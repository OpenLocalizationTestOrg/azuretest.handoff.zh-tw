{
  "nodes": [
    {
      "content": "Deploy an existing application in Azure Service Fabric",
      "pos": [
        26,
        80
      ]
    },
    {
      "content": "Walkthrough on how to package an existing application so it can be deployed on an Azure Service Fabric cluster",
      "pos": [
        98,
        208
      ]
    },
    {
      "content": "Deploy an existing application in Azure Service Fabric",
      "pos": [
        499,
        553
      ]
    },
    {
      "content": "Azure Service Fabric can be used to deploy existing applications.",
      "pos": [
        555,
        620
      ]
    },
    {
      "content": "Applications that currently runs on, for instance, an Azure Web or Worker role, can be 'packaged' so that they can be deployed on an Service Fabric cluster.",
      "pos": [
        621,
        777
      ]
    },
    {
      "content": "Existing applications running on a Service Fabric cluster can benefit from features such as health monitoring and ALM (Application Lifecycle Management) so it is an important scenario that is fully supported.",
      "pos": [
        779,
        987
      ]
    },
    {
      "content": "This tutorial explains the process and basic concepts that are involved with taking an existing application and package it.",
      "pos": [
        988,
        1111
      ]
    },
    {
      "content": "This article that is an overview of the process, we will follow up with specific examples on how to take an existing applications (for instance a node.js or Java) app and package it so it can be hosted on a Service Fabric cluster.",
      "pos": [
        1112,
        1342
      ]
    },
    {
      "content": "Quick overview of Application and Service manifest files",
      "pos": [
        1347,
        1403
      ]
    },
    {
      "content": "Before we can start and learn how to package an existing application, we need to go through an brief introduction of the Service Fabric's deployment model.",
      "pos": [
        1405,
        1560
      ]
    },
    {
      "content": "Service Fabric deployment model relies mainly on two files:",
      "pos": [
        1561,
        1620
      ]
    },
    {
      "content": "Application Manifest.",
      "pos": [
        1625,
        1646
      ]
    },
    {
      "content": "The application manifest is used to describe the application and lists the services that compose it plus other parameters,  such as the number of instances, that are used to define how the service(s) should be deployed.In the Service Fabric world,  an application is the 'upgradable unit'.",
      "pos": [
        1647,
        1936
      ]
    },
    {
      "content": "An application can be upgraded as a single unit where potential failures (and potential rollbacks) are managed by the platform to guarantee that the upgrade process either completely success or, if it fails, it does not leave the application is an unknown/unstable state.",
      "pos": [
        1937,
        2208
      ]
    },
    {
      "content": "This is an example of an application manifest:",
      "pos": [
        2210,
        2256
      ]
    },
    {
      "content": "Service Manifest.",
      "pos": [
        2995,
        3012
      ]
    },
    {
      "content": "Service Manifest describes the components of a service.",
      "pos": [
        3013,
        3068
      ]
    },
    {
      "content": "It includes data such as name and type of the service (information that Service Fabric uses to manage the service), its code, configuration and data components plus some additional parameters that can be used to configure the service once it is deployed.",
      "pos": [
        3069,
        3323
      ]
    },
    {
      "content": "We are not going into the details of all the different parameters available in the service manifest, we will go through the subset that is required to make an existing application to run on Service Fabric",
      "pos": [
        3324,
        3528
      ]
    },
    {
      "content": "This is an example of a service manifest",
      "pos": [
        3530,
        3570
      ]
    },
    {
      "content": "Application Package file structure",
      "pos": [
        4435,
        4469
      ]
    },
    {
      "content": "In order to deploy an application using, for instance, the powershell cmdlets, the application needs to follow a predefined directory structure.",
      "pos": [
        4470,
        4614
      ]
    },
    {
      "content": "\\applicationmanifest.xml",
      "pos": [
        4616,
        4640
      ]
    },
    {
      "content": "\\MyServicePkg",
      "pos": [
        4641,
        4654
      ]
    },
    {
      "content": "\\servicemanifest.xml",
      "pos": [
        4667,
        4687
      ]
    },
    {
      "content": "\\code",
      "pos": [
        4700,
        4705
      ]
    },
    {
      "content": "\\config",
      "pos": [
        4718,
        4725
      ]
    },
    {
      "content": "\\data",
      "pos": [
        4738,
        4743
      ]
    },
    {
      "content": "The root contains the applicationmanifest.xml file that defines the application.",
      "pos": [
        4745,
        4825
      ]
    },
    {
      "content": "A subdirectory for each service included in the application is used to contain all the artifacts that the service requires: The servicemanifest.xml and, typically 3 directories:",
      "pos": [
        4826,
        5003
      ]
    },
    {
      "content": "code: contains the service code",
      "pos": [
        5007,
        5038
      ]
    },
    {
      "content": "config: contains a settings.xml file (and other files if necessary) that the service can access at runtime to retrieve specific configuration settings.",
      "pos": [
        5041,
        5192
      ]
    },
    {
      "content": "Data: an additional directory to store additional local data that service may need.",
      "pos": [
        5195,
        5278
      ]
    },
    {
      "content": "Note: Data should be used to store only ephymeral data, Service Fabric does not copy/replicate changes to the data directory if the service needs to be relocated, for instance, during failover.",
      "pos": [
        5279,
        5472
      ]
    },
    {
      "content": "Note: You can use any arbitrary directory name for Code, Config and Data.",
      "pos": [
        5475,
        5548
      ]
    },
    {
      "content": "You should need to make sure to use the same value in the ApplicationManifest file.",
      "pos": [
        5549,
        5632
      ]
    },
    {
      "content": "the process of packaging an existing app",
      "pos": [
        5638,
        5678
      ]
    },
    {
      "content": "The process of packaging an existing application is based on the following steps:",
      "pos": [
        5679,
        5760
      ]
    },
    {
      "content": "Create the package directory structure",
      "pos": [
        5764,
        5802
      ]
    },
    {
      "content": "Add application's code and configuration files",
      "pos": [
        5805,
        5851
      ]
    },
    {
      "content": "update the service manifest file",
      "pos": [
        5854,
        5886
      ]
    },
    {
      "content": "update the application manifest",
      "pos": [
        5889,
        5920
      ]
    },
    {
      "content": "Create the package directory structure",
      "pos": [
        5927,
        5965
      ]
    },
    {
      "content": "You can start by creating the directory structure as described above.",
      "pos": [
        5966,
        6035
      ]
    },
    {
      "content": "I created a directory and copied the application and service manifest from an existing project that I previously had created in Visual Studio.",
      "pos": [
        6036,
        6178
      ]
    },
    {
      "content": "![][1] ![][2]",
      "pos": [
        6181,
        6194
      ]
    },
    {
      "content": "Add the application's code and configuration files",
      "pos": [
        6201,
        6251
      ]
    },
    {
      "content": "After you have created the directory structure, you can add the application's code and configuration files under the Code and Config directory.",
      "pos": [
        6252,
        6395
      ]
    },
    {
      "content": "You can also create additional directories or sub directories under the Code or Config directories.",
      "pos": [
        6396,
        6495
      ]
    },
    {
      "content": "Service Fabric does an xcopy of the content of the application root directory so there is no predefined structure to use other than creating two top directories Code and Settings (but you can pick different names if you want, more details in the next section).",
      "pos": [
        6496,
        6756
      ]
    },
    {
      "content": "!Azure Note: Make sure that you include all the files/dependencies that the application needs.",
      "pos": [
        6759,
        6853
      ]
    },
    {
      "content": "Service Fabric will copy the content of the application package on all nodes in the cluster where the application's services are going to be deployed.",
      "pos": [
        6854,
        7004
      ]
    },
    {
      "content": "The package should contain all the code that the application needs in order to run.",
      "pos": [
        7005,
        7088
      ]
    },
    {
      "content": "It is not recommended to assume that the dependencies are already installed.",
      "pos": [
        7089,
        7165
      ]
    },
    {
      "content": "Edit the Service Manifest file",
      "pos": [
        7172,
        7202
      ]
    },
    {
      "content": "The next step is to edit the Service Manifest file to include the following information:",
      "pos": [
        7203,
        7291
      ]
    },
    {
      "content": "The name of the service type.",
      "pos": [
        7294,
        7323
      ]
    },
    {
      "content": "This is an 'Id' that Service Fabric uses in order to identify a service",
      "pos": [
        7324,
        7395
      ]
    },
    {
      "content": "The command to use to launch the application (ExeHost)",
      "pos": [
        7398,
        7452
      ]
    },
    {
      "content": "Any script that needs to be run in order to setup/configure the application (SetupEntrypoint",
      "pos": [
        7455,
        7547
      ]
    },
    {
      "pos": [
        7549,
        7639
      ],
      "content": "This is an example of a <ph id=\"ph1\">`servicemanifest.xnml`</ph> file that 'packages' a node.js application:"
    },
    {
      "content": "Let's go over the different part of the file that you need to update:",
      "pos": [
        8646,
        8715
      ]
    },
    {
      "content": "ServiceTypes:",
      "pos": [
        8721,
        8734
      ]
    },
    {
      "pos": [
        8878,
        9012
      ],
      "content": "You can pick any name that you want for <ph id=\"ph1\">`ServiceTypeName`</ph>, the value is used in the <ph id=\"ph2\">`applicationmanifest.xml`</ph> to identify the service."
    },
    {
      "content": "You need to specify <ph id=\"ph1\">`UserImplicitHost = \"true\"`</ph>.",
      "pos": [
        9015,
        9063
      ]
    },
    {
      "content": "This attribute tells Service Fabric that the service is based on a self-contained app so that it needs to do is just to launch it as a process and monitor its health.",
      "pos": [
        9064,
        9230
      ]
    },
    {
      "content": "CodePackage",
      "pos": [
        9237,
        9248
      ]
    },
    {
      "content": "The CodePackage specifies the location (and version) of the service's code.",
      "pos": [
        9250,
        9325
      ]
    },
    {
      "content": "The <ph id=\"ph1\">`Name`</ph> element is used to specify the name of the directory in the Application Package that contains the service's code.",
      "pos": [
        9379,
        9503
      ]
    },
    {
      "content": "<ph id=\"ph1\">`CodePackage`</ph> also has the <ph id=\"ph2\">`version`</ph> attribute that can be used to specify the version of the code and, potentially, be used to upgrade the service's code by leveraging Service Fabric's Application LifeCycle Management infrastructure.",
      "pos": [
        9504,
        9738
      ]
    },
    {
      "content": "Entrypoint",
      "pos": [
        9745,
        9755
      ]
    },
    {
      "content": "The <ph id=\"ph1\">`Entrypoint`</ph> element in the service manifest file is used to specify how to launch the service.",
      "pos": [
        9953,
        10052
      ]
    },
    {
      "content": "The <ph id=\"ph1\">`ExeHost`</ph> element specifies the executable (and arguments) that should be used to launch the service.",
      "pos": [
        10053,
        10158
      ]
    },
    {
      "pos": [
        10163,
        10264
      ],
      "content": "<ph id=\"ph1\">`Program`</ph>:specifies the name of the executable that should be executed in order to start the service."
    },
    {
      "content": "<ph id=\"ph1\">`Arguments`</ph>: it specifies the arguments that should be passed to the executable.",
      "pos": [
        10268,
        10348
      ]
    },
    {
      "content": "it can be a list of parameters with arguments.",
      "pos": [
        10349,
        10395
      ]
    },
    {
      "content": "<ph id=\"ph1\">`WorkingFolder`</ph>: it specifies the working directory for the process that is going to be started.",
      "pos": [
        10398,
        10494
      ]
    },
    {
      "content": "You can specify two values:",
      "pos": [
        10495,
        10522
      ]
    },
    {
      "pos": [
        10529,
        10678
      ],
      "content": "<ph id=\"ph1\">`CodeBase`</ph>: the working directory is going to be set to the Code directory in the application package (<ph id=\"ph2\">`Code`</ph> directory in the structure shown below)"
    },
    {
      "content": "<ph id=\"ph1\">`CodePackage`</ph>: the working directory will be set to the root of the application package   (<ph id=\"ph2\">`MyServicePkg`</ph>)",
      "pos": [
        10685,
        10791
      ]
    },
    {
      "content": "<ph id=\"ph1\">`WorkingDirectory`</ph> element is useful to set the correct working directory so relative paths can be used by either the application or initialization scripts.",
      "pos": [
        10792,
        10948
      ]
    },
    {
      "content": "There is also another value that you can specify for the <ph id=\"ph1\">`WorkingFolder`</ph> element (<ph id=\"ph2\">`Work`</ph>) but it is not very useful for the scenario of bringing an existing application.",
      "pos": [
        10949,
        11118
      ]
    },
    {
      "content": "The setup entry point",
      "pos": [
        11330,
        11351
      ]
    },
    {
      "content": "The <ph id=\"ph1\">`SetupEntrypoint`</ph> is used to specify any executable or batch file that should be executed before the service's code is launched.",
      "pos": [
        11491,
        11623
      ]
    },
    {
      "content": "It is an optional element so it does not need to be included if there is no intialization/setup that is required.",
      "pos": [
        11624,
        11737
      ]
    },
    {
      "content": "The Entrypoint is executed every time the service is restarted.",
      "pos": [
        11738,
        11801
      ]
    },
    {
      "content": "There is only one SetupEntrypoint so setup/config scripts needs to be boundled on a single batch file if the application's setup/config requires multiple scripts.",
      "pos": [
        11802,
        11964
      ]
    },
    {
      "content": "Like the <ph id=\"ph1\">`Entrypoint`</ph> element, <ph id=\"ph2\">`SetupEntrypoint`</ph> can execute any type of file: executable, batch fiules, powershell cmdlet.",
      "pos": [
        11965,
        12088
      ]
    },
    {
      "content": "In the example above, the <ph id=\"ph1\">`SetupEntrypoint`</ph> is based on a batch file myAppsetup.cmd that is located in the scripts subdirectory of the Code directory (assuming the <ph id=\"ph2\">`WorkingDirectory`</ph> element is set to <ph id=\"ph3\">`Code`</ph>).",
      "pos": [
        12089,
        12298
      ]
    },
    {
      "content": "Application Manifest file",
      "pos": [
        12303,
        12328
      ]
    },
    {
      "pos": [
        12330,
        12507
      ],
      "content": "Once you have configured the <ph id=\"ph1\">`servicemanifest.xml`</ph> file you need to make some changes to the <ph id=\"ph2\">`applicationmanifest.xml`</ph> file to ensure the correct Service type and name are used."
    },
    {
      "content": "ServiceManifestImport",
      "pos": [
        12861,
        12882
      ]
    },
    {
      "content": "In the <ph id=\"ph1\">`ServiceManifestImport`</ph> you can specify one or more services that you want to include in the app.",
      "pos": [
        12884,
        12988
      ]
    },
    {
      "content": "Services are referenced with <ph id=\"ph1\">`ServiceManifestName`</ph> that specifies the name of the directory where the <ph id=\"ph2\">`servicemanifest.xml`</ph> file is located.",
      "pos": [
        12989,
        13129
      ]
    },
    {
      "content": "DefaultServices",
      "pos": [
        13292,
        13307
      ]
    },
    {
      "pos": [
        13309,
        13414
      ],
      "content": "The <ph id=\"ph1\">`DefaultServices`</ph> element in the application manifest file is used to define some service properties."
    },
    {
      "content": "<ph id=\"ph1\">`ServiceTypeName`</ph> is used as an 'Id' for the service.",
      "pos": [
        13586,
        13639
      ]
    },
    {
      "content": "in the context of porting an existing application, <ph id=\"ph1\">`ServiceTypeName`</ph> just need to be a unique identifies for your service.",
      "pos": [
        13640,
        13762
      ]
    },
    {
      "content": "<ph id=\"ph1\">`StatelessService`</ph>: Service Fabric supports two types of services: Stateless and Stateful.",
      "pos": [
        13765,
        13855
      ]
    },
    {
      "content": "In the case of porting an existing application the service is a stateless service so <ph id=\"ph1\">`StatelessService`</ph> should always be used.",
      "pos": [
        13856,
        13982
      ]
    },
    {
      "content": "A Service Fabric service can be deployed in various 'configurations', for instance it can be deployed as a single or multiple instances or it can be deployed in such a way that there is one instance of the service on each node of the Service Fabric cluster.",
      "pos": [
        13984,
        14241
      ]
    },
    {
      "content": "In the <ph id=\"ph1\">`applicationmanifest.xml`</ph> file you can specify how you want the application to be deployed",
      "pos": [
        14242,
        14339
      ]
    },
    {
      "content": "<ph id=\"ph1\">`InstanceCount`</ph>: is used to specify how many instances of the service should be launched in the Service Fabric cluster.",
      "pos": [
        14343,
        14462
      ]
    },
    {
      "content": "You can set the <ph id=\"ph1\">`InstanceCount`</ph> value depending on the type of application that you are deploying.",
      "pos": [
        14463,
        14561
      ]
    },
    {
      "content": "The two most common scenarios are:",
      "pos": [
        14562,
        14596
      ]
    },
    {
      "content": "<ph id=\"ph1\">`InstanCount = \"1\"`</ph>: in this case only one instance of the service will be deployed on the cluster.",
      "pos": [
        14603,
        14702
      ]
    },
    {
      "content": "Service Fabric's scheduler determines on which node the service is going to be deployed.",
      "pos": [
        14703,
        14791
      ]
    },
    {
      "content": "A single instance count also makes sense for applications that require a different configuration if they run on multiple instances.",
      "pos": [
        14792,
        14923
      ]
    },
    {
      "content": "In that case it is easier to define multiple services in the same application manifest file and use <ph id=\"ph1\">`InstanceCount = \"1\"`</ph>.",
      "pos": [
        14924,
        15046
      ]
    },
    {
      "content": "So the end result will be to have multiple instances of the same service but each with a specific configuration.",
      "pos": [
        15047,
        15159
      ]
    },
    {
      "content": "A value of <ph id=\"ph1\">`InstanceCount`</ph> greater than one makes sense only if the goal is to have multiple instance of the exact same configuration.",
      "pos": [
        15160,
        15294
      ]
    },
    {
      "content": "<ph id=\"ph1\">`InstanceCount =\"-1\"`</ph>: in this case one instance of the service will be deployed on every node in the Service Fabric cluster.",
      "pos": [
        15301,
        15426
      ]
    },
    {
      "content": "The end result will be having one (and only one) instance of the service for each node in the cluster.",
      "pos": [
        15427,
        15529
      ]
    },
    {
      "content": "This is a useful configuration for front-end applications (ex.",
      "pos": [
        15530,
        15592
      ]
    },
    {
      "content": "a REST endpoint) because client applications just need to 'connect' to any of the node in the cluster in order to use the endpoint.",
      "pos": [
        15593,
        15724
      ]
    },
    {
      "content": "This configuration can also be used when, for instance, all nodes of the Service Fabric cluster are connected to a load balancer so client traffic can be distributed across the service running on all nodes in the cluster.",
      "pos": [
        15725,
        15946
      ]
    },
    {
      "content": "Testing",
      "pos": [
        15953,
        15960
      ]
    },
    {
      "content": "For existing application is very useful to be able to see console logs to find out if the application and configuration scripts don't show any error.",
      "pos": [
        15961,
        16110
      ]
    },
    {
      "content": "Console redirection can be configured in the <ph id=\"ph1\">`servicemanifest.xml`</ph> file using the <ph id=\"ph2\">`ConsoleRedirection`</ph> element",
      "pos": [
        16111,
        16221
      ]
    },
    {
      "pos": [
        16488,
        16730
      ],
      "content": "<ph id=\"ph1\">`ConsoleRedirection`</ph> can be used to redirect console output (both stdout and stderr) to a working directory so they can be used to verify that there are no errors during the setup or execution of the application in the Service Fabric cluster."
    },
    {
      "content": "<ph id=\"ph1\">`FileRetentionCount`</ph> determines how many files are saved in the working directory.",
      "pos": [
        16737,
        16819
      ]
    },
    {
      "content": "A value of, for instance, 5 means that the log files for the previous 5 executions are stored in the working directory.",
      "pos": [
        16820,
        16939
      ]
    },
    {
      "pos": [
        16946,
        17004
      ],
      "content": "<ph id=\"ph1\">`FileMaxSizeInKb`</ph> specifies the max size of the log files."
    },
    {
      "content": "Log files are saved on one of the service's working directories, in order to determine where the files are located, you need to use the Service Fabric Explorer to determine in which node the service is running and which is the working directory that is currently used.",
      "pos": [
        17007,
        17275
      ]
    },
    {
      "content": "In the Service Fabric explorer, identify the node where the service is running",
      "pos": [
        17277,
        17355
      ]
    },
    {
      "content": "![][3]",
      "pos": [
        17357,
        17363
      ]
    },
    {
      "content": "After you know the node where the service is currently running, you can find out which is the working directory used",
      "pos": [
        17365,
        17481
      ]
    },
    {
      "content": "![][4]",
      "pos": [
        17483,
        17489
      ]
    },
    {
      "content": "When you select the name of the service, on the right panel you can see there the service code and settings are stored",
      "pos": [
        17491,
        17609
      ]
    },
    {
      "content": "![][5]",
      "pos": [
        17611,
        17617
      ]
    },
    {
      "content": "If you click on the link in the 'Disk Location' field you can access the directory where the services is running on.",
      "pos": [
        17619,
        17735
      ]
    },
    {
      "content": "![][6]",
      "pos": [
        17737,
        17743
      ]
    },
    {
      "content": "The log directory contains all log files.",
      "pos": [
        17745,
        17786
      ]
    },
    {
      "content": "Note: This example shows the case of a single instance of the service running in the cluster.",
      "pos": [
        17788,
        17881
      ]
    },
    {
      "content": "If there are multiple instances you may need to check the log file on all the nodes where the service is running.",
      "pos": [
        17882,
        17995
      ]
    },
    {
      "content": "What's next",
      "pos": [
        18002,
        18013
      ]
    },
    {
      "content": "We are working on a tools that can be used to package an existing application simply by pointing it at the root of the directory structure of the app.",
      "pos": [
        18014,
        18164
      ]
    },
    {
      "content": "The tool takes care of generate the manifest files and configure the basic settings that are required to 'transform' the application in a Service Fabric service.",
      "pos": [
        18165,
        18326
      ]
    }
  ],
  "content": "<properties\n   pageTitle=\"Deploy an existing application in Azure Service Fabric\"\n   description=\"Walkthrough on how to package an existing application so it can be deployed on an Azure Service Fabric cluster\"\n   services=\"service-fabric\"\n   documentationCenter=\".net\"\n   authors=\"clca\"\n   manager=\"timlt\"\n   editor=\"\"/>\n\n<tags\n   ms.service=\"service-fabric\"\n   ms.devlang=\"dotnet\"\n   ms.topic=\"article\"\n   ms.tgt_pltfrm=\"NA\"\n   ms.workload=\"NA\"\n   ms.date=\"07/06/2015\"\n   ms.author=\"claudioc\"/>\n\n# Deploy an existing application in Azure Service Fabric\n\nAzure Service Fabric can be used to deploy existing applications. Applications that currently runs on, for instance, an Azure Web or Worker role, can be 'packaged' so that they can be deployed on an Service Fabric cluster. \nExisting applications running on a Service Fabric cluster can benefit from features such as health monitoring and ALM (Application Lifecycle Management) so it is an important scenario that is fully supported.\nThis tutorial explains the process and basic concepts that are involved with taking an existing application and package it.\nThis article that is an overview of the process, we will follow up with specific examples on how to take an existing applications (for instance a node.js or Java) app and package it so it can be hosted on a Service Fabric cluster.\n\n## Quick overview of Application and Service manifest files\n\nBefore we can start and learn how to package an existing application, we need to go through an brief introduction of the Service Fabric's deployment model.\nService Fabric deployment model relies mainly on two files:\n\n\n* Application Manifest. The application manifest is used to describe the application and lists the services that compose it plus other parameters,  such as the number of instances, that are used to define how the service(s) should be deployed.In the Service Fabric world,  an application is the 'upgradable unit'. An application can be upgraded as a single unit where potential failures (and potential rollbacks) are managed by the platform to guarantee that the upgrade process either completely success or, if it fails, it does not leave the application is an unknown/unstable state.\n\nThis is an example of an application manifest:\n\n    \n\n    <?xml version=\"1.0\" encoding=\"utf-8\"?>\n    <ApplicationManifest ApplicationTypeName=\"actor2Application\" ApplicationTypeVersion=\"1.0.0.0\" xmlns=\"http://schemas.microsoft.com/2011/01/fabric\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n      <ServiceManifestImport>\n        <ServiceManifestRef ServiceManifestName=\"actor2Pkg\" ServiceManifestVersion=\"1.0.0.0\" />\n        <ConfigOverrides />\n      </ServiceManifestImport>\n      <DefaultServices>\n        <Service Name=\"actor2\">\n          <StatelessService ServiceTypeName=\"actor2Type\">\n            <SingletonPartition />\n          </StatelessService>\n        </Service>\n      </DefaultServices>\n    </ApplicationManifest>\n\n* Service Manifest. Service Manifest describes the components of a service. It includes data such as name and type of the service (information that Service Fabric uses to manage the service), its code, configuration and data components plus some additional parameters that can be used to configure the service once it is deployed. We are not going into the details of all the different parameters available in the service manifest, we will go through the subset that is required to make an existing application to run on Service Fabric\n\nThis is an example of a service manifest\n\n    <?xml version=\"1.0\" encoding=\"utf-8\"?>\n    <ServiceManifest Name=\"actor2Pkg\"\n                     Version=\"1.0.0.0\"\n                     xmlns=\"http://schemas.microsoft.com/2011/01/fabric\"\n                     xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\n                     xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n      <ServiceTypes>\n        <StatelessServiceType ServiceTypeName=\"actor2Type\" />\n      </ServiceTypes>\n    \n      <CodePackage Name=\"Code\" Version=\"1.0.0.0\">\n        <EntryPoint>\n          <ExeHost>\n            <Program>actor2.exe</Program>\n          </ExeHost>\n        </EntryPoint>\n      </CodePackage>\n    \n      <ConfigPackage Name=\"Config\" Version=\"1.0.0.0\" />\n    \n      <Resources>\n        <Endpoints>\n          <Endpoint Name=\"ServiceEndpoint\" />\n        </Endpoints>\n      </Resources>\n    </ServiceManifest>\n    \n## Application Package file structure\nIn order to deploy an application using, for instance, the powershell cmdlets, the application needs to follow a predefined directory structure.\n\n\\applicationmanifest.xml\n\\MyServicePkg\n            \\servicemanifest.xml\n            \\code\n            \\config\n            \\data\n\nThe root contains the applicationmanifest.xml file that defines the application. A subdirectory for each service included in the application is used to contain all the artifacts that the service requires: The servicemanifest.xml and, typically 3 directories:\n\n* code: contains the service code\n* config: contains a settings.xml file (and other files if necessary) that the service can access at runtime to retrieve specific configuration settings.\n* Data: an additional directory to store additional local data that service may need. Note: Data should be used to store only ephymeral data, Service Fabric does not copy/replicate changes to the data directory if the service needs to be relocated, for instance, during failover. \n\nNote: You can use any arbitrary directory name for Code, Config and Data. You should need to make sure to use the same value in the ApplicationManifest file. \n\n## the process of packaging an existing app\nThe process of packaging an existing application is based on the following steps:\n\n* Create the package directory structure\n* Add application's code and configuration files\n* update the service manifest file\n* update the application manifest\n\n\n### Create the package directory structure\nYou can start by creating the directory structure as described above. I created a directory and copied the application and service manifest from an existing project that I previously had created in Visual Studio. \n\n![][1] ![][2]\n\n\n### Add the application's code and configuration files\nAfter you have created the directory structure, you can add the application's code and configuration files under the Code and Config directory. You can also create additional directories or sub directories under the Code or Config directories. Service Fabric does an xcopy of the content of the application root directory so there is no predefined structure to use other than creating two top directories Code and Settings (but you can pick different names if you want, more details in the next section). \n\n!Azure Note: Make sure that you include all the files/dependencies that the application needs. Service Fabric will copy the content of the application package on all nodes in the cluster where the application's services are going to be deployed. The package should contain all the code that the application needs in order to run. It is not recommended to assume that the dependencies are already installed. \n\n### Edit the Service Manifest file\nThe next step is to edit the Service Manifest file to include the following information:\n* The name of the service type. This is an 'Id' that Service Fabric uses in order to identify a service\n* The command to use to launch the application (ExeHost)\n* Any script that needs to be run in order to setup/configure the application (SetupEntrypoint\n\nThis is an example of a `servicemanifest.xnml` file that 'packages' a node.js application:\n\n    <?xml version=\"1.0\" encoding=\"utf-8\"?>\n    <ServiceManifest Name=\"VisualObjectsNodejsWebServicePkg\"\n                     Version=\"1.0.0.0\"\n                     xmlns=\"http://schemas.microsoft.com/2011/01/fabric\"\n                     xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\n                     xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n      <ServiceTypes>\n        <StatelessServiceType ServiceTypeName=\"VisualObjectsNodejsWebServiceType\" UseImplicitHost=\"true\" />\n      </ServiceTypes>\n      <CodePackage Name=\"Code\" Version=\"1.0.0.0\">\n        <EntryPoint>\n          <ExeHost>\n            <Program>node.exe</Program>\n            <Arguments>server.js</Arguments>\n            <WorkingFolder>CodeBase</WorkingFolder>\n          </ExeHost>\n        </EntryPoint>\n      </CodePackage>\n      <ConfigPackage Name=\"Config\" Version=\"1.0.0.0\"/>\n      <Resources>\n        <Endpoints>\n          <Endpoint Name=\"ServiceEndpoint\" />\n        </Endpoints>\n      </Resources>\n    </ServiceManifest>\n\n\nLet's go over the different part of the file that you need to update:\n\n### ServiceTypes:\n\n```\n<ServiceTypes>\n<StatelessServiceType ServiceTypeName=\"VisualObjectsNodejsWebServiceType\" UseImplicitHost=\"true\" />\n</ServiceTypes>\n```\n\n* You can pick any name that you want for `ServiceTypeName`, the value is used in the `applicationmanifest.xml` to identify the service.\n* You need to specify `UserImplicitHost = \"true\"`. This attribute tells Service Fabric that the service is based on a self-contained app so that it needs to do is just to launch it as a process and monitor its health.\n\n\n### CodePackage \nThe CodePackage specifies the location (and version) of the service's code. \n\n\n    <CodePackage Name=\"Code\" Version=\"1.0.0.0\">\n\n\nThe `Name` element is used to specify the name of the directory in the Application Package that contains the service's code. `CodePackage` also has the `version` attribute that can be used to specify the version of the code and, potentially, be used to upgrade the service's code by leveraging Service Fabric's Application LifeCycle Management infrastructure.\n\n\n### Entrypoint\n\n\n    <EntryPoint>\n      <ExeHost>\n        <Program>node.exe</Program>\n        <Arguments>server.js</Arguments>\n        <WorkingFolder>CodeBase</WorkingFolder>\n      </ExeHost>\n    </EntryPoint>\n\n\nThe `Entrypoint` element in the service manifest file is used to specify how to launch the service. The `ExeHost` element specifies the executable (and arguments) that should be used to launch the service. \n\n* `Program`:specifies the name of the executable that should be executed in order to start the service. \n* `Arguments`: it specifies the arguments that should be passed to the executable. it can be a list of parameters with arguments.\n* `WorkingFolder`: it specifies the working directory for the process that is going to be started. You can specify two values:\n    * `CodeBase`: the working directory is going to be set to the Code directory in the application package (`Code` directory in the structure shown below)\n    * `CodePackage`: the working directory will be set to the root of the application package   (`MyServicePkg`)\n`WorkingDirectory` element is useful to set the correct working directory so relative paths can be used by either the application or initialization scripts.\nThere is also another value that you can specify for the `WorkingFolder` element (`Work`) but it is not very useful for the scenario of bringing an existing application.\n\n\n```\n\n\\applicationmanifest.xml\n\\MyServicePkg\n\n            \\servicemanifest.xml\n            \\code\n                 \\bin\n                  \\ ...\n            \\config\n            \\data\n            \\...\n\n```\n\n\n#### The setup entry point\n\n    <SetupEntryPoint>\n        <ExeHost>\n            <Program>scripts\\myAppsetup.cmd</Program>\n        </ExeHost>\n    </SetupEntryPoint>\n\n\nThe `SetupEntrypoint` is used to specify any executable or batch file that should be executed before the service's code is launched. It is an optional element so it does not need to be included if there is no intialization/setup that is required. The Entrypoint is executed every time the service is restarted. There is only one SetupEntrypoint so setup/config scripts needs to be boundled on a single batch file if the application's setup/config requires multiple scripts. Like the `Entrypoint` element, `SetupEntrypoint` can execute any type of file: executable, batch fiules, powershell cmdlet.\nIn the example above, the `SetupEntrypoint` is based on a batch file myAppsetup.cmd that is located in the scripts subdirectory of the Code directory (assuming the `WorkingDirectory` element is set to `Code`).\n\n## Application Manifest file\n\nOnce you have configured the `servicemanifest.xml` file you need to make some changes to the `applicationmanifest.xml` file to ensure the correct Service type and name are used.\n\n    <ServiceManifestImport>\n        <ServiceManifestRef ServiceManifestName=\"MyServicePkg\" ServiceManifestVersion=\"1.0.0.0\" />\n    </ServiceManifestImport>\n    <DefaultServices>\n    <Service Name=\"actor2\">\n      <StatelessService ServiceTypeName=\"MyServiceType\" InstanceCount = \"1\">\n      </StatelessService>\n    </Service>\n    </DefaultServices>\n\n### ServiceManifestImport\n\nIn the `ServiceManifestImport` you can specify one or more services that you want to include in the app. Services are referenced with `ServiceManifestName` that specifies the name of the directory where the `servicemanifest.xml` file is located.\n\n    <ServiceManifestImport>\n        <ServiceManifestRef ServiceManifestName=\"MyServicePkg\" ServiceManifestVersion=\"1.0.0.0\" />\n    </ServiceManifestImport>\n\n### DefaultServices\n\nThe `DefaultServices` element in the application manifest file is used to define some service properties.\n\n    <DefaultServices>\n    <Service Name=\"actor2\">\n      <StatelessService ServiceTypeName=\"MyServiceType\" InstanceCount=\"1\">\n      </StatelessService>\n    </Service>\n\n\n* `ServiceTypeName` is used as an 'Id' for the service. in the context of porting an existing application, `ServiceTypeName` just need to be a unique identifies for your service.\n* `StatelessService`: Service Fabric supports two types of services: Stateless and Stateful. In the case of porting an existing application the service is a stateless service so `StatelessService` should always be used.\n\nA Service Fabric service can be deployed in various 'configurations', for instance it can be deployed as a single or multiple instances or it can be deployed in such a way that there is one instance of the service on each node of the Service Fabric cluster.\nIn the `applicationmanifest.xml` file you can specify how you want the application to be deployed\n\n* `InstanceCount`: is used to specify how many instances of the service should be launched in the Service Fabric cluster. You can set the `InstanceCount` value depending on the type of application that you are deploying. The two most common scenarios are:\n    * `InstanCount = \"1\"`: in this case only one instance of the service will be deployed on the cluster. Service Fabric's scheduler determines on which node the service is going to be deployed. A single instance count also makes sense for applications that require a different configuration if they run on multiple instances. In that case it is easier to define multiple services in the same application manifest file and use `InstanceCount = \"1\"`. So the end result will be to have multiple instances of the same service but each with a specific configuration. A value of `InstanceCount` greater than one makes sense only if the goal is to have multiple instance of the exact same configuration.\n    * `InstanceCount =\"-1\"`: in this case one instance of the service will be deployed on every node in the Service Fabric cluster. The end result will be having one (and only one) instance of the service for each node in the cluster. This is a useful configuration for front-end applications (ex. a REST endpoint) because client applications just need to 'connect' to any of the node in the cluster in order to use the endpoint. This configuration can also be used when, for instance, all nodes of the Service Fabric cluster are connected to a load balancer so client traffic can be distributed across the service running on all nodes in the cluster.\n\n\n### Testing\nFor existing application is very useful to be able to see console logs to find out if the application and configuration scripts don't show any error.\nConsole redirection can be configured in the `servicemanifest.xml` file using the `ConsoleRedirection` element\n\n    <EntryPoint>\n      <ExeHost>\n        <Program>node.exe</Program>\n        <Arguments>server.js</Arguments>\n        <WorkingFolder></WorkingFolder>\n        <ConsoleRedirection FileRetentionCount=\"5\" FileMaxSizeInKb=\"2048\"/>\n      </ExeHost>\n    </EntryPoint>\n\n\n* `ConsoleRedirection` can be used to redirect console output (both stdout and stderr) to a working directory so they can be used to verify that there are no errors during the setup or execution of the application in the Service Fabric cluster.\n    * `FileRetentionCount` determines how many files are saved in the working directory. A value of, for instance, 5 means that the log files for the previous 5 executions are stored in the working directory.\n    * `FileMaxSizeInKb` specifies the max size of the log files. \n\nLog files are saved on one of the service's working directories, in order to determine where the files are located, you need to use the Service Fabric Explorer to determine in which node the service is running and which is the working directory that is currently used.\n\nIn the Service Fabric explorer, identify the node where the service is running\n\n![][3]\n\nAfter you know the node where the service is currently running, you can find out which is the working directory used\n\n![][4]\n\nWhen you select the name of the service, on the right panel you can see there the service code and settings are stored\n\n![][5]\n\nIf you click on the link in the 'Disk Location' field you can access the directory where the services is running on.\n\n![][6]\n\nThe log directory contains all log files.\n\nNote: This example shows the case of a single instance of the service running in the cluster. If there are multiple instances you may need to check the log file on all the nodes where the service is running.\n\n \n## What's next\nWe are working on a tools that can be used to package an existing application simply by pointing it at the root of the directory structure of the app. The tool takes care of generate the manifest files and configure the basic settings that are required to 'transform' the application in a Service Fabric service.\n\n\n<!--Image references-->\n[1]: ./media/service-fabric-deploy-an-existing-app/directory-structure-1.PNG\n[2]: ./media/service-fabric-deploy-an-existing-app/directory-structure-2.PNG\n[3]: ./media/service-fabric-deploy-an-existing-app/service-node-1.PNG\n[4]: ./media/service-fabric-deploy-an-existing-app/service-node-2.PNG\n[5]: ./media/service-fabric-deploy-an-existing-app/service-node-3.PNG\n[6]: ./media/service-fabric-deploy-an-existing-app/service-node-4.PNG\n\n    \n\n\n"
}