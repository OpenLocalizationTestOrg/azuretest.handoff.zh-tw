{
  "nodes": [
    {
      "content": "Setting up on-premises conditional access using Azure Active Directory Device Registration | Microsoft Azure",
      "pos": [
        27,
        135
      ]
    },
    {
      "content": "A step-by-step guide to enable conditional access to on-premises applications using Active Directory Federation Service (AD FS) in Windows Server 2012 R2.",
      "pos": [
        154,
        308
      ]
    },
    {
      "content": "Setting up on-premises conditional access using Azure Active Directory Device Registration",
      "pos": [
        616,
        706
      ]
    },
    {
      "content": "Personally owned devices of your users can be marked known to your organization by requiring the users to work place join their devices to the Azure Active Directory Device Registration service.",
      "pos": [
        708,
        902
      ]
    },
    {
      "content": "Below is a step-by-step guide to enable conditional access to on-premises applications using Active Directory Federation Service (AD FS) in Windows Server 2012 R2.",
      "pos": [
        903,
        1066
      ]
    },
    {
      "pos": [
        1070,
        1362
      ],
      "content": "[AZURE.NOTE]\nOffice 365 license or Azure AD Premium license is required when using devices registered in Azure Active Directory Device Registration service conditional access policies. This includes policies enforced by Active Directory Federation Services (AD FS) to on-premises resources.",
      "leadings": [
        "",
        "> "
      ],
      "nodes": [
        {
          "content": "Office 365 license or Azure AD Premium license is required when using devices registered in Azure Active Directory Device Registration service conditional access policies. This includes policies enforced by Active Directory Federation Services (AD FS) to on-premises resources.",
          "pos": [
            13,
            290
          ],
          "nodes": [
            {
              "content": "Office 365 license or Azure AD Premium license is required when using devices registered in Azure Active Directory Device Registration service conditional access policies.",
              "pos": [
                0,
                171
              ]
            },
            {
              "content": "This includes policies enforced by Active Directory Federation Services (AD FS) to on-premises resources.",
              "pos": [
                172,
                277
              ]
            }
          ]
        }
      ]
    },
    {
      "content": "For more information on the conditional access scenarios for on-premises, see <bpt id=\"p1\">[</bpt>Join to Workplace from Any Device for SSO and Seamless Second Factor Authentication Across Company Applications<ept id=\"p1\">](https://technet.microsoft.com/library/dn280945.aspx)</ept>.",
      "pos": [
        1364,
        1609
      ]
    },
    {
      "content": "These capabilities are available to customers that purchase an Azure Active Directory Premium license.",
      "pos": [
        1610,
        1712
      ]
    },
    {
      "content": "Supported Devices",
      "pos": [
        1714,
        1731
      ]
    },
    {
      "content": "Windows 7 domain joined devices.",
      "pos": [
        1808,
        1840
      ]
    },
    {
      "content": "Windows 8.1 personal and domain joined devices.",
      "pos": [
        1843,
        1890
      ]
    },
    {
      "content": "iOS 6 and later.",
      "pos": [
        1893,
        1909
      ]
    },
    {
      "content": "Android 4.0 or later, Samsung GS3 or above phones, Samsung Note2 or above tablets.",
      "pos": [
        1912,
        1994
      ]
    },
    {
      "content": "Scenario Prerequisites",
      "pos": [
        1996,
        2018
      ]
    },
    {
      "content": "Windows Server Active Directory (Windows Server 2008 or above)",
      "pos": [
        2094,
        2156
      ]
    },
    {
      "content": "Updated schema in Windows Server 2012 R2",
      "pos": [
        2159,
        2199
      ]
    },
    {
      "content": "Subscription to Azure Active Directory Premium",
      "pos": [
        2202,
        2248
      ]
    },
    {
      "content": "Windows Server 2012 R2 Federation Services, configured for SSO to Azure AD",
      "pos": [
        2251,
        2325
      ]
    },
    {
      "content": "Windows Server 2012 R2 Web Application Proxy",
      "pos": [
        2328,
        2372
      ]
    },
    {
      "content": "Directory Synchronization Tool (DirSync) with device object write-back.",
      "pos": [
        2375,
        2446
      ]
    },
    {
      "content": "Download the latest build of dirsync.exe.",
      "pos": [
        2448,
        2489
      ]
    },
    {
      "content": "](http://go.microsoft.com/fwlink/?LinkID=278924)",
      "pos": [
        2489,
        2537
      ]
    },
    {
      "content": "Known Issues in this release",
      "pos": [
        2539,
        2567
      ]
    },
    {
      "content": "Device based conditional access policies require device object write-back to Active Directory from Azure Active Directory.",
      "pos": [
        2650,
        2772
      ]
    },
    {
      "content": "It can take up to 3 hours for device objects to be written-back to Active Directory.",
      "pos": [
        2773,
        2857
      ]
    },
    {
      "content": "iOS7 devices will always prompt the user to select a certificate during client certificate authentication.",
      "pos": [
        2860,
        2966
      ]
    },
    {
      "content": "iOS8 beta devices are not working at this time.",
      "pos": [
        2970,
        3017
      ]
    },
    {
      "content": "Deploy Azure Active Directory Device Registration Service",
      "pos": [
        3023,
        3080
      ]
    },
    {
      "content": "Use this guide to deploy and configure Azure Active Directory Device Registration Service for your organization.",
      "pos": [
        3081,
        3193
      ]
    },
    {
      "content": "This guide assumes that you have configured Windows Server Active Directory and have subscribed to Microsoft Azure Active Directory.",
      "pos": [
        3195,
        3327
      ]
    },
    {
      "content": "See prerequisites above.",
      "pos": [
        3328,
        3352
      ]
    },
    {
      "content": "To deploy Azure Active Directory Device Registration Service with your Azure Active Directory tenant, complete the tasks in the following checklist, in order.",
      "pos": [
        3354,
        3512
      ]
    },
    {
      "content": "When a reference link takes you to a conceptual topic, return to this checklist after you review the conceptual topic so that you can proceed with the remaining tasks in this checklist.",
      "pos": [
        3513,
        3698
      ]
    },
    {
      "content": "Some tasks will include a scenario validation step that can help you confirm the step was completed successfully.",
      "pos": [
        3699,
        3812
      ]
    },
    {
      "content": "Checklist: Enable Azure Active Directory Device Registration",
      "pos": [
        3816,
        3876
      ]
    },
    {
      "content": "Follow the checklist below to enable and configure the Azure Active Directory Device Registration Service.",
      "pos": [
        3880,
        3986
      ]
    },
    {
      "content": "Task",
      "pos": [
        3990,
        3994
      ]
    },
    {
      "content": "Reference",
      "pos": [
        4377,
        4386
      ]
    },
    {
      "content": "Enable Device Registration in your Azure Active Directory tenant to allow devices to join the workplace.",
      "pos": [
        4900,
        5004
      ]
    },
    {
      "content": "By default, multi-factor authentication is not enabled for the service.",
      "pos": [
        5005,
        5076
      ]
    },
    {
      "content": "However, multi-factor authentication is recommended when registering a device.",
      "pos": [
        5077,
        5155
      ]
    },
    {
      "content": "Before enabling multi-factor authentication in ADRS, ensure that AD FS is configured for a multi-factor authentication provider.",
      "pos": [
        5156,
        5284
      ]
    },
    {
      "content": "Enable Azure Active Directory Device Registration",
      "pos": [
        5288,
        5337
      ]
    },
    {
      "content": "Devices will discover your Azure Active Directory Device Registration Service by looking for well-known DNS records.",
      "pos": [
        5426,
        5542
      ]
    },
    {
      "content": "You must configure your company DNS so that devices can discover your Azure Active Directory Device Registration Service.",
      "pos": [
        5543,
        5664
      ]
    },
    {
      "content": "Configure Azure Active Directory Device Registration discovery.",
      "pos": [
        5814,
        5877
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Checklist: Deploy and configure Windows Server 2012 R2 Active Directory Federation Services and set up a federation relationship with Azure Active Directory<ept id=\"p1\">**</ept>",
      "pos": [
        5951,
        6111
      ]
    },
    {
      "content": "With the next set of tasks, you integrate Windows Server 2012 R2 Federation services with Azure Active Directory.",
      "pos": [
        6112,
        6225
      ]
    },
    {
      "content": "This allows you to use devices registered in Azure Active Directory Device Registration Service for conditional access policies in AD FS.",
      "pos": [
        6226,
        6363
      ]
    },
    {
      "content": "Task",
      "pos": [
        6368,
        6372
      ]
    },
    {
      "content": "Reference",
      "pos": [
        6601,
        6610
      ]
    },
    {
      "content": "Deploy Active Directory Domain Services domain with the Windows Server 2012 R2 schema extensions.",
      "pos": [
        7038,
        7135
      ]
    },
    {
      "content": "(You do not need to upgrade any of your domain controllers to Windows Server 2012 R2.",
      "pos": [
        7136,
        7221
      ]
    },
    {
      "content": "The schema upgrade is the only requirement).",
      "pos": [
        7222,
        7266
      ]
    },
    {
      "content": "Upgrade your Active Directory Domain Services Schema.",
      "pos": [
        7271,
        7324
      ]
    },
    {
      "content": "Deploy Windows Server 2012 R2 Federation Services along with the Web Application Proxy.",
      "pos": [
        7373,
        7460
      ]
    },
    {
      "content": "Deploy Windows Server 2012 R2 Federation Services along with the Web Application Proxy.",
      "pos": [
        7606,
        7693
      ]
    },
    {
      "content": "Your Active Directory Domain Services forest must be configured with the objects and containers needed to support device objects.",
      "pos": [
        7708,
        7837
      ]
    },
    {
      "content": "You will also enable Device Authentication in AD FS.",
      "pos": [
        7838,
        7890
      ]
    },
    {
      "content": "Prepare your Active Directory forest to support devices.",
      "pos": [
        7941,
        7997
      ]
    },
    {
      "content": "Set up a federation relationship with your organization and Azure Active Directory.,This step will walk you through configuring your Azure Active Directory tenant with your Windows Server 2012 R2 Federation Services.",
      "pos": [
        8043,
        8259
      ]
    },
    {
      "content": "Configure a federation relationship with Azure Active Directory and Configure Directory Sync Tool",
      "pos": [
        8276,
        8373
      ]
    },
    {
      "content": "Configure Directory Sync (DirSync) to allow device object write-back.",
      "pos": [
        8378,
        8447
      ]
    },
    {
      "content": "Devices created in Azure Active Directory will be written down to your Active Directory.",
      "pos": [
        8448,
        8536
      ]
    },
    {
      "content": "Configure DirSync to allow device object write-back",
      "pos": [
        8611,
        8662
      ]
    },
    {
      "content": "It is strongly recommended that you configure a multi-factor authentication provider with Windows Server 2012 R2 Federation Services.,This will allow your users to securely register their devices using multi-factor authentication.",
      "pos": [
        8713,
        8943
      ]
    },
    {
      "content": "Configure federation services to provide multi-factor authentication.",
      "pos": [
        8946,
        9015
      ]
    },
    {
      "content": "Upgrade your Active Directory Domain Services Schema",
      "pos": [
        9052,
        9104
      ]
    },
    {
      "pos": [
        9107,
        9243
      ],
      "content": "[AZURE.NOTE]\nUpgrading your Active Directory schema cannot be reversed. It is recommended that you perform this in a test environment.",
      "leadings": [
        "",
        "> "
      ],
      "nodes": [
        {
          "content": "Upgrading your Active Directory schema cannot be reversed. It is recommended that you perform this in a test environment.",
          "pos": [
            13,
            134
          ],
          "nodes": [
            {
              "content": "Upgrading your Active Directory schema cannot be reversed.",
              "pos": [
                0,
                58
              ]
            },
            {
              "content": "It is recommended that you perform this in a test environment.",
              "pos": [
                59,
                121
              ]
            }
          ]
        }
      ]
    },
    {
      "content": "Log in to your domain controller with an account that has both Enterprise Admin and Schema Admin rights.",
      "pos": [
        9248,
        9352
      ]
    },
    {
      "content": "Copy the [media]\\support\\adprep directory and sub-directories to one of your Active Directory domain controllers.",
      "pos": [
        9356,
        9469
      ]
    },
    {
      "content": "Where [media] is the path to the Windows Server 2012 R2 installation media.",
      "pos": [
        9474,
        9549
      ]
    },
    {
      "content": "From a command prompt, navigate to the adprep directory and execute: adprep.exe /forestprep.",
      "pos": [
        9553,
        9645
      ]
    },
    {
      "content": "Follow the onscreen instructions to complete the schema upgrade.",
      "pos": [
        9646,
        9710
      ]
    },
    {
      "content": "Deploy Windows Server 2012 R2 Federation Services along with the Web Application Proxy",
      "pos": [
        9716,
        9802
      ]
    },
    {
      "content": "Follow the two guides below to deploy Windows Server 2012 R2 Federation Services with the Web Application Proxy and then return to this guide.",
      "pos": [
        9803,
        9945
      ]
    },
    {
      "content": "Follow the instructions for deploying a Windows Server 2012 R2 Federation Server Farm.",
      "pos": [
        9946,
        10032
      ]
    },
    {
      "pos": [
        10036,
        10363
      ],
      "content": "[AZURE.NOTE]\nWhen deploying AD FS, you must skip the optional step named: Optional step: Configure a federation server with Device Registration Service (DRS). This step is not needed when using Azure Active Directory Device Registration.\nFollow the instructions for deploying a Windows Server 2012 R2 Federation Server Proxy.",
      "leadings": [
        "",
        "> ",
        ""
      ],
      "nodes": [
        {
          "content": "When deploying AD FS, you must skip the optional step named: Optional step: Configure a federation server with Device Registration Service (DRS). This step is not needed when using Azure Active Directory Device Registration.",
          "pos": [
            13,
            237
          ],
          "nodes": [
            {
              "content": "When deploying AD FS, you must skip the optional step named: Optional step: Configure a federation server with Device Registration Service (DRS).",
              "pos": [
                0,
                145
              ]
            },
            {
              "content": "This step is not needed when using Azure Active Directory Device Registration.",
              "pos": [
                146,
                224
              ]
            }
          ]
        },
        {
          "content": "Follow the instructions for deploying a Windows Server 2012 R2 Federation Server Proxy.",
          "pos": [
            238,
            325
          ]
        }
      ]
    },
    {
      "content": "Install the latest update for Windows Server 2012 R2 on all of your Windows Server 2012 R2 Federation and Proxy servers.",
      "pos": [
        10365,
        10485
      ]
    },
    {
      "content": "This can be done before or after configuring your federation farm.",
      "pos": [
        10486,
        10552
      ]
    },
    {
      "content": "The update can be found here: Windows Server 2012 R2 Update.",
      "pos": [
        10553,
        10613
      ]
    },
    {
      "content": "Prepare your Active Directory forest to support devices",
      "pos": [
        10620,
        10675
      ]
    },
    {
      "pos": [
        10679,
        10968
      ],
      "content": "[AZURE.NOTE]\nThis is a one-time operation that you must run to prepare your Active Directory forest to support devices. You must be logged on with enterprise administrator permissions and your Active Directory forest must have the Windows Server 2012 R2 schema to complete this procedure.",
      "leadings": [
        "",
        ">"
      ],
      "nodes": [
        {
          "content": "This is a one-time operation that you must run to prepare your Active Directory forest to support devices. You must be logged on with enterprise administrator permissions and your Active Directory forest must have the Windows Server 2012 R2 schema to complete this procedure.",
          "pos": [
            13,
            288
          ],
          "nodes": [
            {
              "content": "This is a one-time operation that you must run to prepare your Active Directory forest to support devices.",
              "pos": [
                0,
                106
              ]
            },
            {
              "content": "You must be logged on with enterprise administrator permissions and your Active Directory forest must have the Windows Server 2012 R2 schema to complete this procedure.",
              "pos": [
                107,
                275
              ]
            }
          ]
        }
      ]
    },
    {
      "content": "On your federation server, open a Windows PowerShell command window and type:",
      "pos": [
        10973,
        11050
      ]
    },
    {
      "content": "<bpt id=\"p1\">*</bpt>Initialize-ADDeviceRegistration<ept id=\"p1\">*</ept>",
      "pos": [
        11051,
        11084
      ]
    },
    {
      "content": "When prompted for ServiceAccountName, enter the name of the service account you selected as the service account for AD FS.",
      "pos": [
        11089,
        11211
      ]
    },
    {
      "content": "If it is a gMSA account, enter the account in the domain\\accountname$ format.",
      "pos": [
        11212,
        11289
      ]
    },
    {
      "content": "For a domain account, use the format domain\\accountname.",
      "pos": [
        11290,
        11346
      ]
    },
    {
      "content": "Enable device authentication in AD FS",
      "pos": [
        11353,
        11390
      ]
    },
    {
      "pos": [
        11395,
        11512
      ],
      "content": "On your federation server, open the AD FS management console and navigate to <bpt id=\"p1\">**</bpt>AD FS<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>Authentication Policies<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        11516,
        11589
      ],
      "content": "Select E<bpt id=\"p1\">**</bpt>dit Global Primary Authentication…<ept id=\"p1\">**</ept> from the <bpt id=\"p2\">**</bpt>Actions<ept id=\"p2\">**</ept> pane."
    },
    {
      "pos": [
        11593,
        11654
      ],
      "content": "Check <bpt id=\"p1\">**</bpt>Enable device authentication<ept id=\"p1\">**</ept> and then select<bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>."
    },
    {
      "content": "By default, AD FS will periodically remove unused devices from Active Directory.",
      "pos": [
        11658,
        11738
      ]
    },
    {
      "content": "You must disable this task when using Azure Active Directory Device Registration so that devices can be managed in Azure.",
      "pos": [
        11739,
        11860
      ]
    },
    {
      "content": "Disable unused device cleanup",
      "pos": [
        11867,
        11896
      ]
    },
    {
      "content": "On your federation server, open a Windows PowerShell command window and type:",
      "pos": [
        11900,
        11977
      ]
    },
    {
      "content": "Configure a federation relationship with Azure Active Directory and Configure Directory Sync Tool",
      "pos": [
        12037,
        12134
      ]
    },
    {
      "content": "The following section will help you set up a federation trust between Azure Active Directory and AD FS.",
      "pos": [
        12135,
        12238
      ]
    },
    {
      "content": "Some steps may take you away from this page.",
      "pos": [
        12239,
        12283
      ]
    },
    {
      "content": "Follow the instructions below and then return to this guide.",
      "pos": [
        12284,
        12344
      ]
    },
    {
      "content": "Integrate Azure Active Directory with local Active Directory and configure single sign-on",
      "pos": [
        12346,
        12435
      ]
    },
    {
      "pos": [
        12543,
        12591
      ],
      "content": "Log on to the Azure Portal as <bpt id=\"p1\">**</bpt>Administrator<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        12595,
        12641
      ],
      "content": "On the left pane, select <bpt id=\"p1\">**</bpt>Active Directory<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        12645,
        12693
      ],
      "content": "On the <bpt id=\"p1\">**</bpt>Directory<ept id=\"p1\">**</ept> tab, select your directory."
    },
    {
      "pos": [
        12697,
        12738
      ],
      "content": "Select the <bpt id=\"p1\">**</bpt>Directory Integration<ept id=\"p1\">**</ept> tab."
    },
    {
      "content": "Under the integration with local active directory section, locate the Directory Sync option and select Activated.",
      "pos": [
        12742,
        12855
      ]
    },
    {
      "content": "Follow the steps 1 through 4 to integrate Azure Active Directory with your local directory.",
      "pos": [
        12859,
        12950
      ]
    },
    {
      "content": ".",
      "pos": [
        12951,
        12952
      ]
    },
    {
      "content": "Add domains",
      "pos": [
        12960,
        12971
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Configure single-sign on and prepare for directory sync<ept id=\"p1\">**</ept>.",
      "pos": [
        12979,
        13039
      ]
    },
    {
      "content": "If you have already deployed AD FS you can follow these sub-sections to configure and validate a trust between AD FS and Azure AD.",
      "pos": [
        13040,
        13170
      ]
    },
    {
      "pos": [
        13181,
        13296
      ],
      "content": "<bpt id=\"p1\">[</bpt>Install Windows PowerShell for single sign-on with AD FS<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/jj151814.aspx)</ept>."
    },
    {
      "pos": [
        13306,
        13406
      ],
      "content": "<bpt id=\"p1\">[</bpt>Set up a trust between AD FS and Azure AD<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/jj205461.aspx)</ept>."
    },
    {
      "pos": [
        13416,
        13518
      ],
      "content": "<bpt id=\"p1\">[</bpt>Verify and manage single sign-on with AD FS<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/jj151809.aspx)</ept>."
    },
    {
      "content": "Additional AD FS References",
      "pos": [
        13529,
        13556
      ]
    },
    {
      "content": "Install and run the directory sync tool.",
      "pos": [
        13620,
        13660
      ]
    },
    {
      "content": "If you have already installed DirSync, you must upgrade to the latest version.",
      "pos": [
        13661,
        13739
      ]
    },
    {
      "content": "The minimum version required is 6862.0000.",
      "pos": [
        13740,
        13782
      ]
    },
    {
      "content": "Verify and manage directory sync",
      "pos": [
        13788,
        13820
      ]
    },
    {
      "content": "Configure some additional claim rules on the relying party trust object for Azure Active Directory.",
      "pos": [
        13827,
        13926
      ]
    },
    {
      "content": "This relying party trust object is typically named Microsoft Office 365 Identity Platform.",
      "pos": [
        13927,
        14017
      ]
    },
    {
      "content": "Configure the Azure Active Directory relying party trust claim rules",
      "pos": [
        14022,
        14090
      ]
    },
    {
      "content": "Open the AD FS management console and navigate to AD FS &gt; Trust Relationships &gt; <bpt id=\"p1\">**</bpt>Relying Party Trusts<ept id=\"p1\">**</ept>.",
      "pos": [
        14095,
        14200
      ]
    },
    {
      "content": "Right-click on the <bpt id=\"p1\">**</bpt>Microsoft Office 365 Identity Platform relying party trust object<ept id=\"p1\">**</ept> and select **Edit Claim Rules…",
      "pos": [
        14201,
        14320
      ]
    },
    {
      "pos": [
        14324,
        14383
      ],
      "content": "On the <bpt id=\"p1\">**</bpt>Issuance Transform Rules<ept id=\"p1\">**</ept> tab, select Add Rule.**"
    },
    {
      "content": "Select <bpt id=\"p1\">**</bpt>Send Claims Using a Custom Rule<ept id=\"p1\">**</ept> from the <bpt id=\"p2\">**</bpt>Claim<ept id=\"p2\">**</ept> rule template drop down box.",
      "pos": [
        14387,
        14477
      ]
    },
    {
      "content": "Select <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>.",
      "pos": [
        14478,
        14494
      ]
    },
    {
      "pos": [
        14498,
        14563
      ],
      "content": "Type Auth Method Claim Rule in the <bpt id=\"p1\">**</bpt>Claim rule name<ept id=\"p1\">**</ept>: text box."
    },
    {
      "content": "Type the following claim rule in the Claim rule: text box:",
      "pos": [
        14567,
        14625
      ]
    },
    {
      "pos": [
        14631,
        14736
      ],
      "content": "` c:[Type == \"http://schemas.microsoft.com/claims/authnmethodsreferences\"]`\n    `=> issue(claim = c);`",
      "leadings": [
        "",
        "   "
      ],
      "nodes": []
    },
    {
      "pos": [
        14741,
        14787
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept> twice to complete the dialog box."
    },
    {
      "content": "Configure some additional authentication class references on the relying party trust object for Azure Active Directory.",
      "pos": [
        14791,
        14910
      ]
    },
    {
      "content": "This relying party trust object is typically named Microsoft Office 365 Identity Platform.",
      "pos": [
        14911,
        15001
      ]
    },
    {
      "content": "Configure the Azure Active Directory relying party trust authentication class reference",
      "pos": [
        15007,
        15094
      ]
    },
    {
      "content": "On your federation server, open a Windows PowerShell command window and type:",
      "pos": [
        15096,
        15173
      ]
    },
    {
      "content": "Set-AdfsRelyingPartyTrust -TargetName",
      "pos": [
        15176,
        15213
      ]
    },
    {
      "content": "-AllowedAuthenticationClassReferences wiaormultiauthn",
      "pos": [
        15229,
        15282
      ]
    },
    {
      "content": "Where",
      "pos": [
        15286,
        15291
      ]
    },
    {
      "content": "is the relying party object name for your Azure Active Directory relying party trust object.",
      "pos": [
        15307,
        15399
      ]
    },
    {
      "content": "This object is typically named Microsoft Office 365 Identity Platform.",
      "pos": [
        15400,
        15470
      ]
    },
    {
      "content": "Configure DirSync to allow device object write-back",
      "pos": [
        15476,
        15527
      ]
    },
    {
      "content": "You must configure Directory Sync (DirSync) to allow device object write-back.",
      "pos": [
        15528,
        15606
      ]
    },
    {
      "content": "Devices created in Azure Active Directory will be written down to your Active Directory.",
      "pos": [
        15607,
        15695
      ]
    },
    {
      "content": "Devices created in Azure Active Directory may take up to 3 hours before they are written back to Active Directory.",
      "pos": [
        15696,
        15810
      ]
    },
    {
      "pos": [
        15812,
        15973
      ],
      "content": "[Azure.Note]\nYou must be logged on with enterprise administrator permissions to complete the following procedure. Download the latest build of dirsync.exe here.",
      "leadings": [
        "",
        ">"
      ],
      "nodes": [
        {
          "content": "[Azure.Note]",
          "pos": [
            0,
            12
          ]
        },
        {
          "content": "You must be logged on with enterprise administrator permissions to complete the following procedure. Download the latest build of dirsync.exe here.",
          "pos": [
            13,
            160
          ],
          "nodes": [
            {
              "content": "You must be logged on with enterprise administrator permissions to complete the following procedure.",
              "pos": [
                0,
                100
              ]
            },
            {
              "content": "Download the latest build of dirsync.exe here.",
              "pos": [
                101,
                147
              ]
            }
          ]
        }
      ]
    },
    {
      "content": "Office 365 license or Azure AD Premium license is required to allow device write-back to Active Directory.",
      "pos": [
        15977,
        16083
      ]
    },
    {
      "content": "If you have just completed the DirSync installation wizard, sign-out and then sign-in before continuing.",
      "pos": [
        16087,
        16191
      ]
    },
    {
      "content": "This will ensure you have an updated access token.",
      "pos": [
        16192,
        16242
      ]
    },
    {
      "content": "It can take up to 3 hours for device objects to be written-back to Active Directory Domain Services.",
      "pos": [
        16245,
        16345
      ]
    },
    {
      "content": "On your directory sync server, open a Windows PowerShell command window and issue the following commands:",
      "pos": [
        16350,
        16455
      ]
    },
    {
      "content": "When prompted for credentials, type your cloud service administrator account credentials and your Active Directory administrator credentials.",
      "pos": [
        16564,
        16705
      ]
    },
    {
      "content": "Enable-MSOnlineObjectManagement –ObjectTypes Device –TargetCredential $AADCreds -Credential $ADCreds",
      "pos": [
        16708,
        16808
      ]
    },
    {
      "content": "Configure federation services to provide multi-factor authentication",
      "pos": [
        16815,
        16883
      ]
    },
    {
      "content": "Devices that are registered with your organization can be used as a seamless second factor of authentication.",
      "pos": [
        16884,
        16993
      ]
    },
    {
      "content": "Therefore, it is recommended that you require strong authentication when registering a device.",
      "pos": [
        16994,
        17088
      ]
    },
    {
      "content": "You can follow the guide below to configure AD FS with Azure Multi-Factor Authentication and then return to this guide.",
      "pos": [
        17089,
        17208
      ]
    },
    {
      "content": "Follow the instructions for deploying Azure Multi-Factor Authentication.",
      "pos": [
        17209,
        17281
      ]
    },
    {
      "content": "Join devices to your workplace using Azure Active Directory Device Registration",
      "pos": [
        17286,
        17365
      ]
    },
    {
      "content": "Join an iOS device using Azure Active Directory Device Registration",
      "pos": [
        17371,
        17438
      ]
    },
    {
      "content": "Azure Active Directory Device Registration uses the Over-the-Air Profile enrollment process for iOS devices.",
      "pos": [
        17440,
        17548
      ]
    },
    {
      "content": "This process begins with the user connecting to the profile enrollment URL using the Safari web browser.",
      "pos": [
        17549,
        17653
      ]
    },
    {
      "content": "The URL format is as follows:",
      "pos": [
        17654,
        17683
      ]
    },
    {
      "content": "Where",
      "pos": [
        17778,
        17783
      ]
    },
    {
      "content": "is the domain name that you have configured with Azure Active Directory.",
      "pos": [
        17801,
        17873
      ]
    },
    {
      "content": "For example, if your domain name is contoso.com, the URL would be:",
      "pos": [
        17874,
        17940
      ]
    },
    {
      "content": "There are many different ways to communicate this URL to your users.",
      "pos": [
        18030,
        18098
      ]
    },
    {
      "content": "One recommended way is to publish this URL in a custom application access denied message in AD FS.",
      "pos": [
        18099,
        18197
      ]
    },
    {
      "content": "This is covered in the upcoming section: Create an application access policy and custom access denied message.",
      "pos": [
        18198,
        18308
      ]
    },
    {
      "content": "Join a Windows 8.1 device using Azure Active Directory Device Registration",
      "pos": [
        18313,
        18387
      ]
    },
    {
      "pos": [
        18392,
        18478
      ],
      "content": "On your Windows 8.1 device, navigate to <bpt id=\"p1\">**</bpt>PC Settings<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>Network<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">**</bpt>Workplace<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Enter your user name in UPN format.",
      "pos": [
        18482,
        18517
      ]
    },
    {
      "content": "For example, dan@contoso.com..",
      "pos": [
        18518,
        18548
      ]
    },
    {
      "pos": [
        18552,
        18568
      ],
      "content": "Select <bpt id=\"p1\">**</bpt>Join<ept id=\"p1\">**</ept>."
    },
    {
      "content": "When prompted, sign-in with your credentials.",
      "pos": [
        18572,
        18617
      ]
    },
    {
      "content": "The device is now joined.",
      "pos": [
        18618,
        18643
      ]
    },
    {
      "content": "Join an Android device using Azure Active Directory Device Registration",
      "pos": [
        18649,
        18720
      ]
    },
    {
      "content": "The Azure Authenticator for Android topic has instructions on how to install Azure authenticator app on your Android device and add a work account.",
      "pos": [
        18722,
        18869
      ]
    },
    {
      "content": "When a work account is created successfully on an Android device, that device is workplace joined to the organization.",
      "pos": [
        18870,
        18988
      ]
    },
    {
      "content": "Verify registered devices are written-back to Active Directory",
      "pos": [
        18994,
        19056
      ]
    },
    {
      "content": "You can view and verify that your device objects have been written back to your Active Directory using LDP.exe or ADSI Edit.",
      "pos": [
        19057,
        19181
      ]
    },
    {
      "content": "Both are available with the Active Directory Administrator tools.",
      "pos": [
        19182,
        19247
      ]
    },
    {
      "content": "By default, device objects that are written-back from Azure Active Directory will be placed in the same domain as your AD FS farm.",
      "pos": [
        19249,
        19379
      ]
    },
    {
      "content": "Create an application access policy and custom access denied message",
      "pos": [
        19429,
        19497
      ]
    },
    {
      "content": "Consider the following scenario: You create an application Relying Party Trust in AD FS and configure an Issuance Authorization Rule that allows only registered devices.",
      "pos": [
        19498,
        19667
      ]
    },
    {
      "content": "Now only devices that are registered are allowed to access the application.",
      "pos": [
        19668,
        19743
      ]
    },
    {
      "content": "To make it easy for your users to gain access to the application, you configure a custom access denied message that includes instructions on how to join their device.",
      "pos": [
        19744,
        19910
      ]
    },
    {
      "content": "Now your users have a seamless way to register their devices in order to access an application.",
      "pos": [
        19911,
        20006
      ]
    },
    {
      "content": "The following steps will show you how to implement this scenario.",
      "pos": [
        20008,
        20073
      ]
    },
    {
      "content": "This section assumes that you have already configured a Relying Party Trust for your application in AD FS.",
      "pos": [
        20088,
        20194
      ]
    },
    {
      "content": "Open the AD FS MMC tool and navigate to AD FS &gt; Trust Relationships &gt; Relying Party Trusts.",
      "pos": [
        20199,
        20290
      ]
    },
    {
      "content": "Locate the application for which this new access rule will apply.",
      "pos": [
        20294,
        20359
      ]
    },
    {
      "content": "Right-click the application and select Edit Claim Rules…",
      "pos": [
        20360,
        20416
      ]
    },
    {
      "pos": [
        20420,
        20497
      ],
      "content": "Select the <bpt id=\"p1\">**</bpt>Issuance Authorization Rules<ept id=\"p1\">**</ept> tab and then select <bpt id=\"p2\">**</bpt>Add Rule…<ept id=\"p2\">**</ept>"
    },
    {
      "content": "From the <bpt id=\"p1\">**</bpt>Claim rule<ept id=\"p1\">**</ept> template drop down list, select <bpt id=\"p2\">**</bpt>Permit or Deny Users Based on an Incoming Claim<ept id=\"p2\">**</ept>.",
      "pos": [
        20501,
        20609
      ]
    },
    {
      "content": "Select <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>.",
      "pos": [
        20610,
        20626
      ]
    },
    {
      "pos": [
        20630,
        20707
      ],
      "content": "In the Claim Rule name: field type: <bpt id=\"p1\">**</bpt>Permit access from registered devices<ept id=\"p1\">**</ept>"
    },
    {
      "pos": [
        20711,
        20787
      ],
      "content": "From the Incoming claim type: drop down list, select <bpt id=\"p1\">**</bpt>Is Registered User<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        20791,
        20841
      ],
      "content": "In the Incoming claim value: field, type: <bpt id=\"p1\">**</bpt>true<ept id=\"p1\">**</ept>"
    },
    {
      "pos": [
        20845,
        20889
      ],
      "content": "Select <bpt id=\"p1\">**</bpt>Finish<ept id=\"p1\">**</ept> and then select <bpt id=\"p2\">**</bpt>Apply<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Remove any rules that are more permissive than the rule you just created.",
      "pos": [
        20894,
        20967
      ]
    },
    {
      "content": "For example, remove the default",
      "pos": [
        20968,
        20999
      ]
    },
    {
      "pos": [
        21004,
        21112
      ],
      "content": "Select the <bpt id=\"p1\">**</bpt>Permit access to users with this incoming claim<ept id=\"p1\">**</ept> radio button.Permit Access to all Users rule."
    },
    {
      "content": "Your application is now configured to allow access only when the user is coming from a device that they registered and joined to the workplace.",
      "pos": [
        21114,
        21257
      ]
    },
    {
      "content": "For more advanced access polices, see Manage Risk with Multi-Factor Access Control.",
      "pos": [
        21258,
        21341
      ]
    },
    {
      "content": "Next, you will configure a custom error message for your application.",
      "pos": [
        21343,
        21412
      ]
    },
    {
      "content": "The error message will let users know that they must join their device to the workplace before they are allowed access to the application.",
      "pos": [
        21413,
        21551
      ]
    },
    {
      "content": "You can create a custom application access denied message using custom HTML and Windows PowerShell.",
      "pos": [
        21552,
        21651
      ]
    },
    {
      "content": "On your federation server, open a Windows PowerShell command window and type the following command.",
      "pos": [
        21653,
        21752
      ]
    },
    {
      "content": "Replace portions of the command with items that are specific to your system:",
      "pos": [
        21753,
        21829
      ]
    },
    {
      "content": "You must register your device before you can access this application.",
      "pos": [
        21934,
        22003
      ]
    },
    {
      "pos": [
        22005,
        22078
      ],
      "content": "<bpt id=\"p1\">**</bpt>If you are using an iOS device, select this link to join your device<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Join this iOS device to your workplace.",
      "pos": [
        22180,
        22219
      ]
    },
    {
      "pos": [
        22222,
        22348
      ],
      "content": "<bpt id=\"p1\">**</bpt>If you are using a Windows 8.1 device<ept id=\"p1\">**</ept>, you can join your device by going to **PC Settings **&gt; <bpt id=\"p2\">**</bpt>Network<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">**</bpt>Workplace<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Where \"<bpt id=\"p1\">**</bpt>relying party trust name<ept id=\"p1\">**</ept>\" is the name of your applications Relying Party Trust object in AD FS.",
      "pos": [
        22351,
        22457
      ]
    },
    {
      "content": "Where yourdomain.com is the domain name that you have configured with Azure Active Directory.",
      "pos": [
        22460,
        22553
      ]
    },
    {
      "content": "For example, contoso.com.",
      "pos": [
        22554,
        22579
      ]
    },
    {
      "content": "Be sure to remove any line breaks (if any) from the html content that you pass to the S<bpt id=\"p1\">**</bpt>et-AdfsRelyingPartyWebContent<ept id=\"p1\">**</ept> Cmdlet.",
      "pos": [
        22581,
        22709
      ]
    },
    {
      "content": "test",
      "pos": [
        22714,
        22718
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"Setting up on-premises conditional access using Azure Active Directory Device Registration | Microsoft Azure\"\n    description=\"A step-by-step guide to enable conditional access to on-premises applications using Active Directory Federation Service (AD FS) in Windows Server 2012 R2.\"\n    services=\"active-directory\"\n    documentationCenter=\"\"\n    authors=\"femila\"\n    manager=\"stevenpo\"\n    editor=\"\"/>\n\n<tags\n    ms.service=\"active-directory\"\n    ms.workload=\"identity\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.date=\"08/19/2015\"\n    ms.author=\"femila\"/>\n\n# Setting up on-premises conditional access using Azure Active Directory Device Registration\n\nPersonally owned devices of your users can be marked known to your organization by requiring the users to work place join their devices to the Azure Active Directory Device Registration service. Below is a step-by-step guide to enable conditional access to on-premises applications using Active Directory Federation Service (AD FS) in Windows Server 2012 R2.\n\n> [AZURE.NOTE]\n> Office 365 license or Azure AD Premium license is required when using devices registered in Azure Active Directory Device Registration service conditional access policies. This includes policies enforced by Active Directory Federation Services (AD FS) to on-premises resources.\n\nFor more information on the conditional access scenarios for on-premises, see [Join to Workplace from Any Device for SSO and Seamless Second Factor Authentication Across Company Applications](https://technet.microsoft.com/library/dn280945.aspx).\nThese capabilities are available to customers that purchase an Azure Active Directory Premium license.\n\nSupported Devices\n-------------------------------------------------------------------------\n* Windows 7 domain joined devices.\n* Windows 8.1 personal and domain joined devices.\n* iOS 6 and later.\n* Android 4.0 or later, Samsung GS3 or above phones, Samsung Note2 or above tablets.\n\nScenario Prerequisites\n------------------------------------------------------------------------\n* Windows Server Active Directory (Windows Server 2008 or above)\n* Updated schema in Windows Server 2012 R2\n* Subscription to Azure Active Directory Premium\n* Windows Server 2012 R2 Federation Services, configured for SSO to Azure AD\n* Windows Server 2012 R2 Web Application Proxy\n* Directory Synchronization Tool (DirSync) with device object write-back. [Download the latest build of dirsync.exe.](http://go.microsoft.com/fwlink/?LinkID=278924)\n\nKnown Issues in this release\n-------------------------------------------------------------------------------\n* Device based conditional access policies require device object write-back to Active Directory from Azure Active Directory. It can take up to 3 hours for device objects to be written-back to Active Directory.\n* iOS7 devices will always prompt the user to select a certificate during client certificate authentication. \n* iOS8 beta devices are not working at this time.\n\n\n## Deploy Azure Active Directory Device Registration Service\nUse this guide to deploy and configure Azure Active Directory Device Registration Service for your organization.\n\nThis guide assumes that you have configured Windows Server Active Directory and have subscribed to Microsoft Azure Active Directory. See prerequisites above.\n\nTo deploy Azure Active Directory Device Registration Service with your Azure Active Directory tenant, complete the tasks in the following checklist, in order. When a reference link takes you to a conceptual topic, return to this checklist after you review the conceptual topic so that you can proceed with the remaining tasks in this checklist. Some tasks will include a scenario validation step that can help you confirm the step was completed successfully.\n\n**Checklist: Enable Azure Active Directory Device Registration**\n\nFollow the checklist below to enable and configure the Azure Active Directory Device Registration Service.\n\n| Task                                                                                                                                                                                                                                                                                                                                                                                             | Reference                                                       |\n|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|\n| Enable Device Registration in your Azure Active Directory tenant to allow devices to join the workplace. By default, multi-factor authentication is not enabled for the service. However, multi-factor authentication is recommended when registering a device. Before enabling multi-factor authentication in ADRS, ensure that AD FS is configured for a multi-factor authentication provider. | [Enable Azure Active Directory Device Registration](active-directory-conditional-access-device-registration-overview.md)               |\n| Devices will discover your Azure Active Directory Device Registration Service by looking for well-known DNS records. You must configure your company DNS so that devices can discover your Azure Active Directory Device Registration Service.                                                                                                                                                   | [Configure Azure Active Directory Device Registration discovery.](active-directory-conditional-access-device-registration-overview.md) |\n\n**Checklist: Deploy and configure Windows Server 2012 R2 Active Directory Federation Services and set up a federation relationship with Azure Active Directory**\nWith the next set of tasks, you integrate Windows Server 2012 R2 Federation services with Azure Active Directory. This allows you to use devices registered in Azure Active Directory Device Registration Service for conditional access policies in AD FS.\n\n\n| Task                                                                                                                                                                                                                                   | Reference                                                                                         |\n|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|\n| Deploy Active Directory Domain Services domain with the Windows Server 2012 R2 schema extensions. (You do not need to upgrade any of your domain controllers to Windows Server 2012 R2. The schema upgrade is the only requirement).   | Upgrade your Active Directory Domain Services Schema.                                             |\n| Deploy Windows Server 2012 R2 Federation Services along with the Web Application Proxy.                                                                                                                                                | Deploy Windows Server 2012 R2 Federation Services along with the Web Application Proxy.           |\n| Your Active Directory Domain Services forest must be configured with the objects and containers needed to support device objects. You will also enable Device Authentication in AD FS.                                                 | Prepare your Active Directory forest to support devices.                                          |\n| Set up a federation relationship with your organization and Azure Active Directory.,This step will walk you through configuring your Azure Active Directory tenant with your Windows Server 2012 R2 Federation Services.               | Configure a federation relationship with Azure Active Directory and Configure Directory Sync Tool |\n| Configure Directory Sync (DirSync) to allow device object write-back. Devices created in Azure Active Directory will be written down to your Active Directory.                                                                         | Configure DirSync to allow device object write-back                                               |\n| It is strongly recommended that you configure a multi-factor authentication provider with Windows Server 2012 R2 Federation Services.,This will allow your users to securely register their devices using multi-factor authentication. | Configure federation services to provide multi-factor authentication.                             |\n\n\n### Upgrade your Active Directory Domain Services Schema\n> [AZURE.NOTE]\n> Upgrading your Active Directory schema cannot be reversed. It is recommended that you perform this in a test environment.\n\n1. Log in to your domain controller with an account that has both Enterprise Admin and Schema Admin rights.\n2. Copy the [media]\\support\\adprep directory and sub-directories to one of your Active Directory domain controllers. \n3. Where [media] is the path to the Windows Server 2012 R2 installation media.\n4. From a command prompt, navigate to the adprep directory and execute: adprep.exe /forestprep. Follow the onscreen instructions to complete the schema upgrade.\n\n### Deploy Windows Server 2012 R2 Federation Services along with the Web Application Proxy\nFollow the two guides below to deploy Windows Server 2012 R2 Federation Services with the Web Application Proxy and then return to this guide.\nFollow the instructions for deploying a Windows Server 2012 R2 Federation Server Farm.\n\n> [AZURE.NOTE]\n> When deploying AD FS, you must skip the optional step named: Optional step: Configure a federation server with Device Registration Service (DRS). This step is not needed when using Azure Active Directory Device Registration.\nFollow the instructions for deploying a Windows Server 2012 R2 Federation Server Proxy.\n\nInstall the latest update for Windows Server 2012 R2 on all of your Windows Server 2012 R2 Federation and Proxy servers. This can be done before or after configuring your federation farm. The update can be found here: Windows Server 2012 R2 Update.\n\n\n### Prepare your Active Directory forest to support devices\n\n> [AZURE.NOTE]\n>This is a one-time operation that you must run to prepare your Active Directory forest to support devices. You must be logged on with enterprise administrator permissions and your Active Directory forest must have the Windows Server 2012 R2 schema to complete this procedure.\n\n1. On your federation server, open a Windows PowerShell command window and type:\n*Initialize-ADDeviceRegistration*\n\n2. When prompted for ServiceAccountName, enter the name of the service account you selected as the service account for AD FS. If it is a gMSA account, enter the account in the domain\\accountname$ format. For a domain account, use the format domain\\accountname.\n\n\n### Enable device authentication in AD FS\n\n1. On your federation server, open the AD FS management console and navigate to **AD FS** > **Authentication Policies**.\n2. Select E**dit Global Primary Authentication…** from the **Actions** pane.\n3. Check **Enable device authentication** and then select**OK**.\n4. By default, AD FS will periodically remove unused devices from Active Directory. You must disable this task when using Azure Active Directory Device Registration so that devices can be managed in Azure.\n\n\n### Disable unused device cleanup\n1. On your federation server, open a Windows PowerShell command window and type:\n`*Set-AdfsDeviceRegistration -MaximumInactiveDays 0*`\n\n\n###Configure a federation relationship with Azure Active Directory and Configure Directory Sync Tool\nThe following section will help you set up a federation trust between Azure Active Directory and AD FS. Some steps may take you away from this page. Follow the instructions below and then return to this guide.\n\nIntegrate Azure Active Directory with local Active Directory and configure single sign-on\n------------------------------------------------------------------------------------------------------\n\n1. Log on to the Azure Portal as **Administrator**.\n2. On the left pane, select **Active Directory**.\n3. On the **Directory** tab, select your directory.\n4. Select the **Directory Integration** tab.\n5. Under the integration with local active directory section, locate the Directory Sync option and select Activated.\n6. Follow the steps 1 through 4 to integrate Azure Active Directory with your local directory. .\n  1. **Add domains**\n  2. **Configure single-sign on and prepare for directory sync**. If you have already deployed AD FS you can follow these sub-sections to configure and validate a trust between AD FS and Azure AD. \n      *  [Install Windows PowerShell for single sign-on with AD FS](https://msdn.microsoft.com/library/azure/jj151814.aspx).\n      *  [Set up a trust between AD FS and Azure AD](https://msdn.microsoft.com/library/azure/jj205461.aspx).\n      *  [Verify and manage single sign-on with AD FS](https://msdn.microsoft.com/library/azure/jj151809.aspx).\n      *  [Additional AD FS References](https://msdn.microsoft.com/library/azure/dn151321.aspx)\n\n  3. Install and run the directory sync tool. If you have already installed DirSync, you must upgrade to the latest version. The minimum version required is 6862.0000.\n  4. Verify and manage directory sync \n  5. Configure some additional claim rules on the relying party trust object for Azure Active Directory. This relying party trust object is typically named Microsoft Office 365 Identity Platform.\n\n###Configure the Azure Active Directory relying party trust claim rules\n\n1. Open the AD FS management console and navigate to AD FS > Trust Relationships > **Relying Party Trusts**. Right-click on the **Microsoft Office 365 Identity Platform relying party trust object** and select **Edit Claim Rules…\n2. On the **Issuance Transform Rules** tab, select Add Rule.**\n3. Select **Send Claims Using a Custom Rule** from the **Claim** rule template drop down box. Select **Next**.\n4. Type Auth Method Claim Rule in the **Claim rule name**: text box.\n5. Type the following claim rule in the Claim rule: text box:\n\n    ` c:[Type == \"http://schemas.microsoft.com/claims/authnmethodsreferences\"]`\n       `=> issue(claim = c);`\n\n6. Click **OK** twice to complete the dialog box.\n7. Configure some additional authentication class references on the relying party trust object for Azure Active Directory. This relying party trust object is typically named Microsoft Office 365 Identity Platform.\n\n\n###Configure the Azure Active Directory relying party trust authentication class reference\n\nOn your federation server, open a Windows PowerShell command window and type:\n\n*Set-AdfsRelyingPartyTrust -TargetName <RPObjectName> -AllowedAuthenticationClassReferences wiaormultiauthn*\n\n\nWhere <RPObjectName> is the relying party object name for your Azure Active Directory relying party trust object. This object is typically named Microsoft Office 365 Identity Platform.\n\n### Configure DirSync to allow device object write-back\nYou must configure Directory Sync (DirSync) to allow device object write-back. Devices created in Azure Active Directory will be written down to your Active Directory. Devices created in Azure Active Directory may take up to 3 hours before they are written back to Active Directory.\n>[Azure.Note]\n>You must be logged on with enterprise administrator permissions to complete the following procedure. Download the latest build of dirsync.exe here.\n\n> Office 365 license or Azure AD Premium license is required to allow device write-back to Active Directory.\n\n> If you have just completed the DirSync installation wizard, sign-out and then sign-in before continuing. This will ensure you have an updated access token.\n\n>It can take up to 3 hours for device objects to be written-back to Active Directory Domain Services.\n\n1. On your directory sync server, open a Windows PowerShell command window and issue the following commands:\n\n    `Import-Module DirSync`\n    \n    `$AADCreds = Get-Credential`\n    \n    `$ADCreds = Get-Credential`\n\n2. When prompted for credentials, type your cloud service administrator account credentials and your Active Directory administrator credentials.\n\n*Enable-MSOnlineObjectManagement –ObjectTypes Device –TargetCredential $AADCreds -Credential $ADCreds*\n\n### Configure federation services to provide multi-factor authentication\nDevices that are registered with your organization can be used as a seamless second factor of authentication. Therefore, it is recommended that you require strong authentication when registering a device. You can follow the guide below to configure AD FS with Azure Multi-Factor Authentication and then return to this guide.\nFollow the instructions for deploying Azure Multi-Factor Authentication.\n\n## Join devices to your workplace using Azure Active Directory Device Registration\n\n### Join an iOS device using Azure Active Directory Device Registration\n\nAzure Active Directory Device Registration uses the Over-the-Air Profile enrollment process for iOS devices. This process begins with the user connecting to the profile enrollment URL using the Safari web browser. The URL format is as follows:\n\n    https://enterpriseregistration.windows.net/enrollmentserver/otaprofile/\"yourdomainname\"\n\nWhere <yourdomainname> is the domain name that you have configured with Azure Active Directory. For example, if your domain name is contoso.com, the URL would be:\n\n    https://enterpriseregistration.windows.net/enrollmentserver/otaprofile/contoso.com\n\nThere are many different ways to communicate this URL to your users. One recommended way is to publish this URL in a custom application access denied message in AD FS. This is covered in the upcoming section: Create an application access policy and custom access denied message.\n\n###Join a Windows 8.1 device using Azure Active Directory Device Registration\n\n1. On your Windows 8.1 device, navigate to **PC Settings** > **Network** > **Workplace**.\n2. Enter your user name in UPN format. For example, dan@contoso.com..\n3. Select **Join**.\n4. When prompted, sign-in with your credentials. The device is now joined.\n\n### Join an Android device using Azure Active Directory Device Registration\n\nThe Azure Authenticator for Android topic has instructions on how to install Azure authenticator app on your Android device and add a work account. When a work account is created successfully on an Android device, that device is workplace joined to the organization.\n\n### Verify registered devices are written-back to Active Directory\nYou can view and verify that your device objects have been written back to your Active Directory using LDP.exe or ADSI Edit. Both are available with the Active Directory Administrator tools.\n\nBy default, device objects that are written-back from Azure Active Directory will be placed in the same domain as your AD FS farm.\n\n`CN=RegisteredDevices,defaultNamingContext`\n\n###Create an application access policy and custom access denied message\nConsider the following scenario: You create an application Relying Party Trust in AD FS and configure an Issuance Authorization Rule that allows only registered devices. Now only devices that are registered are allowed to access the application. To make it easy for your users to gain access to the application, you configure a custom access denied message that includes instructions on how to join their device. Now your users have a seamless way to register their devices in order to access an application.\n\nThe following steps will show you how to implement this scenario.\n>[AZURE.NOTE]\nThis section assumes that you have already configured a Relying Party Trust for your application in AD FS.\n\n1. Open the AD FS MMC tool and navigate to AD FS > Trust Relationships > Relying Party Trusts.\n2. Locate the application for which this new access rule will apply. Right-click the application and select Edit Claim Rules…\n3. Select the **Issuance Authorization Rules** tab and then select **Add Rule…**\n4. From the **Claim rule** template drop down list, select **Permit or Deny Users Based on an Incoming Claim**. Select **Next**.\n5. In the Claim Rule name: field type: **Permit access from registered devices**\n6. From the Incoming claim type: drop down list, select **Is Registered User**.\n7. In the Incoming claim value: field, type: **true**\n9. Select **Finish** and then select **Apply**.\n10. Remove any rules that are more permissive than the rule you just created. For example, remove the default \n8. Select the **Permit access to users with this incoming claim** radio button.Permit Access to all Users rule.\n\nYour application is now configured to allow access only when the user is coming from a device that they registered and joined to the workplace. For more advanced access polices, see Manage Risk with Multi-Factor Access Control.\n\nNext, you will configure a custom error message for your application. The error message will let users know that they must join their device to the workplace before they are allowed access to the application. You can create a custom application access denied message using custom HTML and Windows PowerShell.\n\nOn your federation server, open a Windows PowerShell command window and type the following command. Replace portions of the command with items that are specific to your system:\n\n`Set-AdfsRelyingPartyWebContent -Name \"relying party trust name\" -ErrorPageAuthorizationErrorMessage `\nYou must register your device before you can access this application.\n\n**If you are using an iOS device, select this link to join your device**: \n\n    a href='https://enterpriseregistration.windows.net/enrollmentserver/otaprofile/yourdomain.com\n\nJoin this iOS device to your workplace.\n\n\n**If you are using a Windows 8.1 device**, you can join your device by going to **PC Settings **> **Network** > **Workplace**.\n\n\nWhere \"**relying party trust name**\" is the name of your applications Relying Party Trust object in AD FS. \n Where yourdomain.com is the domain name that you have configured with Azure Active Directory. For example, contoso.com. \nBe sure to remove any line breaks (if any) from the html content that you pass to the S**et-AdfsRelyingPartyWebContent** Cmdlet.\n\n\n\n\ntest\n"
}