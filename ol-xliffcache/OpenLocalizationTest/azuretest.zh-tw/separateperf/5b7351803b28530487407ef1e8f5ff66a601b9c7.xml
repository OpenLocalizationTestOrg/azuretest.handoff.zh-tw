{
  "nodes": [
    {
      "content": "Add Azure automation runbooks to recovery plans",
      "pos": [
        27,
        74
      ]
    },
    {
      "content": "This article describes how Azure Site Recovery now enables you to extend recovery plans using Azure Automation to complete complex tasks during recovery to Azure",
      "pos": [
        93,
        254
      ]
    },
    {
      "content": "Add Azure automation runbooks to recovery plans",
      "pos": [
        581,
        628
      ]
    },
    {
      "content": "This tutorial describes how Azure Site Recovery integrates with Azure",
      "pos": [
        631,
        700
      ]
    },
    {
      "content": "Automation to provide extensibility to recovery plans.",
      "pos": [
        701,
        755
      ]
    },
    {
      "content": "Recovery plans",
      "pos": [
        756,
        770
      ]
    },
    {
      "content": "can orchestrate recovery of your virtual machines protected using Azure Site Recovery for both replication to secondary cloud and replication to Azure scenarios.",
      "pos": [
        771,
        932
      ]
    },
    {
      "content": "They also help in making the recovery <bpt id=\"p1\">**</bpt>consistently accurate<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>repeatable<ept id=\"p2\">**</ept>, and <bpt id=\"p3\">**</bpt>automated<ept id=\"p3\">**</ept>.",
      "pos": [
        933,
        1032
      ]
    },
    {
      "content": "If you are failing over your virtual machines to Azure, integration with Azure Automation extends the",
      "pos": [
        1033,
        1134
      ]
    },
    {
      "content": "recovery plans and gives you capability to execute runbooks, thus allowing powerful automation tasks.",
      "pos": [
        1135,
        1236
      ]
    },
    {
      "content": "If you have not heard about Azure Automation yet, sign up",
      "pos": [
        1238,
        1295
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](http://azure.microsoft.com/services/automation/)</ept> and",
      "pos": [
        1296,
        1355
      ]
    },
    {
      "content": "download their sample scripts",
      "pos": [
        1356,
        1385
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](http://azure.microsoft.com/documentation/scripts/)</ept>.",
      "pos": [
        1386,
        1444
      ]
    },
    {
      "content": "Read",
      "pos": [
        1445,
        1449
      ]
    },
    {
      "content": "more about <bpt id=\"p1\">[</bpt>Azure Site\nRecovery<ept id=\"p1\">](http://azure.microsoft.com/services/site-recovery/)</ept> and",
      "pos": [
        1450,
        1538
      ]
    },
    {
      "content": "how to orchestrate recovery to Azure using recovery plans",
      "pos": [
        1539,
        1596
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](http://azure.microsoft.com/blog/?p=166264)</ept>.",
      "pos": [
        1597,
        1647
      ]
    },
    {
      "content": "In this tutorial, we will look at how you can integrate Azure Automation",
      "pos": [
        1649,
        1721
      ]
    },
    {
      "content": "runbooks into recovery plans.",
      "pos": [
        1722,
        1751
      ]
    },
    {
      "content": "We will automate simple tasks that earlier",
      "pos": [
        1752,
        1794
      ]
    },
    {
      "content": "required manual intervention and see how to convert a multi-step",
      "pos": [
        1795,
        1859
      ]
    },
    {
      "content": "recovery into a single-click recovery action.",
      "pos": [
        1860,
        1905
      ]
    },
    {
      "content": "We will also look at how you",
      "pos": [
        1906,
        1934
      ]
    },
    {
      "content": "can troubleshoot a simple script if it goes wrong.",
      "pos": [
        1935,
        1985
      ]
    },
    {
      "content": "Protect the application to Azure",
      "pos": [
        1990,
        2022
      ]
    },
    {
      "content": "Let us begin with a simple application consisting of two virtual machines.",
      "pos": [
        2024,
        2098
      ]
    },
    {
      "content": "Here, we have a HRweb application of Fabrikam.",
      "pos": [
        2099,
        2145
      ]
    },
    {
      "content": "Fabrikam-HRweb-frontend and Fabrikam-Hrweb-backend are the two virtual machines protected to Azure using Azure Site Recovery.",
      "pos": [
        2146,
        2271
      ]
    },
    {
      "content": "To protect the virtual machines using Azure Site Recovery, follow the steps below.",
      "pos": [
        2272,
        2354
      ]
    },
    {
      "content": "Enable protection for your virtual machines.",
      "pos": [
        2361,
        2405
      ]
    },
    {
      "pos": [
        2411,
        2503
      ],
      "content": "Ensure that the virtual machines have completed initial replication\nand are replicating.",
      "leadings": [
        "",
        "    "
      ],
      "nodes": [
        {
          "content": "Ensure that the virtual machines have completed initial replication",
          "pos": [
            0,
            67
          ]
        },
        {
          "content": "and are replicating.",
          "pos": [
            68,
            88
          ]
        }
      ]
    },
    {
      "content": "Wait till the initial replication completes and the Replication status says Protected.",
      "pos": [
        2510,
        2596
      ]
    },
    {
      "content": "In this tutorial, we will create a recovery plan for the Fabrikam HRweb application to failover the application to Azure.",
      "pos": [
        2672,
        2793
      ]
    },
    {
      "content": "Then we will integrate it with a runbook that will create an endpoint on the failed over Azure virtual machine to serve web pages at port 80.",
      "pos": [
        2794,
        2935
      ]
    },
    {
      "content": "First, let's create a recovery plan for our application.",
      "pos": [
        2937,
        2993
      ]
    },
    {
      "content": "Create the recovery plan",
      "pos": [
        2998,
        3022
      ]
    },
    {
      "content": "To recover the application to Azure, you need to create a recovery plan.",
      "pos": [
        3024,
        3096
      ]
    },
    {
      "content": "Using a recovery plan you can specify the order of recovery of the",
      "pos": [
        3097,
        3163
      ]
    },
    {
      "content": "virtual machines.",
      "pos": [
        3164,
        3181
      ]
    },
    {
      "content": "The virtual machine placed in group 1 will recover and",
      "pos": [
        3182,
        3236
      ]
    },
    {
      "content": "start first, and then the virtual machine in group 2 will follow.",
      "pos": [
        3237,
        3302
      ]
    },
    {
      "content": "Create a Recovery Plan that looks like below.",
      "pos": [
        3304,
        3349
      ]
    },
    {
      "pos": [
        3403,
        3527
      ],
      "content": "To read more about recovery plans, read documentation <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">]</ept><bpt id=\"p2\">(https://msdn.microsoft.com/library/azure/dn788799.aspx \"</bpt>here<ept id=\"p2\">\")</ept>."
    },
    {
      "content": "Next, let's create the necessary artifacts in Azure Automation.",
      "pos": [
        3530,
        3593
      ]
    },
    {
      "content": "Create the automation account and its assets",
      "pos": [
        3598,
        3642
      ]
    },
    {
      "content": "You need an Azure Automation account to create runbooks.",
      "pos": [
        3644,
        3700
      ]
    },
    {
      "content": "If you do not",
      "pos": [
        3701,
        3714
      ]
    },
    {
      "content": "already have an account, navigate to Azure Automation tab denoted by",
      "pos": [
        3715,
        3783
      ]
    },
    {
      "content": "<ph id=\"ph1\">![](media/site-recovery-runbook-automation/02.png)</ph>and create a new account.",
      "pos": [
        3784,
        3859
      ]
    },
    {
      "content": "Give the account a name to identify with.",
      "pos": [
        3865,
        3906
      ]
    },
    {
      "content": "Specify a geographical region where you want to place the account.",
      "pos": [
        3912,
        3978
      ]
    },
    {
      "content": "It is recommended to place the account in the same region as the ASR vault.",
      "pos": [
        3980,
        4055
      ]
    },
    {
      "content": "Next, create the following assets in the Account.",
      "pos": [
        4109,
        4158
      ]
    },
    {
      "content": "Add a subscription name as asset",
      "pos": [
        4164,
        4196
      ]
    },
    {
      "pos": [
        4202,
        4366
      ],
      "content": "Add a new setting <ph id=\"ph1\">![](media/site-recovery-runbook-automation/04.png)</ph> in the Azure Automation Assets and select to <ph id=\"ph2\">![](media/site-recovery-runbook-automation/05.png)</ph>"
    },
    {
      "pos": [
        4372,
        4410
      ],
      "content": "Select the variable type as <bpt id=\"p1\">**</bpt>String<ept id=\"p1\">**</ept>"
    },
    {
      "pos": [
        4416,
        4466
      ],
      "content": "Specify variable name as <bpt id=\"p1\">**</bpt>AzureSubscriptionName<ept id=\"p1\">**</ept>"
    },
    {
      "content": "Specify your actual Azure Subscription name as the variable value.",
      "pos": [
        4528,
        4594
      ]
    },
    {
      "content": "You can identify the name of your subscription from the settings page of",
      "pos": [
        4654,
        4726
      ]
    },
    {
      "content": "your account on the Azure portal.",
      "pos": [
        4727,
        4760
      ]
    },
    {
      "content": "Add an Azure login credential as asset",
      "pos": [
        4767,
        4805
      ]
    },
    {
      "content": "Azure Automation uses Azure PowerShell to connect to the",
      "pos": [
        4807,
        4863
      ]
    },
    {
      "content": "subscription and operates on the artifacts there.",
      "pos": [
        4864,
        4913
      ]
    },
    {
      "content": "For this, you need to",
      "pos": [
        4914,
        4935
      ]
    },
    {
      "content": "authenticate using your Microsoft account or a work or school account.",
      "pos": [
        4936,
        5006
      ]
    },
    {
      "content": "You can store the account credentials in an asset to be used securely by",
      "pos": [
        5007,
        5079
      ]
    },
    {
      "content": "the runbook.",
      "pos": [
        5080,
        5092
      ]
    },
    {
      "pos": [
        5098,
        5259
      ],
      "content": "Add a new setting <ph id=\"ph1\">![](media/site-recovery-runbook-automation/04.png)</ph> in the Azure Automation Assets and select <ph id=\"ph2\">![](media/site-recovery-runbook-automation/09.png)</ph>"
    },
    {
      "pos": [
        5265,
        5328
      ],
      "content": "Select the Credential type as <bpt id=\"p1\">**</bpt>Windows PowerShell Credential<ept id=\"p1\">**</ept>"
    },
    {
      "pos": [
        5334,
        5373
      ],
      "content": "Specify the name as <bpt id=\"p1\">**</bpt>AzureCredential<ept id=\"p1\">**</ept>"
    },
    {
      "content": "Specify the username and password to sign-in with.",
      "pos": [
        5435,
        5485
      ]
    },
    {
      "content": "Now both these settings are available in your assets.",
      "pos": [
        5487,
        5540
      ]
    },
    {
      "content": "More information about how to connect to your subscription via",
      "pos": [
        5594,
        5656
      ]
    },
    {
      "content": "powershell is given",
      "pos": [
        5657,
        5676
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](../install-configure-powershell.md)</ept>.",
      "pos": [
        5677,
        5720
      ]
    },
    {
      "content": "Next, you will create a runbook in Azure Automation that can add an",
      "pos": [
        5722,
        5789
      ]
    },
    {
      "content": "endpoint for the front-end virtual machine after failover.",
      "pos": [
        5790,
        5848
      ]
    },
    {
      "content": "Azure automation context",
      "pos": [
        5853,
        5877
      ]
    },
    {
      "content": "ASR passes a context variable to the runbook to help you write",
      "pos": [
        5879,
        5941
      ]
    },
    {
      "content": "deterministic scripts.",
      "pos": [
        5942,
        5964
      ]
    },
    {
      "content": "One could argue that the names of the Cloud Service and the Virtual Machine are predictable, but happens that it is not always the case owing to certain scenarios such as the one where the name of the virtual machine name might have changed due to unsupported characters in Azure.",
      "pos": [
        5965,
        6245
      ]
    },
    {
      "content": "Hence this information is passed to the ASR recovery plan as part of the <bpt id=\"p1\">*</bpt>context<ept id=\"p1\">*</ept>.",
      "pos": [
        6246,
        6329
      ]
    },
    {
      "content": "Below is an example of how the context variable looks.",
      "pos": [
        6331,
        6385
      ]
    },
    {
      "content": "The table below contains name and description for each variable in the context.",
      "pos": [
        6755,
        6834
      ]
    },
    {
      "content": "Variable name",
      "pos": [
        6838,
        6851
      ]
    },
    {
      "content": "Description",
      "pos": [
        6858,
        6869
      ]
    },
    {
      "content": "RecoveryPlanName",
      "pos": [
        6880,
        6896
      ]
    },
    {
      "content": "Name of plan being run.",
      "pos": [
        6899,
        6922
      ]
    },
    {
      "content": "Helps you take action based on name using the same script",
      "pos": [
        6923,
        6980
      ]
    },
    {
      "content": "FailoverType",
      "pos": [
        6981,
        6993
      ]
    },
    {
      "content": "Specifies whether the failover is test, planned, or unplanned.",
      "pos": [
        6996,
        7058
      ]
    },
    {
      "content": "FailoverDirection",
      "pos": [
        7060,
        7077
      ]
    },
    {
      "content": "Specify whether recovery is to primary or secondary",
      "pos": [
        7080,
        7131
      ]
    },
    {
      "content": "GroupID",
      "pos": [
        7132,
        7139
      ]
    },
    {
      "content": "Identify the group number within the recovery plan when the plan is running",
      "pos": [
        7142,
        7217
      ]
    },
    {
      "content": "VmMap",
      "pos": [
        7218,
        7223
      ]
    },
    {
      "content": "Array of all the virtual machines in the group",
      "pos": [
        7226,
        7272
      ]
    },
    {
      "content": "VMMap key",
      "pos": [
        7273,
        7282
      ]
    },
    {
      "content": "Unique key (GUID) for each VM.",
      "pos": [
        7285,
        7315
      ]
    },
    {
      "content": "It's the same as the VMM ID of the virtual machine where applicable.",
      "pos": [
        7316,
        7384
      ]
    },
    {
      "content": "RoleName",
      "pos": [
        7386,
        7394
      ]
    },
    {
      "content": "Name of the Azure VM that's being recovered",
      "pos": [
        7397,
        7440
      ]
    },
    {
      "content": "CloudServiceName",
      "pos": [
        7441,
        7457
      ]
    },
    {
      "content": "Azure Cloud Service name under which the virtual machine is created.",
      "pos": [
        7460,
        7528
      ]
    },
    {
      "content": "To identify the VmMap Key in the context you could also go to the VM properties page in ASR and look at the VM GUID property.",
      "pos": [
        7531,
        7656
      ]
    },
    {
      "content": "Author an Automation runbook",
      "pos": [
        7713,
        7741
      ]
    },
    {
      "content": "Now create the runbook to open port 80 on the front-end virtual machine.",
      "pos": [
        7743,
        7815
      ]
    },
    {
      "pos": [
        7821,
        7906
      ],
      "content": "Create a new runbook in the Azure Automation account with the name\n**OpenPort80**",
      "leadings": [
        "",
        "    "
      ],
      "nodes": [
        {
          "content": "Create a new runbook in the Azure Automation account with the name",
          "pos": [
            0,
            66
          ]
        },
        {
          "content": "<bpt id=\"p1\">**</bpt>OpenPort80<ept id=\"p1\">**</ept>",
          "pos": [
            67,
            81
          ]
        }
      ]
    },
    {
      "content": "Navigate to the Author view of the runbook and enter the draft mode.",
      "pos": [
        7964,
        8032
      ]
    },
    {
      "content": "First specify the variable to use as the recovery plan context",
      "pos": [
        8038,
        8100
      ]
    },
    {
      "pos": [
        8174,
        8253
      ],
      "content": "Next connect to the subscription using the credential and\nsubscription name",
      "leadings": [
        "",
        "    "
      ],
      "nodes": [
        {
          "content": "Next connect to the subscription using the credential and",
          "pos": [
            0,
            57
          ]
        },
        {
          "content": "subscription name",
          "pos": [
            58,
            75
          ]
        }
      ]
    },
    {
      "pos": [
        8564,
        8656
      ],
      "content": "Note that you use the Azure assets – <bpt id=\"p1\">**</bpt>AzureCredential<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>AzureSubscriptionName<ept id=\"p2\">**</ept> here."
    },
    {
      "content": "Now specify the endpoint details and the GUID of the virtual machine for which you want to expose the endpoint, in this case the front-end virtual machine.",
      "pos": [
        8662,
        8817
      ]
    },
    {
      "content": "This specifies the Azure endpoint protocol, local port on the VM and its mapped public port.",
      "pos": [
        9037,
        9129
      ]
    },
    {
      "content": "These variables are parameters required by the Azure commands that add endpoints to VMs.",
      "pos": [
        9130,
        9218
      ]
    },
    {
      "content": "The VMGUID holds the GUID of the virtual machine you need to operate on.",
      "pos": [
        9219,
        9291
      ]
    },
    {
      "pos": [
        9298,
        9427
      ],
      "content": "The script will now extract the context for the given VM GUID and\ncreate an endpoint on the virtual machine referenced by it.",
      "leadings": [
        "",
        "    "
      ],
      "nodes": [
        {
          "content": "The script will now extract the context for the given VM GUID and",
          "pos": [
            0,
            65
          ]
        },
        {
          "content": "create an endpoint on the virtual machine referenced by it.",
          "pos": [
            66,
            125
          ]
        }
      ]
    },
    {
      "pos": [
        10222,
        10359
      ],
      "content": "Once this is complete, hit Publish <ph id=\"ph1\">![](media/site-recovery-runbook-automation/20.png)</ph> to allow your script to be available for execution."
    },
    {
      "content": "The complete script is given below for your reference",
      "pos": [
        10362,
        10415
      ]
    },
    {
      "content": "Add the script to the recovery plan",
      "pos": [
        11810,
        11845
      ]
    },
    {
      "content": "Once the script is ready, you can add it to the recovery plan that you created earlier.",
      "pos": [
        11847,
        11934
      ]
    },
    {
      "pos": [
        11940,
        12070
      ],
      "content": "In the recovery plan you created, choose to add a script after the\ngroup 2. ![](media/site-recovery-runbook-automation/15.png)",
      "leadings": [
        "",
        "    "
      ],
      "nodes": [
        {
          "content": "In the recovery plan you created, choose to add a script after the",
          "pos": [
            0,
            66
          ]
        },
        {
          "content": "group 2. ![](media/site-recovery-runbook-automation/15.png)",
          "pos": [
            67,
            126
          ],
          "nodes": [
            {
              "content": "group 2.",
              "pos": [
                0,
                8
              ]
            },
            {
              "content": "<ph id=\"ph1\">![](media/site-recovery-runbook-automation/15.png)</ph>",
              "pos": [
                9,
                59
              ]
            }
          ]
        }
      ]
    },
    {
      "content": "Specify a script name.",
      "pos": [
        12076,
        12098
      ]
    },
    {
      "content": "This is just a friendly name for this script for showing within the Recovery plan.",
      "pos": [
        12099,
        12181
      ]
    },
    {
      "pos": [
        12187,
        12266
      ],
      "content": "In the failover to Azure script – Select the Azure Automation\nAccount name.",
      "leadings": [
        "",
        "    "
      ],
      "nodes": [
        {
          "content": "In the failover to Azure script – Select the Azure Automation",
          "pos": [
            0,
            61
          ]
        },
        {
          "content": "Account name.",
          "pos": [
            62,
            75
          ]
        }
      ]
    },
    {
      "content": "In the Azure Runbooks, select the runbook you authored.",
      "pos": [
        12272,
        12327
      ]
    },
    {
      "content": "Primary side scripts",
      "pos": [
        12384,
        12404
      ]
    },
    {
      "content": "When you are executing a failover to Azure, you can also choose to execute primary side scripts.",
      "pos": [
        12406,
        12502
      ]
    },
    {
      "content": "These scripts will run on the VMM server during failover.",
      "pos": [
        12503,
        12560
      ]
    },
    {
      "content": "Primary side scripts are only available only for pre-shutdown and post shutdown stages.",
      "pos": [
        12562,
        12649
      ]
    },
    {
      "content": "This is because we expect the primary site to be typically unavailable when a disaster strikes.",
      "pos": [
        12650,
        12745
      ]
    },
    {
      "content": "During an unplanned failover, only if you opt in for primary site operations, it will attempt to run the primary side scripts.",
      "pos": [
        12746,
        12872
      ]
    },
    {
      "content": "If they are not reachable or timeout, the failover will continue to recover the virtual machines.",
      "pos": [
        12873,
        12970
      ]
    },
    {
      "content": "Primary side scripts are un-available for VMware/Physical/Hyper-v Sites without VMM protected to Azure - while you failover to Azure.",
      "pos": [
        12971,
        13104
      ]
    },
    {
      "content": "However, when you failback from Azure to on-premises, priamry side scripts (Runbooks) can be used for all targets except VMware.",
      "pos": [
        13105,
        13233
      ]
    },
    {
      "content": "Test the recovery plan",
      "pos": [
        13238,
        13260
      ]
    },
    {
      "content": "Once you have added the runbook to the plan you can initiate a test",
      "pos": [
        13262,
        13329
      ]
    },
    {
      "content": "failover and see it in action.",
      "pos": [
        13330,
        13360
      ]
    },
    {
      "content": "It is always recommended to run a test",
      "pos": [
        13361,
        13399
      ]
    },
    {
      "content": "failover to test your application and the recovery plan to ensure that",
      "pos": [
        13400,
        13470
      ]
    },
    {
      "content": "there are no errors.",
      "pos": [
        13471,
        13491
      ]
    },
    {
      "content": "Select the recovery plan and initiate a test failover.",
      "pos": [
        13497,
        13551
      ]
    },
    {
      "pos": [
        13557,
        13655
      ],
      "content": "During the plan execution, you can see whether the runbook has\nexecuted or not via its status.",
      "leadings": [
        "",
        "    "
      ],
      "nodes": [
        {
          "content": "During the plan execution, you can see whether the runbook has",
          "pos": [
            0,
            62
          ]
        },
        {
          "content": "executed or not via its status.",
          "pos": [
            63,
            94
          ]
        }
      ]
    },
    {
      "pos": [
        13717,
        13826
      ],
      "content": "You can also see the detailed runbook execution status on\nthe Azure Automation jobs page for the runbook.",
      "leadings": [
        "",
        "    "
      ],
      "nodes": [
        {
          "content": "You can also see the detailed runbook execution status on",
          "pos": [
            0,
            57
          ]
        },
        {
          "content": "the Azure Automation jobs page for the runbook.",
          "pos": [
            58,
            105
          ]
        }
      ]
    },
    {
      "content": "After the failover completes, apart from the runbook execution result, you can see whether the execution is successful or not by visiting the Azure virtual machine page and looking at the endpoints.",
      "pos": [
        13888,
        14086
      ]
    },
    {
      "content": "Sample scripts",
      "pos": [
        14144,
        14158
      ]
    },
    {
      "content": "While we walked through automating one commonly used task of adding an endpoint to an Azure virtual machine in this tutorial, you could do a number of other powerful automation tasks using Azure automation.",
      "pos": [
        14160,
        14366
      ]
    },
    {
      "content": "Microsoft and the Azure Automation community provide sample runbooks which can help you get started creating your own solutions, and utility runbooks, which you can use as building blocks for larger automation tasks.",
      "pos": [
        14367,
        14583
      ]
    },
    {
      "content": "Start using them from the gallery and build  powerful one-click recovery plans for your applications using Azure Site Recovery.",
      "pos": [
        14584,
        14711
      ]
    },
    {
      "content": "Additional Resources",
      "pos": [
        14716,
        14736
      ]
    },
    {
      "pos": [
        14738,
        14848
      ],
      "content": "<bpt id=\"p1\">[</bpt>Azure Automation Overview<ept id=\"p1\">]</ept><bpt id=\"p2\">(http://msdn.microsoft.com/library/azure/dn643629.aspx \"</bpt>Azure Automation Overview<ept id=\"p2\">\")</ept>"
    },
    {
      "pos": [
        14850,
        15082
      ],
      "content": "<bpt id=\"p1\">[</bpt>Sample Azure Automation Scripts<ept id=\"p1\">]</ept><bpt id=\"p2\">(http://gallery.technet.microsoft.com/scriptcenter/site/search?f[0].Type=User&amp;f[0].Value=SC%20Automation%20Product%20Team&amp;f[0].Text=SC%20Automation%20Product%20Team \"</bpt>Sample Azure Automation Scripts<ept id=\"p2\">\")</ept>"
    }
  ],
  "content": "<properties \n   pageTitle=\"Add Azure automation runbooks to recovery plans\" \n   description=\"This article describes how Azure Site Recovery now enables you to extend recovery plans using Azure Automation to complete complex tasks during recovery to Azure\" \n   services=\"site-recovery\" \n   documentationCenter=\"\" \n   authors=\"ruturaj\" \n   manager=\"mkjain\" \n   editor=\"\"/>\n\n<tags\n   ms.service=\"site-recovery\"\n   ms.devlang=\"powershell\"\n   ms.tgt_pltfrm=\"na\"\n   ms.topic=\"article\"\n   ms.workload=\"required\" \n   ms.date=\"08/05/2015\"\n   ms.author=\"ruturajd@microsoft.com\"/>\n\n  \n   \n\n# Add Azure automation runbooks to recovery plans\n\n\nThis tutorial describes how Azure Site Recovery integrates with Azure\nAutomation to provide extensibility to recovery plans. Recovery plans\ncan orchestrate recovery of your virtual machines protected using Azure Site Recovery for both replication to secondary cloud and replication to Azure scenarios. They also help in making the recovery **consistently accurate**, **repeatable**, and **automated**. If you are failing over your virtual machines to Azure, integration with Azure Automation extends the\nrecovery plans and gives you capability to execute runbooks, thus allowing powerful automation tasks.\n\nIf you have not heard about Azure Automation yet, sign up\n[here](http://azure.microsoft.com/services/automation/) and\ndownload their sample scripts\n[here](http://azure.microsoft.com/documentation/scripts/). Read\nmore about [Azure Site\nRecovery](http://azure.microsoft.com/services/site-recovery/) and\nhow to orchestrate recovery to Azure using recovery plans\n[here](http://azure.microsoft.com/blog/?p=166264).\n\nIn this tutorial, we will look at how you can integrate Azure Automation\nrunbooks into recovery plans. We will automate simple tasks that earlier\nrequired manual intervention and see how to convert a multi-step\nrecovery into a single-click recovery action. We will also look at how you\ncan troubleshoot a simple script if it goes wrong.\n\n## Protect the application to Azure\n\nLet us begin with a simple application consisting of two virtual machines. Here, we have a HRweb application of Fabrikam. Fabrikam-HRweb-frontend and Fabrikam-Hrweb-backend are the two virtual machines protected to Azure using Azure Site Recovery. To protect the virtual machines using Azure Site Recovery, follow the steps below. \n\n1.  Enable protection for your virtual machines.\n\n2.  Ensure that the virtual machines have completed initial replication\n    and are replicating. \n\n3.  Wait till the initial replication completes and the Replication status says Protected.\n\n![](media/site-recovery-runbook-automation/01.png)\n---------------------\n\nIn this tutorial, we will create a recovery plan for the Fabrikam HRweb application to failover the application to Azure. Then we will integrate it with a runbook that will create an endpoint on the failed over Azure virtual machine to serve web pages at port 80.\n\nFirst, let's create a recovery plan for our application.\n\n## Create the recovery plan\n\nTo recover the application to Azure, you need to create a recovery plan.\nUsing a recovery plan you can specify the order of recovery of the\nvirtual machines. The virtual machine placed in group 1 will recover and\nstart first, and then the virtual machine in group 2 will follow.\n\nCreate a Recovery Plan that looks like below.\n\n![](media/site-recovery-runbook-automation/12.png)\n\nTo read more about recovery plans, read documentation [here](https://msdn.microsoft.com/library/azure/dn788799.aspx \"here\"). \n\nNext, let's create the necessary artifacts in Azure Automation.\n\n## Create the automation account and its assets\n\nYou need an Azure Automation account to create runbooks. If you do not\nalready have an account, navigate to Azure Automation tab denoted by\n![](media/site-recovery-runbook-automation/02.png)and create a new account.\n\n1.  Give the account a name to identify with.\n\n2.  Specify a geographical region where you want to place the account.\n\nIt is recommended to place the account in the same region as the ASR vault.\n\n![](media/site-recovery-runbook-automation/03.png)\n\nNext, create the following assets in the Account.\n\n### Add a subscription name as asset\n\n1.  Add a new setting ![](media/site-recovery-runbook-automation/04.png) in the Azure Automation Assets and select to ![](media/site-recovery-runbook-automation/05.png)\n\n2.  Select the variable type as **String**\n\n3.  Specify variable name as **AzureSubscriptionName**\n\n    ![](media/site-recovery-runbook-automation/06.png)\n\n4.  Specify your actual Azure Subscription name as the variable value.\n\n    ![](media/site-recovery-runbook-automation/07_1.png)\n\nYou can identify the name of your subscription from the settings page of\nyour account on the Azure portal. \n\n### Add an Azure login credential as asset\n\nAzure Automation uses Azure PowerShell to connect to the\nsubscription and operates on the artifacts there. For this, you need to\nauthenticate using your Microsoft account or a work or school account.\nYou can store the account credentials in an asset to be used securely by\nthe runbook.\n\n1.  Add a new setting ![](media/site-recovery-runbook-automation/04.png) in the Azure Automation Assets and select ![](media/site-recovery-runbook-automation/09.png)\n\n2.  Select the Credential type as **Windows PowerShell Credential**\n\n3.  Specify the name as **AzureCredential**\n\n    ![](media/site-recovery-runbook-automation/10.png)\n\n4.  Specify the username and password to sign-in with.\n\nNow both these settings are available in your assets.\n\n![](media/site-recovery-runbook-automation/11.png)\n\nMore information about how to connect to your subscription via\npowershell is given\n[here](../install-configure-powershell.md).\n\nNext, you will create a runbook in Azure Automation that can add an\nendpoint for the front-end virtual machine after failover.\n\n## Azure automation context\n\nASR passes a context variable to the runbook to help you write\ndeterministic scripts. One could argue that the names of the Cloud Service and the Virtual Machine are predictable, but happens that it is not always the case owing to certain scenarios such as the one where the name of the virtual machine name might have changed due to unsupported characters in Azure. Hence this information is passed to the ASR recovery plan as part of the *context*.\n\nBelow is an example of how the context variable looks. \n\n        {\"RecoveryPlanName\":\"hrweb-recovery\",\n\n        \"FailoverType\":\"Test\",\n\n        \"FailoverDirection\":\"PrimaryToSecondary\",\n\n        \"GroupId\":\"1\",\n\n        \"VmMap\":{\"7a1069c6-c1d6-49c5-8c5d-33bfce8dd183\":\n\n                {\"CloudServiceName\":\"pod02hrweb-Chicago-test\",\n\n                \"RoleName\":\"Fabrikam-Hrweb-frontend-test\"}\n\n                }\n\n        }\n\n\nThe table below contains name and description for each variable in the context.\n\n**Variable name** | **Description**\n---|---\nRecoveryPlanName | Name of plan being run. Helps you take action based on name using the same script\nFailoverType | Specifies whether the failover is test, planned, or unplanned. \nFailoverDirection | Specify whether recovery is to primary or secondary\nGroupID | Identify the group number within the recovery plan when the plan is running\nVmMap | Array of all the virtual machines in the group\nVMMap key | Unique key (GUID) for each VM. It's the same as the VMM ID of the virtual machine where applicable. \nRoleName | Name of the Azure VM that's being recovered\nCloudServiceName | Azure Cloud Service name under which the virtual machine is created.\n\n\nTo identify the VmMap Key in the context you could also go to the VM properties page in ASR and look at the VM GUID property.\n\n![](media/site-recovery-runbook-automation/13.png)\n\n## Author an Automation runbook\n\nNow create the runbook to open port 80 on the front-end virtual machine.\n\n1.  Create a new runbook in the Azure Automation account with the name\n    **OpenPort80**\n\n![](media/site-recovery-runbook-automation/14.png)\n\n2.  Navigate to the Author view of the runbook and enter the draft mode.\n\n3.  First specify the variable to use as the recovery plan context\n\n```\n    param (\n        [Object]$RecoveryPlanContext\n    )\n\n```\n  \n\n4.  Next connect to the subscription using the credential and\n    subscription name\n\n```\n    $Cred = Get-AutomationPSCredential -Name 'AzureCredential'\n    \n    # Connect to Azure\n    $AzureAccount = Add-AzureAccount -Credential $Cred\n    $AzureSubscriptionName = Get-AutomationVariable –Name ‘AzureSubscriptionName’\n    Select-AzureSubscription -SubscriptionName $AzureSubscriptionName\n```\n\n> Note that you use the Azure assets – **AzureCredential** and **AzureSubscriptionName** here.\n\n5.  Now specify the endpoint details and the GUID of the virtual machine for which you want to expose the endpoint, in this case the front-end virtual machine.\n\n```\n    # Specify the parameters to be used by the script\n    $AEProtocol = \"TCP\"\n    $AELocalPort = 80\n    $AEPublicPort = 80\n    $AEName = \"Port 80 for HTTP\"\n    $VMGUID = \"7a1069c6-c1d6-49c5-8c5d-33bfce8dd183\"\n```\n\nThis specifies the Azure endpoint protocol, local port on the VM and its mapped public port. These variables are parameters required by the Azure commands that add endpoints to VMs. The VMGUID holds the GUID of the virtual machine you need to operate on. \n\n6.  The script will now extract the context for the given VM GUID and\n    create an endpoint on the virtual machine referenced by it.\n\n```\n    #Read the VM GUID from the context\n    $VM = $RecoveryPlanContext.VmMap.$VMGUID\n\n    if ($VM -ne $null)\n    {\n        # Invoke pipeline commands within an InlineScript\n\n        $EndpointStatus = InlineScript {\n            # Invoke the necessary pipeline commands to add a Azure Endpoint to a specified Virtual Machine\n            # This set of commands includes: Get-AzureVM | Add-AzureEndpoint | Update-AzureVM (including necessary parameters)\n\n            $Status = Get-AzureVM -ServiceName $Using:VM.CloudServiceName -Name $Using:VM.RoleName | `\n                Add-AzureEndpoint -Name $Using:AEName -Protocol $Using:AEProtocol -PublicPort $Using:AEPublicPort -LocalPort $Using:AELocalPort | `\n                Update-AzureVM\n            Write-Output $Status\n        }\n    }\n```\n\n7. Once this is complete, hit Publish ![](media/site-recovery-runbook-automation/20.png) to allow your script to be available for execution. \n\nThe complete script is given below for your reference\n\n```\n  workflow OpenPort80\n  {\n    param (\n        [Object]$RecoveryPlanContext\n    )\n\n    $Cred = Get-AutomationPSCredential -Name 'AzureCredential'\n    \n    # Connect to Azure\n    $AzureAccount = Add-AzureAccount -Credential $Cred\n    $AzureSubscriptionName = Get-AutomationVariable –Name ‘AzureSubscriptionName’\n    Select-AzureSubscription -SubscriptionName $AzureSubscriptionName\n\n    # Specify the parameters to be used by the script\n    $AEProtocol = \"TCP\"\n    $AELocalPort = 80\n    $AEPublicPort = 80\n    $AEName = \"Port 80 for HTTP\"\n    $VMGUID = \"7a1069c6-c1d6-49c5-8c5d-33bfce8dd183\"\n    \n    #Read the VM GUID from the context\n    $VM = $RecoveryPlanContext.VmMap.$VMGUID\n\n    if ($VM -ne $null)\n    {\n        # Invoke pipeline commands within an InlineScript\n\n        $EndpointStatus = InlineScript {\n            # Invoke the necessary pipeline commands to add an Azure Endpoint to a specified Virtual Machine\n            # This set of commands includes: Get-AzureVM | Add-AzureEndpoint | Update-AzureVM (including necessary parameters)\n\n            $Status = Get-AzureVM -ServiceName $Using:VM.CloudServiceName -Name $Using:VM.RoleName | `\n                Add-AzureEndpoint -Name $Using:AEName -Protocol $Using:AEProtocol -PublicPort $Using:AEPublicPort -LocalPort $Using:AELocalPort | `\n                Update-AzureVM\n            Write-Output $Status\n        }\n    }\n  }\n```\n\n## Add the script to the recovery plan\n\nOnce the script is ready, you can add it to the recovery plan that you created earlier.\n\n1.  In the recovery plan you created, choose to add a script after the\n    group 2. ![](media/site-recovery-runbook-automation/15.png)\n\n2.  Specify a script name. This is just a friendly name for this script for showing within the Recovery plan.\n\n3.  In the failover to Azure script – Select the Azure Automation\n    Account name.\n\n4.  In the Azure Runbooks, select the runbook you authored.\n\n![](media/site-recovery-runbook-automation/16.png)\n\n## Primary side scripts\n\nWhen you are executing a failover to Azure, you can also choose to execute primary side scripts. These scripts will run on the VMM server during failover. \nPrimary side scripts are only available only for pre-shutdown and post shutdown stages. This is because we expect the primary site to be typically unavailable when a disaster strikes.\nDuring an unplanned failover, only if you opt in for primary site operations, it will attempt to run the primary side scripts. If they are not reachable or timeout, the failover will continue to recover the virtual machines.\nPrimary side scripts are un-available for VMware/Physical/Hyper-v Sites without VMM protected to Azure - while you failover to Azure.\nHowever, when you failback from Azure to on-premises, priamry side scripts (Runbooks) can be used for all targets except VMware.\n\n## Test the recovery plan\n\nOnce you have added the runbook to the plan you can initiate a test\nfailover and see it in action. It is always recommended to run a test\nfailover to test your application and the recovery plan to ensure that\nthere are no errors.\n\n1.  Select the recovery plan and initiate a test failover.\n\n2.  During the plan execution, you can see whether the runbook has\n    executed or not via its status.\n\n    ![](media/site-recovery-runbook-automation/17.png)\n\n3.  You can also see the detailed runbook execution status on\n    the Azure Automation jobs page for the runbook.\n\n    ![](media/site-recovery-runbook-automation/18.png)\n\n4.  After the failover completes, apart from the runbook execution result, you can see whether the execution is successful or not by visiting the Azure virtual machine page and looking at the endpoints. \n\n![](media/site-recovery-runbook-automation/19.png)\n\n## Sample scripts\n\nWhile we walked through automating one commonly used task of adding an endpoint to an Azure virtual machine in this tutorial, you could do a number of other powerful automation tasks using Azure automation. Microsoft and the Azure Automation community provide sample runbooks which can help you get started creating your own solutions, and utility runbooks, which you can use as building blocks for larger automation tasks. Start using them from the gallery and build  powerful one-click recovery plans for your applications using Azure Site Recovery.\n\n## Additional Resources\n\n[Azure Automation Overview](http://msdn.microsoft.com/library/azure/dn643629.aspx \"Azure Automation Overview\")\n\n[Sample Azure Automation Scripts](http://gallery.technet.microsoft.com/scriptcenter/site/search?f[0].Type=User&f[0].Value=SC%20Automation%20Product%20Team&f[0].Text=SC%20Automation%20Product%20Team \"Sample Azure Automation Scripts\")\n\n \n"
}