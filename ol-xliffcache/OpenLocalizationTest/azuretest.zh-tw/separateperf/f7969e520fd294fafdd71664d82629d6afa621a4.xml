{
  "nodes": [
    {
      "content": "Security considerations for Azure Resource Manager",
      "pos": [
        27,
        77
      ]
    },
    {
      "content": "Shows recommended approaches in Azure Resource Manager for securing resources with keys and secrets, role-based access control and network security groups.",
      "pos": [
        96,
        251
      ]
    },
    {
      "content": "Security considerations for Azure Resource Manager",
      "pos": [
        584,
        634
      ]
    },
    {
      "content": "When looking at aspects of security for your Azure Resource Manager templates, there are several areas to consider â€“ keys and secrets, role-based access control,",
      "pos": [
        636,
        797
      ]
    },
    {
      "content": "and network security groups.",
      "pos": [
        799,
        827
      ]
    },
    {
      "content": "This topic assumes you are familiar with Role-Based Access Control (RBAC) in Azure Resource Manager.",
      "pos": [
        829,
        929
      ]
    },
    {
      "content": "For more information, see",
      "pos": [
        930,
        955
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>Role-based access control in the Microsoft Azure portal<ept id=\"p1\">](role-based-access-control-configure.md)</ept> and",
      "pos": [
        957,
        1058
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>Managing and Auditing Access to Resources<ept id=\"p1\">](resource-group-rbac.md)</ept>",
      "pos": [
        1060,
        1127
      ]
    },
    {
      "content": "This topic is part of a larger whitepaper.",
      "pos": [
        1130,
        1172
      ]
    },
    {
      "content": "To read the full paper, download [World Class ARM Templates Considerations and Proven Practices](http://download.microsoft.com/download/8/E/1/8E1DBEFA-CECE-4DC9-A813-93520A5D7CFE/World Class ARM Templates - Considerations and Proven Practices.pdf).",
      "pos": [
        1173,
        1421
      ]
    },
    {
      "content": "Secrets and certificates",
      "pos": [
        1426,
        1450
      ]
    },
    {
      "content": "Azure Virtual Machines, Azure Resource Manager and Azure Key Vault are fully integrated to provide support for the secure handling of certificates which are",
      "pos": [
        1452,
        1608
      ]
    },
    {
      "content": "to be deployed in the VM.",
      "pos": [
        1610,
        1635
      ]
    },
    {
      "content": "Utilizing Azure Key Vault with Resource Manager to orchestrate and store VM secrets and certificates is a best practice and",
      "pos": [
        1637,
        1760
      ]
    },
    {
      "content": "provides the following advantages:",
      "pos": [
        1762,
        1796
      ]
    },
    {
      "content": "The templates only contain URI references to the secrets, which means the actual secrets are not in code, configuration or source code repositories.",
      "pos": [
        1800,
        1948
      ]
    },
    {
      "content": "This prevents",
      "pos": [
        1949,
        1962
      ]
    },
    {
      "content": "key phishing attacks on internal or external repos, such as harvest-bots in GitHub.",
      "pos": [
        1964,
        2047
      ]
    },
    {
      "content": "Secrets stored in the Key Vault are under full RBAC control of a trusted operator.",
      "pos": [
        2050,
        2132
      ]
    },
    {
      "content": "If the trusted operator leaves the company or transfers within the",
      "pos": [
        2134,
        2200
      ]
    },
    {
      "content": "company to a new group, they no longer have access to the keys they created in the Vault.",
      "pos": [
        2202,
        2291
      ]
    },
    {
      "pos": [
        2294,
        2585
      ],
      "content": "Full compartmentalization of all assets:\n    - the templates to deploy the keys \n    - the templates to deploy a VM with references to the keys \n    - the actual key materials in the Vault.  \nEach template (and action) can be under different RBAC roles for full separation of duties.",
      "leadings": [
        "",
        "  ",
        "  ",
        "  ",
        "  "
      ],
      "nodes": [
        {
          "content": "Full compartmentalization of all assets:",
          "pos": [
            0,
            40
          ]
        },
        {
          "content": "- the templates to deploy the keys",
          "pos": [
            45,
            79
          ]
        },
        {
          "content": "- the templates to deploy a VM with references to the keys",
          "pos": [
            85,
            143
          ]
        },
        {
          "content": "- the actual key materials in the Vault.",
          "pos": [
            149,
            189
          ]
        },
        {
          "content": "Each template (and action) can be under different RBAC roles for full separation of duties.",
          "pos": [
            192,
            283
          ]
        }
      ]
    },
    {
      "content": "The loading of secrets into a VM at deployment time occurs via direct channel between the Azure Fabric and the Key Vault within the confines of the Microsoft",
      "pos": [
        2588,
        2745
      ]
    },
    {
      "content": "datacenter.",
      "pos": [
        2747,
        2758
      ]
    },
    {
      "content": "Once the keys are in the Key Vault, they never see 'daylight' over an untrusted channel outside of the datacenter.",
      "pos": [
        2760,
        2874
      ]
    },
    {
      "content": "Key Vaults are always regional, so the secrets always have locality (and sovereignty) with the VMs.",
      "pos": [
        2879,
        2978
      ]
    },
    {
      "content": "There are no global Key Vaults.",
      "pos": [
        2979,
        3010
      ]
    },
    {
      "content": "Separation of keys from deployments",
      "pos": [
        3016,
        3051
      ]
    },
    {
      "content": "A best practice is to maintain separate templates for:",
      "pos": [
        3053,
        3107
      ]
    },
    {
      "content": "Creation of vaults (which will contain the key material)",
      "pos": [
        3113,
        3169
      ]
    },
    {
      "content": "Deployment of the VMs (with URI references to the keys contained in the vaults)",
      "pos": [
        3174,
        3253
      ]
    },
    {
      "content": "A typical enterprise scenario is to have a small group of Trusted Operators who have access to critical secrets within the deployed workloads, with a broader group",
      "pos": [
        3255,
        3418
      ]
    },
    {
      "content": "of dev/ops personnel who can create or update VM deployments.",
      "pos": [
        3420,
        3481
      ]
    },
    {
      "content": "Below is an example ARM template which creates and configures a new vault in the context",
      "pos": [
        3483,
        3571
      ]
    },
    {
      "content": "of the currently authenticated user's identity in Azure Active Directory.",
      "pos": [
        3573,
        3646
      ]
    },
    {
      "content": "This user would have the default permission to create, delete, list, update, backup,",
      "pos": [
        3648,
        3732
      ]
    },
    {
      "content": "restore, and get the public half of keys in this new key vault.",
      "pos": [
        3734,
        3797
      ]
    },
    {
      "content": "While most of the fields in this template should be self-explanatory, the <bpt id=\"p1\">**</bpt>enableVaultForDeployment<ept id=\"p1\">**</ept> setting deserves more background: vaults do not have any default",
      "pos": [
        3799,
        3966
      ]
    },
    {
      "content": "standing access by any other Azure infrastructure component.",
      "pos": [
        3968,
        4028
      ]
    },
    {
      "content": "By setting this value, it allows the Azure Compute infrastructure components read-only access to this",
      "pos": [
        4029,
        4130
      ]
    },
    {
      "content": "specific named vault.",
      "pos": [
        4132,
        4153
      ]
    },
    {
      "content": "Therefore, a further best practice is to not comingle corporate sensitive data in the same vault as virtual machine secrets.",
      "pos": [
        4154,
        4278
      ]
    },
    {
      "content": "Once the vault is created, the next step is to reference that vault in the deployment template of a new VM.",
      "pos": [
        6788,
        6895
      ]
    },
    {
      "content": "As mentioned above, a best practice is to have a",
      "pos": [
        6897,
        6945
      ]
    },
    {
      "content": "different dev/ops group manage VM deployments, with that group having no direct access to the keys as stored in the vault.",
      "pos": [
        6947,
        7069
      ]
    },
    {
      "content": "The below template fragment would be composed into higher order deployment constructs, each safely and securely referencing highly-sensitive secrets which are not",
      "pos": [
        7071,
        7233
      ]
    },
    {
      "content": "under the direct control of the operator.",
      "pos": [
        7235,
        7276
      ]
    },
    {
      "content": "Service principals for cross-subscription interactions",
      "pos": [
        8109,
        8163
      ]
    },
    {
      "content": "Service identities are represented by service principals in Active Directory.",
      "pos": [
        8165,
        8242
      ]
    },
    {
      "content": "Service principals will be at the center of enabling key scenarios for Enterprise IT organizations, System Integrators (SI), and Cloud Service Vendors (CSV).",
      "pos": [
        8243,
        8400
      ]
    },
    {
      "content": "Specifically, there will be use cases where one of these organizations will need to interact with the subscription of one of their customers.",
      "pos": [
        8401,
        8542
      ]
    },
    {
      "content": "Your organization could provide an offering that will monitor a solution deployed in your customers environment and subscription.",
      "pos": [
        8546,
        8675
      ]
    },
    {
      "content": "In this case, you will need to",
      "pos": [
        8676,
        8706
      ]
    },
    {
      "content": "get access to logs and other data within a customers account so that you can utilize it in your monitoring solution.",
      "pos": [
        8708,
        8824
      ]
    },
    {
      "content": "If you're a corporate IT organization, a systems integrator, you may provide an offering to a customer where you will deploy and manage a capability for them,",
      "pos": [
        8825,
        8983
      ]
    },
    {
      "content": "such as a data analytics platform, where the offering resides in the customers own subscription.",
      "pos": [
        8985,
        9081
      ]
    },
    {
      "content": "In these use cases, your organization would require an identity that could be given access to perform these actions within the context of a customer subscription.",
      "pos": [
        9083,
        9245
      ]
    },
    {
      "content": "These scenarios bring with them a certain set of considerations for your customer:",
      "pos": [
        9249,
        9331
      ]
    },
    {
      "content": "For security reasons, access may need to be scoped to certain types of actions, e.g. read only access.",
      "pos": [
        9337,
        9439
      ]
    },
    {
      "content": "As deployed resources are provided at a cost, there may be similar constraints on access required for financial reasons.",
      "pos": [
        9444,
        9564
      ]
    },
    {
      "content": "For security reasons, access may need to be scoped only to a specific resource (storage accounts) or resources (resource group containing an environment or solution)",
      "pos": [
        9569,
        9734
      ]
    },
    {
      "content": "As a relationship with a vendor may change, the customer will want to have the ability to enable/disable access to SI or CSV",
      "pos": [
        9739,
        9863
      ]
    },
    {
      "content": "As actions against this account having billing implications, the customer desires support for auditability and accountability for billing.",
      "pos": [
        9868,
        10006
      ]
    },
    {
      "content": "From a compliance perspective, the customer will want to be able to audit your behavior within their environment",
      "pos": [
        10011,
        10123
      ]
    },
    {
      "content": "A combination of a service principal and RBAC can be used to address these requirements.",
      "pos": [
        10125,
        10213
      ]
    },
    {
      "content": "Network security groups",
      "pos": [
        10218,
        10241
      ]
    },
    {
      "content": "Many scenarios will have requirements that specify how traffic to one or more VM instances in your virtual network is controlled.",
      "pos": [
        10243,
        10372
      ]
    },
    {
      "content": "You can use a Network Security",
      "pos": [
        10373,
        10403
      ]
    },
    {
      "content": "Group (NSG) to do this as part of an ARM template deployment.",
      "pos": [
        10405,
        10466
      ]
    },
    {
      "content": "A network security group is a top-level object that is associated with your subscription.",
      "pos": [
        10468,
        10557
      ]
    },
    {
      "content": "An NSG contains access control rules that allow or deny traffic to",
      "pos": [
        10558,
        10624
      ]
    },
    {
      "content": "VM instances.",
      "pos": [
        10626,
        10639
      ]
    },
    {
      "content": "The rules of an NSG can be changed at any time, and changes are applied to all associated instances.",
      "pos": [
        10640,
        10740
      ]
    },
    {
      "content": "To use an NSG, you must have a virtual network",
      "pos": [
        10741,
        10787
      ]
    },
    {
      "content": "that is associated with a region (location).",
      "pos": [
        10789,
        10833
      ]
    },
    {
      "content": "NSGs are not compatible with virtual networks that are associated with an affinity group.",
      "pos": [
        10834,
        10923
      ]
    },
    {
      "content": "If you donâ€™t have a",
      "pos": [
        10924,
        10943
      ]
    },
    {
      "content": "regional virtual network and you want to control traffic to your endpoints, please see <bpt id=\"p1\">[</bpt>About Network Access Control Lists (ACLs)<ept id=\"p1\">](../virtual-network/virtual-networks-acl.md)</ept>.",
      "pos": [
        10945,
        11120
      ]
    },
    {
      "content": "You can associate an NSG with a VM, or to a subnet within a virtual network.",
      "pos": [
        11122,
        11198
      ]
    },
    {
      "content": "When associated with a VM, the NSG applies to all the traffic that is sent and",
      "pos": [
        11199,
        11277
      ]
    },
    {
      "content": "received by the VM instance.",
      "pos": [
        11279,
        11307
      ]
    },
    {
      "content": "When applied to a subnet within your virtual network, it applies to all the traffic that is sent and received by all the VM instances",
      "pos": [
        11308,
        11441
      ]
    },
    {
      "content": "in the subnet.",
      "pos": [
        11443,
        11457
      ]
    },
    {
      "content": "A VM or subnet can be associated with only 1 NSG, but each NSG can contain up to 200 rules.",
      "pos": [
        11458,
        11549
      ]
    },
    {
      "content": "You can have 100 NSGs per subscription.",
      "pos": [
        11550,
        11589
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph>  Endpoint-based ACLs and network security groups are not supported on the same VM instance.",
      "pos": [
        11592,
        11696
      ]
    },
    {
      "content": "If you want to use an NSG and have an endpoint ACL already in place, first remove the endpoint ACL.",
      "pos": [
        11697,
        11796
      ]
    },
    {
      "content": "For information about how to do this, see <bpt id=\"p1\">[</bpt>Managing Access Control Lists (ACLs) for Endpoints by using PowerShell<ept id=\"p1\">](../virtual-network/virtual-networks-acl-powershell.md)</ept>.",
      "pos": [
        11797,
        11967
      ]
    },
    {
      "content": "How network security groups work",
      "pos": [
        11973,
        12005
      ]
    },
    {
      "content": "Network security groups are different than endpoint-based ACLs.",
      "pos": [
        12007,
        12070
      ]
    },
    {
      "content": "Endpoint ACLs work only on the public port that is exposed through the Input endpoint.",
      "pos": [
        12071,
        12157
      ]
    },
    {
      "content": "An",
      "pos": [
        12158,
        12160
      ]
    },
    {
      "content": "NSG works on one or more VM instances and controls all the traffic that is inbound and outbound on the VM.",
      "pos": [
        12162,
        12268
      ]
    },
    {
      "content": "A network security group has a <bpt id=\"p1\">*</bpt>Name<ept id=\"p1\">*</ept>, is associated with a <bpt id=\"p2\">*</bpt>Region<ept id=\"p2\">*</ept> (one of the supported Azure locations), and has a descriptive label.",
      "pos": [
        12270,
        12407
      ]
    },
    {
      "content": "It contains two types of",
      "pos": [
        12408,
        12432
      ]
    },
    {
      "content": "rules, Inbound and Outbound.",
      "pos": [
        12434,
        12462
      ]
    },
    {
      "content": "The Inbound rules are applied on the incoming packets to a VM and the Outbound rules are applied to the outgoing packets from the VM.",
      "pos": [
        12463,
        12596
      ]
    },
    {
      "content": "The rules are applied at the server machine where the VM is located.",
      "pos": [
        12598,
        12666
      ]
    },
    {
      "content": "An incoming or outgoing packet must match an Allow rule to be permitted; otherwise, itâ€™s dropped.",
      "pos": [
        12667,
        12764
      ]
    },
    {
      "content": "Rules are processed in the order of priority.",
      "pos": [
        12766,
        12811
      ]
    },
    {
      "content": "For example, a rule with a lower priority number such as 100 is processed before rules with a higher priority numbers",
      "pos": [
        12812,
        12929
      ]
    },
    {
      "content": "such as 200.",
      "pos": [
        12931,
        12943
      ]
    },
    {
      "content": "Once a match is found, no more rules are processed.",
      "pos": [
        12944,
        12995
      ]
    },
    {
      "content": "A rule specifies the following:",
      "pos": [
        12997,
        13028
      ]
    },
    {
      "content": "Name: A unique identifier for the rule",
      "pos": [
        13034,
        13072
      ]
    },
    {
      "content": "Type: Inbound/Outbound",
      "pos": [
        13077,
        13099
      ]
    },
    {
      "content": "Priority: An integer between 100 and 4096 (rules processed from low to high)",
      "pos": [
        13104,
        13180
      ]
    },
    {
      "content": "Source IP Address: CIDR of source IP range",
      "pos": [
        13185,
        13227
      ]
    },
    {
      "content": "Source Port Range: An integer or range between 0 and 65536",
      "pos": [
        13232,
        13290
      ]
    },
    {
      "content": "Destination IP Range: CIDR of the destination IP Range",
      "pos": [
        13295,
        13349
      ]
    },
    {
      "content": "Destination Port Range: An integer or range between 0 and 65536",
      "pos": [
        13354,
        13417
      ]
    },
    {
      "content": "Protocol: TCP, UDP or â€˜\\*â€™",
      "pos": [
        13422,
        13448
      ]
    },
    {
      "content": "Access: Allow/Deny",
      "pos": [
        13453,
        13471
      ]
    },
    {
      "content": "Default rules",
      "pos": [
        13477,
        13490
      ]
    },
    {
      "content": "An NSG contains default rules.",
      "pos": [
        13492,
        13522
      ]
    },
    {
      "content": "The default rules can't be deleted, but because they are assigned the lowest priority, they can be overridden by the rules that",
      "pos": [
        13523,
        13650
      ]
    },
    {
      "content": "you create.",
      "pos": [
        13652,
        13663
      ]
    },
    {
      "content": "The default rules describe the default settings recommended by the platform.",
      "pos": [
        13664,
        13740
      ]
    },
    {
      "content": "As illustrated by the default rules below, traffic originating and ending",
      "pos": [
        13741,
        13814
      ]
    },
    {
      "content": "in a virtual network is allowed both in Inbound and Outbound directions.",
      "pos": [
        13816,
        13888
      ]
    },
    {
      "content": "While connectivity to the Internet is allowed for outbound direction, it is by default blocked for inbound direction.",
      "pos": [
        13890,
        14007
      ]
    },
    {
      "content": "A default rule allows the Azure load balancer",
      "pos": [
        14008,
        14053
      ]
    },
    {
      "content": "to probe the health of a VM.",
      "pos": [
        14055,
        14083
      ]
    },
    {
      "content": "You can override this rule if the VM or set of VMs under the NSG does not participate in the load balanced set.",
      "pos": [
        14084,
        14195
      ]
    },
    {
      "content": "The default rules are shown in the tables below.",
      "pos": [
        14197,
        14245
      ]
    },
    {
      "content": "Inbound default rules",
      "pos": [
        14249,
        14270
      ]
    },
    {
      "content": "Name",
      "pos": [
        14274,
        14278
      ]
    },
    {
      "content": "Priority",
      "pos": [
        14282,
        14290
      ]
    },
    {
      "content": "Source IP",
      "pos": [
        14294,
        14303
      ]
    },
    {
      "content": "Source Port",
      "pos": [
        14306,
        14317
      ]
    },
    {
      "content": "Destination IP",
      "pos": [
        14322,
        14336
      ]
    },
    {
      "content": "Destination Port",
      "pos": [
        14342,
        14358
      ]
    },
    {
      "content": "Protocol",
      "pos": [
        14362,
        14370
      ]
    },
    {
      "content": "Access",
      "pos": [
        14374,
        14380
      ]
    },
    {
      "content": "ALLOW VNET INBOUND",
      "pos": [
        14427,
        14445
      ]
    },
    {
      "content": "65000",
      "pos": [
        14449,
        14454
      ]
    },
    {
      "content": "VIRTUAL_NETWORK",
      "pos": [
        14457,
        14472
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14475,
        14477
      ]
    },
    {
      "content": "VIRTUAL_NETWORK",
      "pos": [
        14483,
        14498
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14501,
        14503
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14507,
        14509
      ]
    },
    {
      "content": "ALLOW",
      "pos": [
        14513,
        14518
      ]
    },
    {
      "content": "ALLOW AZURE LOAD BALANCER INBOUND",
      "pos": [
        14519,
        14552
      ]
    },
    {
      "content": "65001",
      "pos": [
        14557,
        14562
      ]
    },
    {
      "content": "AZURE_LOADBALANCER",
      "pos": [
        14565,
        14583
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14589,
        14591
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14597,
        14599
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14605,
        14607
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14613,
        14615
      ]
    },
    {
      "content": "ALLOW",
      "pos": [
        14621,
        14626
      ]
    },
    {
      "content": "DENY ALL INBOUND",
      "pos": [
        14627,
        14643
      ]
    },
    {
      "content": "65500",
      "pos": [
        14649,
        14654
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14657,
        14659
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14665,
        14667
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14673,
        14675
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14681,
        14683
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14689,
        14691
      ]
    },
    {
      "content": "DENY",
      "pos": [
        14697,
        14701
      ]
    },
    {
      "content": "Outbound default rules",
      "pos": [
        14705,
        14727
      ]
    },
    {
      "content": "Name",
      "pos": [
        14731,
        14735
      ]
    },
    {
      "content": "Priority",
      "pos": [
        14739,
        14747
      ]
    },
    {
      "content": "Source IP",
      "pos": [
        14751,
        14760
      ]
    },
    {
      "content": "Source Port",
      "pos": [
        14763,
        14774
      ]
    },
    {
      "content": "Destination IP",
      "pos": [
        14779,
        14793
      ]
    },
    {
      "content": "Destination Port",
      "pos": [
        14799,
        14815
      ]
    },
    {
      "content": "Protocol",
      "pos": [
        14819,
        14827
      ]
    },
    {
      "content": "Access",
      "pos": [
        14831,
        14837
      ]
    },
    {
      "content": "ALLOW VNET OUTBOUND",
      "pos": [
        14884,
        14903
      ]
    },
    {
      "content": "65000",
      "pos": [
        14906,
        14911
      ]
    },
    {
      "content": "VIRTUAL_NETWORK",
      "pos": [
        14914,
        14929
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14934,
        14936
      ]
    },
    {
      "content": "VIRTUAL_NETWORK",
      "pos": [
        14942,
        14957
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14962,
        14964
      ]
    },
    {
      "content": "\\*",
      "pos": [
        14970,
        14972
      ]
    },
    {
      "content": "ALLOW",
      "pos": [
        14978,
        14983
      ]
    },
    {
      "content": "ALLOW INTERNET OUTBOUND",
      "pos": [
        14984,
        15007
      ]
    },
    {
      "content": "65001",
      "pos": [
        15010,
        15015
      ]
    },
    {
      "content": "\\*",
      "pos": [
        15018,
        15020
      ]
    },
    {
      "content": "\\*",
      "pos": [
        15026,
        15028
      ]
    },
    {
      "content": "INTERNET",
      "pos": [
        15034,
        15042
      ]
    },
    {
      "content": "\\*",
      "pos": [
        15046,
        15048
      ]
    },
    {
      "content": "\\*",
      "pos": [
        15054,
        15056
      ]
    },
    {
      "content": "ALLOW",
      "pos": [
        15062,
        15067
      ]
    },
    {
      "content": "DENY ALL OUTBOUND",
      "pos": [
        15068,
        15085
      ]
    },
    {
      "content": "65500",
      "pos": [
        15090,
        15095
      ]
    },
    {
      "content": "\\*",
      "pos": [
        15098,
        15100
      ]
    },
    {
      "content": "\\*",
      "pos": [
        15106,
        15108
      ]
    },
    {
      "content": "\\*",
      "pos": [
        15114,
        15116
      ]
    },
    {
      "content": "\\*",
      "pos": [
        15122,
        15124
      ]
    },
    {
      "content": "\\*",
      "pos": [
        15130,
        15132
      ]
    },
    {
      "content": "DENY",
      "pos": [
        15138,
        15142
      ]
    },
    {
      "content": "Special infrastructure rules",
      "pos": [
        15148,
        15176
      ]
    },
    {
      "content": "NSG rules are explicit.",
      "pos": [
        15178,
        15201
      ]
    },
    {
      "content": "No traffic is allowed or denied beyond what is specified in the NSG rules.",
      "pos": [
        15202,
        15276
      ]
    },
    {
      "content": "However, two types of traffic are always allowed regardless of the",
      "pos": [
        15277,
        15343
      ]
    },
    {
      "content": "Network Security group specification.",
      "pos": [
        15345,
        15382
      ]
    },
    {
      "content": "These provisions are made to support the infrastructure:",
      "pos": [
        15383,
        15439
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Virtual IP of the Host Node<ept id=\"p1\">**</ept>: Basic infrastructure services such as DHCP, DNS, and Health monitoring are provided through the virtualized host IP address",
      "pos": [
        15443,
        15599
      ]
    },
    {
      "content": "168.63.129.16.",
      "pos": [
        15601,
        15615
      ]
    },
    {
      "content": "This public IP address belongs to Microsoft and will be the only virtualized IP address used in all regions for this purpose.",
      "pos": [
        15616,
        15741
      ]
    },
    {
      "content": "This IP address maps to",
      "pos": [
        15742,
        15765
      ]
    },
    {
      "content": "the physical IP address of the server machine (host node) hosting the VM.",
      "pos": [
        15767,
        15840
      ]
    },
    {
      "content": "The host node acts as the DHCP relay, the DNS recursive resolver, and the probe source for the",
      "pos": [
        15841,
        15935
      ]
    },
    {
      "content": "load balancer health probe and the machine health probe.",
      "pos": [
        15937,
        15993
      ]
    },
    {
      "content": "Communication to this IP address should not be considered as an attack.",
      "pos": [
        15994,
        16065
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Licensing (Key Management Service)<ept id=\"p1\">**</ept>: Windows images running in the VMs should be licensed.",
      "pos": [
        16068,
        16161
      ]
    },
    {
      "content": "To do this, a licensing request is sent to the Key Management Service",
      "pos": [
        16162,
        16231
      ]
    },
    {
      "content": "host servers that handle such queries.",
      "pos": [
        16233,
        16271
      ]
    },
    {
      "content": "This will always be on outbound port 1688.",
      "pos": [
        16272,
        16314
      ]
    },
    {
      "content": "Default tags",
      "pos": [
        16320,
        16332
      ]
    },
    {
      "content": "Default tags are system-provided identifiers to address a category of IP addresses.",
      "pos": [
        16334,
        16417
      ]
    },
    {
      "content": "Default tags can be specified in user-defined rules.",
      "pos": [
        16418,
        16470
      ]
    },
    {
      "content": "Default tags for NSGs",
      "pos": [
        16474,
        16495
      ]
    },
    {
      "content": "Tag",
      "pos": [
        16499,
        16502
      ]
    },
    {
      "content": "Description",
      "pos": [
        16507,
        16518
      ]
    },
    {
      "content": "VIRTUAL_NETWORK",
      "pos": [
        16529,
        16544
      ]
    },
    {
      "content": "Denotes all of your network address space.",
      "pos": [
        16549,
        16591
      ]
    },
    {
      "content": "It includes the virtual network address space (IP CIDR in Azure) as well as all connected on-premises address space (Local Networks).",
      "pos": [
        16592,
        16725
      ]
    },
    {
      "content": "This also includes virtual network-to-virtual network address spaces.",
      "pos": [
        16726,
        16795
      ]
    },
    {
      "content": "AZURE_LOADBALANCER",
      "pos": [
        16796,
        16814
      ]
    },
    {
      "content": "Denotes the Azure Infrastructure load balancer and will translate to an Azure datacenter IP where Azureâ€™s health probes will originate.",
      "pos": [
        16817,
        16952
      ]
    },
    {
      "content": "This is needed only if the VM or set of VMs associated with the NSG is participating in a load balanced set.",
      "pos": [
        16953,
        17061
      ]
    },
    {
      "content": "INTERNET",
      "pos": [
        17062,
        17070
      ]
    },
    {
      "content": "Denotes the IP address space that is outside the virtual network and can be reached by public Internet.",
      "pos": [
        17073,
        17176
      ]
    },
    {
      "content": "This range includes Azure-owned public IP space as well.",
      "pos": [
        17177,
        17233
      ]
    },
    {
      "content": "Ports and port ranges",
      "pos": [
        17239,
        17260
      ]
    },
    {
      "content": "NSG rules can be specified on a single source or destination port, or on a port range.",
      "pos": [
        17262,
        17348
      ]
    },
    {
      "content": "This approach is particularly useful when you want to open a wide range of ports",
      "pos": [
        17349,
        17429
      ]
    },
    {
      "content": "for an application, such as FTP.",
      "pos": [
        17431,
        17463
      ]
    },
    {
      "content": "The range must be sequential and can't be mixed with individual port specifications.",
      "pos": [
        17464,
        17548
      ]
    },
    {
      "content": "To specify a range of ports, use the hyphen (â€“) character.",
      "pos": [
        17549,
        17607
      ]
    },
    {
      "content": "For example, <bpt id=\"p1\">**</bpt>100-500<ept id=\"p1\">**</ept>.",
      "pos": [
        17608,
        17633
      ]
    },
    {
      "content": "ICMP traffic",
      "pos": [
        17639,
        17651
      ]
    },
    {
      "content": "With the current NSG rules, you can specify TCP or UDP as protocols but not ICMP.",
      "pos": [
        17653,
        17734
      ]
    },
    {
      "content": "However, ICMP traffic is allowed within a virtual network by default through",
      "pos": [
        17735,
        17811
      ]
    },
    {
      "content": "the Inbound rules that support traffic from and to any port and protocol (\\*) within the virtual network.",
      "pos": [
        17813,
        17918
      ]
    },
    {
      "content": "Associating an NSG with a VM",
      "pos": [
        17924,
        17952
      ]
    },
    {
      "content": "When an NSG is directly associated with a VM, the network access rules in the NSG are directly applied to all traffic that is destined to the VM.",
      "pos": [
        17954,
        18099
      ]
    },
    {
      "content": "Whenever the NSG is",
      "pos": [
        18100,
        18119
      ]
    },
    {
      "content": "updated for rule changes, the traffic handling reflects the updates within minutes.",
      "pos": [
        18121,
        18204
      ]
    },
    {
      "content": "When the NSG is disassociated from the VM, the state reverts to its",
      "pos": [
        18205,
        18272
      ]
    },
    {
      "content": "pre-NSG conditionâ€”that is, to the system defaults before the NSG was introduced.",
      "pos": [
        18274,
        18354
      ]
    },
    {
      "content": "Associating an NSG with a subnet",
      "pos": [
        18360,
        18392
      ]
    },
    {
      "content": "When an NSG is associated with a subnet, the network access rules in the NSG are applied to all the VMs in the subnet.",
      "pos": [
        18394,
        18512
      ]
    },
    {
      "content": "Whenever the access rules in the NSG are",
      "pos": [
        18513,
        18553
      ]
    },
    {
      "content": "updated, the changes are applied to all VMs in the subnet within minutes.",
      "pos": [
        18555,
        18628
      ]
    },
    {
      "content": "Associating an NSG with a subnet and a VM",
      "pos": [
        18634,
        18675
      ]
    },
    {
      "content": "You can associate one NSG with a VM and another NSG with the subnet where the VM resides.",
      "pos": [
        18677,
        18766
      ]
    },
    {
      "content": "This scenario is supported to provide the VM with two layers of protection.",
      "pos": [
        18767,
        18842
      ]
    },
    {
      "content": "On the inbound traffic, the packet follows the access rules specified in the subnet, followed by rules in the VM.",
      "pos": [
        18844,
        18957
      ]
    },
    {
      "content": "When outbound, the packet follows the rules specified",
      "pos": [
        18958,
        19011
      ]
    },
    {
      "content": "in the VM first, then follows the rules specified in the subnet as shown below.",
      "pos": [
        19013,
        19092
      ]
    },
    {
      "content": "Associating an NSG to a subnet and a VM",
      "pos": [
        19096,
        19135
      ]
    },
    {
      "content": "When an NSG is associated with a VM or subnet, the network access control rules become very explicit.",
      "pos": [
        19206,
        19307
      ]
    },
    {
      "content": "The platform will not insert any implicit rule to allow",
      "pos": [
        19308,
        19363
      ]
    },
    {
      "content": "traffic to a particular port.",
      "pos": [
        19365,
        19394
      ]
    },
    {
      "content": "In this case, if you create an endpoint in the VM, you must also create a rule to allow traffic from the Internet.",
      "pos": [
        19395,
        19509
      ]
    },
    {
      "content": "If you don't do",
      "pos": [
        19510,
        19525
      ]
    },
    {
      "content": "this, the <bpt id=\"p1\">*</bpt>VIP:{Port}<ept id=\"p1\">*</ept> can't be accessed from outside.",
      "pos": [
        19527,
        19581
      ]
    },
    {
      "content": "For example, you can create a new VM and a new NSG.",
      "pos": [
        19583,
        19634
      ]
    },
    {
      "content": "You associate the NSG with the VM.",
      "pos": [
        19635,
        19669
      ]
    },
    {
      "content": "The VM can communicate with other VMs in the virtual network through the",
      "pos": [
        19670,
        19742
      ]
    },
    {
      "content": "ALLOW VNET INBOUND rule.",
      "pos": [
        19744,
        19768
      ]
    },
    {
      "content": "The VM can also make outbound connections to the Internet using the ALLOW INTERNET OUTBOUND rule.",
      "pos": [
        19769,
        19866
      ]
    },
    {
      "content": "Later, you create an endpoint on port 80",
      "pos": [
        19867,
        19907
      ]
    },
    {
      "content": "to receive traffic to your website running in the VM.",
      "pos": [
        19909,
        19962
      ]
    },
    {
      "content": "Packets destined to port 80 on the VIP (public Virtual IP address) from the Internet will not reach the VM until",
      "pos": [
        19963,
        20075
      ]
    },
    {
      "content": "you add a rule similar to the following table to the NSG.",
      "pos": [
        20077,
        20134
      ]
    },
    {
      "content": "Explicit rule allowing traffic to a particular port",
      "pos": [
        20138,
        20189
      ]
    },
    {
      "content": "Name",
      "pos": [
        20193,
        20197
      ]
    },
    {
      "content": "Priority",
      "pos": [
        20201,
        20209
      ]
    },
    {
      "content": "Source IP",
      "pos": [
        20213,
        20222
      ]
    },
    {
      "content": "Source Port",
      "pos": [
        20225,
        20236
      ]
    },
    {
      "content": "Destination IP",
      "pos": [
        20241,
        20255
      ]
    },
    {
      "content": "Destination Port",
      "pos": [
        20261,
        20277
      ]
    },
    {
      "content": "Protocol",
      "pos": [
        20281,
        20289
      ]
    },
    {
      "content": "Access",
      "pos": [
        20293,
        20299
      ]
    },
    {
      "content": "WEB",
      "pos": [
        20346,
        20349
      ]
    },
    {
      "content": "100",
      "pos": [
        20352,
        20355
      ]
    },
    {
      "content": "INTERNET",
      "pos": [
        20360,
        20368
      ]
    },
    {
      "content": "*",
      "pos": [
        20371,
        20372
      ]
    },
    {
      "content": "*",
      "pos": [
        20376,
        20377
      ]
    },
    {
      "content": "80",
      "pos": [
        20380,
        20382
      ]
    },
    {
      "content": "TCP",
      "pos": [
        20388,
        20391
      ]
    },
    {
      "content": "ALLOW",
      "pos": [
        20396,
        20401
      ]
    },
    {
      "content": "User-defined routes",
      "pos": [
        20406,
        20425
      ]
    },
    {
      "content": "Azure uses a route table to decide how to forward IP traffic based on the destination of each packet.",
      "pos": [
        20427,
        20528
      ]
    },
    {
      "content": "Although Azure provides a default route table based on",
      "pos": [
        20529,
        20583
      ]
    },
    {
      "content": "your virtual network settings, you may need to add custom routes to that table.",
      "pos": [
        20585,
        20664
      ]
    },
    {
      "content": "The most common need for a custom entry in the route table is the use of a virtual appliance in your Azure environment.",
      "pos": [
        20666,
        20785
      ]
    },
    {
      "content": "Take into account the scenario shown in",
      "pos": [
        20786,
        20825
      ]
    },
    {
      "content": "the Figure below.",
      "pos": [
        20827,
        20844
      ]
    },
    {
      "content": "Suppose you want to ensure that all traffic directed to the mid-tier and backed subnets initiated from the front end subnet go through a",
      "pos": [
        20845,
        20981
      ]
    },
    {
      "content": "virtual firewall appliance.",
      "pos": [
        20983,
        21010
      ]
    },
    {
      "content": "Simply adding the appliance to your virtual network and connecting it to the different subnets will not provide this functionality.",
      "pos": [
        21011,
        21142
      ]
    },
    {
      "content": "You must also change the routing table applied to your subnet to ensure packets are forwarded to the virtual firewall appliance.",
      "pos": [
        21144,
        21272
      ]
    },
    {
      "content": "The same would be true if you implemented a virtual NAT appliance to control traffic between your Azure virtual network and the Internet.",
      "pos": [
        21274,
        21411
      ]
    },
    {
      "content": "To ensure the virtual",
      "pos": [
        21412,
        21433
      ]
    },
    {
      "content": "appliance is used you have to create a route specifying that all traffic destined to the Internet must be forwarded to the virtual appliance.",
      "pos": [
        21435,
        21576
      ]
    },
    {
      "content": "Routing",
      "pos": [
        21582,
        21589
      ]
    },
    {
      "content": "Packets are routed over a TCP/IP network based on a route table defined at each node on the physical network.",
      "pos": [
        21591,
        21700
      ]
    },
    {
      "content": "A route table is a collection of individual",
      "pos": [
        21701,
        21744
      ]
    },
    {
      "content": "routes used to decide where to forward packets based on the destination IP address.",
      "pos": [
        21746,
        21829
      ]
    },
    {
      "content": "A route consists of the following:",
      "pos": [
        21830,
        21864
      ]
    },
    {
      "content": "Address Prefix.",
      "pos": [
        21868,
        21883
      ]
    },
    {
      "content": "The destination CIDR to which the route applies, such as 10.1.0.0/16.",
      "pos": [
        21884,
        21953
      ]
    },
    {
      "content": "Next hop type.",
      "pos": [
        21956,
        21970
      ]
    },
    {
      "content": "The type of Azure hop the packet should be sent to.",
      "pos": [
        21971,
        22022
      ]
    },
    {
      "content": "Possible values are:",
      "pos": [
        22023,
        22043
      ]
    },
    {
      "content": "Local.",
      "pos": [
        22048,
        22054
      ]
    },
    {
      "content": "Represents the local virtual network.",
      "pos": [
        22055,
        22092
      ]
    },
    {
      "content": "For instance, if you have two subnets, 10.1.0.0/16 and 10.2.0.0/16 in the same virtual network, the route for each subnet in the route table will have a next hop value of Local.",
      "pos": [
        22093,
        22270
      ]
    },
    {
      "content": "VPN Gateway.",
      "pos": [
        22275,
        22287
      ]
    },
    {
      "content": "Represents an Azure S2S VPN Gateway.",
      "pos": [
        22288,
        22324
      ]
    },
    {
      "content": "Internet.",
      "pos": [
        22329,
        22338
      ]
    },
    {
      "content": "Represents the default Internet gateway provided by the Azure Infrastructure",
      "pos": [
        22339,
        22415
      ]
    },
    {
      "content": "Virtual Appliance.",
      "pos": [
        22420,
        22438
      ]
    },
    {
      "content": "Represents a virtual appliance you added to your Azure virtual network.",
      "pos": [
        22439,
        22510
      ]
    },
    {
      "content": "NULL.",
      "pos": [
        22515,
        22520
      ]
    },
    {
      "content": "Represents a black hole.",
      "pos": [
        22521,
        22545
      ]
    },
    {
      "content": "Packets forwarded to a black hole will not be forwarded at all.",
      "pos": [
        22546,
        22609
      ]
    },
    {
      "content": "Nexthop Value.",
      "pos": [
        22614,
        22628
      ]
    },
    {
      "content": "The next hop value contains the IP address packets should be forwarded to.",
      "pos": [
        22629,
        22703
      ]
    },
    {
      "content": "Next hop values are only allowed in routes where the next hop type is <bpt id=\"p1\">*</bpt>Virtual Appliance<ept id=\"p1\">*</ept>.",
      "pos": [
        22704,
        22794
      ]
    },
    {
      "content": "The next hop needs to be on the subnet (the local interface of the virtual appliance according to the network ID), not a remote subnet.",
      "pos": [
        22795,
        22930
      ]
    },
    {
      "content": "Routing",
      "pos": [
        22935,
        22942
      ]
    },
    {
      "content": "Default routes",
      "pos": [
        23011,
        23025
      ]
    },
    {
      "content": "Every subnet created in a virtual network is automatically associated with a route table that contains the following default route rules:",
      "pos": [
        23027,
        23164
      ]
    },
    {
      "content": "Local VNet Rule: This rule is automatically created for every subnet in a virtual network.",
      "pos": [
        23168,
        23258
      ]
    },
    {
      "content": "It specifies that there is a direct link between the VMs in the VNet and there is no intermediate next hop.",
      "pos": [
        23259,
        23366
      ]
    },
    {
      "content": "This enables the VMs on the same subnet, regardless of the network ID that the VMs exist in, to communicate with each other without requiring a default gateway address.",
      "pos": [
        23367,
        23535
      ]
    },
    {
      "content": "On-premises Rule: This rule applies to all traffic destined to the on-premises address range and uses VPN gateway as the next hop destination.",
      "pos": [
        23538,
        23680
      ]
    },
    {
      "content": "Internet Rule: This rule handles all traffic destined to the public Internet and uses the infrastructure internet gateway as the next hop for all traffic destined to the Internet.",
      "pos": [
        23683,
        23862
      ]
    },
    {
      "content": "BGP routes",
      "pos": [
        23868,
        23878
      ]
    },
    {
      "content": "At the time of this writing, <bpt id=\"p1\">[</bpt>ExpressRoute<ept id=\"p1\">](expressroute/expressroute-introduction.md)</ept> is not yet supported in the <bpt id=\"p2\">[</bpt>Network Resource Provider<ept id=\"p2\">](virtual-network/resource-groups-networking.md)</ept> for Azure Resource Manager.",
      "pos": [
        23880,
        24097
      ]
    },
    {
      "content": "If you have an ExpressRoute connection between your",
      "pos": [
        24099,
        24150
      ]
    },
    {
      "content": "on-premises network and Azure, you can enable BGP to propagate routes from your on-premises network to Azure once ExpressRoute is supported in the NRP.",
      "pos": [
        24152,
        24303
      ]
    },
    {
      "content": "These",
      "pos": [
        24304,
        24309
      ]
    },
    {
      "content": "BGP routes are used in the same way as default routes and user defined routes in each Azure subnet.",
      "pos": [
        24311,
        24410
      ]
    },
    {
      "content": "For more information see",
      "pos": [
        24411,
        24435
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>ExpressRoute Introduction<ept id=\"p1\">](expressroute/expressroute-introduction.md)</ept>.",
      "pos": [
        24437,
        24508
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> When ExpressRoute on NRP is supported, you will be able to configure your Azure environment to use forced tunneling through your on-premises network by creating a user defined route for subnet 0.0.0.0/0 that uses the VPN gateway as the next hop.",
      "pos": [
        24511,
        24769
      ]
    },
    {
      "content": "However, this only works if you are using a VPN gateway, not ExpressRoute.",
      "pos": [
        24770,
        24844
      ]
    },
    {
      "content": "For ExpressRoute, forced tunneling is configured through BGP.",
      "pos": [
        24845,
        24906
      ]
    },
    {
      "content": "User-defined routes",
      "pos": [
        24912,
        24931
      ]
    },
    {
      "content": "You cannot view the default routes specified above in your Azure environment, and for most environments, those are the only routes you will need.",
      "pos": [
        24933,
        25078
      ]
    },
    {
      "content": "However, you may need to create a route table and add one or more routes in specific cases, such as:",
      "pos": [
        25080,
        25180
      ]
    },
    {
      "content": "Forced tunneling to the Internet via your on-premises network.",
      "pos": [
        25186,
        25248
      ]
    },
    {
      "content": "Use of virtual appliances in your Azure environment.",
      "pos": [
        25253,
        25305
      ]
    },
    {
      "content": "In the scenarios above, you will have to create a route table and add user defined routes to it.",
      "pos": [
        25307,
        25403
      ]
    },
    {
      "content": "You can have multiple route tables, and the same route table can",
      "pos": [
        25404,
        25468
      ]
    },
    {
      "content": "be associated to one or more subnets.",
      "pos": [
        25470,
        25507
      ]
    },
    {
      "content": "And each subnet can only be associated to a single route table.",
      "pos": [
        25508,
        25571
      ]
    },
    {
      "content": "All VMs and cloud services in a subnet use the route table",
      "pos": [
        25572,
        25630
      ]
    },
    {
      "content": "associated to that subnet.",
      "pos": [
        25632,
        25658
      ]
    },
    {
      "content": "Subnets rely on default routes until a route table is associated to the subnet.",
      "pos": [
        25660,
        25739
      ]
    },
    {
      "content": "Once an association exists, routing is done based on <bpt id=\"p1\">[</bpt>Longest Prefix Match (LPM)<ept id=\"p1\">](https://en.wikipedia.org/wiki/Longest_prefix_match)</ept>",
      "pos": [
        25740,
        25873
      ]
    },
    {
      "content": "among both user defined routes and default routes.",
      "pos": [
        25875,
        25925
      ]
    },
    {
      "content": "If there is more than one route with the same LPM match then a route is selected based on its origin in the following",
      "pos": [
        25926,
        26043
      ]
    },
    {
      "content": "order:",
      "pos": [
        26045,
        26051
      ]
    },
    {
      "content": "User defined route",
      "pos": [
        26057,
        26075
      ]
    },
    {
      "content": "BGP route (when ExpressRoute is used)",
      "pos": [
        26080,
        26117
      ]
    },
    {
      "content": "Default route",
      "pos": [
        26122,
        26135
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> User defined routes are only applied to Azure VMs and cloud services.",
      "pos": [
        26138,
        26220
      ]
    },
    {
      "content": "For instance, if you want to add a firewall virtual appliance between your on-premises network and Azure, you will have to create a user defined route for your Azure route tables that forwards all traffic going to the on-premises address space to the virtual appliance.",
      "pos": [
        26221,
        26490
      ]
    },
    {
      "content": "However, incoming traffic from the on-premises address space will flow through your VPN gateway or ExpressRoute circuit straight to the Azure environment, bypassing the virtual appliance.",
      "pos": [
        26491,
        26678
      ]
    },
    {
      "content": "IP forwarding",
      "pos": [
        26684,
        26697
      ]
    },
    {
      "content": "As described above, one of the main reasons to create a user defined route is to forward traffic to a virtual appliance.",
      "pos": [
        26699,
        26819
      ]
    },
    {
      "content": "A virtual appliance is nothing more than a",
      "pos": [
        26820,
        26862
      ]
    },
    {
      "content": "VM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.",
      "pos": [
        26864,
        26971
      ]
    },
    {
      "content": "This virtual appliance VM must be able to receive incoming traffic that is not addressed to itself.",
      "pos": [
        26973,
        27072
      ]
    },
    {
      "content": "To allow a VM to receive traffic addressed to other destinations,",
      "pos": [
        27073,
        27138
      ]
    },
    {
      "content": "you must enable IP Forwarding in the VM.",
      "pos": [
        27140,
        27180
      ]
    },
    {
      "content": "Next steps",
      "pos": [
        27185,
        27195
      ]
    },
    {
      "pos": [
        27198,
        27433
      ],
      "content": "To understand how to set up security principals with the correct access to work with resources in your organization, see <bpt id=\"p1\">[</bpt>Authenticating a Service Principal with Azure Resource Manager<ept id=\"p1\">](resource-group-authenticate-service-principal.md)</ept>"
    },
    {
      "content": "If you need to lock access to a resource, you can use management locks.",
      "pos": [
        27436,
        27507
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>Lock Resources with Azure Resource Manager<ept id=\"p1\">](resource-group-lock-resources.md)</ept>",
      "pos": [
        27508,
        27590
      ]
    },
    {
      "pos": [
        27593,
        27741
      ],
      "content": "To configure routing and IP forwarding, see <bpt id=\"p1\">[</bpt>How to Create Routes and Enable IP Forwarding in Azure<ept id=\"p1\">](virtual-network/virtual-networks-udr-how-to.md)</ept>"
    },
    {
      "pos": [
        27745,
        27892
      ],
      "content": "For an overview of role-based access control, see <bpt id=\"p1\">[</bpt>Role-based access control in the Microsoft Azure portal<ept id=\"p1\">](role-based-access-control-configure.md)</ept>"
    },
    {
      "content": "test",
      "pos": [
        27894,
        27898
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"Security considerations for Azure Resource Manager\"\n    description=\"Shows recommended approaches in Azure Resource Manager for securing resources with keys and secrets, role-based access control and network security groups.\"\n    services=\"azure-resource-manager\"\n    documentationCenter=\"\"\n    authors=\"george-moore\"\n    manager=\"georgem\"\n    editor=\"tysonn\"/>\n\n<tags\n    ms.service=\"azure-resource-manager\"\n    ms.workload=\"multiple\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.date=\"08/13/2015\"\n    ms.author=\"georgem\"/>\n\n\n# Security considerations for Azure Resource Manager\n\nWhen looking at aspects of security for your Azure Resource Manager templates, there are several areas to consider â€“ keys and secrets, role-based access control, \nand network security groups.\n\nThis topic assumes you are familiar with Role-Based Access Control (RBAC) in Azure Resource Manager. For more information, see \n[Role-based access control in the Microsoft Azure portal](role-based-access-control-configure.md) and \n[Managing and Auditing Access to Resources](resource-group-rbac.md) \n\nThis topic is part of a larger whitepaper. To read the full paper, download [World Class ARM Templates Considerations and Proven Practices](http://download.microsoft.com/download/8/E/1/8E1DBEFA-CECE-4DC9-A813-93520A5D7CFE/World Class ARM Templates - Considerations and Proven Practices.pdf).\n\n## Secrets and certificates\n\nAzure Virtual Machines, Azure Resource Manager and Azure Key Vault are fully integrated to provide support for the secure handling of certificates which are \nto be deployed in the VM.  Utilizing Azure Key Vault with Resource Manager to orchestrate and store VM secrets and certificates is a best practice and \nprovides the following advantages:\n\n- The templates only contain URI references to the secrets, which means the actual secrets are not in code, configuration or source code repositories. This prevents \nkey phishing attacks on internal or external repos, such as harvest-bots in GitHub.\n- Secrets stored in the Key Vault are under full RBAC control of a trusted operator.  If the trusted operator leaves the company or transfers within the \ncompany to a new group, they no longer have access to the keys they created in the Vault.\n- Full compartmentalization of all assets:\n      - the templates to deploy the keys \n      - the templates to deploy a VM with references to the keys \n      - the actual key materials in the Vault.  \n  Each template (and action) can be under different RBAC roles for full separation of duties.\n- The loading of secrets into a VM at deployment time occurs via direct channel between the Azure Fabric and the Key Vault within the confines of the Microsoft \ndatacenter.  Once the keys are in the Key Vault, they never see 'daylight' over an untrusted channel outside of the datacenter.  \n- Key Vaults are always regional, so the secrets always have locality (and sovereignty) with the VMs. There are no global Key Vaults.\n\n### Separation of keys from deployments\n\nA best practice is to maintain separate templates for:\n\n1.  Creation of vaults (which will contain the key material)\n2.  Deployment of the VMs (with URI references to the keys contained in the vaults)\n\nA typical enterprise scenario is to have a small group of Trusted Operators who have access to critical secrets within the deployed workloads, with a broader group \nof dev/ops personnel who can create or update VM deployments.  Below is an example ARM template which creates and configures a new vault in the context \nof the currently authenticated user's identity in Azure Active Directory.  This user would have the default permission to create, delete, list, update, backup, \nrestore, and get the public half of keys in this new key vault.\n\nWhile most of the fields in this template should be self-explanatory, the **enableVaultForDeployment** setting deserves more background: vaults do not have any default \nstanding access by any other Azure infrastructure component. By setting this value, it allows the Azure Compute infrastructure components read-only access to this \nspecific named vault. Therefore, a further best practice is to not comingle corporate sensitive data in the same vault as virtual machine secrets.\n\n    {\n        \"$schema\": \"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#\",\n        \"contentVersion\": \"1.0.0.0\",\n        \"parameters\": {\n            \"keyVaultName\": {\n                \"type\": \"string\",\n                \"metadata\": {\n                    \"description\": \"Name of the Vault\"\n                }\n            },\n            \"location\": {\n                \"type\": \"string\",\n                \"allowedValues\": [\"East US\", \"West US\", \"West Europe\", \"East Asia\", \"South East Asia\"],\n                \"metadata\": {\n                    \"description\": \"Location of the Vault\"\n                }\n            },\n            \"tenantId\": {\n                \"type\": \"string\",\n                \"metadata\": {\n                    \"description\": \"Tenant Id of the subscription. Get using Get-AzureSubscription cmdlet or Get Subscription API\"\n                }\n            },\n            \"objectId\": {\n                \"type\": \"string\",\n                \"metadata\": {\n                    \"description\": \"Object Id of the AD user. Get using Get-AzureADUser cmdlet\"\n                }\n            },\n            \"skuName\": {\n                \"type\": \"string\",\n                \"allowedValues\": [\"Standard\", \"Premium\"],\n                \"metadata\": {\n                    \"description\": \"SKU for the vault\"\n                }\n            },\n            \"enableVaultForDeployment\": {\n                \"type\": \"bool\",\n                \"allowedValues\": [true, false],\n                \"metadata\": {\n                    \"description\": \"Specifies if the vault is enabled for a VM deployment\"\n                }\n            }\n        },\n        \"resources\": [{\n            \"type\": \"Microsoft.KeyVault/vaults\",\n            \"name\": \"[parameters('keyVaultName')]\",\n            \"apiVersion\": \"2014-12-19-preview\",\n            \"location\": \"[parameters('location')]\",\n            \"properties\": {\n                \"enabledForDeployment\": \"[parameters('enableVaultForDeployment')]\",\n                \"tenantid\": \"[parameters('tenantId')]\",\n                \"accessPolicies\": [{\n                    \"tenantId\": \"[parameters('tenantId')]\",\n                    \"objectId\": \"[parameters('objectId')]\",\n                    \"permissions\": {\n                        \"secrets\": [\"all\"],\n                        \"keys\": [\"all\"]\n                    }\n                }],\n                \"sku\": {\n                    \"name\": \"[parameters('skuName')]\",\n                    \"family\": \"A\"\n                }\n            }\n        }]\n    }\n\nOnce the vault is created, the next step is to reference that vault in the deployment template of a new VM.  As mentioned above, a best practice is to have a \ndifferent dev/ops group manage VM deployments, with that group having no direct access to the keys as stored in the vault.\n\nThe below template fragment would be composed into higher order deployment constructs, each safely and securely referencing highly-sensitive secrets which are not \nunder the direct control of the operator.\n\n    \"vaultName\": {\n        \"type\": \"string\",\n        \"metadata\": {\n            \"description\": \"Name of Key Vault that has a secret\"\n        }\n    },\n    {\n        \"apiVersion\": \"2015-05-01-preview\",\n        \"type\": \"Microsoft.Compute/virtualMachines\",\n        \"name\": \"[parameters('vmName')]\",\n        \"location\": \"[parameters('location')]\",\n        \"properties\": {\n            \"osProfile\": {\n                \"secrets\": [{\n                    \"sourceVault\": {\n                        \"id\": \"[resourceId('vaultrg', 'Microsoft.KeyVault/vaults', 'kayvault')]\"\n                    },\n                    \"vaultCertificates\": [{\n                        \"certificateUrl\": \"[parameters('secretUrlWithVersion')]\",\n                        \"certificateStore\": \"My\"\n                    }]\n                }]\n            }\n        }\n    }\n\n## Service principals for cross-subscription interactions\n\nService identities are represented by service principals in Active Directory. Service principals will be at the center of enabling key scenarios for Enterprise IT organizations, System Integrators (SI), and Cloud Service Vendors (CSV). Specifically, there will be use cases where one of these organizations will need to interact with the subscription of one of their customers.  \n\nYour organization could provide an offering that will monitor a solution deployed in your customers environment and subscription. In this case, you will need to \nget access to logs and other data within a customers account so that you can utilize it in your monitoring solution. If you're a corporate IT organization, a systems integrator, you may provide an offering to a customer where you will deploy and manage a capability for them, \nsuch as a data analytics platform, where the offering resides in the customers own subscription.\n\nIn these use cases, your organization would require an identity that could be given access to perform these actions within the context of a customer subscription.  \n\nThese scenarios bring with them a certain set of considerations for your customer:\n\n-   For security reasons, access may need to be scoped to certain types of actions, e.g. read only access.\n-   As deployed resources are provided at a cost, there may be similar constraints on access required for financial reasons.\n-   For security reasons, access may need to be scoped only to a specific resource (storage accounts) or resources (resource group containing an environment or solution)\n-   As a relationship with a vendor may change, the customer will want to have the ability to enable/disable access to SI or CSV\n-   As actions against this account having billing implications, the customer desires support for auditability and accountability for billing.\n-   From a compliance perspective, the customer will want to be able to audit your behavior within their environment\n\nA combination of a service principal and RBAC can be used to address these requirements.\n\n## Network security groups\n\nMany scenarios will have requirements that specify how traffic to one or more VM instances in your virtual network is controlled. You can use a Network Security \nGroup (NSG) to do this as part of an ARM template deployment.\n\nA network security group is a top-level object that is associated with your subscription. An NSG contains access control rules that allow or deny traffic to \nVM instances. The rules of an NSG can be changed at any time, and changes are applied to all associated instances. To use an NSG, you must have a virtual network \nthat is associated with a region (location). NSGs are not compatible with virtual networks that are associated with an affinity group. If you donâ€™t have a \nregional virtual network and you want to control traffic to your endpoints, please see [About Network Access Control Lists (ACLs)](../virtual-network/virtual-networks-acl.md).\n\nYou can associate an NSG with a VM, or to a subnet within a virtual network. When associated with a VM, the NSG applies to all the traffic that is sent and \nreceived by the VM instance. When applied to a subnet within your virtual network, it applies to all the traffic that is sent and received by all the VM instances \nin the subnet. A VM or subnet can be associated with only 1 NSG, but each NSG can contain up to 200 rules. You can have 100 NSGs per subscription.\n\n>[AZURE.NOTE]  Endpoint-based ACLs and network security groups are not supported on the same VM instance. If you want to use an NSG and have an endpoint ACL already in place, first remove the endpoint ACL. For information about how to do this, see [Managing Access Control Lists (ACLs) for Endpoints by using PowerShell](../virtual-network/virtual-networks-acl-powershell.md).\n\n### How network security groups work\n\nNetwork security groups are different than endpoint-based ACLs. Endpoint ACLs work only on the public port that is exposed through the Input endpoint. An \nNSG works on one or more VM instances and controls all the traffic that is inbound and outbound on the VM.\n\nA network security group has a *Name*, is associated with a *Region* (one of the supported Azure locations), and has a descriptive label. It contains two types of \nrules, Inbound and Outbound. The Inbound rules are applied on the incoming packets to a VM and the Outbound rules are applied to the outgoing packets from the VM. \nThe rules are applied at the server machine where the VM is located. An incoming or outgoing packet must match an Allow rule to be permitted; otherwise, itâ€™s dropped.\n\nRules are processed in the order of priority. For example, a rule with a lower priority number such as 100 is processed before rules with a higher priority numbers \nsuch as 200. Once a match is found, no more rules are processed.\n\nA rule specifies the following:\n\n-   Name: A unique identifier for the rule\n-   Type: Inbound/Outbound\n-   Priority: An integer between 100 and 4096 (rules processed from low to high)\n-   Source IP Address: CIDR of source IP range\n-   Source Port Range: An integer or range between 0 and 65536\n-   Destination IP Range: CIDR of the destination IP Range\n-   Destination Port Range: An integer or range between 0 and 65536\n-   Protocol: TCP, UDP or â€˜\\*â€™\n-   Access: Allow/Deny\n\n### Default rules\n\nAn NSG contains default rules. The default rules can't be deleted, but because they are assigned the lowest priority, they can be overridden by the rules that \nyou create. The default rules describe the default settings recommended by the platform. As illustrated by the default rules below, traffic originating and ending \nin a virtual network is allowed both in Inbound and Outbound directions.\n\nWhile connectivity to the Internet is allowed for outbound direction, it is by default blocked for inbound direction. A default rule allows the Azure load balancer \nto probe the health of a VM. You can override this rule if the VM or set of VMs under the NSG does not participate in the load balanced set.\n\nThe default rules are shown in the tables below.\n\n**Inbound default rules**\n\nName |  Priority |  Source IP | Source Port |   Destination IP |    Destination Port |  Protocol |  Access\n--- | --- | --- | --- | --- | --- | --- | ---\nALLOW VNET INBOUND  | 65000 | VIRTUAL_NETWORK | \\* |    VIRTUAL_NETWORK | \\* |  \\*  | ALLOW\nALLOW AZURE LOAD BALANCER INBOUND   | 65001 | AZURE_LOADBALANCER    | \\*    | \\*    | \\*    | \\*    | ALLOW\nDENY ALL INBOUND    | 65500 | \\*    | \\*    | \\*    | \\*    | \\*    | DENY\n\n**Outbound default rules**\n\nName |  Priority |  Source IP | Source Port |   Destination IP |    Destination Port |  Protocol |  Access\n--- | --- | --- | --- | --- | --- | --- | ---\nALLOW VNET OUTBOUND | 65000 | VIRTUAL_NETWORK   | \\*    | VIRTUAL_NETWORK   | \\*    | \\*    | ALLOW\nALLOW INTERNET OUTBOUND | 65001 | \\*    | \\*    | INTERNET  | \\*    | \\*    | ALLOW\nDENY ALL OUTBOUND   | 65500 | \\*    | \\*    | \\*    | \\*    | \\*    | DENY\n\n### Special infrastructure rules\n\nNSG rules are explicit. No traffic is allowed or denied beyond what is specified in the NSG rules. However, two types of traffic are always allowed regardless of the \nNetwork Security group specification. These provisions are made to support the infrastructure:\n\n- **Virtual IP of the Host Node**: Basic infrastructure services such as DHCP, DNS, and Health monitoring are provided through the virtualized host IP address \n168.63.129.16. This public IP address belongs to Microsoft and will be the only virtualized IP address used in all regions for this purpose. This IP address maps to \nthe physical IP address of the server machine (host node) hosting the VM. The host node acts as the DHCP relay, the DNS recursive resolver, and the probe source for the \nload balancer health probe and the machine health probe. Communication to this IP address should not be considered as an attack.\n- **Licensing (Key Management Service)**: Windows images running in the VMs should be licensed. To do this, a licensing request is sent to the Key Management Service \nhost servers that handle such queries. This will always be on outbound port 1688.\n\n### Default tags\n\nDefault tags are system-provided identifiers to address a category of IP addresses. Default tags can be specified in user-defined rules.\n\n**Default tags for NSGs**\n\nTag |   Description\n--- | ---\nVIRTUAL_NETWORK |   Denotes all of your network address space. It includes the virtual network address space (IP CIDR in Azure) as well as all connected on-premises address space (Local Networks). This also includes virtual network-to-virtual network address spaces.\nAZURE_LOADBALANCER | Denotes the Azure Infrastructure load balancer and will translate to an Azure datacenter IP where Azureâ€™s health probes will originate. This is needed only if the VM or set of VMs associated with the NSG is participating in a load balanced set.\nINTERNET | Denotes the IP address space that is outside the virtual network and can be reached by public Internet. This range includes Azure-owned public IP space as well.\n\n### Ports and port ranges\n\nNSG rules can be specified on a single source or destination port, or on a port range. This approach is particularly useful when you want to open a wide range of ports \nfor an application, such as FTP. The range must be sequential and can't be mixed with individual port specifications.\nTo specify a range of ports, use the hyphen (â€“) character. For example, **100-500**.\n\n### ICMP traffic\n\nWith the current NSG rules, you can specify TCP or UDP as protocols but not ICMP. However, ICMP traffic is allowed within a virtual network by default through \nthe Inbound rules that support traffic from and to any port and protocol (\\*) within the virtual network.\n\n### Associating an NSG with a VM\n\nWhen an NSG is directly associated with a VM, the network access rules in the NSG are directly applied to all traffic that is destined to the VM. Whenever the NSG is \nupdated for rule changes, the traffic handling reflects the updates within minutes. When the NSG is disassociated from the VM, the state reverts to its \npre-NSG conditionâ€”that is, to the system defaults before the NSG was introduced.\n\n### Associating an NSG with a subnet\n\nWhen an NSG is associated with a subnet, the network access rules in the NSG are applied to all the VMs in the subnet. Whenever the access rules in the NSG are \nupdated, the changes are applied to all VMs in the subnet within minutes.\n\n### Associating an NSG with a subnet and a VM\n\nYou can associate one NSG with a VM and another NSG with the subnet where the VM resides. This scenario is supported to provide the VM with two layers of protection. \nOn the inbound traffic, the packet follows the access rules specified in the subnet, followed by rules in the VM. When outbound, the packet follows the rules specified \nin the VM first, then follows the rules specified in the subnet as shown below.\n\n![Associating an NSG to a subnet and a VM](./media/best-practices-resource-manager-security/nsg-subnet-vm.png)\n\nWhen an NSG is associated with a VM or subnet, the network access control rules become very explicit. The platform will not insert any implicit rule to allow \ntraffic to a particular port. In this case, if you create an endpoint in the VM, you must also create a rule to allow traffic from the Internet. If you don't do \nthis, the *VIP:{Port}* can't be accessed from outside.\n\nFor example, you can create a new VM and a new NSG. You associate the NSG with the VM. The VM can communicate with other VMs in the virtual network through the \nALLOW VNET INBOUND rule. The VM can also make outbound connections to the Internet using the ALLOW INTERNET OUTBOUND rule. Later, you create an endpoint on port 80 \nto receive traffic to your website running in the VM. Packets destined to port 80 on the VIP (public Virtual IP address) from the Internet will not reach the VM until \nyou add a rule similar to the following table to the NSG.\n\n**Explicit rule allowing traffic to a particular port**\n\nName |  Priority |  Source IP | Source Port |   Destination IP |    Destination Port |  Protocol |  Access\n--- | --- | --- | --- | --- | --- | --- | ---\nWEB | 100   | INTERNET | *  | * | 80    | TCP   | ALLOW\n\n## User-defined routes\n\nAzure uses a route table to decide how to forward IP traffic based on the destination of each packet. Although Azure provides a default route table based on \nyour virtual network settings, you may need to add custom routes to that table.\n\nThe most common need for a custom entry in the route table is the use of a virtual appliance in your Azure environment. Take into account the scenario shown in \nthe Figure below. Suppose you want to ensure that all traffic directed to the mid-tier and backed subnets initiated from the front end subnet go through a \nvirtual firewall appliance. Simply adding the appliance to your virtual network and connecting it to the different subnets will not provide this functionality. \nYou must also change the routing table applied to your subnet to ensure packets are forwarded to the virtual firewall appliance.\n\nThe same would be true if you implemented a virtual NAT appliance to control traffic between your Azure virtual network and the Internet. To ensure the virtual \nappliance is used you have to create a route specifying that all traffic destined to the Internet must be forwarded to the virtual appliance.\n\n### Routing\n\nPackets are routed over a TCP/IP network based on a route table defined at each node on the physical network. A route table is a collection of individual \nroutes used to decide where to forward packets based on the destination IP address. A route consists of the following:\n\n- Address Prefix. The destination CIDR to which the route applies, such as 10.1.0.0/16.\n- Next hop type. The type of Azure hop the packet should be sent to. Possible values are:\n  - Local. Represents the local virtual network. For instance, if you have two subnets, 10.1.0.0/16 and 10.2.0.0/16 in the same virtual network, the route for each subnet in the route table will have a next hop value of Local.\n  - VPN Gateway. Represents an Azure S2S VPN Gateway.\n  - Internet. Represents the default Internet gateway provided by the Azure Infrastructure\n  - Virtual Appliance. Represents a virtual appliance you added to your Azure virtual network.\n  - NULL. Represents a black hole. Packets forwarded to a black hole will not be forwarded at all.\n-   Nexthop Value. The next hop value contains the IP address packets should be forwarded to. Next hop values are only allowed in routes where the next hop type is *Virtual Appliance*. The next hop needs to be on the subnet (the local interface of the virtual appliance according to the network ID), not a remote subnet. \n\n![Routing](./media/best-practices-resource-manager-security/routing.png)\n\n### Default routes\n\nEvery subnet created in a virtual network is automatically associated with a route table that contains the following default route rules:\n\n- Local VNet Rule: This rule is automatically created for every subnet in a virtual network. It specifies that there is a direct link between the VMs in the VNet and there is no intermediate next hop. This enables the VMs on the same subnet, regardless of the network ID that the VMs exist in, to communicate with each other without requiring a default gateway address.\n- On-premises Rule: This rule applies to all traffic destined to the on-premises address range and uses VPN gateway as the next hop destination.\n- Internet Rule: This rule handles all traffic destined to the public Internet and uses the infrastructure internet gateway as the next hop for all traffic destined to the Internet.\n\n### BGP routes\n\nAt the time of this writing, [ExpressRoute](expressroute/expressroute-introduction.md) is not yet supported in the [Network Resource Provider](virtual-network/resource-groups-networking.md) for Azure Resource Manager.  If you have an ExpressRoute connection between your \non-premises network and Azure, you can enable BGP to propagate routes from your on-premises network to Azure once ExpressRoute is supported in the NRP. These \nBGP routes are used in the same way as default routes and user defined routes in each Azure subnet. For more information see \n[ExpressRoute Introduction](expressroute/expressroute-introduction.md).\n\n>[AZURE.NOTE] When ExpressRoute on NRP is supported, you will be able to configure your Azure environment to use forced tunneling through your on-premises network by creating a user defined route for subnet 0.0.0.0/0 that uses the VPN gateway as the next hop. However, this only works if you are using a VPN gateway, not ExpressRoute. For ExpressRoute, forced tunneling is configured through BGP.\n\n### User-defined routes\n\nYou cannot view the default routes specified above in your Azure environment, and for most environments, those are the only routes you will need. \nHowever, you may need to create a route table and add one or more routes in specific cases, such as:\n\n-   Forced tunneling to the Internet via your on-premises network.\n-   Use of virtual appliances in your Azure environment.\n\nIn the scenarios above, you will have to create a route table and add user defined routes to it. You can have multiple route tables, and the same route table can \nbe associated to one or more subnets. And each subnet can only be associated to a single route table. All VMs and cloud services in a subnet use the route table \nassociated to that subnet.\n\nSubnets rely on default routes until a route table is associated to the subnet. Once an association exists, routing is done based on [Longest Prefix Match (LPM)](https://en.wikipedia.org/wiki/Longest_prefix_match) \namong both user defined routes and default routes. If there is more than one route with the same LPM match then a route is selected based on its origin in the following \norder:\n\n1.  User defined route\n2.  BGP route (when ExpressRoute is used)\n3.  Default route\n\n>[AZURE.NOTE] User defined routes are only applied to Azure VMs and cloud services. For instance, if you want to add a firewall virtual appliance between your on-premises network and Azure, you will have to create a user defined route for your Azure route tables that forwards all traffic going to the on-premises address space to the virtual appliance. However, incoming traffic from the on-premises address space will flow through your VPN gateway or ExpressRoute circuit straight to the Azure environment, bypassing the virtual appliance.\n\n### IP forwarding\n\nAs described above, one of the main reasons to create a user defined route is to forward traffic to a virtual appliance. A virtual appliance is nothing more than a \nVM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.\n\nThis virtual appliance VM must be able to receive incoming traffic that is not addressed to itself. To allow a VM to receive traffic addressed to other destinations, \nyou must enable IP Forwarding in the VM.\n\n## Next steps\n- To understand how to set up security principals with the correct access to work with resources in your organization, see [Authenticating a Service Principal with Azure Resource Manager](resource-group-authenticate-service-principal.md)\n- If you need to lock access to a resource, you can use management locks. See [Lock Resources with Azure Resource Manager](resource-group-lock-resources.md)\n- To configure routing and IP forwarding, see [How to Create Routes and Enable IP Forwarding in Azure](virtual-network/virtual-networks-udr-how-to.md) \n- For an overview of role-based access control, see [Role-based access control in the Microsoft Azure portal](role-based-access-control-configure.md)\n\ntest\n"
}