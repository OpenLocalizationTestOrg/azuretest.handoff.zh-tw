{
  "nodes": [
    {
      "content": "Create a .NET WebJob in Azure App Service",
      "pos": [
        28,
        69
      ]
    },
    {
      "content": "Learn how to create a multi-tier app using ASP.NET MVC and Azure.",
      "pos": [
        89,
        154
      ]
    },
    {
      "content": "The frontend runs in a web app in Azure App Service, and the backend runs as a WebJob.",
      "pos": [
        155,
        241
      ]
    },
    {
      "content": "The app uses Entity Framework, SQL Database, and Azure storage queues and blobs.",
      "pos": [
        242,
        322
      ]
    },
    {
      "content": "Create a .NET WebJob in Azure App Service",
      "pos": [
        663,
        704
      ]
    },
    {
      "content": "Overview",
      "pos": [
        709,
        717
      ]
    },
    {
      "content": "This tutorial shows how to create a multi-tier ASP.NET MVC application that uses the WebJobs SDK to work with <bpt id=\"p1\">[</bpt>Azure queues<ept id=\"p1\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern)</ept> and <bpt id=\"p2\">[</bpt>Azure blobs<ept id=\"p2\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage)</ept> in a web app in <bpt id=\"p3\">[</bpt>Azure App Service<ept id=\"p3\">](http://go.microsoft.com/fwlink/?LinkId=529714)</ept>.",
      "pos": [
        719,
        1240
      ]
    },
    {
      "content": "The application also uses <bpt id=\"p1\">[</bpt>Azure SQL Database<ept id=\"p1\">](http://msdn.microsoft.com/library/azure/ee336279)</ept>.",
      "pos": [
        1241,
        1338
      ]
    },
    {
      "content": "The sample application is an advertising bulletin board.",
      "pos": [
        1341,
        1397
      ]
    },
    {
      "content": "Users create an ad by entering text and uploading an image.",
      "pos": [
        1398,
        1457
      ]
    },
    {
      "content": "They can see a list of ads with thumbnail images, and they can see the full size image when they select an ad to see the details.",
      "pos": [
        1458,
        1587
      ]
    },
    {
      "content": "Here's a screenshot:",
      "pos": [
        1588,
        1608
      ]
    },
    {
      "content": "Ad list",
      "pos": [
        1612,
        1619
      ]
    },
    {
      "pos": [
        1680,
        1762
      ],
      "content": "You can <bpt id=\"p1\">[</bpt>download the Visual Studio project<ept id=\"p1\">][download]</ept> from the MSDN Code Gallery."
    },
    {
      "pos": [
        1847,
        1886
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"prerequisites\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Prerequisites"
    },
    {
      "content": "The tutorial assumes that you know how to work with <bpt id=\"p1\">[</bpt>ASP.NET MVC<ept id=\"p1\">](http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started)</ept> or <bpt id=\"p2\">[</bpt>Web Forms<ept id=\"p2\">](http://www.asp.net/web-forms/tutorials/aspnet-45/getting-started-with-aspnet-45-web-forms/introduction-and-overview)</ept> projects in Visual Studio.",
      "pos": [
        1888,
        2181
      ]
    },
    {
      "content": "The sample application uses MVC, but most of the tutorial also applies to Web Forms.",
      "pos": [
        2182,
        2266
      ]
    },
    {
      "content": "The tutorial instructions work with the following products:",
      "pos": [
        2269,
        2328
      ]
    },
    {
      "content": "Visual Studio 2013",
      "pos": [
        2332,
        2350
      ]
    },
    {
      "content": "Visual Studio 2013 Community",
      "pos": [
        2353,
        2381
      ]
    },
    {
      "content": "Visual Studio 2013 Express for Web",
      "pos": [
        2384,
        2418
      ]
    },
    {
      "content": "If you don't have one of these, Visual Studio 2013 Express for Web will be installed automatically when you install the Azure SDK.",
      "pos": [
        2420,
        2550
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> If you want to get started with Azure App Service before signing up for an Azure account, go to <bpt id=\"p1\">[</bpt>Try App Service<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=523751)</ept>, where you can immediately create a short-lived starter web app in App Service.",
      "pos": [
        2623,
        2876
      ]
    },
    {
      "content": "No credit cards required; no commitments.",
      "pos": [
        2877,
        2918
      ]
    },
    {
      "pos": [
        2923,
        2958
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"learn\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>What you'll learn"
    },
    {
      "content": "The tutorial shows how to do the following tasks:",
      "pos": [
        2960,
        3009
      ]
    },
    {
      "content": "Enable your machine for Azure development by installing the Azure SDK.",
      "pos": [
        3013,
        3083
      ]
    },
    {
      "content": "Create a Console Application project that automatically deploys as an Azure WebJob when you deploy the associated web project.",
      "pos": [
        3086,
        3212
      ]
    },
    {
      "content": "Test a WebJobs SDK backend locally on the development computer.",
      "pos": [
        3215,
        3278
      ]
    },
    {
      "content": "Publish an application with a WebJobs backend to a web app in App Service.",
      "pos": [
        3281,
        3355
      ]
    },
    {
      "content": "Upload files and store them in the Azure Blob service.",
      "pos": [
        3358,
        3412
      ]
    },
    {
      "content": "Use the Azure WebJobs SDK to work with Azure Storage queues and blobs.",
      "pos": [
        3415,
        3485
      ]
    },
    {
      "pos": [
        3490,
        3537
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"contosoads\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Application architecture"
    },
    {
      "pos": [
        3539,
        3827
      ],
      "content": "The sample application uses the <bpt id=\"p1\">[</bpt>queue-centric work pattern<ept id=\"p1\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern)</ept> to off-load the CPU-intensive work of creating thumbnails to a backend process."
    },
    {
      "content": "The app stores ads in a SQL database, using Entity Framework Code First to create the tables and access the data.",
      "pos": [
        3830,
        3943
      ]
    },
    {
      "content": "For each ad, the database stores two URLs: one for the full-size image and one for the thumbnail.",
      "pos": [
        3944,
        4041
      ]
    },
    {
      "content": "Ad table",
      "pos": [
        4045,
        4053
      ]
    },
    {
      "content": "When a user uploads an image, the frontend of the web app stores the image in an <bpt id=\"p1\">[</bpt>Azure blob<ept id=\"p1\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage)</ept>, and it stores the ad information in the database with a URL that points to the blob.",
      "pos": [
        4117,
        4443
      ]
    },
    {
      "content": "At the same time, it writes a message to an Azure queue.",
      "pos": [
        4444,
        4500
      ]
    },
    {
      "content": "A backend process running as an Azure WebJob uses the WebJobs SDK to poll the queue for new messages.",
      "pos": [
        4501,
        4602
      ]
    },
    {
      "content": "When a new message appears, the WebJob creates a thumbnail for that image and updates the thumbnail URL database field for that ad.",
      "pos": [
        4603,
        4734
      ]
    },
    {
      "content": "Here's a diagram that shows how the parts of the application interact:",
      "pos": [
        4735,
        4805
      ]
    },
    {
      "content": "Contoso Ads architecture",
      "pos": [
        4809,
        4833
      ]
    },
    {
      "content": "Alternative architecture",
      "pos": [
        4909,
        4933
      ]
    },
    {
      "content": "WebJobs run in the context of a web app and are not scalable separately.",
      "pos": [
        4935,
        5007
      ]
    },
    {
      "content": "For example, if you have one Standard web app instance, you have only one instance of your background process running, and it is using some of the server resources (CPU, memory, etc.) that otherwise would be available to serve web content.",
      "pos": [
        5008,
        5247
      ]
    },
    {
      "content": "If traffic varies by time of day or day of week, and if the backend processing you need to do can wait, you could schedule your WebJobs to run at low-traffic times.",
      "pos": [
        5250,
        5414
      ]
    },
    {
      "content": "If the load is still too high for that solution, you can consider alternative environments for your backend program, such as the following:",
      "pos": [
        5415,
        5554
      ]
    },
    {
      "content": "Run the program as a WebJob in a separate web app dedicated for that purpose.",
      "pos": [
        5558,
        5635
      ]
    },
    {
      "content": "You can then scale your backend web app independently from your frontend web app.",
      "pos": [
        5636,
        5717
      ]
    },
    {
      "content": "Run the program in an Azure Cloud Service worker role.",
      "pos": [
        5720,
        5774
      ]
    },
    {
      "content": "If you choose this option, you could run the frontend in either a Cloud Service web role or a web app.",
      "pos": [
        5775,
        5877
      ]
    },
    {
      "content": "This tutorial shows how to run the frontend in a web app and the backend as a WebJob in the same web app.",
      "pos": [
        5879,
        5984
      ]
    },
    {
      "content": "For information about how to choose the best environment for your scenario, see <bpt id=\"p1\">[</bpt>Azure web app, cloud services, and virtual machines comparison<ept id=\"p1\">](../choose-web-site-cloud-service-vm/)</ept>.",
      "pos": [
        5985,
        6168
      ]
    },
    {
      "content": "The tutorial instructions apply to Azure SDK for .NET 2.5.1 or later.",
      "pos": [
        6252,
        6321
      ]
    },
    {
      "content": "In the create-from-scratch section where you create the WebJob project, the WebJobs SDK packages are automatically included in the project; with earlier versions of the SDK you have to install the packages manually.",
      "pos": [
        6322,
        6537
      ]
    },
    {
      "pos": [
        6542,
        6593
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"storage\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Create an Azure Storage account"
    },
    {
      "content": "An Azure storage account provides resources for storing queue and blob data in the cloud.",
      "pos": [
        6595,
        6684
      ]
    },
    {
      "content": "It is also used by the WebJobs SDK to store logging data for the dashboard.",
      "pos": [
        6685,
        6760
      ]
    },
    {
      "content": "In a real-world application, you typically create separate accounts for application data versus logging data, and separate accounts for test data versus production data.",
      "pos": [
        6762,
        6931
      ]
    },
    {
      "content": "For this tutorial you'll use just one account.",
      "pos": [
        6932,
        6978
      ]
    },
    {
      "pos": [
        6983,
        7036
      ],
      "content": "Open the <bpt id=\"p1\">**</bpt>Server Explorer<ept id=\"p1\">**</ept> window in Visual Studio."
    },
    {
      "pos": [
        7041,
        7119
      ],
      "content": "Right-click the <bpt id=\"p1\">**</bpt>Azure<ept id=\"p1\">**</ept> node, and then click <bpt id=\"p2\">**</bpt>Connect to Microsoft Azure<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Connect to Azure",
      "pos": [
        7123,
        7139
      ]
    },
    {
      "content": "Sign in using your Azure credentials.",
      "pos": [
        7205,
        7242
      ]
    },
    {
      "pos": [
        7247,
        7335
      ],
      "content": "Right-click <bpt id=\"p1\">**</bpt>Storage<ept id=\"p1\">**</ept> under the Azure node, and then click <bpt id=\"p2\">**</bpt>Create Storage Account<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Create Storage Account",
      "pos": [
        7339,
        7361
      ]
    },
    {
      "pos": [
        7431,
        7510
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Create Storage Account<ept id=\"p1\">**</ept> dialog, enter a name for the storage account."
    },
    {
      "content": "The name must be must be unique (no other Azure storage account can have the same name).",
      "pos": [
        7517,
        7605
      ]
    },
    {
      "content": "If the name you enter is already in use you'll get a chance to change it.",
      "pos": [
        7606,
        7679
      ]
    },
    {
      "pos": [
        7685,
        7758
      ],
      "content": "The URL to access your storage account will be <bpt id=\"p1\">*</bpt>{name}<ept id=\"p1\">*</ept>.core.windows.net."
    },
    {
      "pos": [
        7764,
        7845
      ],
      "content": "Set the <bpt id=\"p1\">**</bpt>Region or Affinity Group<ept id=\"p1\">**</ept> drop-down list to the region closest to you."
    },
    {
      "content": "This setting specifies which Azure datacenter will host your storage account.",
      "pos": [
        7851,
        7928
      ]
    },
    {
      "content": "For this tutorial, your choice won't make a noticeable difference.",
      "pos": [
        7929,
        7995
      ]
    },
    {
      "content": "However, for a production web app, you want your web server and your storage account to be in the same region to minimize latency and data egress charges.",
      "pos": [
        7996,
        8150
      ]
    },
    {
      "content": "The web app (which you'll create later) datacenter should be as close as possible to the browsers accessing the web app in order to minimize latency.",
      "pos": [
        8151,
        8300
      ]
    },
    {
      "pos": [
        8305,
        8369
      ],
      "content": "Set the <bpt id=\"p1\">**</bpt>Replication<ept id=\"p1\">**</ept> drop-down list to <bpt id=\"p2\">**</bpt>Locally redundant<ept id=\"p2\">**</ept>."
    },
    {
      "content": "When geo-replication is enabled for a storage account, the stored content is replicated to a secondary datacenter to enable failover to that location in case of a major disaster in the primary location.",
      "pos": [
        8376,
        8578
      ]
    },
    {
      "content": "Geo-replication can incur additional costs.",
      "pos": [
        8579,
        8622
      ]
    },
    {
      "content": "For test and development accounts, you generally don't want to pay for geo-replication.",
      "pos": [
        8623,
        8710
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Create, manage, or delete a storage account<ept id=\"p1\">](../storage-create-storage-account/#replication-options)</ept>.",
      "pos": [
        8711,
        8839
      ]
    },
    {
      "pos": [
        8844,
        8861
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Create<ept id=\"p1\">**</ept>."
    },
    {
      "content": "New storage account",
      "pos": [
        8870,
        8889
      ]
    },
    {
      "pos": [
        8961,
        9006
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"download\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Download the application"
    },
    {
      "pos": [
        9012,
        9066
      ],
      "content": "Download and unzip the <bpt id=\"p1\">[</bpt>completed solution<ept id=\"p1\">][download]</ept>."
    },
    {
      "content": "Start Visual Studio.",
      "pos": [
        9071,
        9091
      ]
    },
    {
      "pos": [
        9096,
        9238
      ],
      "content": "From the <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept> menu choose <bpt id=\"p2\">**</bpt>Open<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">**</bpt>Project/Solution<ept id=\"p3\">**</ept>, navigate to where you downloaded the solution, and then open the solution file."
    },
    {
      "content": "Press CTRL+SHIFT+B to build the solution.",
      "pos": [
        9243,
        9284
      ]
    },
    {
      "content": "By default, Visual Studio automatically restores the NuGet package content, which was not included in the <bpt id=\"p1\">*</bpt>.zip<ept id=\"p1\">*</ept> file.",
      "pos": [
        9290,
        9408
      ]
    },
    {
      "content": "If the packages don't restore, install them manually by going to the <bpt id=\"p1\">**</bpt>Manage NuGet Packages for Solution<ept id=\"p1\">**</ept> dialog and clicking the <bpt id=\"p2\">**</bpt>Restore<ept id=\"p2\">**</ept> button at the top right.",
      "pos": [
        9409,
        9577
      ]
    },
    {
      "pos": [
        9583,
        9677
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, make sure that <bpt id=\"p2\">**</bpt>ContosoAdsWeb<ept id=\"p2\">**</ept> is selected as the startup project."
    },
    {
      "pos": [
        9682,
        9764
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"configurestorage\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Configure the application to use your storage account"
    },
    {
      "pos": [
        9769,
        9837
      ],
      "content": "Open the application <bpt id=\"p1\">*</bpt>Web.config<ept id=\"p1\">*</ept> file in the ContosoAdsWeb project."
    },
    {
      "content": "The file contains a SQL connection string and an Azure storage connection string for working with blobs and queues.",
      "pos": [
        9844,
        9959
      ]
    },
    {
      "pos": [
        9966,
        10091
      ],
      "content": "The SQL connection string points to a <bpt id=\"p1\">[</bpt>SQL Server Express LocalDB<ept id=\"p1\">](http://msdn.microsoft.com/library/hh510202.aspx)</ept> database."
    },
    {
      "content": "The storage connection string is an example that has placeholders for the storage account name and access key.",
      "pos": [
        10098,
        10208
      ]
    },
    {
      "content": "You'll replace this with a connection string that has the name and key of your storage account.",
      "pos": [
        10209,
        10304
      ]
    },
    {
      "pos": [
        10312,
        10785
      ],
      "content": "<pre class=\"prettyprint\">&lt;connectionStrings&gt;\n   &lt;add name=\"ContosoAdsContext\" connectionString=\"Data Source=(localdb)\\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;\" providerName=\"System.Data.SqlClient\" /&gt;\n   &lt;add name=\"AzureWebJobsStorage\" connectionString=\"DefaultEndpointsProtocol=https;AccountName=<mark>[accountname]</mark>;AccountKey=<mark>[accesskey]</mark>\"/&gt;\n &lt;/connectionStrings&gt;</pre>",
      "leadings": [
        "",
        "   ",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "&amp;lt;connectionStrings&amp;gt;",
          "pos": [
            25,
            50
          ]
        },
        {
          "content": "&amp;lt;add name=\"ContosoAdsContext\" connectionString=\"Data Source=(localdb)\\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;\" providerName=\"System.Data.SqlClient\" /&amp;gt;",
          "pos": [
            54,
            262
          ]
        },
        {
          "content": "&amp;lt;add name=\"AzureWebJobsStorage\" connectionString=\"DefaultEndpointsProtocol=https;AccountName=",
          "pos": [
            266,
            362
          ]
        },
        {
          "content": "[accountname]",
          "pos": [
            368,
            381
          ]
        },
        {
          "content": ";AccountKey=",
          "pos": [
            388,
            400
          ]
        },
        {
          "content": "[accesskey]",
          "pos": [
            406,
            417
          ]
        },
        {
          "content": "\"/&amp;gt;",
          "pos": [
            424,
            430
          ]
        },
        {
          "content": "&amp;lt;/connectionStrings&amp;gt;",
          "pos": [
            432,
            458
          ]
        }
      ]
    },
    {
      "content": "The storage connection string is named AzureWebJobsStorage because that's the name the WebJobs SDK uses by default.",
      "pos": [
        10791,
        10906
      ]
    },
    {
      "content": "The same name is used here so you have to set only one connection string value in the Azure environment.",
      "pos": [
        10907,
        11011
      ]
    },
    {
      "pos": [
        11017,
        11132
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Server Explorer<ept id=\"p1\">**</ept>, right-click your storage account under the <bpt id=\"p2\">**</bpt>Storage<ept id=\"p2\">**</ept> node, and then click <bpt id=\"p3\">**</bpt>Properties<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Click Storage Account Properties",
      "pos": [
        11140,
        11172
      ]
    },
    {
      "pos": [
        11243,
        11333
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept> window, click <bpt id=\"p2\">**</bpt>Storage Account Keys<ept id=\"p2\">**</ept>, and then click the ellipsis."
    },
    {
      "content": "New storage account",
      "pos": [
        11341,
        11360
      ]
    },
    {
      "pos": [
        11432,
        11463
      ],
      "content": "Copy the <bpt id=\"p1\">**</bpt>Connection String<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Storage Account Keys dialog",
      "pos": [
        11471,
        11498
      ]
    },
    {
      "content": "Replace the storage connection string in the <bpt id=\"p1\">*</bpt>Web.config<ept id=\"p1\">*</ept> file with the connection string you just copied.",
      "pos": [
        11566,
        11672
      ]
    },
    {
      "content": "Make sure you select everything inside the quotation marks but not including the quotation marks before pasting.",
      "pos": [
        11673,
        11785
      ]
    },
    {
      "pos": [
        11790,
        11849
      ],
      "content": "Open the <bpt id=\"p1\">*</bpt>App.config<ept id=\"p1\">*</ept> file in the ContosoAdsWebJob project."
    },
    {
      "pos": [
        11855,
        12874
      ],
      "content": "This file has two storage connection strings, one for application data and one for logging. For this tutorial you'll use the same account for both. The connection strings have placeholders for the storage account keys.\n <pre class=\"prettyprint\">&lt;configuration&gt;\n &lt;connectionStrings&gt;\n     &lt;add name=\"AzureWebJobsDashboard\" connectionString=\"DefaultEndpointsProtocol=https;AccountName=<mark>[accountname]</mark>;AccountKey=<mark>[accesskey]</mark>\"/&gt;\n     &lt;add name=\"AzureWebJobsStorage\" connectionString=\"DefaultEndpointsProtocol=https;AccountName=<mark>[accountname]</mark>;AccountKey=<mark>[accesskey]</mark>\"/&gt;\n     &lt;add name=\"ContosoAdsContext\" connectionString=\"Data Source=(localdb)\\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;\"/&gt;\n &lt;/connectionStrings&gt;\n     &lt;startup&gt; \n         &lt;supportedRuntime version=\"v4.0\" sku=\".NETFramework,Version=v4.5\" /&gt;\n &lt;/startup&gt;\n&lt;/configuration&gt;</pre>",
      "leadings": [
        "",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        ""
      ],
      "nodes": [
        {
          "content": "This file has two storage connection strings, one for application data and one for logging. For this tutorial you'll use the same account for both. The connection strings have placeholders for the storage account keys.",
          "pos": [
            0,
            218
          ],
          "nodes": [
            {
              "content": "This file has two storage connection strings, one for application data and one for logging.",
              "pos": [
                0,
                91
              ]
            },
            {
              "content": "For this tutorial you'll use the same account for both.",
              "pos": [
                92,
                147
              ]
            },
            {
              "content": "The connection strings have placeholders for the storage account keys.",
              "pos": [
                148,
                218
              ]
            }
          ]
        },
        {
          "content": "&amp;lt;configuration&amp;gt;",
          "pos": [
            245,
            266
          ]
        },
        {
          "content": "&amp;lt;connectionStrings&amp;gt;",
          "pos": [
            268,
            293
          ]
        },
        {
          "content": "&amp;lt;add name=\"AzureWebJobsDashboard\" connectionString=\"DefaultEndpointsProtocol=https;AccountName=",
          "pos": [
            299,
            397
          ]
        },
        {
          "content": "[accountname]",
          "pos": [
            403,
            416
          ]
        },
        {
          "content": ";AccountKey=",
          "pos": [
            423,
            435
          ]
        },
        {
          "content": "[accesskey]",
          "pos": [
            441,
            452
          ]
        },
        {
          "content": "\"/&amp;gt;",
          "pos": [
            459,
            465
          ]
        },
        {
          "content": "&amp;lt;add name=\"AzureWebJobsStorage\" connectionString=\"DefaultEndpointsProtocol=https;AccountName=",
          "pos": [
            471,
            567
          ]
        },
        {
          "content": "[accountname]",
          "pos": [
            573,
            586
          ]
        },
        {
          "content": ";AccountKey=",
          "pos": [
            593,
            605
          ]
        },
        {
          "content": "[accesskey]",
          "pos": [
            611,
            622
          ]
        },
        {
          "content": "\"/&amp;gt;",
          "pos": [
            629,
            635
          ]
        },
        {
          "content": "&amp;lt;add name=\"ContosoAdsContext\" connectionString=\"Data Source=(localdb)\\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;\"/&amp;gt;",
          "pos": [
            641,
            811
          ]
        },
        {
          "content": "&amp;lt;/connectionStrings&amp;gt;",
          "pos": [
            813,
            839
          ]
        },
        {
          "content": "&amp;lt;startup&amp;gt;",
          "pos": [
            845,
            860
          ]
        },
        {
          "content": "&amp;lt;supportedRuntime version=\"v4.0\" sku=\".NETFramework,Version=v4.5\" /&amp;gt;",
          "pos": [
            871,
            945
          ]
        },
        {
          "content": "&amp;lt;/startup&amp;gt;",
          "pos": [
            947,
            963
          ]
        },
        {
          "content": "&amp;lt;/configuration&amp;gt;",
          "pos": [
            964,
            986
          ]
        }
      ]
    },
    {
      "content": "By default, the WebJobs SDK looks for connection strings named AzureWebJobsStorage and AzureWebJobsDashboard.",
      "pos": [
        12880,
        12989
      ]
    },
    {
      "content": "As an alternative, you can <bpt id=\"p1\">[</bpt>store the connection string however you want and pass it in explicitly to the <ph id=\"ph1\">`JobHost`</ph> object<ept id=\"p1\">](websites-dotnet-webjobs-sdk-storage-queues-how-to.md#config)</ept>.",
      "pos": [
        12990,
        13175
      ]
    },
    {
      "content": "Replace both storage connection strings with the connection string you copied earlier.",
      "pos": [
        13180,
        13266
      ]
    },
    {
      "content": "Save your changes.",
      "pos": [
        13271,
        13289
      ]
    },
    {
      "pos": [
        13294,
        13337
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"run\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Run the application locally"
    },
    {
      "content": "To start the web frontend of the application, press CTRL+F5.",
      "pos": [
        13342,
        13402
      ]
    },
    {
      "content": "The default browser opens to the home page.",
      "pos": [
        13409,
        13452
      ]
    },
    {
      "content": "(The web project runs because you've made it the startup project.)",
      "pos": [
        13453,
        13519
      ]
    },
    {
      "content": "Contoso Ads home page",
      "pos": [
        13527,
        13548
      ]
    },
    {
      "pos": [
        13612,
        13777
      ],
      "content": "To start the WebJob backend of the application, right-click the ContosoAdsWebJob project in <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Debug<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">**</bpt>Start new instance<ept id=\"p3\">**</ept>."
    },
    {
      "content": "A console application window opens and displays logging messages indicating the WebJobs SDK JobHost object has started to run.",
      "pos": [
        13783,
        13909
      ]
    },
    {
      "content": "Console application window showing that the backend is running",
      "pos": [
        13917,
        13979
      ]
    },
    {
      "pos": [
        14053,
        14094
      ],
      "content": "In your browser, click  <bpt id=\"p1\">**</bpt>Create an Ad<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        14099,
        14177
      ],
      "content": "Enter some test data and select an image to upload, and then click <bpt id=\"p1\">**</bpt>Create<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Create page",
      "pos": [
        14185,
        14196
      ]
    },
    {
      "content": "The app goes to the Index page, but it doesn't show a thumbnail for the new ad because that processing hasn't happened yet.",
      "pos": [
        14263,
        14386
      ]
    },
    {
      "content": "Meanwhile, after a short wait a logging message in the console application window shows that a queue message was received and has been processed.",
      "pos": [
        14392,
        14537
      ]
    },
    {
      "content": "Console application window showing that a queue message has been processed",
      "pos": [
        14548,
        14622
      ]
    },
    {
      "content": "After you see the logging messages in the console application window, refresh the Index page to see the thumbnail.",
      "pos": [
        14693,
        14807
      ]
    },
    {
      "content": "Index page",
      "pos": [
        14815,
        14825
      ]
    },
    {
      "pos": [
        14889,
        14946
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Details<ept id=\"p1\">**</ept> for your ad to see the full-size image."
    },
    {
      "content": "Details page",
      "pos": [
        14954,
        14966
      ]
    },
    {
      "content": "You've been running the application on your local computer, and it's using a SQL Server database located on your computer, but it's working with queues and blobs in the cloud.",
      "pos": [
        15030,
        15205
      ]
    },
    {
      "content": "In the following section you'll run the application in the cloud, using a cloud database as well as cloud blobs and queues.",
      "pos": [
        15206,
        15329
      ]
    },
    {
      "pos": [
        15336,
        15391
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"runincloud\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Run the application in the cloud"
    },
    {
      "content": "You'll do the following steps to run the application in the cloud:",
      "pos": [
        15393,
        15459
      ]
    },
    {
      "content": "Deploy to Web Apps.",
      "pos": [
        15463,
        15482
      ]
    },
    {
      "content": "Visual Studio will automatically create a new web app in App Service and SQL Database instance.",
      "pos": [
        15483,
        15578
      ]
    },
    {
      "content": "Configure the web app to use your Azure SQL database and storage account.",
      "pos": [
        15581,
        15654
      ]
    },
    {
      "content": "After you've created some ads while running in the cloud, you'll view the WebJobs SDK dashboard to see the rich monitoring features it has to offer.",
      "pos": [
        15656,
        15804
      ]
    },
    {
      "content": "Deploy to Web Apps",
      "pos": [
        15810,
        15828
      ]
    },
    {
      "content": "Close the browser and the console application window.",
      "pos": [
        15833,
        15886
      ]
    },
    {
      "pos": [
        15891,
        15983
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, right-click the ContosoAdsWeb project, and then click <bpt id=\"p2\">**</bpt>Publish<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        15988,
        16078
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Profile<ept id=\"p1\">**</ept> step of the <bpt id=\"p2\">**</bpt>Publish Web<ept id=\"p2\">**</ept> wizard, click <bpt id=\"p3\">**</bpt>Microsoft Azure web apps<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Select Azure web app publish target",
      "pos": [
        16086,
        16121
      ]
    },
    {
      "pos": [
        16189,
        16306
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Select existing web app<ept id=\"p1\">**</ept> box, click <bpt id=\"p2\">**</bpt>Sign In<ept id=\"p2\">**</ept> and enter your credentials if you're not already signed in."
    },
    {
      "pos": [
        16312,
        16350
      ],
      "content": "After you're signed in, click <bpt id=\"p1\">**</bpt>New<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Click New",
      "pos": [
        16358,
        16367
      ]
    },
    {
      "pos": [
        16435,
        16540
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Create web app on Microsoft Azure<ept id=\"p1\">**</ept> dialog box, enter a unique name in the <bpt id=\"p2\">**</bpt>Web app name<ept id=\"p2\">**</ept> box."
    },
    {
      "content": "The complete URL will consist of what you enter here plus .azurewebsites.net (as shown next to the <bpt id=\"p1\">**</bpt>Web app name<ept id=\"p1\">**</ept> text box).",
      "pos": [
        16546,
        16672
      ]
    },
    {
      "content": "For example, if the web app name is ContosoAds, the URL will be ContosoAds.azurewebsites.net.",
      "pos": [
        16673,
        16766
      ]
    },
    {
      "pos": [
        16771,
        16922
      ],
      "content": "In the <bpt id=\"p1\">[</bpt>App Service plan<ept id=\"p1\">](../app-service/azure-web-sites-web-hosting-plans-in-depth-overview.md)</ept> drop-down list choose <bpt id=\"p2\">**</bpt>Create new App Service plan<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Enter a name for the App Service plan, such as ContosoAdsPlan.",
      "pos": [
        16928,
        16990
      ]
    },
    {
      "pos": [
        16995,
        17102
      ],
      "content": "In the <bpt id=\"p1\">[</bpt>Resource group<ept id=\"p1\">](../resource-group-overview.md)</ept> drop-down list choose <bpt id=\"p2\">**</bpt>Create new resource group<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Enter a name for the resource group, such as ContosoAdsGroup.",
      "pos": [
        17108,
        17169
      ]
    },
    {
      "pos": [
        17174,
        17265
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Region<ept id=\"p1\">**</ept> drop-down list choose the same region you chose for your storage account."
    },
    {
      "content": "This setting specifies which Azure datacenter your web app will run in.",
      "pos": [
        17271,
        17342
      ]
    },
    {
      "content": "Keeping the web app and storage account in the same datacenter minimizes latency and data egress charges.",
      "pos": [
        17343,
        17448
      ]
    },
    {
      "pos": [
        17453,
        17524
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Database server<ept id=\"p1\">**</ept> drop-down list choose <bpt id=\"p2\">**</bpt>Create new server<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Alternatively, if your subscription already has a server, you can select that server from the drop-down list.",
      "pos": [
        17530,
        17639
      ]
    },
    {
      "content": "Enter a name for the database server, such as ContosoAdsServer.",
      "pos": [
        17644,
        17707
      ]
    },
    {
      "pos": [
        17712,
        17783
      ],
      "content": "Enter an administrator <bpt id=\"p1\">**</bpt>Database username<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Database password<ept id=\"p2\">**</ept>."
    },
    {
      "content": "If you selected <bpt id=\"p1\">**</bpt>New SQL Database server<ept id=\"p1\">**</ept> you aren't entering an existing name and password here, you're entering a new name and password that you're defining now to use later when you access the database.",
      "pos": [
        17790,
        17997
      ]
    },
    {
      "content": "If you selected a server that you created previously, you'll be prompted for the password to the administrative user account you already created.",
      "pos": [
        17998,
        18143
      ]
    },
    {
      "pos": [
        18148,
        18165
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Create<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Create web app on Microsoft Azure dialog",
      "pos": [
        18173,
        18213
      ]
    },
    {
      "content": "Visual Studio creates the solution, the web project, the web app in Azure, and the Azure SQL Database instance.",
      "pos": [
        18281,
        18392
      ]
    },
    {
      "pos": [
        18397,
        18470
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Connection<ept id=\"p1\">**</ept> step of the <bpt id=\"p2\">**</bpt>Publish Web<ept id=\"p2\">**</ept> wizard, click <bpt id=\"p3\">**</bpt>Next<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Connection step",
      "pos": [
        18478,
        18493
      ]
    },
    {
      "pos": [
        18565,
        18678
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Settings<ept id=\"p1\">**</ept> step, clear the <bpt id=\"p2\">**</bpt>Use this connection string at runtime<ept id=\"p2\">**</ept> check box, and then click <bpt id=\"p3\">**</bpt>Next<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Settings step",
      "pos": [
        18686,
        18699
      ]
    },
    {
      "content": "You don't need to use the publish dialog to set the SQL connection string because you'll set that value in the Azure environment later.",
      "pos": [
        18778,
        18913
      ]
    },
    {
      "content": "You can ignore the warnings on this page.",
      "pos": [
        18919,
        18960
      ]
    },
    {
      "content": "Normally the storage account you use when running in Azure would be different from the one you use when running locally, but for this tutorial you're using the same one in both environments.",
      "pos": [
        18969,
        19159
      ]
    },
    {
      "content": "So the AzureWebJobsStorage connection string does not need to be transformed.",
      "pos": [
        19160,
        19237
      ]
    },
    {
      "content": "Even if you did want to use a different storage account in the cloud, you wouldn't need to transform the connection string because the app will use an Azure environment setting when it runs in Azure.",
      "pos": [
        19238,
        19437
      ]
    },
    {
      "content": "You'll see this later in the tutorial.",
      "pos": [
        19438,
        19476
      ]
    },
    {
      "content": "For this tutorial you aren't going to be making changes to the data model used for the ContosoAdsContext database, so there is no need to use Entity Framework Code First Migrations for deployment.",
      "pos": [
        19484,
        19680
      ]
    },
    {
      "content": "Code First will automatically create a new database the first time the app tries to access SQL data.",
      "pos": [
        19681,
        19781
      ]
    },
    {
      "pos": [
        19787,
        19880
      ],
      "content": "For this tutorial, the default values of the options under <bpt id=\"p1\">**</bpt>File Publish Options<ept id=\"p1\">**</ept> are fine."
    },
    {
      "pos": [
        19886,
        19935
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Preview<ept id=\"p1\">**</ept> step, click <bpt id=\"p2\">**</bpt>Start Preview<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Click Start Preview",
      "pos": [
        19943,
        19962
      ]
    },
    {
      "content": "You can ignore the warning about no databases being published.",
      "pos": [
        20035,
        20097
      ]
    },
    {
      "content": "Entity Framework Code First will create the database; it doesn't need to be published.",
      "pos": [
        20098,
        20184
      ]
    },
    {
      "pos": [
        20190,
        20348
      ],
      "content": "the preview window shows that binaries and configuration files from the WebJob project will be copied to the <bpt id=\"p1\">*</bpt>app_data\\jobs\\continuous<ept id=\"p1\">*</ept> folder of the web app."
    },
    {
      "content": "WebJobs files in preview window",
      "pos": [
        20356,
        20387
      ]
    },
    {
      "pos": [
        20463,
        20481
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Publish<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Visual Studio deploys the application and opens the home page URL in the browser.",
      "pos": [
        20487,
        20568
      ]
    },
    {
      "content": "You won't be able to use the web app until you set connection strings in the Azure environment in the next section.",
      "pos": [
        20575,
        20690
      ]
    },
    {
      "content": "You'll see either an error page or the home page depending on web app and database creation options you chose earlier.",
      "pos": [
        20691,
        20809
      ]
    },
    {
      "content": "Configure the web app to use your Azure SQL database and storage account.",
      "pos": [
        20816,
        20889
      ]
    },
    {
      "content": "It's a security best practice to <bpt id=\"p1\">[</bpt>avoid putting sensitive information such as connection strings in files that are stored in source code repositories<ept id=\"p1\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control#secrets)</ept>.",
      "pos": [
        20891,
        21186
      ]
    },
    {
      "content": "Azure provides a way to do that: you can set connection string and other setting values in the Azure environment, and ASP.NET configuration APIs automatically pick up these values when the app runs in Azure.",
      "pos": [
        21187,
        21394
      ]
    },
    {
      "content": "You can set these values in Azure by using <bpt id=\"p1\">**</bpt>Server Explorer<ept id=\"p1\">**</ept>, the portal, Windows PowerShell, or the cross-platform command-line interface.",
      "pos": [
        21395,
        21536
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>How Application Strings and Connection Strings Work<ept id=\"p1\">](/blog/2013/07/17/windows-azure-web-sites-how-application-strings-and-connection-strings-work/)</ept>.",
      "pos": [
        21537,
        21712
      ]
    },
    {
      "pos": [
        21714,
        21799
      ],
      "content": "In this section you use <bpt id=\"p1\">**</bpt>Server Explorer<ept id=\"p1\">**</ept> to set connection string values in Azure."
    },
    {
      "pos": [
        21804,
        21915
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Server Explorer<ept id=\"p1\">**</ept>, right-click your web app under the <bpt id=\"p2\">**</bpt>Web Apps<ept id=\"p2\">**</ept> node, and then click <bpt id=\"p3\">**</bpt>View Settings<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        21921,
        21985
      ],
      "content": "The <bpt id=\"p1\">**</bpt>Azure Web App<ept id=\"p1\">**</ept> window opens on the <bpt id=\"p2\">**</bpt>Configuration<ept id=\"p2\">**</ept> tab."
    },
    {
      "content": "Change the name of the DefaultConnection connection string to ContosoAdsContext.",
      "pos": [
        21990,
        22070
      ]
    },
    {
      "content": "Azure automatically created this connection string when you created the web app with an associated database, so it already has the right connection string value.",
      "pos": [
        22076,
        22237
      ]
    },
    {
      "content": "You're changing just the name to what your code is looking for.",
      "pos": [
        22238,
        22301
      ]
    },
    {
      "content": "Add two new connection strings, named AzureWebJobsStorage and AzureWebJobsDashboard.",
      "pos": [
        22306,
        22390
      ]
    },
    {
      "content": "Set type to Custom, and set the connection string value to the same value that you used earlier for the <bpt id=\"p1\">*</bpt>Web.config<ept id=\"p1\">*</ept> and <bpt id=\"p2\">*</bpt>App.config<ept id=\"p2\">*</ept> files.",
      "pos": [
        22391,
        22531
      ]
    },
    {
      "content": "(Make sure you include the entire connection string, not just the access key, and don't include the quotation marks.)",
      "pos": [
        22532,
        22649
      ]
    },
    {
      "content": "These connection strings are used by the WebJobs SDK, one for application data and one for logging.",
      "pos": [
        22655,
        22754
      ]
    },
    {
      "content": "As you saw earlier, the one for application data is also used by the web frontend code.",
      "pos": [
        22755,
        22842
      ]
    },
    {
      "pos": [
        22851,
        22866
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Save<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Connection strings in Azure portal",
      "pos": [
        22874,
        22908
      ]
    },
    {
      "pos": [
        22978,
        23059
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Server Explorer<ept id=\"p1\">**</ept>, right-click the web app, and then click <bpt id=\"p2\">**</bpt>Stop web app<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        23066,
        23155
      ],
      "content": "After the web app stops, right-click the web app again, and then click <bpt id=\"p1\">**</bpt>Start web app<ept id=\"p1\">**</ept>."
    },
    {
      "content": "The WebJob automatically starts when you publish, but it stops when you make a configuration change.",
      "pos": [
        23161,
        23261
      ]
    },
    {
      "content": "To restart it you can either restart the web app or restart the WebJob in the <bpt id=\"p1\">[</bpt>Azure Portal<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=529715)</ept>.",
      "pos": [
        23262,
        23402
      ]
    },
    {
      "content": "It's generally recommended to restart the web app after a configuration change.",
      "pos": [
        23403,
        23482
      ]
    },
    {
      "content": "Refresh the browser window that has the web app URL in its address bar.",
      "pos": [
        23488,
        23559
      ]
    },
    {
      "content": "The home page appears.",
      "pos": [
        23565,
        23587
      ]
    },
    {
      "content": "Create an ad, as you did when you ran the application locally.",
      "pos": [
        23593,
        23655
      ]
    },
    {
      "content": "The Index page shows without a thumbnail at first.",
      "pos": [
        23661,
        23711
      ]
    },
    {
      "content": "Refresh the page after a few seconds, and the thumbnail appears.",
      "pos": [
        23717,
        23781
      ]
    },
    {
      "content": "If the thumbnail doesn't appear, the WebJob may not have started automatically.",
      "pos": [
        23787,
        23866
      ]
    },
    {
      "content": "In that case, go to the WebJobs tab in the",
      "pos": [
        23867,
        23909
      ]
    },
    {
      "content": "View the WebJobs SDK dashboard",
      "pos": [
        23918,
        23948
      ]
    },
    {
      "pos": [
        23953,
        24029
      ],
      "content": "In the <bpt id=\"p1\">[</bpt>Azure Portal<ept id=\"p1\">](https://manage.windowsazure.com)</ept>, select your web app."
    },
    {
      "pos": [
        24034,
        24060
      ],
      "content": "Click the <bpt id=\"p1\">**</bpt>WebJobs<ept id=\"p1\">**</ept> tab."
    },
    {
      "content": "click the URL in the Logs column for your WebJob.",
      "pos": [
        24065,
        24114
      ]
    },
    {
      "content": "WebJobs tab",
      "pos": [
        24122,
        24133
      ]
    },
    {
      "content": "A new browser tab opens to the WebJobs SDK dashboard.",
      "pos": [
        24199,
        24252
      ]
    },
    {
      "content": "The dashboard shows that the WebJob is running and shows a list of functions in your code that the WebJobs SDK triggered.",
      "pos": [
        24253,
        24374
      ]
    },
    {
      "content": "Click one of the functions to see details about its execution",
      "pos": [
        24379,
        24440
      ]
    },
    {
      "content": "WebJobs SDK dashboard",
      "pos": [
        24450,
        24471
      ]
    },
    {
      "content": "WebJobs SDK dashboard",
      "pos": [
        24552,
        24573
      ]
    },
    {
      "pos": [
        24652,
        24831
      ],
      "content": "The <bpt id=\"p1\">**</bpt>Replay Function<ept id=\"p1\">**</ept> button on this page causes the WebJobs SDK framework to call the function again, and it gives you a chance to change the data passed to the function first."
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> When you're finished testing, delete the web app and the SQL Database instance.",
      "pos": [
        24834,
        24926
      ]
    },
    {
      "content": "The web app is free, but the SQL Database instance and storage account accrue charges (minimal due to small size).",
      "pos": [
        24927,
        25041
      ]
    },
    {
      "content": "Also, if you leave the web app running, anyone who finds your URL can create and view ads.",
      "pos": [
        25042,
        25132
      ]
    },
    {
      "content": "In the Azure portal, go to the <bpt id=\"p1\">**</bpt>Dashboard<ept id=\"p1\">**</ept> tab for your web app, and then click the <bpt id=\"p2\">**</bpt>Delete<ept id=\"p2\">**</ept> button at the bottom of the page.",
      "pos": [
        25133,
        25263
      ]
    },
    {
      "content": "You can then select a check box to delete the SQL Database instance at the same time.",
      "pos": [
        25264,
        25349
      ]
    },
    {
      "content": "If you just want to temporarily prevent others from accessing the web app, click <bpt id=\"p1\">**</bpt>Stop<ept id=\"p1\">**</ept> instead.",
      "pos": [
        25350,
        25448
      ]
    },
    {
      "content": "In that case, charges will continue to accrue for the SQL Database and Storage account.",
      "pos": [
        25449,
        25536
      ]
    },
    {
      "content": "You can follow a similar procedure to delete the SQL database and storage account when you no longer need them.",
      "pos": [
        25537,
        25648
      ]
    },
    {
      "content": "Enable AlwaysOn for long-running processes",
      "pos": [
        25654,
        25696
      ]
    },
    {
      "pos": [
        25698,
        26014
      ],
      "content": "To make sure your WebJobs are always running, and running on all instances of your web app you have to enabled the <bpt id=\"p1\">[</bpt>AlwaysOn<ept id=\"p1\">](http://weblogs.asp.net/scottgu/archive/2014/01/16/windows-azure-staging-publishing-support-for-web-sites-monitoring-improvements-hyper-v-recovery-manager-ga-and-pci-compliance.aspx)</ept> feature."
    },
    {
      "pos": [
        26019,
        26073
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"create\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Create the application from scratch"
    },
    {
      "content": "In this section you'll do the following tasks:",
      "pos": [
        26076,
        26122
      ]
    },
    {
      "content": "Create a Visual Studio solution with a web project.",
      "pos": [
        26126,
        26177
      ]
    },
    {
      "content": "Add a class library project for the data access layer that is shared between frontend and backend.",
      "pos": [
        26180,
        26278
      ]
    },
    {
      "content": "Add a Console Application project for the backend, with WebJobs deployment enabled.",
      "pos": [
        26281,
        26364
      ]
    },
    {
      "content": "Add NuGet packages.",
      "pos": [
        26367,
        26386
      ]
    },
    {
      "content": "Set project references.",
      "pos": [
        26389,
        26412
      ]
    },
    {
      "content": "Copy application code and configuration files from the downloaded application that you worked with in the previous section of the tutorial.",
      "pos": [
        26415,
        26554
      ]
    },
    {
      "content": "Review the parts of the code that work with Azure blobs and queues and the WebJobs SDK.",
      "pos": [
        26557,
        26644
      ]
    },
    {
      "content": "Create a Visual Studio solution with a web project and class library project",
      "pos": [
        26651,
        26727
      ]
    },
    {
      "pos": [
        26732,
        26802
      ],
      "content": "In Visual Studio, choose <bpt id=\"p1\">**</bpt>New<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>Project<ept id=\"p2\">**</ept> from the <bpt id=\"p3\">**</bpt>File<ept id=\"p3\">**</ept> menu."
    },
    {
      "pos": [
        26807,
        26899
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>New Project<ept id=\"p1\">**</ept> dialog, choose <bpt id=\"p2\">**</bpt>Visual C#<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">**</bpt>Web<ept id=\"p3\">**</ept> &gt; <bpt id=\"p4\">**</bpt>ASP.NET Web Application<ept id=\"p4\">**</ept>."
    },
    {
      "pos": [
        26904,
        27092
      ],
      "content": "Name the project ContosoAdsWeb, name the solution ContosoAdsWebJobsSDK (change the solution name if you're putting it in the same folder as the downloaded solution), and then click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>."
    },
    {
      "content": "New Project",
      "pos": [
        27100,
        27111
      ]
    },
    {
      "pos": [
        27183,
        27319
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>New ASP.NET Project<ept id=\"p1\">**</ept> dialog, choose the MVC template, and clear the <bpt id=\"p2\">**</bpt>Host in the cloud<ept id=\"p2\">**</ept> check box under <bpt id=\"p3\">**</bpt>Microsoft Azure<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Selecting <bpt id=\"p1\">**</bpt>Host in the cloud<ept id=\"p1\">**</ept> enables Visual Studio to automatically create a new Azure web app and SQL Database.",
      "pos": [
        27325,
        27440
      ]
    },
    {
      "content": "Since you already created these earlier, you don't need to do so now while creating the project.",
      "pos": [
        27441,
        27537
      ]
    },
    {
      "content": "If you want to create a new one, select the check box.",
      "pos": [
        27538,
        27592
      ]
    },
    {
      "content": "You can then configure the new web app and SQL database the same way you did earlier when you were deploying the application.",
      "pos": [
        27593,
        27718
      ]
    },
    {
      "pos": [
        27723,
        27755
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Change Authentication<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Change Authentication",
      "pos": [
        27763,
        27784
      ]
    },
    {
      "pos": [
        27854,
        27947
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Change Authentication<ept id=\"p1\">**</ept> dialog, choose <bpt id=\"p2\">**</bpt>No Authentication<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>OK<ept id=\"p3\">**</ept>."
    },
    {
      "content": "No Authentication",
      "pos": [
        27955,
        27972
      ]
    },
    {
      "pos": [
        28042,
        28094
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>New ASP.NET Project<ept id=\"p1\">**</ept> dialog, click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Visual Studio creates the solution and the web project.",
      "pos": [
        28101,
        28156
      ]
    },
    {
      "pos": [
        28161,
        28268
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, right-click the solution (not the project), and choose <bpt id=\"p2\">**</bpt>Add<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">**</bpt>New Project<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        28274,
        28381
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Add New Project<ept id=\"p1\">**</ept> dialog, choose <bpt id=\"p2\">**</bpt>Visual C#<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">**</bpt>Windows Desktop<ept id=\"p3\">**</ept> &gt; <bpt id=\"p4\">**</bpt>Class Library<ept id=\"p4\">**</ept> template."
    },
    {
      "pos": [
        28389,
        28448
      ],
      "content": "Name the project <bpt id=\"p1\">*</bpt>ContosoAdsCommon<ept id=\"p1\">*</ept>, and then click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>."
    },
    {
      "content": "This project will contain the Entity Framework context and the data model which both the frontend and backend will use.",
      "pos": [
        28454,
        28573
      ]
    },
    {
      "content": "As an alternative you could define the EF-related classes in the web project and reference that project from the WebJob project.",
      "pos": [
        28574,
        28702
      ]
    },
    {
      "content": "But then your WebJob project would have a reference to web assemblies which it doesn't need.",
      "pos": [
        28703,
        28795
      ]
    },
    {
      "content": "Add a Console Application project that has WebJobs deployment enabled",
      "pos": [
        28801,
        28870
      ]
    },
    {
      "pos": [
        28876,
        29007
      ],
      "content": "Right-click the web project (not the solution or the class library project), and then click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>New Azure WebJob Project<ept id=\"p2\">**</ept>."
    },
    {
      "content": "New Azure WebJob Project menu selection",
      "pos": [
        29015,
        29054
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Add Azure WebJob<ept id=\"p1\">**</ept> dialog, enter ContosoAdsWebJob as both the <bpt id=\"p2\">**</bpt>Project name<ept id=\"p2\">**</ept> and the <bpt id=\"p3\">**</bpt>WebJob name<ept id=\"p3\">**</ept>.",
      "pos": [
        29122,
        29234
      ]
    },
    {
      "content": "Leave <bpt id=\"p1\">**</bpt>WebJob run mode<ept id=\"p1\">**</ept> set to <bpt id=\"p2\">**</bpt>Run Continuously<ept id=\"p2\">**</ept>.",
      "pos": [
        29235,
        29289
      ]
    },
    {
      "pos": [
        29295,
        29308
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Visual Studio creates a Console application that is configured to deploy as a WebJob whenever you deploy the web project.",
      "pos": [
        29316,
        29437
      ]
    },
    {
      "content": "To do that it performed the following tasks after creating the project:",
      "pos": [
        29438,
        29509
      ]
    },
    {
      "pos": [
        29517,
        29601
      ],
      "content": "Added a <bpt id=\"p1\">*</bpt>webjob-publish-settings.json<ept id=\"p1\">*</ept> file in the WebJob project Properties folder."
    },
    {
      "pos": [
        29608,
        29678
      ],
      "content": "Added a <bpt id=\"p1\">*</bpt>webjobs-list.json<ept id=\"p1\">*</ept> file in the web project Properties folder."
    },
    {
      "content": "Installed the Microsoft.Web.WebJobs.Publish NuGet package in the WebJob project.",
      "pos": [
        29685,
        29765
      ]
    },
    {
      "pos": [
        29776,
        29904
      ],
      "content": "For more information about these changes, see <bpt id=\"p1\">[</bpt>How to Deploy WebJobs by using Visual Studio<ept id=\"p1\">](websites-dotnet-deploy-webjobs.md)</ept>."
    },
    {
      "content": "Add NuGet packages",
      "pos": [
        29910,
        29928
      ]
    },
    {
      "pos": [
        29930,
        30131
      ],
      "content": "The new-project template for a WebJob project automatically installs the WebJobs SDK NuGet package <bpt id=\"p1\">[</bpt>Microsoft.Azure.WebJobs<ept id=\"p1\">](http://www.nuget.org/packages/Microsoft.Azure.WebJobs)</ept> and its dependencies."
    },
    {
      "content": "One of the WebJobs SDK dependencies that is installed automatically in the WebJob project is the Azure Storage Client Library (SCL).",
      "pos": [
        30134,
        30266
      ]
    },
    {
      "content": "However, you need to add it to the web project to work with blobs and queues.",
      "pos": [
        30267,
        30344
      ]
    },
    {
      "pos": [
        30350,
        30409
      ],
      "content": "Open the <bpt id=\"p1\">**</bpt>Manage NuGet Packages<ept id=\"p1\">**</ept> dialog for the solution."
    },
    {
      "pos": [
        30415,
        30463
      ],
      "content": "In the left pane, select <bpt id=\"p1\">**</bpt>Installed packages<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        30472,
        30532
      ],
      "content": "Find the <bpt id=\"p1\">*</bpt>Azure Storage<ept id=\"p1\">*</ept> package, and then click <bpt id=\"p2\">**</bpt>Manage<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        30538,
        30632
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Select Projects<ept id=\"p1\">**</ept> box, select the <bpt id=\"p2\">**</bpt>ContosoAdsWeb<ept id=\"p2\">**</ept> check box, and then click <bpt id=\"p3\">**</bpt>OK<ept id=\"p3\">**</ept>."
    },
    {
      "content": "All three projects use the Entity Framework to work with data in SQL Database.",
      "pos": [
        30635,
        30713
      ]
    },
    {
      "pos": [
        30719,
        30755
      ],
      "content": "In the left pane, select <bpt id=\"p1\">**</bpt>Online<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        30764,
        30843
      ],
      "content": "Find the <bpt id=\"p1\">*</bpt>EntityFramework<ept id=\"p1\">*</ept> NuGet package, and install it in all three projects."
    },
    {
      "content": "Set project references",
      "pos": [
        30850,
        30872
      ]
    },
    {
      "content": "Both web and WebJob projects will work with the SQL database, so both need a reference to the ContosoAdsCommon project.",
      "pos": [
        30874,
        30993
      ]
    },
    {
      "content": "In the ContosoAdsWeb project, set a reference to the ContosoAdsCommon project.",
      "pos": [
        30999,
        31077
      ]
    },
    {
      "content": "(Right-click the ContosoAdsWeb project, and then click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>Reference<ept id=\"p2\">**</ept>.",
      "pos": [
        31078,
        31157
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Reference Manager<ept id=\"p1\">**</ept> dialog box, select <bpt id=\"p2\">**</bpt>Solution<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">**</bpt>Projects<ept id=\"p3\">**</ept> &gt; <bpt id=\"p4\">**</bpt>ContosoAdsCommon<ept id=\"p4\">**</ept>, and then click <bpt id=\"p5\">**</bpt>OK<ept id=\"p5\">**</ept>.)",
      "pos": [
        31158,
        31281
      ]
    },
    {
      "content": "In the ContosoAdsWebJob project, set a reference to the ContosAdsCommon project.",
      "pos": [
        31287,
        31367
      ]
    },
    {
      "content": "The WebJob project needs references for working with images and for accessing connection strings.",
      "pos": [
        31369,
        31466
      ]
    },
    {
      "pos": [
        31472,
        31568
      ],
      "content": "In the ContosoAdsWebJob project, set a reference to <ph id=\"ph1\">`System.Drawing`</ph> and <ph id=\"ph2\">`System.Configuration`</ph>."
    },
    {
      "content": "Add code and configuration files",
      "pos": [
        31574,
        31606
      ]
    },
    {
      "content": "This tutorial does not show how to <bpt id=\"p1\">[</bpt>create MVC controllers and views using scaffolding<ept id=\"p1\">](http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started)</ept>, how to <bpt id=\"p2\">[</bpt>write Entity Framework code that works with SQL Server databases<ept id=\"p2\">](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc)</ept>, or <bpt id=\"p3\">[</bpt>the basics of asynchronous programming in ASP.NET 4.5<ept id=\"p3\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/web-development-best-practices#async)</ept>.",
      "pos": [
        31608,
        32126
      ]
    },
    {
      "content": "So all that remains to do is copy code and configuration files from the downloaded solution into the new solution.",
      "pos": [
        32127,
        32241
      ]
    },
    {
      "content": "After you do that, the following sections will show and explain key parts of the code.",
      "pos": [
        32242,
        32328
      ]
    },
    {
      "content": "To add files to a project or a folder, right-click the project or folder and click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>Existing Item<ept id=\"p2\">**</ept>.",
      "pos": [
        32330,
        32441
      ]
    },
    {
      "content": "Select the files you want and click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept>.",
      "pos": [
        32442,
        32486
      ]
    },
    {
      "content": "If asked whether you want to replace existing files, click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept>.",
      "pos": [
        32487,
        32554
      ]
    },
    {
      "pos": [
        32559,
        32689
      ],
      "content": "In the ContosoAdsCommon project, delete the <bpt id=\"p1\">*</bpt>Class1.cs<ept id=\"p1\">*</ept> file and add in its place the following files from the downloaded project."
    },
    {
      "content": "Ad.cs",
      "pos": [
        32698,
        32703
      ]
    },
    {
      "content": "ContosoAdscontext.cs",
      "pos": [
        32712,
        32732
      ]
    },
    {
      "content": "<bpt id=\"p1\">*</bpt>BlobInformation.cs<ept id=\"p1\">*</ept>",
      "pos": [
        32740,
        32760
      ]
    },
    {
      "content": "In the ContosoAdsWeb project, add the following files from the downloaded project.",
      "pos": [
        32775,
        32857
      ]
    },
    {
      "content": "Web.config",
      "pos": [
        32866,
        32876
      ]
    },
    {
      "content": "Global.asax.cs",
      "pos": [
        32885,
        32899
      ]
    },
    {
      "pos": [
        32909,
        32955
      ],
      "content": "In the <bpt id=\"p1\">*</bpt>Controllers<ept id=\"p1\">*</ept> folder: <bpt id=\"p2\">*</bpt>AdController.cs<ept id=\"p2\">*</ept>"
    },
    {
      "pos": [
        32963,
        33022
      ],
      "content": "In the <bpt id=\"p1\">*</bpt>Views\\Shared<ept id=\"p1\">*</ept> folder: <ph id=\"ph1\">&lt;em&gt;</ph>_Layout.cshtml<ph id=\"ph2\">&lt;/em&gt;</ph> file."
    },
    {
      "pos": [
        33030,
        33073
      ],
      "content": "In the <bpt id=\"p1\">*</bpt>Views\\Home<ept id=\"p1\">*</ept> folder: <bpt id=\"p2\">*</bpt>Index.cshtml<ept id=\"p2\">*</ept>."
    },
    {
      "content": "In the <bpt id=\"p1\">*</bpt>Views\\Ad<ept id=\"p1\">*</ept> folder (create the folder first): five <bpt id=\"p2\">*</bpt>.cshtml<ept id=\"p2\">*</ept> files.",
      "pos": [
        33081,
        33154
      ]
    },
    {
      "content": "In the ContosoAdsWebJob project, add the following files from the downloaded project.",
      "pos": [
        33169,
        33254
      ]
    },
    {
      "pos": [
        33262,
        33321
      ],
      "content": "<bpt id=\"p1\">*</bpt>App.config<ept id=\"p1\">*</ept> (change the file type filter to <bpt id=\"p2\">**</bpt>All Files<ept id=\"p2\">**</ept>)"
    },
    {
      "content": "Program.cs",
      "pos": [
        33329,
        33339
      ]
    },
    {
      "content": "Functions.cs",
      "pos": [
        33348,
        33360
      ]
    },
    {
      "content": "You can now build, run, and deploy the application as instructed earlier in the tutorial.",
      "pos": [
        33363,
        33452
      ]
    },
    {
      "content": "Before you do that, however, stop the WebJob that is still running in the first web app you deployed to.",
      "pos": [
        33453,
        33557
      ]
    },
    {
      "content": "Otherwise that WebJob will process queue messages created locally or by the app running in a new web app, since all are using the same storage account.",
      "pos": [
        33558,
        33709
      ]
    },
    {
      "pos": [
        33714,
        33758
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"code\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Review the application code"
    },
    {
      "content": "The following sections explain the code related to working with the WebJobs SDK and Azure Storage blobs and queues.",
      "pos": [
        33760,
        33875
      ]
    },
    {
      "pos": [
        33880,
        33979
      ],
      "content": "<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  For the code specific to the WebJobs SDK, see <bpt id=\"p2\">[</bpt>Program.cs and Functions.cs<ept id=\"p2\">](#programcs)</ept>."
    },
    {
      "content": "ContosoAdsCommon - Ad.cs",
      "pos": [
        33985,
        34009
      ]
    },
    {
      "content": "The Ad.cs file defines an enum for ad categories and a POCO entity class for ad information.",
      "pos": [
        34011,
        34103
      ]
    },
    {
      "content": "ContosoAdsCommon - ContosoAdsContext.cs",
      "pos": [
        35222,
        35261
      ]
    },
    {
      "content": "The ContosoAdsContext class specifies that the Ad class is used in a DbSet collection, which Entity Framework will store in a SQL database.",
      "pos": [
        35263,
        35402
      ]
    },
    {
      "content": "The class has two constructors.",
      "pos": [
        35762,
        35793
      ]
    },
    {
      "content": "The first of them is used by the web project, and specifies the name of a connection string that is stored in the Web.config file or the Azure runtime environment.",
      "pos": [
        35794,
        35957
      ]
    },
    {
      "content": "The second constructor enables you to pass in the actual connection string.",
      "pos": [
        35958,
        36033
      ]
    },
    {
      "content": "That is needed by the WebJob project, since it doesn't have a Web.config file.",
      "pos": [
        36034,
        36112
      ]
    },
    {
      "content": "You saw earlier where this connection string was stored, and you'll see later how the code retrieves the connection string when it instantiates the DbContext class.",
      "pos": [
        36113,
        36277
      ]
    },
    {
      "content": "ContosoAdsCommon - BlobInformation.cs",
      "pos": [
        36283,
        36320
      ]
    },
    {
      "pos": [
        36322,
        36418
      ],
      "content": "The <ph id=\"ph1\">`BlobInformation`</ph> class is used to store information about an image blob in a queue message."
    },
    {
      "content": "ContosoAdsWeb - Global.asax.cs",
      "pos": [
        36982,
        37012
      ]
    },
    {
      "content": "Code that is called from the <ph id=\"ph1\">`Application_Start`</ph> method creates an <bpt id=\"p1\">*</bpt>images<ept id=\"p1\">*</ept> blob container and an <bpt id=\"p2\">*</bpt>images<ept id=\"p2\">*</ept> queue if they don't already exist.",
      "pos": [
        37014,
        37155
      ]
    },
    {
      "content": "This ensures that whenever you start using a new storage account, the required blob container and queue will be created automatically.",
      "pos": [
        37156,
        37290
      ]
    },
    {
      "pos": [
        37292,
        37431
      ],
      "content": "The code gets access to the storage account by using the storage connection string from the <bpt id=\"p1\">*</bpt>Web.config<ept id=\"p1\">*</ept> file or Azure runtime environment."
    },
    {
      "content": "Then it gets a reference to the <bpt id=\"p1\">*</bpt>images<ept id=\"p1\">*</ept> blob container, creates the container if it doesn't already exist, and sets access permissions on the new container.",
      "pos": [
        37577,
        37734
      ]
    },
    {
      "content": "By default new containers allow only clients with storage account credentials to access blobs.",
      "pos": [
        37735,
        37829
      ]
    },
    {
      "content": "The web app needs the blobs to be public so that it can display images using URLs that point to the image blobs.",
      "pos": [
        37830,
        37942
      ]
    },
    {
      "content": "Similar code gets a reference to the <bpt id=\"p1\">*</bpt>blobnamerequest<ept id=\"p1\">*</ept> queue and creates a new queue.",
      "pos": [
        38362,
        38447
      ]
    },
    {
      "content": "In this case no permissions change is needed.",
      "pos": [
        38448,
        38493
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>ResolveBlobName<ept id=\"p1\">](#resolveblobname)</ept> section later in the tutorial explains why the queue that the web application writes to is used just for getting blob names and not for generating thumbnails.",
      "pos": [
        38494,
        38692
      ]
    },
    {
      "content": "ContosoAdsWeb - _Layout.cshtml",
      "pos": [
        38896,
        38926
      ]
    },
    {
      "pos": [
        38928,
        39030
      ],
      "content": "The <bpt id=\"p1\">*</bpt>_Layout.cshtml<ept id=\"p1\">*</ept> file sets the app name in the header and footer, and creates an \"Ads\" menu entry."
    },
    {
      "content": "ContosoAdsWeb - Views\\Home\\Index.cshtml",
      "pos": [
        39036,
        39075
      ]
    },
    {
      "content": "The <bpt id=\"p1\">*</bpt>Views\\Home\\Index.cshtml<ept id=\"p1\">*</ept> file displays category links on the home page.",
      "pos": [
        39077,
        39153
      ]
    },
    {
      "content": "The links pass the integer value of the <ph id=\"ph1\">`Category`</ph> enum in a querystring variable to the Ads Index page.",
      "pos": [
        39154,
        39258
      ]
    },
    {
      "content": "ContosoAdsWeb - AdController.cs",
      "pos": [
        39667,
        39698
      ]
    },
    {
      "pos": [
        39700,
        39884
      ],
      "content": "In the <bpt id=\"p1\">*</bpt>AdController.cs<ept id=\"p1\">*</ept> file the constructor calls the <ph id=\"ph1\">`InitializeStorage`</ph> method to create Azure Storage Client Library objects that provide an API for working with blobs and queues."
    },
    {
      "content": "Then the code gets a reference to the <bpt id=\"p1\">*</bpt>images<ept id=\"p1\">*</ept> blob container as you saw earlier in <bpt id=\"p2\">*</bpt>Global.asax.cs<ept id=\"p2\">*</ept>.",
      "pos": [
        39887,
        39988
      ]
    },
    {
      "content": "While doing that it sets a default <bpt id=\"p1\">[</bpt>retry policy<ept id=\"p1\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/transient-fault-handling)</ept> appropriate for a web app.",
      "pos": [
        39989,
        40211
      ]
    },
    {
      "content": "The default exponential backoff retry policy could hang the web app for longer than a minute on repeated retries for a transient fault.",
      "pos": [
        40212,
        40347
      ]
    },
    {
      "content": "The retry policy specified here waits 3 seconds after each try for up to 3 tries.",
      "pos": [
        40348,
        40429
      ]
    },
    {
      "pos": [
        40671,
        40723
      ],
      "content": "Similar code gets a reference to the <bpt id=\"p1\">*</bpt>images<ept id=\"p1\">*</ept> queue."
    },
    {
      "content": "Most of the controller code is typical for working with an Entity Framework data model using a DbContext class.",
      "pos": [
        40979,
        41090
      ]
    },
    {
      "content": "An exception is the HttpPost <ph id=\"ph1\">`Create`</ph> method, which uploads a file and saves it in blob storage.",
      "pos": [
        41091,
        41187
      ]
    },
    {
      "content": "The model binder provides an <bpt id=\"p1\">[</bpt>HttpPostedFileBase<ept id=\"p1\">](http://msdn.microsoft.com/library/system.web.httppostedfilebase.aspx)</ept> object to the method.",
      "pos": [
        41188,
        41329
      ]
    },
    {
      "content": "If the user selected a file to upload, the code uploads the file, saves it in a blob, and updates the Ad database record with a URL that points to the blob.",
      "pos": [
        41554,
        41710
      ]
    },
    {
      "content": "The code that does the upload is in the <ph id=\"ph1\">`UploadAndSaveBlobAsync`</ph> method.",
      "pos": [
        41903,
        41975
      ]
    },
    {
      "content": "It creates a GUID name for the blob, uploads and saves the file, and returns a reference to the saved blob.",
      "pos": [
        41976,
        42083
      ]
    },
    {
      "pos": [
        42575,
        42762
      ],
      "content": "After the HttpPost <ph id=\"ph1\">`Create`</ph> method uploads a blob and updates the database, it creates a queue message to inform the back-end process that an image is ready for conversion to a thumbnail."
    },
    {
      "pos": [
        43030,
        43187
      ],
      "content": "The code for the HttpPost <ph id=\"ph1\">`Edit`</ph> method is similar except that if the user selects a new image file any blobs that already exist for this ad must be deleted."
    },
    {
      "content": "Here is the code that deletes blobs when you delete an ad:",
      "pos": [
        43433,
        43491
      ]
    },
    {
      "content": "ContosoAdsWeb - Views\\Ad\\Index.cshtml and Details.cshtml",
      "pos": [
        44257,
        44313
      ]
    },
    {
      "pos": [
        44315,
        44382
      ],
      "content": "The <bpt id=\"p1\">*</bpt>Index.cshtml<ept id=\"p1\">*</ept> file displays thumbnails with the other ad data:"
    },
    {
      "pos": [
        44437,
        44492
      ],
      "content": "The <bpt id=\"p1\">*</bpt>Details.cshtml<ept id=\"p1\">*</ept> file displays the full-size image:"
    },
    {
      "content": "ContosoAdsWeb - Views\\Ad\\Create.cshtml and Edit.cshtml",
      "pos": [
        44547,
        44601
      ]
    },
    {
      "pos": [
        44603,
        44736
      ],
      "content": "The <bpt id=\"p1\">*</bpt>Create.cshtml<ept id=\"p1\">*</ept> and <bpt id=\"p2\">*</bpt>Edit.cshtml<ept id=\"p2\">*</ept> files specify form encoding that enables the controller to get the <ph id=\"ph1\">`HttpPostedFileBase`</ph> object."
    },
    {
      "pos": [
        44845,
        44919
      ],
      "content": "An <ph id=\"ph1\">`&lt;input&gt;`</ph> element tells the browser to provide a file selection dialog."
    },
    {
      "pos": [
        45022,
        45073
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"programcs\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>ContosoAdsWebJob - Program.cs"
    },
    {
      "pos": [
        45075,
        45232
      ],
      "content": "When the WebJob starts, the <ph id=\"ph1\">`Main`</ph> method calls the WebJobs SDK <ph id=\"ph2\">`JobHost.RunAndBlock`</ph> method to begin execution of triggered functions on the current thread."
    },
    {
      "pos": [
        45373,
        45461
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"generatethumbnail\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>ContosoAdsWebJob - Functions.cs - GenerateThumbnail method"
    },
    {
      "content": "The WebJobs SDK calls this method when a queue message is received.",
      "pos": [
        45463,
        45530
      ]
    },
    {
      "content": "The method creates a thumbnail and puts the thumbnail URL in the database.",
      "pos": [
        45531,
        45605
      ]
    },
    {
      "pos": [
        46724,
        46858
      ],
      "content": "The <ph id=\"ph1\">`QueueTrigger`</ph> attribute directs the WebJobs SDK to call this method when a new message is received on the thumbnailrequest queue."
    },
    {
      "content": "The <ph id=\"ph1\">`BlobInformation`</ph> object in the queue message is automatically deserialized into the <ph id=\"ph2\">`blobInfo`</ph> parameter.",
      "pos": [
        46934,
        47044
      ]
    },
    {
      "content": "When the method completes, the queue message is deleted.",
      "pos": [
        47045,
        47101
      ]
    },
    {
      "content": "If the method fails before completing, the queue message is not deleted; after a 10-minute lease expires, the message is released to be picked up again and processed.",
      "pos": [
        47102,
        47268
      ]
    },
    {
      "content": "This sequence won't be repeated indefinitely if a message always causes an exception.",
      "pos": [
        47269,
        47354
      ]
    },
    {
      "content": "After 5 unsuccessful attempts to process a message, the message is moved to a queue named {queuename}-poison.",
      "pos": [
        47355,
        47464
      ]
    },
    {
      "content": "The maximum number of attempts is configurable.",
      "pos": [
        47465,
        47512
      ]
    },
    {
      "pos": [
        47517,
        47671
      ],
      "content": "The two <ph id=\"ph1\">`Blob`</ph> attributes provide objects that are bound to blobs: one to the existing image blob and one to a new thumbnail blob that the method creates."
    },
    {
      "content": "Blob names come from properties of the <ph id=\"ph1\">`BlobInformation`</ph> object received in the queue message (<ph id=\"ph2\">`BlobName`</ph> and <ph id=\"ph3\">`BlobNameWithoutExtension`</ph>).",
      "pos": [
        47839,
        47977
      ]
    },
    {
      "content": "To get the full functionality of the Storage Client Library you can use the <ph id=\"ph1\">`CloudBlockBlob`</ph> class to work with blobs.",
      "pos": [
        47978,
        48096
      ]
    },
    {
      "content": "If you want to reuse code that was written to work with <ph id=\"ph1\">`Stream`</ph> objects, you can use the <ph id=\"ph2\">`Stream`</ph> class.",
      "pos": [
        48097,
        48202
      ]
    },
    {
      "content": "For more information about how to write functions that use  WebJobs SDK attributes, see the following resources:",
      "pos": [
        48205,
        48317
      ]
    },
    {
      "content": "How to use Azure queue storage with the WebJobs SDK",
      "pos": [
        48322,
        48373
      ]
    },
    {
      "content": "How to use Azure blob storage with the WebJobs SDK",
      "pos": [
        48432,
        48482
      ]
    },
    {
      "content": "How to use Azure table storage with the WebJobs SDK",
      "pos": [
        48540,
        48591
      ]
    },
    {
      "content": "How to use Azure Service Bus with the WebJobs SDK",
      "pos": [
        48650,
        48699
      ]
    },
    {
      "content": "If your web app runs on multiple VMs, multiple WebJobs will be running simultaneously, and in some scenarios this can result in the same data getting processed multiple times.",
      "pos": [
        48768,
        48943
      ]
    },
    {
      "content": "This is not a problem if you use the built-in queue, blob, and Service Bus triggers.",
      "pos": [
        48944,
        49028
      ]
    },
    {
      "content": "The SDK ensures that your functions will be processed only once for each message or blob.",
      "pos": [
        49029,
        49118
      ]
    },
    {
      "pos": [
        49125,
        49270
      ],
      "content": "For information about how to implement graceful shutdown, see <bpt id=\"p1\">[</bpt>Graceful Shutdown<ept id=\"p1\">](websites-dotnet-webjobs-sdk-storage-queues-how-to.md#graceful)</ept>."
    },
    {
      "content": "The code in the <ph id=\"ph1\">`ConvertImageToThumbnailJPG`</ph> method (not shown) uses classes in the <ph id=\"ph2\">`System.Drawing`</ph> namespace for simplicity.",
      "pos": [
        49280,
        49406
      ]
    },
    {
      "content": "However, the classes in this namespace were designed for use with Windows Forms.",
      "pos": [
        49407,
        49487
      ]
    },
    {
      "content": "They are not supported for use in a Windows or ASP.NET service.",
      "pos": [
        49488,
        49551
      ]
    },
    {
      "content": "For more information about image processing options, see <bpt id=\"p1\">[</bpt>Dynamic Image Generation<ept id=\"p1\">](http://www.hanselman.com/blog/BackToBasicsDynamicImageGenerationASPNETControllersRoutingIHttpHandlersAndRunAllManagedModulesForAllRequests.aspx)</ept> and <bpt id=\"p2\">[</bpt>Deep Inside Image Resizing<ept id=\"p2\">](http://www.hanselminutes.com/313/deep-inside-image-resizing-and-scaling-with-aspnet-and-iis-with-imageresizingnet-author-na)</ept>.",
      "pos": [
        49552,
        49939
      ]
    },
    {
      "content": "WebJobs SDK versus Cloud Service worker role without WebJobs SDK",
      "pos": [
        49945,
        50009
      ]
    },
    {
      "content": "If you compare the amount of code in the <ph id=\"ph1\">`GenerateThumbnails`</ph> method in this sample application with the worker role code in the <bpt id=\"p1\">[</bpt>Cloud Service version of the application<ept id=\"p1\">](../cloud-services-dotnet-get-started.md)</ept>, you can see how much work the WebJobs SDK is doing for you.",
      "pos": [
        50011,
        50284
      ]
    },
    {
      "content": "The advantage is greater than it appears, because the Cloud Service sample application code doesn't do all of the things (such as poison message handling) that you would do in a production application, and which the WebJobs SDK does for you.",
      "pos": [
        50285,
        50526
      ]
    },
    {
      "content": "In the Cloud Service version of the application, the record ID is the only information in the queue message, and the background process gets the image URL from the database.",
      "pos": [
        50528,
        50701
      ]
    },
    {
      "content": "In the WebJobs SDK version of the application, the queue message includes the image URL so that it can be provided to the <ph id=\"ph1\">`Blob`</ph> attributes.",
      "pos": [
        50702,
        50842
      ]
    },
    {
      "content": "If the queue message didn't have the blob URL, you could <bpt id=\"p1\">[</bpt>use the Blob attribute in the body of the method instead of in the method signature<ept id=\"p1\">](websites-dotnet-webjobs-sdk-storage-queues-how-to.md#blobbody)</ept>.",
      "pos": [
        50843,
        51049
      ]
    },
    {
      "content": "Using the WebJobs SDK outside of WebJobs",
      "pos": [
        51055,
        51095
      ]
    },
    {
      "content": "A program that uses the WebJobs SDK doesn't have to run in Azure in a WebJob.",
      "pos": [
        51097,
        51174
      ]
    },
    {
      "content": "It can run locally, and it can also run in other environments such as a Cloud Service worker role or a Windows service.",
      "pos": [
        51175,
        51294
      ]
    },
    {
      "content": "However, you can only access the WebJobs SDK dashboard through an Azure web app.",
      "pos": [
        51295,
        51375
      ]
    },
    {
      "content": "To use the dashboard you have to connect the web app to the storage account you're using by setting the AzureWebJobsDashboard connection string on the <bpt id=\"p1\">**</bpt>Configure<ept id=\"p1\">**</ept> tab of the Azure portal.",
      "pos": [
        51376,
        51565
      ]
    },
    {
      "content": "Then you can get to the Dashboard by using the following URL:",
      "pos": [
        51566,
        51627
      ]
    },
    {
      "content": "https://{webappname}.scm.azurewebsites.net/azurejobs/#/functions",
      "pos": [
        51629,
        51693
      ]
    },
    {
      "pos": [
        51695,
        51960
      ],
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Getting a dashboard for local development with the WebJobs SDK<ept id=\"p1\">](http://blogs.msdn.com/b/jmstall/archive/2014/01/27/getting-a-dashboard-for-local-development-with-the-webjobs-sdk.aspx)</ept>, but note that it shows an old connection string name."
    },
    {
      "content": "Next steps",
      "pos": [
        51966,
        51976
      ]
    },
    {
      "content": "In this tutorial you've seen a simple multi-tier application that uses the WebJobs SDK for backend processing.",
      "pos": [
        51978,
        52088
      ]
    },
    {
      "content": "The application has been kept simple for a getting-started tutorial.",
      "pos": [
        52089,
        52157
      ]
    },
    {
      "content": "For example, it doesn't implement <bpt id=\"p1\">[</bpt>dependency injection<ept id=\"p1\">](http://www.asp.net/mvc/tutorials/hands-on-labs/aspnet-mvc-4-dependency-injection)</ept> or the <bpt id=\"p2\">[</bpt>repository and unit of work patterns<ept id=\"p2\">](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/advanced-entity-framework-scenarios-for-an-mvc-web-application#repo)</ept>, it doesn't <bpt id=\"p3\">[</bpt>use an interface for logging<ept id=\"p3\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry#log)</ept>, it doesn't use <bpt id=\"p4\">[</bpt>EF Code First Migrations<ept id=\"p4\">](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application)</ept> to manage data model changes or <bpt id=\"p5\">[</bpt>EF Connection Resiliency<ept id=\"p5\">](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application)</ept> to manage transient network errors, and so forth.",
      "pos": [
        52158,
        53144
      ]
    },
    {
      "pos": [
        53146,
        53258
      ],
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Azure Web Jobs Recommended Resources<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=390226)</ept>."
    },
    {
      "content": "What's changed",
      "pos": [
        53263,
        53277
      ]
    },
    {
      "pos": [
        53280,
        53448
      ],
      "content": "For a guide to the change from Websites to App Service see: <bpt id=\"p1\">[</bpt>Azure App Service and Its Impact on Existing Azure Services<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=529714)</ept>"
    },
    {
      "pos": [
        53451,
        53622
      ],
      "content": "For a guide to the change of the Azure portal to the Azure preview portal see: <bpt id=\"p1\">[</bpt>Reference for navigating the preview portal<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=529715)</ept>"
    },
    {
      "content": "test",
      "pos": [
        53624,
        53628
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"Create a .NET WebJob in Azure App Service\" \n    description=\"Learn how to create a multi-tier app using ASP.NET MVC and Azure. The frontend runs in a web app in Azure App Service, and the backend runs as a WebJob. The app uses Entity Framework, SQL Database, and Azure storage queues and blobs.\" \n    services=\"app-service\\web\" \n    documentationCenter=\".net\" \n    authors=\"tdykstra\" \n    manager=\"wpickett\" \n    editor=\"mollybos\"/>\n\n<tags \n    ms.service=\"app-service-web\" \n    ms.workload=\"web\" \n    ms.tgt_pltfrm=\"na\" \n    ms.devlang=\"na\" \n    ms.topic=\"get-started-article\" \n    ms.date=\"06/29/2015\" \n    ms.author=\"tdykstra\"/>\n\n# Create a .NET WebJob in Azure App Service\n\n## Overview\n\nThis tutorial shows how to create a multi-tier ASP.NET MVC application that uses the WebJobs SDK to work with [Azure queues](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern) and [Azure blobs](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage) in a web app in [Azure App Service](http://go.microsoft.com/fwlink/?LinkId=529714). The application also uses [Azure SQL Database](http://msdn.microsoft.com/library/azure/ee336279). \n\nThe sample application is an advertising bulletin board. Users create an ad by entering text and uploading an image. They can see a list of ads with thumbnail images, and they can see the full size image when they select an ad to see the details. Here's a screenshot:\n\n![Ad list](./media/websites-dotnet-webjobs-sdk-get-started/list.png)\n\nYou can [download the Visual Studio project][download] from the MSDN Code Gallery. \n\n[download]: http://code.msdn.microsoft.com/Simple-Azure-Website-with-b4391eeb\n\n## <a id=\"prerequisites\"></a>Prerequisites\n\nThe tutorial assumes that you know how to work with [ASP.NET MVC](http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started) or [Web Forms](http://www.asp.net/web-forms/tutorials/aspnet-45/getting-started-with-aspnet-45-web-forms/introduction-and-overview) projects in Visual Studio. The sample application uses MVC, but most of the tutorial also applies to Web Forms. \n\nThe tutorial instructions work with the following products:\n\n* Visual Studio 2013\n* Visual Studio 2013 Community\n* Visual Studio 2013 Express for Web\n\nIf you don't have one of these, Visual Studio 2013 Express for Web will be installed automatically when you install the Azure SDK.\n\n[AZURE.INCLUDE [free-trial-note](../../includes/free-trial-note.md)]\n\n>[AZURE.NOTE] If you want to get started with Azure App Service before signing up for an Azure account, go to [Try App Service](http://go.microsoft.com/fwlink/?LinkId=523751), where you can immediately create a short-lived starter web app in App Service. No credit cards required; no commitments.\n\n## <a id=\"learn\"></a>What you'll learn\n\nThe tutorial shows how to do the following tasks:\n\n* Enable your machine for Azure development by installing the Azure SDK.\n* Create a Console Application project that automatically deploys as an Azure WebJob when you deploy the associated web project.\n* Test a WebJobs SDK backend locally on the development computer.\n* Publish an application with a WebJobs backend to a web app in App Service.\n* Upload files and store them in the Azure Blob service.\n* Use the Azure WebJobs SDK to work with Azure Storage queues and blobs.\n\n## <a id=\"contosoads\"></a>Application architecture\n\nThe sample application uses the [queue-centric work pattern](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern) to off-load the CPU-intensive work of creating thumbnails to a backend process. \n\nThe app stores ads in a SQL database, using Entity Framework Code First to create the tables and access the data. For each ad, the database stores two URLs: one for the full-size image and one for the thumbnail.\n\n![Ad table](./media/websites-dotnet-webjobs-sdk-get-started/adtable.png)\n\nWhen a user uploads an image, the frontend of the web app stores the image in an [Azure blob](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage), and it stores the ad information in the database with a URL that points to the blob. At the same time, it writes a message to an Azure queue. A backend process running as an Azure WebJob uses the WebJobs SDK to poll the queue for new messages. When a new message appears, the WebJob creates a thumbnail for that image and updates the thumbnail URL database field for that ad. Here's a diagram that shows how the parts of the application interact:\n\n![Contoso Ads architecture](./media/websites-dotnet-webjobs-sdk-get-started/apparchitecture.png)\n\n### Alternative architecture\n\nWebJobs run in the context of a web app and are not scalable separately. For example, if you have one Standard web app instance, you have only one instance of your background process running, and it is using some of the server resources (CPU, memory, etc.) that otherwise would be available to serve web content. \n\nIf traffic varies by time of day or day of week, and if the backend processing you need to do can wait, you could schedule your WebJobs to run at low-traffic times. If the load is still too high for that solution, you can consider alternative environments for your backend program, such as the following:\n\n* Run the program as a WebJob in a separate web app dedicated for that purpose. You can then scale your backend web app independently from your frontend web app.\n* Run the program in an Azure Cloud Service worker role. If you choose this option, you could run the frontend in either a Cloud Service web role or a web app.\n\nThis tutorial shows how to run the frontend in a web app and the backend as a WebJob in the same web app. For information about how to choose the best environment for your scenario, see [Azure web app, cloud services, and virtual machines comparison](../choose-web-site-cloud-service-vm/).\n\n[AZURE.INCLUDE [install-sdk-2013-only](../../includes/install-sdk-2013-only.md)]\n\nThe tutorial instructions apply to Azure SDK for .NET 2.5.1 or later. In the create-from-scratch section where you create the WebJob project, the WebJobs SDK packages are automatically included in the project; with earlier versions of the SDK you have to install the packages manually.\n\n## <a id=\"storage\"></a>Create an Azure Storage account\n\nAn Azure storage account provides resources for storing queue and blob data in the cloud. It is also used by the WebJobs SDK to store logging data for the dashboard.\n\nIn a real-world application, you typically create separate accounts for application data versus logging data, and separate accounts for test data versus production data. For this tutorial you'll use just one account.\n\n1. Open the **Server Explorer** window in Visual Studio.\n\n2. Right-click the **Azure** node, and then click **Connect to Microsoft Azure**.\n\n![Connect to Azure](./media/websites-dotnet-webjobs-sdk-get-started/connaz.png)\n\n3. Sign in using your Azure credentials.\n\n5. Right-click **Storage** under the Azure node, and then click **Create Storage Account**.\n\n![Create Storage Account](./media/websites-dotnet-webjobs-sdk-get-started/createstor.png)\n\n3. In the **Create Storage Account** dialog, enter a name for the storage account. \n\n    The name must be must be unique (no other Azure storage account can have the same name). If the name you enter is already in use you'll get a chance to change it.\n\n    The URL to access your storage account will be *{name}*.core.windows.net. \n\n5. Set the **Region or Affinity Group** drop-down list to the region closest to you.\n\n    This setting specifies which Azure datacenter will host your storage account. For this tutorial, your choice won't make a noticeable difference. However, for a production web app, you want your web server and your storage account to be in the same region to minimize latency and data egress charges. The web app (which you'll create later) datacenter should be as close as possible to the browsers accessing the web app in order to minimize latency.\n\n6. Set the **Replication** drop-down list to **Locally redundant**. \n\n    When geo-replication is enabled for a storage account, the stored content is replicated to a secondary datacenter to enable failover to that location in case of a major disaster in the primary location. Geo-replication can incur additional costs. For test and development accounts, you generally don't want to pay for geo-replication. For more information, see [Create, manage, or delete a storage account](../storage-create-storage-account/#replication-options).\n\n5. Click **Create**. \n\n    ![New storage account](./media/websites-dotnet-webjobs-sdk-get-started/newstorage.png)  \n\n## <a id=\"download\"></a>Download the application\n \n1. Download and unzip the [completed solution][download].\n\n2. Start Visual Studio.\n\n3. From the **File** menu choose **Open** > **Project/Solution**, navigate to where you downloaded the solution, and then open the solution file.\n\n3. Press CTRL+SHIFT+B to build the solution.\n\n    By default, Visual Studio automatically restores the NuGet package content, which was not included in the *.zip* file. If the packages don't restore, install them manually by going to the **Manage NuGet Packages for Solution** dialog and clicking the **Restore** button at the top right. \n\n3. In **Solution Explorer**, make sure that **ContosoAdsWeb** is selected as the startup project.\n\n## <a id=\"configurestorage\"></a>Configure the application to use your storage account\n\n2. Open the application *Web.config* file in the ContosoAdsWeb project.\n \n    The file contains a SQL connection string and an Azure storage connection string for working with blobs and queues. \n\n    The SQL connection string points to a [SQL Server Express LocalDB](http://msdn.microsoft.com/library/hh510202.aspx) database.\n \n    The storage connection string is an example that has placeholders for the storage account name and access key. You'll replace this with a connection string that has the name and key of your storage account.  \n\n    <pre class=\"prettyprint\">&lt;connectionStrings&gt;\n      &lt;add name=\"ContosoAdsContext\" connectionString=\"Data Source=(localdb)\\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;\" providerName=\"System.Data.SqlClient\" /&gt;\n      &lt;add name=\"AzureWebJobsStorage\" connectionString=\"DefaultEndpointsProtocol=https;AccountName=<mark>[accountname]</mark>;AccountKey=<mark>[accesskey]</mark>\"/&gt;\n    &lt;/connectionStrings&gt;</pre>\n\n    The storage connection string is named AzureWebJobsStorage because that's the name the WebJobs SDK uses by default. The same name is used here so you have to set only one connection string value in the Azure environment.\n \n2. In **Server Explorer**, right-click your storage account under the **Storage** node, and then click **Properties**.\n\n    ![Click Storage Account Properties](./media/websites-dotnet-webjobs-sdk-get-started/storppty.png)   \n\n4. In the **Properties** window, click **Storage Account Keys**, and then click the ellipsis.\n\n    ![New storage account](./media/websites-dotnet-webjobs-sdk-get-started/newstorage.png)  \n\n7. Copy the **Connection String**.\n\n    ![Storage Account Keys dialog](./media/websites-dotnet-webjobs-sdk-get-started/cpak.png)    \n\n8. Replace the storage connection string in the *Web.config* file with the connection string you just copied. Make sure you select everything inside the quotation marks but not including the quotation marks before pasting.\n\n4. Open the *App.config* file in the ContosoAdsWebJob project.\n\n    This file has two storage connection strings, one for application data and one for logging. For this tutorial you'll use the same account for both. The connection strings have placeholders for the storage account keys.\n    <pre class=\"prettyprint\">&lt;configuration&gt;\n    &lt;connectionStrings&gt;\n        &lt;add name=\"AzureWebJobsDashboard\" connectionString=\"DefaultEndpointsProtocol=https;AccountName=<mark>[accountname]</mark>;AccountKey=<mark>[accesskey]</mark>\"/&gt;\n        &lt;add name=\"AzureWebJobsStorage\" connectionString=\"DefaultEndpointsProtocol=https;AccountName=<mark>[accountname]</mark>;AccountKey=<mark>[accesskey]</mark>\"/&gt;\n        &lt;add name=\"ContosoAdsContext\" connectionString=\"Data Source=(localdb)\\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;\"/&gt;\n    &lt;/connectionStrings&gt;\n        &lt;startup&gt; \n            &lt;supportedRuntime version=\"v4.0\" sku=\".NETFramework,Version=v4.5\" /&gt;\n    &lt;/startup&gt;\n&lt;/configuration&gt;</pre>\n\n    By default, the WebJobs SDK looks for connection strings named AzureWebJobsStorage and AzureWebJobsDashboard. As an alternative, you can [store the connection string however you want and pass it in explicitly to the `JobHost` object](websites-dotnet-webjobs-sdk-storage-queues-how-to.md#config).\n\n1. Replace both storage connection strings with the connection string you copied earlier.\n\n5. Save your changes.\n\n## <a id=\"run\"></a>Run the application locally\n\n1. To start the web frontend of the application, press CTRL+F5. \n\n    The default browser opens to the home page. (The web project runs because you've made it the startup project.)\n\n    ![Contoso Ads home page](./media/websites-dotnet-webjobs-sdk-get-started/home.png)\n\n2. To start the WebJob backend of the application, right-click the ContosoAdsWebJob project in **Solution Explorer**, and then click **Debug** > **Start new instance**.\n\n    A console application window opens and displays logging messages indicating the WebJobs SDK JobHost object has started to run.\n\n    ![Console application window showing that the backend is running](./media/websites-dotnet-webjobs-sdk-get-started/backendrunning.png)\n\n2. In your browser, click  **Create an Ad**.\n\n2. Enter some test data and select an image to upload, and then click **Create**.\n\n    ![Create page](./media/websites-dotnet-webjobs-sdk-get-started/create.png)\n\n    The app goes to the Index page, but it doesn't show a thumbnail for the new ad because that processing hasn't happened yet.\n\n    Meanwhile, after a short wait a logging message in the console application window shows that a queue message was received and has been processed.   \n\n    ![Console application window showing that a queue message has been processed](./media/websites-dotnet-webjobs-sdk-get-started/backendlogs.png)\n\n3. After you see the logging messages in the console application window, refresh the Index page to see the thumbnail.\n\n    ![Index page](./media/websites-dotnet-webjobs-sdk-get-started/list.png)\n\n4. Click **Details** for your ad to see the full-size image.\n\n    ![Details page](./media/websites-dotnet-webjobs-sdk-get-started/details.png)\n\nYou've been running the application on your local computer, and it's using a SQL Server database located on your computer, but it's working with queues and blobs in the cloud. In the following section you'll run the application in the cloud, using a cloud database as well as cloud blobs and queues.  \n\n## <a id=\"runincloud\"></a>Run the application in the cloud\n\nYou'll do the following steps to run the application in the cloud:\n\n* Deploy to Web Apps. Visual Studio will automatically create a new web app in App Service and SQL Database instance.\n* Configure the web app to use your Azure SQL database and storage account.\n\nAfter you've created some ads while running in the cloud, you'll view the WebJobs SDK dashboard to see the rich monitoring features it has to offer.\n\n### Deploy to Web Apps\n\n1. Close the browser and the console application window.\n\n3. In **Solution Explorer**, right-click the ContosoAdsWeb project, and then click **Publish**.\n\n3. In the **Profile** step of the **Publish Web** wizard, click **Microsoft Azure web apps**.\n\n    ![Select Azure web app publish target](./media/websites-dotnet-webjobs-sdk-get-started/pubweb.png)  \n\n2. In the **Select existing web app** box, click **Sign In** and enter your credentials if you're not already signed in.\n \n5. After you're signed in, click **New**.\n\n    ![Click New](./media/websites-dotnet-webjobs-sdk-get-started/clicknew.png)\n\n9. In the **Create web app on Microsoft Azure** dialog box, enter a unique name in the **Web app name** box.\n\n    The complete URL will consist of what you enter here plus .azurewebsites.net (as shown next to the **Web app name** text box). For example, if the web app name is ContosoAds, the URL will be ContosoAds.azurewebsites.net.\n\n9. In the [App Service plan](../app-service/azure-web-sites-web-hosting-plans-in-depth-overview.md) drop-down list choose **Create new App Service plan**.\n\n11. Enter a name for the App Service plan, such as ContosoAdsPlan.\n\n9. In the [Resource group](../resource-group-overview.md) drop-down list choose **Create new resource group**.\n\n11. Enter a name for the resource group, such as ContosoAdsGroup.\n\n9. In the **Region** drop-down list choose the same region you chose for your storage account.\n\n    This setting specifies which Azure datacenter your web app will run in. Keeping the web app and storage account in the same datacenter minimizes latency and data egress charges.\n\n9. In the **Database server** drop-down list choose **Create new server**.\n\n    Alternatively, if your subscription already has a server, you can select that server from the drop-down list.\n\n1. Enter a name for the database server, such as ContosoAdsServer.\n\n1. Enter an administrator **Database username** and **Database password**. \n\n    If you selected **New SQL Database server** you aren't entering an existing name and password here, you're entering a new name and password that you're defining now to use later when you access the database. If you selected a server that you created previously, you'll be prompted for the password to the administrative user account you already created.\n\n1. Click **Create**.\n\n    ![Create web app on Microsoft Azure dialog](./media/websites-dotnet-webjobs-sdk-get-started/newdb.png)  \n\n    Visual Studio creates the solution, the web project, the web app in Azure, and the Azure SQL Database instance.\n\n2. In the **Connection** step of the **Publish Web** wizard, click **Next**.\n\n    ![Connection step](./media/websites-dotnet-webjobs-sdk-get-started/connstep.png)    \n\n3. In the **Settings** step, clear the **Use this connection string at runtime** check box, and then click **Next**.\n\n    ![Settings step](./media/websites-dotnet-webjobs-sdk-get-started/settingsstep.png)  \n    \n    You don't need to use the publish dialog to set the SQL connection string because you'll set that value in the Azure environment later.\n\n    You can ignore the warnings on this page. \n\n    * Normally the storage account you use when running in Azure would be different from the one you use when running locally, but for this tutorial you're using the same one in both environments. So the AzureWebJobsStorage connection string does not need to be transformed. Even if you did want to use a different storage account in the cloud, you wouldn't need to transform the connection string because the app will use an Azure environment setting when it runs in Azure. You'll see this later in the tutorial.\n\n    * For this tutorial you aren't going to be making changes to the data model used for the ContosoAdsContext database, so there is no need to use Entity Framework Code First Migrations for deployment. Code First will automatically create a new database the first time the app tries to access SQL data.\n\n    For this tutorial, the default values of the options under **File Publish Options** are fine. \n\n4. In the **Preview** step, click **Start Preview**.\n\n    ![Click Start Preview](./media/websites-dotnet-webjobs-sdk-get-started/previewstep.png) \n\n    You can ignore the warning about no databases being published. Entity Framework Code First will create the database; it doesn't need to be published.\n\n    the preview window shows that binaries and configuration files from the WebJob project will be copied to the *app_data\\jobs\\continuous* folder of the web app.\n\n    ![WebJobs files in preview window](./media/websites-dotnet-webjobs-sdk-get-started/previewwjfiles.png)  \n\n5. Click **Publish**.\n\n    Visual Studio deploys the application and opens the home page URL in the browser. \n\n    You won't be able to use the web app until you set connection strings in the Azure environment in the next section. You'll see either an error page or the home page depending on web app and database creation options you chose earlier. \n\n### Configure the web app to use your Azure SQL database and storage account.\n\nIt's a security best practice to [avoid putting sensitive information such as connection strings in files that are stored in source code repositories](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control#secrets). Azure provides a way to do that: you can set connection string and other setting values in the Azure environment, and ASP.NET configuration APIs automatically pick up these values when the app runs in Azure. You can set these values in Azure by using **Server Explorer**, the portal, Windows PowerShell, or the cross-platform command-line interface. For more information, see [How Application Strings and Connection Strings Work](/blog/2013/07/17/windows-azure-web-sites-how-application-strings-and-connection-strings-work/).\n\nIn this section you use **Server Explorer** to set connection string values in Azure.\n\n7. In **Server Explorer**, right-click your web app under the **Web Apps** node, and then click **View Settings**.\n\n    The **Azure Web App** window opens on the **Configuration** tab.\n\n9. Change the name of the DefaultConnection connection string to ContosoAdsContext.\n\n    Azure automatically created this connection string when you created the web app with an associated database, so it already has the right connection string value. You're changing just the name to what your code is looking for.\n\n9. Add two new connection strings, named AzureWebJobsStorage and AzureWebJobsDashboard. Set type to Custom, and set the connection string value to the same value that you used earlier for the *Web.config* and *App.config* files. (Make sure you include the entire connection string, not just the access key, and don't include the quotation marks.)\n\n    These connection strings are used by the WebJobs SDK, one for application data and one for logging. As you saw earlier, the one for application data is also used by the web frontend code.\n    \n9. Click **Save**.\n\n    ![Connection strings in Azure portal](./media/websites-dotnet-webjobs-sdk-get-started/azconnstr.png)\n\n10. In **Server Explorer**, right-click the web app, and then click **Stop web app**. \n\n12. After the web app stops, right-click the web app again, and then click **Start web app**.\n\n    The WebJob automatically starts when you publish, but it stops when you make a configuration change. To restart it you can either restart the web app or restart the WebJob in the [Azure Portal](http://go.microsoft.com/fwlink/?LinkId=529715). It's generally recommended to restart the web app after a configuration change. \n\n9. Refresh the browser window that has the web app URL in its address bar.\n\n    The home page appears.\n\n10. Create an ad, as you did when you ran the application locally.\n\n    The Index page shows without a thumbnail at first.\n\n11. Refresh the page after a few seconds, and the thumbnail appears.\n\n    If the thumbnail doesn't appear, the WebJob may not have started automatically. In that case, go to the WebJobs tab in the \n \n\n### View the WebJobs SDK dashboard\n\n1. In the [Azure Portal](https://manage.windowsazure.com), select your web app.\n\n2. Click the **WebJobs** tab.\n\n3. click the URL in the Logs column for your WebJob.\n\n    ![WebJobs tab](./media/websites-dotnet-webjobs-sdk-get-started/wjtab.png)\n\n    A new browser tab opens to the WebJobs SDK dashboard. The dashboard shows that the WebJob is running and shows a list of functions in your code that the WebJobs SDK triggered.\n\n4. Click one of the functions to see details about its execution \n \n    ![WebJobs SDK dashboard](./media/websites-dotnet-webjobs-sdk-get-started/wjdashboardhome.png)   \n\n    ![WebJobs SDK dashboard](./media/websites-dotnet-webjobs-sdk-get-started/wjfunctiondetails.png) \n\n    The **Replay Function** button on this page causes the WebJobs SDK framework to call the function again, and it gives you a chance to change the data passed to the function first.\n\n>[AZURE.NOTE] When you're finished testing, delete the web app and the SQL Database instance. The web app is free, but the SQL Database instance and storage account accrue charges (minimal due to small size). Also, if you leave the web app running, anyone who finds your URL can create and view ads. In the Azure portal, go to the **Dashboard** tab for your web app, and then click the **Delete** button at the bottom of the page. You can then select a check box to delete the SQL Database instance at the same time. If you just want to temporarily prevent others from accessing the web app, click **Stop** instead. In that case, charges will continue to accrue for the SQL Database and Storage account. You can follow a similar procedure to delete the SQL database and storage account when you no longer need them.\n\n### Enable AlwaysOn for long-running processes\n\nTo make sure your WebJobs are always running, and running on all instances of your web app you have to enabled the [AlwaysOn](http://weblogs.asp.net/scottgu/archive/2014/01/16/windows-azure-staging-publishing-support-for-web-sites-monitoring-improvements-hyper-v-recovery-manager-ga-and-pci-compliance.aspx) feature.\n\n## <a id=\"create\"></a>Create the application from scratch \n\nIn this section you'll do the following tasks:\n\n* Create a Visual Studio solution with a web project.\n* Add a class library project for the data access layer that is shared between frontend and backend.\n* Add a Console Application project for the backend, with WebJobs deployment enabled.\n* Add NuGet packages.\n* Set project references.\n* Copy application code and configuration files from the downloaded application that you worked with in the previous section of the tutorial.\n* Review the parts of the code that work with Azure blobs and queues and the WebJobs SDK.\n \n### Create a Visual Studio solution with a web project and class library project\n\n1. In Visual Studio, choose **New** > **Project** from the **File** menu.\n\n2. In the **New Project** dialog, choose **Visual C#** > **Web** > **ASP.NET Web Application**.\n\n3. Name the project ContosoAdsWeb, name the solution ContosoAdsWebJobsSDK (change the solution name if you're putting it in the same folder as the downloaded solution), and then click **OK**.\n\n    ![New Project](./media/websites-dotnet-webjobs-sdk-get-started/newproject.png)  \n\n5. In the **New ASP.NET Project** dialog, choose the MVC template, and clear the **Host in the cloud** check box under **Microsoft Azure**.\n\n    Selecting **Host in the cloud** enables Visual Studio to automatically create a new Azure web app and SQL Database. Since you already created these earlier, you don't need to do so now while creating the project. If you want to create a new one, select the check box. You can then configure the new web app and SQL database the same way you did earlier when you were deploying the application.\n\n5. Click **Change Authentication**.\n\n    ![Change Authentication](./media/websites-dotnet-webjobs-sdk-get-started/chgauth.png)   \n\n7. In the **Change Authentication** dialog, choose **No Authentication**, and then click **OK**.\n\n    ![No Authentication](./media/websites-dotnet-webjobs-sdk-get-started/noauth.png)    \n\n8. In the **New ASP.NET Project** dialog, click **OK**. \n\n    Visual Studio creates the solution and the web project.\n\n9. In **Solution Explorer**, right-click the solution (not the project), and choose **Add** > **New Project**.\n\n11. In the **Add New Project** dialog, choose **Visual C#** > **Windows Desktop** > **Class Library** template.  \n\n10. Name the project *ContosoAdsCommon*, and then click **OK**.\n\n    This project will contain the Entity Framework context and the data model which both the frontend and backend will use. As an alternative you could define the EF-related classes in the web project and reference that project from the WebJob project. But then your WebJob project would have a reference to web assemblies which it doesn't need.\n\n### Add a Console Application project that has WebJobs deployment enabled\n\n11. Right-click the web project (not the solution or the class library project), and then click **Add** > **New Azure WebJob Project**.\n\n    ![New Azure WebJob Project menu selection](./media/websites-dotnet-webjobs-sdk-get-started/newawjp.png) \n\n1. In the **Add Azure WebJob** dialog, enter ContosoAdsWebJob as both the **Project name** and the **WebJob name**. Leave **WebJob run mode** set to **Run Continuously**.\n\n2.  Click **OK**.\n  \n    Visual Studio creates a Console application that is configured to deploy as a WebJob whenever you deploy the web project. To do that it performed the following tasks after creating the project:\n\n    * Added a *webjob-publish-settings.json* file in the WebJob project Properties folder.\n    * Added a *webjobs-list.json* file in the web project Properties folder.\n    * Installed the Microsoft.Web.WebJobs.Publish NuGet package in the WebJob project.\n     \n    For more information about these changes, see [How to Deploy WebJobs by using Visual Studio](websites-dotnet-deploy-webjobs.md).\n\n### Add NuGet packages\n\nThe new-project template for a WebJob project automatically installs the WebJobs SDK NuGet package [Microsoft.Azure.WebJobs](http://www.nuget.org/packages/Microsoft.Azure.WebJobs) and its dependencies. \n\nOne of the WebJobs SDK dependencies that is installed automatically in the WebJob project is the Azure Storage Client Library (SCL). However, you need to add it to the web project to work with blobs and queues.\n\n11. Open the **Manage NuGet Packages** dialog for the solution.\n\n12. In the left pane, select **Installed packages**.\n   \n13. Find the *Azure Storage* package, and then click **Manage**.\n\n13. In the **Select Projects** box, select the **ContosoAdsWeb** check box, and then click **OK**. \n\nAll three projects use the Entity Framework to work with data in SQL Database.\n\n12. In the left pane, select **Online**.\n   \n16. Find the *EntityFramework* NuGet package, and install it in all three projects.\n\n\n### Set project references\n\nBoth web and WebJob projects will work with the SQL database, so both need a reference to the ContosoAdsCommon project.\n\n10. In the ContosoAdsWeb project, set a reference to the ContosoAdsCommon project. (Right-click the ContosoAdsWeb project, and then click **Add** > **Reference**. In the **Reference Manager** dialog box, select **Solution** > **Projects** > **ContosoAdsCommon**, and then click **OK**.)\n\n11. In the ContosoAdsWebJob project, set a reference to the ContosAdsCommon project.\n\nThe WebJob project needs references for working with images and for accessing connection strings.\n\n11. In the ContosoAdsWebJob project, set a reference to `System.Drawing` and `System.Configuration`.\n\n### Add code and configuration files\n\nThis tutorial does not show how to [create MVC controllers and views using scaffolding](http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started), how to [write Entity Framework code that works with SQL Server databases](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc), or [the basics of asynchronous programming in ASP.NET 4.5](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/web-development-best-practices#async). So all that remains to do is copy code and configuration files from the downloaded solution into the new solution. After you do that, the following sections will show and explain key parts of the code.\n\nTo add files to a project or a folder, right-click the project or folder and click **Add** > **Existing Item**. Select the files you want and click **Add**. If asked whether you want to replace existing files, click **Yes**.\n\n3. In the ContosoAdsCommon project, delete the *Class1.cs* file and add in its place the following files from the downloaded project.\n\n    - *Ad.cs*\n    - *ContosoAdscontext.cs*\n    - *BlobInformation.cs*<br/><br/>\n\n3. In the ContosoAdsWeb project, add the following files from the downloaded project.\n\n    - *Web.config*\n    - *Global.asax.cs*  \n    - In the *Controllers* folder: *AdController.cs* \n    - In the *Views\\Shared* folder: <em>_Layout.cshtml</em> file. \n    - In the *Views\\Home* folder: *Index.cshtml*. \n    - In the *Views\\Ad* folder (create the folder first): five *.cshtml* files.<br/><br/>\n\n3. In the ContosoAdsWebJob project, add the following files from the downloaded project.\n\n    - *App.config* (change the file type filter to **All Files**)\n    - *Program.cs*\n    - *Functions.cs*\n\nYou can now build, run, and deploy the application as instructed earlier in the tutorial. Before you do that, however, stop the WebJob that is still running in the first web app you deployed to. Otherwise that WebJob will process queue messages created locally or by the app running in a new web app, since all are using the same storage account.\n\n## <a id=\"code\"></a>Review the application code\n\nThe following sections explain the code related to working with the WebJobs SDK and Azure Storage blobs and queues. \n\n> **Note:**  For the code specific to the WebJobs SDK, see [Program.cs and Functions.cs](#programcs).\n\n### ContosoAdsCommon - Ad.cs\n\nThe Ad.cs file defines an enum for ad categories and a POCO entity class for ad information.\n\n        public enum Category\n        {\n            Cars,\n            [Display(Name=\"Real Estate\")]\n            RealEstate,\n            [Display(Name = \"Free Stuff\")]\n            FreeStuff\n        }\n\n        public class Ad\n        {\n            public int AdId { get; set; }\n\n            [StringLength(100)]\n            public string Title { get; set; }\n\n            public int Price { get; set; }\n\n            [StringLength(1000)]\n            [DataType(DataType.MultilineText)]\n            public string Description { get; set; }\n\n            [StringLength(1000)]\n            [DisplayName(\"Full-size Image\")]\n            public string ImageURL { get; set; }\n\n            [StringLength(1000)]\n            [DisplayName(\"Thumbnail\")]\n            public string ThumbnailURL { get; set; }\n\n            [DataType(DataType.Date)]\n            [DisplayFormat(DataFormatString = \"{0:yyyy-MM-dd}\", ApplyFormatInEditMode = true)]\n            public DateTime PostedDate { get; set; }\n\n            public Category? Category { get; set; }\n            [StringLength(12)]\n            public string Phone { get; set; }\n        }\n\n### ContosoAdsCommon - ContosoAdsContext.cs\n\nThe ContosoAdsContext class specifies that the Ad class is used in a DbSet collection, which Entity Framework will store in a SQL database.\n\n        public class ContosoAdsContext : DbContext\n        {\n            public ContosoAdsContext() : base(\"name=ContosoAdsContext\")\n            {\n            }\n            public ContosoAdsContext(string connString)\n                : base(connString)\n            {\n            }\n            public System.Data.Entity.DbSet<Ad> Ads { get; set; }\n        }\n \nThe class has two constructors. The first of them is used by the web project, and specifies the name of a connection string that is stored in the Web.config file or the Azure runtime environment. The second constructor enables you to pass in the actual connection string. That is needed by the WebJob project, since it doesn't have a Web.config file. You saw earlier where this connection string was stored, and you'll see later how the code retrieves the connection string when it instantiates the DbContext class.\n\n### ContosoAdsCommon - BlobInformation.cs\n\nThe `BlobInformation` class is used to store information about an image blob in a queue message.\n\n        public class BlobInformation\n        {\n            public Uri BlobUri { get; set; }\n            \n            public string BlobName\n            {\n                get\n                {\n                    return BlobUri.Segments[BlobUri.Segments.Length - 1];\n                }\n            }\n            public string BlobNameWithoutExtension\n            {\n                get\n                {\n                    return Path.GetFileNameWithoutExtension(BlobName);\n                }\n            }\n            public int AdId { get; set; }\n        }\n\n\n### ContosoAdsWeb - Global.asax.cs\n\nCode that is called from the `Application_Start` method creates an *images* blob container and an *images* queue if they don't already exist. This ensures that whenever you start using a new storage account, the required blob container and queue will be created automatically.\n\nThe code gets access to the storage account by using the storage connection string from the *Web.config* file or Azure runtime environment.\n\n        var storageAccount = CloudStorageAccount.Parse\n            (ConfigurationManager.ConnectionStrings[\"AzureWebJobsStorage\"].ToString());\n\nThen it gets a reference to the *images* blob container, creates the container if it doesn't already exist, and sets access permissions on the new container. By default new containers allow only clients with storage account credentials to access blobs. The web app needs the blobs to be public so that it can display images using URLs that point to the image blobs.\n\n        var blobClient = storageAccount.CreateCloudBlobClient();\n        var imagesBlobContainer = blobClient.GetContainerReference(\"images\");\n        if (imagesBlobContainer.CreateIfNotExists())\n        {\n            imagesBlobContainer.SetPermissions(\n                new BlobContainerPermissions\n                {\n                    PublicAccess = BlobContainerPublicAccessType.Blob\n                });\n        }\n\nSimilar code gets a reference to the *blobnamerequest* queue and creates a new queue. In this case no permissions change is needed. The [ResolveBlobName](#resolveblobname) section later in the tutorial explains why the queue that the web application writes to is used just for getting blob names and not for generating thumbnails.\n\n        CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient();\n        var imagesQueue = queueClient.GetQueueReference(\"blobnamerequest\");\n        imagesQueue.CreateIfNotExists();\n\n### ContosoAdsWeb - _Layout.cshtml\n\nThe *_Layout.cshtml* file sets the app name in the header and footer, and creates an \"Ads\" menu entry.\n\n### ContosoAdsWeb - Views\\Home\\Index.cshtml\n\nThe *Views\\Home\\Index.cshtml* file displays category links on the home page. The links pass the integer value of the `Category` enum in a querystring variable to the Ads Index page.\n    \n        <li>@Html.ActionLink(\"Cars\", \"Index\", \"Ad\", new { category = (int)Category.Cars }, null)</li>\n        <li>@Html.ActionLink(\"Real estate\", \"Index\", \"Ad\", new { category = (int)Category.RealEstate }, null)</li>\n        <li>@Html.ActionLink(\"Free stuff\", \"Index\", \"Ad\", new { category = (int)Category.FreeStuff }, null)</li>\n        <li>@Html.ActionLink(\"All\", \"Index\", \"Ad\", null, null)</li>\n\n### ContosoAdsWeb - AdController.cs\n\nIn the *AdController.cs* file the constructor calls the `InitializeStorage` method to create Azure Storage Client Library objects that provide an API for working with blobs and queues. \n\nThen the code gets a reference to the *images* blob container as you saw earlier in *Global.asax.cs*. While doing that it sets a default [retry policy](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/transient-fault-handling) appropriate for a web app. The default exponential backoff retry policy could hang the web app for longer than a minute on repeated retries for a transient fault. The retry policy specified here waits 3 seconds after each try for up to 3 tries.\n\n        var blobClient = storageAccount.CreateCloudBlobClient();\n        blobClient.DefaultRequestOptions.RetryPolicy = new LinearRetry(TimeSpan.FromSeconds(3), 3);\n        imagesBlobContainer = blobClient.GetContainerReference(\"images\");\n\nSimilar code gets a reference to the *images* queue.\n\n        CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient();\n        queueClient.DefaultRequestOptions.RetryPolicy = new LinearRetry(TimeSpan.FromSeconds(3), 3);\n        imagesQueue = queueClient.GetQueueReference(\"blobnamerequest\");\n\nMost of the controller code is typical for working with an Entity Framework data model using a DbContext class. An exception is the HttpPost `Create` method, which uploads a file and saves it in blob storage. The model binder provides an [HttpPostedFileBase](http://msdn.microsoft.com/library/system.web.httppostedfilebase.aspx) object to the method.\n\n        [HttpPost]\n        [ValidateAntiForgeryToken]\n        public async Task<ActionResult> Create(\n            [Bind(Include = \"Title,Price,Description,Category,Phone\")] Ad ad,\n            HttpPostedFileBase imageFile)\n\nIf the user selected a file to upload, the code uploads the file, saves it in a blob, and updates the Ad database record with a URL that points to the blob.\n\n        if (imageFile != null && imageFile.ContentLength != 0)\n        {\n            blob = await UploadAndSaveBlobAsync(imageFile);\n            ad.ImageURL = blob.Uri.ToString();\n        }\n\nThe code that does the upload is in the `UploadAndSaveBlobAsync` method. It creates a GUID name for the blob, uploads and saves the file, and returns a reference to the saved blob.\n\n        private async Task<CloudBlockBlob> UploadAndSaveBlobAsync(HttpPostedFileBase imageFile)\n        {\n            string blobName = Guid.NewGuid().ToString() + Path.GetExtension(imageFile.FileName);\n            CloudBlockBlob imageBlob = imagesBlobContainer.GetBlockBlobReference(blobName);\n            using (var fileStream = imageFile.InputStream)\n            {\n                await imageBlob.UploadFromStreamAsync(fileStream);\n            }\n            return imageBlob;\n        }\n\nAfter the HttpPost `Create` method uploads a blob and updates the database, it creates a queue message to inform the back-end process that an image is ready for conversion to a thumbnail.\n\n        BlobInformation blobInfo = new BlobInformation() { AdId = ad.AdId, BlobUri = new Uri(ad.ImageURL) };\n        var queueMessage = new CloudQueueMessage(JsonConvert.SerializeObject(blobInfo));\n        await thumbnailRequestQueue.AddMessageAsync(queueMessage);\n\nThe code for the HttpPost `Edit` method is similar except that if the user selects a new image file any blobs that already exist for this ad must be deleted.\n \n        if (imageFile != null && imageFile.ContentLength != 0)\n        {\n            await DeleteAdBlobsAsync(ad);\n            imageBlob = await UploadAndSaveBlobAsync(imageFile);\n            ad.ImageURL = imageBlob.Uri.ToString();\n        }\n\nHere is the code that deletes blobs when you delete an ad:\n\n        private async Task DeleteAdBlobsAsync(Ad ad)\n        {\n            if (!string.IsNullOrWhiteSpace(ad.ImageURL))\n            {\n                Uri blobUri = new Uri(ad.ImageURL);\n                await DeleteAdBlobAsync(blobUri);\n            }\n            if (!string.IsNullOrWhiteSpace(ad.ThumbnailURL))\n            {\n                Uri blobUri = new Uri(ad.ThumbnailURL);\n                await DeleteAdBlobAsync(blobUri);\n            }\n        }\n        private static async Task DeleteAdBlobAsync(Uri blobUri)\n        {\n            string blobName = blobUri.Segments[blobUri.Segments.Length - 1];\n            CloudBlockBlob blobToDelete = imagesBlobContainer.GetBlockBlobReference(blobName);\n            await blobToDelete.DeleteAsync();\n        }\n \n### ContosoAdsWeb - Views\\Ad\\Index.cshtml and Details.cshtml\n\nThe *Index.cshtml* file displays thumbnails with the other ad data:\n\n        <img  src=\"@Html.Raw(item.ThumbnailURL)\" />\n\nThe *Details.cshtml* file displays the full-size image:\n\n        <img src=\"@Html.Raw(Model.ImageURL)\" />\n\n### ContosoAdsWeb - Views\\Ad\\Create.cshtml and Edit.cshtml\n\nThe *Create.cshtml* and *Edit.cshtml* files specify form encoding that enables the controller to get the `HttpPostedFileBase` object.\n\n        @using (Html.BeginForm(\"Create\", \"Ad\", FormMethod.Post, new { enctype = \"multipart/form-data\" }))\n\nAn `<input>` element tells the browser to provide a file selection dialog.\n\n        <input type=\"file\" name=\"imageFile\" accept=\"image/*\" class=\"form-control fileupload\" />\n\n### <a id=\"programcs\"></a>ContosoAdsWebJob - Program.cs\n\nWhen the WebJob starts, the `Main` method calls the WebJobs SDK `JobHost.RunAndBlock` method to begin execution of triggered functions on the current thread.\n\n        static void Main(string[] args)\n        {\n            JobHost host = new JobHost();\n            host.RunAndBlock();\n        }\n\n### <a id=\"generatethumbnail\"></a>ContosoAdsWebJob - Functions.cs - GenerateThumbnail method\n\nThe WebJobs SDK calls this method when a queue message is received. The method creates a thumbnail and puts the thumbnail URL in the database.\n\n        public static void GenerateThumbnail(\n        [QueueTrigger(\"thumbnailrequest\")] BlobInformation blobInfo,\n        [Blob(\"images/{BlobName}\", FileAccess.Read)] Stream input,\n        [Blob(\"images/{BlobNameWithoutExtension}_thumbnail.jpg\")] CloudBlockBlob outputBlob)\n        {\n            using (Stream output = outputBlob.OpenWrite())\n            {\n                ConvertImageToThumbnailJPG(input, output);\n                outputBlob.Properties.ContentType = \"image/jpeg\";\n            }\n        \n            // Entity Framework context class is not thread-safe, so it must\n            // be instantiated and disposed within the function.\n            using (ContosoAdsContext db = new ContosoAdsContext())\n            {\n                var id = blobInfo.AdId;\n                Ad ad = db.Ads.Find(id);\n                if (ad == null)\n                {\n                    throw new Exception(String.Format(\"AdId {0} not found, can't create thumbnail\", id.ToString()));\n                }\n                ad.ThumbnailURL = outputBlob.Uri.ToString();\n                db.SaveChanges();\n            }\n        }\n\n* The `QueueTrigger` attribute directs the WebJobs SDK to call this method when a new message is received on the thumbnailrequest queue.\n\n        [QueueTrigger(\"thumbnailrequest\")] BlobInformation blobInfo,\n\n    The `BlobInformation` object in the queue message is automatically deserialized into the `blobInfo` parameter. When the method completes, the queue message is deleted. If the method fails before completing, the queue message is not deleted; after a 10-minute lease expires, the message is released to be picked up again and processed. This sequence won't be repeated indefinitely if a message always causes an exception. After 5 unsuccessful attempts to process a message, the message is moved to a queue named {queuename}-poison. The maximum number of attempts is configurable. \n\n* The two `Blob` attributes provide objects that are bound to blobs: one to the existing image blob and one to a new thumbnail blob that the method creates. \n\n        [Blob(\"images/{BlobName}\", FileAccess.Read)] Stream input,\n        [Blob(\"images/{BlobNameWithoutExtension}_thumbnail.jpg\")] CloudBlockBlob outputBlob)\n\n    Blob names come from properties of the `BlobInformation` object received in the queue message (`BlobName` and `BlobNameWithoutExtension`). To get the full functionality of the Storage Client Library you can use the `CloudBlockBlob` class to work with blobs. If you want to reuse code that was written to work with `Stream` objects, you can use the `Stream` class. \n\nFor more information about how to write functions that use  WebJobs SDK attributes, see the following resources:\n\n* [How to use Azure queue storage with the WebJobs SDK](websites-dotnet-webjobs-sdk-storage-queues-how-to.md)\n* [How to use Azure blob storage with the WebJobs SDK](websites-dotnet-webjobs-sdk-storage-blobs-how-to.md)\n* [How to use Azure table storage with the WebJobs SDK](websites-dotnet-webjobs-sdk-storage-tables-how-to.md)\n* [How to use Azure Service Bus with the WebJobs SDK](websites-dotnet-webjobs-sdk-service-bus.md)\n\n> [AZURE.NOTE] \n>\n> * If your web app runs on multiple VMs, multiple WebJobs will be running simultaneously, and in some scenarios this can result in the same data getting processed multiple times. This is not a problem if you use the built-in queue, blob, and Service Bus triggers. The SDK ensures that your functions will be processed only once for each message or blob.\n>\n> * For information about how to implement graceful shutdown, see [Graceful Shutdown](websites-dotnet-webjobs-sdk-storage-queues-how-to.md#graceful).   \n>\n> * The code in the `ConvertImageToThumbnailJPG` method (not shown) uses classes in the `System.Drawing` namespace for simplicity. However, the classes in this namespace were designed for use with Windows Forms. They are not supported for use in a Windows or ASP.NET service. For more information about image processing options, see [Dynamic Image Generation](http://www.hanselman.com/blog/BackToBasicsDynamicImageGenerationASPNETControllersRoutingIHttpHandlersAndRunAllManagedModulesForAllRequests.aspx) and [Deep Inside Image Resizing](http://www.hanselminutes.com/313/deep-inside-image-resizing-and-scaling-with-aspnet-and-iis-with-imageresizingnet-author-na).\n\n### WebJobs SDK versus Cloud Service worker role without WebJobs SDK\n\nIf you compare the amount of code in the `GenerateThumbnails` method in this sample application with the worker role code in the [Cloud Service version of the application](../cloud-services-dotnet-get-started.md), you can see how much work the WebJobs SDK is doing for you. The advantage is greater than it appears, because the Cloud Service sample application code doesn't do all of the things (such as poison message handling) that you would do in a production application, and which the WebJobs SDK does for you.\n\nIn the Cloud Service version of the application, the record ID is the only information in the queue message, and the background process gets the image URL from the database. In the WebJobs SDK version of the application, the queue message includes the image URL so that it can be provided to the `Blob` attributes. If the queue message didn't have the blob URL, you could [use the Blob attribute in the body of the method instead of in the method signature](websites-dotnet-webjobs-sdk-storage-queues-how-to.md#blobbody).\n\n### Using the WebJobs SDK outside of WebJobs\n\nA program that uses the WebJobs SDK doesn't have to run in Azure in a WebJob. It can run locally, and it can also run in other environments such as a Cloud Service worker role or a Windows service. However, you can only access the WebJobs SDK dashboard through an Azure web app. To use the dashboard you have to connect the web app to the storage account you're using by setting the AzureWebJobsDashboard connection string on the **Configure** tab of the Azure portal. Then you can get to the Dashboard by using the following URL:\n\nhttps://{webappname}.scm.azurewebsites.net/azurejobs/#/functions\n\nFor more information, see [Getting a dashboard for local development with the WebJobs SDK](http://blogs.msdn.com/b/jmstall/archive/2014/01/27/getting-a-dashboard-for-local-development-with-the-webjobs-sdk.aspx), but note that it shows an old connection string name. \n\n## Next steps\n\nIn this tutorial you've seen a simple multi-tier application that uses the WebJobs SDK for backend processing. The application has been kept simple for a getting-started tutorial. For example, it doesn't implement [dependency injection](http://www.asp.net/mvc/tutorials/hands-on-labs/aspnet-mvc-4-dependency-injection) or the [repository and unit of work patterns](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/advanced-entity-framework-scenarios-for-an-mvc-web-application#repo), it doesn't [use an interface for logging](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry#log), it doesn't use [EF Code First Migrations](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application) to manage data model changes or [EF Connection Resiliency](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application) to manage transient network errors, and so forth.\n\nFor more information, see [Azure Web Jobs Recommended Resources](http://go.microsoft.com/fwlink/?LinkId=390226).\n\n## What's changed\n* For a guide to the change from Websites to App Service see: [Azure App Service and Its Impact on Existing Azure Services](http://go.microsoft.com/fwlink/?LinkId=529714)\n* For a guide to the change of the Azure portal to the Azure preview portal see: [Reference for navigating the preview portal](http://go.microsoft.com/fwlink/?LinkId=529715)\n\ntest\n"
}