{
  "nodes": [
    {
      "content": "Move data from an on-premise SQL Server to SQL Azure with Azure Data Factory | Azure",
      "pos": [
        28,
        112
      ]
    },
    {
      "content": "Set up an ADF pipeline that composes two data migration activities that together move data on a daily basis between databases on-premise and in the cloud.",
      "pos": [
        132,
        286
      ]
    },
    {
      "content": "Move data from an on-premise SQL server to SQL Azure with Azure Data Factory",
      "pos": [
        702,
        778
      ]
    },
    {
      "content": "This topic shows how to move data from an on-premise SQL Server Database to a SQL Azure Database via Azure Blob Storage using the Azure Data Factory (ADF).",
      "pos": [
        780,
        935
      ]
    },
    {
      "pos": [
        941,
        1030
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"intro\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Introduction: What is ADF and when should it be used to migrate data?"
    },
    {
      "content": "Azure Data Factory is a fully managed cloud-based data integration service that orchestrates and automates the movement and transformation of data.",
      "pos": [
        1032,
        1179
      ]
    },
    {
      "content": "The key concept in the ADF model is pipeline.",
      "pos": [
        1180,
        1225
      ]
    },
    {
      "content": "A pipelines is a logical groupings of Activities, each of which defines the actions to perform on the data contained in Datasets.",
      "pos": [
        1226,
        1355
      ]
    },
    {
      "content": "Linked services are used to define the information needed for Data Factory to connect to the data resources.",
      "pos": [
        1356,
        1464
      ]
    },
    {
      "content": "With ADF, existing data processing services can be composed into data pipelines that are highly available and managed in the cloud.",
      "pos": [
        1466,
        1597
      ]
    },
    {
      "content": "These data pipelines can be scheduled to ingest, prepare, transform, analyze, and publish data, and ADF will manage and orchestrate all of the complex data and processing dependencies.",
      "pos": [
        1598,
        1782
      ]
    },
    {
      "content": "Solutions can be quickly built and deployed in the cloud, connecting a growing number of on-premises and cloud data sources.",
      "pos": [
        1783,
        1907
      ]
    },
    {
      "content": "Consider using ADF when data needs to be continually migrated in a hybrid scenario that accesses both on-premise and cloud resources, and when the data is transacted or needs to be modified or have business logic added to it in the course of being migrated.",
      "pos": [
        1909,
        2166
      ]
    },
    {
      "content": "ADF allows for the scheduling and monitoring of jobs using simple JSON scripts that manage the movement of data on a periodic basis.",
      "pos": [
        2167,
        2299
      ]
    },
    {
      "content": "ADF also has other capabilities such as support for complex operations.",
      "pos": [
        2300,
        2371
      ]
    },
    {
      "content": "For more information on ADF, see the documentation at <bpt id=\"p1\">[</bpt>Azure Data Factory (ADF)<ept id=\"p1\">](http://azure.microsoft.com/services/data-factory/)</ept>.",
      "pos": [
        2372,
        2504
      ]
    },
    {
      "pos": [
        2509,
        2544
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"scenario\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>The Scenario"
    },
    {
      "content": "We set up an ADF pipeline that composes two data migration activities that together move data on a daily basis between an on-premise SQL database and an Azure SQL Database in the cloud.",
      "pos": [
        2546,
        2731
      ]
    },
    {
      "content": "The two activities are:",
      "pos": [
        2732,
        2755
      ]
    },
    {
      "content": "copy data from an on-premise SQL Server database to an Azure Blob Storage account",
      "pos": [
        2759,
        2840
      ]
    },
    {
      "content": "copy data from the Azure Blob Storage account to an Azure SQL Database.",
      "pos": [
        2844,
        2915
      ]
    },
    {
      "pos": [
        2917,
        3210
      ],
      "content": "<bpt id=\"p1\">**</bpt>Reference<ept id=\"p1\">**</ept>: The steps shown here have been adapted from the more detailed tutorial <bpt id=\"p2\">[</bpt>Enable your pipelines to work with on-premises data<ept id=\"p2\">](data-factory-use-onpremises-datasources.md)</ept> provided by the ADF team and references to the relevant sections of that topic are provided when appropriate."
    },
    {
      "pos": [
        3216,
        3251
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"prereqs\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Prerequisites"
    },
    {
      "content": "This tutorial assumes you have:",
      "pos": [
        3252,
        3283
      ]
    },
    {
      "content": "An <bpt id=\"p1\">**</bpt>Azure subscription<ept id=\"p1\">**</ept>.",
      "pos": [
        3287,
        3313
      ]
    },
    {
      "content": "If you do not have a subscription, you can sign up for a <bpt id=\"p1\">[</bpt>free trial<ept id=\"p1\">](https://azure.microsoft.com/pricing/free-trial/)</ept>.",
      "pos": [
        3314,
        3433
      ]
    },
    {
      "content": "An <bpt id=\"p1\">**</bpt>Azure storage account<ept id=\"p1\">**</ept>.",
      "pos": [
        3436,
        3465
      ]
    },
    {
      "content": "You will use an Azure storage account for storing the data in this tutorial.",
      "pos": [
        3466,
        3542
      ]
    },
    {
      "content": "If you don't have an Azure storage account, see the <bpt id=\"p1\">[</bpt>Create a storage account<ept id=\"p1\">](storage-create-storage-account.md#create-a-storage-account)</ept> article.",
      "pos": [
        3543,
        3690
      ]
    },
    {
      "content": "After you have created the storage account, you will need to obtain the account key used to access the storage.",
      "pos": [
        3691,
        3802
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>View, copy and regenerate storage access keys<ept id=\"p1\">](storage-create-storage-account.md#view-copy-and-regenerate-storage-access-keys)</ept>.",
      "pos": [
        3803,
        3935
      ]
    },
    {
      "content": "Access to an <bpt id=\"p1\">**</bpt>Azure SQL Database<ept id=\"p1\">**</ept>.",
      "pos": [
        3938,
        3974
      ]
    },
    {
      "content": "If you must setup an Azure SQL Database, <bpt id=\"p1\">[</bpt>Getting Started with Microsoft Azure SQL Database <ept id=\"p1\">](sql-database-get-started.md)</ept> provides information on how to provision a new instance of a Azure SQL Database.",
      "pos": [
        3975,
        4178
      ]
    },
    {
      "content": "Installed and configured <bpt id=\"p1\">**</bpt>Azure PowerShell<ept id=\"p1\">**</ept> locally.",
      "pos": [
        4181,
        4235
      ]
    },
    {
      "content": "For instructions, see <bpt id=\"p1\">[</bpt>How to install and configure Azure PowerShell<ept id=\"p1\">](powershell-install-configure.md)</ept>.",
      "pos": [
        4236,
        4339
      ]
    },
    {
      "pos": [
        4343,
        4433
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> This procedure uses the <bpt id=\"p1\">[</bpt>Azure preview portal<ept id=\"p1\">](https://ms.portal.azure.com/)</ept>."
    },
    {
      "pos": [
        4437,
        4509
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"upload-data\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph> Upload the data to your on-premise SQL Server"
    },
    {
      "content": "We use the <bpt id=\"p1\">[</bpt>NYC Taxi dataset<ept id=\"p1\">](http://chriswhong.com/open-data/foil_nyc_taxi/)</ept> to demonstrate the migration process.",
      "pos": [
        4512,
        4627
      ]
    },
    {
      "content": "The NYC Taxi dataset is available, as noted that post, on Azure blob storage <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](http://www.andresmh.com/nyctaxitrips/)</ept>.",
      "pos": [
        4628,
        4751
      ]
    },
    {
      "content": "The data has two files, the trip_data.csv file which contains trip details and the  trip_far.csv file which contains details of the fare paid for each trip.",
      "pos": [
        4752,
        4908
      ]
    },
    {
      "content": "A sample and description of these files are provided in <bpt id=\"p1\">[</bpt>NYC Taxi Trips Dataset Description<ept id=\"p1\">](machine-learning-data-science-process-sql-walkthrough.md#dataset)</ept>.",
      "pos": [
        4909,
        5068
      ]
    },
    {
      "content": "You can either adapt the procedure provided here to a set of your own data or follow the steps as described by using the NYC Taxi dataset.",
      "pos": [
        5072,
        5210
      ]
    },
    {
      "content": "To upload the NYC Taxi dataset into your on-premise SQL Server database, follow the procedure outlined in <bpt id=\"p1\">[</bpt>Bulk Import Data into SQL Server Database<ept id=\"p1\">](machine-learning-data-science-process-sql-walkthrough.md#dbload)</ept>.",
      "pos": [
        5211,
        5426
      ]
    },
    {
      "content": "These instructions are for a SQL Server on an Azure Virtual Machine, but the procedure for uploading to the on-premise SQL Server is the same.",
      "pos": [
        5427,
        5569
      ]
    },
    {
      "pos": [
        5573,
        5627
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"create-adf\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph> Create an Azure Data Factory"
    },
    {
      "content": "The instructions for creating a new Azure Data Factory and a resource group in the <bpt id=\"p1\">[</bpt>Azure preview portal<ept id=\"p1\">](https://ms.portal.azure.com/)</ept> are provided <bpt id=\"p2\">[</bpt>here<ept id=\"p2\">](data-factory-build-your-first-pipeline-using-editor.md#step-1-creating-the-data-factory)</ept>.",
      "pos": [
        5629,
        5874
      ]
    },
    {
      "content": "Name the new ADF instance <bpt id=\"p1\">*</bpt>adfdsp<ept id=\"p1\">*</ept> and name the resource group created <bpt id=\"p2\">*</bpt>adfdsprg<ept id=\"p2\">*</ept>.",
      "pos": [
        5875,
        5957
      ]
    },
    {
      "content": "Install and configure up the Data Management Gateway",
      "pos": [
        5962,
        6014
      ]
    },
    {
      "content": "To enable your pipelines in an Azure data factory to work with an on-premise SQL Server, you need to add it as a linked service to the data factory.",
      "pos": [
        6016,
        6164
      ]
    },
    {
      "content": "To create a Linked Service for the on-premise SQL Server, you must first download and install Microsoft Data Management Gateway onto the on-premise computer and configure the linked service for the on-premises data source to use the gateway.",
      "pos": [
        6165,
        6406
      ]
    },
    {
      "content": "The Data Management Gateway serializes and deserializes the source and sink data on the computer where it is hosted.",
      "pos": [
        6407,
        6523
      ]
    },
    {
      "pos": [
        6526,
        6691
      ],
      "content": "For set-up instructions and details on Data Management Gateway, see <bpt id=\"p1\">[</bpt>Enable your pipelines to work with on-premises data<ept id=\"p1\">](data-factory-use-onpremises-datasources.md)</ept>"
    },
    {
      "pos": [
        6697,
        6784
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"adflinkedservices\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Create linked services to connect to the data resources"
    },
    {
      "content": "A linked service defines the information needed for Azure Data Factory to connect to a data resource.",
      "pos": [
        6787,
        6888
      ]
    },
    {
      "content": "The step-by-step procedure for creating linked services is provided in <bpt id=\"p1\">[</bpt>Create linked services<ept id=\"p1\">](data-factory-use-onpremises-datasources.md#step-2-create-linked-services)</ept>.",
      "pos": [
        6889,
        7059
      ]
    },
    {
      "content": "We have three resources in this scenario for which linked services are needed.",
      "pos": [
        7062,
        7140
      ]
    },
    {
      "content": "Linked service for on-premise SQL Server",
      "pos": [
        7146,
        7186
      ]
    },
    {
      "content": "Linked service for Azure Blob Storage",
      "pos": [
        7224,
        7261
      ]
    },
    {
      "content": "Linked service for Azure SQL database",
      "pos": [
        7299,
        7336
      ]
    },
    {
      "content": "<ph id=\"ph1\">&lt;a name=\"adf-linked-service-onprem-sql\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Linked service for on-premise SQL Server database",
      "pos": [
        7374,
        7467
      ]
    },
    {
      "content": "To create the linked service for the on-premise SQL Server, click on the <bpt id=\"p1\">**</bpt>Data Store<ept id=\"p1\">**</ept> in the ADF landing page on Azure Portal, select <bpt id=\"p2\">*</bpt>SQL<ept id=\"p2\">*</ept> and enter the credentials for the <bpt id=\"p3\">*</bpt>username<ept id=\"p3\">*</ept> and <bpt id=\"p4\">*</bpt>password<ept id=\"p4\">*</ept> for the on-premise SQL Server.",
      "pos": [
        7468,
        7700
      ]
    },
    {
      "content": "You need to enter the servername as a <bpt id=\"p1\">**</bpt>fully qualified servername backslash instance name (servername\\instancename)<ept id=\"p1\">**</ept>.",
      "pos": [
        7701,
        7820
      ]
    },
    {
      "content": "Name the linked service <bpt id=\"p1\">*</bpt>adfonpremsql<ept id=\"p1\">*</ept>.",
      "pos": [
        7821,
        7860
      ]
    },
    {
      "content": "<ph id=\"ph1\">&lt;a name=\"adf-linked-service-blob-store\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Linked service for Blob",
      "pos": [
        7865,
        7932
      ]
    },
    {
      "content": "To create the linked service for the Azure Blob Storage account, click on the <bpt id=\"p1\">**</bpt>Data Store<ept id=\"p1\">**</ept> in the ADF landing page on Azure Portal, select <bpt id=\"p2\">*</bpt>Azure Storage Account<ept id=\"p2\">*</ept> and enter the Azure Blob Storage account key and container name.",
      "pos": [
        7933,
        8162
      ]
    },
    {
      "content": "Name the link service <bpt id=\"p1\">*</bpt>adfds<ept id=\"p1\">*</ept>.",
      "pos": [
        8163,
        8193
      ]
    },
    {
      "content": "<ph id=\"ph1\">&lt;a name=\"adf-linked-service-azure-sql\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Linked service for Azure SQL database",
      "pos": [
        8198,
        8278
      ]
    },
    {
      "content": "To create the linked service for the Azure SQL Database, click on the <bpt id=\"p1\">**</bpt>Data Store<ept id=\"p1\">**</ept> in the ADF landing page on Azure Portal, select <bpt id=\"p2\">*</bpt>Azure SQL<ept id=\"p2\">*</ept> and enter the credentials for the <bpt id=\"p3\">*</bpt>username<ept id=\"p3\">*</ept> and <bpt id=\"p4\">*</bpt>password<ept id=\"p4\">*</ept> for the Azure SQL Database.",
      "pos": [
        8279,
        8511
      ]
    },
    {
      "content": "The <bpt id=\"p1\">*</bpt>username<ept id=\"p1\">*</ept> must be specified as <bpt id=\"p2\">*</bpt>user@servername<ept id=\"p2\">*</ept>.",
      "pos": [
        8512,
        8566
      ]
    },
    {
      "pos": [
        8574,
        8661
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"adf-tables\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Define and create tables to specify how to access the datasets"
    },
    {
      "content": "Create tables that specify the structure, location and availability of the datasets with the following script-based procedures.",
      "pos": [
        8663,
        8790
      ]
    },
    {
      "content": "JSON files are used to define the tables.",
      "pos": [
        8791,
        8832
      ]
    },
    {
      "content": "For more information on the structure of these files, see <bpt id=\"p1\">[</bpt>Datasets<ept id=\"p1\">](data-factory-create-datasets.md)</ept>.",
      "pos": [
        8833,
        8935
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph>  You should execute <ph id=\"ph2\">`Switch-AzureMode -Name AzureResourceManager`</ph> and the <ph id=\"ph3\">`Add-AzureAccount`</ph> cmdlets prior to executing the <bpt id=\"p1\">[</bpt>New-AzureDataFactoryTable<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/dn835096.aspx)</ept> cmdlet to confirm that the Azure PowerShell cmdlets are available and that the right Azure subscription is selected for the command execution.",
      "pos": [
        8939,
        9302
      ]
    },
    {
      "content": "For documentation of these cmdlets, see <bpt id=\"p1\">[</bpt>Switch-AzureMode<ept id=\"p1\">](https://msdn.microsoft.com/library/dn722470.aspx)</ept> and <bpt id=\"p2\">[</bpt>Add-AzureAccoun<ept id=\"p2\">](https://msdn.microsoft.com/library/azure/dn790372.aspx)</ept>.",
      "pos": [
        9303,
        9490
      ]
    },
    {
      "content": "The JSON-based definitions in the tables use the following names:",
      "pos": [
        9493,
        9558
      ]
    },
    {
      "pos": [
        9563,
        9628
      ],
      "content": "the <bpt id=\"p1\">**</bpt>table name<ept id=\"p1\">**</ept> in the on-premise SQL server is <bpt id=\"p2\">*</bpt>nyctaxi_data<ept id=\"p2\">*</ept>"
    },
    {
      "pos": [
        9631,
        9706
      ],
      "content": "the <bpt id=\"p1\">**</bpt>container name<ept id=\"p1\">**</ept> in the Azure Blob Storage account is <bpt id=\"p2\">*</bpt>containername<ept id=\"p2\">*</ept>"
    },
    {
      "content": "Three table definitions are needed for this ADF pipeline:",
      "pos": [
        9710,
        9767
      ]
    },
    {
      "content": "SQL on-premise Table",
      "pos": [
        9773,
        9793
      ]
    },
    {
      "content": "Blob Table",
      "pos": [
        9822,
        9832
      ]
    },
    {
      "content": "SQL Azure Table",
      "pos": [
        9862,
        9877
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph>  The following procedures use Azure PowerShell to define and create the ADF activities.",
      "pos": [
        9904,
        10004
      ]
    },
    {
      "content": "But these tasks can also be accomplished using the Azure preview portal.",
      "pos": [
        10005,
        10077
      ]
    },
    {
      "content": "For details, see <bpt id=\"p1\">[</bpt>Create input and output datasets<ept id=\"p1\">](data-factory-use-onpremises-datasources.md#step-3-create-input-and-output-datasets)</ept>.",
      "pos": [
        10078,
        10214
      ]
    },
    {
      "pos": [
        10219,
        10274
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"adf-table-onprem-sql\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>SQL on-premise Table"
    },
    {
      "content": "The table definition for the on-premise SQL Server is specified in the following JSON file.",
      "pos": [
        10276,
        10367
      ]
    },
    {
      "pos": [
        11053,
        11248
      ],
      "content": "Note that the column names were not included here, you can sub-select on the column names by including them here (for details please check the <bpt id=\"p1\">[</bpt>ADF documentation<ept id=\"p1\">](data-factory-copy-activity.md)</ept>)."
    },
    {
      "content": "Copy the JSON definition of the table into a file called <bpt id=\"p1\">*</bpt>onpremtabledef.json<ept id=\"p1\">*</ept> file and save it to a known location (here assumed to be <bpt id=\"p2\">*</bpt>C:\\temp\\onpremtabledef.json<ept id=\"p2\">*</ept>).",
      "pos": [
        11250,
        11417
      ]
    },
    {
      "content": "Create the table in ADF with the following Azure PowerShell cmdlet.",
      "pos": [
        11418,
        11485
      ]
    },
    {
      "content": "<ph id=\"ph1\">&lt;a name=\"adf-table-blob-store\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Blob Table",
      "pos": [
        11608,
        11653
      ]
    },
    {
      "content": "Definition for the table for the output blob location is in the following (this maps the ingested data from on-premise to Azure blob):",
      "pos": [
        11654,
        11788
      ]
    },
    {
      "content": "Copy the JSON definition of the table into a file called <bpt id=\"p1\">*</bpt>bloboutputtabledef.json<ept id=\"p1\">*</ept> file and save it to a known location (here assumed to be <bpt id=\"p2\">*</bpt>C:\\temp\\bloboutputtabledef.json<ept id=\"p2\">*</ept>).",
      "pos": [
        12384,
        12559
      ]
    },
    {
      "content": "Create the table in ADF with the following Azure PowerShell cmdlet.",
      "pos": [
        12560,
        12627
      ]
    },
    {
      "content": "<ph id=\"ph1\">&lt;a name=\"adf-table-azure-sq\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>SQL Azure Table",
      "pos": [
        12755,
        12803
      ]
    },
    {
      "content": "Definition for the table for the SQL Azure output is in the following (this schema maps the data coming from the blob):",
      "pos": [
        12804,
        12923
      ]
    },
    {
      "content": "Copy the JSON definition of the table into a file called <bpt id=\"p1\">*</bpt>AzureSqlTable.json<ept id=\"p1\">*</ept> file and save it to a known location (here assumed to be <bpt id=\"p2\">*</bpt>C:\\temp\\AzureSqlTable.json<ept id=\"p2\">*</ept>).",
      "pos": [
        13554,
        13719
      ]
    },
    {
      "content": "Create the table in ADF with the following Azure PowerShell cmdlet.",
      "pos": [
        13720,
        13787
      ]
    },
    {
      "pos": [
        13909,
        13966
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"adf-pipeline\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Define and create the pipeline"
    },
    {
      "content": "Specify the activities that belong to the pipeline and create the pipeline with the following script-based procedures.",
      "pos": [
        13968,
        14086
      ]
    },
    {
      "content": "A JSON file is used to define the pipeline properties.",
      "pos": [
        14087,
        14141
      ]
    },
    {
      "pos": [
        14146,
        14218
      ],
      "content": "The script assumes that the <bpt id=\"p1\">**</bpt>pipeline name<ept id=\"p1\">**</ept> is <bpt id=\"p2\">*</bpt>AMLDSProcessPipeline<ept id=\"p2\">*</ept>."
    },
    {
      "content": "Also note that we set the periodicity of the pipeline to be executed on daily basis and use the default execution time for the job (12 am UTC).",
      "pos": [
        14221,
        14364
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph>  The following procedures use Azure PowerShell to define and create the ADF pipeline.",
      "pos": [
        14368,
        14466
      ]
    },
    {
      "content": "But this task can also be accomplished using the Azure preview portal.",
      "pos": [
        14467,
        14537
      ]
    },
    {
      "content": "For details, see <bpt id=\"p1\">[</bpt>Create and run a pipeline<ept id=\"p1\">](data-factory-use-onpremises-datasources.md#step-4-create-and-run-a-pipeline)</ept>.",
      "pos": [
        14538,
        14660
      ]
    },
    {
      "content": "Using the table definitions provided above, the pipeline definition for the ADF is specified as follows:",
      "pos": [
        14662,
        14766
      ]
    },
    {
      "content": "Copy this JSON definition of the pipeline into a file called <bpt id=\"p1\">*</bpt>pipelinedef.json<ept id=\"p1\">*</ept> file and save it to a known location (here assumed to be <bpt id=\"p2\">*</bpt>C:\\temp\\pipelinedef.json<ept id=\"p2\">*</ept>).",
      "pos": [
        17551,
        17716
      ]
    },
    {
      "content": "Create the pipeline in ADF with the following Azure PowerShell cmdlet.",
      "pos": [
        17717,
        17787
      ]
    },
    {
      "content": "Confirm that you can see the pipeline on the ADF in the Azure portal show up as following (when you click on the diagram)",
      "pos": [
        17908,
        18029
      ]
    },
    {
      "content": "<ph id=\"ph1\">&lt;a name=\"adf-pipeline-start\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Start the Pipeline",
      "pos": [
        18070,
        18121
      ]
    },
    {
      "content": "The pipeline can now be run using the following command:",
      "pos": [
        18122,
        18178
      ]
    },
    {
      "pos": [
        18354,
        18486
      ],
      "content": "The <bpt id=\"p1\">*</bpt>startdate<ept id=\"p1\">*</ept> and <bpt id=\"p2\">*</bpt>enddate<ept id=\"p2\">*</ept> parameter values need to be replaced with the actual dates between which you want the pipeline to run."
    },
    {
      "content": "Once the pipeline executes, you should be able to see the data show up in the container selected for the blob, one file per day.",
      "pos": [
        18488,
        18616
      ]
    },
    {
      "content": "Note that we have not leveraged the functionality provided by ADF to pipe data incrementally.",
      "pos": [
        18618,
        18711
      ]
    },
    {
      "content": "For more details on how to do this and other capabilities provided by ADF, see the <bpt id=\"p1\">[</bpt>ADF documentation<ept id=\"p1\">](http://azure.microsoft.com/services/data-factory/)</ept>.",
      "pos": [
        18712,
        18866
      ]
    },
    {
      "content": "test",
      "pos": [
        18871,
        18875
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"Move data from an on-premise SQL Server to SQL Azure with Azure Data Factory | Azure\" \n    description=\"Set up an ADF pipeline that composes two data migration activities that together move data on a daily basis between databases on-premise and in the cloud.\" \n    metaKeywords=\"\" \n    services=\"machine-learning\" \n    solutions=\"\" \n    documentationCenter=\"\" \n    authors=\"fashah\" \n    manager=\"jacob.spoelstra\" \n    editor=\"\" \n    videoId=\"\" \n    scriptId=\"\" />\n\n<tags \n    ms.service=\"machine-learning\" \n    ms.workload=\"data-services\" \n    ms.tgt_pltfrm=\"na\" \n    ms.devlang=\"na\" \n    ms.topic=\"article\" \n    ms.date=\"08/10/2015\" \n    ms.author=\"fashah;bradsev\" /> \n\n\n# Move data from an on-premise SQL server to SQL Azure with Azure Data Factory\n\nThis topic shows how to move data from an on-premise SQL Server Database to a SQL Azure Database via Azure Blob Storage using the Azure Data Factory (ADF). \n\n## <a name=\"intro\"></a>Introduction: What is ADF and when should it be used to migrate data?\n\nAzure Data Factory is a fully managed cloud-based data integration service that orchestrates and automates the movement and transformation of data. The key concept in the ADF model is pipeline. A pipelines is a logical groupings of Activities, each of which defines the actions to perform on the data contained in Datasets. Linked services are used to define the information needed for Data Factory to connect to the data resources.\n\nWith ADF, existing data processing services can be composed into data pipelines that are highly available and managed in the cloud. These data pipelines can be scheduled to ingest, prepare, transform, analyze, and publish data, and ADF will manage and orchestrate all of the complex data and processing dependencies. Solutions can be quickly built and deployed in the cloud, connecting a growing number of on-premises and cloud data sources.\n\nConsider using ADF when data needs to be continually migrated in a hybrid scenario that accesses both on-premise and cloud resources, and when the data is transacted or needs to be modified or have business logic added to it in the course of being migrated. ADF allows for the scheduling and monitoring of jobs using simple JSON scripts that manage the movement of data on a periodic basis. ADF also has other capabilities such as support for complex operations. For more information on ADF, see the documentation at [Azure Data Factory (ADF)](http://azure.microsoft.com/services/data-factory/).\n\n## <a name=\"scenario\"></a>The Scenario\n\nWe set up an ADF pipeline that composes two data migration activities that together move data on a daily basis between an on-premise SQL database and an Azure SQL Database in the cloud. The two activities are:\n\n* copy data from an on-premise SQL Server database to an Azure Blob Storage account \n* copy data from the Azure Blob Storage account to an Azure SQL Database.\n\n**Reference**: The steps shown here have been adapted from the more detailed tutorial [Enable your pipelines to work with on-premises data](data-factory-use-onpremises-datasources.md) provided by the ADF team and references to the relevant sections of that topic are provided when appropriate.\n\n\n## <a name=\"prereqs\"></a>Prerequisites\nThis tutorial assumes you have:\n\n* An **Azure subscription**. If you do not have a subscription, you can sign up for a [free trial](https://azure.microsoft.com/pricing/free-trial/).\n* An **Azure storage account**. You will use an Azure storage account for storing the data in this tutorial. If you don't have an Azure storage account, see the [Create a storage account](storage-create-storage-account.md#create-a-storage-account) article. After you have created the storage account, you will need to obtain the account key used to access the storage. See [View, copy and regenerate storage access keys](storage-create-storage-account.md#view-copy-and-regenerate-storage-access-keys).\n* Access to an **Azure SQL Database**. If you must setup an Azure SQL Database, [Getting Started with Microsoft Azure SQL Database ](sql-database-get-started.md) provides information on how to provision a new instance of a Azure SQL Database.\n* Installed and configured **Azure PowerShell** locally. For instructions, see [How to install and configure Azure PowerShell](powershell-install-configure.md).\n\n> [AZURE.NOTE] This procedure uses the [Azure preview portal](https://ms.portal.azure.com/).\n\n##<a name=\"upload-data\"></a> Upload the data to your on-premise SQL Server \n\nWe use the [NYC Taxi dataset](http://chriswhong.com/open-data/foil_nyc_taxi/) to demonstrate the migration process. The NYC Taxi dataset is available, as noted that post, on Azure blob storage [here](http://www.andresmh.com/nyctaxitrips/). The data has two files, the trip_data.csv file which contains trip details and the  trip_far.csv file which contains details of the fare paid for each trip. A sample and description of these files are provided in [NYC Taxi Trips Dataset Description](machine-learning-data-science-process-sql-walkthrough.md#dataset).\n \n\nYou can either adapt the procedure provided here to a set of your own data or follow the steps as described by using the NYC Taxi dataset. To upload the NYC Taxi dataset into your on-premise SQL Server database, follow the procedure outlined in [Bulk Import Data into SQL Server Database](machine-learning-data-science-process-sql-walkthrough.md#dbload). These instructions are for a SQL Server on an Azure Virtual Machine, but the procedure for uploading to the on-premise SQL Server is the same.\n\n##<a name=\"create-adf\"></a> Create an Azure Data Factory\n\nThe instructions for creating a new Azure Data Factory and a resource group in the [Azure preview portal](https://ms.portal.azure.com/) are provided [here](data-factory-build-your-first-pipeline-using-editor.md#step-1-creating-the-data-factory). Name the new ADF instance *adfdsp* and name the resource group created *adfdsprg*.\n\n## Install and configure up the Data Management Gateway\n\nTo enable your pipelines in an Azure data factory to work with an on-premise SQL Server, you need to add it as a linked service to the data factory. To create a Linked Service for the on-premise SQL Server, you must first download and install Microsoft Data Management Gateway onto the on-premise computer and configure the linked service for the on-premises data source to use the gateway. The Data Management Gateway serializes and deserializes the source and sink data on the computer where it is hosted. \n\nFor set-up instructions and details on Data Management Gateway, see [Enable your pipelines to work with on-premises data](data-factory-use-onpremises-datasources.md)\n\n\n## <a name=\"adflinkedservices\"></a>Create linked services to connect to the data resources \n\nA linked service defines the information needed for Azure Data Factory to connect to a data resource. The step-by-step procedure for creating linked services is provided in [Create linked services](data-factory-use-onpremises-datasources.md#step-2-create-linked-services). \n\nWe have three resources in this scenario for which linked services are needed.\n\n1. [Linked service for on-premise SQL Server](#adf-linked-service-onprem-sql)\n2. [Linked service for Azure Blob Storage](#adf-linked-service-blob-store)\n3. [Linked service for Azure SQL database](#adf-linked-service-azure-sql)\n\n\n###<a name=\"adf-linked-service-onprem-sql\"></a>Linked service for on-premise SQL Server database\nTo create the linked service for the on-premise SQL Server, click on the **Data Store** in the ADF landing page on Azure Portal, select *SQL* and enter the credentials for the *username* and *password* for the on-premise SQL Server. You need to enter the servername as a **fully qualified servername backslash instance name (servername\\instancename)**. Name the linked service *adfonpremsql*.\n\n###<a name=\"adf-linked-service-blob-store\"></a>Linked service for Blob\nTo create the linked service for the Azure Blob Storage account, click on the **Data Store** in the ADF landing page on Azure Portal, select *Azure Storage Account* and enter the Azure Blob Storage account key and container name. Name the link service *adfds*.\n\n###<a name=\"adf-linked-service-azure-sql\"></a>Linked service for Azure SQL database\nTo create the linked service for the Azure SQL Database, click on the **Data Store** in the ADF landing page on Azure Portal, select *Azure SQL* and enter the credentials for the *username* and *password* for the Azure SQL Database. The *username* must be specified as *user@servername*.   \n\n\n##<a name=\"adf-tables\"></a>Define and create tables to specify how to access the datasets\n\nCreate tables that specify the structure, location and availability of the datasets with the following script-based procedures. JSON files are used to define the tables. For more information on the structure of these files, see [Datasets](data-factory-create-datasets.md).\n\n> [AZURE.NOTE]  You should execute `Switch-AzureMode -Name AzureResourceManager` and the `Add-AzureAccount` cmdlets prior to executing the [New-AzureDataFactoryTable](https://msdn.microsoft.com/library/azure/dn835096.aspx) cmdlet to confirm that the Azure PowerShell cmdlets are available and that the right Azure subscription is selected for the command execution. For documentation of these cmdlets, see [Switch-AzureMode](https://msdn.microsoft.com/library/dn722470.aspx) and [Add-AzureAccoun](https://msdn.microsoft.com/library/azure/dn790372.aspx).\n \nThe JSON-based definitions in the tables use the following names: \n\n* the **table name** in the on-premise SQL server is *nyctaxi_data*\n* the **container name** in the Azure Blob Storage account is *containername*  \n\nThree table definitions are needed for this ADF pipeline:\n\n1. [SQL on-premise Table](#adf-table-onprem-sql)\n2. [Blob Table ](#adf-table-blob-store)\n3. [SQL Azure Table](#adf-table-azure-sql)\n\n> [AZURE.NOTE]  The following procedures use Azure PowerShell to define and create the ADF activities. But these tasks can also be accomplished using the Azure preview portal. For details, see [Create input and output datasets](data-factory-use-onpremises-datasources.md#step-3-create-input-and-output-datasets).\n\n###<a name=\"adf-table-onprem-sql\"></a>SQL on-premise Table\n\nThe table definition for the on-premise SQL Server is specified in the following JSON file. \n\n        {\n            \"name\": \"OnPremSQLTable\",\n            \"properties\":\n            {\n                \"location\":\n                {\n                \"type\": \"OnPremisesSqlServerTableLocation\",\n                \"tableName\": \"nyctaxi_data\",\n                \"linkedServiceName\": \"adfonpremsql\"\n                },\n                \"availability\": \n                {\n                \"frequency\": \"Day\",\n                \"interval\": 1,   \n                \"waitOnExternal\":\n                {\n                \"retryInterval\": \"00:01:00\",\n                \"retryTimeout\": \"00:10:00\",\n                \"maximumRetry\": 3\n                }\n                \n                }\n            }\n        }\nNote that the column names were not included here, you can sub-select on the column names by including them here (for details please check the [ADF documentation](data-factory-copy-activity.md)).\n\nCopy the JSON definition of the table into a file called *onpremtabledef.json* file and save it to a known location (here assumed to be *C:\\temp\\onpremtabledef.json*). Create the table in ADF with the following Azure PowerShell cmdlet.\n\n    New-AzureDataFactoryTable -ResourceGroupName ADFdsprg -DataFactoryName ADFdsp –File C:\\temp\\onpremtabledef.json\n\n\n###<a name=\"adf-table-blob-store\"></a>Blob Table\nDefinition for the table for the output blob location is in the following (this maps the ingested data from on-premise to Azure blob):\n\n        {\n            \"name\": \"OutputBlobTable\",\n            \"properties\":\n            {\n                \"location\": \n                {\n                \"type\": \"AzureBlobLocation\",\n                \"folderPath\": \"containername\",\n                \"format\":\n                {\n                \"type\": \"TextFormat\",\n                \"columnDelimiter\": \"\\t\"\n                },\n                \"linkedServiceName\": \"adfds\"\n                },\n                \"availability\": \n                {\n                \"frequency\": \"Day\",\n                \"interval\": 1\n                }\n            }\n        }\n \nCopy the JSON definition of the table into a file called *bloboutputtabledef.json* file and save it to a known location (here assumed to be *C:\\temp\\bloboutputtabledef.json*). Create the table in ADF with the following Azure PowerShell cmdlet.\n\n    New-AzureDataFactoryTable -ResourceGroupName adfdsprg -DataFactoryName adfdsp -File C:\\temp\\bloboutputtabledef.json  \n\n###<a name=\"adf-table-azure-sq\"></a>SQL Azure Table\nDefinition for the table for the SQL Azure output is in the following (this schema maps the data coming from the blob):\n\n    {\n        \"name\": \"OutputSQLAzureTable\",\n        \"properties\":\n        {\n            \"structure\":\n            [\n                { \"name\": \"column1\", type\": \"String\"},\n                { \"name\": \"column2\", type\": \"String\"}                \n            ],\n            \"location\":\n            {\n                \"type\": \"AzureSqlTableLocation\",\n                \"tableName\": \"your_db_name\",\n                \"linkedServiceName\": \"adfdssqlazure_linked_servicename\"\n            },\n            \"availability\": \n            {\n                \"frequency\": \"Day\",\n                \"interval\": 1            \n            }\n        }\n    }\n  \nCopy the JSON definition of the table into a file called *AzureSqlTable.json* file and save it to a known location (here assumed to be *C:\\temp\\AzureSqlTable.json*). Create the table in ADF with the following Azure PowerShell cmdlet.\n\n    New-AzureDataFactoryTable -ResourceGroupName adfdsprg -DataFactoryName adfdsp -File C:\\temp\\AzureSqlTable.json  \n\n##<a name=\"adf-pipeline\"></a>Define and create the pipeline\n\nSpecify the activities that belong to the pipeline and create the pipeline with the following script-based procedures. A JSON file is used to define the pipeline properties. \n\n* The script assumes that the **pipeline name** is *AMLDSProcessPipeline*.\n* Also note that we set the periodicity of the pipeline to be executed on daily basis and use the default execution time for the job (12 am UTC).\n\n> [AZURE.NOTE]  The following procedures use Azure PowerShell to define and create the ADF pipeline. But this task can also be accomplished using the Azure preview portal. For details, see [Create and run a pipeline](data-factory-use-onpremises-datasources.md#step-4-create-and-run-a-pipeline).\n\nUsing the table definitions provided above, the pipeline definition for the ADF is specified as follows:\n    \n        {\n            \"name\": \"AMLDSProcessPipeline\",\n            \"properties\":\n            {\n                \"description\" : \"This pipeline has one Copy activity that copies data from an on-premise SQL to Azure blob\",\n                 \"activities\":\n                [\n                    {\n                        \"name\": \"CopyFromSQLtoBlob\",\n                        \"description\": \"Copy data from on-premise SQL server to blob\",     \n                        \"type\": \"CopyActivity\",\n                        \"inputs\": [ {\"name\": \"OnPremSQLTable\"} ],\n                        \"outputs\": [ {\"name\": \"OutputBlobTable\"} ],\n                        \"transformation\":\n                        {\n                            \"source\":\n                            {                               \n                                \"type\": \"SqlSource\",\n                                \"sqlReaderQuery\": \"select * from nyctaxi_data\"\n                            },\n                            \"sink\":\n                            {\n                                \"type\": \"BlobSink\"\n                            }   \n                        },\n                        \"Policy\":\n                        {\n                            \"concurrency\": 3,\n                            \"executionPriorityOrder\": \"NewestFirst\",\n                            \"style\": \"StartOfInterval\",\n                            \"retry\": 0,\n                            \"timeout\": \"01:00:00\"\n                        }       \n        \n                     },\n\n                    {\n                        \"name\": \"CopyFromBlobtoSQLAzure\",\n                        \"description\": \"Push data to Sql Azure\",        \n                        \"type\": \"CopyActivity\",\n                        \"inputs\": [ {\"name\": \"OutputBlobTable\"} ],\n                        \"outputs\": [ {\"name\": \"OutputSQLAzureTable\"} ], \n                        \"transformation\":\n                        {\n                            \"source\":\n                            {                               \n                                \"type\": \"BlobSource\"\n                            },\n                            \"sink\":\n                            {\n                                \"type\": \"SqlSink\",\n                                \"WriteBatchTimeout\": \"00:5:00\",             \n                            }           \n                        },\n                        \"Policy\":\n                        {\n                            \"concurrency\": 3,\n                            \"executionPriorityOrder\": \"NewestFirst\",\n                            \"style\": \"StartOfInterval\",\n                            \"retry\": 2,\n                            \"timeout\": \"02:00:00\"\n                        }\n                     }\n                ]\n            }\n        }\n\nCopy this JSON definition of the pipeline into a file called *pipelinedef.json* file and save it to a known location (here assumed to be *C:\\temp\\pipelinedef.json*). Create the pipeline in ADF with the following Azure PowerShell cmdlet.\n\n    New-AzureDataFactoryPipeline  -ResourceGroupName adfdsprg -DataFactoryName adfdsp -File C:\\temp\\pipelinedef.json \n\nConfirm that you can see the pipeline on the ADF in the Azure portal show up as following (when you click on the diagram)\n\n![](http://i.imgur.com/DJP1kji.png)\n\n##<a name=\"adf-pipeline-start\"></a>Start the Pipeline\nThe pipeline can now be run using the following command:\n\n    Set-AzureDataFactoryPipelineActivePeriod -ResourceGroupName ADFdsprg -DataFactoryName ADFdsp -StartDateTime startdateZ –EndDateTime enddateZ –Name AMLDSProcessPipeline \n\nThe *startdate* and *enddate* parameter values need to be replaced with the actual dates between which you want the pipeline to run.\n\nOnce the pipeline executes, you should be able to see the data show up in the container selected for the blob, one file per day.\n\nNote that we have not leveraged the functionality provided by ADF to pipe data incrementally. For more details on how to do this and other capabilities provided by ADF, see the [ADF documentation](http://azure.microsoft.com/services/data-factory/). \n\n\n\ntest\n"
}