{
  "nodes": [
    {
      "content": "How to generate and transfer HSM-protected keys for Azure Key Vault | Microsoft Azure",
      "pos": [
        27,
        112
      ]
    },
    {
      "content": "Use this article to help you plan for, generate, and then transfer your own HSM-protected keys to use with Azure Key Vault.",
      "pos": [
        131,
        254
      ]
    },
    {
      "content": "How to generate and transfer HSM-protected keys for Azure Key Vault",
      "pos": [
        571,
        638
      ]
    },
    {
      "content": "Introduction",
      "pos": [
        642,
        654
      ]
    },
    {
      "content": "For added assurance, when you use Azure Key Vault, you can import or generate keys in hardware security modules (HSMs) that never leave the HSM boundary.",
      "pos": [
        656,
        809
      ]
    },
    {
      "content": "This scenario is often referred to as <bpt id=\"p1\">*</bpt>bring your own key<ept id=\"p1\">*</ept>, or BYOK.",
      "pos": [
        810,
        878
      ]
    },
    {
      "content": "The HSMs are FIPS 140-2 Level 2 validated.",
      "pos": [
        879,
        921
      ]
    },
    {
      "content": "Azure Key Vault uses Thales nShield family of HSMs to protect your keys.",
      "pos": [
        922,
        994
      ]
    },
    {
      "content": "Use the information in this topic to help you plan for, generate and then transfer your own HSM-protected keys to use with Azure Key Vault.",
      "pos": [
        996,
        1135
      ]
    },
    {
      "pos": [
        1139,
        1247
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> For more information about Azure Key Vault, see <bpt id=\"p1\">[</bpt>What is Azure Key Vault?<ept id=\"p1\">](key-vault-whatis.md)</ept>"
    },
    {
      "pos": [
        1253,
        1410
      ],
      "content": "For a getting started tutorial, which includes creating a key vault for HSM-protected keys, see <bpt id=\"p1\">[</bpt>Get started with Azure Key Vault<ept id=\"p1\">](key-vault-get-started.md)</ept>."
    },
    {
      "content": "More information about generating and transferring an HSM-protected key over the Internet:",
      "pos": [
        1412,
        1502
      ]
    },
    {
      "content": "You generate the key from an offline workstation, which reduces the attack surface.",
      "pos": [
        1506,
        1589
      ]
    },
    {
      "content": "The key is encrypted with a Key Exchange Key (KEK), which stays encrypted until it is transferred to the Azure Key Vault HSMs.",
      "pos": [
        1593,
        1719
      ]
    },
    {
      "content": "Only the encrypted version of your key leaves the original workstation.",
      "pos": [
        1720,
        1791
      ]
    },
    {
      "content": "The toolset sets properties on your tenant key that binds your key to the Azure Key Vault security world.",
      "pos": [
        1795,
        1900
      ]
    },
    {
      "content": "So after the Azure Key Vault HSMs receive and decrypt your key, only these HSMs can use it.",
      "pos": [
        1901,
        1992
      ]
    },
    {
      "content": "Your key cannot be exported.",
      "pos": [
        1993,
        2021
      ]
    },
    {
      "content": "This binding is enforced by the Thales HSMs.",
      "pos": [
        2022,
        2066
      ]
    },
    {
      "content": "The Key Exchange Key (KEK) that is used to encrypt your key is generated inside the Azure Key Vault HSMs and is not exportable.",
      "pos": [
        2070,
        2197
      ]
    },
    {
      "content": "The HSMs enforce that there can be no clear version of the KEK outside the HSMs.",
      "pos": [
        2198,
        2278
      ]
    },
    {
      "content": "In addition, the toolset includes attestation from Thales that the KEK is not exportable and was generated inside a genuine HSM that was manufactured by Thales.",
      "pos": [
        2279,
        2439
      ]
    },
    {
      "content": "The toolset includes attestation from Thales that the Azure Key Vault security world was also generated on a genuine HSM manufactured by Thales.",
      "pos": [
        2443,
        2587
      ]
    },
    {
      "content": "This proves to you that Microsoft is using genuine hardware.",
      "pos": [
        2588,
        2648
      ]
    },
    {
      "content": "Microsoft uses separate KEKs as well as separate Security Worlds in each geographical region, which ensures that your key can be used only in data centers in the region in which you encrypted it.",
      "pos": [
        2652,
        2847
      ]
    },
    {
      "content": "For example, a key from a European customer cannot be used in data centers in North American or Asia.",
      "pos": [
        2848,
        2949
      ]
    },
    {
      "content": "More information about Thales HSMs and Microsoft services",
      "pos": [
        2953,
        3010
      ]
    },
    {
      "content": "Thales e-Security is a leading global provider of data encryption and cyber security solutions to the financial services, high technology, manufacturing, government, and technology sectors.",
      "pos": [
        3012,
        3201
      ]
    },
    {
      "content": "With a 40-year track record of protecting corporate and government information, Thales solutions are used by four of the five largest energy and aerospace companies, 22 NATO countries, and secure more than 80 per cent of worldwide payment transactions.",
      "pos": [
        3202,
        3454
      ]
    },
    {
      "content": "Microsoft has collaborated with Thales to enhance the state of art for HSMs.",
      "pos": [
        3456,
        3532
      ]
    },
    {
      "content": "These enhancements enable you to get the typical benefits of hosted services without relinquishing control over your keys.",
      "pos": [
        3533,
        3655
      ]
    },
    {
      "content": "Specifically, these enhancements let Microsoft manage the HSMs so that you do not have to.",
      "pos": [
        3656,
        3746
      ]
    },
    {
      "content": "As a cloud service, Azure Key Vault scales up at short notice to meet your organization’s usage spikes.",
      "pos": [
        3747,
        3850
      ]
    },
    {
      "content": "At the same time, your key is protected inside Microsoft’s HSMs: You retain control over the key lifecycle because you generate the key and transfer it to Microsoft’s HSMs.",
      "pos": [
        3851,
        4023
      ]
    },
    {
      "content": "Implementing bring your own key (BYOK) for Azure Key Vault",
      "pos": [
        4027,
        4085
      ]
    },
    {
      "content": "Use the following information and procedures if you will generate your own HSM-protected key and then transfer it to Azure Key Vault—the bring your own key (BYOK) scenario.",
      "pos": [
        4087,
        4259
      ]
    },
    {
      "content": "Prerequisites for BYOK",
      "pos": [
        4264,
        4286
      ]
    },
    {
      "content": "See the following table for a list of prerequisites for bring your own key (BYOK) for Azure Key Vault.",
      "pos": [
        4288,
        4390
      ]
    },
    {
      "content": "Requirement",
      "pos": [
        4393,
        4404
      ]
    },
    {
      "content": "More information",
      "pos": [
        4405,
        4421
      ]
    },
    {
      "content": "A subscription to Azure",
      "pos": [
        4434,
        4457
      ]
    },
    {
      "pos": [
        4458,
        4592
      ],
      "content": "To create an Azure Key Vault, you need an Azure subscription: <bpt id=\"p1\">[</bpt>Sign up for free trial<ept id=\"p1\">](http://azure.microsoft.com/pricing/free-trial/)</ept>"
    },
    {
      "content": "An Azure Key Vault that supports HSMs",
      "pos": [
        4595,
        4632
      ]
    },
    {
      "pos": [
        4633,
        4813
      ],
      "content": "For more information about the service tiers and capabilities for Azure Key Vault, see the <bpt id=\"p1\">[</bpt>Azure Key Vault Pricing<ept id=\"p1\">](http://azure.microsoft.com/pricing/details/key-vault/)</ept> website."
    },
    {
      "content": "Thales HSM, smartcards, and support software",
      "pos": [
        4816,
        4860
      ]
    },
    {
      "content": "You must have access to a Thales Hardware Security Module and basic operational knowledge of Thales HSMs.",
      "pos": [
        4861,
        4966
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>Thales Hardware Security Module<ept id=\"p1\">](https://www.thales-esecurity.com/msrms/buy)</ept> for the list of compatible models, or to purchase an HSM if you do not have one.",
      "pos": [
        4967,
        5129
      ]
    },
    {
      "content": "The following hardware and software:",
      "pos": [
        5132,
        5168
      ]
    },
    {
      "content": "An offline x64 workstation with a minimum Windows operation system of Windows 7 and Thales nShield software that is at least version 11.50.",
      "pos": [
        5176,
        5315
      ]
    },
    {
      "content": "If this workstation runs Windows 7, you must <bpt id=\"p1\">[</bpt>install Microsoft .NET Framework 4.5<ept id=\"p1\">](http://download.microsoft.com/download/b/a/4/ba4a7e71-2906-4b2d-a0e1-80cf16844f5f/dotnetfx45_full_x86_x64.exe)</ept>.",
      "pos": [
        5325,
        5520
      ]
    },
    {
      "content": "A workstation that is connected to the Internet and has a minimum Windows operation system of Windows 7.",
      "pos": [
        5529,
        5633
      ]
    },
    {
      "content": "A USB drive or other portable storage device that has at least 16 MB free space.",
      "pos": [
        5642,
        5722
      ]
    },
    {
      "content": "For security reasons, we recommend that the first workstation is not connected to a network.",
      "pos": [
        5733,
        5825
      ]
    },
    {
      "content": "However, this is not programmatically enforced.",
      "pos": [
        5826,
        5873
      ]
    },
    {
      "content": "Note that in the instructions that follow, this workstation is referred to as the disconnected workstation.",
      "pos": [
        5883,
        5990
      ]
    },
    {
      "content": "In addition, if your tenant key is for a production network, we recommend that you use a second, separate workstation to download the toolset and upload the tenant key.",
      "pos": [
        6012,
        6180
      ]
    },
    {
      "content": "But for testing purposes, you can use the same workstation as the first one.",
      "pos": [
        6181,
        6257
      ]
    },
    {
      "content": "Note that in the instructions that follow, this second workstation is referred to as the Internet-connected workstation.",
      "pos": [
        6267,
        6387
      ]
    },
    {
      "content": "Generate and transfer your key to Azure Key Vault HSM",
      "pos": [
        6414,
        6467
      ]
    },
    {
      "content": "You will use the following 5 steps to generate and transfer your key to an Azure Key Vault HSM:",
      "pos": [
        6469,
        6564
      ]
    },
    {
      "content": "Step 1: Prepare your Internet-connected workstation",
      "pos": [
        6570,
        6621
      ]
    },
    {
      "content": "Step 2: Prepare your disconnected workstation",
      "pos": [
        6679,
        6724
      ]
    },
    {
      "content": "Step 3: Generate your key",
      "pos": [
        6776,
        6801
      ]
    },
    {
      "content": "Step 4: Prepare your key for transfer",
      "pos": [
        6833,
        6870
      ]
    },
    {
      "content": "Step 5: Transfer your key to Azure Key Vault",
      "pos": [
        6914,
        6958
      ]
    },
    {
      "content": "Step 1: Prepare your Internet-connected workstation",
      "pos": [
        7010,
        7061
      ]
    },
    {
      "content": "For this first step, do the following procedures on your workstation that is connected to the Internet.",
      "pos": [
        7062,
        7165
      ]
    },
    {
      "content": "Step 1.1: Install Azure PowerShell",
      "pos": [
        7171,
        7205
      ]
    },
    {
      "content": "From the Internet-connected workstation, download and install the Azure PowerShell module that includes the cmdlets to manage Azure Key Vault.",
      "pos": [
        7207,
        7349
      ]
    },
    {
      "content": "This requires a minimum version of  0.8.13.",
      "pos": [
        7350,
        7393
      ]
    },
    {
      "pos": [
        7395,
        7514
      ],
      "content": "For installation instructions, see <bpt id=\"p1\">[</bpt>How to install and configure Azure PowerShell<ept id=\"p1\">](../powershell-install-configure.md)</ept>."
    },
    {
      "content": "Step 1.2: Get your Azure subscription ID",
      "pos": [
        7519,
        7559
      ]
    },
    {
      "content": "Start an Azure PowerShell session and sign in to your Azure account by using the following command:",
      "pos": [
        7561,
        7660
      ]
    },
    {
      "content": "In the pop-up browser window, enter your Azure account user name and password.",
      "pos": [
        7687,
        7765
      ]
    },
    {
      "content": "Then, use the <bpt id=\"p1\">[</bpt>Get-AzureSubscription<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/dn790366.aspx)</ept> command:",
      "pos": [
        7766,
        7868
      ]
    },
    {
      "content": "From the output, locate the ID for the subscription you will use for Azure Key Vault.",
      "pos": [
        7900,
        7985
      ]
    },
    {
      "content": "You will need this subscription ID later.",
      "pos": [
        7986,
        8027
      ]
    },
    {
      "content": "Do not close the Azure PowerShell window.",
      "pos": [
        8029,
        8070
      ]
    },
    {
      "content": "Step 1.3: Download the BYOK toolset for Azure Key Vault",
      "pos": [
        8075,
        8130
      ]
    },
    {
      "pos": [
        8132,
        8289
      ],
      "content": "Go to the Microsoft Download Center and <bpt id=\"p1\">[</bpt>download the Azure Key Vault BYOK toolset<ept id=\"p1\">](http://www.microsoft.com/download/details.aspx?id=45345)</ept> for your region:"
    },
    {
      "content": "Region",
      "pos": [
        8292,
        8298
      ]
    },
    {
      "content": "Package name",
      "pos": [
        8299,
        8311
      ]
    },
    {
      "content": "SHA-256 package hash",
      "pos": [
        8312,
        8332
      ]
    },
    {
      "content": "North America",
      "pos": [
        8349,
        8362
      ]
    },
    {
      "content": "KeyVault-BYOK-Tools-UnitedStates.zip",
      "pos": [
        8363,
        8399
      ]
    },
    {
      "content": "D9FDA9F5A34E1388CD6C9138E5B75B7051FB7D6B11F087AFE0553DC85CCF0E36",
      "pos": [
        8400,
        8464
      ]
    },
    {
      "content": "Europe",
      "pos": [
        8467,
        8473
      ]
    },
    {
      "content": "KeyVault-BYOK-Tools-Europe.zip",
      "pos": [
        8474,
        8504
      ]
    },
    {
      "content": "881DCA798305B8408C06BAE7B3EFBC1E9EA6113A8D6EC443464F3744896F32C3",
      "pos": [
        8505,
        8569
      ]
    },
    {
      "content": "Asia",
      "pos": [
        8572,
        8576
      ]
    },
    {
      "content": "KeyVault-BYOK-Tools-AsiaPacific.zip",
      "pos": [
        8577,
        8612
      ]
    },
    {
      "content": "0C76967B3AC76687E4EA47EB96174EE6B25AB24E3114E28A90D9B93A2E6ABF6E",
      "pos": [
        8613,
        8677
      ]
    },
    {
      "content": "Latin America",
      "pos": [
        8680,
        8693
      ]
    },
    {
      "content": "KeyVault-BYOK-Tools-LatinAmerica.zip",
      "pos": [
        8694,
        8730
      ]
    },
    {
      "content": "B38015990D4D1E522B8367FF78E78E0234BF9592663470426088C44C3CAAAF48",
      "pos": [
        8731,
        8795
      ]
    },
    {
      "pos": [
        8798,
        8976
      ],
      "content": "To validate the integrity of your downloaded BYOK toolset, from your Azure PowerShell session, use the <bpt id=\"p1\">[</bpt>Get-FileHash<ept id=\"p1\">](https://technet.microsoft.com/library/dn520872.aspx)</ept> cmdlet."
    },
    {
      "content": "The toolset includes the following:",
      "pos": [
        9022,
        9057
      ]
    },
    {
      "pos": [
        9061,
        9143
      ],
      "content": "A Key Exchange Key (KEK) package that has a name beginning with <bpt id=\"p1\">**</bpt>BYOK-KEK-pkg-.<ept id=\"p1\">**</ept>"
    },
    {
      "pos": [
        9146,
        9230
      ],
      "content": "A Security World package that has a name beginning with <bpt id=\"p1\">**</bpt>BYOK-SecurityWorld-pkg-.<ept id=\"p1\">**</ept>"
    },
    {
      "pos": [
        9233,
        9279
      ],
      "content": "A python script named v<bpt id=\"p1\">**</bpt>erifykeypackage.py.<ept id=\"p1\">**</ept>"
    },
    {
      "pos": [
        9282,
        9365
      ],
      "content": "A command-line executable file named <bpt id=\"p1\">**</bpt>KeyTransferRemote.exe<ept id=\"p1\">**</ept> and associated DLLs."
    },
    {
      "pos": [
        9368,
        9433
      ],
      "content": "A Visual C++ Redistributable Package, named <bpt id=\"p1\">**</bpt>vcredist_x64.exe.<ept id=\"p1\">**</ept>"
    },
    {
      "content": "Copy the package to a USB drive or other portable storage.",
      "pos": [
        9435,
        9493
      ]
    },
    {
      "content": "Step 2: Prepare your disconnected workstation",
      "pos": [
        9497,
        9542
      ]
    },
    {
      "content": "For this second step, do the following procedures on the workstation that is not connected to a network (either the Internet or your internal network).",
      "pos": [
        9544,
        9695
      ]
    },
    {
      "content": "Step 2.1: Prepare the disconnected workstation with Thales HSM",
      "pos": [
        9701,
        9763
      ]
    },
    {
      "content": "Install the nCipher (Thales) support software on a Windows computer, and then attach a Thales HSM to that computer.",
      "pos": [
        9765,
        9880
      ]
    },
    {
      "content": "Ensure that the Thales tools are in your path (<bpt id=\"p1\">**</bpt>%nfast_home%\\bin<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>%nfast_home%\\python\\bin<ept id=\"p2\">**</ept>).",
      "pos": [
        9883,
        9984
      ]
    },
    {
      "content": "For example, type the following:",
      "pos": [
        9985,
        10017
      ]
    },
    {
      "content": "For more information, see the user guide included with the Thales HSM.",
      "pos": [
        10089,
        10159
      ]
    },
    {
      "content": "Step 2.2: Install the BYOK toolset on the disconnected workstation",
      "pos": [
        10164,
        10230
      ]
    },
    {
      "content": "Copy the BYOK toolset package from the USB drive or other portable storage, and then do the following:",
      "pos": [
        10232,
        10334
      ]
    },
    {
      "content": "Extract the files from the downloaded package into any folder.",
      "pos": [
        10339,
        10401
      ]
    },
    {
      "content": "From that folder, run vcredist_x64.exe.",
      "pos": [
        10405,
        10444
      ]
    },
    {
      "content": "Follow the instructions to the install the Visual C++ runtime components for Visual Studio 2012.",
      "pos": [
        10448,
        10544
      ]
    },
    {
      "content": "Step 3: Generate your key",
      "pos": [
        10548,
        10573
      ]
    },
    {
      "content": "For this third step, do the following procedures on the disconnected workstation.",
      "pos": [
        10575,
        10656
      ]
    },
    {
      "content": "Step 3.1: Create a security world",
      "pos": [
        10661,
        10694
      ]
    },
    {
      "content": "Start a command prompt and run the Thales new-world program.",
      "pos": [
        10696,
        10756
      ]
    },
    {
      "content": "This program creates a <bpt id=\"p1\">**</bpt>Security World<ept id=\"p1\">**</ept> file at %NFAST_KMDATA%\\local\\world, which corresponds to the C:\\ProgramData\\nCipher\\Key Management Data\\local folder.",
      "pos": [
        10854,
        11013
      ]
    },
    {
      "content": "You can use different values for the quorum but in our example, you’re prompted to enter three blank cards and pins for each one.",
      "pos": [
        11014,
        11143
      ]
    },
    {
      "content": "Then, any two cards will give full access to the security world.",
      "pos": [
        11144,
        11208
      ]
    },
    {
      "content": "These cards become the <bpt id=\"p1\">**</bpt>Administrator Card Set<ept id=\"p1\">**</ept> for the new security world.",
      "pos": [
        11209,
        11286
      ]
    },
    {
      "content": "Then do the following:",
      "pos": [
        11289,
        11311
      ]
    },
    {
      "content": "Back up the world file.",
      "pos": [
        11315,
        11338
      ]
    },
    {
      "content": "Secure and protect the world file, the Administrator Cards, and their pins, and make sure that no single person has access to more than one card.",
      "pos": [
        11339,
        11484
      ]
    },
    {
      "content": "Step 3.2: Validate the downloaded package",
      "pos": [
        11489,
        11530
      ]
    },
    {
      "content": "This step is optional but recommended so that you can validate the following:",
      "pos": [
        11532,
        11609
      ]
    },
    {
      "content": "The Key Exchange Key that is included in the toolset has been generated from a genuine Thales HSM.",
      "pos": [
        11613,
        11711
      ]
    },
    {
      "content": "The hash of the Security World that is included in the toolset has been generated in a genuine Thales HSM.",
      "pos": [
        11714,
        11820
      ]
    },
    {
      "content": "The Key Exchange Key is non-exportable.",
      "pos": [
        11823,
        11862
      ]
    },
    {
      "pos": [
        11865,
        12027
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph>To validate the downloaded package, the HSM must be connected, powered on, and must have a security world on it (such as the one you’ve just created)."
    },
    {
      "content": "To validate the downloaded package:",
      "pos": [
        12029,
        12064
      ]
    },
    {
      "content": "Run the verifykeypackage.py script by tying one of the following, depending on your region:",
      "pos": [
        12070,
        12161
      ]
    },
    {
      "content": "For North America:",
      "pos": [
        12168,
        12186
      ]
    },
    {
      "content": "For Europe:",
      "pos": [
        12285,
        12296
      ]
    },
    {
      "content": "For Asia:",
      "pos": [
        12395,
        12404
      ]
    },
    {
      "content": "For Latin America:",
      "pos": [
        12503,
        12521
      ]
    },
    {
      "content": "For Japan:",
      "pos": [
        12626,
        12636
      ]
    },
    {
      "pos": [
        12737,
        12810
      ],
      "content": "<ph id=\"ph1\">[AZURE.TIP]</ph>The Thales software includes python at %NFAST_HOME%\\python\\bin"
    },
    {
      "pos": [
        12820,
        12914
      ],
      "content": "Confirm that you see the following, which indicates successful validation: <bpt id=\"p1\">**</bpt>Result: SUCCESS<ept id=\"p1\">**</ept>"
    },
    {
      "content": "This script validates the signer chain up to the Thales root key.",
      "pos": [
        12916,
        12981
      ]
    },
    {
      "content": "The hash of this root key is embedded in the script and its value should be <bpt id=\"p1\">**</bpt>59178a47 de508c3f 291277ee 184f46c4 f1d9c639<ept id=\"p1\">**</ept>.",
      "pos": [
        12982,
        13107
      ]
    },
    {
      "content": "You can also confirm this value separately by visiting the <bpt id=\"p1\">[</bpt>Thales website<ept id=\"p1\">](http://www.thalesesec.com/)</ept>.",
      "pos": [
        13108,
        13212
      ]
    },
    {
      "content": "You’re now ready to create a new key.",
      "pos": [
        13214,
        13251
      ]
    },
    {
      "content": "Step 3.3: Create a new key",
      "pos": [
        13256,
        13282
      ]
    },
    {
      "pos": [
        13284,
        13343
      ],
      "content": "Generate a key by using the Thales <bpt id=\"p1\">**</bpt>generatekey<ept id=\"p1\">**</ept> program."
    },
    {
      "content": "Run the following command to generate the key:",
      "pos": [
        13345,
        13391
      ]
    },
    {
      "content": "When you run this command, use these instructions:",
      "pos": [
        13517,
        13567
      ]
    },
    {
      "content": "Replace the value of <bpt id=\"p1\">*</bpt>contosokey<ept id=\"p1\">*</ept> for the <bpt id=\"p2\">**</bpt>ident<ept id=\"p2\">**</ept> and <bpt id=\"p3\">**</bpt>plainname<ept id=\"p3\">**</ept> with any string value.",
      "pos": [
        13571,
        13663
      ]
    },
    {
      "content": "To minimize administrative overheads and reduce the risk of errors, we recommend that you use the same value for both.",
      "pos": [
        13664,
        13782
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>ident<ept id=\"p1\">**</ept> value must contain only numbers, dashes, and lower case letters.",
      "pos": [
        13783,
        13861
      ]
    },
    {
      "content": "The pubexp is left blank (default) in this example, but you can specify specific values.",
      "pos": [
        13865,
        13953
      ]
    },
    {
      "content": "For more information, see the Thales documentation.",
      "pos": [
        13954,
        14005
      ]
    },
    {
      "content": "This command creates a Tokenized Key file in your %NFAST_KMDATA%\\local folder with a name starting with <bpt id=\"p1\">**</bpt>key_simple_<ept id=\"p1\">**</ept> followed by the ident that was specified in the command.",
      "pos": [
        14007,
        14183
      ]
    },
    {
      "content": "For example: <bpt id=\"p1\">**</bpt>key_simple_contosokey<ept id=\"p1\">**</ept>.",
      "pos": [
        14184,
        14223
      ]
    },
    {
      "content": "This file contains an encrypted key.",
      "pos": [
        14224,
        14260
      ]
    },
    {
      "content": "Back up this Tokenized Key File in a safe location.",
      "pos": [
        14263,
        14314
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.IMPORTANT]</ph> When you later transfer your key to Azure Key Vault, Microsoft cannot export this key back to you so it becomes extremely important that you back up your key and security world safely.",
      "pos": [
        14317,
        14519
      ]
    },
    {
      "content": "Contact Thales for guidance and best practices for backing up your key.",
      "pos": [
        14520,
        14591
      ]
    },
    {
      "content": "You are now ready to transfer your key to Azure Key Vault.",
      "pos": [
        14593,
        14651
      ]
    },
    {
      "content": "Step 4: Prepare your key for transfer",
      "pos": [
        14655,
        14692
      ]
    },
    {
      "content": "For this fourth step, do the following procedures on the disconnected workstation.",
      "pos": [
        14694,
        14776
      ]
    },
    {
      "content": "Step 4.1: Create a copy of your key with reduced permissions",
      "pos": [
        14781,
        14841
      ]
    },
    {
      "content": "To reduce the permissions on your key, from a command prompt, run one of the following, depending on your region:",
      "pos": [
        14843,
        14956
      ]
    },
    {
      "content": "For North America:",
      "pos": [
        14960,
        14978
      ]
    },
    {
      "content": "For Europe:",
      "pos": [
        15160,
        15171
      ]
    },
    {
      "content": "For Asia:",
      "pos": [
        15353,
        15362
      ]
    },
    {
      "content": "For Latin America:",
      "pos": [
        15544,
        15562
      ]
    },
    {
      "content": "For Japan:",
      "pos": [
        15750,
        15760
      ]
    },
    {
      "pos": [
        15943,
        16120
      ],
      "content": "When you run this command, replace <bpt id=\"p1\">*</bpt>contosokey<ept id=\"p1\">*</ept> with the same value you specified in <bpt id=\"p2\">**</bpt>Step 3.3: Create a new key<ept id=\"p2\">**</ept> from the <bpt id=\"p3\">[</bpt>Generate your key<ept id=\"p3\">](#step-3-generate-your-key)</ept> step."
    },
    {
      "content": "You will be asked to plug in your security world admin cards.",
      "pos": [
        16122,
        16183
      ]
    },
    {
      "content": "When the command completes, you will see <bpt id=\"p1\">**</bpt>Result: SUCCESS<ept id=\"p1\">**</ept> and the copy of your key with reduced permissions will be in the file named key_xferacId_",
      "pos": [
        16185,
        16335
      ]
    },
    {
      "content": ".",
      "pos": [
        16347,
        16348
      ]
    },
    {
      "content": "Step 4.2: Inspect the new copy of the key",
      "pos": [
        16353,
        16394
      ]
    },
    {
      "content": "Optionally, run the Thales utilities to confirm the minimal permissions on the new key:",
      "pos": [
        16396,
        16483
      ]
    },
    {
      "content": "aclprint.py:",
      "pos": [
        16487,
        16499
      ]
    },
    {
      "content": "kmfile-dump.exe:",
      "pos": [
        16649,
        16665
      ]
    },
    {
      "pos": [
        16757,
        16933
      ],
      "content": "When you run these command, replace contosokey with the same value you specified in <bpt id=\"p1\">**</bpt>Step 3.3: Create a new key<ept id=\"p1\">**</ept> from the <bpt id=\"p2\">[</bpt>Generate your key<ept id=\"p2\">](#step-3-generate-your-key)</ept> step."
    },
    {
      "content": "Step 4.3: Encrypt your key by using Microsoft’s Key Exchange Key",
      "pos": [
        16938,
        17002
      ]
    },
    {
      "content": "Run one of the following commands, depending on your region:",
      "pos": [
        17004,
        17064
      ]
    },
    {
      "content": "For North America:",
      "pos": [
        17068,
        17086
      ]
    },
    {
      "content": "For Europe:",
      "pos": [
        17313,
        17324
      ]
    },
    {
      "content": "For Asia:",
      "pos": [
        17551,
        17560
      ]
    },
    {
      "content": "For Latin America:",
      "pos": [
        17787,
        17805
      ]
    },
    {
      "content": "For Japan:",
      "pos": [
        18038,
        18048
      ]
    },
    {
      "content": "When you run this command, use these instructions:",
      "pos": [
        18276,
        18326
      ]
    },
    {
      "pos": [
        18330,
        18500
      ],
      "content": "Replace <bpt id=\"p1\">*</bpt>contosokey<ept id=\"p1\">*</ept> with the identifier that you used to generate the key in <bpt id=\"p2\">**</bpt>Step 3.3: Create a new key<ept id=\"p2\">**</ept> from the <bpt id=\"p3\">[</bpt>Generate your key<ept id=\"p3\">](#step-3-generate-your-key)</ept> step."
    },
    {
      "content": "Replace <bpt id=\"p1\">*</bpt>SubscriptionID<ept id=\"p1\">*</ept> with the ID of the Azure subscription that contains your key vault.",
      "pos": [
        18504,
        18596
      ]
    },
    {
      "content": "You retrieved this value previously, in <bpt id=\"p1\">**</bpt>Step 1.2: Get your Azure subscription ID<ept id=\"p1\">**</ept> from the <bpt id=\"p2\">[</bpt>Prepare your Internet-connected workstation<ept id=\"p2\">](#step-1-prepare-your-internet-connected-workstation)</ept> step.",
      "pos": [
        18597,
        18795
      ]
    },
    {
      "pos": [
        18799,
        18885
      ],
      "content": "Replace <bpt id=\"p1\">*</bpt>ContosoFirstHSMKey<ept id=\"p1\">*</ept> with a label that will be used for your output file name."
    },
    {
      "pos": [
        18887,
        19073
      ],
      "content": "When this completes successfully it displays <bpt id=\"p1\">**</bpt>Result: SUCCESS<ept id=\"p1\">**</ept> and there will be a new file in the current folder that has the following name: TransferPackage-<bpt id=\"p2\">*</bpt>ContosoFirstHSMkey<ept id=\"p2\">*</ept>.byok"
    },
    {
      "content": "Step 4.4: Copy your key transfer package to the Internet-connected workstation",
      "pos": [
        19078,
        19156
      ]
    },
    {
      "content": "Use a USB drive or other portable storage to copy the output file from the previous step (KeyTransferPackage-ContosoFirstHSMkey.byok) to your Internet-connected workstation.",
      "pos": [
        19159,
        19332
      ]
    },
    {
      "content": "Step 5: Transfer your key to Azure Key Vault",
      "pos": [
        19336,
        19380
      ]
    },
    {
      "pos": [
        19382,
        19648
      ],
      "content": "For this final step, on the Internet-connected workstation, use the <bpt id=\"p1\">[</bpt>Add-AzureKeyVaultKey<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/dn868048.aspx)</ept> cmdlet to upload the key transfer package that you copied from the disconnected workstation to the Azure Key Vault HSM:"
    },
    {
      "content": "If the upload is successful, you see displayed the properties of the key that you just added.",
      "pos": [
        19812,
        19905
      ]
    },
    {
      "content": "Next steps",
      "pos": [
        19909,
        19919
      ]
    },
    {
      "content": "You can now use this HSM-protected key in your key vault.",
      "pos": [
        19921,
        19978
      ]
    },
    {
      "content": "For more information, see the <bpt id=\"p1\">**</bpt>If you want to use a hardware security module (HSM)<ept id=\"p1\">**</ept> section in the <bpt id=\"p2\">[</bpt>Getting started with Azure Key Vault<ept id=\"p2\">](key-vault-get-started.md)</ept> tutorial.",
      "pos": [
        19979,
        20154
      ]
    },
    {
      "content": "test",
      "pos": [
        20156,
        20160
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"How to generate and transfer HSM-protected keys for Azure Key Vault | Microsoft Azure\"\n    description=\"Use this article to help you plan for, generate, and then transfer your own HSM-protected keys to use with Azure Key Vault.\"\n    services=\"key-vault\"\n    documentationCenter=\"\"\n    authors=\"cabailey\"\n    manager=\"mbaldwin\"\n    tags=\"azure-resource-manager\"/>\n\n<tags\n    ms.service=\"key-vault\"\n    ms.workload=\"identity\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\" \n    ms.date=\"07/22/2015\"\n    ms.author=\"cabailey\"/>\n#How to generate and transfer HSM-protected keys for Azure Key Vault\n\n##Introduction\n\nFor added assurance, when you use Azure Key Vault, you can import or generate keys in hardware security modules (HSMs) that never leave the HSM boundary. This scenario is often referred to as *bring your own key*, or BYOK. The HSMs are FIPS 140-2 Level 2 validated. Azure Key Vault uses Thales nShield family of HSMs to protect your keys.\n\nUse the information in this topic to help you plan for, generate and then transfer your own HSM-protected keys to use with Azure Key Vault. \n\n>[AZURE.NOTE] For more information about Azure Key Vault, see [What is Azure Key Vault?](key-vault-whatis.md)  \n>\n>For a getting started tutorial, which includes creating a key vault for HSM-protected keys, see [Get started with Azure Key Vault](key-vault-get-started.md).\n\nMore information about generating and transferring an HSM-protected key over the Internet:\n\n- You generate the key from an offline workstation, which reduces the attack surface.\n\n- The key is encrypted with a Key Exchange Key (KEK), which stays encrypted until it is transferred to the Azure Key Vault HSMs. Only the encrypted version of your key leaves the original workstation.\n\n- The toolset sets properties on your tenant key that binds your key to the Azure Key Vault security world. So after the Azure Key Vault HSMs receive and decrypt your key, only these HSMs can use it. Your key cannot be exported. This binding is enforced by the Thales HSMs.\n\n- The Key Exchange Key (KEK) that is used to encrypt your key is generated inside the Azure Key Vault HSMs and is not exportable. The HSMs enforce that there can be no clear version of the KEK outside the HSMs. In addition, the toolset includes attestation from Thales that the KEK is not exportable and was generated inside a genuine HSM that was manufactured by Thales.\n\n- The toolset includes attestation from Thales that the Azure Key Vault security world was also generated on a genuine HSM manufactured by Thales. This proves to you that Microsoft is using genuine hardware.\n\n- Microsoft uses separate KEKs as well as separate Security Worlds in each geographical region, which ensures that your key can be used only in data centers in the region in which you encrypted it. For example, a key from a European customer cannot be used in data centers in North American or Asia.\n\n##More information about Thales HSMs and Microsoft services\n\nThales e-Security is a leading global provider of data encryption and cyber security solutions to the financial services, high technology, manufacturing, government, and technology sectors. With a 40-year track record of protecting corporate and government information, Thales solutions are used by four of the five largest energy and aerospace companies, 22 NATO countries, and secure more than 80 per cent of worldwide payment transactions.\n\nMicrosoft has collaborated with Thales to enhance the state of art for HSMs. These enhancements enable you to get the typical benefits of hosted services without relinquishing control over your keys. Specifically, these enhancements let Microsoft manage the HSMs so that you do not have to. As a cloud service, Azure Key Vault scales up at short notice to meet your organization’s usage spikes. At the same time, your key is protected inside Microsoft’s HSMs: You retain control over the key lifecycle because you generate the key and transfer it to Microsoft’s HSMs.\n\n##Implementing bring your own key (BYOK) for Azure Key Vault\n\nUse the following information and procedures if you will generate your own HSM-protected key and then transfer it to Azure Key Vault—the bring your own key (BYOK) scenario.\n\n\n##Prerequisites for BYOK\n\nSee the following table for a list of prerequisites for bring your own key (BYOK) for Azure Key Vault.\n\n|Requirement|More information|\n|---|---|\n|A subscription to Azure|To create an Azure Key Vault, you need an Azure subscription: [Sign up for free trial](http://azure.microsoft.com/pricing/free-trial/)|\n|An Azure Key Vault that supports HSMs|For more information about the service tiers and capabilities for Azure Key Vault, see the [Azure Key Vault Pricing](http://azure.microsoft.com/pricing/details/key-vault/) website.|\n|Thales HSM, smartcards, and support software|You must have access to a Thales Hardware Security Module and basic operational knowledge of Thales HSMs. See [Thales Hardware Security Module](https://www.thales-esecurity.com/msrms/buy) for the list of compatible models, or to purchase an HSM if you do not have one.|\n|The following hardware and software:<ol><li>An offline x64 workstation with a minimum Windows operation system of Windows 7 and Thales nShield software that is at least version 11.50.<br/><br/>If this workstation runs Windows 7, you must [install Microsoft .NET Framework 4.5](http://download.microsoft.com/download/b/a/4/ba4a7e71-2906-4b2d-a0e1-80cf16844f5f/dotnetfx45_full_x86_x64.exe).</li><li>A workstation that is connected to the Internet and has a minimum Windows operation system of Windows 7.</li><li>A USB drive or other portable storage device that has at least 16 MB free space.</li></ol>|For security reasons, we recommend that the first workstation is not connected to a network. However, this is not programmatically enforced.<br/><br/>Note that in the instructions that follow, this workstation is referred to as the disconnected workstation.</p></blockquote><br/>In addition, if your tenant key is for a production network, we recommend that you use a second, separate workstation to download the toolset and upload the tenant key. But for testing purposes, you can use the same workstation as the first one.<br/><br/>Note that in the instructions that follow, this second workstation is referred to as the Internet-connected workstation.</p></blockquote><br/>|\n\n##Generate and transfer your key to Azure Key Vault HSM\n\nYou will use the following 5 steps to generate and transfer your key to an Azure Key Vault HSM: \n\n- [Step 1: Prepare your Internet-connected workstation](#step-1-prepare-your-internet-connected-workstation)\n- [Step 2: Prepare your disconnected workstation](#step-2-prepare-your-disconnected-workstation)\n- [Step 3: Generate your key](#step-3-generate-your-key)\n- [Step 4: Prepare your key for transfer](#step-4-prepare-your-key-for-transfer)\n- [Step 5: Transfer your key to Azure Key Vault](#step-5-transfer-your-key-to-azure-key-vault)\n\n## Step 1: Prepare your Internet-connected workstation\nFor this first step, do the following procedures on your workstation that is connected to the Internet.\n\n\n###Step 1.1: Install Azure PowerShell\n\nFrom the Internet-connected workstation, download and install the Azure PowerShell module that includes the cmdlets to manage Azure Key Vault. This requires a minimum version of  0.8.13.\n\nFor installation instructions, see [How to install and configure Azure PowerShell](../powershell-install-configure.md).\n\n###Step 1.2: Get your Azure subscription ID\n\nStart an Azure PowerShell session and sign in to your Azure account by using the following command:\n\n        Add-AzureAccount\nIn the pop-up browser window, enter your Azure account user name and password. Then, use the [Get-AzureSubscription](https://msdn.microsoft.com/library/azure/dn790366.aspx) command:\n\n        Get-AzureSubscription\nFrom the output, locate the ID for the subscription you will use for Azure Key Vault. You will need this subscription ID later.\n\nDo not close the Azure PowerShell window.\n\n###Step 1.3: Download the BYOK toolset for Azure Key Vault\n\nGo to the Microsoft Download Center and [download the Azure Key Vault BYOK toolset](http://www.microsoft.com/download/details.aspx?id=45345) for your region:\n\n|Region|Package name|SHA-256 package hash|\n|---|---|---|\n|North America|KeyVault-BYOK-Tools-UnitedStates.zip|D9FDA9F5A34E1388CD6C9138E5B75B7051FB7D6B11F087AFE0553DC85CCF0E36|\n|Europe|KeyVault-BYOK-Tools-Europe.zip|881DCA798305B8408C06BAE7B3EFBC1E9EA6113A8D6EC443464F3744896F32C3|\n|Asia|KeyVault-BYOK-Tools-AsiaPacific.zip|0C76967B3AC76687E4EA47EB96174EE6B25AB24E3114E28A90D9B93A2E6ABF6E|\n|Latin America|KeyVault-BYOK-Tools-LatinAmerica.zip|B38015990D4D1E522B8367FF78E78E0234BF9592663470426088C44C3CAAAF48|\n\nTo validate the integrity of your downloaded BYOK toolset, from your Azure PowerShell session, use the [Get-FileHash](https://technet.microsoft.com/library/dn520872.aspx) cmdlet.\n\n    Get-FileHash KeyVault-BYOK-Tools-*.zip\n\nThe toolset includes the following:\n\n- A Key Exchange Key (KEK) package that has a name beginning with **BYOK-KEK-pkg-.**\n- A Security World package that has a name beginning with **BYOK-SecurityWorld-pkg-.**\n- A python script named v**erifykeypackage.py.**\n- A command-line executable file named **KeyTransferRemote.exe** and associated DLLs.\n- A Visual C++ Redistributable Package, named **vcredist_x64.exe.**\n\nCopy the package to a USB drive or other portable storage.\n\n##Step 2: Prepare your disconnected workstation\n\nFor this second step, do the following procedures on the workstation that is not connected to a network (either the Internet or your internal network).\n\n\n###Step 2.1: Prepare the disconnected workstation with Thales HSM\n\nInstall the nCipher (Thales) support software on a Windows computer, and then attach a Thales HSM to that computer. \n\nEnsure that the Thales tools are in your path (**%nfast_home%\\bin** and **%nfast_home%\\python\\bin**). For example, type the following:\n\n        set PATH=%PATH%;”%nfast_home%\\bin”;”%nfast_home%\\python\\bin”\n\nFor more information, see the user guide included with the Thales HSM.\n\n###Step 2.2: Install the BYOK toolset on the disconnected workstation\n\nCopy the BYOK toolset package from the USB drive or other portable storage, and then do the following:\n\n1. Extract the files from the downloaded package into any folder.\n2. From that folder, run vcredist_x64.exe.\n3. Follow the instructions to the install the Visual C++ runtime components for Visual Studio 2012.\n\n##Step 3: Generate your key\n\nFor this third step, do the following procedures on the disconnected workstation.\n\n###Step 3.1: Create a security world\n\nStart a command prompt and run the Thales new-world program.\n\n    new-world.exe --initialize --cipher-suite=DLf1024s160mRijndael --module=1 --acs-quorum=2/3\n\nThis program creates a **Security World** file at %NFAST_KMDATA%\\local\\world, which corresponds to the C:\\ProgramData\\nCipher\\Key Management Data\\local folder. You can use different values for the quorum but in our example, you’re prompted to enter three blank cards and pins for each one. Then, any two cards will give full access to the security world. These cards become the **Administrator Card Set** for the new security world. \n\nThen do the following:\n\n- Back up the world file. Secure and protect the world file, the Administrator Cards, and their pins, and make sure that no single person has access to more than one card.\n\n###Step 3.2: Validate the downloaded package\n\nThis step is optional but recommended so that you can validate the following:\n\n- The Key Exchange Key that is included in the toolset has been generated from a genuine Thales HSM.\n- The hash of the Security World that is included in the toolset has been generated in a genuine Thales HSM.\n- The Key Exchange Key is non-exportable.\n\n>[AZURE.NOTE]To validate the downloaded package, the HSM must be connected, powered on, and must have a security world on it (such as the one you’ve just created).\n\nTo validate the downloaded package:\n\n1.  Run the verifykeypackage.py script by tying one of the following, depending on your region:\n    - For North America:\n\n            python verifykeypackage.py -k BYOK-KEK-pkg-NA-1 -w BYOK-SecurityWorld-pkg-NA-1\n    - For Europe:\n\n            python verifykeypackage.py -k BYOK-KEK-pkg-EU-1 -w BYOK-SecurityWorld-pkg-EU-1\n    - For Asia:\n\n            python verifykeypackage.py -k BYOK-KEK-pkg-AP-1 -w BYOK-SecurityWorld-pkg-AP-1\n    - For Latin America:\n\n            python verifykeypackage.py -k BYOK-KEK-pkg-LATAM-1 -w BYOK-SecurityWorld-pkg-LATAM-1\n    - For Japan:\n\n            python verifykeypackage.py -k BYOK-KEK-pkg-JPN-1 -w BYOK-SecurityWorld-pkg-JPN-1\n\n    >[AZURE.TIP]The Thales software includes python at %NFAST_HOME%\\python\\bin\n    \n2.  Confirm that you see the following, which indicates successful validation: **Result: SUCCESS**\n\nThis script validates the signer chain up to the Thales root key. The hash of this root key is embedded in the script and its value should be **59178a47 de508c3f 291277ee 184f46c4 f1d9c639**. You can also confirm this value separately by visiting the [Thales website](http://www.thalesesec.com/).\n\nYou’re now ready to create a new key.\n\n###Step 3.3: Create a new key\n\nGenerate a key by using the Thales **generatekey** program.\n\nRun the following command to generate the key:\n\n    generatekey --generate simple type=RSA size=2048 protect=module ident=contosokey plainname=contosokey nvram=no pubexp=\n\nWhen you run this command, use these instructions:\n\n- Replace the value of *contosokey* for the **ident** and **plainname** with any string value. To minimize administrative overheads and reduce the risk of errors, we recommend that you use the same value for both. The **ident** value must contain only numbers, dashes, and lower case letters.\n\n- The pubexp is left blank (default) in this example, but you can specify specific values. For more information, see the Thales documentation.\n\nThis command creates a Tokenized Key file in your %NFAST_KMDATA%\\local folder with a name starting with **key_simple_** followed by the ident that was specified in the command. For example: **key_simple_contosokey**. This file contains an encrypted key. \n\nBack up this Tokenized Key File in a safe location.\n\n>[AZURE.IMPORTANT] When you later transfer your key to Azure Key Vault, Microsoft cannot export this key back to you so it becomes extremely important that you back up your key and security world safely. Contact Thales for guidance and best practices for backing up your key.\n\nYou are now ready to transfer your key to Azure Key Vault.\n\n##Step 4: Prepare your key for transfer\n\nFor this fourth step, do the following procedures on the disconnected workstation.\n\n###Step 4.1: Create a copy of your key with reduced permissions\n\nTo reduce the permissions on your key, from a command prompt, run one of the following, depending on your region:\n\n- For North America:\n\n        KeyTransferRemote.exe -ModifyAcls -KeyAppName simple -KeyIdentifier contosokey -ExchangeKeyPackage BYOK-KEK-pkg-NA-1 -NewSecurityWorldPackage BYOK-SecurityWorld-pkg-NA-1\n- For Europe:\n\n        KeyTransferRemote.exe -ModifyAcls -KeyAppName simple -KeyIdentifier contosokey -ExchangeKeyPackage BYOK-KEK-pkg-EU-1 -NewSecurityWorldPackage BYOK-SecurityWorld-pkg-EU-1\n- For Asia:\n\n        KeyTransferRemote.exe -ModifyAcls -KeyAppName simple -KeyIdentifier contosokey -ExchangeKeyPackage BYOK-KEK-pkg-AP-1 -NewSecurityWorldPackage BYOK-SecurityWorld-pkg-AP-1\n- For Latin America:\n\n        KeyTransferRemote.exe -ModifyAcls -KeyAppName simple -KeyIdentifier contosokey -ExchangeKeyPackage BYOK-KEK-pkg-LATAM-1 -NewSecurityWorldPackage BYOK-SecurityWorld-pkg-LATAM-1\n- For Japan:\n\n        KeyTransferRemote.exe -ModifyAcls -KeyAppName simple -KeyIdentifier contosokey -ExchangeKeyPackage BYOK-KEK-pkg-JPN-1 -NewSecurityWorldPackage BYOK-SecurityWorld-pkg-JPN-1\n\nWhen you run this command, replace *contosokey* with the same value you specified in **Step 3.3: Create a new key** from the [Generate your key](#step-3-generate-your-key) step.\n\nYou will be asked to plug in your security world admin cards.\n\nWhen the command completes, you will see **Result: SUCCESS** and the copy of your key with reduced permissions will be in the file named key_xferacId_<contosokey>.\n\n###Step 4.2: Inspect the new copy of the key\n\nOptionally, run the Thales utilities to confirm the minimal permissions on the new key:\n\n- aclprint.py:\n\n        \"%nfast_home%\\bin\\preload.exe\" -m 1 -A xferacld -K contosokey \"%nfast_home%\\python\\bin\\python\" \"%nfast_home%\\python\\examples\\aclprint.py\"\n- kmfile-dump.exe:\n\n        \"%nfast_home%\\bin\\kmfile-dump.exe\" \"%NFAST_KMDATA%\\local\\key_xferacld_contosokey\"\nWhen you run these command, replace contosokey with the same value you specified in **Step 3.3: Create a new key** from the [Generate your key](#step-3-generate-your-key) step.\n\n###Step 4.3: Encrypt your key by using Microsoft’s Key Exchange Key\n\nRun one of the following commands, depending on your region:\n\n- For North America:\n\n        KeyTransferRemote.exe -Package -KeyIdentifier contosokey -ExchangeKeyPackage BYOK-KEK-pkg-NA-1 -NewSecurityWorldPackage BYOK-SecurityWorld-pkg-NA-1 -SubscriptionId SubscriptionID -KeyFriendlyName ContosoFirstHSMkey\n- For Europe:\n\n        KeyTransferRemote.exe -Package -KeyIdentifier contosokey -ExchangeKeyPackage BYOK-KEK-pkg-EU-1 -NewSecurityWorldPackage BYOK-SecurityWorld-pkg-EU-1 -SubscriptionId SubscriptionID -KeyFriendlyName ContosoFirstHSMkey\n- For Asia:\n\n        KeyTransferRemote.exe -Package -KeyIdentifier contosokey -ExchangeKeyPackage BYOK-KEK-pkg-AP-1 -NewSecurityWorldPackage BYOK-SecurityWorld-pkg-AP-1 -SubscriptionId SubscriptionID -KeyFriendlyName ContosoFirstHSMkey\n- For Latin America:\n\n        KeyTransferRemote.exe -Package -KeyIdentifier contosokey -ExchangeKeyPackage BYOK-KEK-pkg-LATAM-1 -NewSecurityWorldPackage BYOK-SecurityWorld-pkg-LATAM-1 -SubscriptionId SubscriptionID -KeyFriendlyName ContosoFirstHSMkey\n- For Japan:\n\n        KeyTransferRemote.exe -Package -KeyIdentifier contosokey -ExchangeKeyPackage BYOK-KEK-pkg-JPN-1 -NewSecurityWorldPackage BYOK-SecurityWorld-pkg-JPN-1 -SubscriptionId SubscriptionID -KeyFriendlyName ContosoFirstHSMkey\n\nWhen you run this command, use these instructions:\n\n- Replace *contosokey* with the identifier that you used to generate the key in **Step 3.3: Create a new key** from the [Generate your key](#step-3-generate-your-key) step.\n\n- Replace *SubscriptionID* with the ID of the Azure subscription that contains your key vault. You retrieved this value previously, in **Step 1.2: Get your Azure subscription ID** from the [Prepare your Internet-connected workstation](#step-1-prepare-your-internet-connected-workstation) step.\n\n- Replace *ContosoFirstHSMKey* with a label that will be used for your output file name.\n\nWhen this completes successfully it displays **Result: SUCCESS** and there will be a new file in the current folder that has the following name: TransferPackage-*ContosoFirstHSMkey*.byok\n\n###Step 4.4: Copy your key transfer package to the Internet-connected workstation \n\nUse a USB drive or other portable storage to copy the output file from the previous step (KeyTransferPackage-ContosoFirstHSMkey.byok) to your Internet-connected workstation.\n\n##Step 5: Transfer your key to Azure Key Vault\n\nFor this final step, on the Internet-connected workstation, use the [Add-AzureKeyVaultKey](https://msdn.microsoft.com/library/azure/dn868048.aspx) cmdlet to upload the key transfer package that you copied from the disconnected workstation to the Azure Key Vault HSM:\n\n    Add-AzureKeyVaultKey -VaultName 'ContosoKeyVaultHSM' -Name 'ContosoFirstHSMkey' -KeyFilePath 'c:\\TransferPackage-ContosoFirstHSMkey.byok' -Destination 'HSM'\n\nIf the upload is successful, you see displayed the properties of the key that you just added.\n\n##Next steps\n\nYou can now use this HSM-protected key in your key vault. For more information, see the **If you want to use a hardware security module (HSM)** section in the [Getting started with Azure Key Vault](key-vault-get-started.md) tutorial.\n\ntest\n"
}