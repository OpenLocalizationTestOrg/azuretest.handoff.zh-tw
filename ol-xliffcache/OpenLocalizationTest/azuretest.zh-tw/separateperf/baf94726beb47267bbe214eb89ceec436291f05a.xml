{
  "nodes": [
    {
      "content": "Set up protection between an on-premises Hyper-V site and Azure",
      "pos": [
        27,
        90
      ]
    },
    {
      "content": "Azure Site Recovery coordinates the replication, failover and recovery of virtual machines located on on-premises Hyper-V servers to Azure",
      "pos": [
        110,
        248
      ]
    },
    {
      "content": "Set up protection between an on-premises Hyper-V site and Azure",
      "pos": [
        580,
        643
      ]
    },
    {
      "content": "Overview",
      "pos": [
        649,
        657
      ]
    },
    {
      "content": "Azure Site Recovery contributes to your business continuity and disaster recovery (BCDR) strategy by orchestrating replication, failover and recovery of virtual machines and physical servers.",
      "pos": [
        659,
        850
      ]
    },
    {
      "content": "Read about possible deployment scenarios in the <bpt id=\"p1\">[</bpt>Site Recovery Overview<ept id=\"p1\">](site-recovery-overview.md)</ept>.",
      "pos": [
        851,
        951
      ]
    },
    {
      "content": "This article describes how to deploy Site Recovery to replicate virtual machines located on on-premises Hyper-V servers running Windows Server 2012 R2.",
      "pos": [
        953,
        1104
      ]
    },
    {
      "content": "Replication to Azure storage is orchestrated by Site Recovery.",
      "pos": [
        1105,
        1167
      ]
    },
    {
      "content": "This deployment is particularly useful if you're running Hyper-V servers but System Center Virtual Machine Manager (VMM) isn't deployed.",
      "pos": [
        1168,
        1304
      ]
    },
    {
      "content": "About this article",
      "pos": [
        1310,
        1328
      ]
    },
    {
      "content": "The article summarizes the deployment prerequisites, helps you to configure replication settings, and enable protection for virtual machines.",
      "pos": [
        1330,
        1471
      ]
    },
    {
      "content": "It finishes up by testing failover to make sure everything's working as expected.",
      "pos": [
        1472,
        1553
      ]
    },
    {
      "pos": [
        1555,
        1713
      ],
      "content": "If you run into problems post your questions on the <bpt id=\"p1\">[</bpt>Azure Recovery Services Forum<ept id=\"p1\">](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)</ept>."
    },
    {
      "content": "Before you start",
      "pos": [
        1719,
        1735
      ]
    },
    {
      "content": "Make sure you have everything in place before you begin.",
      "pos": [
        1737,
        1793
      ]
    },
    {
      "content": "Azure prerequisites",
      "pos": [
        1799,
        1818
      ]
    },
    {
      "content": "You'll need a <bpt id=\"p1\">[</bpt>Microsoft Azure<ept id=\"p1\">](http://azure.microsoft.com/)</ept> account.",
      "pos": [
        1822,
        1891
      ]
    },
    {
      "content": "You can start with a <bpt id=\"p1\">[</bpt>free trial<ept id=\"p1\">](pricing/free-trial/)</ept>.",
      "pos": [
        1892,
        1947
      ]
    },
    {
      "content": "You'll need an Azure storage account to store replicated data.",
      "pos": [
        1952,
        2014
      ]
    },
    {
      "content": "The account needs geo-replication enabled.",
      "pos": [
        2015,
        2057
      ]
    },
    {
      "content": "It should be in the same region as the Azure Site Recovery vault and be associated with the same subscription.",
      "pos": [
        2058,
        2168
      ]
    },
    {
      "content": "To learn more read <bpt id=\"p1\">[</bpt>Introduction to Microsoft Azure Storage<ept id=\"p1\">](../storage/storage-introduction.md)</ept>.",
      "pos": [
        2169,
        2266
      ]
    },
    {
      "content": "You'll need an Azure virtual network so that replicated virtual machines are connected to a network after failover.",
      "pos": [
        2271,
        2386
      ]
    },
    {
      "content": "Hyper-V prerequisites",
      "pos": [
        2391,
        2412
      ]
    },
    {
      "content": "In the source on-premises site you'll need at least one server running Windows Server 2012 R2 with the Hyper-V role.",
      "pos": [
        2416,
        2532
      ]
    },
    {
      "content": "The Hyper-V server should contain one or more virtual machines.",
      "pos": [
        2535,
        2598
      ]
    },
    {
      "content": "Hyper-V servers should be connected to the Internet, either directly or via a proxy.",
      "pos": [
        2601,
        2685
      ]
    },
    {
      "content": "Virtual machine prerequisites",
      "pos": [
        2691,
        2720
      ]
    },
    {
      "pos": [
        2722,
        2866
      ],
      "content": "Virtual machines you want to protect should conform with <bpt id=\"p1\">[</bpt>Azure prerequisites<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/dn469078.aspx#BKMK_E2A)</ept>."
    },
    {
      "content": "Provider and agent prerequisites",
      "pos": [
        2873,
        2905
      ]
    },
    {
      "content": "As part of Azure Site Recovery deployment you’ll install the Azure Site Recovery Provider and the Azure Recovery Services Agent on each Hyper-V server running virtual machines you want to protect.",
      "pos": [
        2907,
        3103
      ]
    },
    {
      "content": "Note that:",
      "pos": [
        3104,
        3114
      ]
    },
    {
      "content": "You should run the latest versions of the Provider and agent.",
      "pos": [
        3118,
        3179
      ]
    },
    {
      "content": "All Hyper-V servers in a vault should have the same versions.",
      "pos": [
        3182,
        3243
      ]
    },
    {
      "content": "The Provider will need to connect to Azure Site Recovery over the Internet.",
      "pos": [
        3246,
        3321
      ]
    },
    {
      "content": "You can select to do this without a proxy, using proxy settings currently configured on the VMM server, or using custom proxy settings that you configure during Provider installation.",
      "pos": [
        3322,
        3505
      ]
    },
    {
      "content": "To use an existing proxy server ensure that the URLs for connecting to Azure are allowed through the firewall:",
      "pos": [
        3506,
        3616
      ]
    },
    {
      "content": "*.hypervrecoverymanager.windowsazure.com",
      "pos": [
        3623,
        3663
      ]
    },
    {
      "content": "*.accesscontrol.windows.net",
      "pos": [
        3670,
        3697
      ]
    },
    {
      "content": "*.backup.windowsazure.com",
      "pos": [
        3704,
        3729
      ]
    },
    {
      "content": "*.blob.core.windows.net",
      "pos": [
        3741,
        3764
      ]
    },
    {
      "content": "*.store.core.windows.net",
      "pos": [
        3772,
        3796
      ]
    },
    {
      "content": "To use a custom proxy set up the proxy server before installing the Provider.",
      "pos": [
        3801,
        3878
      ]
    },
    {
      "content": "During Provider setup you’ll need to specify the proxy server address and port, and credentials that can be used for access.",
      "pos": [
        3879,
        4003
      ]
    },
    {
      "content": "Note that HTTPS based proxy is not supported.",
      "pos": [
        4004,
        4049
      ]
    },
    {
      "content": "The picture below shows the different communication channels and ports used by Azure Site Recovery for orchestration and replication",
      "pos": [
        4051,
        4183
      ]
    },
    {
      "content": "B2A Topology",
      "pos": [
        4187,
        4199
      ]
    },
    {
      "content": "Step 1: Create a vault",
      "pos": [
        4268,
        4290
      ]
    },
    {
      "pos": [
        4295,
        4356
      ],
      "content": "Sign in to the <bpt id=\"p1\">[</bpt>Management Portal<ept id=\"p1\">](https://portal.azure.com)</ept>."
    },
    {
      "pos": [
        4362,
        4445
      ],
      "content": "Expand <bpt id=\"p1\">**</bpt>Data Services<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>Recovery Services<ept id=\"p2\">**</ept> and click <bpt id=\"p3\">**</bpt>Site Recovery Vault<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        4451,
        4491
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Create New<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>Quick Create<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        4496,
        4553
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Name<ept id=\"p1\">**</ept>, enter a friendly name to identify the vault."
    },
    {
      "content": "In <bpt id=\"p1\">**</bpt>Region<ept id=\"p1\">**</ept>, select the geographic region for the vault.",
      "pos": [
        4558,
        4616
      ]
    },
    {
      "content": "To check supported regions see Geographic Availability in <bpt id=\"p1\">[</bpt>Azure Site Recovery Pricing Details<ept id=\"p1\">](pricing/details/site-recovery/)</ept>.",
      "pos": [
        4617,
        4745
      ]
    },
    {
      "pos": [
        4750,
        4773
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Create vault<ept id=\"p1\">**</ept>."
    },
    {
      "content": "New vault",
      "pos": [
        4781,
        4790
      ]
    },
    {
      "content": "Check the status bar to confirm that the vault was successfully created.",
      "pos": [
        4853,
        4925
      ]
    },
    {
      "content": "The vault will be listed as <bpt id=\"p1\">**</bpt>Active<ept id=\"p1\">**</ept> on the main Recovery Services page.",
      "pos": [
        4926,
        5000
      ]
    },
    {
      "content": "Step 2: Create a Hyper-V site",
      "pos": [
        5006,
        5035
      ]
    },
    {
      "content": "In the Recovery Services page, click the vault to open the Quick Start page.",
      "pos": [
        5040,
        5116
      ]
    },
    {
      "content": "Quick Start can also be opened at any time using the icon.",
      "pos": [
        5117,
        5175
      ]
    },
    {
      "content": "Quick Start",
      "pos": [
        5183,
        5194
      ]
    },
    {
      "pos": [
        5273,
        5352
      ],
      "content": "In the dropdown list, select <bpt id=\"p1\">**</bpt>Between an on-premises Hyper-V site and Azure<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Hyper-V site scenario",
      "pos": [
        5360,
        5381
      ]
    },
    {
      "content": "In <bpt id=\"p1\">**</bpt>Create a Hyper-V Site<ept id=\"p1\">**</ept> click <bpt id=\"p2\">**</bpt>Create Hyper-V site<ept id=\"p2\">**</ept>.",
      "pos": [
        5460,
        5519
      ]
    },
    {
      "content": "Specify a site name and save.",
      "pos": [
        5520,
        5549
      ]
    },
    {
      "content": "Hyper-V site",
      "pos": [
        5557,
        5569
      ]
    },
    {
      "content": "Step 3: Install the Provider and agent",
      "pos": [
        5646,
        5684
      ]
    },
    {
      "content": "Install the Provider and agent.",
      "pos": [
        5685,
        5716
      ]
    },
    {
      "content": "If you're installing on a Hyper-V cluster, performs steps 5-11 on each node in the failover cluster.",
      "pos": [
        5717,
        5817
      ]
    },
    {
      "content": "After all nodes are registered and protection is enabled, virtual machines will be protected even if they migrate across nodes in the failover cluster.",
      "pos": [
        5818,
        5969
      ]
    },
    {
      "pos": [
        5974,
        6049
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Prepare Hyper-V servers<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>Download a registration key<ept id=\"p2\">**</ept> file."
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Download Registration Key<ept id=\"p1\">**</ept> page, click <bpt id=\"p2\">**</bpt>Download<ept id=\"p2\">**</ept> next to the site.",
      "pos": [
        6053,
        6132
      ]
    },
    {
      "content": "Download the key to a safe location that can be easily accessed by the Hyper-V server.",
      "pos": [
        6133,
        6219
      ]
    },
    {
      "content": "The key is valid for 5 days after it's generated.",
      "pos": [
        6220,
        6269
      ]
    },
    {
      "content": "Registration key",
      "pos": [
        6277,
        6293
      ]
    },
    {
      "pos": [
        6370,
        6431
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Download the Provider<ept id=\"p1\">**</ept> to obtain the latest version."
    },
    {
      "content": "Run the file on each Hyper-V server you want to register in the vault.",
      "pos": [
        6435,
        6505
      ]
    },
    {
      "content": "The file installs two components:",
      "pos": [
        6506,
        6539
      ]
    },
    {
      "pos": [
        6546,
        6681
      ],
      "content": "<bpt id=\"p1\">**</bpt>Azure Site Recovery Provider<ept id=\"p1\">**</ept>—Handles communication and orchestration between the Hyper-V server and the Azure Site Recovery portal."
    },
    {
      "pos": [
        6689,
        6826
      ],
      "content": "<bpt id=\"p1\">**</bpt>Azure Recovery Services Agent<ept id=\"p1\">**</ept>—Handles data transport between virtual machines running on the source Hyper-V server and Azure storage."
    },
    {
      "content": "In <bpt id=\"p1\">**</bpt>Microsoft Update<ept id=\"p1\">**</ept> you can opt in for updates.",
      "pos": [
        6831,
        6882
      ]
    },
    {
      "content": "With this setting enabled, Provider and Agent updates will be installed according to your Microsoft Update policy.",
      "pos": [
        6883,
        6997
      ]
    },
    {
      "content": "Microsoft Updates",
      "pos": [
        7005,
        7022
      ]
    },
    {
      "pos": [
        7096,
        7195
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Installation<ept id=\"p1\">**</ept> specify where you want to install the Provider and Agent on the Hyper-V server."
    },
    {
      "content": "Install location",
      "pos": [
        7203,
        7219
      ]
    },
    {
      "content": "After installation is complete continue setup to register the server in the vault.",
      "pos": [
        7293,
        7375
      ]
    },
    {
      "content": "Installation complete",
      "pos": [
        7383,
        7404
      ]
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Internet Connection<ept id=\"p1\">**</ept> page you specify how the Provider connects to Azure Site Recovery.",
      "pos": [
        7479,
        7576
      ]
    },
    {
      "content": "Select <bpt id=\"p1\">**</bpt>Use default system proxy settings<ept id=\"p1\">**</ept> to use the default Internet connection settings configured on the server.",
      "pos": [
        7577,
        7695
      ]
    },
    {
      "content": "If you don't specify a value the default settings will be used.",
      "pos": [
        7696,
        7759
      ]
    },
    {
      "content": "Internet Settings",
      "pos": [
        7767,
        7784
      ]
    },
    {
      "content": "Note that:",
      "pos": [
        7859,
        7869
      ]
    },
    {
      "content": "If the default proxy on the Hyper-V server requires authentication then you should select to use a custom proxy server.",
      "pos": [
        7877,
        7996
      ]
    },
    {
      "content": "Type in the default proxy details and specify credentials.",
      "pos": [
        7997,
        8055
      ]
    },
    {
      "content": "If you want to use a custom proxy server set it up before you install the Provider.",
      "pos": [
        8062,
        8145
      ]
    },
    {
      "content": "Following urls should be accessible from Hyper-v host",
      "pos": [
        8153,
        8206
      ]
    },
    {
      "content": "*.hypervrecoverymanager.windowsazure.com",
      "pos": [
        8217,
        8257
      ]
    },
    {
      "content": "*.accesscontrol.windows.net",
      "pos": [
        8268,
        8295
      ]
    },
    {
      "content": "*.backup.windowsazure.com",
      "pos": [
        8306,
        8331
      ]
    },
    {
      "content": "*.blob.core.windows.net",
      "pos": [
        8342,
        8365
      ]
    },
    {
      "content": "*.store.core.windows.net",
      "pos": [
        8376,
        8400
      ]
    },
    {
      "content": "Allow the IP addresses described in <bpt id=\"p1\">[</bpt>Azure Datacenter IP Ranges<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=511094)</ept> and HTTPS (443) protocol.",
      "pos": [
        8409,
        8546
      ]
    },
    {
      "content": "You would have to white-list IP ranges of the Azure region that you plan to use and that of West US.",
      "pos": [
        8547,
        8647
      ]
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Vault Settings<ept id=\"p1\">**</ept> page, click <bpt id=\"p2\">**</bpt>Browse<ept id=\"p2\">**</ept> to select the key file.",
      "pos": [
        8653,
        8725
      ]
    },
    {
      "content": "Specify the Azure Site Recovery subscription, the vault name, and the Hyper-V site to which the Hyper-V server belongs.",
      "pos": [
        8726,
        8845
      ]
    },
    {
      "content": "Server registration",
      "pos": [
        8853,
        8872
      ]
    },
    {
      "content": "Registration starts to register the server in the vault.",
      "pos": [
        8948,
        9004
      ]
    },
    {
      "content": "Server registration",
      "pos": [
        9012,
        9031
      ]
    },
    {
      "pos": [
        9106,
        9297
      ],
      "content": "After registration finishes metadata from the Hyper-V server is retrieved by Azure Site Recovery and the server is displayed on the <bpt id=\"p1\">**</bpt>Hyper-V Sites<ept id=\"p1\">**</ept> tab on the <bpt id=\"p2\">**</bpt>Servers<ept id=\"p2\">**</ept> page in the vault."
    },
    {
      "content": "Server registration",
      "pos": [
        9305,
        9324
      ]
    },
    {
      "content": "Note that if you want to install the Provider on Server Core for Windows Server 2012 R2 or standalone Hyper-V Server 2012 R2, do the following:",
      "pos": [
        9395,
        9538
      ]
    },
    {
      "content": "Download the Provider installation file and the registration key to a folder say C:\\ASR .",
      "pos": [
        9543,
        9632
      ]
    },
    {
      "content": "Extract the Provider installer by typing:",
      "pos": [
        9636,
        9677
      ]
    },
    {
      "content": "Install the Provider by typing:",
      "pos": [
        9775,
        9806
      ]
    },
    {
      "content": "Register the server by typing:",
      "pos": [
        9843,
        9873
      ]
    },
    {
      "content": "/Credentials: Mandatory parameter that specifies the location in which the registration key file is located.",
      "pos": [
        10024,
        10132
      ]
    },
    {
      "content": "/FriendlyName: Mandatory parameter for the name of the Hyper-V host server that appears in the Azure Site Recovery portal.",
      "pos": [
        10139,
        10261
      ]
    },
    {
      "content": "Optional proxy parameters:",
      "pos": [
        10268,
        10294
      ]
    },
    {
      "content": "/proxyAddress",
      "pos": [
        10305,
        10318
      ]
    },
    {
      "content": ": Address of proxy server",
      "pos": [
        10328,
        10353
      ]
    },
    {
      "content": "/proxyport",
      "pos": [
        10364,
        10374
      ]
    },
    {
      "content": ": Port of the proxy server",
      "pos": [
        10381,
        10407
      ]
    },
    {
      "content": "/proxyUsername",
      "pos": [
        10418,
        10432
      ]
    },
    {
      "content": ": Credentials if proxy requires authentication.",
      "pos": [
        10443,
        10490
      ]
    },
    {
      "content": "proxyPassword",
      "pos": [
        10501,
        10514
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph>You can configure each of the individual Hyper-V host to use different network bandwidth settings to replicate virtual machines to Azure.",
      "pos": [
        10528,
        10677
      ]
    },
    {
      "content": "Learn more about <bpt id=\"p1\">[</bpt>How to Manage on-premises to Azure protection network bandwidth usage<ept id=\"p1\">](https://support.microsoft.com/en-us/kb/3056159)</ept>",
      "pos": [
        10678,
        10814
      ]
    },
    {
      "content": "Step 4: Create Azure resources",
      "pos": [
        10822,
        10852
      ]
    },
    {
      "content": "In <bpt id=\"p1\">**</bpt>Prepare resources<ept id=\"p1\">**</ept> select <bpt id=\"p2\">**</bpt>Create Storage Account<ept id=\"p2\">**</ept>  to create an Azure storage account if you don't have one.",
      "pos": [
        10857,
        10974
      ]
    },
    {
      "content": "The account should have geo-replication enabled.",
      "pos": [
        10975,
        11023
      ]
    },
    {
      "content": "It should be in the same region as the Azure Site Recovery vault, and be associated with the same subscription.",
      "pos": [
        11024,
        11135
      ]
    },
    {
      "content": "Create storage account",
      "pos": [
        11143,
        11165
      ]
    },
    {
      "content": "Step 5: Create and configure protection groups",
      "pos": [
        11246,
        11292
      ]
    },
    {
      "content": "Protection groups are logical groupings of virtual machines that you want to protect using the same protection settings.",
      "pos": [
        11294,
        11414
      ]
    },
    {
      "content": "You apply protection settings to a protection group, and those settings are applied to all virtual machines that you add to the group.",
      "pos": [
        11415,
        11549
      ]
    },
    {
      "content": "In <bpt id=\"p1\">**</bpt>Create and configure protection groups<ept id=\"p1\">**</ept> click <bpt id=\"p2\">**</bpt>Create a protection group<ept id=\"p2\">**</ept>.",
      "pos": [
        11553,
        11635
      ]
    },
    {
      "content": "If any prerequisites aren't in place a message is issued and you can click <bpt id=\"p1\">**</bpt>View details<ept id=\"p1\">**</ept> for more information.",
      "pos": [
        11636,
        11749
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Protection Groups<ept id=\"p1\">**</ept> tab, add a protection group.",
      "pos": [
        11754,
        11811
      ]
    },
    {
      "content": "Specify a name, the source Hyper-V site, the target <bpt id=\"p1\">**</bpt>Azure<ept id=\"p1\">**</ept>, your Azure Site Recovery subscription name, and the Azure storage account.",
      "pos": [
        11812,
        11949
      ]
    },
    {
      "content": "Protection group",
      "pos": [
        11957,
        11973
      ]
    },
    {
      "content": "In <bpt id=\"p1\">**</bpt>Replication settings<ept id=\"p1\">**</ept> set the <bpt id=\"p2\">**</bpt>Copy frequency<ept id=\"p2\">**</ept> to specify how often the data delta should be synchronized between the source and target.",
      "pos": [
        12061,
        12205
      ]
    },
    {
      "content": "You can set to 30 seconds, 5 minutes, or 15 minutes.",
      "pos": [
        12206,
        12258
      ]
    },
    {
      "pos": [
        12262,
        12352
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Retain recovery points<ept id=\"p1\">**</ept> specify how many hours of recovery history should be stored."
    },
    {
      "content": "In <bpt id=\"p1\">**</bpt>Frequency of application-consistent snapshots<ept id=\"p1\">**</ept> you can specify whether to take snapshots that use Volume Shadow Copy Service (VSS) to ensure that applications are in a consistent state when the snapshot is taken.",
      "pos": [
        12356,
        12574
      ]
    },
    {
      "content": "By default these aren't taken.",
      "pos": [
        12575,
        12605
      ]
    },
    {
      "content": "Make sure this value is set to less than the number of additional recovery points you configure.",
      "pos": [
        12606,
        12702
      ]
    },
    {
      "content": "This is only supported if the virtual machine is running a Windows operating system.",
      "pos": [
        12703,
        12787
      ]
    },
    {
      "pos": [
        12791,
        12930
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Initial replication start time<ept id=\"p1\">**</ept> specify when initial replication of virtual machines in the protection group should be sent to Azure."
    },
    {
      "content": "Protection group",
      "pos": [
        12938,
        12954
      ]
    },
    {
      "content": "Step 6: Enable virtual machine protection",
      "pos": [
        13036,
        13077
      ]
    },
    {
      "content": "Add virtual machines to a protection group to enable protection for them.",
      "pos": [
        13080,
        13153
      ]
    },
    {
      "pos": [
        13159,
        13282
      ],
      "content": "On the <bpt id=\"p1\">**</bpt>Machines<ept id=\"p1\">**</ept> tab for the protection group, click** Add virtual machines to protection groups to enable protection**."
    },
    {
      "pos": [
        13286,
        13384
      ],
      "content": "On the <bpt id=\"p1\">**</bpt>Enable Virtual Machine Protection<ept id=\"p1\">**</ept> page select the virtual machines you want to protect."
    },
    {
      "content": "Enable virtual machine protection",
      "pos": [
        13393,
        13426
      ]
    },
    {
      "content": "The Enable Protection jobs begins.",
      "pos": [
        13498,
        13532
      ]
    },
    {
      "content": "You can track progress on the <bpt id=\"p1\">**</bpt>Jobs<ept id=\"p1\">**</ept> tab.",
      "pos": [
        13533,
        13576
      ]
    },
    {
      "content": "After the Finalize Protection job runs the virtual machine is ready for failover.",
      "pos": [
        13577,
        13658
      ]
    },
    {
      "content": "After protection is set up you can:",
      "pos": [
        13663,
        13698
      ]
    },
    {
      "pos": [
        13706,
        13888
      ],
      "content": "View virtual machines in <bpt id=\"p1\">**</bpt>Protected Items<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>Protection Groups<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">*</bpt>protectiongroup_name<ept id=\"p3\">*</ept> &gt; <bpt id=\"p4\">**</bpt>Virtual Machines<ept id=\"p4\">**</ept> You can drill down to machine details in the <bpt id=\"p5\">**</bpt>Properties<ept id=\"p5\">**</ept> tab.."
    },
    {
      "content": "Configure the failover properties for a virtual machines in <bpt id=\"p1\">**</bpt>Protected Items<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>Protection Groups<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">*</bpt>protectiongroup_name<ept id=\"p3\">*</ept> &gt; <bpt id=\"p4\">**</bpt>Virtual Machines<ept id=\"p4\">**</ept> <bpt id=\"p5\">*</bpt>virtual_machine_name<ept id=\"p5\">*</ept> &gt; <bpt id=\"p6\">**</bpt>Configure<ept id=\"p6\">**</ept>.",
      "pos": [
        13895,
        14086
      ]
    },
    {
      "content": "You can configure:",
      "pos": [
        14087,
        14105
      ]
    },
    {
      "pos": [
        14116,
        14167
      ],
      "content": "<bpt id=\"p1\">**</bpt>Name<ept id=\"p1\">**</ept>: The name of the virtual machine in Azure."
    },
    {
      "pos": [
        14178,
        14243
      ],
      "content": "<bpt id=\"p1\">**</bpt>Size<ept id=\"p1\">**</ept>: The target size of the virtual machine that fails over."
    },
    {
      "content": "Configure virtual machine properties",
      "pos": [
        14255,
        14291
      ]
    },
    {
      "pos": [
        14361,
        14551
      ],
      "content": "Configure additional virtual machine settings in <bpt id=\"p1\">*</bpt>Protected Items<ept id=\"p1\">*</ept>* &gt; <bpt id=\"p2\">**</bpt>Protection Groups<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">*</bpt>protectiongroup_name<ept id=\"p3\">*</ept> &gt; <bpt id=\"p4\">**</bpt>Virtual Machines<ept id=\"p4\">**</ept> <bpt id=\"p5\">*</bpt>virtual_machine_name<ept id=\"p5\">*</ept> &gt; <bpt id=\"p6\">**</bpt>Configure<ept id=\"p6\">**</ept>, including:"
    },
    {
      "pos": [
        14563,
        14683
      ],
      "content": "<bpt id=\"p1\">**</bpt>Network adapters<ept id=\"p1\">**</ept>: The number of network adapters is dictated by the size you specify for the target virtual machine."
    },
    {
      "content": "Large (A3) and A6: 2",
      "pos": [
        14699,
        14719
      ]
    },
    {
      "content": "ExtraLarge (A4) and A7:",
      "pos": [
        14734,
        14757
      ]
    },
    {
      "content": "A9: 2",
      "pos": [
        14772,
        14777
      ]
    },
    {
      "content": "D3: 2",
      "pos": [
        14792,
        14797
      ]
    },
    {
      "content": "D4: 4",
      "pos": [
        14812,
        14817
      ]
    },
    {
      "content": "D13: 4",
      "pos": [
        14832,
        14838
      ]
    },
    {
      "content": "When you modify the size for a virtual machine and save the settings, the next time you open the <bpt id=\"p1\">**</bpt>Configure<ept id=\"p1\">**</ept> page the network adapters will be shown.",
      "pos": [
        14864,
        15015
      ]
    },
    {
      "content": "The number of adapters for a virtual machine will be determined as follows:",
      "pos": [
        15016,
        15091
      ]
    },
    {
      "content": "Step 7: Create a recovery plan",
      "pos": [
        16708,
        16738
      ]
    },
    {
      "content": "In order to test the deployment you can run a test failover for a single virtual machine or a recovery plan that contains one or more virtual machines.",
      "pos": [
        16740,
        16891
      ]
    },
    {
      "content": "To create a recovery plan <bpt id=\"p1\">[</bpt>follow these instructions<ept id=\"p1\">](site-recovery-create-recovery-plans.md)</ept>",
      "pos": [
        16892,
        16985
      ]
    },
    {
      "content": "Step 8: Test the deployment",
      "pos": [
        16990,
        17017
      ]
    },
    {
      "content": "There are two ways to run a test failover to Azure.",
      "pos": [
        17019,
        17070
      ]
    },
    {
      "content": "Test failover without an Azure network—This type of test failover checks that the virtual machine comes up correctly in Azure.",
      "pos": [
        17074,
        17200
      ]
    },
    {
      "content": "The virtual machine won’t be connected to any Azure network after failover.",
      "pos": [
        17201,
        17276
      ]
    },
    {
      "content": "Test failover with an Azure network—This type of failover checks that the entire replication environment comes up as expected and that failed over the virtual machines will be connected to the specified target Azure network.",
      "pos": [
        17279,
        17503
      ]
    },
    {
      "content": "For subnet handling, for test failover the subnet of the test virtual machine will be figured out based on the subnet of the replica virtual machine.",
      "pos": [
        17504,
        17653
      ]
    },
    {
      "content": "This is different to regular replication when the subnet of a replica virtual machine is based on the subnet of the source virtual machine.",
      "pos": [
        17654,
        17793
      ]
    },
    {
      "content": "If you want to run a test failover for a virtual machine enabled for protection to Azure without specifying an Azure target network you don’t need to prepare anything.",
      "pos": [
        17795,
        17962
      ]
    },
    {
      "content": "To run a test failover with a target Azure network you’ll need to create a new Azure network that’s isolated from your Azure production network (default behavior when you create a new network in Azure) and set up the infrastructure for the replicated virtual machine to work as expected.",
      "pos": [
        17963,
        18250
      ]
    },
    {
      "content": "For example, a virtual machine with Domain Controller and DNS can be replicated to Azure using Azure Site Recovery and can be created in the test network using Test Failover.",
      "pos": [
        18251,
        18425
      ]
    },
    {
      "content": "To run a test failover follow the steps below:",
      "pos": [
        18426,
        18472
      ]
    },
    {
      "content": "Do a test failover of the virtual machine with Domain Controller and DNS in the same network that you’ll be using for the actual test failover of the on-premises virtual machine.",
      "pos": [
        18478,
        18656
      ]
    },
    {
      "content": "Note down the IP addresses that were allocated to the failed over DNS virtual machine.",
      "pos": [
        18660,
        18746
      ]
    },
    {
      "content": "In the Azure virtual network that will be used for the failover, add the IP address as the address of the DNS server.",
      "pos": [
        18750,
        18867
      ]
    },
    {
      "content": "Run the test failover of the source on-premises virtual machines, specifying the Azure test network.",
      "pos": [
        18871,
        18971
      ]
    },
    {
      "content": "After validating that the test failure worked as expected, mark the test failover as complete for the recovery plan, and then mark the test failover as complete for the Domain Controller and DNS virtual machines.",
      "pos": [
        18975,
        19187
      ]
    },
    {
      "content": "To run the test failover do the following:",
      "pos": [
        19189,
        19231
      ]
    },
    {
      "pos": [
        19236,
        19311
      ],
      "content": "On the <bpt id=\"p1\">**</bpt>Recovery Plans<ept id=\"p1\">**</ept> tab, select the plan and click <bpt id=\"p2\">**</bpt>Test Failover<ept id=\"p2\">**</ept>."
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Confirm Test Failover<ept id=\"p1\">**</ept> page select <bpt id=\"p2\">**</bpt>None<ept id=\"p2\">**</ept> or a specific Azure network.",
      "pos": [
        19315,
        19397
      ]
    },
    {
      "content": "Note that if you select <bpt id=\"p1\">**</bpt>None<ept id=\"p1\">**</ept> the test failover will check that the virtual machine replicated correctly to Azure but doesn't check your replication network configuration.",
      "pos": [
        19399,
        19573
      ]
    },
    {
      "content": "Test failover",
      "pos": [
        19581,
        19594
      ]
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Jobs<ept id=\"p1\">**</ept> tab you can track failover progress.",
      "pos": [
        19680,
        19732
      ]
    },
    {
      "content": "You should also be able to see the virtual machine test replica in the Azure portal.",
      "pos": [
        19733,
        19817
      ]
    },
    {
      "content": "If you’re set up to access virtual machines from your on-premises network you can initiate a Remote Desktop connection to the virtual machine.",
      "pos": [
        19818,
        19960
      ]
    },
    {
      "content": "When the failover reaches the <bpt id=\"p1\">**</bpt>Complete testing<ept id=\"p1\">**</ept> phase , click <bpt id=\"p2\">**</bpt>Complete Test<ept id=\"p2\">**</ept> to finish up the test failover.",
      "pos": [
        19964,
        20078
      ]
    },
    {
      "content": "You can drill down to the <bpt id=\"p1\">**</bpt>Job<ept id=\"p1\">**</ept> tab to track failover progress and status, and to perform any actions that are needed.",
      "pos": [
        20079,
        20199
      ]
    },
    {
      "content": "After  failover you'll be able to see the virtual machine test replica in the Azure portal.",
      "pos": [
        20203,
        20294
      ]
    },
    {
      "content": "If you’re set up to access virtual machines from your on-premises network you can initiate a Remote Desktop connection to the virtual machine.",
      "pos": [
        20295,
        20437
      ]
    },
    {
      "content": "Verify that the virtual machines start successfully.",
      "pos": [
        20446,
        20498
      ]
    },
    {
      "content": "If you want to connect to the virtual machine in Azure using Remote Desktop after the failover, enable Remote Desktop Connection on the virtual machine before you run the test failover.",
      "pos": [
        20506,
        20691
      ]
    },
    {
      "content": "You will also need to add an RDP endpoint on the virtual machine.",
      "pos": [
        20692,
        20757
      ]
    },
    {
      "content": "You can leverage an <bpt id=\"p1\">[</bpt>Azure Automation Runbooks<ept id=\"p1\">](site-recovery-runbook-automation.md)</ept> to do that.",
      "pos": [
        20758,
        20854
      ]
    },
    {
      "content": "After failover if you use a public IP address to connect to the virtual machine in Azure using Remote Desktop, ensure you don't have any domain policies that prevent you from connecting to a virtual machine using a public address.",
      "pos": [
        20862,
        21092
      ]
    },
    {
      "content": "After the testing is complete do the following:",
      "pos": [
        21097,
        21144
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>The test failover is complete<ept id=\"p1\">**</ept>.",
      "pos": [
        21152,
        21192
      ]
    },
    {
      "content": "Clean up the test environment to automatically power off and delete the test virtual machines.",
      "pos": [
        21193,
        21287
      ]
    },
    {
      "pos": [
        21294,
        21380
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Notes<ept id=\"p1\">**</ept> to record and save any observations associated with the test failover."
    },
    {
      "pos": [
        21384,
        21476
      ],
      "content": "When the failover reaches the <bpt id=\"p1\">**</bpt>Complete testing<ept id=\"p1\">**</ept> phase finish the verification as follows:"
    },
    {
      "content": "View the replica virtual machine in the Azure portal.",
      "pos": [
        21484,
        21537
      ]
    },
    {
      "content": "Verify that the virtual machine starts successfully.",
      "pos": [
        21538,
        21590
      ]
    },
    {
      "content": "If you’re set up to access virtual machines from your on-premises network you can initiate a Remote Desktop connection to the virtual machine.",
      "pos": [
        21598,
        21740
      ]
    },
    {
      "pos": [
        21748,
        21789
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Complete the test<ept id=\"p1\">**</ept> to finish it."
    },
    {
      "pos": [
        21797,
        21883
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Notes<ept id=\"p1\">**</ept> to record and save any observations associated with the test failover."
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>The test failover is complete<ept id=\"p1\">**</ept>.",
      "pos": [
        21892,
        21932
      ]
    },
    {
      "content": "Clean up the test environment to automatically power off and delete the test virtual machine.",
      "pos": [
        21933,
        22026
      ]
    },
    {
      "content": "Next steps",
      "pos": [
        22031,
        22041
      ]
    },
    {
      "pos": [
        22043,
        22143
      ],
      "content": "After your deployment is set up and running, <bpt id=\"p1\">[</bpt>learn more<ept id=\"p1\">](site-recovery-failover.md)</ept> about failover."
    }
  ],
  "content": "<properties\n    pageTitle=\"Set up protection between an on-premises Hyper-V site and Azure\" \n    description=\"Azure Site Recovery coordinates the replication, failover and recovery of virtual machines located on on-premises Hyper-V servers to Azure\" \n    services=\"site-recovery\" \n    documentationCenter=\"\" \n    authors=\"rayne-wiselman\" \n    manager=\"jwhit\" \n    editor=\"\"/>\n\n<tags \n    ms.service=\"site-recovery\" \n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.tgt_pltfrm=\"na\"\n    ms.workload=\"storage-backup-recovery\" \n    ms.date=\"08/05/2015\" \n    ms.author=\"raynew\"/>\n\n\n# Set up protection between an on-premises Hyper-V site and Azure\n\n\n## Overview\n\nAzure Site Recovery contributes to your business continuity and disaster recovery (BCDR) strategy by orchestrating replication, failover and recovery of virtual machines and physical servers. Read about possible deployment scenarios in the [Site Recovery Overview](site-recovery-overview.md).\n\nThis article describes how to deploy Site Recovery to replicate virtual machines located on on-premises Hyper-V servers running Windows Server 2012 R2. Replication to Azure storage is orchestrated by Site Recovery. This deployment is particularly useful if you're running Hyper-V servers but System Center Virtual Machine Manager (VMM) isn't deployed.\n\n\n## About this article\n\nThe article summarizes the deployment prerequisites, helps you to configure replication settings, and enable protection for virtual machines. It finishes up by testing failover to make sure everything's working as expected.\n\nIf you run into problems post your questions on the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).\n\n\n## Before you start\n\nMake sure you have everything in place before you begin.\n\n### Azure prerequisites\n\n- You'll need a [Microsoft Azure](http://azure.microsoft.com/) account. You can start with a [free trial](pricing/free-trial/).\n- - You'll need an Azure storage account to store replicated data. The account needs geo-replication enabled. It should be in the same region as the Azure Site Recovery vault and be associated with the same subscription. To learn more read [Introduction to Microsoft Azure Storage](../storage/storage-introduction.md).\n- - You'll need an Azure virtual network so that replicated virtual machines are connected to a network after failover.\n\n## Hyper-V prerequisites\n\n- In the source on-premises site you'll need at least one server running Windows Server 2012 R2 with the Hyper-V role.\n- The Hyper-V server should contain one or more virtual machines.\n- Hyper-V servers should be connected to the Internet, either directly or via a proxy.\n\n### Virtual machine prerequisites\n\nVirtual machines you want to protect should conform with [Azure prerequisites](https://msdn.microsoft.com/library/azure/dn469078.aspx#BKMK_E2A). \n\n### Provider and agent prerequisites\n\nAs part of Azure Site Recovery deployment you’ll install the Azure Site Recovery Provider and the Azure Recovery Services Agent on each Hyper-V server running virtual machines you want to protect. Note that:\n\n- You should run the latest versions of the Provider and agent.\n- All Hyper-V servers in a vault should have the same versions.\n- The Provider will need to connect to Azure Site Recovery over the Internet. You can select to do this without a proxy, using proxy settings currently configured on the VMM server, or using custom proxy settings that you configure during Provider installation. To use an existing proxy server ensure that the URLs for connecting to Azure are allowed through the firewall:\n    - *.hypervrecoverymanager.windowsazure.com\n    - *.accesscontrol.windows.net\n    - *.backup.windowsazure.com     \n    - *.blob.core.windows.net \n    - *.store.core.windows.net \n\n- To use a custom proxy set up the proxy server before installing the Provider. During Provider setup you’ll need to specify the proxy server address and port, and credentials that can be used for access. Note that HTTPS based proxy is not supported.\n\nThe picture below shows the different communication channels and ports used by Azure Site Recovery for orchestration and replication\n\n![B2A Topology](./media/site-recovery-hyper-v-site-to-azure/B2ATopology.png)\n\n \n## Step 1: Create a vault\n\n1. Sign in to the [Management Portal](https://portal.azure.com).\n\n\n2. Expand **Data Services** > **Recovery Services** and click **Site Recovery Vault**.\n\n\n3. Click **Create New** > **Quick Create**.\n\n4. In **Name**, enter a friendly name to identify the vault.\n\n5. In **Region**, select the geographic region for the vault. To check supported regions see Geographic Availability in [Azure Site Recovery Pricing Details](pricing/details/site-recovery/).\n\n6. Click **Create vault**.\n\n    ![New vault](./media/site-recovery-hyper-v-site-to-azure/SR_HvVault.png)\n\nCheck the status bar to confirm that the vault was successfully created. The vault will be listed as **Active** on the main Recovery Services page.\n\n\n## Step 2: Create a Hyper-V site\n\n1. In the Recovery Services page, click the vault to open the Quick Start page. Quick Start can also be opened at any time using the icon.\n\n    ![Quick Start](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_QuickStartIcon.png)\n\n2. In the dropdown list, select **Between an on-premises Hyper-V site and Azure**.\n\n    ![Hyper-V site scenario](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_SelectScenario.png)\n\n3. In **Create a Hyper-V Site** click **Create Hyper-V site**. Specify a site name and save.\n\n    ![Hyper-V site](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_CreateSite2.png)\n\n\n## Step 3: Install the Provider and agent\nInstall the Provider and agent. If you're installing on a Hyper-V cluster, performs steps 5-11 on each node in the failover cluster. After all nodes are registered and protection is enabled, virtual machines will be protected even if they migrate across nodes in the failover cluster.\n\n1. In **Prepare Hyper-V servers**, click **Download a registration key** file.\n2. On the **Download Registration Key** page, click **Download** next to the site. Download the key to a safe location that can be easily accessed by the Hyper-V server. The key is valid for 5 days after it's generated.\n\n    ![Registration key](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_DownloadKey2.png)\n\n4. Click **Download the Provider** to obtain the latest version.\n5. Run the file on each Hyper-V server you want to register in the vault. The file installs two components:\n    - **Azure Site Recovery Provider**—Handles communication and orchestration between the Hyper-V server and the Azure Site Recovery portal. \n    - **Azure Recovery Services Agent**—Handles data transport between virtual machines running on the source Hyper-V server and Azure storage. \n6. In **Microsoft Update** you can opt in for updates. With this setting enabled, Provider and Agent updates will be installed according to your Microsoft Update policy.\n\n    ![Microsoft Updates](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_Provider1.png)\n\n7. In **Installation** specify where you want to install the Provider and Agent on the Hyper-V server.\n\n    ![Install location](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_Provider2.png)\n\n8. After installation is complete continue setup to register the server in the vault.\n\n    ![Installation complete](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_Provider3.png)\n\n\n9. On the **Internet Connection** page you specify how the Provider connects to Azure Site Recovery. Select **Use default system proxy settings** to use the default Internet connection settings configured on the server. If you don't specify a value the default settings will be used.\n\n    ![Internet Settings](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_Provider4.png)\n\n    Note that:\n\n    - If the default proxy on the Hyper-V server requires authentication then you should select to use a custom proxy server. Type in the default proxy details and specify credentials.\n    - If you want to use a custom proxy server set it up before you install the Provider. \n    - Following urls should be accessible from Hyper-v host\n        - *.hypervrecoverymanager.windowsazure.com\n        - *.accesscontrol.windows.net\n        - *.backup.windowsazure.com\n        - *.blob.core.windows.net\n        - *.store.core.windows.net \n\n    - Allow the IP addresses described in [Azure Datacenter IP Ranges](http://go.microsoft.com/fwlink/?LinkId=511094) and HTTPS (443) protocol. You would have to white-list IP ranges of the Azure region that you plan to use and that of West US. \n\n9. On the **Vault Settings** page, click **Browse** to select the key file. Specify the Azure Site Recovery subscription, the vault name, and the Hyper-V site to which the Hyper-V server belongs.\n\n    ![Server registration](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_SelectKey.png)\n\n\n11. Registration starts to register the server in the vault.\n\n    ![Server registration](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_Provider6.png)\n\n11. After registration finishes metadata from the Hyper-V server is retrieved by Azure Site Recovery and the server is displayed on the **Hyper-V Sites** tab on the **Servers** page in the vault.\n\n    ![Server registration](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_Provider7.png)\n\nNote that if you want to install the Provider on Server Core for Windows Server 2012 R2 or standalone Hyper-V Server 2012 R2, do the following:\n\n1. Download the Provider installation file and the registration key to a folder say C:\\ASR .\n2. Extract the Provider installer by typing:\n\n        C:\\Windows\\System32> CD C:\\ASR\n        C:\\ASR>AzureSiteRecoveryProvider.exe /x:. /q\n\n3. Install the Provider by typing:\n\n        C:\\ASR> setupdr.exe /i\n\n4. Register the server by typing:\n\n        C:\\Program Files\\Azure Site Recovery Provider> DRConfigurator.exe /r /Credentials <Location of key> /FriendlyName <Hyper-V host name>\n\n    - /Credentials: Mandatory parameter that specifies the location in which the registration key file is located.\n    - /FriendlyName: Mandatory parameter for the name of the Hyper-V host server that appears in the Azure Site Recovery portal.\n    - Optional proxy parameters:\n        - /proxyAddress <address>: Address of proxy server\n        - /proxyport <port>: Port of the proxy server\n        - /proxyUsername <username>: Credentials if proxy requires authentication.\n        - proxyPassword <password>\n\n>[AZURE.NOTE]You can configure each of the individual Hyper-V host to use different network bandwidth settings to replicate virtual machines to Azure. Learn more about [How to Manage on-premises to Azure protection network bandwidth usage](https://support.microsoft.com/en-us/kb/3056159)  \n\n\n## Step 4: Create Azure resources\n\n1. In **Prepare resources** select **Create Storage Account**  to create an Azure storage account if you don't have one. The account should have geo-replication enabled. It should be in the same region as the Azure Site Recovery vault, and be associated with the same subscription.\n\n    ![Create storage account](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_CreateResources1.png)\n\n## Step 5: Create and configure protection groups\n\nProtection groups are logical groupings of virtual machines that you want to protect using the same protection settings. You apply protection settings to a protection group, and those settings are applied to all virtual machines that you add to the group.\n1. In **Create and configure protection groups** click **Create a protection group**. If any prerequisites aren't in place a message is issued and you can click **View details** for more information.\n\n2. In the **Protection Groups** tab, add a protection group. Specify a name, the source Hyper-V site, the target **Azure**, your Azure Site Recovery subscription name, and the Azure storage account.\n\n    ![Protection group](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_ProtectionGroupCreate3.png)\n\n\n2. In **Replication settings** set the **Copy frequency** to specify how often the data delta should be synchronized between the source and target. You can set to 30 seconds, 5 minutes, or 15 minutes.\n3. In **Retain recovery points** specify how many hours of recovery history should be stored.\n4. In **Frequency of application-consistent snapshots** you can specify whether to take snapshots that use Volume Shadow Copy Service (VSS) to ensure that applications are in a consistent state when the snapshot is taken. By default these aren't taken. Make sure this value is set to less than the number of additional recovery points you configure. This is only supported if the virtual machine is running a Windows operating system.\n5. In **Initial replication start time** specify when initial replication of virtual machines in the protection group should be sent to Azure.\n\n    ![Protection group](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_ProtectionGroup4.png)\n\n\n## Step 6: Enable virtual machine protection\n\n\nAdd virtual machines to a protection group to enable protection for them. \n\n1. On the **Machines** tab for the protection group, click** Add virtual machines to protection groups to enable protection**.\n2. On the **Enable Virtual Machine Protection** page select the virtual machines you want to protect. \n\n    ![Enable virtual machine protection](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_AddVM3.png)\n\n    The Enable Protection jobs begins. You can track progress on the **Jobs** tab. After the Finalize Protection job runs the virtual machine is ready for failover. \n3. After protection is set up you can:\n\n    - View virtual machines in **Protected Items** > **Protection Groups** > *protectiongroup_name* > **Virtual Machines** You can drill down to machine details in the **Properties** tab..\n    - Configure the failover properties for a virtual machines in **Protected Items** > **Protection Groups** > *protectiongroup_name* > **Virtual Machines** *virtual_machine_name* > **Configure**. You can configure:\n        - **Name**: The name of the virtual machine in Azure.\n        - **Size**: The target size of the virtual machine that fails over.\n\n        ![Configure virtual machine properties](./media/site-recovery-hyper-v-site-to-azure/VMProperties.png)\n    - Configure additional virtual machine settings in *Protected Items** > **Protection Groups** > *protectiongroup_name* > **Virtual Machines** *virtual_machine_name* > **Configure**, including:\n\n        - **Network adapters**: The number of network adapters is dictated by the size you specify for the target virtual machine. \n            - Large (A3) and A6: 2\n            - ExtraLarge (A4) and A7:\n            - A9: 2\n            - D3: 2\n            - D4: 4\n            - D13: 4\n            \n            When you modify the size for a virtual machine and save the settings, the next time you open the **Configure** page the network adapters will be shown. The number of adapters for a virtual machine will be determined as follows:\n\n\n            - If the number of network adapters on the source machine is less than or equal to the number of adapters allowed for the target machine size, then the target will have the same number of adapters as the source.\n            - If the number of adapters for the source virtual machine exceeds the number allowed for the target size then the target size maximum will be used.\n            - For example if a source machine has two network adapters and the target machine size supports four, the target machine will have two adapters. If the source machine has two adapters but the supported target size only supports one then the target machine will have only one adapter.     \n        - **Azure network**: Specify the network to which the virtual machine should fail over. If the virtual machine has multiple network adapters all adapters should connected to the same Azure network.\n        - **Subnet** For each network adapter on the virtual machine, select the subnet in the Azure network to which the machine should connect after failover.\n        - **Target IP address**: If the network adapter of source virtual machine is configured to use static a IP address then you can specify the IP address for the ttarget virtual machine to ensure that the machine has the same IP address after failover.  If you don't specify an IP address then any available address will be assigned at the time of failover. If you specify an address that's in use then failover wll fail.\n         \n        ![Configure virtual machine properties](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_VMMultipleNic.png)\n\n## Step 7: Create a recovery plan\n\nIn order to test the deployment you can run a test failover for a single virtual machine or a recovery plan that contains one or more virtual machines. To create a recovery plan [follow these instructions](site-recovery-create-recovery-plans.md)\n\n## Step 8: Test the deployment\n\nThere are two ways to run a test failover to Azure.\n\n- Test failover without an Azure network—This type of test failover checks that the virtual machine comes up correctly in Azure. The virtual machine won’t be connected to any Azure network after failover.\n- Test failover with an Azure network—This type of failover checks that the entire replication environment comes up as expected and that failed over the virtual machines will be connected to the specified target Azure network. For subnet handling, for test failover the subnet of the test virtual machine will be figured out based on the subnet of the replica virtual machine. This is different to regular replication when the subnet of a replica virtual machine is based on the subnet of the source virtual machine.\n\nIf you want to run a test failover for a virtual machine enabled for protection to Azure without specifying an Azure target network you don’t need to prepare anything. To run a test failover with a target Azure network you’ll need to create a new Azure network that’s isolated from your Azure production network (default behavior when you create a new network in Azure) and set up the infrastructure for the replicated virtual machine to work as expected. For example, a virtual machine with Domain Controller and DNS can be replicated to Azure using Azure Site Recovery and can be created in the test network using Test Failover. To run a test failover follow the steps below:\n\n\n1. Do a test failover of the virtual machine with Domain Controller and DNS in the same network that you’ll be using for the actual test failover of the on-premises virtual machine.\n2. Note down the IP addresses that were allocated to the failed over DNS virtual machine.\n3. In the Azure virtual network that will be used for the failover, add the IP address as the address of the DNS server.\n4. Run the test failover of the source on-premises virtual machines, specifying the Azure test network.\n5. After validating that the test failure worked as expected, mark the test failover as complete for the recovery plan, and then mark the test failover as complete for the Domain Controller and DNS virtual machines.\n\nTo run the test failover do the following:\n\n1. On the **Recovery Plans** tab, select the plan and click **Test Failover**.\n2. On the **Confirm Test Failover** page select **None** or a specific Azure network.  Note that if you select **None** the test failover will check that the virtual machine replicated correctly to Azure but doesn't check your replication network configuration.\n\n    ![Test failover](./media/site-recovery-hyper-v-site-to-azure/SRHVSite_TestFailoverNoNetwork.png)\n\n3. On the **Jobs** tab you can track failover progress. You should also be able to see the virtual machine test replica in the Azure portal. If you’re set up to access virtual machines from your on-premises network you can initiate a Remote Desktop connection to the virtual machine.\n4. When the failover reaches the **Complete testing** phase , click **Complete Test** to finish up the test failover. You can drill down to the **Job** tab to track failover progress and status, and to perform any actions that are needed.\n5. After  failover you'll be able to see the virtual machine test replica in the Azure portal. If you’re set up to access virtual machines from your on-premises network you can initiate a Remote Desktop connection to the virtual machine.\n\n    1. Verify that the virtual machines start successfully.\n    2. If you want to connect to the virtual machine in Azure using Remote Desktop after the failover, enable Remote Desktop Connection on the virtual machine before you run the test failover. You will also need to add an RDP endpoint on the virtual machine. You can leverage an [Azure Automation Runbooks](site-recovery-runbook-automation.md) to do that.\n    3. After failover if you use a public IP address to connect to the virtual machine in Azure using Remote Desktop, ensure you don't have any domain policies that prevent you from connecting to a virtual machine using a public address.\n\n6. After the testing is complete do the following:\n\n    - Click **The test failover is complete**. Clean up the test environment to automatically power off and delete the test virtual machines.\n    - Click **Notes** to record and save any observations associated with the test failover.\n7. When the failover reaches the **Complete testing** phase finish the verification as follows:\n    1. View the replica virtual machine in the Azure portal. Verify that the virtual machine starts successfully.\n    2. If you’re set up to access virtual machines from your on-premises network you can initiate a Remote Desktop connection to the virtual machine.\n    3. Click **Complete the test** to finish it.\n    4. Click **Notes** to record and save any observations associated with the test failover.\n    5.  Click **The test failover is complete**. Clean up the test environment to automatically power off and delete the test virtual machine.\n\n## Next steps\n\nAfter your deployment is set up and running, [learn more](site-recovery-failover.md) about failover. "
}