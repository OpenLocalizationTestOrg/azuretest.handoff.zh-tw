{
  "nodes": [
    {
      "content": "How to connect classic VNets to ARM VNets in Azure - Solution Guide",
      "pos": [
        27,
        94
      ]
    },
    {
      "content": "Learn how to create a VPN connection between classic VNets and new VNets",
      "pos": [
        112,
        184
      ]
    },
    {
      "content": "Connecting classic VNets to new VNets",
      "pos": [
        507,
        544
      ]
    },
    {
      "content": "Azure currently has two management modes: Azure Service Manager (referred to as classic), and Azure Resource Manager (ARM).",
      "pos": [
        546,
        669
      ]
    },
    {
      "content": "If you have been using Azure for some time, you probably have Azure VMs and instance roles running on a classic VNet.",
      "pos": [
        670,
        787
      ]
    },
    {
      "content": "And your newer VMs and role instances may be running on a VNet created in ARM.",
      "pos": [
        788,
        866
      ]
    },
    {
      "content": "In such situations, you will want to ensure the new infrastructure is able to communicate with your classic resources.",
      "pos": [
        868,
        986
      ]
    },
    {
      "content": "You can do so by creating a VPN connection between the two VNets.",
      "pos": [
        987,
        1052
      ]
    },
    {
      "content": "The figure below illustrates a sample environment with two VNets (classic and ARM), along with a secure tunnel connectivity between the VNets.",
      "pos": [
        1053,
        1195
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> This document walks you through an end-to-end solution, for testing purposes.",
      "pos": [
        1271,
        1361
      ]
    },
    {
      "content": "If you already have your VNets setup, and are familiar with VPN gateways and site-to-site connection in Azure, visit <bpt id=\"p1\">[</bpt>Configure a S2S VPN between an ARM VNet and a classic VNet<ept id=\"p1\">](../virtual-networks-arm-asm-s2s-howto.md)</ept>.",
      "pos": [
        1362,
        1582
      ]
    },
    {
      "content": "To test this scenario, you will:",
      "pos": [
        1584,
        1616
      ]
    },
    {
      "pos": [
        1621,
        1693
      ],
      "content": "<bpt id=\"p1\">[</bpt>Create a classic VNet environment<ept id=\"p1\">](#Create-a-classic-VNet-environment)</ept>."
    },
    {
      "pos": [
        1697,
        1761
      ],
      "content": "<bpt id=\"p1\">[</bpt>Create a new VNet environment<ept id=\"p1\">](#Create-a-new-VNet-environment)</ept>."
    },
    {
      "pos": [
        1765,
        1813
      ],
      "content": "<bpt id=\"p1\">[</bpt>Connect the two VNets<ept id=\"p1\">](#Connect-the-two-VNets)</ept>."
    },
    {
      "content": "You will execute the steps above by first using classic Azure management tools, including the classic portal, network configuration files, and Azure Service Manager PowerShell cmdlets; and later move on to the new management tools, including the new Azure portal, ARM templates, and ARM PowerShell cmdlets.",
      "pos": [
        1815,
        2121
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.IMPORTANT]</ph> For VNets to be connected to one another, they cannot have a CIDR block clash.",
      "pos": [
        2124,
        2220
      ]
    },
    {
      "content": "Make sure each VNet has a unique CIDR block!",
      "pos": [
        2221,
        2265
      ]
    },
    {
      "content": "Create a classic VNet environment",
      "pos": [
        2271,
        2304
      ]
    },
    {
      "content": "You can use an existing classic VNet to connect to a new ARM VNet.",
      "pos": [
        2306,
        2372
      ]
    },
    {
      "content": "In this example, you will see how to create a new classic VNet, with two subnets, a gateway, and a VM for testing purposes.",
      "pos": [
        2373,
        2496
      ]
    },
    {
      "content": "Step 1: Create a classic VNet",
      "pos": [
        2502,
        2531
      ]
    },
    {
      "content": "To create a new VNet that maps to figure 1 above, follow the instructions below.",
      "pos": [
        2533,
        2613
      ]
    },
    {
      "content": "From a PowerShell console, add you Azure account by running the command below.",
      "pos": [
        2618,
        2696
      ]
    },
    {
      "content": "Follow the sign in dialog box instructions to log on with your Azure account.",
      "pos": [
        2727,
        2804
      ]
    },
    {
      "content": "Make sure you are using Azure Service Management PowerShell cmdlets by running the command below.",
      "pos": [
        2809,
        2906
      ]
    },
    {
      "content": "Download your Azure network configuration file by running command below.",
      "pos": [
        2960,
        3032
      ]
    },
    {
      "content": "Open the file you just downloaded, and add a local network site named <bpt id=\"p1\">*</bpt>vnet02<ept id=\"p1\">*</ept> that uses <bpt id=\"p2\">*</bpt>10.2.0.0/16<ept id=\"p2\">*</ept> as an address prefix, and any valid public IP address as a VPN gateway address.",
      "pos": [
        3679,
        3861
      ]
    },
    {
      "content": "You can do so by adding a <bpt id=\"p1\">**</bpt>LocalNetworkSite<ept id=\"p1\">**</ept> element to the <bpt id=\"p2\">**</bpt>LocalNetworkSites<ept id=\"p2\">**</ept> element in your configuration file.",
      "pos": [
        3862,
        3981
      ]
    },
    {
      "content": "The file snippet below shows a sample <bpt id=\"p1\">**</bpt>LocalNetworksSites<ept id=\"p1\">**</ept> element.",
      "pos": [
        3982,
        4051
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>VirtualNetworkSites<ept id=\"p1\">**</ept> element, add a new virtual network with an address prefix of <bpt id=\"p2\">*</bpt>10.1.0.0/16<ept id=\"p2\">*</ept> and two subnets according the scenario figure above.",
      "pos": [
        4366,
        4524
      ]
    },
    {
      "content": "The file snippet below shows a sample <bpt id=\"p1\">**</bpt>VirtualNetworkSites<ept id=\"p1\">**</ept> element.",
      "pos": [
        4525,
        4595
      ]
    },
    {
      "content": "Save the file, then upload it to Azure by running the command below.",
      "pos": [
        5169,
        5237
      ]
    },
    {
      "content": "Make sure you change the file path as necessary for your environment.",
      "pos": [
        5238,
        5307
      ]
    },
    {
      "content": "Step 2: Create a VM in the classic VNet",
      "pos": [
        5938,
        5977
      ]
    },
    {
      "content": "To create a VM in the classic VNet by using Azure Service Manager PowerShell cmdlets, follow the instructions below.",
      "pos": [
        5979,
        6095
      ]
    },
    {
      "content": "Retrieve a VM image from Azure.",
      "pos": [
        6100,
        6131
      ]
    },
    {
      "content": "The PowerShell command below retrieves the latest Windows Server 2012 R2 image available.",
      "pos": [
        6132,
        6221
      ]
    },
    {
      "content": "Create a storage account to store the virtual hard drive (VHD) for the VM by running the command below.",
      "pos": [
        6398,
        6501
      ]
    },
    {
      "content": "Create the VM by running the commands below.",
      "pos": [
        6638,
        6682
      ]
    },
    {
      "content": "Make sure to replace the user name and password values.",
      "pos": [
        6683,
        6738
      ]
    },
    {
      "pos": [
        7094,
        7152
      ],
      "content": "Connect the VM to <bpt id=\"p1\">*</bpt>Subnet1<ept id=\"p1\">*</ept> by running the commands below."
    },
    {
      "content": "Create a new cloud service to host the VM by running the command below.",
      "pos": [
        7278,
        7349
      ]
    },
    {
      "content": "Step 3: Create a VPN gateway for the classic VNet",
      "pos": [
        7500,
        7549
      ]
    },
    {
      "content": "To create the VPN gateway for vnet01 by using the classic Azure portal, follow the instructions below.",
      "pos": [
        7552,
        7654
      ]
    },
    {
      "content": "Open the classic Azure Portal at https://manage.windowsazure.com.",
      "pos": [
        7659,
        7724
      ]
    },
    {
      "content": "If necessary, specify your credentials.",
      "pos": [
        7725,
        7764
      ]
    },
    {
      "pos": [
        7768,
        7832
      ],
      "content": "Scroll down on the list of <bpt id=\"p1\">**</bpt>ALL ITEMS<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>NETWORKS<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        7836,
        7919
      ],
      "content": "On the list of virtual networks, click <bpt id=\"p1\">**</bpt>vnet01<ept id=\"p1\">**</ept>, and then click on <bpt id=\"p2\">**</bpt>CONFIGURE<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        7923,
        8013
      ],
      "content": "Under <bpt id=\"p1\">**</bpt>site-to-site connectivity<ept id=\"p1\">**</ept>, enable the <bpt id=\"p2\">**</bpt>Connect to the local network<ept id=\"p2\">**</ept> checkbox."
    },
    {
      "pos": [
        8017,
        8111
      ],
      "content": "On the <bpt id=\"p1\">**</bpt>LOCAL NETWORK<ept id=\"p1\">**</ept> list, select <bpt id=\"p2\">**</bpt>vnet02<ept id=\"p2\">**</ept>, then click <bpt id=\"p3\">**</bpt>SAVE<ept id=\"p3\">**</ept>, and then click <bpt id=\"p4\">**</bpt>YES<ept id=\"p4\">**</ept>."
    },
    {
      "pos": [
        8115,
        8224
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>DASHBOARD<ept id=\"p1\">**</ept> and notice the message stating a gateway was not yet created, as shown in figure 2 below."
    },
    {
      "content": "VNet dashboard",
      "pos": [
        8232,
        8246
      ]
    },
    {
      "pos": [
        8320,
        8407
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>CREATE GATEWAY<ept id=\"p1\">**</ept> as shown in figure 3 below to create a VPN gateway for vnet01."
    },
    {
      "content": "VNet dashboard",
      "pos": [
        8415,
        8429
      ]
    },
    {
      "content": "In the list of gateway types, click <bpt id=\"p1\">**</bpt>DYNAMIC<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>YES<ept id=\"p2\">**</ept>.",
      "pos": [
        8503,
        8575
      ]
    },
    {
      "content": "Notice that the dashboard image changes, showing the gateway in yellow, while it is being created.",
      "pos": [
        8576,
        8674
      ]
    },
    {
      "content": "VNet dashboard",
      "pos": [
        8683,
        8697
      ]
    },
    {
      "pos": [
        8773,
        8826
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> This operation may take several minutes."
    },
    {
      "content": "Write down the public IP address for the gateway, as seen below, once it is created.",
      "pos": [
        8831,
        8915
      ]
    },
    {
      "content": "You will need this address to create a local network for the ARM VNet later.",
      "pos": [
        8916,
        8992
      ]
    },
    {
      "content": "VNet dashboard",
      "pos": [
        9000,
        9014
      ]
    },
    {
      "content": "Create a new VNet environment",
      "pos": [
        9088,
        9117
      ]
    },
    {
      "content": "Now that the classic VNet is up and running with a VM and a gateway, it is time to create the ARM VNet.",
      "pos": [
        9119,
        9222
      ]
    },
    {
      "content": "Step 1: Create a new VNet in ARM",
      "pos": [
        9228,
        9260
      ]
    },
    {
      "content": "To create the ARM VNet, with two subnets, and a local network for the classic VNet by using an ARM template, follow the instructions below.",
      "pos": [
        9262,
        9401
      ]
    },
    {
      "pos": [
        9406,
        9566
      ],
      "content": "Download the azuredeploy.json and azuredeploy-parameters.json files from <bpt id=\"p1\">[</bpt>git hub<ept id=\"p1\">](https://github.com/Azure/azure-quickstart-templates/tree/master/arm-asm-s2s)</ept>."
    },
    {
      "content": "Open the azuredeploy.json file in Visual Studio, and notice that the template creates four resources:",
      "pos": [
        9570,
        9671
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Local gateway<ept id=\"p1\">**</ept>: this resource represents the gateway created for the VNet you want to connect to.",
      "pos": [
        9680,
        9780
      ]
    },
    {
      "content": "In this scenario, the gateway for vnet01.",
      "pos": [
        9781,
        9822
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Virtual network<ept id=\"p1\">**</ept>: this resource represents an ARM VNet to be created.",
      "pos": [
        9829,
        9901
      ]
    },
    {
      "content": "In this scenario, vnet02.",
      "pos": [
        9902,
        9927
      ]
    },
    {
      "pos": [
        9934,
        10051
      ],
      "content": "<bpt id=\"p1\">**</bpt>Gateway public IP<ept id=\"p1\">**</ept>: this resource represents the public IP address for the gateway to be created for the ARM VNet."
    },
    {
      "pos": [
        10059,
        10149
      ],
      "content": "<bpt id=\"p1\">**</bpt>Gateway<ept id=\"p1\">**</ept>: this resource represents the gateway to be created for the ARM VNet (vnet02)."
    },
    {
      "content": "Notice the parameters used in this file.",
      "pos": [
        10154,
        10194
      ]
    },
    {
      "content": "Most of them have a default value.",
      "pos": [
        10195,
        10229
      ]
    },
    {
      "content": "You can change these values according to your needs.",
      "pos": [
        10230,
        10282
      ]
    },
    {
      "content": "Open the azuredeploy-parameters.json file in Visual Studio.",
      "pos": [
        10288,
        10347
      ]
    },
    {
      "content": "This file contains values to be used for the parameters in the template file.",
      "pos": [
        10348,
        10425
      ]
    },
    {
      "content": "Edit the following values, if necessary.",
      "pos": [
        10427,
        10467
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>subscriptionId<ept id=\"p1\">**</ept>: edit and paste your subscription id.",
      "pos": [
        10475,
        10531
      ]
    },
    {
      "content": "If you do not know your subscription id, run the <bpt id=\"p1\">**</bpt>Get-AzureSubscription<ept id=\"p1\">**</ept> PowerShell cmdlet to retrieve your id.",
      "pos": [
        10532,
        10645
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>location<ept id=\"p1\">**</ept>: specify the Azure location where the VNet will be created.",
      "pos": [
        10652,
        10724
      ]
    },
    {
      "content": "In this scenario, it will be <bpt id=\"p1\">**</bpt>Central US<ept id=\"p1\">**</ept>.",
      "pos": [
        10725,
        10769
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>virtualNetworkName<ept id=\"p1\">**</ept>: this is the name of the ARM VNet to be created.",
      "pos": [
        10776,
        10847
      ]
    },
    {
      "content": "In this scenario, <bpt id=\"p1\">**</bpt>vnet02<ept id=\"p1\">**</ept>.",
      "pos": [
        10848,
        10877
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>localGatewayName<ept id=\"p1\">**</ept>: this is the local network you want to connect to, from your new ARM VNet.",
      "pos": [
        10884,
        10979
      ]
    },
    {
      "content": "In this scenario, <bpt id=\"p1\">**</bpt>vnet01<ept id=\"p1\">**</ept>.",
      "pos": [
        10980,
        11009
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>localGatewayIpAddress<ept id=\"p1\">**</ept>: this is the public IP address for the gateway created for the network you want to connect to.",
      "pos": [
        11016,
        11136
      ]
    },
    {
      "content": "In this scenario, this is the IP address you wrote down in step 9 above, when creating the VPN gateway for <bpt id=\"p1\">**</bpt>vnet01<ept id=\"p1\">**</ept>.",
      "pos": [
        11137,
        11255
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>localGatewayAddressPrefix<ept id=\"p1\">**</ept>: this is the CIDR block for the local network your VNet will connect to.",
      "pos": [
        11262,
        11364
      ]
    },
    {
      "content": "In this scenario, the VNet you will connect to is <bpt id=\"p1\">**</bpt>vnet01<ept id=\"p1\">**</ept>, and its CIDR block is <bpt id=\"p2\">**</bpt>10.1.0.0/16<ept id=\"p2\">**</ept>.",
      "pos": [
        11365,
        11465
      ]
    },
    {
      "pos": [
        11472,
        11616
      ],
      "content": "<bpt id=\"p1\">**</bpt>gatewayPublicIPName<ept id=\"p1\">**</ept>: this is the name of the IP object to be created for the public IP of the gateway that will be created for the ARM VNet."
    },
    {
      "pos": [
        11623,
        11717
      ],
      "content": "<bpt id=\"p1\">**</bpt>gatewayName<ept id=\"p1\">**</ept>: this is the name of the gateway object that will be created for the ARM VNet."
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>addressPrefix<ept id=\"p1\">**</ept>: this is the CIDR block for the ARM VNet.",
      "pos": [
        11724,
        11783
      ]
    },
    {
      "content": "In this scenario, <bpt id=\"p1\">**</bpt>10.2.0.0/16<ept id=\"p1\">**</ept>.",
      "pos": [
        11784,
        11818
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>subnet1Prefix<ept id=\"p1\">**</ept>: this is the CIDR block for a subnet in the ARM VNet.",
      "pos": [
        11825,
        11896
      ]
    },
    {
      "content": "In this scenario, <bpt id=\"p1\">**</bpt>10.2.0.0/24<ept id=\"p1\">**</ept>.",
      "pos": [
        11897,
        11931
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>gatewaySubnetPrefix<ept id=\"p1\">**</ept>: this is the CIDR block for the gateway subnet in the ARM VNet.",
      "pos": [
        11938,
        12025
      ]
    },
    {
      "content": "In this scenario, <bpt id=\"p1\">**</bpt>10.2.200.0/29<ept id=\"p1\">**</ept>.",
      "pos": [
        12026,
        12062
      ]
    },
    {
      "pos": [
        12069,
        12145
      ],
      "content": "<bpt id=\"p1\">**</bpt>connectionName<ept id=\"p1\">**</ept>: this is the name of the connection object to be created."
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>sharedKey<ept id=\"p1\">**</ept>: this is the IPSec shared key for the connection.",
      "pos": [
        12152,
        12215
      ]
    },
    {
      "content": "In this scenario, <bpt id=\"p1\">**</bpt>abc123<ept id=\"p1\">**</ept>.",
      "pos": [
        12216,
        12245
      ]
    },
    {
      "content": "To create the ARM VNet, and its related objects, in a new resource group named <bpt id=\"p1\">**</bpt>RG1<ept id=\"p1\">**</ept>, run the following PowerShell command.",
      "pos": [
        12250,
        12375
      ]
    },
    {
      "content": "Make sure you change the path for the template file and the parameters file.",
      "pos": [
        12376,
        12452
      ]
    },
    {
      "pos": [
        12705,
        12758
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> This operation may take several minutes."
    },
    {
      "content": "From your browser, navigate to https://portal.azure.com/ and enter your credentials, if necessary.",
      "pos": [
        12763,
        12861
      ]
    },
    {
      "pos": [
        12865,
        12942
      ],
      "content": "Click on the <bpt id=\"p1\">**</bpt>RG1<ept id=\"p1\">**</ept> resource group tile in the Azure portal, as shown below."
    },
    {
      "content": "VNet dashboard",
      "pos": [
        12950,
        12964
      ]
    },
    {
      "content": "Notice the resources added to the group by using the ARM template.",
      "pos": [
        13038,
        13104
      ]
    },
    {
      "content": "Step 2: Create a new VM in ARM",
      "pos": [
        13110,
        13140
      ]
    },
    {
      "content": "To create a VM in the new VNet, from the Azure portal, follow the instructions below.",
      "pos": [
        13142,
        13227
      ]
    },
    {
      "pos": [
        13232,
        13352
      ],
      "content": "From the portal, click the <bpt id=\"p1\">**</bpt>NEW<ept id=\"p1\">**</ept> button, then click <bpt id=\"p2\">**</bpt>Compute<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Windows Server 2012 R2 Datacenter<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        13356,
        13528
      ],
      "content": "At the bottom of the right pane, in the <bpt id=\"p1\">**</bpt>Select a compute stack<ept id=\"p1\">**</ept>, select <bpt id=\"p2\">**</bpt>Use the Resource Manager stack<ept id=\"p2\">**</ept> to create the VM in ARM, as seen below, then click <bpt id=\"p3\">**</bpt>Create<ept id=\"p3\">**</ept>."
    },
    {
      "content": "VNet dashboard",
      "pos": [
        13536,
        13550
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Basics<ept id=\"p1\">**</ept> blade, enter the VM name, user name, password, subscription, resource group, and location for the VM, and then click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>.",
      "pos": [
        13624,
        13766
      ]
    },
    {
      "content": "The figure below shows the settings for this scenario.",
      "pos": [
        13767,
        13821
      ]
    },
    {
      "content": "VNet dashboard",
      "pos": [
        13829,
        13843
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Choose a size<ept id=\"p1\">**</ept> blade, select a size, and then click <bpt id=\"p2\">**</bpt>Select<ept id=\"p2\">**</ept>.",
      "pos": [
        13917,
        13990
      ]
    },
    {
      "content": "For this scenario, select <bpt id=\"p1\">**</bpt>D2<ept id=\"p1\">**</ept>.",
      "pos": [
        13991,
        14024
      ]
    },
    {
      "pos": [
        14028,
        14108
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Settings<ept id=\"p1\">**</ept> blade, click <bpt id=\"p2\">**</bpt>Virtual network<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>vnet02<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Subnet<ept id=\"p1\">**</ept>, then click <bpt id=\"p2\">**</bpt>Subnet1<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>OK<ept id=\"p3\">**</ept>.",
      "pos": [
        14112,
        14176
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>Summary<ept id=\"p1\">**</ept> blade should look similar to the figure below.",
      "pos": [
        14177,
        14239
      ]
    },
    {
      "content": "VNet dashboard",
      "pos": [
        14247,
        14261
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Create<ept id=\"p2\">**</ept> to create the VM.",
      "pos": [
        14335,
        14392
      ]
    },
    {
      "content": "You will see a new tile in the portal, showing the VM being provisioned, as seen below.",
      "pos": [
        14393,
        14480
      ]
    },
    {
      "content": "VNet dashboard",
      "pos": [
        14488,
        14502
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> This operation may take several minutes.",
      "pos": [
        14578,
        14631
      ]
    },
    {
      "content": "You can move on to the next part of this document.",
      "pos": [
        14632,
        14682
      ]
    },
    {
      "content": "Connect the two VNets",
      "pos": [
        14687,
        14708
      ]
    },
    {
      "content": "Now that you have two VNets with VMs connected to them, it's time to connect the VNets through the gateways previously established, and test the connection.",
      "pos": [
        14710,
        14866
      ]
    },
    {
      "content": "Step 1: Configure the gateway for the classic VNet",
      "pos": [
        14872,
        14922
      ]
    },
    {
      "content": "You need to configure the classic VNet to use the IP address of the gateway created for the ARM VNet (vnet02), then establish a connection from each VNet.",
      "pos": [
        14924,
        15078
      ]
    },
    {
      "content": "To do so, follow the instructions below.",
      "pos": [
        15079,
        15119
      ]
    },
    {
      "content": "To retrieve the IP address used for the gateway in the ARM VNet, run the command below, and notice the output.",
      "pos": [
        15124,
        15234
      ]
    },
    {
      "content": "Write down the address, you will need it to modify the local network settings for the classic VNet later.",
      "pos": [
        15235,
        15340
      ]
    },
    {
      "content": "Make sure you are using the Azure Service Management API for your PowerShell commands by running the command below.",
      "pos": [
        16378,
        16493
      ]
    },
    {
      "content": "Download your Azure network configuration file by running the command below.",
      "pos": [
        16547,
        16623
      ]
    },
    {
      "content": "Open the file you just downloaded, and edit the <bpt id=\"p1\">**</bpt>LocalNetworkSite<ept id=\"p1\">**</ept> element for <bpt id=\"p2\">**</bpt>vnet02<ept id=\"p2\">**</ept> to add the IP address of the gateway for the new VNet obtained in step 1 above.",
      "pos": [
        16700,
        16871
      ]
    },
    {
      "content": "The element should look similar to the sample below.",
      "pos": [
        16872,
        16924
      ]
    },
    {
      "content": "Save the file, then run the command below to configure the classic vnet.",
      "pos": [
        17179,
        17251
      ]
    },
    {
      "content": "Make sure you change the path to point the file you save in step 4 above.",
      "pos": [
        17252,
        17325
      ]
    },
    {
      "content": "Set the IPSec shared key for the classic VNet gateway by running the command below.",
      "pos": [
        17407,
        17490
      ]
    },
    {
      "content": "You should see an output similar to the one posted below.",
      "pos": [
        17491,
        17548
      ]
    },
    {
      "content": "Make sure you change the VNet names, if you are using your own pre-existing VNets.",
      "pos": [
        17549,
        17631
      ]
    },
    {
      "content": "Step 2: Configure the gateway for the ARM VNet",
      "pos": [
        17974,
        18020
      ]
    },
    {
      "content": "Now that you have the classic VNet gateway configured, it's time to establish the connection.",
      "pos": [
        18022,
        18115
      ]
    },
    {
      "content": "To do so, follow the instructions below.",
      "pos": [
        18116,
        18156
      ]
    },
    {
      "content": "From a PowerShell console, run the command below to switch to ARM mode.",
      "pos": [
        18161,
        18232
      ]
    },
    {
      "content": "Create the connection between the gateways, by running the following commands.",
      "pos": [
        18285,
        18363
      ]
    },
    {
      "content": "Open the Azure Portal at https://manage.windowsazure.com and, if necessary, enter your credentials.",
      "pos": [
        18869,
        18968
      ]
    },
    {
      "content": "Under <bpt id=\"p1\">**</bpt>ALL ITEMS<ept id=\"p1\">**</ept>, scroll down and click <bpt id=\"p2\">**</bpt>NETWORKS<ept id=\"p2\">**</ept>, then click <bpt id=\"p3\">**</bpt>vnet01<ept id=\"p3\">**</ept>, and then click <bpt id=\"p4\">**</bpt>DASHBOARD<ept id=\"p4\">**</ept>.",
      "pos": [
        18972,
        19081
      ]
    },
    {
      "content": "Notice the connection between <bpt id=\"p1\">**</bpt>vnet01<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>vnet02<ept id=\"p2\">**</ept> is now established, as seen below.",
      "pos": [
        19082,
        19172
      ]
    },
    {
      "content": "VNet dashboard",
      "pos": [
        19180,
        19194
      ]
    },
    {
      "content": "Although you can manage the classic VNet and its connection from the classic portal, it's recommended to use the new Azure portal.",
      "pos": [
        19268,
        19398
      ]
    },
    {
      "content": "To open the new portal, navigate to https://portal.azure.com.",
      "pos": [
        19399,
        19460
      ]
    },
    {
      "content": "In the new portal, click <bpt id=\"p1\">**</bpt>BROWSE ALL<ept id=\"p1\">**</ept>, then click <bpt id=\"p2\">**</bpt>Virtual networks (classic)<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>vnet01<ept id=\"p3\">**</ept>.",
      "pos": [
        19464,
        19574
      ]
    },
    {
      "content": "Notice the <bpt id=\"p1\">**</bpt>VPN connections<ept id=\"p1\">**</ept> pane shown below.",
      "pos": [
        19575,
        19623
      ]
    },
    {
      "content": "VNet dashboard",
      "pos": [
        19631,
        19645
      ]
    },
    {
      "content": "Step 3: Test the connectivity",
      "pos": [
        19720,
        19749
      ]
    },
    {
      "content": "Now that you have the two VNets connected, it is time to test the connectivity by pinging one VM from the other.",
      "pos": [
        19751,
        19863
      ]
    },
    {
      "content": "You will need to change the firewall settings in one of the VMs to allow ICMP, and then ping that VM from the other VM.",
      "pos": [
        19865,
        19984
      ]
    },
    {
      "content": "To do so, follow the instructions below.",
      "pos": [
        19985,
        20025
      ]
    },
    {
      "pos": [
        20030,
        20132
      ],
      "content": "From the Azure portal, click <bpt id=\"p1\">**</bpt>BROWSE ALL<ept id=\"p1\">**</ept>, then click <bpt id=\"p2\">**</bpt>Virtual machines<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>VM02<ept id=\"p3\">**</ept>."
    },
    {
      "content": "From the <bpt id=\"p1\">**</bpt>VM02<ept id=\"p1\">**</ept> blade, click <bpt id=\"p2\">**</bpt>Connect<ept id=\"p2\">**</ept>.",
      "pos": [
        20136,
        20179
      ]
    },
    {
      "content": "If needed, click <bpt id=\"p1\">**</bpt>Open<ept id=\"p1\">**</ept> on your browser security banner to open the RDP file.",
      "pos": [
        20180,
        20259
      ]
    },
    {
      "pos": [
        20263,
        20330
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Remote Desktop Connection<ept id=\"p1\">**</ept> dialog box, click <bpt id=\"p2\">**</bpt>Connect<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        20334,
        20411
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Windows Security<ept id=\"p1\">**</ept> dialog box, enter your VM user name and password."
    },
    {
      "pos": [
        20416,
        20479
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Remote Desktop Connection<ept id=\"p1\">**</ept> dialog box, click <bpt id=\"p2\">**</bpt>Yes<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        20483,
        20612
      ],
      "content": "Once you connect to the VM, from <bpt id=\"p1\">**</bpt>Server Manager<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>Tools<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Windows Firewall with Advanced Security<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        20616,
        20699
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Windows Firewall with Advanced Security<ept id=\"p1\">**</ept> window, click <bpt id=\"p2\">**</bpt>Inbound Rules<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        20703,
        20833
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Inbound Rules<ept id=\"p1\">**</ept> list, right click <bpt id=\"p2\">**</bpt>File and Printer Sharing (Echo Request - ICMPv4-In)<ept id=\"p2\">**</ept> and then click <bpt id=\"p3\">**</bpt>Enable Rule<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        20837,
        20926
      ],
      "content": "In the task bar, click the <bpt id=\"p1\">**</bpt>Windows PowerShell<ept id=\"p1\">**</ept> button, then run the following command."
    },
    {
      "content": "Write down the IP address for the VM.",
      "pos": [
        21288,
        21325
      ]
    },
    {
      "content": "In this scenario, <bpt id=\"p1\">**</bpt>10.2.0.101<ept id=\"p1\">**</ept>.",
      "pos": [
        21326,
        21359
      ]
    },
    {
      "content": "You will ping that address from the other VM to test connectivity between the VNets.",
      "pos": [
        21360,
        21444
      ]
    },
    {
      "content": "From the Azure portal, on the left pane, click <bpt id=\"p1\">**</bpt>Virtual machines (classic)<ept id=\"p1\">**</ept>, then click <bpt id=\"p2\">**</bpt>VM01<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Connect<ept id=\"p3\">**</ept>.",
      "pos": [
        21449,
        21576
      ]
    },
    {
      "content": "If needed, click <bpt id=\"p1\">**</bpt>Open<ept id=\"p1\">**</ept> on your browser security banner to open the RDP file.",
      "pos": [
        21577,
        21656
      ]
    },
    {
      "pos": [
        21661,
        21728
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Remote Desktop Connection<ept id=\"p1\">**</ept> dialog box, click <bpt id=\"p2\">**</bpt>Connect<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        21733,
        21810
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Windows Security<ept id=\"p1\">**</ept> dialog box, enter your VM user name and password."
    },
    {
      "pos": [
        21816,
        21879
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Remote Desktop Connection<ept id=\"p1\">**</ept> dialog box, click <bpt id=\"p2\">**</bpt>Yes<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        21884,
        21991
      ],
      "content": "In the task bar for the remote VM, click the <bpt id=\"p1\">**</bpt>Windows PowerShell<ept id=\"p1\">**</ept> button, then run the following command."
    },
    {
      "content": "Next Steps",
      "pos": [
        22254,
        22264
      ]
    },
    {
      "pos": [
        22268,
        22365
      ],
      "content": "Learn more about <bpt id=\"p1\">[</bpt>the Network Resource Provider (NRP) for ARM<ept id=\"p1\">](../resource-groups-networking.md)</ept>."
    },
    {
      "pos": [
        22368,
        22517
      ],
      "content": "View the general guidelines on how to <bpt id=\"p1\">[</bpt>create a S2S VPN connection between a classic VNet and an ARM VNet<ept id=\"p1\">](../virtual-networks-arm-asm-s2s-howto.md)</ept>."
    }
  ],
  "content": "<properties \n   pageTitle=\"How to connect classic VNets to ARM VNets in Azure - Solution Guide\"\n   description=\"Learn how to create a VPN connection between classic VNets and new VNets\"\n   services=\"virtual-network\"\n   documentationCenter=\"na\"\n   authors=\"telmosampaio\"\n   manager=\"carolz\"\n   editor=\"tysonn\" />\n<tags \n   ms.service=\"virtual-network\"\n   ms.devlang=\"na\"\n   ms.topic=\"article\"\n   ms.tgt_pltfrm=\"na\"\n   ms.workload=\"infrastructure-services\"\n   ms.date=\"07/14/2015\"\n   ms.author=\"telmos\" />\n\n# Connecting classic VNets to new VNets\n\nAzure currently has two management modes: Azure Service Manager (referred to as classic), and Azure Resource Manager (ARM). If you have been using Azure for some time, you probably have Azure VMs and instance roles running on a classic VNet. And your newer VMs and role instances may be running on a VNet created in ARM.\n\nIn such situations, you will want to ensure the new infrastructure is able to communicate with your classic resources. You can do so by creating a VPN connection between the two VNets. The figure below illustrates a sample environment with two VNets (classic and ARM), along with a secure tunnel connectivity between the VNets.\n\n![](..\\virtual-network\\media\\virtual-networks-arm-asm-s2s\\figure01.png)\n\n>[AZURE.NOTE] This document walks you through an end-to-end solution, for testing purposes. If you already have your VNets setup, and are familiar with VPN gateways and site-to-site connection in Azure, visit [Configure a S2S VPN between an ARM VNet and a classic VNet](../virtual-networks-arm-asm-s2s-howto.md).\n\nTo test this scenario, you will:\n\n1. [Create a classic VNet environment](#Create-a-classic-VNet-environment).\n2. [Create a new VNet environment](#Create-a-new-VNet-environment).\n3. [Connect the two VNets](#Connect-the-two-VNets).\n\nYou will execute the steps above by first using classic Azure management tools, including the classic portal, network configuration files, and Azure Service Manager PowerShell cmdlets; and later move on to the new management tools, including the new Azure portal, ARM templates, and ARM PowerShell cmdlets.\n\n>[AZURE.IMPORTANT] For VNets to be connected to one another, they cannot have a CIDR block clash. Make sure each VNet has a unique CIDR block! \n\n## Create a classic VNet environment\n\nYou can use an existing classic VNet to connect to a new ARM VNet. In this example, you will see how to create a new classic VNet, with two subnets, a gateway, and a VM for testing purposes.\n\n### Step 1: Create a classic VNet\n\nTo create a new VNet that maps to figure 1 above, follow the instructions below.\n\n1. From a PowerShell console, add you Azure account by running the command below.\n\n        Add-AzureAccount\n\n2. Follow the sign in dialog box instructions to log on with your Azure account.\n\n3. Make sure you are using Azure Service Management PowerShell cmdlets by running the command below.\n\n        Switch-AzureMode AzureServiceManagement\n\n4. Download your Azure network configuration file by running command below.\n\n        Get-AzureVNetConfig -ExportToFile c:\\Azure\\classicvnets.netcfg\n\n        XMLConfiguration                                OperationDescription                            OperationId                                     OperationStatus                                \n        ----------------                                --------------------                            -----------                                     ---------------                                \n        <?xml version=\"1.0\" encoding=\"utf-8\"?>...       Get-AzureVNetConfig                             04ab3224-7e1c-cc1a-8b75-96c6c300ddb8            Succeeded       \n\n5. Open the file you just downloaded, and add a local network site named *vnet02* that uses *10.2.0.0/16* as an address prefix, and any valid public IP address as a VPN gateway address. You can do so by adding a **LocalNetworkSite** element to the **LocalNetworkSites** element in your configuration file. The file snippet below shows a sample **LocalNetworksSites** element.\n\n        <LocalNetworkSites>\n          <LocalNetworkSite name=\"vnet02\">\n            <AddressSpace>\n              <AddressPrefix>10.2.0.0/16</AddressPrefix>\n            </AddressSpace>\n            <VPNGatewayAddress>2.0.0.2</VPNGatewayAddress>\n          </LocalNetworkSite>\n        </LocalNetworkSites>        \n\n6. In the **VirtualNetworkSites** element, add a new virtual network with an address prefix of *10.1.0.0/16* and two subnets according the scenario figure above. The file snippet below shows a sample **VirtualNetworkSites** element.\n    \n        <VirtualNetworkSites>\n          <VirtualNetworkSite name=\"vnet01\" Location=\"East US\">\n            <AddressSpace>\n              <AddressPrefix>10.1.0.0/16</AddressPrefix>\n            </AddressSpace>\n            <Subnets>\n              <Subnet name=\"Subnet1\">\n                <AddressPrefix>10.1.0.0/24</AddressPrefix>\n              </Subnet>\n              <Subnet name=\"GatewaySubnet\">\n                <AddressPrefix>10.1.200.0/29</AddressPrefix>\n              </Subnet>\n            </Subnets>\n          </VirtualNetworkSite>\n        </VirtualNetworkSites>\n\n7. Save the file, then upload it to Azure by running the command below. Make sure you change the file path as necessary for your environment.\n\n        Set-AzureVNetConfig -ConfigurationPath c:\\Azure\\classicvnets.netcfg\n\n        OperationDescription                                            OperationId                                                     OperationStatus                                                \n        --------------------                                            -----------                                                     ---------------                                                \n        Set-AzureVNetConfig                                             e0ee6e66-9167-cfa7-a746-7cab93c22013                            Succeeded \n\n### Step 2: Create a VM in the classic VNet\n\nTo create a VM in the classic VNet by using Azure Service Manager PowerShell cmdlets, follow the instructions below.\n\n1. Retrieve a VM image from Azure. The PowerShell command below retrieves the latest Windows Server 2012 R2 image available.\n\n        $WinImage = (Get-AzureVMImage `\n            | ?{$_.ImageFamily -eq \"Windows Server 2012 R2 Datacenter\"} `\n            | sort PublishedDate -Descending)[0]        \n\n2. Create a storage account to store the virtual hard drive (VHD) for the VM by running the command below.\n\n        $storage1 = New-AzureStorageAccount `\n            -StorageAccountName v1v2teststorage1 `\n            -Location \"East US\" \n\n3.  Create the VM by running the commands below. Make sure to replace the user name and password values.\n\n        $vm1 = New-AzureVMConfig -Name \"VM01\" -InstanceSize \"ExtraLarge\" `\n            -Image $WinImage.ImageName –AvailabilitySetName \"MyAVSet1\" `\n            -MediaLocation \"https://v1v2teststorage1.blob.core.windows.net/vhd/vm01.vhd\"\n        Add-AzureProvisioningConfig –VM $vm1 -Windows `\n            -AdminUserName \"user\" -Password \"P@ssw0rd\" \n\n4.  Connect the VM to *Subnet1* by running the commands below.\n\n        Set-AzureSubnet -SubnetNames \"Subnet1\" -VM $vm1\n        Set-AzureStaticVNetIP  -IPAddress \"10.1.0.101\" -VM $vm1\n\n5. Create a new cloud service to host the VM by running the command below.\n\n        New-AzureService -ServiceName \"v1v2svc01\" -Location \"East US\"\n        New-AzureVM -ServiceName \"v1v2svc01\" –VNetName \"vnet01\" –VMs $vm1\n\n### Step 3: Create a VPN gateway for the classic VNet \n\nTo create the VPN gateway for vnet01 by using the classic Azure portal, follow the instructions below.\n\n1. Open the classic Azure Portal at https://manage.windowsazure.com. If necessary, specify your credentials.\n2. Scroll down on the list of **ALL ITEMS** and click **NETWORKS**.\n3. On the list of virtual networks, click **vnet01**, and then click on **CONFIGURE**.\n4. Under **site-to-site connectivity**, enable the **Connect to the local network** checkbox.\n5. On the **LOCAL NETWORK** list, select **vnet02**, then click **SAVE**, and then click **YES**.\n6. Click **DASHBOARD** and notice the message stating a gateway was not yet created, as shown in figure 2 below.\n\n    ![VNet dashboard](..\\virtual-network\\media\\virtual-networks-arm-asm-s2s\\figure02.png)\n\n7. Click **CREATE GATEWAY** as shown in figure 3 below to create a VPN gateway for vnet01.\n\n    ![VNet dashboard](..\\virtual-network\\media\\virtual-networks-arm-asm-s2s\\figure03.png)\n\n8. In the list of gateway types, click **DYNAMIC**, and then click **YES**. Notice that the dashboard image changes, showing the gateway in yellow, while it is being created. \n\n    ![VNet dashboard](..\\virtual-network\\media\\virtual-networks-arm-asm-s2s\\figure04.png)\n\n    >[AZURE.NOTE] This operation may take several minutes.\n\n9. Write down the public IP address for the gateway, as seen below, once it is created. You will need this address to create a local network for the ARM VNet later.\n\n    ![VNet dashboard](..\\virtual-network\\media\\virtual-networks-arm-asm-s2s\\figure05.png)\n\n## Create a new VNet environment\n\nNow that the classic VNet is up and running with a VM and a gateway, it is time to create the ARM VNet.\n\n### Step 1: Create a new VNet in ARM\n\nTo create the ARM VNet, with two subnets, and a local network for the classic VNet by using an ARM template, follow the instructions below.\n\n1. Download the azuredeploy.json and azuredeploy-parameters.json files from [git hub](https://github.com/Azure/azure-quickstart-templates/tree/master/arm-asm-s2s).\n2. Open the azuredeploy.json file in Visual Studio, and notice that the template creates four resources: \n\n    - **Local gateway**: this resource represents the gateway created for the VNet you want to connect to. In this scenario, the gateway for vnet01.\n    - **Virtual network**: this resource represents an ARM VNet to be created. In this scenario, vnet02.\n    - **Gateway public IP**: this resource represents the public IP address for the gateway to be created for the ARM VNet. \n    - **Gateway**: this resource represents the gateway to be created for the ARM VNet (vnet02).\n\n3. Notice the parameters used in this file. Most of them have a default value. You can change these values according to your needs. \n\n4. Open the azuredeploy-parameters.json file in Visual Studio. This file contains values to be used for the parameters in the template file.  Edit the following values, if necessary.\n\n    - **subscriptionId**: edit and paste your subscription id. If you do not know your subscription id, run the **Get-AzureSubscription** PowerShell cmdlet to retrieve your id.\n    - **location**: specify the Azure location where the VNet will be created. In this scenario, it will be **Central US**.\n    - **virtualNetworkName**: this is the name of the ARM VNet to be created. In this scenario, **vnet02**.\n    - **localGatewayName**: this is the local network you want to connect to, from your new ARM VNet. In this scenario, **vnet01**.\n    - **localGatewayIpAddress**: this is the public IP address for the gateway created for the network you want to connect to. In this scenario, this is the IP address you wrote down in step 9 above, when creating the VPN gateway for **vnet01**.\n    - **localGatewayAddressPrefix**: this is the CIDR block for the local network your VNet will connect to. In this scenario, the VNet you will connect to is **vnet01**, and its CIDR block is **10.1.0.0/16**.\n    - **gatewayPublicIPName**: this is the name of the IP object to be created for the public IP of the gateway that will be created for the ARM VNet.\n    - **gatewayName**: this is the name of the gateway object that will be created for the ARM VNet.\n    - **addressPrefix**: this is the CIDR block for the ARM VNet. In this scenario, **10.2.0.0/16**.\n    - **subnet1Prefix**: this is the CIDR block for a subnet in the ARM VNet. In this scenario, **10.2.0.0/24**.\n    - **gatewaySubnetPrefix**: this is the CIDR block for the gateway subnet in the ARM VNet. In this scenario, **10.2.200.0/29**.\n    - **connectionName**: this is the name of the connection object to be created.\n    - **sharedKey**: this is the IPSec shared key for the connection. In this scenario, **abc123**.\n\n5. To create the ARM VNet, and its related objects, in a new resource group named **RG1**, run the following PowerShell command. Make sure you change the path for the template file and the parameters file.  \n\n        Switch-AzureMode AzureResourceManager\n        New-AzureResourceGroup -Name RG1 -Location \"Central US\" `\n            -TemplateFile C:\\Azure\\azuredeploy.json `\n            -TemplateParameterFile C:\\Azure\\azuredeploy-parameters.json     \n\n    >[AZURE.NOTE] This operation may take several minutes.\n\n7. From your browser, navigate to https://portal.azure.com/ and enter your credentials, if necessary.\n8. Click on the **RG1** resource group tile in the Azure portal, as shown below.\n\n    ![VNet dashboard](..\\virtual-network\\media\\virtual-networks-arm-asm-s2s\\figure06.png)\n\n9. Notice the resources added to the group by using the ARM template.\n\n### Step 2: Create a new VM in ARM\n\nTo create a VM in the new VNet, from the Azure portal, follow the instructions below.\n\n1. From the portal, click the **NEW** button, then click **Compute**, and then click **Windows Server 2012 R2 Datacenter**.\n2. At the bottom of the right pane, in the **Select a compute stack**, select **Use the Resource Manager stack** to create the VM in ARM, as seen below, then click **Create**.\n\n    ![VNet dashboard](..\\virtual-network\\media\\virtual-networks-arm-asm-s2s\\figure07.png)\n\n3. In the **Basics** blade, enter the VM name, user name, password, subscription, resource group, and location for the VM, and then click **OK**. The figure below shows the settings for this scenario.\n\n    ![VNet dashboard](..\\virtual-network\\media\\virtual-networks-arm-asm-s2s\\figure08.png)\n\n4. In the **Choose a size** blade, select a size, and then click **Select**. For this scenario, select **D2**.\n5. In the **Settings** blade, click **Virtual network**, and then click **vnet02**.\n6. Click **Subnet**, then click **Subnet1**, and then click **OK**. The **Summary** blade should look similar to the figure below.\n\n    ![VNet dashboard](..\\virtual-network\\media\\virtual-networks-arm-asm-s2s\\figure09.png)\n\n7. Click **OK**, and then click **Create** to create the VM. You will see a new tile in the portal, showing the VM being provisioned, as seen below.\n\n    ![VNet dashboard](..\\virtual-network\\media\\virtual-networks-arm-asm-s2s\\figure10.png)\n\n    >[AZURE.NOTE] This operation may take several minutes. You can move on to the next part of this document.\n\n## Connect the two VNets\n\nNow that you have two VNets with VMs connected to them, it's time to connect the VNets through the gateways previously established, and test the connection.\n\n### Step 1: Configure the gateway for the classic VNet\n\nYou need to configure the classic VNet to use the IP address of the gateway created for the ARM VNet (vnet02), then establish a connection from each VNet. To do so, follow the instructions below.\n\n1. To retrieve the IP address used for the gateway in the ARM VNet, run the command below, and notice the output. Write down the address, you will need it to modify the local network settings for the classic VNet later.\n\n        Get-AzurePublicIpAddress | ?{$_.Name -eq \"ArmAsmS2sGatewayIp\"}\n\n        Name                     : ArmAsmS2sGatewayIp\n        ResourceGroupName        : RG1\n        Location                 : centralus\n        Id                       : /subscriptions/628dad04-b5d1-4f10-b3a4-dc61d88cf97c/resourceGroups/RG1/providers/Microsoft.Network/publicIPAddresses/ArmAsmS2sGatewayIp\n        Etag                     : W/\"1ee6c1bd-8be1-488e-a571-77b05b49e33a\"\n        ProvisioningState        : Succeeded\n        Tags                     : \n        PublicIpAllocationMethod : Dynamic\n        IpAddress                : 23.99.213.28\n        IdleTimeoutInMinutes     : 4\n        IpConfiguration          : {\n                                     \"Id\": \"/subscriptions/628dad04-b5d1-4f10-b3a4-dc61d88cf97c/resourceGroups/RG1/providers/Microsoft.Network/virtualNetworkGateways/ArmAsmGateway/ipConfigurations/vn\n                                   etGatewayConfig\"\n                                   }\n        DnsSettings              : null\n\n2. Make sure you are using the Azure Service Management API for your PowerShell commands by running the command below.\n\n        Switch-AzureMode AzureServiceManagement\n\n3. Download your Azure network configuration file by running the command below.\n\n        Get-AzureVNetConfig -ExportToFile c:\\Azure\\classicvnets.netcfg\n\n4. Open the file you just downloaded, and edit the **LocalNetworkSite** element for **vnet02** to add the IP address of the gateway for the new VNet obtained in step 1 above. The element should look similar to the sample below.\n\n          <LocalNetworkSite name=\"vnet03\">\n            <AddressSpace>\n              <AddressPrefix>10.3.0.0/16</AddressPrefix>\n            </AddressSpace>\n            <VPNGatewayAddress>23.99.213.28</VPNGatewayAddress>\n          </LocalNetworkSite>\n\n5. Save the file, then run the command below to configure the classic vnet. Make sure you change the path to point the file you save in step 4 above.\n\n        Set-AzureVNetConfig -ConfigurationPath c:\\Azure\\classicvnets.netcfg\n\n6. Set the IPSec shared key for the classic VNet gateway by running the command below. You should see an output similar to the one posted below. Make sure you change the VNet names, if you are using your own pre-existing VNets.\n\n        Set-AzureVNetGatewayKey -VNetName vnet01 -LocalNetworkSiteName vnet02 -SharedKey abc123 \n\n        Error          : \n        HttpStatusCode : OK\n        Id             : b2154475-bf00-480e-ad1e-aed893014979\n        Status         : Successful\n        RequestId      : 08257a09d723cb8982c47b85edb0e08a\n        StatusCode     : OK\n\n### Step 2: Configure the gateway for the ARM VNet\n\nNow that you have the classic VNet gateway configured, it's time to establish the connection. To do so, follow the instructions below.\n\n1. From a PowerShell console, run the command below to switch to ARM mode. \n\n        Switch-AzureMode AzureResourceManager\n\n2. Create the connection between the gateways, by running the following commands.\n\n        $vnet01gateway = Get-AzureLocalNetworkGateway -Name vnet01 -ResourceGroupName RG1\n        $vnet02gateway = Get-AzureVirtualNetworkGateway -Name ArmAsmGateway -ResourceGroupName RG1\n        \n        New-AzureVirtualNetworkGatewayConnection -Name arm-asm-s2s-connection `\n            -ResourceGroupName RG1 -Location \"Central US\" -VirtualNetworkGateway1 $vnet02gateway `\n            -LocalNetworkGateway2 $vnet01gateway -ConnectionType IPsec `\n            -RoutingWeight 10 -SharedKey 'abc123'\n\n3. Open the Azure Portal at https://manage.windowsazure.com and, if necessary, enter your credentials.\n4. Under **ALL ITEMS**, scroll down and click **NETWORKS**, then click **vnet01**, and then click **DASHBOARD**. Notice the connection between **vnet01** and **vnet02** is now established, as seen below.\n\n    ![VNet dashboard](..\\virtual-network\\media\\virtual-networks-arm-asm-s2s\\figure11.png)\n\n5. Although you can manage the classic VNet and its connection from the classic portal, it's recommended to use the new Azure portal. To open the new portal, navigate to https://portal.azure.com.\n6. In the new portal, click **BROWSE ALL**, then click **Virtual networks (classic)**, and then click **vnet01**. Notice the **VPN connections** pane shown below.\n\n    ![VNet dashboard](..\\virtual-network\\media\\virtual-networks-arm-asm-s2s\\figure12.png)\n\n### Step 3: Test the connectivity\n\nNow that you have the two VNets connected, it is time to test the connectivity by pinging one VM from the other.  You will need to change the firewall settings in one of the VMs to allow ICMP, and then ping that VM from the other VM. To do so, follow the instructions below.\n\n1. From the Azure portal, click **BROWSE ALL**, then click **Virtual machines**, and then click **VM02**.\n2. From the **VM02** blade, click **Connect**. If needed, click **Open** on your browser security banner to open the RDP file.\n3. In the **Remote Desktop Connection** dialog box, click **Connect**.\n4. In the **Windows Security** dialog box, enter your VM user name and password. \n5. In the **Remote Desktop Connection** dialog box, click **Yes**.\n6. Once you connect to the VM, from **Server Manager**, click **Tools**, and then click **Windows Firewall with Advanced Security**.\n7. In the **Windows Firewall with Advanced Security** window, click **Inbound Rules**.\n8. In the **Inbound Rules** list, right click **File and Printer Sharing (Echo Request - ICMPv4-In)** and then click **Enable Rule**.\n9. In the task bar, click the **Windows PowerShell** button, then run the following command.\n\n        ipconfig\n\n        Connection-specific DNS Suffix  . : 4oxp4ce0c5rulb1iey4cdqhasg.gx.internal.cloudapp.net\n        Link-local IPv6 Address . . . . . : fe80::8cea:a98a:5c48:4c58%12\n        IPv4 Address. . . . . . . . . . . : 10.2.0.101\n        Subnet Mask . . . . . . . . . . . : 255.255.255.0\n        Default Gateway . . . . . . . . . : 10.2.0.101\n\n10. Write down the IP address for the VM. In this scenario, **10.2.0.101**. You will ping that address from the other VM to test connectivity between the VNets.\n11. From the Azure portal, on the left pane, click **Virtual machines (classic)**, then click **VM01**, and then click **Connect**. If needed, click **Open** on your browser security banner to open the RDP file.\n12. In the **Remote Desktop Connection** dialog box, click **Connect**.\n13. In the **Windows Security** dialog box, enter your VM user name and password. \n14. In the **Remote Desktop Connection** dialog box, click **Yes**.\n15. In the task bar for the remote VM, click the **Windows PowerShell** button, then run the following command.\n\n        ping 10.2.0.101\n\n        Reply from 10.2.0.101: bytes=32 time=32ms TTL=126\n        Reply from 10.2.0.101: bytes=32 time=32ms TTL=126\n        Reply from 10.2.0.101: bytes=32 time=32ms TTL=126\n        Reply from 10.2.0.101: bytes=32 time=32ms TTL=126\n\n## Next Steps\n\n- Learn more about [the Network Resource Provider (NRP) for ARM](../resource-groups-networking.md).\n- View the general guidelines on how to [create a S2S VPN connection between a classic VNet and an ARM VNet](../virtual-networks-arm-asm-s2s-howto.md).\n"
}