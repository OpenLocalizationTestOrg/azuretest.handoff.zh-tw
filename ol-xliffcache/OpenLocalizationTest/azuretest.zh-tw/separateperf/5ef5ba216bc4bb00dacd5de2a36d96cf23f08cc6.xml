{
  "nodes": [
    {
      "content": "Create and use a SAS with the Blob Service | Microsoft Azure",
      "pos": [
        28,
        88
      ]
    },
    {
      "content": "Explore generating and using shared access signatures with the Blob service",
      "pos": [
        108,
        183
      ]
    },
    {
      "content": "Shared Access Signatures, Part 2: Create and Use a SAS with the Blob Service",
      "pos": [
        495,
        571
      ]
    },
    {
      "content": "Overview",
      "pos": [
        576,
        584
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>Part 1<ept id=\"p1\">](storage-dotnet-shared-access-signature-part-1.md)</ept> of this tutorial explored shared access signatures (SAS) and explained best practices for using them.",
      "pos": [
        586,
        746
      ]
    },
    {
      "content": "Part 2 shows you how to generate and then use shared access signatures with the Azure Blob service.",
      "pos": [
        747,
        846
      ]
    },
    {
      "content": "The examples are written in C# and use the Azure Storage Client Library for .NET.",
      "pos": [
        847,
        928
      ]
    },
    {
      "content": "The scenarios covered include these aspects of working with shared access signatures:",
      "pos": [
        929,
        1014
      ]
    },
    {
      "content": "Generating a shared access signature on a container",
      "pos": [
        1018,
        1069
      ]
    },
    {
      "content": "Generating a shared access signature on a blob",
      "pos": [
        1072,
        1118
      ]
    },
    {
      "content": "Creating a stored access policy to manage signatures on a container's resources",
      "pos": [
        1121,
        1200
      ]
    },
    {
      "content": "Testing the shared access signatures from a client application",
      "pos": [
        1203,
        1265
      ]
    },
    {
      "content": "About this Tutorial",
      "pos": [
        1270,
        1289
      ]
    },
    {
      "content": "In this tutorial, we'll focus on creating shared access signatures for containers and blobs by creating two console applications.",
      "pos": [
        1290,
        1419
      ]
    },
    {
      "content": "The first console application generates shared access signatures on a container and on a blob.",
      "pos": [
        1420,
        1514
      ]
    },
    {
      "content": "This application has knowledge of the storage account keys.",
      "pos": [
        1515,
        1574
      ]
    },
    {
      "content": "The second console application, which will act as a client application, accesses container and blob resources using the shared access signatures created with the first application.",
      "pos": [
        1575,
        1755
      ]
    },
    {
      "content": "This application uses the shared access signatures only to authenticate its access to the container and blob resources - it does not have knowledge of the account keys.",
      "pos": [
        1756,
        1924
      ]
    },
    {
      "content": "Part 1: Create a Console Application to Generate Shared Access Signatures",
      "pos": [
        1929,
        2002
      ]
    },
    {
      "content": "First, ensure that you have the Azure Storage Client Library for .NET installed.",
      "pos": [
        2004,
        2084
      ]
    },
    {
      "content": "You can install the <bpt id=\"p1\">[</bpt>NuGet package<ept id=\"p1\">]</ept><bpt id=\"p2\">(http://nuget.org/packages/WindowsAzure.Storage/ \"</bpt>NuGet package<ept id=\"p2\">\")</ept> containing the most up-to-date assemblies for the client library; this is the recommended method for ensuring that you have the most recent fixes.",
      "pos": [
        2085,
        2332
      ]
    },
    {
      "content": "You can also download the client library as part of the most recent version of the <bpt id=\"p1\">[</bpt>Azure SDK for .NET<ept id=\"p1\">](http://azure.microsoft.com/downloads/)</ept>.",
      "pos": [
        2333,
        2476
      ]
    },
    {
      "content": "In Visual Studio, create a new Windows console application and name it <bpt id=\"p1\">**</bpt>GenerateSharedAccessSignatures<ept id=\"p1\">**</ept>.",
      "pos": [
        2478,
        2584
      ]
    },
    {
      "content": "Add references to  <bpt id=\"p1\">**</bpt>Microsoft.WindowsAzure.Configuration.dll<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Microsoft.WindowsAzure.Storage.dll<ept id=\"p2\">**</ept>, using either of the following approaches:",
      "pos": [
        2585,
        2734
      ]
    },
    {
      "content": "If you want to install the NuGet package, first install the <bpt id=\"p1\">[</bpt>NuGet Package Manager Extension for Visual Studio<ept id=\"p1\">](http://visualstudiogallery.msdn.microsoft.com/27077b70-9dad-4c64-adcf-c7cf6bc9970c)</ept>.",
      "pos": [
        2740,
        2936
      ]
    },
    {
      "content": "In Visual Studio, select <bpt id=\"p1\">**</bpt>Project | Manage NuGet Packages<ept id=\"p1\">**</ept>, search online for <bpt id=\"p2\">**</bpt>Azure Storage<ept id=\"p2\">**</ept>, and follow the instructions to install.",
      "pos": [
        2937,
        3075
      ]
    },
    {
      "content": "Alternatively, locate the assemblies in your installation of the Azure SDK and add references to them.",
      "pos": [
        3080,
        3182
      ]
    },
    {
      "pos": [
        3185,
        3259
      ],
      "content": "At the top of the Program.cs file, add the following <bpt id=\"p1\">**</bpt>using<ept id=\"p1\">**</ept> statements:"
    },
    {
      "content": "Edit the app.config file so that it contains a configuration setting with a connection string that points to your storage account.",
      "pos": [
        3410,
        3540
      ]
    },
    {
      "content": "Your app.config file should look similar to this one:",
      "pos": [
        3541,
        3594
      ]
    },
    {
      "content": "Generate a Shared Access Signature URI for a Container",
      "pos": [
        3918,
        3972
      ]
    },
    {
      "content": "To begin with, we'll add a method to generate a shared access signature on a new container.",
      "pos": [
        3974,
        4065
      ]
    },
    {
      "content": "In this case the signature is not associated with a stored access policy, so it carries on the URI the information indicating its expiry time and the permissions that it grants.",
      "pos": [
        4066,
        4243
      ]
    },
    {
      "pos": [
        4245,
        4360
      ],
      "content": "First, add code to the <bpt id=\"p1\">**</bpt>Main()<ept id=\"p1\">**</ept> method to authenticate access to your storage account and create a new container:"
    },
    {
      "content": "Next, add a new method that generates the shared access signature for the container and returns the signature URI:",
      "pos": [
        5172,
        5286
      ]
    },
    {
      "pos": [
        6152,
        6342
      ],
      "content": "Add the following lines at the bottom of the <bpt id=\"p1\">**</bpt>Main()<ept id=\"p1\">**</ept> method, before the call to <bpt id=\"p2\">**</bpt>Console.ReadLine()<ept id=\"p2\">**</ept>, to call <bpt id=\"p3\">**</bpt>GetContainerSasUri()<ept id=\"p3\">**</ept> and write the signature URI to the console window:"
    },
    {
      "content": "Compile and run to output the shared access signature URI for the new container.",
      "pos": [
        6524,
        6604
      ]
    },
    {
      "content": "The URI will be similar to the following URI:",
      "pos": [
        6605,
        6650
      ]
    },
    {
      "content": "Once you have run the code, the shared access signature that you created on the container will be valid for the next twenty-four hours.",
      "pos": [
        6832,
        6967
      ]
    },
    {
      "content": "The signature grants a client permission to list blobs in the container and to write a new blob to the container.",
      "pos": [
        6968,
        7081
      ]
    },
    {
      "content": "Generate a Shared Access Signature URI for a Blob",
      "pos": [
        7087,
        7136
      ]
    },
    {
      "content": "Next, we'll write similar code to create a new blob within the container and generate a shared access signature for it.",
      "pos": [
        7138,
        7257
      ]
    },
    {
      "content": "This shared access signature is not associated with a stored access policy, so it includes the start time, expiry time, and permission information on the URI.",
      "pos": [
        7258,
        7416
      ]
    },
    {
      "content": "Add a new method that creates a new blob and write some text to it, then generates a shared access signature and returns the signature URI:",
      "pos": [
        7418,
        7557
      ]
    },
    {
      "pos": [
        9133,
        9333
      ],
      "content": "At the bottom of the <bpt id=\"p1\">**</bpt>Main()<ept id=\"p1\">**</ept> method, add the following lines to call <bpt id=\"p2\">**</bpt>GetBlobSasUri()<ept id=\"p2\">**</ept>, before the call to <bpt id=\"p3\">**</bpt>Console.ReadLine()<ept id=\"p3\">**</ept>, and write the shared access signature URI to the console window:"
    },
    {
      "content": "Compile and run to output the shared access signature URI for the new blob.",
      "pos": [
        9532,
        9607
      ]
    },
    {
      "content": "The URI will be similar to the following URI:",
      "pos": [
        9608,
        9653
      ]
    },
    {
      "content": "Create a Stored Access Policy on the Container",
      "pos": [
        9866,
        9912
      ]
    },
    {
      "content": "Now let's create a stored access policy on the container, which will define the constraints for any shared access signatures that are associated with it.",
      "pos": [
        9914,
        10067
      ]
    },
    {
      "content": "In the previous examples, we specified the start time (implicitly or explicitly), the expiry time, and the permissions on the shared access signature URI itself.",
      "pos": [
        10069,
        10230
      ]
    },
    {
      "content": "In the following examples, we will specify these on the stored access policy and not on the shared access signature.",
      "pos": [
        10231,
        10347
      ]
    },
    {
      "content": "Doing so enables us to change these constraints without reissuing the shared access signature.",
      "pos": [
        10348,
        10442
      ]
    },
    {
      "content": "It's possible to have one or more of the constraints on the shared access signature and the remainder on the stored access policy.",
      "pos": [
        10444,
        10574
      ]
    },
    {
      "content": "However, you can only specify the start time, expiry time, and permissions in one place or the other; for example, you can't specify permissions on the shared access signature and also specify them on the stored access policy.",
      "pos": [
        10575,
        10801
      ]
    },
    {
      "content": "Note that when you add an access policy to a container, you must get the container's existing permissions, add the new access policy, and then set the container's permissions.",
      "pos": [
        10803,
        10978
      ]
    },
    {
      "content": "Add a new method that creates a new stored access policy on a container and returns the name of the policy:",
      "pos": [
        10980,
        11087
      ]
    },
    {
      "pos": [
        11940,
        12147
      ],
      "content": "At the bottom of the <bpt id=\"p1\">**</bpt>Main()<ept id=\"p1\">**</ept> method, before the call to <bpt id=\"p2\">**</bpt>Console.ReadLine()<ept id=\"p2\">**</ept>, add the following lines to first clear any existing access policies and then call the <bpt id=\"p3\">**</bpt>CreateSharedAccessPolicy()<ept id=\"p3\">**</ept> method:"
    },
    {
      "content": "Note that when you clear the access policies on a container, you must first get the container's existing permissions, then clear the permissions, then set the permissions again.",
      "pos": [
        12653,
        12830
      ]
    },
    {
      "content": "Generate a Shared Access Signature URI on the Container That Uses an Access Policy",
      "pos": [
        12836,
        12918
      ]
    },
    {
      "content": "Next, we'll create another shared access signature on the container that we created earlier, but this time we'll associate the signature with the access policy that we created in the previous example.",
      "pos": [
        12920,
        13120
      ]
    },
    {
      "content": "Add a new method to generate another shared access signature on the container:",
      "pos": [
        13122,
        13200
      ]
    },
    {
      "pos": [
        13727,
        13886
      ],
      "content": "At the bottom of the <bpt id=\"p1\">**</bpt>Main()<ept id=\"p1\">**</ept> method, before the call to <bpt id=\"p2\">**</bpt>Console.ReadLine()<ept id=\"p2\">**</ept>, add the following lines to call the <bpt id=\"p3\">**</bpt>GetContainerSasUriWithPolicy<ept id=\"p3\">**</ept> method:"
    },
    {
      "content": "Generate a Shared Access Signature URI on the Blob That Uses an Access Policy",
      "pos": [
        14161,
        14238
      ]
    },
    {
      "content": "Finally, we'll add a similar method to create another blob and generate a shared access signature that's associated with an access policy.",
      "pos": [
        14240,
        14378
      ]
    },
    {
      "content": "Add a new method to create a blob and generate a shared access signature:",
      "pos": [
        14380,
        14453
      ]
    },
    {
      "pos": [
        15514,
        15668
      ],
      "content": "At the bottom of the <bpt id=\"p1\">**</bpt>Main()<ept id=\"p1\">**</ept> method, before the call to <bpt id=\"p2\">**</bpt>Console.ReadLine()<ept id=\"p2\">**</ept>, add the following lines to call the <bpt id=\"p3\">**</bpt>GetBlobSasUriWithPolicy<ept id=\"p3\">**</ept> method:"
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>Main()<ept id=\"p1\">**</ept> method should now look like this in its entirety.",
      "pos": [
        15947,
        16011
      ]
    },
    {
      "content": "Run it to write the shared access signature URIs to the console window, then copy and paste them into a text file for use in the second part of this tutorial.",
      "pos": [
        16012,
        16170
      ]
    },
    {
      "content": "When you run the GenerateSharedAccessSignatures console application, you'll see output similar to the following in the console window.",
      "pos": [
        18375,
        18509
      ]
    },
    {
      "content": "These are the shared access signatures that you'll use in Part 2 of the tutorial.",
      "pos": [
        18510,
        18591
      ]
    },
    {
      "content": "sas-console-output-1",
      "pos": [
        18595,
        18615
      ]
    },
    {
      "content": "Part 2: Create a Console Application to Test the Shared Access Signatures",
      "pos": [
        18643,
        18716
      ]
    },
    {
      "content": "To test the shared access signatures created in the previous examples, we'll create a second console application that uses the signatures to perform operations on the container and on a blob.",
      "pos": [
        18718,
        18909
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> If more than 24 hours have passed since you completed the first part of the tutorial, the signatures you generated will no longer be valid.",
      "pos": [
        18913,
        19065
      ]
    },
    {
      "content": "In this case, you should run the code in the first console application to generate fresh shared access signatures for use in the second part of the tutorial.",
      "pos": [
        19066,
        19223
      ]
    },
    {
      "content": "In Visual Studio, create a new Windows console application and name it <bpt id=\"p1\">**</bpt>ConsumeSharedAccessSignatures<ept id=\"p1\">**</ept>.",
      "pos": [
        19225,
        19330
      ]
    },
    {
      "content": "Add references to <bpt id=\"p1\">**</bpt>Microsoft.WindowsAzure.Configuration.dll<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Microsoft.WindowsAzure.Storage.dll<ept id=\"p2\">**</ept>, as you did previously.",
      "pos": [
        19331,
        19460
      ]
    },
    {
      "pos": [
        19462,
        19536
      ],
      "content": "At the top of the Program.cs file, add the following <bpt id=\"p1\">**</bpt>using<ept id=\"p1\">**</ept> statements:"
    },
    {
      "pos": [
        19653,
        19821
      ],
      "content": "In the body of the <bpt id=\"p1\">**</bpt>Main()<ept id=\"p1\">**</ept> method, add the following constants, and update their values to the shared access signatures that you generated in part 1 of the tutorial."
    },
    {
      "content": "Add a Method to Try Container Operations Using a Shared Access Signature",
      "pos": [
        20146,
        20218
      ]
    },
    {
      "content": "Next, we'll add a method that tests some representative container operations using a shared access signature on the container.",
      "pos": [
        20220,
        20346
      ]
    },
    {
      "content": "Note that the shared access signature is used to return a reference to the container, authenticating access to the container based on the signature alone.",
      "pos": [
        20347,
        20501
      ]
    },
    {
      "content": "Add the following method to Program.cs:",
      "pos": [
        20503,
        20542
      ]
    },
    {
      "pos": [
        23808,
        23943
      ],
      "content": "Update the <bpt id=\"p1\">**</bpt>Main()<ept id=\"p1\">**</ept> method to call <bpt id=\"p2\">**</bpt>UseContainerSAS()<ept id=\"p2\">**</ept> with both of the shared access signatures that you created on the container:"
    },
    {
      "content": "Add a Method to Try Blob Operations Using a Shared Access Signature",
      "pos": [
        24530,
        24597
      ]
    },
    {
      "content": "Finally, we'll add a method that tests some representative blob operations using a shared access signature on the blob.",
      "pos": [
        24599,
        24718
      ]
    },
    {
      "content": "In this case we use the constructor <bpt id=\"p1\">**</bpt>CloudBlockBlob(String)<ept id=\"p1\">**</ept>, passing in the shared access signature, to return a reference to the blob.",
      "pos": [
        24719,
        24857
      ]
    },
    {
      "content": "No other authentication is required; it's based on the signature alone.",
      "pos": [
        24858,
        24929
      ]
    },
    {
      "content": "Add the following method to Program.cs:",
      "pos": [
        24931,
        24970
      ]
    },
    {
      "pos": [
        27402,
        27527
      ],
      "content": "Update the <bpt id=\"p1\">**</bpt>Main()<ept id=\"p1\">**</ept> method to call <bpt id=\"p2\">**</bpt>UseBlobSAS()<ept id=\"p2\">**</ept> with both of the shared access signatures that you created on the blob:"
    },
    {
      "content": "Run the console application and observe the output to see which operations are permitted for which signatures.",
      "pos": [
        28311,
        28421
      ]
    },
    {
      "content": "The output in the console window will look similar to the following:",
      "pos": [
        28422,
        28490
      ]
    },
    {
      "content": "sas-console-output-2",
      "pos": [
        28494,
        28514
      ]
    },
    {
      "content": "Next Steps",
      "pos": [
        28542,
        28552
      ]
    },
    {
      "content": "Shared Access Signatures, Part 1: Understanding the SAS Model",
      "pos": [
        28555,
        28616
      ]
    },
    {
      "content": "Manage Access to Azure Storage Resources",
      "pos": [
        28671,
        28711
      ]
    },
    {
      "content": "Delegating Access with a Shared Access Signature (REST API)",
      "pos": [
        28770,
        28829
      ]
    },
    {
      "content": "Introducing Table and Queue SAS",
      "pos": [
        28888,
        28919
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"Create and use a SAS with the Blob Service | Microsoft Azure\" \n    description=\"Explore generating and using shared access signatures with the Blob service\" \n    services=\"storage\" \n    documentationCenter=\"\" \n    authors=\"tamram\" \n    manager=\"adinah\" \n    editor=\"cgronlun\"/>\n\n<tags \n    ms.service=\"storage\" \n    ms.workload=\"storage\" \n    ms.tgt_pltfrm=\"na\" \n    ms.devlang=\"dotnet\" \n    ms.topic=\"article\" \n    ms.date=\"06/08/2015\" \n    ms.author=\"tamram\"/>\n\n\n# Shared Access Signatures, Part 2: Create and Use a SAS with the Blob Service\n\n## Overview\n\n[Part 1](storage-dotnet-shared-access-signature-part-1.md) of this tutorial explored shared access signatures (SAS) and explained best practices for using them. Part 2 shows you how to generate and then use shared access signatures with the Azure Blob service. The examples are written in C# and use the Azure Storage Client Library for .NET. The scenarios covered include these aspects of working with shared access signatures:\n\n- Generating a shared access signature on a container\n- Generating a shared access signature on a blob\n- Creating a stored access policy to manage signatures on a container's resources\n- Testing the shared access signatures from a client application\n\n## About this Tutorial\nIn this tutorial, we'll focus on creating shared access signatures for containers and blobs by creating two console applications. The first console application generates shared access signatures on a container and on a blob. This application has knowledge of the storage account keys. The second console application, which will act as a client application, accesses container and blob resources using the shared access signatures created with the first application. This application uses the shared access signatures only to authenticate its access to the container and blob resources - it does not have knowledge of the account keys.\n\n## Part 1: Create a Console Application to Generate Shared Access Signatures\n\nFirst, ensure that you have the Azure Storage Client Library for .NET installed. You can install the [NuGet package](http://nuget.org/packages/WindowsAzure.Storage/ \"NuGet package\") containing the most up-to-date assemblies for the client library; this is the recommended method for ensuring that you have the most recent fixes. You can also download the client library as part of the most recent version of the [Azure SDK for .NET](http://azure.microsoft.com/downloads/).\n\nIn Visual Studio, create a new Windows console application and name it **GenerateSharedAccessSignatures**. Add references to  **Microsoft.WindowsAzure.Configuration.dll** and **Microsoft.WindowsAzure.Storage.dll**, using either of the following approaches:\n\n-   If you want to install the NuGet package, first install the [NuGet Package Manager Extension for Visual Studio](http://visualstudiogallery.msdn.microsoft.com/27077b70-9dad-4c64-adcf-c7cf6bc9970c). In Visual Studio, select **Project | Manage NuGet Packages**, search online for **Azure Storage**, and follow the instructions to install.\n-   Alternatively, locate the assemblies in your installation of the Azure SDK and add references to them.\n \nAt the top of the Program.cs file, add the following **using** statements:\n\n    using System.IO;    \n    using Microsoft.WindowsAzure;\n    using Microsoft.WindowsAzure.Storage;\n    using Microsoft.WindowsAzure.Storage.Blob;\n\nEdit the app.config file so that it contains a configuration setting with a connection string that points to your storage account. Your app.config file should look similar to this one:\n\n    <configuration>\n      <startup> \n        <supportedRuntime version=\"v4.0\" sku=\".NETFramework,Version=v4.5\" />\n      </startup>\n      <appSettings>\n        <add key=\"StorageConnectionString\" value=\"DefaultEndpointsProtocol=https;AccountName=myaccount;AccountKey=mykey\"/>\n      </appSettings> \n    </configuration>\n\n### Generate a Shared Access Signature URI for a Container\n\nTo begin with, we'll add a method to generate a shared access signature on a new container. In this case the signature is not associated with a stored access policy, so it carries on the URI the information indicating its expiry time and the permissions that it grants.\n\nFirst, add code to the **Main()** method to authenticate access to your storage account and create a new container:\n\n    static void Main(string[] args)\n    {\n        //Parse the connection string and return a reference to the storage account.\n        CloudStorageAccount storageAccount = CloudStorageAccount.Parse(CloudConfigurationManager.GetSetting(\"StorageConnectionString\"));\n        \n        //Create the blob client object.\n        CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();\n        \n        //Get a reference to a container to use for the sample code, and create it if it does not exist.\n        CloudBlobContainer container = blobClient.GetContainerReference(\"sascontainer\");\n        container.CreateIfNotExists();\n        \n        //Insert calls to the methods created below here...\n        \n        //Require user input before closing the console window.\n        Console.ReadLine();\n    }\n\nNext, add a new method that generates the shared access signature for the container and returns the signature URI:\n\n    static string GetContainerSasUri(CloudBlobContainer container)\n    {\n        //Set the expiry time and permissions for the container.\n        //In this case no start time is specified, so the shared access signature becomes valid immediately.\n        SharedAccessBlobPolicy sasConstraints = new SharedAccessBlobPolicy();\n        sasConstraints.SharedAccessExpiryTime = DateTime.UtcNow.AddHours(24);\n        sasConstraints.Permissions = SharedAccessBlobPermissions.Write | SharedAccessBlobPermissions.List;\n        \n        //Generate the shared access signature on the container, setting the constraints directly on the signature.\n        string sasContainerToken = container.GetSharedAccessSignature(sasConstraints);\n        \n        //Return the URI string for the container, including the SAS token.\n        return container.Uri + sasContainerToken;\n    }\n\nAdd the following lines at the bottom of the **Main()** method, before the call to **Console.ReadLine()**, to call **GetContainerSasUri()** and write the signature URI to the console window:\n\n    //Generate a SAS URI for the container, without a stored access policy.\n    Console.WriteLine(\"Container SAS URI: \" + GetContainerSasUri(container));\n    Console.WriteLine();\n\nCompile and run to output the shared access signature URI for the new container. The URI will be similar to the following URI:       \n\n    https://storageaccount.blob.core.windows.net/sascontainer?sv=2012-02-12&se=2013-04-13T00%3A12%3A08Z&sr=c&sp=wl&sig=t%2BbzU9%2B7ry4okULN9S0wst%2F8MCUhTjrHyV9rDNLSe8g%3D\n\nOnce you have run the code, the shared access signature that you created on the container will be valid for the next twenty-four hours. The signature grants a client permission to list blobs in the container and to write a new blob to the container.\n\n### Generate a Shared Access Signature URI for a Blob\n\nNext, we'll write similar code to create a new blob within the container and generate a shared access signature for it. This shared access signature is not associated with a stored access policy, so it includes the start time, expiry time, and permission information on the URI.\n\nAdd a new method that creates a new blob and write some text to it, then generates a shared access signature and returns the signature URI:\n\n    static string GetBlobSasUri(CloudBlobContainer container)\n    {\n        //Get a reference to a blob within the container.\n        CloudBlockBlob blob = container.GetBlockBlobReference(\"sasblob.txt\");\n        \n        //Upload text to the blob. If the blob does not yet exist, it will be created. \n        //If the blob does exist, its existing content will be overwritten.\n        string blobContent = \"This blob will be accessible to clients via a Shared Access Signature.\";\n        MemoryStream ms = new MemoryStream(Encoding.UTF8.GetBytes(blobContent));\n        ms.Position = 0;\n        using (ms)\n        {\n            blob.UploadFromStream(ms);\n        }\n        \n        //Set the expiry time and permissions for the blob.\n        //In this case the start time is specified as a few minutes in the past, to mitigate clock skew.\n        //The shared access signature will be valid immediately.\n        SharedAccessBlobPolicy sasConstraints = new SharedAccessBlobPolicy();\n        sasConstraints.SharedAccessStartTime = DateTime.UtcNow.AddMinutes(-5);\n        sasConstraints.SharedAccessExpiryTime = DateTime.UtcNow.AddHours(24);\n        sasConstraints.Permissions = SharedAccessBlobPermissions.Read | SharedAccessBlobPermissions.Write;\n        \n        //Generate the shared access signature on the blob, setting the constraints directly on the signature.\n        string sasBlobToken = blob.GetSharedAccessSignature(sasConstraints);\n        \n        //Return the URI string for the container, including the SAS token.\n        return blob.Uri + sasBlobToken;\n    }\n\nAt the bottom of the **Main()** method, add the following lines to call **GetBlobSasUri()**, before the call to **Console.ReadLine()**, and write the shared access signature URI to the console window:    \n    \n    //Generate a SAS URI for a blob within the container, without a stored access policy.\n    Console.WriteLine(\"Blob SAS URI: \" + GetBlobSasUri(container));\n    Console.WriteLine();\n    \n\nCompile and run to output the shared access signature URI for the new blob. The URI will be similar to the following URI:\n\n    https://storageaccount.blob.core.windows.net/sascontainer/sasblob.txt?sv=2012-02-12&st=2013-04-12T23%3A37%3A08Z&se=2013-04-13T00%3A12%3A08Z&sr=b&sp=rw&sig=dF2064yHtc8RusQLvkQFPItYdeOz3zR8zHsDMBi4S30%3D\n\n### Create a Stored Access Policy on the Container\n\nNow let's create a stored access policy on the container, which will define the constraints for any shared access signatures that are associated with it.\n\nIn the previous examples, we specified the start time (implicitly or explicitly), the expiry time, and the permissions on the shared access signature URI itself. In the following examples, we will specify these on the stored access policy and not on the shared access signature. Doing so enables us to change these constraints without reissuing the shared access signature.\n\nIt's possible to have one or more of the constraints on the shared access signature and the remainder on the stored access policy. However, you can only specify the start time, expiry time, and permissions in one place or the other; for example, you can't specify permissions on the shared access signature and also specify them on the stored access policy.\n\nNote that when you add an access policy to a container, you must get the container's existing permissions, add the new access policy, and then set the container's permissions.\n\nAdd a new method that creates a new stored access policy on a container and returns the name of the policy:\n\n    static void CreateSharedAccessPolicy(CloudBlobClient blobClient, CloudBlobContainer container, \n        string policyName)\n    {\n        //Create a new shared access policy and define its constraints.\n        SharedAccessBlobPolicy sharedPolicy = new SharedAccessBlobPolicy()\n        {\n            SharedAccessExpiryTime = DateTime.UtcNow.AddHours(24),\n            Permissions = SharedAccessBlobPermissions.Write | SharedAccessBlobPermissions.List | SharedAccessBlobPermissions.Read\n        };\n\n        //Get the container's existing permissions.\n        BlobContainerPermissions permissions = container.GetPermissions();\n\n        //Add the new policy to the container's permissions, and set the container's permissions.\n        permissions.SharedAccessPolicies.Add(policyName, sharedPolicy);\n        container.SetPermissions(permissions);\n    }\n\nAt the bottom of the **Main()** method, before the call to **Console.ReadLine()**, add the following lines to first clear any existing access policies and then call the **CreateSharedAccessPolicy()** method:    \n\n    //Clear any existing access policies on container.\n    BlobContainerPermissions perms = container.GetPermissions();\n    perms.SharedAccessPolicies.Clear();\n    container.SetPermissions(perms);\n\n    //Create a new access policy on the container, which may be optionally used to provide constraints for \n    //shared access signatures on the container and the blob.\n    string sharedAccessPolicyName = \"tutorialpolicy\";\n    CreateSharedAccessPolicy(blobClient, container, sharedAccessPolicyName);\n\nNote that when you clear the access policies on a container, you must first get the container's existing permissions, then clear the permissions, then set the permissions again.\n\n### Generate a Shared Access Signature URI on the Container That Uses an Access Policy\n\nNext, we'll create another shared access signature on the container that we created earlier, but this time we'll associate the signature with the access policy that we created in the previous example.\n\nAdd a new method to generate another shared access signature on the container:\n\n    static string GetContainerSasUriWithPolicy(CloudBlobContainer container, string policyName)\n    {\n        //Generate the shared access signature on the container. In this case, all of the constraints for the \n        //shared access signature are specified on the stored access policy.\n        string sasContainerToken = container.GetSharedAccessSignature(null, policyName);\n        \n        //Return the URI string for the container, including the SAS token.\n        return container.Uri + sasContainerToken;\n    }\n    \nAt the bottom of the **Main()** method, before the call to **Console.ReadLine()**, add the following lines to call the **GetContainerSasUriWithPolicy** method:\n\n    //Generate a SAS URI for the container, using a stored access policy to set constraints on the SAS.\n    Console.WriteLine(\"Container SAS URI using stored access policy: \" + GetContainerSasUriWithPolicy(container, sharedAccessPolicyName));\n    Console.WriteLine();\n\n### Generate a Shared Access Signature URI on the Blob That Uses an Access Policy\n\nFinally, we'll add a similar method to create another blob and generate a shared access signature that's associated with an access policy.\n\nAdd a new method to create a blob and generate a shared access signature:\n\n    static string GetBlobSasUriWithPolicy(CloudBlobContainer container, string policyName)\n    {\n        //Get a reference to a blob within the container.\n        CloudBlockBlob blob = container.GetBlockBlobReference(\"sasblobpolicy.txt\");\n        \n        //Upload text to the blob. If the blob does not yet exist, it will be created. \n        //If the blob does exist, its existing content will be overwritten.\n        string blobContent = \"This blob will be accessible to clients via a shared access signature. \" + \n        \"A stored access policy defines the constraints for the signature.\";\n        MemoryStream ms = new MemoryStream(Encoding.UTF8.GetBytes(blobContent));\n        ms.Position = 0;\n        using (ms)\n        {\n            blob.UploadFromStream(ms);\n        }\n        \n        //Generate the shared access signature on the blob.\n        string sasBlobToken = blob.GetSharedAccessSignature(null, policyName);\n        \n        //Return the URI string for the container, including the SAS token.\n        return blob.Uri + sasBlobToken;\n    }\n\nAt the bottom of the **Main()** method, before the call to **Console.ReadLine()**, add the following lines to call the **GetBlobSasUriWithPolicy** method:    \n\n    //Generate a SAS URI for a blob within the container, using a stored access policy to set constraints on the SAS.\n    Console.WriteLine(\"Blob SAS URI using stored access policy: \" + GetBlobSasUriWithPolicy(container, sharedAccessPolicyName));\n    Console.WriteLine();\n\nThe **Main()** method should now look like this in its entirety. Run it to write the shared access signature URIs to the console window, then copy and paste them into a text file for use in the second part of this tutorial.\n\n    static void Main(string[] args)\n    {\n        //Parse the connection string and return a reference to the storage account.\n        CloudStorageAccount storageAccount = CloudStorageAccount.Parse(CloudConfigurationManager.GetSetting(\"StorageConnectionString\"));\n        \n        //Create the blob client object.\n        CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();\n        \n        //Get a reference to a container to use for the sample code, and create it if it does not exist.\n        CloudBlobContainer container = blobClient.GetContainerReference(\"sascontainer\");\n        container.CreateIfNotExists();\n        \n        //Generate a SAS URI for the container, without a stored access policy.\n        Console.WriteLine(\"Container SAS URI: \" + GetContainerSasUri(container));\n        Console.WriteLine();\n        \n        //Generate a SAS URI for a blob within the container, without a stored access policy.\n        Console.WriteLine(\"Blob SAS URI: \" + GetBlobSasUri(container));\n        Console.WriteLine();\n        \n        //Clear any existing access policies on container.\n        BlobContainerPermissions perms = container.GetPermissions();\n        perms.SharedAccessPolicies.Clear();\n        container.SetPermissions(perms);\n\n        //Create a new access policy on the container, which may be optionally used to provide constraints for \n        //shared access signatures on the container and the blob.\n        string sharedAccessPolicyName = \"tutorialpolicy\";\n        CreateSharedAccessPolicy(blobClient, container, sharedAccessPolicyName);\n        \n        //Generate a SAS URI for the container, using a stored access policy to set constraints on the SAS.\n        Console.WriteLine(\"Container SAS URI using stored access policy: \" + GetContainerSasUriWithPolicy(container, sharedAccessPolicyName));\n        Console.WriteLine();\n        \n        //Generate a SAS URI for a blob within the container, using a stored access policy to set constraints on the SAS.\n        Console.WriteLine(\"Blob SAS URI using stored access policy: \" + GetBlobSasUriWithPolicy(container, sharedAccessPolicyName));\n        Console.WriteLine();\n        \n        Console.ReadLine();\n    }\n\nWhen you run the GenerateSharedAccessSignatures console application, you'll see output similar to the following in the console window. These are the shared access signatures that you'll use in Part 2 of the tutorial.\n\n![sas-console-output-1][sas-console-output-1]\n\n## Part 2: Create a Console Application to Test the Shared Access Signatures\n\nTo test the shared access signatures created in the previous examples, we'll create a second console application that uses the signatures to perform operations on the container and on a blob.\n\n> [AZURE.NOTE] If more than 24 hours have passed since you completed the first part of the tutorial, the signatures you generated will no longer be valid. In this case, you should run the code in the first console application to generate fresh shared access signatures for use in the second part of the tutorial.\n\nIn Visual Studio, create a new Windows console application and name it **ConsumeSharedAccessSignatures**. Add references to **Microsoft.WindowsAzure.Configuration.dll** and **Microsoft.WindowsAzure.Storage.dll**, as you did previously.\n\nAt the top of the Program.cs file, add the following **using** statements:\n\n    using System.IO;\n    using Microsoft.WindowsAzure.Storage;\n    using Microsoft.WindowsAzure.Storage.Blob;\n    \nIn the body of the **Main()** method, add the following constants, and update their values to the shared access signatures that you generated in part 1 of the tutorial.\n\n    static void Main(string[] args)\n    {\n        string containerSAS = \"<your container SAS>\";\n        string blobSAS = \"<your blob SAS>\";\n        string containerSASWithAccessPolicy = \"<your container SAS with access policy>\";\n        string blobSASWithAccessPolicy = \"<your blob SAS with access policy>\";\n    }\n    \n### Add a Method to Try Container Operations Using a Shared Access Signature\n\nNext, we'll add a method that tests some representative container operations using a shared access signature on the container. Note that the shared access signature is used to return a reference to the container, authenticating access to the container based on the signature alone.\n\nAdd the following method to Program.cs:\n\n    static void UseContainerSAS(string sas)\n    {\n        //Try performing container operations with the SAS provided.\n\n        //Return a reference to the container using the SAS URI.\n        CloudBlobContainer container = new CloudBlobContainer(new Uri(sas));\n\n        //Create a list to store blob URIs returned by a listing operation on the container.\n        List<ICloudBlob> blobList = new List<ICloudBlob>();\n\n        //Write operation: write a new blob to the container. \n        try\n        {\n            CloudBlockBlob blob = container.GetBlockBlobReference(\"blobCreatedViaSAS.txt\");\n            string blobContent = \"This blob was created with a shared access signature granting write permissions to the container. \";\n            MemoryStream msWrite = new MemoryStream(Encoding.UTF8.GetBytes(blobContent));\n            msWrite.Position = 0;\n            using (msWrite)\n            {\n                blob.UploadFromStream(msWrite);\n            }\n            Console.WriteLine(\"Write operation succeeded for SAS \" + sas);\n            Console.WriteLine();\n        }\n        catch (StorageException e)\n        {\n            Console.WriteLine(\"Write operation failed for SAS \" + sas);\n            Console.WriteLine(\"Additional error information: \" + e.Message);\n            Console.WriteLine();\n        }\n\n        //List operation: List the blobs in the container.\n        try\n        {\n            foreach (ICloudBlob blob in container.ListBlobs())\n            {\n                blobList.Add(blob);\n            }\n            Console.WriteLine(\"List operation succeeded for SAS \" + sas);\n            Console.WriteLine();\n        }\n        catch (StorageException e)\n        {\n            Console.WriteLine(\"List operation failed for SAS \" + sas);\n            Console.WriteLine(\"Additional error information: \" + e.Message);\n            Console.WriteLine();\n        }\n\n        //Read operation: Get a reference to one of the blobs in the container and read it. \n        try\n        {\n            CloudBlockBlob blob = container.GetBlockBlobReference(blobList[0].Name);\n            MemoryStream msRead = new MemoryStream();\n            msRead.Position = 0;\n            using (msRead)\n            {\n                blob.DownloadToStream(msRead);\n                Console.WriteLine(msRead.Length);\n            }\n            Console.WriteLine(\"Read operation succeeded for SAS \" + sas);\n            Console.WriteLine();\n        }\n        catch (StorageException e)\n        {\n            Console.WriteLine(\"Read operation failed for SAS \" + sas);\n            Console.WriteLine(\"Additional error information: \" + e.Message);\n            Console.WriteLine();\n        }\n        Console.WriteLine();\n\n        //Delete operation: Delete a blob in the container.\n        try\n        {\n            CloudBlockBlob blob = container.GetBlockBlobReference(blobList[0].Name);\n            blob.Delete();\n            Console.WriteLine(\"Delete operation succeeded for SAS \" + sas);\n            Console.WriteLine();\n        }\n        catch (StorageException e)\n        {\n            Console.WriteLine(\"Delete operation failed for SAS \" + sas);\n            Console.WriteLine(\"Additional error information: \" + e.Message);\n            Console.WriteLine();\n        }        \n    }\n\n\nUpdate the **Main()** method to call **UseContainerSAS()** with both of the shared access signatures that you created on the container:\n\n    static void Main(string[] args)\n    {\n        string containerSAS = \"<your container SAS>\";\n        string blobSAS = \"<your blob SAS>\";\n        string containerSASWithAccessPolicy = \"<your container SAS with access policy>\";\n        string blobSASWithAccessPolicy = \"<your blob SAS with access policy>\";\n    \n        //Call the test methods with the shared access signatures created on the container, with and without the access policy.\n        UseContainerSAS(containerSAS);\n        UseContainerSAS(containerSASWithAccessPolicy); \n        \n        Console.ReadLine();\n    }\n\n\n### Add a Method to Try Blob Operations Using a Shared Access Signature\n\nFinally, we'll add a method that tests some representative blob operations using a shared access signature on the blob. In this case we use the constructor **CloudBlockBlob(String)**, passing in the shared access signature, to return a reference to the blob. No other authentication is required; it's based on the signature alone.\n\nAdd the following method to Program.cs:\n\n    static void UseBlobSAS(string sas)\n    {\n        //Try performing blob operations using the SAS provided.\n\n        //Return a reference to the blob using the SAS URI.\n        CloudBlockBlob blob = new CloudBlockBlob(new Uri(sas));\n\n        //Write operation: Write a new blob to the container. \n        try\n        {\n            string blobContent = \"This blob was created with a shared access signature granting write permissions to the blob. \";\n            MemoryStream msWrite = new MemoryStream(Encoding.UTF8.GetBytes(blobContent));\n            msWrite.Position = 0;\n            using (msWrite)\n            {\n                blob.UploadFromStream(msWrite);\n            }\n            Console.WriteLine(\"Write operation succeeded for SAS \" + sas);\n            Console.WriteLine();\n        }\n        catch (StorageException e)\n        {\n            Console.WriteLine(\"Write operation failed for SAS \" + sas);\n            Console.WriteLine(\"Additional error information: \" + e.Message);\n            Console.WriteLine();\n        }\n\n        //Read operation: Read the contents of the blob.\n        try\n        {\n            MemoryStream msRead = new MemoryStream();\n            using (msRead)\n            {\n                blob.DownloadToStream(msRead);\n                msRead.Position = 0;\n                using (StreamReader reader = new StreamReader(msRead, true))\n                {\n                    string line;\n                    while ((line = reader.ReadLine()) != null)\n                    {\n                        Console.WriteLine(line);\n                    }\n                }\n            }\n            Console.WriteLine(\"Read operation succeeded for SAS \" + sas);\n            Console.WriteLine();\n        }\n        catch (StorageException e)\n        {\n            Console.WriteLine(\"Read operation failed for SAS \" + sas);\n            Console.WriteLine(\"Additional error information: \" + e.Message);\n            Console.WriteLine();\n        }\n\n        //Delete operation: Delete the blob.\n        try\n        {\n            blob.Delete();\n            Console.WriteLine(\"Delete operation succeeded for SAS \" + sas);\n            Console.WriteLine();\n        }\n        catch (StorageException e)\n        {\n            Console.WriteLine(\"Delete operation failed for SAS \" + sas);\n            Console.WriteLine(\"Additional error information: \" + e.Message);\n            Console.WriteLine();\n        }        \n    }\n\n\nUpdate the **Main()** method to call **UseBlobSAS()** with both of the shared access signatures that you created on the blob:\n\n    static void Main(string[] args)\n    {\n        string containerSAS = \"<your container SAS>\";\n        string blobSAS = \"<your blob SAS>\";\n        string containerSASWithAccessPolicy = \"<your container SAS with access policy>\";\n        string blobSASWithAccessPolicy = \"<your blob SAS with access policy>\";\n    \n        //Call the test methods with the shared access signatures created on the container, with and without the access policy.\n        UseContainerSAS(containerSAS);\n        UseContainerSAS(containerSASWithAccessPolicy); \n        \n        //Call the test methods with the shared access signatures created on the blob, with and without the access policy.\n        UseBlobSAS(blobSAS);\n        UseBlobSAS(blobSASWithAccessPolicy);\n    \n        Console.ReadLine();\n    }\n\nRun the console application and observe the output to see which operations are permitted for which signatures. The output in the console window will look similar to the following:\n\n![sas-console-output-2][sas-console-output-2]\n\n## Next Steps\n\n[Shared Access Signatures, Part 1: Understanding the SAS Model](../storage-dotnet-shared-access-signature-part-1/)\n\n[Manage Access to Azure Storage Resources](http://msdn.microsoft.com/library/azure/ee393343.aspx)\n\n[Delegating Access with a Shared Access Signature (REST API)](http://msdn.microsoft.com/library/azure/ee395415.aspx)\n\n[Introducing Table and Queue SAS](http://blogs.msdn.com/b/windowsazurestorage/archive/2012/06/12/introducing-table-sas-shared-access-signature-queue-sas-and-update-to-blob-sas.aspx)\n\n[sas-console-output-1]: ./media/storage-dotnet-shared-access-signature-part-2/sas-console-output-1.PNG\n[sas-console-output-2]: ./media/storage-dotnet-shared-access-signature-part-2/sas-console-output-2.PNG\n\n "
}