{
  "nodes": [
    {
      "content": "Troubleshoot Remote Desktop connections to a Windows-based Azure Virtual Machine",
      "pos": [
        27,
        107
      ]
    },
    {
      "content": "If you can't connect your Windows-based Azure virtual machine, use these diagnotics and steps to isolate the source of the problem.",
      "pos": [
        126,
        257
      ]
    },
    {
      "content": "Troubleshoot Remote Desktop connections to a Windows-based Azure virtual machine",
      "pos": [
        646,
        726
      ]
    },
    {
      "content": "If you can't connect to Windows-based Azure virtual machines, this article describes a methodical approach for correction and root-cause determination of Remote Desktop connections.",
      "pos": [
        728,
        909
      ]
    },
    {
      "content": "Step 1: Run the Azure IaaS diagnostics package",
      "pos": [
        914,
        960
      ]
    },
    {
      "pos": [
        962,
        1203
      ],
      "content": "To address many of the common problems with creating Remote Desktop connections, Microsoft has created an <bpt id=\"p1\">[</bpt>Azure IaaS (Windows) diagnostics package<ept id=\"p1\">](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864)</ept>."
    },
    {
      "pos": [
        1209,
        1319
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Microsoft Azure IaaS (Windows) diagnostics package<ept id=\"p1\">**</ept> on this page to create a new diagnostics session."
    },
    {
      "pos": [
        1324,
        1483
      ],
      "content": "On the <bpt id=\"p1\">**</bpt>Which of the following issues are you experiencing with your Azure VM?<ept id=\"p1\">**</ept> page, select the <bpt id=\"p2\">**</bpt>RDP connectivity to an Azure VM (Reboot Required)<ept id=\"p2\">**</ept> issue."
    },
    {
      "pos": [
        1485,
        1631
      ],
      "content": "For more information, see the <bpt id=\"p1\">[</bpt>Microsoft Azure IaaS (Windows) diagnostics package Knowledgebase article<ept id=\"p1\">](http://support.microsoft.com/kb/2976864)</ept>."
    },
    {
      "content": "If running the Azure IaaS diagnostics package did not correct the problem or you were unable to run the diagnostics package, more detailed troubleshooting described in the following steps might be required.",
      "pos": [
        1633,
        1839
      ]
    },
    {
      "pos": [
        1843,
        2008
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> The Azure IaaS (Windows) diagnostics package must be run from a computer running Windows 8, Windows 8.1, Windows Server 2012, or Windows Server 2012 R2."
    },
    {
      "content": "Step 2: Determine the error message from the Remote Desktop client",
      "pos": [
        2013,
        2079
      ]
    },
    {
      "content": "Use these sections based on the error message you see when attempting to connect.",
      "pos": [
        2081,
        2162
      ]
    },
    {
      "content": "Remote Desktop Connection message window: The remote session was disconnected because there are no Remote Desktop License Servers available to provide a license.",
      "pos": [
        2168,
        2329
      ]
    },
    {
      "content": "Cause: The 120-day licensing grace period for the Remote Desktop Server role has expired and you need to install licenses.",
      "pos": [
        2331,
        2453
      ]
    },
    {
      "content": "As a temporary workaround, save a local copy of the RDP file from the Azure portal and then run this command at a Windows PowerShell command prompt to connect.",
      "pos": [
        2455,
        2614
      ]
    },
    {
      "content": "This will disable licensing for only that connection.",
      "pos": [
        2650,
        2703
      ]
    },
    {
      "content": "If you don't actually need more than two simultaneous Remote Desktop connections to the virtual machine, you can use Server Manager to remove the Remote Desktop Server role.",
      "pos": [
        2705,
        2878
      ]
    },
    {
      "pos": [
        2880,
        3106
      ],
      "content": "Also see the <bpt id=\"p1\">[</bpt>Azure VM fails with \"No Remote Desktop License Servers available\"<ept id=\"p1\">](http://blogs.msdn.com/b/wats/archive/2014/01/21/rdp-to-azure-vm-fails-with-quot-no-remote-desktop-license-servers-available-quot.aspx)</ept> blog post."
    },
    {
      "content": "Remote Desktop Connection message window: Remote Desktop can't find the computer \"name\".",
      "pos": [
        3112,
        3200
      ]
    },
    {
      "content": "Cause: The Remote Desktop client on your computer cannot resolve the name of the computer in the settings of the RDP file.",
      "pos": [
        3202,
        3324
      ]
    },
    {
      "content": "Here is an example RDP file generated by the Azure portal:",
      "pos": [
        3326,
        3384
      ]
    },
    {
      "content": "In this example, the address portion consists of the fully qualified domain name of the cloud service that contains the virtual machine (tailspin-azdatatier.cloudapp.net in this example) and the external TCP port of the endpoint for Remote Desktop traffic (55919).",
      "pos": [
        3476,
        3740
      ]
    },
    {
      "content": "Possible solutions to this problem:",
      "pos": [
        3742,
        3777
      ]
    },
    {
      "content": "If you are on an organization intranet, ensure that your computer has access to the proxy server and can send HTTPS traffic to it.",
      "pos": [
        3781,
        3911
      ]
    },
    {
      "content": "If you are using a locally stored RDP file, try using the one generated by the Azure portal to ensure you have the correct DNS name for the virtual machine or the cloud service and the endpoint port of the virtual machine.",
      "pos": [
        3914,
        4136
      ]
    },
    {
      "content": "Remote Desktop Connection message window: An authentication error has occurred.",
      "pos": [
        4142,
        4221
      ]
    },
    {
      "content": "The Local Security Authority cannot be contacted.",
      "pos": [
        4222,
        4271
      ]
    },
    {
      "content": "Cause: The virtual machine to which you are connecting cannot locate the security authority indicated in the user name portion of your credentials.",
      "pos": [
        4273,
        4420
      ]
    },
    {
      "pos": [
        4422,
        4660
      ],
      "content": "When your user name is of the form <bpt id=\"p1\">*</bpt>SecurityAuthority<ept id=\"p1\">*</ept>\\\\<bpt id=\"p2\">*</bpt>UserName<ept id=\"p2\">*</ept> (example: CORP\\User1), the <bpt id=\"p3\">*</bpt>SecurityAuthority<ept id=\"p3\">*</ept> portion is either the virtual machine's computer name (for the local security authority) or an Active Directory domain name."
    },
    {
      "content": "Possible solutions to this problem:",
      "pos": [
        4662,
        4697
      ]
    },
    {
      "content": "If the user account is local to the virtual machine, verify the spelling of the virtual machine name.",
      "pos": [
        4701,
        4802
      ]
    },
    {
      "content": "If the user account is an Active Directory domain account, verify the spelling of the domain name.",
      "pos": [
        4805,
        4903
      ]
    },
    {
      "content": "If the user account is an Active Directory domain account and the domain name is spelled correctly, verify that a domain controller for the Active Directory domain is available.",
      "pos": [
        4906,
        5083
      ]
    },
    {
      "content": "This can be a common issue in an Azure virtual network that contains domain controllers, in which a domain controller computer is not started.",
      "pos": [
        5084,
        5226
      ]
    },
    {
      "content": "A temporary workaround is to use a local administrator account, rather than a domain account.",
      "pos": [
        5227,
        5320
      ]
    },
    {
      "content": "Windows Security message window: Your credentials did not work.",
      "pos": [
        5326,
        5389
      ]
    },
    {
      "content": "Cause: The account name and password that you submitted cannot be validated by the virtual machine to which you are connecting.",
      "pos": [
        5391,
        5518
      ]
    },
    {
      "content": "A Windows-based computer can validate the credentials of either a local account or a domain-based account.",
      "pos": [
        5520,
        5626
      ]
    },
    {
      "pos": [
        5630,
        5718
      ],
      "content": "For local accounts, use the <bpt id=\"p1\">*</bpt>ComputerName<ept id=\"p1\">*</ept>\\\\<bpt id=\"p2\">*</bpt>UserName<ept id=\"p2\">*</ept> syntax (example: SQL1\\Admin4798)."
    },
    {
      "pos": [
        5721,
        5809
      ],
      "content": "For domain accounts, use the <bpt id=\"p1\">*</bpt>DomainName<ept id=\"p1\">*</ept>\\\\<bpt id=\"p2\">*</bpt>UserName<ept id=\"p2\">*</ept> syntax (example: CONTOSO\\johndoe)."
    },
    {
      "content": "For computers that you promote to domain controllers in a new Active Directory forest, the local administrator account that you are logged in to when you perform the promotion gets converted to an equivalent account with the same password in the new forest and domain.",
      "pos": [
        5811,
        6079
      ]
    },
    {
      "content": "The previous local administrator account is deleted.",
      "pos": [
        6080,
        6132
      ]
    },
    {
      "content": "For example, if you logged in with the local administrator account DC1\\DCAdmin and promoted the virtual machine as a domain controller in a new forest for the corp.contoso.com domain, the DC1\\DCAdmin local account gets deleted and a new domain account (CORP\\DCAdmin) is created with the same password.",
      "pos": [
        6133,
        6434
      ]
    },
    {
      "content": "Double-check the account name to ensure that it is a name that the virtual machine can verify as a valid account.",
      "pos": [
        6436,
        6549
      ]
    },
    {
      "content": "Double-check the password to ensure that it is the correct password.",
      "pos": [
        6550,
        6618
      ]
    },
    {
      "pos": [
        6620,
        6824
      ],
      "content": "If you need to change the password of the local administrator account, see <bpt id=\"p1\">[</bpt>How to reset a password or the Remote Desktop service for Windows virtual machines<ept id=\"p1\">](virtual-machines-windows-reset-password.md)</ept>."
    },
    {
      "content": "Remote Desktop Connection message window: This computer can't connect to the remote computer.",
      "pos": [
        6830,
        6923
      ]
    },
    {
      "content": "Cause: The account that you are using to connect does not have Remote Desktop logon rights.",
      "pos": [
        6925,
        7016
      ]
    },
    {
      "content": "Each Windows-based computer has a Remote Desktop Users local group, which contains the accounts and groups that have the right to log on with a Remote Desktop connection.",
      "pos": [
        7018,
        7188
      ]
    },
    {
      "content": "Members of the local Administrators group also have access, even though those accounts are not listed as members of the Remote Desktop Users local group.",
      "pos": [
        7189,
        7342
      ]
    },
    {
      "content": "For domain-joined machines, the local Administrators group also contains the domain administrators for the domain.",
      "pos": [
        7343,
        7457
      ]
    },
    {
      "content": "Ensure that the account you are using to initiate the connection has Remote Desktop logon rights.",
      "pos": [
        7459,
        7556
      ]
    },
    {
      "content": "Use a domain administrator or local administrator account as a temporary workaround to create a Remote Desktop connection and add the desired account to the Remote Desktop Users local group by using the Computer Management snap-in (<bpt id=\"p1\">**</bpt>System Tools &gt; Local Users and Groups &gt; Groups &gt; Remote Desktop Users<ept id=\"p1\">**</ept>).",
      "pos": [
        7557,
        7864
      ]
    },
    {
      "content": "Remote Desktop Connection message window: Remote Desktop cannot connect to the remote computer for one of these reasons…",
      "pos": [
        7870,
        7990
      ]
    },
    {
      "content": "Cause: The Remote Desktop client cannot reach the Remote Desktop Services service on the virtual machine.",
      "pos": [
        7992,
        8097
      ]
    },
    {
      "content": "This problem can be due to many root causes.",
      "pos": [
        8098,
        8142
      ]
    },
    {
      "content": "Here is the set of components involved.",
      "pos": [
        8144,
        8183
      ]
    },
    {
      "content": "Before diving into a step-by-step troubleshooting process, it is helpful to mentally review what has changed since you were able to successfully create Remote Desktop connections and use that change as a basis for correcting the problem.",
      "pos": [
        8272,
        8509
      ]
    },
    {
      "content": "For example:",
      "pos": [
        8510,
        8522
      ]
    },
    {
      "content": "If you were able to create Remote Desktop connections and you changed the public IP address of the virtual machine or the cloud service containing your virtual machine (also known as the virtual IP address [VIP]), your DNS client cache might have an entry for the DNS name and the <bpt id=\"p1\">*</bpt>old IP address<ept id=\"p1\">*</ept>.",
      "pos": [
        8526,
        8824
      ]
    },
    {
      "content": "Flush your DNS client cache and try again.",
      "pos": [
        8825,
        8867
      ]
    },
    {
      "content": "Alternately, try making the connection by using the new VIP.",
      "pos": [
        8868,
        8928
      ]
    },
    {
      "content": "If you changed from using the Azure portal or the Azure preview portal to using an application to manage your Remote Desktop connections, ensure that the application configuration includes the randomly determined TCP port for the Remote Desktop traffic.",
      "pos": [
        8931,
        9184
      ]
    },
    {
      "content": "The following sections step through isolating and determining the various root causes for this problem and providing solutions and workarounds.",
      "pos": [
        9186,
        9329
      ]
    },
    {
      "content": "Step 3: Preliminary steps before detailed troubleshooting",
      "pos": [
        9334,
        9391
      ]
    },
    {
      "content": "Perform these steps:",
      "pos": [
        9393,
        9413
      ]
    },
    {
      "content": "Check the status of the virtual machine in the Azure portal or the Azure preview portal",
      "pos": [
        9417,
        9504
      ]
    },
    {
      "content": "Restart the virtual machine",
      "pos": [
        9508,
        9535
      ]
    },
    {
      "content": "Resize the virtual machine",
      "pos": [
        9596,
        9622
      ]
    },
    {
      "content": "After these steps, try the Remote Desktop connection again.",
      "pos": [
        9675,
        9734
      ]
    },
    {
      "content": "Step 4: Detailed troubleshooting",
      "pos": [
        9739,
        9771
      ]
    },
    {
      "content": "The inability of your Remote Desktop client to reach the Remote Desktop Services service on the Azure virtual machine can be due to the following sources of issues or misconfigurations:",
      "pos": [
        9773,
        9958
      ]
    },
    {
      "content": "Remote Desktop client computer",
      "pos": [
        9962,
        9992
      ]
    },
    {
      "content": "Organization intranet edge device",
      "pos": [
        9995,
        10028
      ]
    },
    {
      "content": "Cloud service endpoint and access control list (ACL)",
      "pos": [
        10031,
        10083
      ]
    },
    {
      "content": "Network security groups",
      "pos": [
        10086,
        10109
      ]
    },
    {
      "content": "Windows-based Azure virtual machine",
      "pos": [
        10112,
        10147
      ]
    },
    {
      "content": "Source 1: Remote Desktop client computer",
      "pos": [
        10153,
        10193
      ]
    },
    {
      "content": "To eliminate your computer as being the source of issues or misconfiguration, verify that your computer can make Remote Desktop connections to another on-premises, Windows-based computer.",
      "pos": [
        10195,
        10382
      ]
    },
    {
      "content": "If you cannot, check for these on your computer:",
      "pos": [
        10471,
        10519
      ]
    },
    {
      "content": "A local firewall setting that is blocking Remote Desktop traffic",
      "pos": [
        10523,
        10587
      ]
    },
    {
      "content": "Locally installed client proxy software that is preventing Remote Desktop connections",
      "pos": [
        10590,
        10675
      ]
    },
    {
      "content": "Locally installed network monitoring software that is preventing Remote Desktop connections",
      "pos": [
        10678,
        10769
      ]
    },
    {
      "content": "Other types of security software that either monitor traffic or allow/disallow specific types of traffic that is preventing Remote Desktop connections",
      "pos": [
        10772,
        10922
      ]
    },
    {
      "content": "In all of these cases, try to temporarily disable the software and attempt a Remote Desktop connection to an on-premises computer to determine the root cause.",
      "pos": [
        10924,
        11082
      ]
    },
    {
      "content": "Then, work with your network administrator to correct the settings of the software to allow Remote Desktop connections.",
      "pos": [
        11083,
        11202
      ]
    },
    {
      "content": "Source 2: Organization intranet edge device",
      "pos": [
        11208,
        11251
      ]
    },
    {
      "content": "To eliminate your organization intranet edge device as being the source of issues or misconfiguration, verify that a computer directly connected to the Internet can make Remote Desktop connections to your Azure virtual machine.",
      "pos": [
        11253,
        11480
      ]
    },
    {
      "content": "If you do not have a computer that is directly connected to the Internet, you can easily create a new Azure virtual machine in its own resource group or cloud service and use it.",
      "pos": [
        11569,
        11747
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Create a virtual machine running Windows in Azure<ept id=\"p1\">](virtual-machines-windows-tutorial.md)</ept>.",
      "pos": [
        11748,
        11864
      ]
    },
    {
      "content": "Delete the resource group or the virtual machine and cloud service when you are done with your testing.",
      "pos": [
        11865,
        11968
      ]
    },
    {
      "content": "If you can create a Remote Desktop connection with a computer directly attached to the Internet, check your organization intranet edge device for:",
      "pos": [
        11970,
        12116
      ]
    },
    {
      "content": "An internal firewall that is blocking HTTPS connections to the Internet",
      "pos": [
        12120,
        12191
      ]
    },
    {
      "content": "Your proxy server that is preventing Remote Desktop connections",
      "pos": [
        12194,
        12257
      ]
    },
    {
      "content": "Intrusion detection or network monitoring software running on devices in your edge network that is preventing Remote Desktop connections",
      "pos": [
        12260,
        12396
      ]
    },
    {
      "content": "Work with your network administrator to correct the settings of your organization intranet edge device to allow HTTPS-based Remote Desktop connections to the Internet.",
      "pos": [
        12398,
        12565
      ]
    },
    {
      "content": "Source 3: Cloud service endpoint and ACL",
      "pos": [
        12571,
        12611
      ]
    },
    {
      "content": "To eliminate the cloud service endpoint and ACL as being the source of issues or misconfiguration for virtual machines created using the Service Management API, verify that another Azure virtual machine that is in the same cloud service or virtual network can make Remote Desktop connections to your Azure virtual machine.",
      "pos": [
        12613,
        12935
      ]
    },
    {
      "pos": [
        13026,
        13140
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> For virtual machines created in Resource Manager, skip to <bpt id=\"p1\">[</bpt>Source 4: Network Security Groups<ept id=\"p1\">](#nsgs)</ept>."
    },
    {
      "content": "If you do not have another virtual machine in the same cloud service or virtual network, you can easily create a new one.",
      "pos": [
        13142,
        13263
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Create a virtual machine running Windows in Azure<ept id=\"p1\">](virtual-machines-windows-tutorial.md)</ept>.",
      "pos": [
        13264,
        13380
      ]
    },
    {
      "content": "Delete the extra virtual machine when you are done with your testing.",
      "pos": [
        13381,
        13450
      ]
    },
    {
      "content": "If you can create a Remote Desktop connection with a virtual machine in the same cloud service or virtual network, check for these:",
      "pos": [
        13452,
        13583
      ]
    },
    {
      "content": "The endpoint configuration for Remote Desktop traffic on the target virtual machine.",
      "pos": [
        13587,
        13671
      ]
    },
    {
      "content": "The private TCP port of the endpoint must match the TCP port on which the Remote Desktop Services service on the virtual machine is listening, which by default is 3389.",
      "pos": [
        13672,
        13840
      ]
    },
    {
      "content": "The ACL for the Remote Desktop traffic endpoint on the target virtual machine.",
      "pos": [
        13843,
        13921
      ]
    },
    {
      "content": "ACLs allow you to specify allowed or denied incoming traffic from the Internet based on its source IP address.",
      "pos": [
        13922,
        14032
      ]
    },
    {
      "content": "Misconfigured ACLs can prevent incoming Remote Desktop traffic to the endpoint.",
      "pos": [
        14033,
        14112
      ]
    },
    {
      "content": "Examine your ACLs to ensure that incoming traffic from your public IP addresses of your proxy or other edge server is allowed.",
      "pos": [
        14113,
        14239
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>What is a Network Access Control List (ACL)?<ept id=\"p1\">](../virtual-network/virtual-networks-acl.md)</ept>.",
      "pos": [
        14240,
        14357
      ]
    },
    {
      "content": "To eliminate the endpoint as a source of the problem, remove the current endpoint and create a new endpoint, choosing a random port in the range 49152–65535 for the external port number.",
      "pos": [
        14359,
        14545
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>How to set up endpoints to a virtual machine<ept id=\"p1\">](virtual-machines-set-up-endpoints.md)</ept>.",
      "pos": [
        14546,
        14657
      ]
    },
    {
      "pos": [
        14663,
        14713
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"nsgs\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Source 4: Network Security Groups"
    },
    {
      "content": "Network Security Groups allow you have more granular control of allowed inbound and outbound traffic.",
      "pos": [
        14715,
        14816
      ]
    },
    {
      "content": "You can create rules that span subnets and cloud services in an Azure virtual network.",
      "pos": [
        14817,
        14903
      ]
    },
    {
      "content": "Examine your Network Security Group rules to ensure that Remote Desktop traffic from the Internet is allowed.",
      "pos": [
        14904,
        15013
      ]
    },
    {
      "pos": [
        15015,
        15127
      ],
      "content": "For more information, see <bpt id=\"p1\">[</bpt>What is a Network Security Group (NSG)?<ept id=\"p1\">](../virtual-network/virtual-networks-nsg.md)</ept>."
    },
    {
      "content": "Source 5: Windows-based Azure virtual machine",
      "pos": [
        15133,
        15178
      ]
    },
    {
      "content": "The last set of possible problems is on the Azure virtual machine itself.",
      "pos": [
        15180,
        15253
      ]
    },
    {
      "content": "First, if you were unable to run the <bpt id=\"p1\">[</bpt>Azure IaaS (Windows) diagnostics package<ept id=\"p1\">](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864)</ept> for the <bpt id=\"p2\">**</bpt>RDP connectivity to an Azure VM (Reboot Required)<ept id=\"p2\">**</ept> issue, follow the instructions in <bpt id=\"p3\">[</bpt>How to reset a password or the Remote Desktop service for Windows virtual machines<ept id=\"p3\">](virtual-machines-windows-reset-password.md)</ept> to reset the Remote Desktop Services service on the virtual machine.",
      "pos": [
        15342,
        15807
      ]
    },
    {
      "content": "This will:",
      "pos": [
        15808,
        15818
      ]
    },
    {
      "content": "Enable the \"Remote Desktop\" Windows Firewall default rule (TCP port 3389).",
      "pos": [
        15822,
        15896
      ]
    },
    {
      "content": "Enable Remote Desktop connections by setting the HKLM\\System\\CurrentControlSet\\Control\\Terminal Server\\fDenyTSConnections registry value to 0.",
      "pos": [
        15899,
        16041
      ]
    },
    {
      "content": "Try the connection from your computer again.",
      "pos": [
        16043,
        16087
      ]
    },
    {
      "content": "If you are not successful, these are some of the possible problems:",
      "pos": [
        16088,
        16155
      ]
    },
    {
      "content": "The Remote Desktop Services service is not running on the target virtual machine.",
      "pos": [
        16159,
        16240
      ]
    },
    {
      "content": "The Remote Desktop Services service is not listening on TCP port 3389.",
      "pos": [
        16243,
        16313
      ]
    },
    {
      "content": "Windows Firewall or another local firewall has an outbound rule that is preventing Remote Desktop traffic.",
      "pos": [
        16316,
        16422
      ]
    },
    {
      "content": "Intrusion detection or network monitoring software running on the Azure virtual machine is preventing Remote Desktop connections.",
      "pos": [
        16425,
        16554
      ]
    },
    {
      "content": "To correct these possible problems for virtual machines created using the Service Management API, you can use a remote Azure PowerShell session to the Azure virtual machine.",
      "pos": [
        16556,
        16729
      ]
    },
    {
      "content": "First, you must install a certificate for the virtual machine's hosting cloud service.",
      "pos": [
        16730,
        16816
      ]
    },
    {
      "content": "Go to <bpt id=\"p1\">[</bpt>Configures Secure Remote PowerShell Access to Azure Virtual Machines<ept id=\"p1\">](http://gallery.technet.microsoft.com/scriptcenter/Configures-Secure-Remote-b137f2fe)</ept> and download the <bpt id=\"p2\">**</bpt>InstallWinRMCertAzureVM.ps1<ept id=\"p2\">**</ept> script file to a folder on your local computer.",
      "pos": [
        16817,
        17075
      ]
    },
    {
      "content": "Next, install Azure PowerShell if you haven't already.",
      "pos": [
        17077,
        17131
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>How to install and configure Azure PowerShell<ept id=\"p1\">](../install-configure-powershell.md)</ept>.",
      "pos": [
        17132,
        17220
      ]
    },
    {
      "content": "Next, open an Azure PowerShell command prompt and then change the current folder to the location of the <bpt id=\"p1\">**</bpt>InstallWinRMCertAzureVM.ps1<ept id=\"p1\">**</ept> script file.",
      "pos": [
        17222,
        17370
      ]
    },
    {
      "content": "To run an Azure PowerShell script, you must set the correct execution policy.",
      "pos": [
        17371,
        17448
      ]
    },
    {
      "content": "Run the <bpt id=\"p1\">**</bpt>Get-ExecutionPolicy<ept id=\"p1\">**</ept> command to determine your current policy level.",
      "pos": [
        17449,
        17528
      ]
    },
    {
      "content": "For information about setting the appropriate level, see <bpt id=\"p1\">[</bpt>Set-ExecutionPolicy<ept id=\"p1\">](https://technet.microsoft.com/library/hh849812.aspx)</ept>.",
      "pos": [
        17529,
        17661
      ]
    },
    {
      "content": "Next, fill in your Azure subscription name, the cloud service name, and your virtual machine name (removing the &lt; and &gt; characters), and then run these commands.",
      "pos": [
        17663,
        17824
      ]
    },
    {
      "content": "You can get the correct subscription name from the SubscriptionName property of the display of the <bpt id=\"p1\">**</bpt>Get-AzureSubscription<ept id=\"p1\">**</ept> command.",
      "pos": [
        18114,
        18247
      ]
    },
    {
      "content": "You can get the cloud service name for the virtual machine from the ServiceName column of the display of the <bpt id=\"p1\">**</bpt>Get-AzureVM<ept id=\"p1\">**</ept> command.",
      "pos": [
        18248,
        18381
      ]
    },
    {
      "content": "To prove that you have this new certificate, open a Certificates snap-in focused on the current user and look in the <bpt id=\"p1\">**</bpt>Trusted Root Certification Authorities\\Certificates<ept id=\"p1\">**</ept> folder.",
      "pos": [
        18383,
        18563
      ]
    },
    {
      "content": "You should see a certificate with the DNS name of your cloud service in the Issued To column (example: cloudservice4testing.cloudapp.net).",
      "pos": [
        18564,
        18702
      ]
    },
    {
      "content": "Next, initiate a remote Azure PowerShell session by using these commands.",
      "pos": [
        18704,
        18777
      ]
    },
    {
      "content": "After entering valid administrator credentials, you should see something like this as your Azure PowerShell prompt:",
      "pos": [
        18936,
        19051
      ]
    },
    {
      "content": "The first part of the prompt indicates that you are now issuing Azure PowerShell commands for the cloud service that contains the target virtual machine.",
      "pos": [
        19124,
        19277
      ]
    },
    {
      "content": "Your cloud service name will be something different from \"cloudservice4testing.cloudapp.net\".",
      "pos": [
        19278,
        19371
      ]
    },
    {
      "content": "You can now issue Azure PowerShell commands to investigate the additional problems cited above and make configuration corrections.",
      "pos": [
        19373,
        19503
      ]
    },
    {
      "content": "To manually correct the Remote Desktop Services listening TCP port",
      "pos": [
        19509,
        19575
      ]
    },
    {
      "pos": [
        19577,
        19875
      ],
      "content": "If you were unable to run the <bpt id=\"p1\">[</bpt>Azure IaaS (Windows) diagnostics package<ept id=\"p1\">](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864)</ept> for the <bpt id=\"p2\">**</bpt>RDP connectivity to an Azure VM (Reboot Required)<ept id=\"p2\">**</ept> issue, at the remote Azure PowerShell session prompt, run this command."
    },
    {
      "content": "The PortNumber property shows the current port number.",
      "pos": [
        20001,
        20055
      ]
    },
    {
      "content": "If needed, change the Remote Desktop port number back to its default value (3389) by using this command.",
      "pos": [
        20056,
        20160
      ]
    },
    {
      "content": "Verify that the port has been changed to 3389 by using this command.",
      "pos": [
        20298,
        20366
      ]
    },
    {
      "content": "Exit the remote Azure PowerShell session by using this command.",
      "pos": [
        20492,
        20555
      ]
    },
    {
      "content": "Verify that the Remote Desktop endpoint for the Azure virtual machine is also using TCP port 3398 as its internal port.",
      "pos": [
        20577,
        20696
      ]
    },
    {
      "content": "Then, restart the Azure virtual machine and try your Remote Desktop connection again.",
      "pos": [
        20697,
        20782
      ]
    },
    {
      "content": "Step 5: Submit your issue to the Azure support forums",
      "pos": [
        20787,
        20840
      ]
    },
    {
      "content": "To get help from Azure experts across the world, you can submit your issue to either the MSDN Azure or Stack Overflow forums.",
      "pos": [
        20842,
        20967
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>Microsoft Azure forums<ept id=\"p1\">](http://azure.microsoft.com/support/forums/)</ept> for more information.",
      "pos": [
        20968,
        21062
      ]
    },
    {
      "content": "Step 6: File an Azure support incident",
      "pos": [
        21067,
        21105
      ]
    },
    {
      "pos": [
        21107,
        21559
      ],
      "content": "If you have run the <bpt id=\"p1\">[</bpt>Azure IaaS (Windows) diagnostics package<ept id=\"p1\">](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864)</ept> for the <bpt id=\"p2\">**</bpt>RDP connectivity to an Azure VM (Reboot Required)<ept id=\"p2\">**</ept> issue or done steps 2 through 5 in in this article and submitted your issue to the Azure support forums, but still cannot create a Remote Desktop connection, one alternative to consider is whether you can re-create the virtual machine."
    },
    {
      "content": "If you cannot re-create the virtual machine, it might be time for you to file an Azure support incident.",
      "pos": [
        21561,
        21665
      ]
    },
    {
      "pos": [
        21667,
        21793
      ],
      "content": "To file an incident, go to the <bpt id=\"p1\">[</bpt>Azure Support site<ept id=\"p1\">](http://azure.microsoft.com/support/options/)</ept> and click on <bpt id=\"p2\">**</bpt>Get Support<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        21795,
        21917
      ],
      "content": "For information about using Azure Support, see the <bpt id=\"p1\">[</bpt>Microsoft Azure Support FAQ<ept id=\"p1\">](http://azure.microsoft.com/support/faq/)</ept>."
    },
    {
      "content": "Additional resources",
      "pos": [
        21922,
        21942
      ]
    },
    {
      "content": "Azure IaaS (Windows) diagnostics package",
      "pos": [
        21945,
        21985
      ]
    },
    {
      "content": "How to reset a password or the Remote Desktop service for Windows virtual machines",
      "pos": [
        22081,
        22163
      ]
    },
    {
      "content": "How to install and configure Azure PowerShell",
      "pos": [
        22211,
        22256
      ]
    },
    {
      "content": "Troubleshoot Secure Shell (SSH) connections to a Linux-based Azure virtual machine",
      "pos": [
        22296,
        22378
      ]
    },
    {
      "content": "Troubleshoot access to an application running on an Azure virtual machine",
      "pos": [
        22432,
        22505
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"Troubleshoot Remote Desktop connections to a Windows-based Azure Virtual Machine\"\n    description=\"If you can't connect your Windows-based Azure virtual machine, use these diagnotics and steps to isolate the source of the problem.\"\n    services=\"virtual-machines\"\n    documentationCenter=\"\"\n    authors=\"dsk-2015\"\n    manager=\"timlt\"\n    editor=\"\"\n    tags=\"azure-service-management,azure-resource-manager\"/>\n\n<tags\n    ms.service=\"virtual-machines\"\n    ms.workload=\"infrastructure-services\"\n    ms.tgt_pltfrm=\"vm-windows\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.date=\"07/07/2015\"\n    ms.author=\"dkshir\"/>\n\n# Troubleshoot Remote Desktop connections to a Windows-based Azure virtual machine\n\nIf you can't connect to Windows-based Azure virtual machines, this article describes a methodical approach for correction and root-cause determination of Remote Desktop connections.\n\n## Step 1: Run the Azure IaaS diagnostics package\n\nTo address many of the common problems with creating Remote Desktop connections, Microsoft has created an [Azure IaaS (Windows) diagnostics package](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864).\n\n1.  Click **Microsoft Azure IaaS (Windows) diagnostics package** on this page to create a new diagnostics session.\n2.  On the **Which of the following issues are you experiencing with your Azure VM?** page, select the **RDP connectivity to an Azure VM (Reboot Required)** issue.\n\nFor more information, see the [Microsoft Azure IaaS (Windows) diagnostics package Knowledgebase article](http://support.microsoft.com/kb/2976864).\n\nIf running the Azure IaaS diagnostics package did not correct the problem or you were unable to run the diagnostics package, more detailed troubleshooting described in the following steps might be required.\n\n> [AZURE.NOTE] The Azure IaaS (Windows) diagnostics package must be run from a computer running Windows 8, Windows 8.1, Windows Server 2012, or Windows Server 2012 R2.\n\n## Step 2: Determine the error message from the Remote Desktop client\n\nUse these sections based on the error message you see when attempting to connect.\n\n### Remote Desktop Connection message window: The remote session was disconnected because there are no Remote Desktop License Servers available to provide a license.\n\nCause: The 120-day licensing grace period for the Remote Desktop Server role has expired and you need to install licenses.\n\nAs a temporary workaround, save a local copy of the RDP file from the Azure portal and then run this command at a Windows PowerShell command prompt to connect.\n\n    mstsc <File name>.RDP /admin\n\nThis will disable licensing for only that connection.\n\nIf you don't actually need more than two simultaneous Remote Desktop connections to the virtual machine, you can use Server Manager to remove the Remote Desktop Server role.\n\nAlso see the [Azure VM fails with \"No Remote Desktop License Servers available\"](http://blogs.msdn.com/b/wats/archive/2014/01/21/rdp-to-azure-vm-fails-with-quot-no-remote-desktop-license-servers-available-quot.aspx) blog post.\n\n### Remote Desktop Connection message window: Remote Desktop can't find the computer \"name\".\n\nCause: The Remote Desktop client on your computer cannot resolve the name of the computer in the settings of the RDP file.\n\nHere is an example RDP file generated by the Azure portal:\n\n    full address:s:tailspin-azdatatier.cloudapp.net:55919\n    prompt for credentials:i:1\n\nIn this example, the address portion consists of the fully qualified domain name of the cloud service that contains the virtual machine (tailspin-azdatatier.cloudapp.net in this example) and the external TCP port of the endpoint for Remote Desktop traffic (55919).\n\nPossible solutions to this problem:\n\n- If you are on an organization intranet, ensure that your computer has access to the proxy server and can send HTTPS traffic to it.\n- If you are using a locally stored RDP file, try using the one generated by the Azure portal to ensure you have the correct DNS name for the virtual machine or the cloud service and the endpoint port of the virtual machine.\n\n### Remote Desktop Connection message window: An authentication error has occurred. The Local Security Authority cannot be contacted.\n\nCause: The virtual machine to which you are connecting cannot locate the security authority indicated in the user name portion of your credentials.\n\nWhen your user name is of the form *SecurityAuthority*\\\\*UserName* (example: CORP\\User1), the *SecurityAuthority* portion is either the virtual machine's computer name (for the local security authority) or an Active Directory domain name.\n\nPossible solutions to this problem:\n\n- If the user account is local to the virtual machine, verify the spelling of the virtual machine name.\n- If the user account is an Active Directory domain account, verify the spelling of the domain name.\n- If the user account is an Active Directory domain account and the domain name is spelled correctly, verify that a domain controller for the Active Directory domain is available. This can be a common issue in an Azure virtual network that contains domain controllers, in which a domain controller computer is not started. A temporary workaround is to use a local administrator account, rather than a domain account.\n\n### Windows Security message window: Your credentials did not work.\n\nCause: The account name and password that you submitted cannot be validated by the virtual machine to which you are connecting.\n\nA Windows-based computer can validate the credentials of either a local account or a domain-based account.\n\n- For local accounts, use the *ComputerName*\\\\*UserName* syntax (example: SQL1\\Admin4798).\n- For domain accounts, use the *DomainName*\\\\*UserName* syntax (example: CONTOSO\\johndoe).\n\nFor computers that you promote to domain controllers in a new Active Directory forest, the local administrator account that you are logged in to when you perform the promotion gets converted to an equivalent account with the same password in the new forest and domain. The previous local administrator account is deleted. For example, if you logged in with the local administrator account DC1\\DCAdmin and promoted the virtual machine as a domain controller in a new forest for the corp.contoso.com domain, the DC1\\DCAdmin local account gets deleted and a new domain account (CORP\\DCAdmin) is created with the same password.\n\nDouble-check the account name to ensure that it is a name that the virtual machine can verify as a valid account. Double-check the password to ensure that it is the correct password.\n\nIf you need to change the password of the local administrator account, see [How to reset a password or the Remote Desktop service for Windows virtual machines](virtual-machines-windows-reset-password.md).\n\n### Remote Desktop Connection message window: This computer can't connect to the remote computer.\n\nCause: The account that you are using to connect does not have Remote Desktop logon rights.\n\nEach Windows-based computer has a Remote Desktop Users local group, which contains the accounts and groups that have the right to log on with a Remote Desktop connection. Members of the local Administrators group also have access, even though those accounts are not listed as members of the Remote Desktop Users local group. For domain-joined machines, the local Administrators group also contains the domain administrators for the domain.\n\nEnsure that the account you are using to initiate the connection has Remote Desktop logon rights. Use a domain administrator or local administrator account as a temporary workaround to create a Remote Desktop connection and add the desired account to the Remote Desktop Users local group by using the Computer Management snap-in (**System Tools > Local Users and Groups > Groups > Remote Desktop Users**).\n\n### Remote Desktop Connection message window: Remote Desktop cannot connect to the remote computer for one of these reasons…\n\nCause: The Remote Desktop client cannot reach the Remote Desktop Services service on the virtual machine. This problem can be due to many root causes.\n\nHere is the set of components involved.\n\n![](./media/virtual-machines-troubleshoot-remote-desktop-connections/tshootrdp_0.png)\n\nBefore diving into a step-by-step troubleshooting process, it is helpful to mentally review what has changed since you were able to successfully create Remote Desktop connections and use that change as a basis for correcting the problem. For example:\n\n- If you were able to create Remote Desktop connections and you changed the public IP address of the virtual machine or the cloud service containing your virtual machine (also known as the virtual IP address [VIP]), your DNS client cache might have an entry for the DNS name and the *old IP address*. Flush your DNS client cache and try again. Alternately, try making the connection by using the new VIP.\n- If you changed from using the Azure portal or the Azure preview portal to using an application to manage your Remote Desktop connections, ensure that the application configuration includes the randomly determined TCP port for the Remote Desktop traffic.\n\nThe following sections step through isolating and determining the various root causes for this problem and providing solutions and workarounds.\n\n## Step 3: Preliminary steps before detailed troubleshooting\n\nPerform these steps:\n\n- Check the status of the virtual machine in the Azure portal or the Azure preview portal\n- [Restart the virtual machine](https://msdn.microsoft.com/library/azure/dn763934.aspx)\n- [Resize the virtual machine](https://msdn.microsoft.com/library/dn168976.aspx)\n\nAfter these steps, try the Remote Desktop connection again.\n\n## Step 4: Detailed troubleshooting\n\nThe inability of your Remote Desktop client to reach the Remote Desktop Services service on the Azure virtual machine can be due to the following sources of issues or misconfigurations:\n\n- Remote Desktop client computer\n- Organization intranet edge device\n- Cloud service endpoint and access control list (ACL)\n- Network security groups\n- Windows-based Azure virtual machine\n\n### Source 1: Remote Desktop client computer\n\nTo eliminate your computer as being the source of issues or misconfiguration, verify that your computer can make Remote Desktop connections to another on-premises, Windows-based computer.\n\n![](./media/virtual-machines-troubleshoot-remote-desktop-connections/tshootrdp_1.png)\n\nIf you cannot, check for these on your computer:\n\n- A local firewall setting that is blocking Remote Desktop traffic\n- Locally installed client proxy software that is preventing Remote Desktop connections\n- Locally installed network monitoring software that is preventing Remote Desktop connections\n- Other types of security software that either monitor traffic or allow/disallow specific types of traffic that is preventing Remote Desktop connections\n\nIn all of these cases, try to temporarily disable the software and attempt a Remote Desktop connection to an on-premises computer to determine the root cause. Then, work with your network administrator to correct the settings of the software to allow Remote Desktop connections.\n\n### Source 2: Organization intranet edge device\n\nTo eliminate your organization intranet edge device as being the source of issues or misconfiguration, verify that a computer directly connected to the Internet can make Remote Desktop connections to your Azure virtual machine.\n\n![](./media/virtual-machines-troubleshoot-remote-desktop-connections/tshootrdp_2.png)\n\nIf you do not have a computer that is directly connected to the Internet, you can easily create a new Azure virtual machine in its own resource group or cloud service and use it. For more information, see [Create a virtual machine running Windows in Azure](virtual-machines-windows-tutorial.md). Delete the resource group or the virtual machine and cloud service when you are done with your testing.\n\nIf you can create a Remote Desktop connection with a computer directly attached to the Internet, check your organization intranet edge device for:\n\n- An internal firewall that is blocking HTTPS connections to the Internet\n- Your proxy server that is preventing Remote Desktop connections\n- Intrusion detection or network monitoring software running on devices in your edge network that is preventing Remote Desktop connections\n\nWork with your network administrator to correct the settings of your organization intranet edge device to allow HTTPS-based Remote Desktop connections to the Internet.\n\n### Source 3: Cloud service endpoint and ACL\n\nTo eliminate the cloud service endpoint and ACL as being the source of issues or misconfiguration for virtual machines created using the Service Management API, verify that another Azure virtual machine that is in the same cloud service or virtual network can make Remote Desktop connections to your Azure virtual machine.\n\n![](./media/virtual-machines-troubleshoot-remote-desktop-connections/tshootrdp_3.png)\n\n> [AZURE.NOTE] For virtual machines created in Resource Manager, skip to [Source 4: Network Security Groups](#nsgs).\n\nIf you do not have another virtual machine in the same cloud service or virtual network, you can easily create a new one. For more information, see [Create a virtual machine running Windows in Azure](virtual-machines-windows-tutorial.md). Delete the extra virtual machine when you are done with your testing.\n\nIf you can create a Remote Desktop connection with a virtual machine in the same cloud service or virtual network, check for these:\n\n- The endpoint configuration for Remote Desktop traffic on the target virtual machine. The private TCP port of the endpoint must match the TCP port on which the Remote Desktop Services service on the virtual machine is listening, which by default is 3389.\n- The ACL for the Remote Desktop traffic endpoint on the target virtual machine. ACLs allow you to specify allowed or denied incoming traffic from the Internet based on its source IP address. Misconfigured ACLs can prevent incoming Remote Desktop traffic to the endpoint. Examine your ACLs to ensure that incoming traffic from your public IP addresses of your proxy or other edge server is allowed. For more information, see [What is a Network Access Control List (ACL)?](../virtual-network/virtual-networks-acl.md).\n\nTo eliminate the endpoint as a source of the problem, remove the current endpoint and create a new endpoint, choosing a random port in the range 49152–65535 for the external port number. For more information, see [How to set up endpoints to a virtual machine](virtual-machines-set-up-endpoints.md).\n\n### <a id=\"nsgs\"></a>Source 4: Network Security Groups\n\nNetwork Security Groups allow you have more granular control of allowed inbound and outbound traffic. You can create rules that span subnets and cloud services in an Azure virtual network. Examine your Network Security Group rules to ensure that Remote Desktop traffic from the Internet is allowed.\n\nFor more information, see [What is a Network Security Group (NSG)?](../virtual-network/virtual-networks-nsg.md).\n\n### Source 5: Windows-based Azure virtual machine\n\nThe last set of possible problems is on the Azure virtual machine itself.\n\n![](./media/virtual-machines-troubleshoot-remote-desktop-connections/tshootrdp_5.png)\n\nFirst, if you were unable to run the [Azure IaaS (Windows) diagnostics package](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864) for the **RDP connectivity to an Azure VM (Reboot Required)** issue, follow the instructions in [How to reset a password or the Remote Desktop service for Windows virtual machines](virtual-machines-windows-reset-password.md) to reset the Remote Desktop Services service on the virtual machine. This will:\n\n- Enable the \"Remote Desktop\" Windows Firewall default rule (TCP port 3389).\n- Enable Remote Desktop connections by setting the HKLM\\System\\CurrentControlSet\\Control\\Terminal Server\\fDenyTSConnections registry value to 0.\n\nTry the connection from your computer again. If you are not successful, these are some of the possible problems:\n\n- The Remote Desktop Services service is not running on the target virtual machine.\n- The Remote Desktop Services service is not listening on TCP port 3389.\n- Windows Firewall or another local firewall has an outbound rule that is preventing Remote Desktop traffic.\n- Intrusion detection or network monitoring software running on the Azure virtual machine is preventing Remote Desktop connections.\n\nTo correct these possible problems for virtual machines created using the Service Management API, you can use a remote Azure PowerShell session to the Azure virtual machine. First, you must install a certificate for the virtual machine's hosting cloud service. Go to [Configures Secure Remote PowerShell Access to Azure Virtual Machines](http://gallery.technet.microsoft.com/scriptcenter/Configures-Secure-Remote-b137f2fe) and download the **InstallWinRMCertAzureVM.ps1** script file to a folder on your local computer.\n\nNext, install Azure PowerShell if you haven't already. See [How to install and configure Azure PowerShell](../install-configure-powershell.md).\n\nNext, open an Azure PowerShell command prompt and then change the current folder to the location of the **InstallWinRMCertAzureVM.ps1** script file. To run an Azure PowerShell script, you must set the correct execution policy. Run the **Get-ExecutionPolicy** command to determine your current policy level. For information about setting the appropriate level, see [Set-ExecutionPolicy](https://technet.microsoft.com/library/hh849812.aspx).\n\nNext, fill in your Azure subscription name, the cloud service name, and your virtual machine name (removing the < and > characters), and then run these commands.\n\n    $subscr=\"<Name of your Azure subscription>\"\n    $serviceName=\"<Name of the cloud service that contains the target virtual machine>\"\n    $vmName=\"<Name of the target virtual machine>\"\n    .\\InstallWinRMCertAzureVM.ps1 -SubscriptionName $subscr -ServiceName $serviceName -Name $vmName\n\nYou can get the correct subscription name from the SubscriptionName property of the display of the **Get-AzureSubscription** command. You can get the cloud service name for the virtual machine from the ServiceName column of the display of the **Get-AzureVM** command.\n\nTo prove that you have this new certificate, open a Certificates snap-in focused on the current user and look in the **Trusted Root Certification Authorities\\Certificates** folder. You should see a certificate with the DNS name of your cloud service in the Issued To column (example: cloudservice4testing.cloudapp.net).\n\nNext, initiate a remote Azure PowerShell session by using these commands.\n\n    $uri = Get-AzureWinRMUri -ServiceName $serviceName -Name $vmName\n    $creds = Get-Credential\n    Enter-PSSession -ConnectionUri $uri -Credential $creds\n\nAfter entering valid administrator credentials, you should see something like this as your Azure PowerShell prompt:\n\n    [cloudservice4testing.cloudapp.net]: PS C:\\Users\\User1\\Documents>\n\nThe first part of the prompt indicates that you are now issuing Azure PowerShell commands for the cloud service that contains the target virtual machine. Your cloud service name will be something different from \"cloudservice4testing.cloudapp.net\".\n\nYou can now issue Azure PowerShell commands to investigate the additional problems cited above and make configuration corrections.\n\n### To manually correct the Remote Desktop Services listening TCP port\n\nIf you were unable to run the [Azure IaaS (Windows) diagnostics package](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864) for the **RDP connectivity to an Azure VM (Reboot Required)** issue, at the remote Azure PowerShell session prompt, run this command.\n\n    Get-ItemProperty -Path \"HKLM:\\System\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp\" -Name \"PortNumber\"\n\nThe PortNumber property shows the current port number. If needed, change the Remote Desktop port number back to its default value (3389) by using this command.\n\n    Set-ItemProperty -Path \"HKLM:\\System\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp\" -Name \"PortNumber\" -Value 3389\n\nVerify that the port has been changed to 3389 by using this command.\n\n    Get-ItemProperty -Path \"HKLM:\\System\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp\" -Name \"PortNumber\"\n\nExit the remote Azure PowerShell session by using this command.\n\n    Exit-PSSession\n\nVerify that the Remote Desktop endpoint for the Azure virtual machine is also using TCP port 3398 as its internal port. Then, restart the Azure virtual machine and try your Remote Desktop connection again.\n\n## Step 5: Submit your issue to the Azure support forums\n\nTo get help from Azure experts across the world, you can submit your issue to either the MSDN Azure or Stack Overflow forums. See [Microsoft Azure forums](http://azure.microsoft.com/support/forums/) for more information.\n\n## Step 6: File an Azure support incident\n\nIf you have run the [Azure IaaS (Windows) diagnostics package](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864) for the **RDP connectivity to an Azure VM (Reboot Required)** issue or done steps 2 through 5 in in this article and submitted your issue to the Azure support forums, but still cannot create a Remote Desktop connection, one alternative to consider is whether you can re-create the virtual machine.\n\nIf you cannot re-create the virtual machine, it might be time for you to file an Azure support incident.\n\nTo file an incident, go to the [Azure Support site](http://azure.microsoft.com/support/options/) and click on **Get Support**.\n\nFor information about using Azure Support, see the [Microsoft Azure Support FAQ](http://azure.microsoft.com/support/faq/).\n\n## Additional resources\n\n[Azure IaaS (Windows) diagnostics package](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864)\n\n[How to reset a password or the Remote Desktop service for Windows virtual machines](virtual-machines-windows-reset-password.md)\n\n[How to install and configure Azure PowerShell](../install-configure-powershell.md)\n\n[Troubleshoot Secure Shell (SSH) connections to a Linux-based Azure virtual machine](virtual-machines-troubleshoot-ssh-connections.md)\n\n[Troubleshoot access to an application running on an Azure virtual machine](virtual-machines-troubleshoot-access-application.md)\n"
}