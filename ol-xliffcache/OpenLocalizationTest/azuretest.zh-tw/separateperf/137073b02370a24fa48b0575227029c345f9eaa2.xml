{
  "nodes": [
    {
      "content": "How to use diagnostics (.NET) | Microsoft Azure",
      "pos": [
        28,
        75
      ]
    },
    {
      "content": "Learn how to use diagnostic data in Azure for debugging, measuring performance, monitoring, traffic analysis, and more.",
      "pos": [
        95,
        214
      ]
    },
    {
      "content": "Enabling Diagnostics in Azure Cloud Services and Virtual Machines",
      "pos": [
        532,
        597
      ]
    },
    {
      "content": "Azure Diagnostics 1.2 and 1.3 enable you to collect diagnostic data from a worker role, web role, or virtual machine running in Azure.",
      "pos": [
        599,
        733
      ]
    },
    {
      "content": "This guide describes how to use Azure Diagnostics 1.2 and 1.3.",
      "pos": [
        734,
        796
      ]
    },
    {
      "content": "For additional in-depth guidance on creating a logging and tracing strategy and using diagnostics and other techniques to troubleshoot problems, see <bpt id=\"p1\">[</bpt>Troubleshooting Best Practices for Developing Azure Applications<ept id=\"p1\">][]</ept>.",
      "pos": [
        797,
        1015
      ]
    },
    {
      "content": "Overview",
      "pos": [
        1020,
        1028
      ]
    },
    {
      "content": "Azure Diagnostics 1.2 and 1.3 are Azure extensions that enable you to collect diagnostic telemetry data from a worker role, web role, or virtual machine running in Azure.",
      "pos": [
        1030,
        1200
      ]
    },
    {
      "content": "The telemetry data is stored in an Azure storage account and can be used for debugging and troubleshooting, measuring performance, monitoring resource usage, traffic analysis and capacity planning, and auditing.",
      "pos": [
        1201,
        1412
      ]
    },
    {
      "content": "Azure Diagnostics 1.2 are for use with Azure SDKs for .NET 2.4 and before.",
      "pos": [
        1415,
        1489
      ]
    },
    {
      "content": "Azure Diagnostics 1.3 are for use with Azure SDKs for .NET 2.5 and later.",
      "pos": [
        1490,
        1563
      ]
    },
    {
      "content": "If you have used Diagnostics version 1.0 in the past, there are three notable differences compared to Diagnostics 1.2 and 1.3:",
      "pos": [
        1565,
        1691
      ]
    },
    {
      "content": "Diagnostics 1.2 and 1.3 can be deployed on virtual machines, in addition to cloud services.",
      "pos": [
        1697,
        1788
      ]
    },
    {
      "content": "Diagnostics 1.0 is part of the Azure SDK and is deployed when you deploy your cloud service.",
      "pos": [
        1793,
        1885
      ]
    },
    {
      "content": "Diagnostics 1.2 and 1.3 are an extension and are deployed separately from your cloud service deployment.",
      "pos": [
        1886,
        1990
      ]
    },
    {
      "content": "Diagnostics 1.2 and 1.3 enable the collection of ETW and .NET EventSource events.",
      "pos": [
        1995,
        2076
      ]
    },
    {
      "pos": [
        2078,
        2182
      ],
      "content": "For a more detailed comparison, see <bpt id=\"p1\">[</bpt>Comparing Azure Diagnostics Versions<ept id=\"p1\">][]</ept> at the end of this article."
    },
    {
      "content": "Azure Diagnostics can collect the following types of telemetry:",
      "pos": [
        2184,
        2247
      ]
    },
    {
      "content": "Data Source",
      "pos": [
        2249,
        2260
      ]
    },
    {
      "content": "Description",
      "pos": [
        2261,
        2272
      ]
    },
    {
      "content": "IIS Logs",
      "pos": [
        2281,
        2289
      ]
    },
    {
      "content": "Information about IIS web sites.",
      "pos": [
        2290,
        2322
      ]
    },
    {
      "content": "Azure Diagnostic infrastructure logs",
      "pos": [
        2323,
        2359
      ]
    },
    {
      "content": "Information about Diagnostics itself.",
      "pos": [
        2360,
        2397
      ]
    },
    {
      "content": "IIS Failed Request logs",
      "pos": [
        2398,
        2421
      ]
    },
    {
      "content": "Information about failed requests to an IIS site or application.",
      "pos": [
        2422,
        2486
      ]
    },
    {
      "content": "Windows Event logs",
      "pos": [
        2487,
        2505
      ]
    },
    {
      "content": "Information sent to the Windows event logging system.",
      "pos": [
        2506,
        2559
      ]
    },
    {
      "content": "Performance counters",
      "pos": [
        2560,
        2580
      ]
    },
    {
      "content": "Operating System and custom performance counters.",
      "pos": [
        2581,
        2630
      ]
    },
    {
      "content": "Crash dumps",
      "pos": [
        2631,
        2642
      ]
    },
    {
      "content": "Information about the state of the process in the event of an application crash.",
      "pos": [
        2643,
        2723
      ]
    },
    {
      "content": "Custom error logs",
      "pos": [
        2724,
        2741
      ]
    },
    {
      "content": "Logs created by your application or service.",
      "pos": [
        2742,
        2786
      ]
    },
    {
      "content": "NET EventSource",
      "pos": [
        2787,
        2802
      ]
    },
    {
      "pos": [
        2804,
        2968
      ],
      "content": "Events generated by your code using the .NET <ph id=\"ph1\">&lt;a href=\"http://msdn.microsoft.com/library/system.diagnostics.tracing.eventsource(v=vs.110).aspx\"&gt;</ph>EventSource class<ph id=\"ph2\">&lt;/a&gt;</ph>"
    },
    {
      "content": "Manifest based ETW",
      "pos": [
        2969,
        2987
      ]
    },
    {
      "content": "ETW events generated by any process.",
      "pos": [
        2988,
        3024
      ]
    },
    {
      "content": "How to Enable Diagnostics in a Worker Role",
      "pos": [
        3029,
        3071
      ]
    },
    {
      "content": "This walk through describes how to implement an Azure worker role that emits telemetry data using the .NET EventSource class.",
      "pos": [
        3073,
        3198
      ]
    },
    {
      "content": "Azure Diagnostics is used to collect the telemetry data and store it in an Azure storage account.",
      "pos": [
        3199,
        3296
      ]
    },
    {
      "content": "When creating a worker role Visual Studio automatically enables Diagnostics 1.0 as part of the solution in Azure SDKs for .NET 2.4 and earlier.",
      "pos": [
        3297,
        3440
      ]
    },
    {
      "content": "The following instructions describe the process for creating the worker role, disabling Diagnostics 1.0 from the solution, and deploying Diagnostics 1.2 or 1.3 to your worker role.",
      "pos": [
        3441,
        3621
      ]
    },
    {
      "content": "Pre-requisites",
      "pos": [
        3627,
        3641
      ]
    },
    {
      "content": "This article assumes you have an Azure subscription and are using Visual Studio 2013 with the Azure SDK.",
      "pos": [
        3642,
        3746
      ]
    },
    {
      "content": "If you do not have an Azure subscription, you can sign up for the <bpt id=\"p1\">[</bpt>Free Trial<ept id=\"p1\">][]</ept>.",
      "pos": [
        3747,
        3828
      ]
    },
    {
      "content": "Make sure to <bpt id=\"p1\">[</bpt>Install and configure Azure PowerShell version 0.8.7 or later<ept id=\"p1\">][]</ept>.",
      "pos": [
        3829,
        3908
      ]
    },
    {
      "content": "Step 1: Create a Worker Role",
      "pos": [
        3914,
        3942
      ]
    },
    {
      "pos": [
        3947,
        3977
      ],
      "content": "Launch <bpt id=\"p1\">**</bpt>Visual Studio 2013<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Create a new <bpt id=\"p1\">**</bpt>Azure Cloud Service<ept id=\"p1\">**</ept> project from the <bpt id=\"p2\">**</bpt>Cloud<ept id=\"p2\">**</ept> template that targets .NET Framework 4.5.",
      "pos": [
        3982,
        4087
      ]
    },
    {
      "content": "Name the project \"WadExample\" and click Ok.",
      "pos": [
        4089,
        4132
      ]
    },
    {
      "content": "Select <bpt id=\"p1\">**</bpt>Worker Role<ept id=\"p1\">**</ept> and click Ok.",
      "pos": [
        4137,
        4173
      ]
    },
    {
      "content": "The project will be created.",
      "pos": [
        4174,
        4202
      ]
    },
    {
      "pos": [
        4208,
        4286
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, double-click on the <bpt id=\"p2\">**</bpt>WorkerRole1<ept id=\"p2\">**</ept> properties file."
    },
    {
      "pos": [
        4291,
        4407
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Configuration<ept id=\"p1\">**</ept> tab un-check <bpt id=\"p2\">**</bpt>Enable Diagnostics<ept id=\"p2\">**</ept> to disable Diagnostics 1.0 (Azure SDK 2.4 and eariler)."
    },
    {
      "content": "Build your solution to verify that you have no errors.",
      "pos": [
        4412,
        4466
      ]
    },
    {
      "content": "Step 2: Instrument your code",
      "pos": [
        4472,
        4500
      ]
    },
    {
      "content": "Replace the contents of WorkerRole.cs with the following code.",
      "pos": [
        4501,
        4563
      ]
    },
    {
      "content": "The class SampleEventSourceWriter, inherited from the <bpt id=\"p1\">[</bpt>EventSource Class<ept id=\"p1\">][]</ept>, implements four logging methods: <bpt id=\"p2\">**</bpt>SendEnums<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>MessageMethod<ept id=\"p3\">**</ept>, <bpt id=\"p4\">**</bpt>SetOther<ept id=\"p4\">**</ept> and <bpt id=\"p5\">**</bpt>HighFreq<ept id=\"p5\">**</ept>.",
      "pos": [
        4564,
        4738
      ]
    },
    {
      "content": "The first parameter to the <bpt id=\"p1\">**</bpt>WriteEvent<ept id=\"p1\">**</ept> method defines the ID for the respective event.",
      "pos": [
        4739,
        4828
      ]
    },
    {
      "content": "The Run method implements an infinite loop that calls each of the logging methods implemented in the <bpt id=\"p1\">**</bpt>SampleEventSourceWriter<ept id=\"p1\">**</ept> class every 10 seconds.",
      "pos": [
        4829,
        4981
      ]
    },
    {
      "content": "Step 3: Deploy your Worker Role",
      "pos": [
        7399,
        7430
      ]
    },
    {
      "pos": [
        7435,
        7600
      ],
      "content": "Deploy your worker role to Azure from within Visual Studio by selecting the <bpt id=\"p1\">**</bpt>WadExample<ept id=\"p1\">**</ept> project in the Solution Explorer then <bpt id=\"p2\">**</bpt>Publish<ept id=\"p2\">**</ept> from the <bpt id=\"p3\">**</bpt>Build<ept id=\"p3\">**</ept> menu."
    },
    {
      "content": "Choose your subscription.",
      "pos": [
        7605,
        7630
      ]
    },
    {
      "pos": [
        7635,
        7709
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Microsoft Azure Publish Settings<ept id=\"p1\">**</ept> dialog select <bpt id=\"p2\">**</bpt>Create New…<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        7714,
        7856
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Create Cloud Service and Storage Account<ept id=\"p1\">**</ept> dialog enter a <bpt id=\"p2\">**</bpt>Name<ept id=\"p2\">**</ept> (for example, \"WadExample\") and select a region or affinity group."
    },
    {
      "pos": [
        7861,
        7900
      ],
      "content": "Set the <bpt id=\"p1\">**</bpt>Environment<ept id=\"p1\">**</ept> to <bpt id=\"p2\">**</bpt>Staging<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        7905,
        7972
      ],
      "content": "Modify any other <bpt id=\"p1\">**</bpt>Settings<ept id=\"p1\">**</ept> as appropriate and click <bpt id=\"p2\">**</bpt>Publish<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        7977,
        8085
      ],
      "content": "After deployment has completed verify in the Azure Portal that your cloud service is in a <bpt id=\"p1\">**</bpt>Running<ept id=\"p1\">**</ept> state."
    },
    {
      "content": "Step 4: Create your Diagnostics configuration file and install the extension",
      "pos": [
        8091,
        8167
      ]
    },
    {
      "content": "Download the public configuration file schema definition by executing the following PowerShell command:",
      "pos": [
        8172,
        8275
      ]
    },
    {
      "content": "(Get-AzureServiceAvailableExtension -ExtensionName 'PaaSDiagnostics' -ProviderNamespace 'Microsoft.Azure.Diagnostics').PublicConfigurationSchema | Out-File -Encoding utf8 -FilePath 'WadConfig.xsd'",
      "pos": [
        8289,
        8485
      ]
    },
    {
      "content": "Add an XML file to your <bpt id=\"p1\">**</bpt>WorkerRole1<ept id=\"p1\">**</ept> project by right-clicking on the <bpt id=\"p2\">**</bpt>WorkerRole1<ept id=\"p2\">**</ept> project and select <bpt id=\"p3\">**</bpt>Add<ept id=\"p3\">**</ept> -&gt; <bpt id=\"p4\">**</bpt>New Item…<ept id=\"p4\">**</ept> -&gt; <bpt id=\"p5\">**</bpt>Visual C# items<ept id=\"p5\">**</ept> -&gt; <bpt id=\"p6\">**</bpt>Data<ept id=\"p6\">**</ept> -&gt; <bpt id=\"p7\">**</bpt>XML File<ept id=\"p7\">**</ept>.",
      "pos": [
        8492,
        8676
      ]
    },
    {
      "content": "Name the file \"WadExample.xml\".",
      "pos": [
        8677,
        8708
      ]
    },
    {
      "content": "CloudServices_diag_add_xml",
      "pos": [
        8716,
        8742
      ]
    },
    {
      "content": "Associate the WadConfig.xsd with the configuration file.",
      "pos": [
        8807,
        8863
      ]
    },
    {
      "content": "Make sure the WadExample.xml editor window is the active window.",
      "pos": [
        8864,
        8928
      ]
    },
    {
      "content": "Press <bpt id=\"p1\">**</bpt>F4<ept id=\"p1\">**</ept> to open the <bpt id=\"p2\">**</bpt>Properties<ept id=\"p2\">**</ept> window.",
      "pos": [
        8929,
        8976
      ]
    },
    {
      "content": "Click on the <bpt id=\"p1\">**</bpt>Schemas<ept id=\"p1\">**</ept> property in the <bpt id=\"p2\">**</bpt>Properties<ept id=\"p2\">**</ept> window.",
      "pos": [
        8977,
        9040
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>…<ept id=\"p1\">**</ept> in the <bpt id=\"p2\">**</bpt>Schemas<ept id=\"p2\">**</ept> property.",
      "pos": [
        9041,
        9085
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>Add…<ept id=\"p1\">**</ept> button and navigate to the location where you saved the XSD file and select the file WadConfig.xsd.",
      "pos": [
        9086,
        9204
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.",
      "pos": [
        9205,
        9218
      ]
    },
    {
      "content": "Replace the contents of the WadExample.xml configuration file with the following XML and save the file.",
      "pos": [
        9223,
        9326
      ]
    },
    {
      "content": "This configuration file defines a couple performance counters to collect: one for CPU utilization and one for memory utilization.",
      "pos": [
        9327,
        9456
      ]
    },
    {
      "content": "Then the configuration defines the four events corresponding to the methods in the SampleEventSourceWriter class.",
      "pos": [
        9457,
        9570
      ]
    },
    {
      "content": "Step 5: Install Diagnostics on your Worker Role",
      "pos": [
        10960,
        11007
      ]
    },
    {
      "content": "The PowerShell cmdlets for managing Diagnostics on a web or worker role are: Set-AzureServiceDiagnosticsExtension, Get-AzureServiceDiagnosticsExtension, and Remove-AzureServiceDiagnosticsExtension.",
      "pos": [
        11008,
        11205
      ]
    },
    {
      "content": "Open Azure PowerShell.",
      "pos": [
        11211,
        11233
      ]
    },
    {
      "pos": [
        11238,
        11395
      ],
      "content": "Execute the script to install Diagnostics on your worker role (replace <bpt id=\"p1\">*</bpt>StorageAccountKey<ept id=\"p1\">*</ept> with the storage account key for your wadexample storage account):"
    },
    {
      "content": "Step 6: Look at your telemetry data",
      "pos": [
        11915,
        11950
      ]
    },
    {
      "content": "In the Visual Studio <bpt id=\"p1\">**</bpt>Server Explorer<ept id=\"p1\">**</ept> navigate to the wadexample storage account.",
      "pos": [
        11951,
        12035
      ]
    },
    {
      "content": "After the cloud service has been running about 5 minutes you should see the tables <bpt id=\"p1\">**</bpt>WADEnumsTable<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>WADHighFreqTable<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>WADMessageTable<ept id=\"p3\">**</ept>, <bpt id=\"p4\">**</bpt>WADPerformanceCountersTable<ept id=\"p4\">**</ept> and <bpt id=\"p5\">**</bpt>WADSetOtherTable<ept id=\"p5\">**</ept>.",
      "pos": [
        12036,
        12238
      ]
    },
    {
      "content": "Double-click on one of the tables to view the telemetry that has been collected.",
      "pos": [
        12239,
        12319
      ]
    },
    {
      "content": "<ph id=\"ph1\">    ![</ph>CloudServices_diag_tables<ph id=\"ph2\">](./media/cloud-services-dotnet-diagnostics/WadExampleTables.png)</ph>",
      "pos": [
        12320,
        12416
      ]
    },
    {
      "content": "How to Enable Diagnostics in a Virtual Machine",
      "pos": [
        12421,
        12467
      ]
    },
    {
      "content": "This walk through describes how to remotely install Diagnostics to an Azure virtual machine from a development computer.",
      "pos": [
        12469,
        12589
      ]
    },
    {
      "content": "You also learn how to implement an application that runs on that Azure virtual machine and emits telemetry data using the .NET <bpt id=\"p1\">[</bpt>EventSource Class<ept id=\"p1\">][]</ept>.",
      "pos": [
        12590,
        12739
      ]
    },
    {
      "content": "Azure Diagnostics is used to collect the telemetry and store it in an Azure storage account.",
      "pos": [
        12740,
        12832
      ]
    },
    {
      "content": "Pre-requisites",
      "pos": [
        12838,
        12852
      ]
    },
    {
      "content": "This walk through assumes you have an Azure subscription and are using Visual Studio 2013 with the Azure SDK.",
      "pos": [
        12853,
        12962
      ]
    },
    {
      "content": "If you do not have an Azure subscription, you can sign up for the <bpt id=\"p1\">[</bpt>Free Trial<ept id=\"p1\">][]</ept>.",
      "pos": [
        12963,
        13044
      ]
    },
    {
      "content": "Make sure to <bpt id=\"p1\">[</bpt>Install and configure Azure PowerShell version 0.8.7 or later<ept id=\"p1\">][]</ept>.",
      "pos": [
        13045,
        13124
      ]
    },
    {
      "content": "Step 1: Create a Virtual Machine",
      "pos": [
        13130,
        13162
      ]
    },
    {
      "content": "On your development computer, launch Visual Studio 2013.",
      "pos": [
        13167,
        13223
      ]
    },
    {
      "pos": [
        13228,
        13359
      ],
      "content": "In the Visual Studio <bpt id=\"p1\">**</bpt>Server Explorer<ept id=\"p1\">**</ept> expand <bpt id=\"p2\">**</bpt>Azure<ept id=\"p2\">**</ept>, right-click <bpt id=\"p3\">**</bpt>Virtual Machines<ept id=\"p3\">**</ept> then select <bpt id=\"p4\">**</bpt>Create Virtual Machine<ept id=\"p4\">**</ept>."
    },
    {
      "pos": [
        13364,
        13454
      ],
      "content": "Select your Azure subscription in the <bpt id=\"p1\">**</bpt>Choose a Subscription<ept id=\"p1\">**</ept> dialog and click <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        13459,
        13587
      ],
      "content": "Select <bpt id=\"p1\">**</bpt>Windows Server 2012 R2 Datacenter, November 2014<ept id=\"p1\">**</ept> in the <bpt id=\"p2\">**</bpt>Select a Virtual Machine Image<ept id=\"p2\">**</ept> dialog and click <bpt id=\"p3\">**</bpt>Next<ept id=\"p3\">**</ept>."
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Virtual Machine Basic Settings<ept id=\"p1\">**</ept>, set the virtual machine name to \"wadexample\".",
      "pos": [
        13592,
        13680
      ]
    },
    {
      "content": "Set your Administrator user name and password and click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>.",
      "pos": [
        13681,
        13746
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Cloud Service Settings<ept id=\"p1\">**</ept> dialog create a new cloud service named \"wadexampleVM\".",
      "pos": [
        13751,
        13840
      ]
    },
    {
      "content": "Create a new Storage account named \"wadexample\" and click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>.",
      "pos": [
        13841,
        13908
      ]
    },
    {
      "pos": [
        13913,
        13930
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Create<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Step 2: Create your Application",
      "pos": [
        13936,
        13967
      ]
    },
    {
      "content": "On your development computer, launch Visual Studio 2013.",
      "pos": [
        13972,
        14028
      ]
    },
    {
      "pos": [
        14033,
        14237
      ],
      "content": "Create a new Visual C# Console Application that targets .NET Framework 4.5. Name the project \"WadExampleVM\".\n![CloudServices_diag_new_project](./media/cloud-services-dotnet-diagnostics/NewProject.png)",
      "leadings": [
        "",
        "    "
      ],
      "nodes": [
        {
          "content": "Create a new Visual C# Console Application that targets .NET Framework 4.5. Name the project \"WadExampleVM\".",
          "pos": [
            0,
            108
          ],
          "nodes": [
            {
              "content": "Create a new Visual C# Console Application that targets .NET Framework 4.5.",
              "pos": [
                0,
                75
              ]
            },
            {
              "content": "Name the project \"WadExampleVM\".",
              "pos": [
                76,
                108
              ]
            }
          ]
        },
        {
          "content": "CloudServices_diag_new_project",
          "pos": [
            111,
            141
          ]
        }
      ]
    },
    {
      "content": "Replace the contents of Program.cs with the following code.",
      "pos": [
        14242,
        14301
      ]
    },
    {
      "content": "The class <bpt id=\"p1\">**</bpt>SampleEventSourceWriter<ept id=\"p1\">**</ept> implements four logging methods: <bpt id=\"p2\">**</bpt>SendEnums<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>MessageMethod<ept id=\"p3\">**</ept>, <bpt id=\"p4\">**</bpt>SetOther<ept id=\"p4\">**</ept> and <bpt id=\"p5\">**</bpt>HighFreq<ept id=\"p5\">**</ept>.",
      "pos": [
        14302,
        14437
      ]
    },
    {
      "content": "The first parameter to the WriteEvent method defines the ID for the respective event.",
      "pos": [
        14438,
        14523
      ]
    },
    {
      "content": "The Run method implements an infinite loop that calls each of the logging methods implemented in the <bpt id=\"p1\">**</bpt>SampleEventSourceWriter<ept id=\"p1\">**</ept> class every 10 seconds.",
      "pos": [
        14524,
        14676
      ]
    },
    {
      "pos": [
        16690,
        16777
      ],
      "content": "Save the file and select <bpt id=\"p1\">**</bpt>Build Solution<ept id=\"p1\">**</ept> from the <bpt id=\"p2\">**</bpt>Build<ept id=\"p2\">**</ept> menu to build your code."
    },
    {
      "content": "Step 3: Deploy your Application",
      "pos": [
        16784,
        16815
      ]
    },
    {
      "pos": [
        16820,
        16933
      ],
      "content": "Right-click on the <bpt id=\"p1\">**</bpt>WadExampleVM<ept id=\"p1\">**</ept> project in <bpt id=\"p2\">**</bpt>Solution Explorer<ept id=\"p2\">**</ept> and choose <bpt id=\"p3\">**</bpt>Open Folder in File Explorer<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        16938,
        17012
      ],
      "content": "Navigate to the <bpt id=\"p1\">*</bpt>bin\\Debug<ept id=\"p1\">*</ept> folder and copy all the files (WadExampleVM.*)"
    },
    {
      "pos": [
        17017,
        17119
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Server Explorer<ept id=\"p1\">**</ept> right-click on the virtual machine and choose <bpt id=\"p2\">**</bpt>Connect using Remote Desktop<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Once connected to the VM create a folder named WadExampleVM and paste your application files into the folder.",
      "pos": [
        17124,
        17233
      ]
    },
    {
      "content": "Launch the application WadExampleVM.exe.",
      "pos": [
        17238,
        17278
      ]
    },
    {
      "content": "You should see a blank console window.",
      "pos": [
        17279,
        17317
      ]
    },
    {
      "content": "Step 4: Create your Diagnostics configuration and install the Extension",
      "pos": [
        17323,
        17394
      ]
    },
    {
      "content": "Download the public configuration file schema definition to your development computer by executing the following PowerShell command:",
      "pos": [
        17399,
        17531
      ]
    },
    {
      "content": "Open a new XML file in Visual Studio, either in a project you already have open or in a Visual Studio instance with no open projects.",
      "pos": [
        17744,
        17877
      ]
    },
    {
      "content": "In Visual Studio, select <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept> -&gt; <bpt id=\"p2\">**</bpt>New Item…<ept id=\"p2\">**</ept> -&gt; <bpt id=\"p3\">**</bpt>Visual C# items<ept id=\"p3\">**</ept> -&gt; <bpt id=\"p4\">**</bpt>Data<ept id=\"p4\">**</ept> -&gt; <bpt id=\"p5\">**</bpt>XML File<ept id=\"p5\">**</ept>.",
      "pos": [
        17878,
        17979
      ]
    },
    {
      "content": "Name the file \"WadExample.xml\"",
      "pos": [
        17980,
        18010
      ]
    },
    {
      "content": "Associate the WadConfig.xsd with the configuration file.",
      "pos": [
        18015,
        18071
      ]
    },
    {
      "content": "Make sure the WadExample.xml editor window is the active window.",
      "pos": [
        18072,
        18136
      ]
    },
    {
      "content": "Press <bpt id=\"p1\">**</bpt>F4<ept id=\"p1\">**</ept> to open the <bpt id=\"p2\">**</bpt>Properties<ept id=\"p2\">**</ept> window.",
      "pos": [
        18137,
        18184
      ]
    },
    {
      "content": "Click on the <bpt id=\"p1\">**</bpt>Schemas<ept id=\"p1\">**</ept> property in the <bpt id=\"p2\">**</bpt>Properties<ept id=\"p2\">**</ept> window.",
      "pos": [
        18185,
        18248
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>…<ept id=\"p1\">**</ept> in the <bpt id=\"p2\">**</bpt>Schemas<ept id=\"p2\">**</ept> property.",
      "pos": [
        18249,
        18293
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>Add…<ept id=\"p1\">**</ept> button and navigate to the location where you saved the XSD file and select the file WadConfig.xsd.",
      "pos": [
        18294,
        18412
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.",
      "pos": [
        18413,
        18426
      ]
    },
    {
      "content": "Replace the contents of the WadExample.xml configuration file with the following XML and save the file.",
      "pos": [
        18431,
        18534
      ]
    },
    {
      "content": "This configuration file defines a couple performance counters to collect: one for CPU utilization and one for memory utilization.",
      "pos": [
        18535,
        18664
      ]
    },
    {
      "content": "Then the configuration defines the four events corresponding to the methods in the SampleEventSourceWriter class.",
      "pos": [
        18665,
        18778
      ]
    },
    {
      "content": "Step 5: Remotely install Diagnostics on your Azure Virtual Machine",
      "pos": [
        20168,
        20234
      ]
    },
    {
      "content": "The PowerShell cmdlets for managing Diagnostics on a VM are: Set-AzureVMDiagnosticsExtension, Get-AzureVMDiagnosticsExtension, and Remove-AzureVMDiagnosticsExtension.",
      "pos": [
        20235,
        20401
      ]
    },
    {
      "content": "On your developer computer, open Azure PowerShell.",
      "pos": [
        20407,
        20457
      ]
    },
    {
      "pos": [
        20462,
        20621
      ],
      "content": "Execute the script to remotely install Diagnostics on your VM (Replace <bpt id=\"p1\">*</bpt>StorageAccountKey<ept id=\"p1\">*</ept> with the storage account key for your wadexamplevm storage account):"
    },
    {
      "content": "Step 6: Look at your telemetry data",
      "pos": [
        21298,
        21333
      ]
    },
    {
      "content": "In the Visual Studio <bpt id=\"p1\">**</bpt>Server Explorer<ept id=\"p1\">**</ept> navigate to the wadexample storage account.",
      "pos": [
        21334,
        21418
      ]
    },
    {
      "content": "After the VM has been running about 5 minutes you should see the tables <bpt id=\"p1\">**</bpt>WADEnumsTable<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>WADHighFreqTable<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>WADMessageTable<ept id=\"p3\">**</ept>, <bpt id=\"p4\">**</bpt>WADPerformanceCountersTable<ept id=\"p4\">**</ept> and <bpt id=\"p5\">**</bpt>WADSetOtherTable<ept id=\"p5\">**</ept>.",
      "pos": [
        21419,
        21610
      ]
    },
    {
      "content": "Double-click on one of the tables to view the telemetry that has been collected.",
      "pos": [
        21611,
        21691
      ]
    },
    {
      "content": "<ph id=\"ph1\">    ![</ph>CloudServices_diag_wadexamplevm_tables<ph id=\"ph2\">](./media/cloud-services-dotnet-diagnostics/WadExampleVMTables.png)</ph>",
      "pos": [
        21692,
        21803
      ]
    },
    {
      "content": "Configuration File Schema",
      "pos": [
        21808,
        21833
      ]
    },
    {
      "content": "The Diagnostics configuration file defines values that are used to initialize diagnostic configuration settings when the diagnostics monitor starts.",
      "pos": [
        21835,
        21983
      ]
    },
    {
      "content": "A sample configuration file and detailed documentation on its schema is located here: <bpt id=\"p1\">[</bpt>Azure Diagnostics 1.2 Configuration Schema<ept id=\"p1\">][]</ept>.",
      "pos": [
        21984,
        22117
      ]
    },
    {
      "content": "Troubleshooting",
      "pos": [
        22122,
        22137
      ]
    },
    {
      "content": "Azure Diagnostics is not Starting",
      "pos": [
        22143,
        22176
      ]
    },
    {
      "content": "Diagnostics is comprised of two components: A guest agent plugin and the monitoring agent.",
      "pos": [
        22177,
        22267
      ]
    },
    {
      "content": "Log files for the guest agent plugin are located in the file:",
      "pos": [
        22268,
        22329
      ]
    },
    {
      "pos": [
        22332,
        22460
      ],
      "content": "<bpt id=\"p1\">*</bpt>%SystemDrive%\\ WindowsAzure\\Logs\\Plugins\\Microsoft.Azure.Diagnostics.PaaSDiagnostics\\&lt;DiagnosticsVersion&gt;<ept id=\"p1\">*</ept>\\CommandExecution.log"
    },
    {
      "content": "The following error codes are returned by the plugin:",
      "pos": [
        22462,
        22515
      ]
    },
    {
      "content": "Exit Code",
      "pos": [
        22517,
        22526
      ]
    },
    {
      "content": "Description",
      "pos": [
        22527,
        22538
      ]
    },
    {
      "content": "0",
      "pos": [
        22547,
        22548
      ]
    },
    {
      "content": "Success.",
      "pos": [
        22549,
        22557
      ]
    },
    {
      "content": "-1",
      "pos": [
        22558,
        22560
      ]
    },
    {
      "content": "Generic Error.",
      "pos": [
        22561,
        22575
      ]
    },
    {
      "content": "-2",
      "pos": [
        22576,
        22578
      ]
    },
    {
      "content": "Unable to load the rcf file.",
      "pos": [
        22579,
        22607
      ]
    },
    {
      "content": "This is an internal error that should only happen if the guest agent plugin launcher is manually invoked, incorrectly, on the VM.",
      "pos": [
        22610,
        22739
      ]
    },
    {
      "content": "-3",
      "pos": [
        22740,
        22742
      ]
    },
    {
      "content": "Cannot load the Diagnostics configuration file.",
      "pos": [
        22743,
        22790
      ]
    },
    {
      "content": "Solution: This is the result of a configuration file not passing schema validation.",
      "pos": [
        22796,
        22879
      ]
    },
    {
      "content": "The solution is to provide a configuration file that complies with the schema.",
      "pos": [
        22880,
        22958
      ]
    },
    {
      "content": "-4",
      "pos": [
        22959,
        22961
      ]
    },
    {
      "content": "Another instance of the monitoring agent Diagnostics is already using the local resource directory.",
      "pos": [
        22962,
        23061
      ]
    },
    {
      "content": "Solution: Specify a different value for <bpt id=\"p1\">**</bpt>LocalResourceDirectory<ept id=\"p1\">**</ept>.",
      "pos": [
        23067,
        23134
      ]
    },
    {
      "content": "-6",
      "pos": [
        23135,
        23137
      ]
    },
    {
      "content": "The guest agent plugin launcher attempted to launch Diagnostics with an invalid command line.",
      "pos": [
        23138,
        23231
      ]
    },
    {
      "content": "This is an internal error that should only happen if the guest agent plugin launcher is manually invoked, incorrectly, on the VM.",
      "pos": [
        23237,
        23366
      ]
    },
    {
      "content": "-10",
      "pos": [
        23367,
        23370
      ]
    },
    {
      "content": "The Diagnostics plugin exited with an unhandled exception.",
      "pos": [
        23371,
        23429
      ]
    },
    {
      "content": "-11",
      "pos": [
        23430,
        23433
      ]
    },
    {
      "content": "The guest agent was unable to create the process responsible for launching and monitoring the monitoring agent.",
      "pos": [
        23434,
        23545
      ]
    },
    {
      "content": "Solution: Verify that sufficient system resources are available to launch new processes.",
      "pos": [
        23551,
        23639
      ]
    },
    {
      "content": "-101",
      "pos": [
        23643,
        23647
      ]
    },
    {
      "content": "Invalid arguments when calling the Diagnostics plugin.",
      "pos": [
        23648,
        23702
      ]
    },
    {
      "content": "This is an internal error that should only happen if the guest agent plugin launcher is manually invoked, incorrectly, on the VM.",
      "pos": [
        23708,
        23837
      ]
    },
    {
      "content": "-102",
      "pos": [
        23838,
        23842
      ]
    },
    {
      "content": "The plugin process is unable to initialize itself.",
      "pos": [
        23843,
        23893
      ]
    },
    {
      "content": "Solution: Verify that sufficient system resources are available to launch new processes.",
      "pos": [
        23899,
        23987
      ]
    },
    {
      "content": "-103",
      "pos": [
        23988,
        23992
      ]
    },
    {
      "content": "The plugin process is unable to initialize itself.",
      "pos": [
        23993,
        24043
      ]
    },
    {
      "content": "Specifically it is unable to create the logger object.",
      "pos": [
        24044,
        24098
      ]
    },
    {
      "content": "Solution: Verify that sufficient system resources are available to launch new processes.",
      "pos": [
        24104,
        24192
      ]
    },
    {
      "content": "-104",
      "pos": [
        24193,
        24197
      ]
    },
    {
      "content": "Unable to load the rcf file provided by the guest agent.",
      "pos": [
        24198,
        24254
      ]
    },
    {
      "content": "This is an internal error that should only happen if the guest agent plugin launcher is manually invoked, incorrectly, on the VM.",
      "pos": [
        24260,
        24389
      ]
    },
    {
      "content": "-105",
      "pos": [
        24390,
        24394
      ]
    },
    {
      "content": "The Diagnostics plugin cannot open the Diagnostics configuration file.",
      "pos": [
        24395,
        24465
      ]
    },
    {
      "content": "This is an internal error that should only happen if the Diagnostics plugin is manually invoked, incorrectly, on the VM.",
      "pos": [
        24471,
        24591
      ]
    },
    {
      "content": "-106",
      "pos": [
        24592,
        24596
      ]
    },
    {
      "content": "Cannot read the Diagnostics configuration file.",
      "pos": [
        24597,
        24644
      ]
    },
    {
      "content": "Solution: This is the result of a configuration file not passing schema validation.",
      "pos": [
        24650,
        24733
      ]
    },
    {
      "content": "So the solution is to provide a configuration file that complies with the schema.",
      "pos": [
        24734,
        24815
      ]
    },
    {
      "content": "You can find the XML that is delivered to the Diagnostics extension in the folder <bpt id=\"p1\">*</bpt>%SystemDrive%\\WindowsAzure\\Config<ept id=\"p1\">*</ept> on the VM.",
      "pos": [
        24816,
        24944
      ]
    },
    {
      "content": "Open the appropriate XML file and search for <bpt id=\"p1\">**</bpt>Microsoft.Azure.Diagnostics<ept id=\"p1\">**</ept>, then for the <bpt id=\"p2\">**</bpt>xmlCfg<ept id=\"p2\">**</ept> field.",
      "pos": [
        24945,
        25053
      ]
    },
    {
      "content": "The data is base64 encoded so you’ll need to <bpt id=\"p1\">[</bpt>decode it<ept id=\"p1\">](http://www.bing.com/search?q=base64+decoder)</ept> to see the XML that was loaded by Diagnostics.",
      "pos": [
        25054,
        25202
      ]
    },
    {
      "content": "-107",
      "pos": [
        25206,
        25210
      ]
    },
    {
      "content": "The resource directory pass to the monitoring agent is invalid.",
      "pos": [
        25211,
        25274
      ]
    },
    {
      "content": "This is an internal error that should only happen if the monitoring agent is manually invoked, incorrectly, on the VM.",
      "pos": [
        25280,
        25398
      ]
    },
    {
      "content": "-108",
      "pos": [
        25403,
        25407
      ]
    },
    {
      "content": "Unable to convert the Diagnostics configuration file into the monitoring agent configuration file.",
      "pos": [
        25412,
        25510
      ]
    },
    {
      "content": "This is an internal error that should only happen if the Diagnostics plugin is manually invoked with an invalid configuration file.",
      "pos": [
        25516,
        25647
      ]
    },
    {
      "content": "-110",
      "pos": [
        25648,
        25652
      ]
    },
    {
      "content": "General Diagnostics configuration error.",
      "pos": [
        25653,
        25693
      ]
    },
    {
      "content": "This is an internal error that should only happen if the Diagnostics plugin is manually invoked with an invalid configuration file.",
      "pos": [
        25699,
        25830
      ]
    },
    {
      "content": "-111",
      "pos": [
        25831,
        25835
      ]
    },
    {
      "content": "Unable to start the monitoring agent.",
      "pos": [
        25836,
        25873
      ]
    },
    {
      "content": "Solution: Verify that sufficient system resources are available.",
      "pos": [
        25879,
        25943
      ]
    },
    {
      "content": "-112",
      "pos": [
        25944,
        25948
      ]
    },
    {
      "content": "General error",
      "pos": [
        25949,
        25962
      ]
    },
    {
      "content": "Diagnostics Data is Not Logged to Storage",
      "pos": [
        25969,
        26010
      ]
    },
    {
      "content": "The most common cause of missing event data is incorrectly defined storage account information.",
      "pos": [
        26011,
        26106
      ]
    },
    {
      "content": "Solution: Correct your Diagnostics configuration file and re-install Diagnostics.",
      "pos": [
        26109,
        26190
      ]
    },
    {
      "content": "Before event data is uploaded to your storage account it is stored in the folder.",
      "pos": [
        26191,
        26272
      ]
    },
    {
      "content": "See above for details on <bpt id=\"p1\">**</bpt>LocalResourceDirectory<ept id=\"p1\">**</ept>.",
      "pos": [
        26273,
        26325
      ]
    },
    {
      "content": "If there are no files in this folder the monitoring agent is unable to launch.",
      "pos": [
        26327,
        26405
      ]
    },
    {
      "content": "This is typically caused by an invalid configuration file and should have been reported in the CommandExecution.log.",
      "pos": [
        26406,
        26522
      ]
    },
    {
      "content": "If the Monitoring Agent is successfully collecting event data you will see .tsf files for each event defined in your configuration file.",
      "pos": [
        26523,
        26659
      ]
    },
    {
      "content": "The Monitoring Agent logs any errors it experiences in the file MaEventTable.tsf.",
      "pos": [
        26661,
        26742
      ]
    },
    {
      "content": "To inspect the contents of this file run the following command:",
      "pos": [
        26743,
        26806
      ]
    },
    {
      "content": "The tool generates a file named maeventtable.csv that you may open and inspect the logs for failures.",
      "pos": [
        26948,
        27049
      ]
    },
    {
      "content": "Frequently Asked Questions",
      "pos": [
        27055,
        27081
      ]
    },
    {
      "content": "The following are some frequently asked questions and their answers:",
      "pos": [
        27082,
        27150
      ]
    },
    {
      "content": "Q.",
      "pos": [
        27154,
        27156
      ]
    },
    {
      "content": "How do I upgrade my Visual Studio solution from Azure Diagnostics 1.0 to Azure Diagnostics 1.1?",
      "pos": [
        27159,
        27254
      ]
    },
    {
      "content": "A.",
      "pos": [
        27258,
        27260
      ]
    },
    {
      "content": "Upgrading your Visual Studio solution from Diagnostics 1.0 to Diagnostics 1.1 (or later) is a manual process:",
      "pos": [
        27263,
        27372
      ]
    },
    {
      "content": "Disable Diagnostics in your Visual Studio solution to prevent Diagnostics 1.0 from being deployed with your role",
      "pos": [
        27375,
        27487
      ]
    },
    {
      "content": "If your code uses Trace Listener you will need to modify your code to use .NET EventSource.",
      "pos": [
        27490,
        27581
      ]
    },
    {
      "content": "Diagnostics 1.1 and later does not support Trace Listener.",
      "pos": [
        27582,
        27640
      ]
    },
    {
      "content": "Modify your deployment process to install the Diagnostics 1.1 extension",
      "pos": [
        27643,
        27714
      ]
    },
    {
      "content": "Q.",
      "pos": [
        27718,
        27720
      ]
    },
    {
      "content": "If I have already installed the Diagnostics 1.1 Extension on my role or VM how do I upgrade to Diagnostics 1.2 or 1.3?",
      "pos": [
        27723,
        27841
      ]
    },
    {
      "content": "A.",
      "pos": [
        27845,
        27847
      ]
    },
    {
      "content": "”\" when you installed Diagnostics 1.1, the next time your role restarts or the VM reboots it will be automatically updated to the most recent version matching the regular expression “1.",
      "pos": [
        27881,
        28066
      ]
    },
    {
      "content": "” If “–Version “1.1”” when you installed Diagnostics 1.1 you can update a newer version be re-executing the Set- cmdlet and specifying the version you want to install.",
      "pos": [
        28067,
        28234
      ]
    },
    {
      "content": "Q.",
      "pos": [
        28238,
        28240
      ]
    },
    {
      "content": "How are tables named?",
      "pos": [
        28243,
        28264
      ]
    },
    {
      "content": "A.",
      "pos": [
        28268,
        28270
      ]
    },
    {
      "content": "Tables are named according to the following:",
      "pos": [
        28273,
        28317
      ]
    },
    {
      "content": "Here is an example:",
      "pos": [
        28626,
        28645
      ]
    },
    {
      "content": "That will generate 4 tables:",
      "pos": [
        29028,
        29056
      ]
    },
    {
      "content": "Event",
      "pos": [
        29058,
        29063
      ]
    },
    {
      "content": "Table Name",
      "pos": [
        29064,
        29074
      ]
    },
    {
      "content": "provider=”prov1” &amp;lt;Event id=”1” /&amp;gt;",
      "pos": [
        29083,
        29122
      ]
    },
    {
      "content": "WADEvent+MD5(“prov1”)+”1”",
      "pos": [
        29123,
        29148
      ]
    },
    {
      "content": "provider=”prov1” &amp;lt;Event id=”2” eventDestination=”dest1” /&amp;gt;",
      "pos": [
        29149,
        29213
      ]
    },
    {
      "content": "WADdest1",
      "pos": [
        29214,
        29222
      ]
    },
    {
      "content": "provider=”prov1” &amp;lt;DefaultEvents /&amp;gt;",
      "pos": [
        29223,
        29263
      ]
    },
    {
      "content": "WADDefault+MD5(“prov1”)",
      "pos": [
        29264,
        29287
      ]
    },
    {
      "content": "provider=”prov2” &amp;lt;DefaultEvents eventDestination=”dest2” /&amp;gt;",
      "pos": [
        29288,
        29353
      ]
    },
    {
      "content": "WADdest2",
      "pos": [
        29354,
        29362
      ]
    },
    {
      "content": "Comparing Azure Diagnostics Versions",
      "pos": [
        29367,
        29403
      ]
    },
    {
      "content": "The following table compare the features supported by Azure Diagnostics versions 1.0 and 1.1/1.2/1.3:",
      "pos": [
        29405,
        29506
      ]
    },
    {
      "content": "Role Types Supported|Diagnostics 1.0|Diagnostics 1.1/1.2/1.3",
      "pos": [
        29508,
        29568
      ]
    },
    {
      "content": "---|---",
      "pos": [
        29569,
        29576
      ]
    },
    {
      "content": "Web role|Yes|Yes",
      "pos": [
        29577,
        29593
      ]
    },
    {
      "content": "Worker role|Yes|Yes",
      "pos": [
        29594,
        29613
      ]
    },
    {
      "content": "IaaS|No|Yes",
      "pos": [
        29614,
        29625
      ]
    },
    {
      "content": "Configuration and deployment",
      "pos": [
        29627,
        29655
      ]
    },
    {
      "content": "Diagnostics 1.0",
      "pos": [
        29656,
        29671
      ]
    },
    {
      "content": "Diagnostics 1.1/1.2/1.3",
      "pos": [
        29672,
        29695
      ]
    },
    {
      "content": "Integration with Visual Studio- Integrated into the Azure web/worker development experience.",
      "pos": [
        29708,
        29800
      ]
    },
    {
      "content": "Yes",
      "pos": [
        29801,
        29804
      ]
    },
    {
      "content": "No",
      "pos": [
        29805,
        29807
      ]
    },
    {
      "content": "PowerShell Scripts- Scripts to manage the installation and configuration of Diagnostics on the role.",
      "pos": [
        29808,
        29908
      ]
    },
    {
      "content": "Yes",
      "pos": [
        29909,
        29912
      ]
    },
    {
      "content": "Yes",
      "pos": [
        29913,
        29916
      ]
    },
    {
      "content": "Data Source",
      "pos": [
        29918,
        29929
      ]
    },
    {
      "content": "Default Collection",
      "pos": [
        29930,
        29948
      ]
    },
    {
      "content": "Format",
      "pos": [
        29949,
        29955
      ]
    },
    {
      "content": "Description",
      "pos": [
        29956,
        29967
      ]
    },
    {
      "content": "Diagnostics 1.0",
      "pos": [
        29968,
        29983
      ]
    },
    {
      "content": "Diagnostics 1.1/1.2",
      "pos": [
        29984,
        30003
      ]
    },
    {
      "content": "Diagnostics 1.3",
      "pos": [
        30004,
        30019
      ]
    },
    {
      "content": "System.Diagnostics.Trace Logs",
      "pos": [
        30048,
        30077
      ]
    },
    {
      "content": "Yes",
      "pos": [
        30078,
        30081
      ]
    },
    {
      "content": "Table",
      "pos": [
        30082,
        30087
      ]
    },
    {
      "content": "Logs trace messages sent from your code to the trace listener (a trace listener must be added to the web.config or app.config file).",
      "pos": [
        30088,
        30220
      ]
    },
    {
      "content": "Log data will be transferred at the scheduledTransferPeriod transfer interval to storage table WADLogsTable.",
      "pos": [
        30221,
        30329
      ]
    },
    {
      "content": "Yes",
      "pos": [
        30330,
        30333
      ]
    },
    {
      "content": "No (Use EventSource)",
      "pos": [
        30334,
        30354
      ]
    },
    {
      "content": "Yes",
      "pos": [
        30355,
        30358
      ]
    },
    {
      "content": "IIS logs",
      "pos": [
        30359,
        30367
      ]
    },
    {
      "content": "Yes",
      "pos": [
        30368,
        30371
      ]
    },
    {
      "content": "Blob",
      "pos": [
        30372,
        30376
      ]
    },
    {
      "content": "Logs information about IIS sites.",
      "pos": [
        30377,
        30410
      ]
    },
    {
      "content": "Log data will be transferred at the scheduledTransferPeriod transfer interval to the container you specify.",
      "pos": [
        30411,
        30518
      ]
    },
    {
      "content": "Yes",
      "pos": [
        30519,
        30522
      ]
    },
    {
      "content": "Yes",
      "pos": [
        30523,
        30526
      ]
    },
    {
      "content": "Yes",
      "pos": [
        30527,
        30530
      ]
    },
    {
      "content": "Azure Diagnostic infrastructure logs",
      "pos": [
        30531,
        30567
      ]
    },
    {
      "content": "Yes",
      "pos": [
        30568,
        30571
      ]
    },
    {
      "content": "Table",
      "pos": [
        30572,
        30577
      ]
    },
    {
      "content": "Logs information about the diagnostic infrastructure, the RemoteAccess module, and the RemoteForwarder module.",
      "pos": [
        30578,
        30688
      ]
    },
    {
      "content": "Log data will transferred at the scheduledTransferPeriodtransfer interval to storage table WADDiagnosticInfrastructureLogsTable.",
      "pos": [
        30689,
        30817
      ]
    },
    {
      "content": "Yes",
      "pos": [
        30818,
        30821
      ]
    },
    {
      "content": "Yes",
      "pos": [
        30822,
        30825
      ]
    },
    {
      "content": "Yes",
      "pos": [
        30826,
        30829
      ]
    },
    {
      "content": "IIS Failed Request logs",
      "pos": [
        30830,
        30853
      ]
    },
    {
      "content": "No",
      "pos": [
        30854,
        30856
      ]
    },
    {
      "content": "Blob",
      "pos": [
        30857,
        30861
      ]
    },
    {
      "content": "Logs information about failed requests to an IIS site or application.",
      "pos": [
        30862,
        30931
      ]
    },
    {
      "content": "You must also enable by setting tracing options under system.WebServer in Web.config.",
      "pos": [
        30932,
        31017
      ]
    },
    {
      "content": "Log data will be transferred at the scheduledTransferPeriod transfer interval to the container you specify.",
      "pos": [
        31018,
        31125
      ]
    },
    {
      "content": "Yes",
      "pos": [
        31126,
        31129
      ]
    },
    {
      "content": "Yes",
      "pos": [
        31130,
        31133
      ]
    },
    {
      "content": "Yes",
      "pos": [
        31134,
        31137
      ]
    },
    {
      "content": "Windows Event logs",
      "pos": [
        31138,
        31156
      ]
    },
    {
      "content": "No",
      "pos": [
        31157,
        31159
      ]
    },
    {
      "content": "Table",
      "pos": [
        31160,
        31165
      ]
    },
    {
      "content": "Logs information about how well the operating system, application, or driver is performing.",
      "pos": [
        31166,
        31257
      ]
    },
    {
      "content": "Performance counters must be specified explicitly.",
      "pos": [
        31258,
        31308
      ]
    },
    {
      "content": "When these are added, performance counter data will be transferred at the scheduledTransferPeriod transfer interval to storage table WADPerformanceCountersTable.",
      "pos": [
        31309,
        31470
      ]
    },
    {
      "content": "Yes",
      "pos": [
        31471,
        31474
      ]
    },
    {
      "content": "Yes",
      "pos": [
        31475,
        31478
      ]
    },
    {
      "content": "Yes",
      "pos": [
        31479,
        31482
      ]
    },
    {
      "content": "Performance counters",
      "pos": [
        31483,
        31503
      ]
    },
    {
      "content": "No",
      "pos": [
        31504,
        31506
      ]
    },
    {
      "content": "Table",
      "pos": [
        31507,
        31512
      ]
    },
    {
      "content": "Logs information about how well the operating system, application, or driver is performing.",
      "pos": [
        31513,
        31604
      ]
    },
    {
      "content": "Performance counters must be specified explicitly.",
      "pos": [
        31605,
        31655
      ]
    },
    {
      "content": "When these are added, performance counter data will be transferred at the scheduledTransferPeriod transfer interval to storage table WADPerformanceCountersTable.",
      "pos": [
        31656,
        31817
      ]
    },
    {
      "content": "Yes",
      "pos": [
        31818,
        31821
      ]
    },
    {
      "content": "Yes",
      "pos": [
        31822,
        31825
      ]
    },
    {
      "content": "Yes",
      "pos": [
        31826,
        31829
      ]
    },
    {
      "content": "Crash dumps",
      "pos": [
        31830,
        31841
      ]
    },
    {
      "content": "No",
      "pos": [
        31842,
        31844
      ]
    },
    {
      "content": "Blob",
      "pos": [
        31845,
        31849
      ]
    },
    {
      "content": "Logs information about the state of the operating system in the event of a system crash.",
      "pos": [
        31850,
        31938
      ]
    },
    {
      "content": "Mini crash dumps are collected locally.",
      "pos": [
        31939,
        31978
      ]
    },
    {
      "content": "Full dumps can be enabled.",
      "pos": [
        31979,
        32005
      ]
    },
    {
      "content": "Log data will be transferred at the scheduledTransferPeriod transfer interval to the container you specify.",
      "pos": [
        32006,
        32113
      ]
    },
    {
      "content": "Because ASP.NET handles most exceptions, this is generally useful only for a worker role or a VM.",
      "pos": [
        32114,
        32211
      ]
    },
    {
      "content": "Yes",
      "pos": [
        32212,
        32215
      ]
    },
    {
      "content": "Yes",
      "pos": [
        32216,
        32219
      ]
    },
    {
      "content": "Yes",
      "pos": [
        32220,
        32223
      ]
    },
    {
      "content": "Custom error logs",
      "pos": [
        32224,
        32241
      ]
    },
    {
      "content": "No",
      "pos": [
        32242,
        32244
      ]
    },
    {
      "content": "Blob",
      "pos": [
        32245,
        32249
      ]
    },
    {
      "content": "By using local storage resources, custom data can be logged and transferred immediately to the container you specify.",
      "pos": [
        32250,
        32367
      ]
    },
    {
      "content": "Yes",
      "pos": [
        32368,
        32371
      ]
    },
    {
      "content": "Yes",
      "pos": [
        32372,
        32375
      ]
    },
    {
      "content": "Yes",
      "pos": [
        32376,
        32379
      ]
    },
    {
      "content": "EventSource",
      "pos": [
        32380,
        32391
      ]
    },
    {
      "content": "No",
      "pos": [
        32392,
        32394
      ]
    },
    {
      "content": "Table",
      "pos": [
        32395,
        32400
      ]
    },
    {
      "content": "Logs events generated by your code using the .NET EventSource class.",
      "pos": [
        32401,
        32469
      ]
    },
    {
      "content": "No",
      "pos": [
        32470,
        32472
      ]
    },
    {
      "content": "Yes",
      "pos": [
        32473,
        32476
      ]
    },
    {
      "content": "Yes",
      "pos": [
        32477,
        32480
      ]
    },
    {
      "content": "Manifest based ETW",
      "pos": [
        32481,
        32499
      ]
    },
    {
      "content": "No",
      "pos": [
        32500,
        32502
      ]
    },
    {
      "content": "Table",
      "pos": [
        32503,
        32508
      ]
    },
    {
      "content": "ETW events generated by any process.",
      "pos": [
        32509,
        32545
      ]
    },
    {
      "content": "No",
      "pos": [
        32546,
        32548
      ]
    },
    {
      "content": "Yes",
      "pos": [
        32549,
        32552
      ]
    },
    {
      "content": "Yes",
      "pos": [
        32553,
        32556
      ]
    },
    {
      "content": "Additional Resources",
      "pos": [
        32562,
        32582
      ]
    },
    {
      "content": "Troubleshooting Best Practices for Developing Azure Applications",
      "pos": [
        32587,
        32651
      ]
    },
    {
      "content": "Collect Logging Data by Using Azure Diagnostics",
      "pos": [
        32658,
        32705
      ]
    },
    {
      "content": "Debugging an Azure Application",
      "pos": [
        32712,
        32742
      ]
    },
    {
      "content": "Configuring Diagnostics for Azure Cloud Services and Virtual Machines",
      "pos": [
        32749,
        32818
      ]
    },
    {
      "content": "test",
      "pos": [
        34361,
        34365
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"How to use diagnostics (.NET) | Microsoft Azure\" \n    description=\"Learn how to use diagnostic data in Azure for debugging, measuring performance, monitoring, traffic analysis, and more.\" \n    services=\"cloud-services\" \n    documentationCenter=\".net\" \n    authors=\"rboucher\" \n    manager=\"jwhit\" \n    editor=\"\"/>\n\n<tags \n    ms.service=\"cloud-services\" \n    ms.workload=\"tbd\" \n    ms.tgt_pltfrm=\"na\" \n    ms.devlang=\"dotnet\" \n    ms.topic=\"article\" \n    ms.date=\"08/25/2015\" \n    ms.author=\"robb\"/>\n\n\n\n# Enabling Diagnostics in Azure Cloud Services and Virtual Machines\n\nAzure Diagnostics 1.2 and 1.3 enable you to collect diagnostic data from a worker role, web role, or virtual machine running in Azure. This guide describes how to use Azure Diagnostics 1.2 and 1.3. For additional in-depth guidance on creating a logging and tracing strategy and using diagnostics and other techniques to troubleshoot problems, see [Troubleshooting Best Practices for Developing Azure Applications][].\n\n## Overview\n\nAzure Diagnostics 1.2 and 1.3 are Azure extensions that enable you to collect diagnostic telemetry data from a worker role, web role, or virtual machine running in Azure. The telemetry data is stored in an Azure storage account and can be used for debugging and troubleshooting, measuring performance, monitoring resource usage, traffic analysis and capacity planning, and auditing. \n\nAzure Diagnostics 1.2 are for use with Azure SDKs for .NET 2.4 and before. Azure Diagnostics 1.3 are for use with Azure SDKs for .NET 2.5 and later.\n\nIf you have used Diagnostics version 1.0 in the past, there are three notable differences compared to Diagnostics 1.2 and 1.3:\n\n1.  Diagnostics 1.2 and 1.3 can be deployed on virtual machines, in addition to cloud services.\n2.  Diagnostics 1.0 is part of the Azure SDK and is deployed when you deploy your cloud service. Diagnostics 1.2 and 1.3 are an extension and are deployed separately from your cloud service deployment.\n3.  Diagnostics 1.2 and 1.3 enable the collection of ETW and .NET EventSource events.\n\nFor a more detailed comparison, see [Comparing Azure Diagnostics Versions][] at the end of this article.\n\nAzure Diagnostics can collect the following types of telemetry:\n\nData Source|Description\n---|---\nIIS Logs|Information about IIS web sites.\nAzure Diagnostic infrastructure logs|Information about Diagnostics itself.\nIIS Failed Request logs|Information about failed requests to an IIS site or application.\nWindows Event logs|Information sent to the Windows event logging system.\nPerformance counters|Operating System and custom performance counters.\nCrash dumps|Information about the state of the process in the event of an application crash.\nCustom error logs|Logs created by your application or service.\nNET EventSource |Events generated by your code using the .NET <a href=\"http://msdn.microsoft.com/library/system.diagnostics.tracing.eventsource(v=vs.110).aspx\">EventSource class</a>\nManifest based ETW|ETW events generated by any process.\n\n## How to Enable Diagnostics in a Worker Role\n\nThis walk through describes how to implement an Azure worker role that emits telemetry data using the .NET EventSource class. Azure Diagnostics is used to collect the telemetry data and store it in an Azure storage account. When creating a worker role Visual Studio automatically enables Diagnostics 1.0 as part of the solution in Azure SDKs for .NET 2.4 and earlier. The following instructions describe the process for creating the worker role, disabling Diagnostics 1.0 from the solution, and deploying Diagnostics 1.2 or 1.3 to your worker role.\n\n### Pre-requisites\nThis article assumes you have an Azure subscription and are using Visual Studio 2013 with the Azure SDK. If you do not have an Azure subscription, you can sign up for the [Free Trial][]. Make sure to [Install and configure Azure PowerShell version 0.8.7 or later][].\n\n### Step 1: Create a Worker Role\n1.  Launch **Visual Studio 2013**.\n2.  Create a new **Azure Cloud Service** project from the **Cloud** template that targets .NET Framework 4.5.  Name the project \"WadExample\" and click Ok.\n3.  Select **Worker Role** and click Ok. The project will be created. \n4.  In **Solution Explorer**, double-click on the **WorkerRole1** properties file.\n5.  In the **Configuration** tab un-check **Enable Diagnostics** to disable Diagnostics 1.0 (Azure SDK 2.4 and eariler).\n6.  Build your solution to verify that you have no errors.\n\n### Step 2: Instrument your code\nReplace the contents of WorkerRole.cs with the following code. The class SampleEventSourceWriter, inherited from the [EventSource Class][], implements four logging methods: **SendEnums**, **MessageMethod**, **SetOther** and **HighFreq**. The first parameter to the **WriteEvent** method defines the ID for the respective event. The Run method implements an infinite loop that calls each of the logging methods implemented in the **SampleEventSourceWriter** class every 10 seconds.\n\n    using Microsoft.WindowsAzure.ServiceRuntime;\n    using System;\n    using System.Diagnostics;\n    using System.Diagnostics.Tracing;\n    using System.Net;\n    using System.Threading;\n\n    namespace WorkerRole1\n    {\n    sealed class SampleEventSourceWriter : EventSource\n    {\n        public static SampleEventSourceWriter Log = new SampleEventSourceWriter();\n        public void SendEnums(MyColor color, MyFlags flags) { if (IsEnabled())  WriteEvent(1, (int)color, (int)flags); }// Cast enums to int for efficient logging.\n        public void MessageMethod(string Message) { if (IsEnabled())  WriteEvent(2, Message); }\n        public void SetOther(bool flag, int myInt) { if (IsEnabled())  WriteEvent(3, flag, myInt); }\n        public void HighFreq(int value) { if (IsEnabled()) WriteEvent(4, value); }\n\n    }\n\n    enum MyColor\n    {\n        Red,\n        Blue,\n        Green\n    }\n\n    [Flags]\n    enum MyFlags\n    {\n        Flag1 = 1,\n        Flag2 = 2,\n        Flag3 = 4\n    }\n\n    public class WorkerRole : RoleEntryPoint\n    {\n        public override void Run()\n        {\n            // This is a sample worker implementation. Replace with your logic.\n            Trace.TraceInformation(\"WorkerRole1 entry point called\");\n\n            int value = 0;\n\n            while (true)\n            {\n                Thread.Sleep(10000);\n                Trace.TraceInformation(\"Working\");\n\n                // Emit several events every time we go through the loop\n                for (int i = 0; i < 6; i++)\n                {\n                    SampleEventSourceWriter.Log.SendEnums(MyColor.Blue, MyFlags.Flag2 | MyFlags.Flag3);\n                }\n\n                for (int i = 0; i < 3; i++)\n                {\n                    SampleEventSourceWriter.Log.MessageMethod(\"This is a message.\");\n                    SampleEventSourceWriter.Log.SetOther(true, 123456789);\n                }\n\n                if (value == int.MaxValue) value = 0;\n                SampleEventSourceWriter.Log.HighFreq(value++);\n            }\n        }\n\n        public override bool OnStart()\n        {\n            // Set the maximum number of concurrent connections \n            ServicePointManager.DefaultConnectionLimit = 12;\n\n            // For information on handling configuration changes\n            // see the MSDN topic at http://go.microsoft.com/fwlink/?LinkId=166357.\n\n            return base.OnStart();\n        }\n    }\n    }\n\n\n### Step 3: Deploy your Worker Role\n1.  Deploy your worker role to Azure from within Visual Studio by selecting the **WadExample** project in the Solution Explorer then **Publish** from the **Build** menu.\n2.  Choose your subscription.\n3.  In the **Microsoft Azure Publish Settings** dialog select **Create New…**.\n4.  In the **Create Cloud Service and Storage Account** dialog enter a **Name** (for example, \"WadExample\") and select a region or affinity group.\n5.  Set the **Environment** to **Staging**.\n6.  Modify any other **Settings** as appropriate and click **Publish**.\n7.  After deployment has completed verify in the Azure Portal that your cloud service is in a **Running** state.\n\n### Step 4: Create your Diagnostics configuration file and install the extension\n1.  Download the public configuration file schema definition by executing the following PowerShell command:\n2.  \n        (Get-AzureServiceAvailableExtension -ExtensionName 'PaaSDiagnostics' -ProviderNamespace 'Microsoft.Azure.Diagnostics').PublicConfigurationSchema | Out-File -Encoding utf8 -FilePath 'WadConfig.xsd' \n\n2.  Add an XML file to your **WorkerRole1** project by right-clicking on the **WorkerRole1** project and select **Add** -> **New Item…** -> **Visual C# items** -> **Data** -> **XML File**. Name the file \"WadExample.xml\".\n\n    ![CloudServices_diag_add_xml](./media/cloud-services-dotnet-diagnostics/AddXmlFile.png)\n\n3.  Associate the WadConfig.xsd with the configuration file. Make sure the WadExample.xml editor window is the active window. Press **F4** to open the **Properties** window. Click on the **Schemas** property in the **Properties** window. Click the **…** in the **Schemas** property. Click the **Add…** button and navigate to the location where you saved the XSD file and select the file WadConfig.xsd. Click **OK**.\n4.  Replace the contents of the WadExample.xml configuration file with the following XML and save the file. This configuration file defines a couple performance counters to collect: one for CPU utilization and one for memory utilization. Then the configuration defines the four events corresponding to the methods in the SampleEventSourceWriter class.\n\n```\n        <?xml version=\"1.0\" encoding=\"utf-8\"?>\n        <PublicConfig xmlns=\"http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration\">\n            <WadCfg>\n                <DiagnosticMonitorConfiguration overallQuotaInMB=\"25000\">\n                <PerformanceCounters scheduledTransferPeriod=\"PT1M\">\n                    <PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Processor Time\" sampleRate=\"PT1M\" unit=\"percent\" />\n                    <PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Committed Bytes\" sampleRate=\"PT1M\" unit=\"bytes\"/>\n                    </PerformanceCounters>\n                    <EtwProviders>\n                        <EtwEventSourceProviderConfiguration provider=\"SampleEventSourceWriter\" scheduledTransferPeriod=\"PT5M\">\n                            <Event id=\"1\" eventDestination=\"EnumsTable\"/>\n                            <Event id=\"2\" eventDestination=\"MessageTable\"/>\n                            <Event id=\"3\" eventDestination=\"SetOtherTable\"/>\n                            <Event id=\"4\" eventDestination=\"HighFreqTable\"/>\n                            <DefaultEvents eventDestination=\"DefaultTable\" />\n                        </EtwEventSourceProviderConfiguration>\n                    </EtwProviders>\n                </DiagnosticMonitorConfiguration>\n            </WadCfg>\n        </PublicConfig>\n```\n\n### Step 5: Install Diagnostics on your Worker Role\nThe PowerShell cmdlets for managing Diagnostics on a web or worker role are: Set-AzureServiceDiagnosticsExtension, Get-AzureServiceDiagnosticsExtension, and Remove-AzureServiceDiagnosticsExtension.\n\n1.  Open Azure PowerShell.\n2.  Execute the script to install Diagnostics on your worker role (replace *StorageAccountKey* with the storage account key for your wadexample storage account):\n\n        $storage_name = \"wadexample\"\n        $key = \"<StorageAccountKey>\"\n        $config_path=\"c:\\users\\<user>\\documents\\visual studio 2013\\Projects\\WadExample\\WorkerRole1\\WadExample.xml\"\n        $service_name=\"wadexample\"\n        $storageContext = New-AzureStorageContext -StorageAccountName $storage_name -StorageAccountKey $key \n        Set-AzureServiceDiagnosticsExtension -StorageContext $storageContext -DiagnosticsConfigurationPath $config_path -ServiceName $service_name -Slot Staging -Role WorkerRole1\n\n\n### Step 6: Look at your telemetry data\nIn the Visual Studio **Server Explorer** navigate to the wadexample storage account. After the cloud service has been running about 5 minutes you should see the tables **WADEnumsTable**, **WADHighFreqTable**, **WADMessageTable**, **WADPerformanceCountersTable** and **WADSetOtherTable**. Double-click on one of the tables to view the telemetry that has been collected.\n    ![CloudServices_diag_tables](./media/cloud-services-dotnet-diagnostics/WadExampleTables.png)\n\n## How to Enable Diagnostics in a Virtual Machine\n\nThis walk through describes how to remotely install Diagnostics to an Azure virtual machine from a development computer. You also learn how to implement an application that runs on that Azure virtual machine and emits telemetry data using the .NET [EventSource Class][]. Azure Diagnostics is used to collect the telemetry and store it in an Azure storage account.\n\n### Pre-requisites\nThis walk through assumes you have an Azure subscription and are using Visual Studio 2013 with the Azure SDK. If you do not have an Azure subscription, you can sign up for the [Free Trial][]. Make sure to [Install and configure Azure PowerShell version 0.8.7 or later][].\n\n### Step 1: Create a Virtual Machine\n1.  On your development computer, launch Visual Studio 2013.\n2.  In the Visual Studio **Server Explorer** expand **Azure**, right-click **Virtual Machines** then select **Create Virtual Machine**.\n3.  Select your Azure subscription in the **Choose a Subscription** dialog and click **Next**.\n4.  Select **Windows Server 2012 R2 Datacenter, November 2014** in the **Select a Virtual Machine Image** dialog and click **Next**.\n5.  In the **Virtual Machine Basic Settings**, set the virtual machine name to \"wadexample\". Set your Administrator user name and password and click **Next**.\n6.  In the **Cloud Service Settings** dialog create a new cloud service named \"wadexampleVM\". Create a new Storage account named \"wadexample\" and click **Next**.\n7.  Click **Create**.\n\n### Step 2: Create your Application\n1.  On your development computer, launch Visual Studio 2013.\n2.  Create a new Visual C# Console Application that targets .NET Framework 4.5. Name the project \"WadExampleVM\".\n    ![CloudServices_diag_new_project](./media/cloud-services-dotnet-diagnostics/NewProject.png)\n3.  Replace the contents of Program.cs with the following code. The class **SampleEventSourceWriter** implements four logging methods: **SendEnums**, **MessageMethod**, **SetOther** and **HighFreq**. The first parameter to the WriteEvent method defines the ID for the respective event. The Run method implements an infinite loop that calls each of the logging methods implemented in the **SampleEventSourceWriter** class every 10 seconds.\n\n        using System;\n        using System.Diagnostics;\n        using System.Diagnostics.Tracing;\n        using System.Threading;\n\n        namespace WadExampleVM\n        {\n        sealed class SampleEventSourceWriter : EventSource\n        {\n            public static SampleEventSourceWriter Log = new SampleEventSourceWriter();\n            public void SendEnums(MyColor color, MyFlags flags) { if (IsEnabled())  WriteEvent(1, (int)color, (int)flags); }// Cast enums to int for efficient logging.\n            public void MessageMethod(string Message) { if (IsEnabled())  WriteEvent(2, Message); }\n            public void SetOther(bool flag, int myInt) { if (IsEnabled())  WriteEvent(3, flag, myInt); }\n            public void HighFreq(int value) { if (IsEnabled()) WriteEvent(4, value); }\n\n        }\n\n        enum MyColor\n        {\n            Red,\n            Blue,\n            Green\n        }\n\n        [Flags]\n        enum MyFlags\n        {\n            Flag1 = 1,\n            Flag2 = 2,\n            Flag3 = 4\n        }\n\n        class Program\n        {\n        static void Main(string[] args)\n        {\n            Trace.TraceInformation(\"My application entry point called\");\n            \n            int value = 0;\n\n            while (true)\n            {\n                Thread.Sleep(10000);\n                Trace.TraceInformation(\"Working\");\n\n                // Emit several events every time we go through the loop\n                for (int i = 0; i < 6; i++)\n                {\n                    SampleEventSourceWriter.Log.SendEnums(MyColor.Blue, MyFlags.Flag2 | MyFlags.Flag3);\n                }\n\n                for (int i = 0; i < 3; i++)\n                {\n                    SampleEventSourceWriter.Log.MessageMethod(\"This is a message.\");\n                    SampleEventSourceWriter.Log.SetOther(true, 123456789);\n                }\n\n                if (value == int.MaxValue) value = 0;\n                SampleEventSourceWriter.Log.HighFreq(value++);\n            }\n\n        }\n        }\n        }\n\n\n4.  Save the file and select **Build Solution** from the **Build** menu to build your code.\n\n\n### Step 3: Deploy your Application\n1.  Right-click on the **WadExampleVM** project in **Solution Explorer** and choose **Open Folder in File Explorer**.\n2.  Navigate to the *bin\\Debug* folder and copy all the files (WadExampleVM.*)\n3.  In **Server Explorer** right-click on the virtual machine and choose **Connect using Remote Desktop**.\n4.  Once connected to the VM create a folder named WadExampleVM and paste your application files into the folder.\n5.  Launch the application WadExampleVM.exe. You should see a blank console window.\n\n### Step 4: Create your Diagnostics configuration and install the Extension\n1.  Download the public configuration file schema definition to your development computer by executing the following PowerShell command:\n\n        (Get-AzureServiceAvailableExtension -ExtensionName 'PaaSDiagnostics' -ProviderNamespace 'Microsoft.Azure.Diagnostics').PublicConfigurationSchema | Out-File -Encoding utf8 -FilePath 'WadConfig.xsd' \n\n2.  Open a new XML file in Visual Studio, either in a project you already have open or in a Visual Studio instance with no open projects. In Visual Studio, select **Add** -> **New Item…** -> **Visual C# items** -> **Data** -> **XML File**. Name the file \"WadExample.xml\"\n3.  Associate the WadConfig.xsd with the configuration file. Make sure the WadExample.xml editor window is the active window. Press **F4** to open the **Properties** window. Click on the **Schemas** property in the **Properties** window. Click the **…** in the **Schemas** property. Click the **Add…** button and navigate to the location where you saved the XSD file and select the file WadConfig.xsd. Click **OK**.\n4.  Replace the contents of the WadExample.xml configuration file with the following XML and save the file. This configuration file defines a couple performance counters to collect: one for CPU utilization and one for memory utilization. Then the configuration defines the four events corresponding to the methods in the SampleEventSourceWriter class.\n\n```\n        <?xml version=\"1.0\" encoding=\"utf-8\"?>\n        <PublicConfig xmlns=\"http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration\">\n            <WadCfg>\n                <DiagnosticMonitorConfiguration overallQuotaInMB=\"25000\">\n                <PerformanceCounters scheduledTransferPeriod=\"PT1M\">\n                    <PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Processor Time\" sampleRate=\"PT1M\" unit=\"percent\" />\n                    <PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Committed Bytes\" sampleRate=\"PT1M\" unit=\"bytes\"/>\n                    </PerformanceCounters>\n                    <EtwProviders>\n                        <EtwEventSourceProviderConfiguration provider=\"SampleEventSourceWriter\" scheduledTransferPeriod=\"PT5M\">\n                            <Event id=\"1\" eventDestination=\"EnumsTable\"/>\n                            <Event id=\"2\" eventDestination=\"MessageTable\"/>\n                            <Event id=\"3\" eventDestination=\"SetOtherTable\"/>\n                            <Event id=\"4\" eventDestination=\"HighFreqTable\"/>\n                            <DefaultEvents eventDestination=\"DefaultTable\" />\n                        </EtwEventSourceProviderConfiguration>\n                    </EtwProviders>\n                </DiagnosticMonitorConfiguration>\n            </WadCfg>\n        </PublicConfig>\n```\n\n### Step 5: Remotely install Diagnostics on your Azure Virtual Machine\nThe PowerShell cmdlets for managing Diagnostics on a VM are: Set-AzureVMDiagnosticsExtension, Get-AzureVMDiagnosticsExtension, and Remove-AzureVMDiagnosticsExtension.\n\n1.  On your developer computer, open Azure PowerShell.\n2.  Execute the script to remotely install Diagnostics on your VM (Replace *StorageAccountKey* with the storage account key for your wadexamplevm storage account):\n\n        $storage_name = \"wadexamplevm\"\n        $key = \"<StorageAccountKey>\"\n        $config_path=\"c:\\users\\<user>\\documents\\visual studio 2013\\Projects\\WadExampleVM\\WadExampleVM\\WadExample.xml\"\n        $service_name=\"wadexamplevm\"\n        $vm_name=\"WadExample\"\n        $storageContext = New-AzureStorageContext -StorageAccountName $storage_name -StorageAccountKey $key \n        $VM1 = Get-AzureVM -ServiceName $service_name -Name $vm_name\n        $VM2 = Set-AzureVMDiagnosticsExtension -DiagnosticsConfigurationPath $config_path -Version \"1.*\" -VM $VM1 -StorageContext $storageContext\n        $VM3 = Update-AzureVM -ServiceName $service_name -Name $vm_name -VM $VM2.VM\n\n\n### Step 6: Look at your telemetry data\nIn the Visual Studio **Server Explorer** navigate to the wadexample storage account. After the VM has been running about 5 minutes you should see the tables **WADEnumsTable**, **WADHighFreqTable**, **WADMessageTable**, **WADPerformanceCountersTable** and **WADSetOtherTable**. Double-click on one of the tables to view the telemetry that has been collected.\n    ![CloudServices_diag_wadexamplevm_tables](./media/cloud-services-dotnet-diagnostics/WadExampleVMTables.png)\n\n## Configuration File Schema\n\nThe Diagnostics configuration file defines values that are used to initialize diagnostic configuration settings when the diagnostics monitor starts. A sample configuration file and detailed documentation on its schema is located here: [Azure Diagnostics 1.2 Configuration Schema][].\n\n## Troubleshooting\n\n### Azure Diagnostics is not Starting\nDiagnostics is comprised of two components: A guest agent plugin and the monitoring agent. Log files for the guest agent plugin are located in the file: \n\n*%SystemDrive%\\ WindowsAzure\\Logs\\Plugins\\Microsoft.Azure.Diagnostics.PaaSDiagnostics\\<DiagnosticsVersion>*\\CommandExecution.log\n\nThe following error codes are returned by the plugin:\n\nExit Code|Description\n---|---\n0|Success.\n-1|Generic Error.\n-2|Unable to load the rcf file.<p>This is an internal error that should only happen if the guest agent plugin launcher is manually invoked, incorrectly, on the VM.\n-3|Cannot load the Diagnostics configuration file.<p><p>Solution: This is the result of a configuration file not passing schema validation. The solution is to provide a configuration file that complies with the schema.\n-4|Another instance of the monitoring agent Diagnostics is already using the local resource directory.<p><p>Solution: Specify a different value for **LocalResourceDirectory**.\n-6|The guest agent plugin launcher attempted to launch Diagnostics with an invalid command line.<p><p>This is an internal error that should only happen if the guest agent plugin launcher is manually invoked, incorrectly, on the VM.\n-10|The Diagnostics plugin exited with an unhandled exception.\n-11|The guest agent was unable to create the process responsible for launching and monitoring the monitoring agent.<p><p>Solution: Verify that sufficient system resources are available to launch new processes.<p>\n-101|Invalid arguments when calling the Diagnostics plugin.<p><p>This is an internal error that should only happen if the guest agent plugin launcher is manually invoked, incorrectly, on the VM.\n-102|The plugin process is unable to initialize itself.<p><p>Solution: Verify that sufficient system resources are available to launch new processes.\n-103|The plugin process is unable to initialize itself. Specifically it is unable to create the logger object.<p><p>Solution: Verify that sufficient system resources are available to launch new processes.\n-104|Unable to load the rcf file provided by the guest agent.<p><p>This is an internal error that should only happen if the guest agent plugin launcher is manually invoked, incorrectly, on the VM.\n-105|The Diagnostics plugin cannot open the Diagnostics configuration file.<p><p>This is an internal error that should only happen if the Diagnostics plugin is manually invoked, incorrectly, on the VM.\n-106|Cannot read the Diagnostics configuration file.<p><p>Solution: This is the result of a configuration file not passing schema validation. So the solution is to provide a configuration file that complies with the schema. You can find the XML that is delivered to the Diagnostics extension in the folder *%SystemDrive%\\WindowsAzure\\Config* on the VM. Open the appropriate XML file and search for **Microsoft.Azure.Diagnostics**, then for the **xmlCfg** field. The data is base64 encoded so you’ll need to [decode it](http://www.bing.com/search?q=base64+decoder) to see the XML that was loaded by Diagnostics.<p>\n-107|The resource directory pass to the monitoring agent is invalid.<p><p>This is an internal error that should only happen if the monitoring agent is manually invoked, incorrectly, on the VM.</p>\n-108    |Unable to convert the Diagnostics configuration file into the monitoring agent configuration file.<p><p>This is an internal error that should only happen if the Diagnostics plugin is manually invoked with an invalid configuration file.\n-110|General Diagnostics configuration error.<p><p>This is an internal error that should only happen if the Diagnostics plugin is manually invoked with an invalid configuration file.\n-111|Unable to start the monitoring agent.<p><p>Solution: Verify that sufficient system resources are available.\n-112|General error\n\n\n### Diagnostics Data is Not Logged to Storage\nThe most common cause of missing event data is incorrectly defined storage account information. \n\nSolution: Correct your Diagnostics configuration file and re-install Diagnostics.\nBefore event data is uploaded to your storage account it is stored in the folder. See above for details on **LocalResourceDirectory**.\n\nIf there are no files in this folder the monitoring agent is unable to launch. This is typically caused by an invalid configuration file and should have been reported in the CommandExecution.log. If the Monitoring Agent is successfully collecting event data you will see .tsf files for each event defined in your configuration file.\n\nThe Monitoring Agent logs any errors it experiences in the file MaEventTable.tsf. To inspect the contents of this file run the following command:\n\n        %SystemDrive%\\Packages\\Plugins\\Microsoft.Azure.Diagnostics.[IaaS | PaaS]Diagnostics\\1.3.0.0\\Monitor\\x64\\table2csv maeventtable.tsf\n\nThe tool generates a file named maeventtable.csv that you may open and inspect the logs for failures.\n\n\n## Frequently Asked Questions\nThe following are some frequently asked questions and their answers:\n\n**Q.** How do I upgrade my Visual Studio solution from Azure Diagnostics 1.0 to Azure Diagnostics 1.1?\n\n**A.** Upgrading your Visual Studio solution from Diagnostics 1.0 to Diagnostics 1.1 (or later) is a manual process:\n- Disable Diagnostics in your Visual Studio solution to prevent Diagnostics 1.0 from being deployed with your role\n- If your code uses Trace Listener you will need to modify your code to use .NET EventSource. Diagnostics 1.1 and later does not support Trace Listener.\n- Modify your deployment process to install the Diagnostics 1.1 extension\n\n**Q.** If I have already installed the Diagnostics 1.1 Extension on my role or VM how do I upgrade to Diagnostics 1.2 or 1.3?\n\n**A.** If you specified “–Version “1.*”\" when you installed Diagnostics 1.1, the next time your role restarts or the VM reboots it will be automatically updated to the most recent version matching the regular expression “1.*” If “–Version “1.1”” when you installed Diagnostics 1.1 you can update a newer version be re-executing the Set- cmdlet and specifying the version you want to install.\n\n**Q.** How are tables named?\n\n**A.** Tables are named according to the following:\n\n        if (String.IsNullOrEmpty(eventDestination)) {\n            if (e == \"DefaultEvents\")\n                tableName = \"WADDefault\" + MD5(provider);\n            else\n                tableName = \"WADEvent\" + MD5(provider) + eventId;\n        }\n        else\n            tableName = \"WAD\" + eventDestination;\n\nHere is an example:\n\n        <EtwEventSourceProviderConfiguration provider=”prov1”>\n          <Event id=”1” />\n          <Event id=”2” eventDestination=”dest1” />\n          <DefaultEvents />\n        </EtwEventSourceProviderConfiguration>\n        <EtwEventSourceProviderConfiguration provider=”prov2”>\n          <DefaultEvents eventDestination=”dest2” />\n        </EtwEventSourceProviderConfiguration>\n\nThat will generate 4 tables:\n\nEvent|Table Name\n---|---\nprovider=”prov1” &lt;Event id=”1” /&gt;|WADEvent+MD5(“prov1”)+”1”\nprovider=”prov1” &lt;Event id=”2” eventDestination=”dest1” /&gt;|WADdest1\nprovider=”prov1” &lt;DefaultEvents /&gt;|WADDefault+MD5(“prov1”)\nprovider=”prov2” &lt;DefaultEvents eventDestination=”dest2” /&gt;|WADdest2\n\n## Comparing Azure Diagnostics Versions\n\nThe following table compare the features supported by Azure Diagnostics versions 1.0 and 1.1/1.2/1.3:\n\nRole Types Supported|Diagnostics 1.0|Diagnostics 1.1/1.2/1.3\n---|---\nWeb role|Yes|Yes\nWorker role|Yes|Yes\nIaaS|No|Yes\n\nConfiguration and deployment|Diagnostics 1.0|Diagnostics 1.1/1.2/1.3\n---|---|---\nIntegration with Visual Studio- Integrated into the Azure web/worker development experience.|Yes|No\nPowerShell Scripts- Scripts to manage the installation and configuration of Diagnostics on the role.|Yes|Yes\n\nData Source|Default Collection|Format|Description|Diagnostics 1.0|Diagnostics 1.1/1.2|Diagnostics 1.3\n---|---|---|---|---|---|---\nSystem.Diagnostics.Trace Logs|Yes|Table|Logs trace messages sent from your code to the trace listener (a trace listener must be added to the web.config or app.config file). Log data will be transferred at the scheduledTransferPeriod transfer interval to storage table WADLogsTable.|Yes|No (Use EventSource)|Yes\nIIS logs|Yes|Blob|Logs information about IIS sites. Log data will be transferred at the scheduledTransferPeriod transfer interval to the container you specify.|Yes|Yes|Yes\nAzure Diagnostic infrastructure logs|Yes|Table|Logs information about the diagnostic infrastructure, the RemoteAccess module, and the RemoteForwarder module. Log data will transferred at the scheduledTransferPeriodtransfer interval to storage table WADDiagnosticInfrastructureLogsTable.|Yes|Yes|Yes\nIIS Failed Request logs|No|Blob|Logs information about failed requests to an IIS site or application. You must also enable by setting tracing options under system.WebServer in Web.config. Log data will be transferred at the scheduledTransferPeriod transfer interval to the container you specify.|Yes|Yes|Yes\nWindows Event logs|No|Table|Logs information about how well the operating system, application, or driver is performing. Performance counters must be specified explicitly. When these are added, performance counter data will be transferred at the scheduledTransferPeriod transfer interval to storage table WADPerformanceCountersTable.|Yes|Yes|Yes\nPerformance counters|No|Table|Logs information about how well the operating system, application, or driver is performing. Performance counters must be specified explicitly. When these are added, performance counter data will be transferred at the scheduledTransferPeriod transfer interval to storage table WADPerformanceCountersTable.|Yes|Yes|Yes\nCrash dumps|No|Blob|Logs information about the state of the operating system in the event of a system crash. Mini crash dumps are collected locally. Full dumps can be enabled. Log data will be transferred at the scheduledTransferPeriod transfer interval to the container you specify. Because ASP.NET handles most exceptions, this is generally useful only for a worker role or a VM.|Yes|Yes|Yes\nCustom error logs|No|Blob|By using local storage resources, custom data can be logged and transferred immediately to the container you specify.|Yes|Yes|Yes\nEventSource|No|Table|Logs events generated by your code using the .NET EventSource class.|No|Yes|Yes\nManifest based ETW|No|Table|ETW events generated by any process.|No|Yes|Yes\n\n\n## Additional Resources\n\n- [Troubleshooting Best Practices for Developing Azure Applications][]\n- [Collect Logging Data by Using Azure Diagnostics][]\n- [Debugging an Azure Application][]\n- [Configuring Diagnostics for Azure Cloud Services and Virtual Machines][]\n\n  \n\n[Overview]: #overview\n[How to Enable Diagnostics in a Worker Role]: #worker-role\n[How to Enable Diagnostics in a Virtual Machine]: #virtual-machine\n[Sample Configuration File and Schema]: #configuration-file-schema\n[Troubleshooting]: #troubleshooting\n[Frequently Asked Questions]: #faq\n[Comparing Azure Diagnostics Versions]: #comparing\n[Additional Resources]: #additional\n[EventSource Class]: http://msdn.microsoft.com/library/system.diagnostics.tracing.eventsource(v=vs.110).aspx\n  \n[Configuring Diagnostics for Azure Cloud Services and Virtual Machines]: http://msdn.microsoft.com/library/windowsazure/dn186185.aspx\n[Debugging an Azure Application]: http://msdn.microsoft.com/library/windowsazure/ee405479.aspx   \n[Collect Logging Data by Using Azure Diagnostics]: http://msdn.microsoft.com/library/windowsazure/gg433048.aspx\n[Troubleshooting Best Practices for Developing Azure Applications]: http://msdn.microsoft.com/library/windowsazure/hh771389.aspx\n[Free Trial]: http://azure.microsoft.com/pricing/free-trial/\n[Install and configure Azure PowerShell version 0.8.7 or later]: http://azure.microsoft.com/documentation/articles/install-configure-powershell/\n[Azure Diagnostics 1.2 Configuration Schema]: http://msdn.microsoft.com/library/azure/dn782207.aspx\n[Set-AzureServiceDiagnosticsExtension]: http://msdn.microsoft.com/library/dn495270.aspx\n[Get-AzureServiceDiagnosticsExtension]: http://msdn.microsoft.com/library/dn495145.aspx\n[Remove-AzureServiceDiagnosticsExtension]: http://msdn.microsoft.com/library/dn495168.aspx\n \n\ntest\n"
}