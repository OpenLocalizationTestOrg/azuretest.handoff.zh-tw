{
  "nodes": [
    {
      "content": "Azure Stream Analytics Query Patterns | Microsoft Azure",
      "pos": [
        27,
        82
      ]
    },
    {
      "content": "Common Azure Stream Analytics Query Patterns",
      "pos": [
        101,
        145
      ]
    },
    {
      "content": "Common Azure Stream Analytics Query Patterns",
      "pos": [
        545,
        589
      ]
    },
    {
      "content": "Introduction",
      "pos": [
        597,
        609
      ]
    },
    {
      "content": "Queries in Azure Stream Analytics are expressed in a SQL-like query language, which is documented <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/dn834998.aspx)</ept>.",
      "pos": [
        613,
        774
      ]
    },
    {
      "content": "This document outlines solutions to several common query patterns based on real world scenarios.",
      "pos": [
        776,
        872
      ]
    },
    {
      "content": "It is a work in progress and will continue to be updated with new patterns on an ongoing basis.",
      "pos": [
        874,
        969
      ]
    },
    {
      "content": "Basics",
      "pos": [
        974,
        980
      ]
    },
    {
      "content": "Data type conversions",
      "pos": [
        988,
        1009
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Description<ept id=\"p1\">**</ept>: Define the types of the properties on the input stream.",
      "pos": [
        1013,
        1085
      ]
    },
    {
      "content": "e.g. Car weight is coming on the input stream as strings and needs to be converted to INT to perform SUM it up.",
      "pos": [
        1086,
        1197
      ]
    },
    {
      "pos": [
        1199,
        1209
      ],
      "content": "<bpt id=\"p1\">**</bpt>Input<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        1213,
        1217
      ]
    },
    {
      "content": "Time",
      "pos": [
        1220,
        1224
      ]
    },
    {
      "content": "Weight",
      "pos": [
        1227,
        1233
      ]
    },
    {
      "content": "Honda",
      "pos": [
        1258,
        1263
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        1266,
        1294
      ]
    },
    {
      "content": "\"1000\"",
      "pos": [
        1297,
        1303
      ]
    },
    {
      "content": "Honda",
      "pos": [
        1308,
        1313
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        1316,
        1344
      ]
    },
    {
      "content": "\"2000\"",
      "pos": [
        1347,
        1353
      ]
    },
    {
      "pos": [
        1357,
        1368
      ],
      "content": "<bpt id=\"p1\">**</bpt>Output<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        1372,
        1376
      ]
    },
    {
      "content": "Weight",
      "pos": [
        1379,
        1385
      ]
    },
    {
      "content": "Honda",
      "pos": [
        1404,
        1409
      ]
    },
    {
      "content": "3000",
      "pos": [
        1412,
        1416
      ]
    },
    {
      "pos": [
        1420,
        1433
      ],
      "content": "<bpt id=\"p1\">**</bpt>Solution<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Explanation<ept id=\"p1\">**</ept>:",
      "pos": [
        1610,
        1626
      ]
    },
    {
      "content": "Use a CAST statement on the Weight field to specify its type (see the list of supported Data Types <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/dn835065.aspx)</ept>).",
      "pos": [
        1627,
        1790
      ]
    },
    {
      "content": "Using Like/Not like to do pattern matching",
      "pos": [
        1795,
        1837
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Description<ept id=\"p1\">**</ept>: Check that a field value on the event matches a certain pattern",
      "pos": [
        1841,
        1921
      ]
    },
    {
      "content": "e.g. Return license plates that start with A and end with 9",
      "pos": [
        1922,
        1981
      ]
    },
    {
      "pos": [
        1983,
        1993
      ],
      "content": "<bpt id=\"p1\">**</bpt>Input<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        1997,
        2001
      ]
    },
    {
      "content": "LicensePlate",
      "pos": [
        2004,
        2016
      ]
    },
    {
      "content": "Time",
      "pos": [
        2019,
        2023
      ]
    },
    {
      "content": "Honda",
      "pos": [
        2048,
        2053
      ]
    },
    {
      "content": "ABC-123",
      "pos": [
        2056,
        2063
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        2066,
        2094
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        2099,
        2105
      ]
    },
    {
      "content": "AAA-999",
      "pos": [
        2108,
        2115
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        2118,
        2146
      ]
    },
    {
      "content": "Nissan",
      "pos": [
        2151,
        2157
      ]
    },
    {
      "content": "ABC-369",
      "pos": [
        2160,
        2167
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        2170,
        2198
      ]
    },
    {
      "pos": [
        2202,
        2213
      ],
      "content": "<bpt id=\"p1\">**</bpt>Output<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        2217,
        2221
      ]
    },
    {
      "content": "LicensePlate",
      "pos": [
        2224,
        2236
      ]
    },
    {
      "content": "Time",
      "pos": [
        2239,
        2243
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        2268,
        2274
      ]
    },
    {
      "content": "AAA-999",
      "pos": [
        2277,
        2284
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        2287,
        2315
      ]
    },
    {
      "content": "Nissan",
      "pos": [
        2320,
        2326
      ]
    },
    {
      "content": "ABC-369",
      "pos": [
        2329,
        2336
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        2339,
        2367
      ]
    },
    {
      "pos": [
        2371,
        2384
      ],
      "content": "<bpt id=\"p1\">**</bpt>Solution<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Explanation<ept id=\"p1\">**</ept>:",
      "pos": [
        2491,
        2507
      ]
    },
    {
      "content": "Use the LIKE statement to check that the LicensePlate field value starts with A then has any string of zero or more characters and it ends with 9.",
      "pos": [
        2508,
        2654
      ]
    },
    {
      "content": "Specify logic for different cases/values (CASE statements)",
      "pos": [
        2660,
        2718
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Description<ept id=\"p1\">**</ept>: Provide different computation for a field based on some criteria.",
      "pos": [
        2722,
        2804
      ]
    },
    {
      "content": "e.g. Provide a string description for how many cars passed of the same make with a special case for 1.",
      "pos": [
        2805,
        2907
      ]
    },
    {
      "pos": [
        2909,
        2919
      ],
      "content": "<bpt id=\"p1\">**</bpt>Input<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        2923,
        2927
      ]
    },
    {
      "content": "Time",
      "pos": [
        2930,
        2934
      ]
    },
    {
      "content": "Honda",
      "pos": [
        2953,
        2958
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        2961,
        2989
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        2994,
        3000
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        3003,
        3031
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        3036,
        3042
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        3045,
        3073
      ]
    },
    {
      "pos": [
        3077,
        3088
      ],
      "content": "<bpt id=\"p1\">**</bpt>Output<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "| CarsPassed | Time |",
      "pos": [
        3090,
        3111
      ]
    },
    {
      "content": "| --- | --- | --- |",
      "pos": [
        3112,
        3131
      ]
    },
    {
      "content": "| 1 Honda | 2015-01-01T00:00:10.0000000Z |",
      "pos": [
        3132,
        3174
      ]
    },
    {
      "content": "| 2 Toyotas | 2015-01-01T00:00:10.0000000Z |",
      "pos": [
        3175,
        3219
      ]
    },
    {
      "pos": [
        3221,
        3234
      ],
      "content": "<bpt id=\"p1\">**</bpt>Solution<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Explanation<ept id=\"p1\">**</ept>:",
      "pos": [
        3551,
        3567
      ]
    },
    {
      "content": "The CASE clause allows us to provide a different computation based on some criteria (in our case the count of cars in the aggregate window).",
      "pos": [
        3568,
        3708
      ]
    },
    {
      "content": "Send data to multiple outputs",
      "pos": [
        3713,
        3742
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Description<ept id=\"p1\">**</ept>: Send data to multiple output targets from a single job.",
      "pos": [
        3746,
        3818
      ]
    },
    {
      "content": "e.g. Analyze data for a threshold-based alert and archive all events to blob storage",
      "pos": [
        3819,
        3903
      ]
    },
    {
      "pos": [
        3905,
        3915
      ],
      "content": "<bpt id=\"p1\">**</bpt>Input<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        3919,
        3923
      ]
    },
    {
      "content": "Time",
      "pos": [
        3926,
        3930
      ]
    },
    {
      "content": "Honda",
      "pos": [
        3949,
        3954
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        3957,
        3985
      ]
    },
    {
      "content": "Honda",
      "pos": [
        3990,
        3995
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        3998,
        4026
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        4031,
        4037
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        4040,
        4068
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        4073,
        4079
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        4082,
        4110
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        4115,
        4121
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        4124,
        4152
      ]
    },
    {
      "pos": [
        4156,
        4168
      ],
      "content": "<bpt id=\"p1\">**</bpt>Output1<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        4172,
        4176
      ]
    },
    {
      "content": "Time",
      "pos": [
        4179,
        4183
      ]
    },
    {
      "content": "Honda",
      "pos": [
        4202,
        4207
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        4210,
        4238
      ]
    },
    {
      "content": "Honda",
      "pos": [
        4243,
        4248
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        4251,
        4279
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        4284,
        4290
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        4293,
        4321
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        4326,
        4332
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        4335,
        4363
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        4368,
        4374
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        4377,
        4405
      ]
    },
    {
      "pos": [
        4409,
        4421
      ],
      "content": "<bpt id=\"p1\">**</bpt>Output2<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        4425,
        4429
      ]
    },
    {
      "content": "Time",
      "pos": [
        4432,
        4436
      ]
    },
    {
      "content": "Count",
      "pos": [
        4439,
        4444
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        4469,
        4475
      ]
    },
    {
      "content": "2015-01-01T00:00:10.0000000Z",
      "pos": [
        4478,
        4506
      ]
    },
    {
      "content": "3",
      "pos": [
        4509,
        4510
      ]
    },
    {
      "pos": [
        4514,
        4527
      ],
      "content": "<bpt id=\"p1\">**</bpt>Solution<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Explanation<ept id=\"p1\">**</ept>:",
      "pos": [
        4875,
        4891
      ]
    },
    {
      "content": "The INTO clause tells Stream Analytics which of the outputs to write the data from this statement.",
      "pos": [
        4892,
        4990
      ]
    },
    {
      "content": "The first query is a pass-through of the data we received to an output that we named ArchiveOutput.",
      "pos": [
        4991,
        5090
      ]
    },
    {
      "content": "The second query does some simple aggregation and filtering and sends the results to a downstream alerting system.",
      "pos": [
        5091,
        5205
      ]
    },
    {
      "content": "<bpt id=\"p1\">*</bpt>Note<ept id=\"p1\">*</ept>: You can also reuse results of CTEs (i.e. WITH statements) in multiple output statements – this has the added benefit of opening less readers to the input source.",
      "pos": [
        5206,
        5375
      ]
    },
    {
      "content": "e.g.",
      "pos": [
        5376,
        5380
      ]
    },
    {
      "content": "Patterns",
      "pos": [
        5672,
        5680
      ]
    },
    {
      "content": "Counting unique values",
      "pos": [
        5688,
        5710
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Description<ept id=\"p1\">**</ept>: count the number of unique field values that appear in the stream within a time window.",
      "pos": [
        5711,
        5815
      ]
    },
    {
      "content": "e.g. How many unique make of cars passed through the toll booth in a 2 second window?",
      "pos": [
        5816,
        5901
      ]
    },
    {
      "pos": [
        5903,
        5913
      ],
      "content": "<bpt id=\"p1\">**</bpt>Input<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        5917,
        5921
      ]
    },
    {
      "content": "Time",
      "pos": [
        5924,
        5928
      ]
    },
    {
      "content": "Honda",
      "pos": [
        5947,
        5952
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        5955,
        5983
      ]
    },
    {
      "content": "Honda",
      "pos": [
        5988,
        5993
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        5996,
        6024
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        6029,
        6035
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        6038,
        6066
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        6071,
        6077
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        6080,
        6108
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        6113,
        6119
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        6122,
        6150
      ]
    },
    {
      "content": "Output:",
      "pos": [
        6156,
        6163
      ]
    },
    {
      "content": "Count",
      "pos": [
        6169,
        6174
      ]
    },
    {
      "content": "Time",
      "pos": [
        6177,
        6181
      ]
    },
    {
      "content": "2",
      "pos": [
        6200,
        6201
      ]
    },
    {
      "content": "2015-01-01T00:00:02.000Z",
      "pos": [
        6204,
        6228
      ]
    },
    {
      "content": "1",
      "pos": [
        6233,
        6234
      ]
    },
    {
      "content": "2015-01-01T00:00:04.000Z",
      "pos": [
        6237,
        6261
      ]
    },
    {
      "content": "Solution:",
      "pos": [
        6267,
        6276
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Explanation:<ept id=\"p1\">**</ept>",
      "pos": [
        6642,
        6658
      ]
    },
    {
      "content": "We do an initial aggregation to get unique makes with their count over the window.",
      "pos": [
        6659,
        6741
      ]
    },
    {
      "content": "We then do an aggregation of how many makes we got – given all unique values in a window get the same timestamp then the second aggregation window needs to be minimal to not aggregate 2 windows from the first step.",
      "pos": [
        6742,
        6956
      ]
    },
    {
      "content": "Determine if a value has changed",
      "pos": [
        6961,
        6993
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Description<ept id=\"p1\">**</ept>: Look at a previous value to determine if it is different than the current value",
      "pos": [
        6997,
        7093
      ]
    },
    {
      "content": "e.g. Is the previous car on the Toll Road the same make as the current car?",
      "pos": [
        7094,
        7169
      ]
    },
    {
      "pos": [
        7171,
        7181
      ],
      "content": "<bpt id=\"p1\">**</bpt>Input<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        7185,
        7189
      ]
    },
    {
      "content": "Time",
      "pos": [
        7192,
        7196
      ]
    },
    {
      "content": "Honda",
      "pos": [
        7215,
        7220
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        7223,
        7251
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        7256,
        7262
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        7265,
        7293
      ]
    },
    {
      "pos": [
        7297,
        7308
      ],
      "content": "<bpt id=\"p1\">**</bpt>Output<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        7312,
        7316
      ]
    },
    {
      "content": "Time",
      "pos": [
        7319,
        7323
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        7342,
        7348
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        7351,
        7379
      ]
    },
    {
      "pos": [
        7383,
        7396
      ],
      "content": "<bpt id=\"p1\">**</bpt>Solution<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Explanation<ept id=\"p1\">**</ept>:",
      "pos": [
        7550,
        7566
      ]
    },
    {
      "content": "Use LAG to peek into the input stream one event back and get the Make value.",
      "pos": [
        7567,
        7643
      ]
    },
    {
      "content": "Then compare it to the Make on the current event and output the event if they are different.",
      "pos": [
        7644,
        7736
      ]
    },
    {
      "content": "Find first event in a window",
      "pos": [
        7741,
        7769
      ]
    },
    {
      "pos": [
        7773,
        7833
      ],
      "content": "<bpt id=\"p1\">**</bpt>Description<ept id=\"p1\">**</ept>: Find first car in every 10 minute interval?"
    },
    {
      "pos": [
        7835,
        7845
      ],
      "content": "<bpt id=\"p1\">**</bpt>Input<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "LicensePlate",
      "pos": [
        7849,
        7861
      ]
    },
    {
      "content": "Make",
      "pos": [
        7864,
        7868
      ]
    },
    {
      "content": "Time",
      "pos": [
        7871,
        7875
      ]
    },
    {
      "content": "DXE 5291",
      "pos": [
        7900,
        7908
      ]
    },
    {
      "content": "Honda",
      "pos": [
        7911,
        7916
      ]
    },
    {
      "content": "2015-07-27T00:00:05.0000000Z",
      "pos": [
        7919,
        7947
      ]
    },
    {
      "content": "YZK 5704",
      "pos": [
        7952,
        7960
      ]
    },
    {
      "content": "Ford",
      "pos": [
        7963,
        7967
      ]
    },
    {
      "content": "2015-07-27T00:02:17.0000000Z",
      "pos": [
        7970,
        7998
      ]
    },
    {
      "content": "RMV 8282",
      "pos": [
        8003,
        8011
      ]
    },
    {
      "content": "Honda",
      "pos": [
        8014,
        8019
      ]
    },
    {
      "content": "2015-07-27T00:05:01.0000000Z",
      "pos": [
        8022,
        8050
      ]
    },
    {
      "content": "YHN 6970",
      "pos": [
        8055,
        8063
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        8066,
        8072
      ]
    },
    {
      "content": "2015-07-27T00:06:00.0000000Z",
      "pos": [
        8075,
        8103
      ]
    },
    {
      "content": "VFE 1616",
      "pos": [
        8108,
        8116
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        8119,
        8125
      ]
    },
    {
      "content": "2015-07-27T00:09:31.0000000Z",
      "pos": [
        8128,
        8156
      ]
    },
    {
      "content": "QYF 9358",
      "pos": [
        8161,
        8169
      ]
    },
    {
      "content": "Honda",
      "pos": [
        8172,
        8177
      ]
    },
    {
      "content": "2015-07-27T00:12:02.0000000Z",
      "pos": [
        8180,
        8208
      ]
    },
    {
      "content": "MDR 6128",
      "pos": [
        8213,
        8221
      ]
    },
    {
      "content": "BMW",
      "pos": [
        8224,
        8227
      ]
    },
    {
      "content": "2015-07-27T00:13:45.0000000Z",
      "pos": [
        8230,
        8258
      ]
    },
    {
      "pos": [
        8262,
        8273
      ],
      "content": "<bpt id=\"p1\">**</bpt>Output<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "LicensePlate",
      "pos": [
        8277,
        8289
      ]
    },
    {
      "content": "Make",
      "pos": [
        8292,
        8296
      ]
    },
    {
      "content": "Time",
      "pos": [
        8299,
        8303
      ]
    },
    {
      "content": "DXE 5291",
      "pos": [
        8328,
        8336
      ]
    },
    {
      "content": "Honda",
      "pos": [
        8339,
        8344
      ]
    },
    {
      "content": "2015-07-27T00:00:05.0000000Z",
      "pos": [
        8347,
        8375
      ]
    },
    {
      "content": "QYF 9358",
      "pos": [
        8380,
        8388
      ]
    },
    {
      "content": "Honda",
      "pos": [
        8391,
        8396
      ]
    },
    {
      "content": "2015-07-27T00:12:02.0000000Z",
      "pos": [
        8399,
        8427
      ]
    },
    {
      "pos": [
        8431,
        8444
      ],
      "content": "<bpt id=\"p1\">**</bpt>Solution<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Now let’s change the problem and find first car of particular Make in every 10 minute interval.",
      "pos": [
        8593,
        8688
      ]
    },
    {
      "content": "LicensePlate",
      "pos": [
        8692,
        8704
      ]
    },
    {
      "content": "Make",
      "pos": [
        8707,
        8711
      ]
    },
    {
      "content": "Time",
      "pos": [
        8714,
        8718
      ]
    },
    {
      "content": "DXE 5291",
      "pos": [
        8743,
        8751
      ]
    },
    {
      "content": "Honda",
      "pos": [
        8754,
        8759
      ]
    },
    {
      "content": "2015-07-27T00:00:05.0000000Z",
      "pos": [
        8762,
        8790
      ]
    },
    {
      "content": "YZK 5704",
      "pos": [
        8795,
        8803
      ]
    },
    {
      "content": "Ford",
      "pos": [
        8806,
        8810
      ]
    },
    {
      "content": "2015-07-27T00:02:17.0000000Z",
      "pos": [
        8813,
        8841
      ]
    },
    {
      "content": "YHN 6970",
      "pos": [
        8846,
        8854
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        8857,
        8863
      ]
    },
    {
      "content": "2015-07-27T00:06:00.0000000Z",
      "pos": [
        8866,
        8894
      ]
    },
    {
      "content": "QYF 9358",
      "pos": [
        8899,
        8907
      ]
    },
    {
      "content": "Honda",
      "pos": [
        8910,
        8915
      ]
    },
    {
      "content": "2015-07-27T00:12:02.0000000Z",
      "pos": [
        8918,
        8946
      ]
    },
    {
      "content": "MDR 6128",
      "pos": [
        8951,
        8959
      ]
    },
    {
      "content": "BMW",
      "pos": [
        8962,
        8965
      ]
    },
    {
      "content": "2015-07-27T00:13:45.0000000Z",
      "pos": [
        8968,
        8996
      ]
    },
    {
      "pos": [
        9000,
        9013
      ],
      "content": "<bpt id=\"p1\">**</bpt>Solution<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Find last event in a window",
      "pos": [
        9190,
        9217
      ]
    },
    {
      "pos": [
        9221,
        9280
      ],
      "content": "<bpt id=\"p1\">**</bpt>Description<ept id=\"p1\">**</ept>: Find last car in every 10 minute interval."
    },
    {
      "pos": [
        9282,
        9292
      ],
      "content": "<bpt id=\"p1\">**</bpt>Input<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "LicensePlate",
      "pos": [
        9296,
        9308
      ]
    },
    {
      "content": "Make",
      "pos": [
        9311,
        9315
      ]
    },
    {
      "content": "Time",
      "pos": [
        9318,
        9322
      ]
    },
    {
      "content": "DXE 5291",
      "pos": [
        9347,
        9355
      ]
    },
    {
      "content": "Honda",
      "pos": [
        9358,
        9363
      ]
    },
    {
      "content": "2015-07-27T00:00:05.0000000Z",
      "pos": [
        9366,
        9394
      ]
    },
    {
      "content": "YZK 5704",
      "pos": [
        9399,
        9407
      ]
    },
    {
      "content": "Ford",
      "pos": [
        9410,
        9414
      ]
    },
    {
      "content": "2015-07-27T00:02:17.0000000Z",
      "pos": [
        9417,
        9445
      ]
    },
    {
      "content": "RMV 8282",
      "pos": [
        9450,
        9458
      ]
    },
    {
      "content": "Honda",
      "pos": [
        9461,
        9466
      ]
    },
    {
      "content": "2015-07-27T00:05:01.0000000Z",
      "pos": [
        9469,
        9497
      ]
    },
    {
      "content": "YHN 6970",
      "pos": [
        9502,
        9510
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        9513,
        9519
      ]
    },
    {
      "content": "2015-07-27T00:06:00.0000000Z",
      "pos": [
        9522,
        9550
      ]
    },
    {
      "content": "VFE 1616",
      "pos": [
        9555,
        9563
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        9566,
        9572
      ]
    },
    {
      "content": "2015-07-27T00:09:31.0000000Z",
      "pos": [
        9575,
        9603
      ]
    },
    {
      "content": "QYF 9358",
      "pos": [
        9608,
        9616
      ]
    },
    {
      "content": "Honda",
      "pos": [
        9619,
        9624
      ]
    },
    {
      "content": "2015-07-27T00:12:02.0000000Z",
      "pos": [
        9627,
        9655
      ]
    },
    {
      "content": "MDR 6128",
      "pos": [
        9660,
        9668
      ]
    },
    {
      "content": "BMW",
      "pos": [
        9671,
        9674
      ]
    },
    {
      "content": "2015-07-27T00:13:45.0000000Z",
      "pos": [
        9677,
        9705
      ]
    },
    {
      "pos": [
        9709,
        9720
      ],
      "content": "<bpt id=\"p1\">**</bpt>Output<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "LicensePlate",
      "pos": [
        9724,
        9736
      ]
    },
    {
      "content": "Make",
      "pos": [
        9739,
        9743
      ]
    },
    {
      "content": "Time",
      "pos": [
        9746,
        9750
      ]
    },
    {
      "content": "VFE 1616",
      "pos": [
        9775,
        9783
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        9786,
        9792
      ]
    },
    {
      "content": "2015-07-27T00:09:31.0000000Z",
      "pos": [
        9795,
        9823
      ]
    },
    {
      "content": "MDR 6128",
      "pos": [
        9828,
        9836
      ]
    },
    {
      "content": "BMW",
      "pos": [
        9839,
        9842
      ]
    },
    {
      "content": "2015-07-27T00:13:45.0000000Z",
      "pos": [
        9845,
        9873
      ]
    },
    {
      "pos": [
        9877,
        9890
      ],
      "content": "<bpt id=\"p1\">**</bpt>Solution<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Explanation<ept id=\"p1\">**</ept>:",
      "pos": [
        10363,
        10379
      ]
    },
    {
      "content": "There are two steps in the query – the first one finds latest timestamp in 10 minute windows.",
      "pos": [
        10380,
        10473
      ]
    },
    {
      "content": "The second step joins results of the first query with original stream to find events matching last timestamps in each window.",
      "pos": [
        10474,
        10599
      ]
    },
    {
      "content": "Detect the absence of events",
      "pos": [
        10605,
        10633
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Description<ept id=\"p1\">**</ept>: Check that a stream has no value that matches a certain criteria.",
      "pos": [
        10637,
        10719
      ]
    },
    {
      "content": "e.g. Have 2 consecutive cars from the same make entered the toll road within 90 seconds?",
      "pos": [
        10720,
        10808
      ]
    },
    {
      "pos": [
        10810,
        10820
      ],
      "content": "<bpt id=\"p1\">**</bpt>Input<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        10824,
        10828
      ]
    },
    {
      "content": "LicensePlate",
      "pos": [
        10831,
        10843
      ]
    },
    {
      "content": "Time",
      "pos": [
        10846,
        10850
      ]
    },
    {
      "content": "Honda",
      "pos": [
        10875,
        10880
      ]
    },
    {
      "content": "ABC-123",
      "pos": [
        10883,
        10890
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        10893,
        10921
      ]
    },
    {
      "content": "Honda",
      "pos": [
        10926,
        10931
      ]
    },
    {
      "content": "AAA-999",
      "pos": [
        10934,
        10941
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        10944,
        10972
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        10977,
        10983
      ]
    },
    {
      "content": "DEF-987",
      "pos": [
        10986,
        10993
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        10996,
        11024
      ]
    },
    {
      "content": "Honda",
      "pos": [
        11029,
        11034
      ]
    },
    {
      "content": "GHI-345",
      "pos": [
        11037,
        11044
      ]
    },
    {
      "content": "2015-01-01T00:00:04.0000000Z",
      "pos": [
        11047,
        11075
      ]
    },
    {
      "pos": [
        11079,
        11090
      ],
      "content": "<bpt id=\"p1\">**</bpt>Output<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        11094,
        11098
      ]
    },
    {
      "content": "Time",
      "pos": [
        11101,
        11105
      ]
    },
    {
      "content": "CurrentCarLicensePlate",
      "pos": [
        11108,
        11130
      ]
    },
    {
      "content": "FirstCarLicensePlate",
      "pos": [
        11133,
        11153
      ]
    },
    {
      "content": "FirstCarTime",
      "pos": [
        11156,
        11168
      ]
    },
    {
      "content": "Honda",
      "pos": [
        11205,
        11210
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        11213,
        11241
      ]
    },
    {
      "content": "AAA-999",
      "pos": [
        11244,
        11251
      ]
    },
    {
      "content": "ABC-123",
      "pos": [
        11254,
        11261
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        11264,
        11292
      ]
    },
    {
      "pos": [
        11296,
        11309
      ],
      "content": "<bpt id=\"p1\">**</bpt>Solution<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Explanation<ept id=\"p1\">**</ept>:",
      "pos": [
        11671,
        11687
      ]
    },
    {
      "content": "Use LAG to peek into the input stream one event back and get the Make value.",
      "pos": [
        11688,
        11764
      ]
    },
    {
      "content": "Then compare it to the Make on the current event and output the event if they are the same and use LAG to get data about the previous car.",
      "pos": [
        11765,
        11903
      ]
    },
    {
      "content": "Detect duration of a condition",
      "pos": [
        11908,
        11938
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Description<ept id=\"p1\">**</ept>: Find out how long a condition occurred for.",
      "pos": [
        11942,
        12002
      ]
    },
    {
      "content": "e.g. Suppose that a bug that resulted in all cars having an incorrect (above 20,000 pounds) – we want to compute the duration of the bug.",
      "pos": [
        12003,
        12140
      ]
    },
    {
      "pos": [
        12142,
        12152
      ],
      "content": "<bpt id=\"p1\">**</bpt>Input<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "Make",
      "pos": [
        12156,
        12160
      ]
    },
    {
      "content": "Time",
      "pos": [
        12163,
        12167
      ]
    },
    {
      "content": "Weight",
      "pos": [
        12170,
        12176
      ]
    },
    {
      "content": "Honda",
      "pos": [
        12201,
        12206
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        12209,
        12237
      ]
    },
    {
      "content": "2000",
      "pos": [
        12240,
        12244
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        12249,
        12255
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        12258,
        12286
      ]
    },
    {
      "content": "25000",
      "pos": [
        12289,
        12294
      ]
    },
    {
      "content": "Honda",
      "pos": [
        12299,
        12304
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        12307,
        12335
      ]
    },
    {
      "content": "26000",
      "pos": [
        12338,
        12343
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        12348,
        12354
      ]
    },
    {
      "content": "2015-01-01T00:00:04.0000000Z",
      "pos": [
        12357,
        12385
      ]
    },
    {
      "content": "25000",
      "pos": [
        12388,
        12393
      ]
    },
    {
      "content": "Honda",
      "pos": [
        12398,
        12403
      ]
    },
    {
      "content": "2015-01-01T00:00:05.0000000Z",
      "pos": [
        12406,
        12434
      ]
    },
    {
      "content": "26000",
      "pos": [
        12437,
        12442
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        12447,
        12453
      ]
    },
    {
      "content": "2015-01-01T00:00:06.0000000Z",
      "pos": [
        12456,
        12484
      ]
    },
    {
      "content": "25000",
      "pos": [
        12487,
        12492
      ]
    },
    {
      "content": "Honda",
      "pos": [
        12497,
        12502
      ]
    },
    {
      "content": "2015-01-01T00:00:07.0000000Z",
      "pos": [
        12505,
        12533
      ]
    },
    {
      "content": "26000",
      "pos": [
        12536,
        12541
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        12546,
        12552
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        12555,
        12583
      ]
    },
    {
      "content": "2000",
      "pos": [
        12586,
        12590
      ]
    },
    {
      "pos": [
        12594,
        12605
      ],
      "content": "<bpt id=\"p1\">**</bpt>Output<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "StartFault",
      "pos": [
        12609,
        12619
      ]
    },
    {
      "content": "EndFault",
      "pos": [
        12622,
        12630
      ]
    },
    {
      "content": "FaultDurationSeconds",
      "pos": [
        12633,
        12653
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        12678,
        12706
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        12709,
        12737
      ]
    },
    {
      "content": "7",
      "pos": [
        12740,
        12741
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        12746,
        12774
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        12777,
        12805
      ]
    },
    {
      "content": "7",
      "pos": [
        12808,
        12809
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        12814,
        12842
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        12845,
        12873
      ]
    },
    {
      "content": "7",
      "pos": [
        12876,
        12877
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        12882,
        12910
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        12913,
        12941
      ]
    },
    {
      "content": "7",
      "pos": [
        12944,
        12945
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        12950,
        12978
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        12981,
        13009
      ]
    },
    {
      "content": "7",
      "pos": [
        13012,
        13013
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        13018,
        13046
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        13049,
        13077
      ]
    },
    {
      "content": "7",
      "pos": [
        13080,
        13081
      ]
    },
    {
      "pos": [
        13085,
        13098
      ],
      "content": "<bpt id=\"p1\">**</bpt>Solution<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Explanation<ept id=\"p1\">**</ept>:",
      "pos": [
        13979,
        13995
      ]
    },
    {
      "content": "We are looking for 2 good events with a bad event in between and without a good event in between which means the 2 events are the first events before and after at least 1 bad event.",
      "pos": [
        13996,
        14177
      ]
    },
    {
      "content": "Getting 2 good events with 1 bad event in the middle is simple using 2 JOINs and validating that we get good -&gt; bad -&gt; good by checking the weight and comparing the time stamps.",
      "pos": [
        14178,
        14355
      ]
    },
    {
      "content": "Using what we learned on “LEFT Outer Join to include NULLs or to do absence of events” we know how to check that no good event has occurred between the 2 good events we picked up.",
      "pos": [
        14358,
        14537
      ]
    },
    {
      "content": "Composing those together and we get good -&gt; bad -&gt; good with no other good event in between.",
      "pos": [
        14539,
        14631
      ]
    },
    {
      "content": "We can now compute the duration between the beginning and end good events which gives us the duration of the bug.",
      "pos": [
        14632,
        14745
      ]
    },
    {
      "content": "Get help",
      "pos": [
        14750,
        14758
      ]
    },
    {
      "pos": [
        14759,
        14901
      ],
      "content": "For further assistance, try our <bpt id=\"p1\">[</bpt>Azure Stream Analytics forum<ept id=\"p1\">](https://social.msdn.microsoft.com/Forums/en-US/home?forum=AzureStreamAnalytics)</ept>"
    },
    {
      "content": "Next steps",
      "pos": [
        14906,
        14916
      ]
    },
    {
      "content": "Introduction to Azure Stream Analytics",
      "pos": [
        14921,
        14959
      ]
    },
    {
      "content": "Get started using Azure Stream Analytics",
      "pos": [
        14998,
        15038
      ]
    },
    {
      "content": "Scale Azure Stream Analytics jobs",
      "pos": [
        15079,
        15112
      ]
    },
    {
      "content": "Azure Stream Analytics Query Language Reference",
      "pos": [
        15149,
        15196
      ]
    },
    {
      "content": "Azure Stream Analytics Management REST API Reference",
      "pos": [
        15257,
        15309
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"Azure Stream Analytics Query Patterns | Microsoft Azure\"\n    description=\"Common Azure Stream Analytics Query Patterns \"\n    keywords=\"stream analytics, sample, query, language, guide, patterns\"\n    services=\"stream-analytics\"\n    documentationCenter=\"\"\n    authors=\"jeffstokes72\"\n    manager=\"paulettm\"\n    editor=\"cgronlun\"/>\n\n<tags\n    ms.service=\"stream-analytics\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.tgt_pltfrm=\"na\"\n    ms.workload=\"big-data\"\n    ms.date=\"08/19/2015\"\n    ms.author=\"jeffstok\"/>\n\n\n# Common Azure Stream Analytics Query Patterns  #\n\n## Introduction ##\nQueries in Azure Stream Analytics are expressed in a SQL-like query language, which is documented [here](https://msdn.microsoft.com/library/azure/dn834998.aspx).  This document outlines solutions to several common query patterns based on real world scenarios.  It is a work in progress and will continue to be updated with new patterns on an ongoing basis.\n\n## Basics ##\n\n## Data type conversions ##\n**Description**: Define the types of the properties on the input stream.\ne.g. Car weight is coming on the input stream as strings and needs to be converted to INT to perform SUM it up.\n\n**Input**:\n\n| Make | Time | Weight |\n| --- | --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z | \"1000\" |\n| Honda | 2015-01-01T00:00:02.0000000Z | \"2000\" |\n\n**Output**:\n\n| Make | Weight |\n| --- | --- |\n| Honda | 3000 |\n\n**Solution**:\n\n    SELECT\n        Make,\n        SUM(CAST(Weight AS BIGINT)) AS Weight\n    FROM\n        Input TIMESTAMP BY Time\n    GROUP BY\n        Make,\n        TumblingWindow(second, 10)\n\n**Explanation**:\nUse a CAST statement on the Weight field to specify its type (see the list of supported Data Types [here](https://msdn.microsoft.com/library/azure/dn835065.aspx)).\n\n## Using Like/Not like to do pattern matching ##\n**Description**: Check that a field value on the event matches a certain pattern\ne.g. Return license plates that start with A and end with 9\n\n**Input**:\n\n| Make | LicensePlate | Time |\n| --- | --- | --- |\n| Honda | ABC-123 | 2015-01-01T00:00:01.0000000Z |\n| Toyota | AAA-999 | 2015-01-01T00:00:02.0000000Z |\n| Nissan | ABC-369 | 2015-01-01T00:00:03.0000000Z |\n\n**Output**:\n\n| Make | LicensePlate | Time |\n| --- | --- | --- |\n| Toyota | AAA-999 | 2015-01-01T00:00:02.0000000Z |\n| Nissan | ABC-369 | 2015-01-01T00:00:03.0000000Z |\n\n**Solution**:\n\n    SELECT\n        *\n    FROM\n        Input TIMESTAMP BY Time\n    WHERE\n        LicensePlate LIKE 'A%9'\n\n**Explanation**:\nUse the LIKE statement to check that the LicensePlate field value starts with A then has any string of zero or more characters and it ends with 9. \n\n## Specify logic for different cases/values (CASE statements) ##\n**Description**: Provide different computation for a field based on some criteria.\ne.g. Provide a string description for how many cars passed of the same make with a special case for 1.\n\n**Input**:\n\n| Make | Time |\n| --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z |\n| Toyota | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:03.0000000Z |\n\n**Output**:\n\n| CarsPassed | Time |\n| --- | --- | --- |\n| 1 Honda | 2015-01-01T00:00:10.0000000Z |\n| 2 Toyotas | 2015-01-01T00:00:10.0000000Z |\n\n**Solution**:\n\n    SELECT\n        CASE\n            WHEN COUNT(*) = 1 THEN CONCAT('1 ', Make)\n            ELSE CONCAT(CAST(COUNT(*) AS NVARCHAR(MAX)), ' ', Make, 's')\n        END AS CarsPassed,\n        System.TimeStamp AS Time\n    FROM\n        Input TIMESTAMP BY Time\n    GROUP BY\n        Make,\n        TumblingWindow(second, 10)\n\n**Explanation**:\nThe CASE clause allows us to provide a different computation based on some criteria (in our case the count of cars in the aggregate window).\n\n## Send data to multiple outputs ##\n**Description**: Send data to multiple output targets from a single job.\ne.g. Analyze data for a threshold-based alert and archive all events to blob storage\n\n**Input**:\n\n| Make | Time |\n| --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z |\n| Honda | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:01.0000000Z |\n| Toyota | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:03.0000000Z |\n\n**Output1**:\n\n| Make | Time |\n| --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z |\n| Honda | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:01.0000000Z |\n| Toyota | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:03.0000000Z |\n\n**Output2**:\n\n| Make | Time | Count |\n| --- | --- | --- |\n| Toyota | 2015-01-01T00:00:10.0000000Z | 3 |\n\n**Solution**:\n\n    SELECT\n        *\n    INTO\n        ArchiveOutput\n    FROM\n        Input TIMESTAMP BY Time\n\n    SELECT\n        Make,\n        System.TimeStamp AS Time,\n        COUNT(*) AS [Count]\n    INTO\n        AlertOutput\n    FROM\n        Input TIMESTAMP BY Time\n    GROUP BY\n        Make,\n        TumblingWindow(second, 10)\n    HAVING\n        [Count] >= 3\n\n**Explanation**:\nThe INTO clause tells Stream Analytics which of the outputs to write the data from this statement.\nThe first query is a pass-through of the data we received to an output that we named ArchiveOutput.\nThe second query does some simple aggregation and filtering and sends the results to a downstream alerting system.\n*Note*: You can also reuse results of CTEs (i.e. WITH statements) in multiple output statements – this has the added benefit of opening less readers to the input source.\ne.g. \n\n    WITH AllRedCars AS (\n        SELECT\n            *\n        FROM\n            Input TIMESTAMP BY Time\n        WHERE\n            Color = 'red'\n    )\n    SELECT * INTO HondaOutput FROM AllRedCars WHERE Make = 'Honda'\n    SELECT * INTO ToyotaOutput FROM AllRedCars WHERE Make = 'Toyota'\n\n## Patterns ##\n\n## Counting unique values\n**Description**: count the number of unique field values that appear in the stream within a time window.\ne.g. How many unique make of cars passed through the toll booth in a 2 second window?\n\n**Input**:\n\n| Make | Time |\n| --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z |\n| Honda | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:01.0000000Z |\n| Toyota | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:03.0000000Z |\n\n**Output:**\n\n| Count | Time |\n| --- | --- |\n| 2 | 2015-01-01T00:00:02.000Z |\n| 1 | 2015-01-01T00:00:04.000Z |\n\n**Solution:**\n\n    WITH Makes AS (\n        SELECT\n            Make,\n            COUNT(*) AS CountMake\n        FROM\n            Input TIMESTAMP BY Time\n        GROUP BY\n              Make,\n              TumblingWindow(second, 2)\n    )\n    SELECT\n        COUNT(*) AS Count,\n        System.TimeStamp AS Time\n    FROM\n        Makes\n    GROUP BY\n        TumblingWindow(second, 1)\n\n\n**Explanation:**\nWe do an initial aggregation to get unique makes with their count over the window.\nWe then do an aggregation of how many makes we got – given all unique values in a window get the same timestamp then the second aggregation window needs to be minimal to not aggregate 2 windows from the first step.\n\n## Determine if a value has changed ##\n**Description**: Look at a previous value to determine if it is different than the current value\ne.g. Is the previous car on the Toll Road the same make as the current car?\n\n**Input**:\n\n| Make | Time |\n| --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z |\n| Toyota | 2015-01-01T00:00:02.0000000Z |\n\n**Output**:\n\n| Make | Time |\n| --- | --- |\n| Toyota | 2015-01-01T00:00:02.0000000Z |\n\n**Solution**:\n\n    SELECT\n        Make,\n        Time\n    FROM\n        Input TIMESTAMP BY Time\n    WHERE\n        LAG(Make, 1) OVER (LIMIT DURATION(minute, 1)) <> Make\n\n**Explanation**:\nUse LAG to peek into the input stream one event back and get the Make value. Then compare it to the Make on the current event and output the event if they are different.\n\n## Find first event in a window ##\n**Description**: Find first car in every 10 minute interval?\n\n**Input**:\n\n| LicensePlate | Make | Time |\n| --- | --- | --- |\n| DXE 5291 | Honda | 2015-07-27T00:00:05.0000000Z |\n| YZK 5704 | Ford | 2015-07-27T00:02:17.0000000Z |\n| RMV 8282 | Honda | 2015-07-27T00:05:01.0000000Z |\n| YHN 6970 | Toyota | 2015-07-27T00:06:00.0000000Z |\n| VFE 1616 | Toyota | 2015-07-27T00:09:31.0000000Z |\n| QYF 9358 | Honda | 2015-07-27T00:12:02.0000000Z |\n| MDR 6128 | BMW | 2015-07-27T00:13:45.0000000Z |\n\n**Output**:\n\n| LicensePlate | Make | Time |\n| --- | --- | --- |\n| DXE 5291 | Honda | 2015-07-27T00:00:05.0000000Z |\n| QYF 9358 | Honda | 2015-07-27T00:12:02.0000000Z |\n\n**Solution**:\n\n    SELECT \n        LicensePlate,\n        Make,\n        Time\n    FROM \n        Input TIMESTAMP BY Time\n    WHERE \n        IsFirst(minute, 10) = 1\n\nNow let’s change the problem and find first car of particular Make in every 10 minute interval.\n\n| LicensePlate | Make | Time |\n| --- | --- | --- |\n| DXE 5291 | Honda | 2015-07-27T00:00:05.0000000Z |\n| YZK 5704 | Ford | 2015-07-27T00:02:17.0000000Z |\n| YHN 6970 | Toyota | 2015-07-27T00:06:00.0000000Z |\n| QYF 9358 | Honda | 2015-07-27T00:12:02.0000000Z |\n| MDR 6128 | BMW | 2015-07-27T00:13:45.0000000Z |\n\n**Solution**:\n\n    SELECT \n        LicensePlate,\n        Make,\n        Time\n    FROM \n        Input TIMESTAMP BY Time\n    WHERE \n        IsFirst(minute, 10) OVER (PARTITION BY Make) = 1\n\n## Find last event in a window ##\n**Description**: Find last car in every 10 minute interval.\n\n**Input**:\n\n| LicensePlate | Make | Time |\n| --- | --- | --- |\n| DXE 5291 | Honda | 2015-07-27T00:00:05.0000000Z |\n| YZK 5704 | Ford | 2015-07-27T00:02:17.0000000Z |\n| RMV 8282 | Honda | 2015-07-27T00:05:01.0000000Z |\n| YHN 6970 | Toyota | 2015-07-27T00:06:00.0000000Z |\n| VFE 1616 | Toyota | 2015-07-27T00:09:31.0000000Z |\n| QYF 9358 | Honda | 2015-07-27T00:12:02.0000000Z |\n| MDR 6128 | BMW | 2015-07-27T00:13:45.0000000Z |\n\n**Output**:\n\n| LicensePlate | Make | Time |\n| --- | --- | --- |\n| VFE 1616 | Toyota | 2015-07-27T00:09:31.0000000Z |\n| MDR 6128 | BMW | 2015-07-27T00:13:45.0000000Z |\n\n**Solution**:\n\n    WITH LastInWindow AS\n    (\n        SELECT \n            MAX(Time) AS LastEventTime\n        FROM \n            Input TIMESTAMP BY Time\n        GROUP BY \n            TumblingWindow(minute, 10)\n    )\n    SELECT \n        Input.LicensePlate,\n        Input.Make,\n        Input.Time\n    FROM\n        Input TIMESTAMP BY Time \n        INNER JOIN LastInWindow\n        ON DATEDIFF(minute, Input, LastInWindow) BETWEEN 0 AND 10\n        AND Input.Time = LastInWindow.LastEventTime\n\n**Explanation**:\nThere are two steps in the query – the first one finds latest timestamp in 10 minute windows. The second step joins results of the first query with original stream to find events matching last timestamps in each window. \n\n## Detect the absence of events ##\n**Description**: Check that a stream has no value that matches a certain criteria.\ne.g. Have 2 consecutive cars from the same make entered the toll road within 90 seconds?\n\n**Input**:\n\n| Make | LicensePlate | Time |\n| --- | --- | --- |\n| Honda | ABC-123 | 2015-01-01T00:00:01.0000000Z |\n| Honda | AAA-999 | 2015-01-01T00:00:02.0000000Z |\n| Toyota | DEF-987 | 2015-01-01T00:00:03.0000000Z |\n| Honda | GHI-345 | 2015-01-01T00:00:04.0000000Z |\n\n**Output**:\n\n| Make | Time | CurrentCarLicensePlate | FirstCarLicensePlate | FirstCarTime |\n| --- | --- | --- | --- | --- |\n| Honda | 2015-01-01T00:00:02.0000000Z | AAA-999 | ABC-123 | 2015-01-01T00:00:01.0000000Z |\n\n**Solution**:\n\n    SELECT\n        Make,\n        Time,\n        LicensePlate AS CurrentCarLicensePlate,\n        LAG(LicensePlate, 1) OVER (LIMIT DURATION(second, 90)) AS FirstCarLicensePlate,\n        LAG(Time, 1) OVER (LIMIT DURATION(second, 90)) AS FirstCarTime\n    FROM\n        Input TIMESTAMP BY Time\n    WHERE\n        LAG(Make, 1) OVER (LIMIT DURATION(second, 90)) = Make\n\n**Explanation**:\nUse LAG to peek into the input stream one event back and get the Make value. Then compare it to the Make on the current event and output the event if they are the same and use LAG to get data about the previous car.\n\n## Detect duration of a condition ##\n**Description**: Find out how long a condition occurred for.\ne.g. Suppose that a bug that resulted in all cars having an incorrect (above 20,000 pounds) – we want to compute the duration of the bug.\n\n**Input**:\n\n| Make | Time | Weight |\n| --- | --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z | 2000 |\n| Toyota | 2015-01-01T00:00:02.0000000Z | 25000 |\n| Honda | 2015-01-01T00:00:03.0000000Z | 26000 |\n| Toyota | 2015-01-01T00:00:04.0000000Z | 25000 |\n| Honda | 2015-01-01T00:00:05.0000000Z | 26000 |\n| Toyota | 2015-01-01T00:00:06.0000000Z | 25000 |\n| Honda | 2015-01-01T00:00:07.0000000Z | 26000 |\n| Toyota | 2015-01-01T00:00:08.0000000Z | 2000 |\n\n**Output**:\n\n| StartFault | EndFault | FaultDurationSeconds |\n| --- | --- | --- |\n| 2015-01-01T00:00:01.0000000Z | 2015-01-01T00:00:08.0000000Z | 7 |\n| 2015-01-01T00:00:01.0000000Z | 2015-01-01T00:00:08.0000000Z | 7 |\n| 2015-01-01T00:00:01.0000000Z | 2015-01-01T00:00:08.0000000Z | 7 |\n| 2015-01-01T00:00:01.0000000Z | 2015-01-01T00:00:08.0000000Z | 7 |\n| 2015-01-01T00:00:01.0000000Z | 2015-01-01T00:00:08.0000000Z | 7 |\n| 2015-01-01T00:00:01.0000000Z | 2015-01-01T00:00:08.0000000Z | 7 |\n\n**Solution**:\n\n    SELECT\n        PrevGood.Time AS StartFault,\n        ThisGood.Time AS Endfault,\n        DATEDIFF(second, PrevGood.Time, ThisGood.Time) AS FaultDuraitonSeconds\n    FROM\n        Input AS ThisGood TIMESTAMP BY Time\n        INNER JOIN Input AS PrevGood TIMESTAMP BY Time\n        ON DATEDIFF(second, PrevGood, ThisGood) BETWEEN 1 AND 3600\n        AND PrevGood.Weight < 20000\n        INNER JOIN Input AS Bad TIMESTAMP BY Time\n        ON DATEDIFF(second, PrevGood, Bad) BETWEEN 1 AND 3600\n        AND DATEDIFF(second, Bad, ThisGood) BETWEEN 1 AND 3600\n        AND Bad.Weight >= 20000\n        LEFT JOIN Input AS MidGood TIMESTAMP BY Time\n        ON DATEDIFF(second, PrevGood, MidGood) BETWEEN 1 AND 3600\n        AND DATEDIFF(second, MidGood, ThisGood) BETWEEN 1 AND 3600\n        AND MidGood.Weight < 20000\n    WHERE\n        ThisGood.Weight < 20000\n        AND MidGood.Weight IS NULL\n\n**Explanation**:\nWe are looking for 2 good events with a bad event in between and without a good event in between which means the 2 events are the first events before and after at least 1 bad event. Getting 2 good events with 1 bad event in the middle is simple using 2 JOINs and validating that we get good -> bad -> good by checking the weight and comparing the time stamps. \n\nUsing what we learned on “LEFT Outer Join to include NULLs or to do absence of events” we know how to check that no good event has occurred between the 2 good events we picked up.\n\nComposing those together and we get good -> bad -> good with no other good event in between. We can now compute the duration between the beginning and end good events which gives us the duration of the bug.\n\n## Get help\nFor further assistance, try our [Azure Stream Analytics forum](https://social.msdn.microsoft.com/Forums/en-US/home?forum=AzureStreamAnalytics)\n\n## Next steps\n\n- [Introduction to Azure Stream Analytics](stream-analytics-introduction.md)\n- [Get started using Azure Stream Analytics](../stream.analytics.get.started.md)\n- [Scale Azure Stream Analytics jobs](stream-analytics-scale-jobs.md)\n- [Azure Stream Analytics Query Language Reference](https://msdn.microsoft.com/library/azure/dn834998.aspx)\n- [Azure Stream Analytics Management REST API Reference](https://msdn.microsoft.com/library/azure/dn835031.aspx)\n \n"
}