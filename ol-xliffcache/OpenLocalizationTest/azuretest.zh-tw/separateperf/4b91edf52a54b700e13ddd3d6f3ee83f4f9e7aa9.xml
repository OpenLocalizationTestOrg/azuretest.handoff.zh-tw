{
  "nodes": [
    {
      "content": "Serialize data with the Microsoft Avro Library | Microsoft Azure",
      "pos": [
        27,
        91
      ]
    },
    {
      "content": "Learn how Azure HDInsight uses Avro to serialize big data.",
      "pos": [
        110,
        168
      ]
    },
    {
      "content": "Serialize data in Hadoop with the Microsoft Avro Library",
      "pos": [
        494,
        550
      ]
    },
    {
      "pos": [
        552,
        882
      ],
      "content": "This topic shows how to use the <ph id=\"ph1\">&lt;a href=\"https://hadoopsdk.codeplex.com/wikipage?title=Avro%20Library\" target=\"_blank\"&gt;</ph>Microsoft Avro Library<ph id=\"ph2\">&lt;/a&gt;</ph> to serialize objects and other data structures into streams in order to persist them to memory, a database, or a file, and also how to deserialize them to recover the original objects."
    },
    {
      "content": "<ph id=\"ph1\">&lt;a name=\"apacheAvro\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Apache Avro",
      "pos": [
        887,
        923
      ]
    },
    {
      "content": "The <ph id=\"ph1\">&lt;a href=\"https://hadoopsdk.codeplex.com/wikipage?title=Avro%20Library\" target=\"_blank\"&gt;</ph>Microsoft Avro Library<ph id=\"ph2\">&lt;/a&gt;</ph> implements the Apache Avro data serialization system for the Microsoft.NET environment.",
      "pos": [
        924,
        1129
      ]
    },
    {
      "content": "Apache Avro provides a compact binary data interchange format for serialization.",
      "pos": [
        1130,
        1210
      ]
    },
    {
      "content": "It uses <ph id=\"ph1\">&lt;a href=\"http://www.json.org\" target=\"_blank\"&gt;</ph>JSON<ph id=\"ph2\">&lt;/a&gt;</ph> to define a language-agnostic schema that underwrites language interoperability.",
      "pos": [
        1211,
        1354
      ]
    },
    {
      "content": "Data serialized in one language can be read in another.",
      "pos": [
        1355,
        1410
      ]
    },
    {
      "content": "Currently C, C++, C#, Java, PHP, Python, and Ruby are supported.",
      "pos": [
        1411,
        1475
      ]
    },
    {
      "content": "Detailed information on the format can be found in the <ph id=\"ph1\">&lt;a href=\"http://avro.apache.org/docs/current/spec.html\" target=\"_blank\"&gt;</ph>Apache Avro Specification<ph id=\"ph2\">&lt;/a&gt;</ph>.",
      "pos": [
        1476,
        1633
      ]
    },
    {
      "content": "Note that the current version of the Microsoft Avro Library does not support the remote procedure calls (RPCs) part of this specification.",
      "pos": [
        1634,
        1772
      ]
    },
    {
      "content": "The serialized representation of an object in the Avro system consists of two parts: schema and actual value.",
      "pos": [
        1774,
        1883
      ]
    },
    {
      "content": "The Avro schema describes the language-independent data model of the serialized data with JSON.",
      "pos": [
        1884,
        1979
      ]
    },
    {
      "content": "It is present side-by-side with a binary representation of data.",
      "pos": [
        1980,
        2044
      ]
    },
    {
      "content": "Having the schema separate from the binary representation permits each object to be written with no per-value overheads, making serialization fast and the representation small.",
      "pos": [
        2045,
        2221
      ]
    },
    {
      "content": "<ph id=\"ph1\">&lt;a name=\"hadoopScenario\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>The Hadoop scenario",
      "pos": [
        2225,
        2273
      ]
    },
    {
      "content": "The Apache Avro serialization format is widely used in Azure HDInsight and other Apache Hadoop environments.",
      "pos": [
        2274,
        2382
      ]
    },
    {
      "content": "Avro provides a convenient way to represent complex data structures within a Hadoop MapReduce job.",
      "pos": [
        2383,
        2481
      ]
    },
    {
      "content": "The format of Avro files (Avro object container file) has been designed to support the distributed MapReduce programming model.",
      "pos": [
        2482,
        2609
      ]
    },
    {
      "content": "The key feature that enables the distribution is that the files are “splittable” in the sense that one can seek any point in a file and start reading from a particular block.",
      "pos": [
        2610,
        2784
      ]
    },
    {
      "content": "<ph id=\"ph1\">&lt;a name=\"serializationMAL\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Serialization in the Microsoft Avro Library",
      "pos": [
        2788,
        2862
      ]
    },
    {
      "content": "The .NET Library for Avro supports two ways of serializing objects:",
      "pos": [
        2863,
        2930
      ]
    },
    {
      "pos": [
        2934,
        3073
      ],
      "content": "<bpt id=\"p1\">**</bpt>reflection<ept id=\"p1\">**</ept> - The JSON schema for the types is automatically built from the data contract attributes of the .NET types to be serialized."
    },
    {
      "pos": [
        3076,
        3346
      ],
      "content": "<bpt id=\"p1\">**</bpt>generic record<ept id=\"p1\">**</ept> - A JSON schema is explicitly specified in a record represented by the <bpt id=\"p2\">[</bpt><bpt id=\"p3\">**</bpt>AvroRecord<ept id=\"p3\">**</ept><ept id=\"p2\">](http://msdn.microsoft.com/library/microsoft.hadoop.avro.avrorecord.aspx)</ept> class when no .NET types are present to describe the schema for the data to be serialized."
    },
    {
      "content": "When the data schema is known to both the writer and reader of the stream, the data can be sent without its schema.",
      "pos": [
        3348,
        3463
      ]
    },
    {
      "content": "In cases when an Avro object container file is used, the schema is stored within the file.",
      "pos": [
        3464,
        3554
      ]
    },
    {
      "content": "Other parameters, such as the codec used for data compression, can be specified.",
      "pos": [
        3555,
        3635
      ]
    },
    {
      "content": "These scenarios are outlined in more detail and illustrated in the code examples below.",
      "pos": [
        3636,
        3723
      ]
    },
    {
      "pos": [
        3728,
        3793
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"prerequisites\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph> Microsoft Avro Library prerequisites"
    },
    {
      "pos": [
        3797,
        3909
      ],
      "content": "<ph id=\"ph1\">&lt;a href=\"http://www.microsoft.com/download/details.aspx?id=17851\" target=\"_blank\"&gt;</ph>Microsoft .NET Framework 4<ph id=\"ph2\">&lt;/a&gt;</ph>"
    },
    {
      "pos": [
        3912,
        4011
      ],
      "content": "<ph id=\"ph1\">&lt;a href=\"http://james.newtonking.com/json\" target=\"_blank\"&gt;</ph>Newtonsoft Json.NET<ph id=\"ph2\">&lt;/a&gt;</ph> (6.0.4 or later)"
    },
    {
      "content": "Note that the Newtonsoft.Json.dll dependency is downloaded automatically with the installation of the Microsoft Avro Library.",
      "pos": [
        4013,
        4138
      ]
    },
    {
      "content": "The procedure for this is provided in the following section.",
      "pos": [
        4139,
        4199
      ]
    },
    {
      "content": "<ph id=\"ph1\">&lt;a name=\"installation\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph> Microsoft Avro Library installation",
      "pos": [
        4203,
        4266
      ]
    },
    {
      "content": "The Microsoft Avro Library is distributed as a NuGet package that can be installed from Visual Studio via the following procedure:",
      "pos": [
        4267,
        4397
      ]
    },
    {
      "pos": [
        4402,
        4460
      ],
      "content": "Select the <bpt id=\"p1\">**</bpt>Project<ept id=\"p1\">**</ept> tab -&gt; <bpt id=\"p2\">**</bpt>Manage NuGet Packages...<ept id=\"p2\">**</ept>"
    },
    {
      "pos": [
        4464,
        4528
      ],
      "content": "Search for \"Microsoft.Hadoop.Avro\" in the <bpt id=\"p1\">**</bpt>Search Online<ept id=\"p1\">**</ept> box."
    },
    {
      "pos": [
        4532,
        4612
      ],
      "content": "Click the <bpt id=\"p1\">**</bpt>Install<ept id=\"p1\">**</ept> button next to <bpt id=\"p2\">**</bpt>Microsoft Azure HDInsight Avro Library<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Note that the Newtonsoft.Json.dll (&gt;=6.0.4) dependency is also downloaded automatically with the Microsoft Avro Library.",
      "pos": [
        4614,
        4734
      ]
    },
    {
      "pos": [
        4736,
        4920
      ],
      "content": "You may want to visit the <ph id=\"ph1\">&lt;a href=\"https://hadoopsdk.codeplex.com/wikipage?title=Avro%20Library\" target=\"_blank\"&gt;</ph>Microsoft Avro Library home page<ph id=\"ph2\">&lt;/a&gt;</ph> to read the current release notes."
    },
    {
      "pos": [
        4924,
        4983
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"sourceCode\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Microsoft Avro Library source code"
    },
    {
      "pos": [
        4985,
        5168
      ],
      "content": "The Microsoft Avro Library source code is available at the <ph id=\"ph1\">&lt;a href=\"https://hadoopsdk.codeplex.com/wikipage?title=Avro%20Library\" target=\"_blank\"&gt;</ph>Microsoft Avro Library home page<ph id=\"ph2\">&lt;/a&gt;</ph>."
    },
    {
      "pos": [
        5172,
        5252
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"compiling\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Compiling the schema by using the Microsoft Avro Library"
    },
    {
      "content": "The Microsoft Avro Library contains a code generation utility that allows creating C# types automatically based on the previously defined JSON schema.",
      "pos": [
        5254,
        5404
      ]
    },
    {
      "content": "The code generation utility is not distributed as a binary executable, but can be easily built via the following procedure:",
      "pos": [
        5405,
        5528
      ]
    },
    {
      "content": "Download the .zip file with the latest version of HDInsight SDK source code from <ph id=\"ph1\">&lt;a href=\"http://hadoopsdk.codeplex.com/SourceControl/latest\" target=\"_blank\"&gt;</ph>Microsoft .NET SDK For Hadoop<ph id=\"ph2\">&lt;/a&gt;</ph>.",
      "pos": [
        5533,
        5725
      ]
    },
    {
      "content": "(Click the <bpt id=\"p1\">**</bpt>Download<ept id=\"p1\">**</ept> icon.)",
      "pos": [
        5726,
        5756
      ]
    },
    {
      "content": "Extract the HDInsight SDK to a directory on the machine with .NET Framework 4 installed and connected to the Internet for downloading necessary dependency NuGet packages.",
      "pos": [
        5761,
        5931
      ]
    },
    {
      "content": "Below we will assume that the source code is extracted to C:\\SDK.",
      "pos": [
        5932,
        5997
      ]
    },
    {
      "content": "Go to the folder C:\\SDK\\src\\Microsoft.Hadoop.Avro.Tools and run build.bat.",
      "pos": [
        6002,
        6076
      ]
    },
    {
      "content": "(The file will call MSBuild from the 32-bit distribution of the .NET Framework.",
      "pos": [
        6077,
        6156
      ]
    },
    {
      "content": "If you would like to use the 64-bit version, edit build.bat, following the comments inside the file.) Ensure that the build is successful.",
      "pos": [
        6157,
        6295
      ]
    },
    {
      "content": "(On some systems, MSBuild may produce warnings.",
      "pos": [
        6296,
        6343
      ]
    },
    {
      "content": "These warnings do not affect the utility as long as there are no build errors.)",
      "pos": [
        6344,
        6423
      ]
    },
    {
      "content": "The compiled utility is located in C:\\SDK\\Bin\\Unsigned\\Release\\Microsoft.Hadoop.Avro.Tools.",
      "pos": [
        6428,
        6519
      ]
    },
    {
      "pos": [
        6522,
        6705
      ],
      "content": "To get familiar with the command-line syntax, execute the following command from the folder where the code generation utility is located: <ph id=\"ph1\">`Microsoft.Hadoop.Avro.Tools help /c:codegen`</ph>"
    },
    {
      "content": "To test the utility, you can generate C# classes from the sample JSON schema file provided with the source code.",
      "pos": [
        6707,
        6819
      ]
    },
    {
      "content": "Execute the following command:",
      "pos": [
        6820,
        6850
      ]
    },
    {
      "content": "This is supposed to produce two C# files in the current directory: SensorData.cs and Location.cs.",
      "pos": [
        6972,
        7069
      ]
    },
    {
      "content": "To understand the logic that the code generation utility is using while converting the JSON schema to C# types, see the file GenerationVerification.feature located in C:\\SDK\\src\\Microsoft.Hadoop.Avro.Tools\\Doc.",
      "pos": [
        7071,
        7281
      ]
    },
    {
      "content": "Please note that namespaces are extracted from the JSON schema, using the logic described in the file mentioned in the previous paragraph.",
      "pos": [
        7283,
        7421
      ]
    },
    {
      "content": "Namespaces extracted from the schema take precedence over whatever is provided with the /n parameter in the utility command line.",
      "pos": [
        7422,
        7551
      ]
    },
    {
      "content": "If you want to override the namespaces contained within the schema, use the /nf parameter.",
      "pos": [
        7552,
        7642
      ]
    },
    {
      "content": "For example, to change all namespaces from the SampleJSONSchema.avsc to my.own.nspace, execute the following command:",
      "pos": [
        7643,
        7760
      ]
    },
    {
      "content": "<ph id=\"ph1\">&lt;a name=\"samples\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Guide to the samples for the Microsoft Avro Library",
      "pos": [
        7903,
        7976
      ]
    },
    {
      "content": "Six examples provided in this topic illustrate different scenarios supported by the Microsoft Avro Library.",
      "pos": [
        7977,
        8084
      ]
    },
    {
      "content": "The Microsoft Avro Library is designed to work with any stream.",
      "pos": [
        8085,
        8148
      ]
    },
    {
      "content": "In these examples, data is manipulated via memory streams rather than file streams or databases for simplicity and consistency.",
      "pos": [
        8149,
        8276
      ]
    },
    {
      "content": "The approach taken in a production environment will depend on the exact scenario requirements, data source and volume, performance constraints, and other factors.",
      "pos": [
        8277,
        8439
      ]
    },
    {
      "content": "The first two examples show how to serialize and deserialize data into memory stream buffers by using reflection and generic records.",
      "pos": [
        8441,
        8574
      ]
    },
    {
      "content": "The schema in these two cases is assumed to be shared between the readers and writers out-of-band.",
      "pos": [
        8575,
        8673
      ]
    },
    {
      "content": "The third and fourth examples show how to serialize and deserialize data by using the Avro object container files.",
      "pos": [
        8675,
        8789
      ]
    },
    {
      "content": "When data is stored in an Avro container file, its schema is always stored with it because the schema must be shared for deserialization.",
      "pos": [
        8790,
        8927
      ]
    },
    {
      "pos": [
        8929,
        9133
      ],
      "content": "The sample containing the first four examples can be downloaded from the <ph id=\"ph1\">&lt;a href=\"http://code.msdn.microsoft.com/windowsazure/Serialize-data-with-the-86055923\" target=\"_blank\"&gt;</ph>Azure code samples<ph id=\"ph2\">&lt;/a&gt;</ph> site."
    },
    {
      "content": "The fifth example shows how to how to use a custom compression codec for Avro object container files.",
      "pos": [
        9135,
        9236
      ]
    },
    {
      "content": "A sample containing the code for this example can be downloaded from the <ph id=\"ph1\">&lt;a href=\"http://code.msdn.microsoft.com/windowsazure/Serialize-data-with-the-67159111\" target=\"_blank\"&gt;</ph>Azure code samples<ph id=\"ph2\">&lt;/a&gt;</ph> site.",
      "pos": [
        9237,
        9441
      ]
    },
    {
      "content": "The sixth sample shows how to use Avro serialization to upload data to Azure Blob storage and then analyze it by using Hive with an HDInsight (Hadoop) cluster.",
      "pos": [
        9443,
        9602
      ]
    },
    {
      "content": "It can be downloaded from the <ph id=\"ph1\">&lt;a href=\"https://code.msdn.microsoft.com/windowsazure/Using-Avro-to-upload-data-ae81b1e3\" target=\"_blank\"&gt;</ph>Azure code samples<ph id=\"ph2\">&lt;/a&gt;</ph> site.",
      "pos": [
        9603,
        9767
      ]
    },
    {
      "content": "Here are links to the six samples discussed in the topic:",
      "pos": [
        9769,
        9826
      ]
    },
    {
      "pos": [
        9831,
        9992
      ],
      "content": "<ph id=\"ph1\">&lt;a href=\"#Scenario1\"&gt;</ph><bpt id=\"p1\">**</bpt>Serialization with reflection<ept id=\"p1\">**</ept><ph id=\"ph2\">&lt;/a&gt;</ph> - The JSON schema for types to be serialized is automatically built from the data contract attributes."
    },
    {
      "pos": [
        9996,
        10159
      ],
      "content": "<ph id=\"ph1\">&lt;a href=\"#Scenario2\"&gt;</ph><bpt id=\"p1\">**</bpt>Serialization with generic record<ept id=\"p1\">**</ept><ph id=\"ph2\">&lt;/a&gt;</ph> - The JSON schema is explicitly specified in a record when no .NET type is available for reflection."
    },
    {
      "pos": [
        10163,
        10371
      ],
      "content": "<ph id=\"ph1\">&lt;a href=\"#Scenario3\"&gt;</ph><bpt id=\"p1\">**</bpt>Serialization using object container files with reflection<ept id=\"p1\">**</ept><ph id=\"ph2\">&lt;/a&gt;</ph> - The JSON schema is automatically built and shared together with the serialized data via an Avro object container file."
    },
    {
      "pos": [
        10375,
        10602
      ],
      "content": "<ph id=\"ph1\">&lt;a href=\"#Scenario4\"&gt;</ph><bpt id=\"p1\">**</bpt>Serialization using object container files with generic record<ept id=\"p1\">**</ept><ph id=\"ph2\">&lt;/a&gt;</ph> - The JSON schema is explicitly specified before the serialization and shared together with the data via an Avro object container file."
    },
    {
      "pos": [
        10606,
        10850
      ],
      "content": "<ph id=\"ph1\">&lt;a href=\"#Scenario5\"&gt;</ph><bpt id=\"p1\">**</bpt>Serialization using object container files with a custom compression codec<ept id=\"p1\">**</ept><ph id=\"ph2\">&lt;/a&gt;</ph> - The example shows how to create an Avro object container file with a customized .NET implementation of the Deflate data compression codec."
    },
    {
      "content": "<ph id=\"ph1\">&lt;a href=\"#Scenario6\"&gt;</ph><bpt id=\"p1\">**</bpt>Using Avro to upload data for the Microsoft Azure HDInsight service<ept id=\"p1\">**</ept><ph id=\"ph2\">&lt;/a&gt;</ph> - The example illustrates how Avro serialization interacts with the HDInsight service.",
      "pos": [
        10854,
        11037
      ]
    },
    {
      "content": "An active Azure subscription and access to an Azure HDInsight cluster are required to run this example.",
      "pos": [
        11038,
        11141
      ]
    },
    {
      "pos": [
        11146,
        11209
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"Scenario1\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Sample 1: Serialization with reflection"
    },
    {
      "content": "The JSON schema for the types can be automatically built by the Microsoft Avro Library via reflection from the data contract attributes of the C# objects to be serialized.",
      "pos": [
        11211,
        11382
      ]
    },
    {
      "content": "The Microsoft Avro Library creates an <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>IAvroSeralizer<ph id=\"ph1\">&lt;T&gt;</ph><ept id=\"p2\">**</ept><ept id=\"p1\">](http://msdn.microsoft.com/library/dn627341.aspx)</ept> to identify the fields to be serialized.",
      "pos": [
        11383,
        11534
      ]
    },
    {
      "content": "In this example, objects (a <bpt id=\"p1\">**</bpt>SensorData<ept id=\"p1\">**</ept> class with a member <bpt id=\"p2\">**</bpt>Location<ept id=\"p2\">**</ept> struct) are serialized to a memory stream, and this stream is in turn deserialized.",
      "pos": [
        11536,
        11695
      ]
    },
    {
      "content": "The result is then compared to the initial instance to confirm that the <bpt id=\"p1\">**</bpt>SensorData<ept id=\"p1\">**</ept> object recovered is identical to the original.",
      "pos": [
        11696,
        11829
      ]
    },
    {
      "content": "The schema in this example is assumed to be shared between the readers and writers, so the Avro object container format is not required.",
      "pos": [
        11831,
        11967
      ]
    },
    {
      "content": "For an example of how to serialize and deserialize data into memory buffers by using reflection with the object container format when the schema must be shared with the data, see <ph id=\"ph1\">&lt;a href=\"#Scenario3\"&gt;</ph>Serialization using object container files with reflection<ph id=\"ph2\">&lt;/a&gt;</ph>.",
      "pos": [
        11968,
        12231
      ]
    },
    {
      "pos": [
        16559,
        16628
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"Scenario2\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Sample 2: Serialization with a generic record"
    },
    {
      "content": "A JSON schema can be explicitly specified in a generic record when reflection cannot be used because the data cannot be represented via .NET classes with a data contract.",
      "pos": [
        16630,
        16800
      ]
    },
    {
      "content": "This method is generally slower than using reflection.",
      "pos": [
        16801,
        16855
      ]
    },
    {
      "content": "In such cases, the schema for the data may also be dynamic, i.e., not be known at compile time.",
      "pos": [
        16856,
        16951
      ]
    },
    {
      "content": "Data represented as comma-separated values (CSV) files whose schema is unknown until it is transformed to the Avro format at run time is an example of this sort of dynamic scenario.",
      "pos": [
        16952,
        17133
      ]
    },
    {
      "content": "This example shows how to create and use an <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>AvroRecord<ept id=\"p2\">**</ept><ept id=\"p1\">](http://msdn.microsoft.com/library/microsoft.hadoop.avro.avrorecord.aspx)</ept> to explicitly specify a JSON schema, how to populate it with the data, and then how to serialize and deserialize it.",
      "pos": [
        17135,
        17385
      ]
    },
    {
      "content": "The result is then compared to the initial instance to confirm that the record recovered is identical to the original.",
      "pos": [
        17386,
        17504
      ]
    },
    {
      "content": "The schema in this example is assumed to be shared between the readers and writers, so the Avro object container format is not required.",
      "pos": [
        17506,
        17642
      ]
    },
    {
      "content": "For an example of how to serialize and deserialize data into memory buffers by using a generic record with the object container format when the schema must be included with the serialized data, see the <ph id=\"ph1\">&lt;a href=\"#Scenario4\"&gt;</ph>Serialization using object container files with generic record<ph id=\"ph2\">&lt;/a&gt;</ph> example.",
      "pos": [
        17643,
        17941
      ]
    },
    {
      "pos": [
        22947,
        23057
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"Scenario3\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Sample 3: Serialization using object container files and serialization with reflection"
    },
    {
      "content": "This example is similar to the scenario in the <ph id=\"ph1\">&lt;a href=\"#Scenario1\"&gt;</ph> first example<ph id=\"ph2\">&lt;/a&gt;</ph>, where the schema is implicitly specified with reflection.",
      "pos": [
        23059,
        23204
      ]
    },
    {
      "content": "The difference is that here, the schema is not assumed to be known to the reader that deserializes it.",
      "pos": [
        23205,
        23307
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>SensorData<ept id=\"p1\">**</ept> objects to be serialized and their implicitly specified schema are stored in an Avro object container file represented by the <bpt id=\"p2\">[</bpt><bpt id=\"p3\">**</bpt>AvroContainer<ept id=\"p3\">**</ept><ept id=\"p2\">](http://msdn.microsoft.com/library/microsoft.hadoop.avro.container.avrocontainer.aspx)</ept> class.",
      "pos": [
        23308,
        23565
      ]
    },
    {
      "content": "The data is serialized in this example with <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SequentialWriter<ph id=\"ph1\">&lt;SensorData&gt;</ph><ept id=\"p2\">**</ept><ept id=\"p1\">](http://msdn.microsoft.com/library/dn627340.aspx)</ept> and deserialized with <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>SequentialReader<ph id=\"ph2\">&lt;SensorData&gt;</ph><ept id=\"p4\">**</ept><ept id=\"p3\">](http://msdn.microsoft.com/library/dn627340.aspx)</ept>.",
      "pos": [
        23567,
        23801
      ]
    },
    {
      "content": "The result then is compared to the initial instances to ensure identity.",
      "pos": [
        23802,
        23874
      ]
    },
    {
      "content": "The data in the object container file is compressed via the default <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>Deflate<ept id=\"p2\">**</ept><ept id=\"p1\">][deflate-100]</ept> compression codec from .NET Framework 4.",
      "pos": [
        23876,
        24011
      ]
    },
    {
      "content": "See the <ph id=\"ph1\">&lt;a href=\"#Scenario5\"&gt;</ph> fifth example<ph id=\"ph2\">&lt;/a&gt;</ph> in this topic to learn how to use a more recent and superior version of the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>Deflate<ept id=\"p2\">**</ept><ept id=\"p1\">][deflate-110]</ept> compression codec available in .NET Framework 4.5.",
      "pos": [
        24012,
        24213
      ]
    },
    {
      "pos": [
        33596,
        33710
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"Scenario4\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Sample 4: Serialization using object container files and serialization with generic record"
    },
    {
      "content": "This example is similar to the scenario in the <ph id=\"ph1\">&lt;a href=\"#Scenario2\"&gt;</ph> second example<ph id=\"ph2\">&lt;/a&gt;</ph>, where the schema is explicitly specified with JSON.",
      "pos": [
        33712,
        33852
      ]
    },
    {
      "content": "The difference is that here, the schema is not assumed to be known to the reader that deserializes it.",
      "pos": [
        33853,
        33955
      ]
    },
    {
      "content": "The test data set is collected into a list of <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>AvroRecord<ept id=\"p2\">**</ept><ept id=\"p1\">](http://msdn.microsoft.com/library/microsoft.hadoop.avro.avrorecord.aspx)</ept> objects via an explicitly defined JSON schema and then stored in an object container file represented by the <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>AvroContainer<ept id=\"p4\">**</ept><ept id=\"p3\">](http://msdn.microsoft.com/library/microsoft.hadoop.avro.container.avrocontainer.aspx)</ept> class.",
      "pos": [
        33957,
        34314
      ]
    },
    {
      "content": "This container file creates a writer that is used to serialize the data, uncompressed, to a memory stream that is then saved to a file.",
      "pos": [
        34315,
        34450
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>Codec.Null<ept id=\"p2\">**</ept><ept id=\"p1\">](http://msdn.microsoft.com/library/microsoft.hadoop.avro.container.codec.null.aspx)</ept> parameter used for creating the reader specifies that this data will not be compressed.",
      "pos": [
        34451,
        34642
      ]
    },
    {
      "content": "The data is then read from the file and deserialized into a collection of objects.",
      "pos": [
        34644,
        34726
      ]
    },
    {
      "content": "This collection is compared to the initial list of Avro records to confirm that they are identical.",
      "pos": [
        34727,
        34826
      ]
    },
    {
      "pos": [
        45956,
        46064
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"Scenario5\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Sample 5: Serialization using object container files with a custom compression codec"
    },
    {
      "content": "The fifth example shows how to how to use a custom compression codec for Avro object container files.",
      "pos": [
        46066,
        46167
      ]
    },
    {
      "content": "A sample containing the code for this example can be downloaded from the <bpt id=\"p1\">[</bpt>Azure code samples<ept id=\"p1\">](http://code.msdn.microsoft.com/windowsazure/Serialize-data-with-the-67159111)</ept> site.",
      "pos": [
        46168,
        46345
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>Avro Specification<ept id=\"p1\">](http://avro.apache.org/docs/current/spec.html#Required+Codecs)</ept> allows usage of an optional compression codec (in addition to <bpt id=\"p2\">**</bpt>Null<ept id=\"p2\">**</ept> and <bpt id=\"p3\">**</bpt>Deflate<ept id=\"p3\">**</ept> defaults).",
      "pos": [
        46347,
        46532
      ]
    },
    {
      "content": "This example is not implementing a completely new codec such as Snappy (mentioned as a supported optional codec in the <bpt id=\"p1\">[</bpt>Avro Specification<ept id=\"p1\">](http://avro.apache.org/docs/current/spec.html#snappy)</ept>).",
      "pos": [
        46533,
        46728
      ]
    },
    {
      "content": "It shows how to use the .NET Framework 4.5 implementation of the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>Deflate<ept id=\"p2\">**</ept><ept id=\"p1\">][deflate-110]</ept> codec, which provides a better compression algorithm based on the <bpt id=\"p3\">[</bpt>zlib<ept id=\"p3\">](http://zlib.net/)</ept> compression library than the default .NET Framework 4 version.",
      "pos": [
        46729,
        46974
      ]
    },
    {
      "pos": [
        65800,
        65901
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"Scenario6\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Sample 6: Using Avro to upload data for the Microsoft Azure HDInsight service"
    },
    {
      "content": "The sixth example illustrates some programming techniques related to interacting with the Azure HDInsight service.",
      "pos": [
        65903,
        66017
      ]
    },
    {
      "content": "A sample containing the code for this example can be downloaded from the <bpt id=\"p1\">[</bpt>Azure code samples<ept id=\"p1\">](https://code.msdn.microsoft.com/windowsazure/Using-Avro-to-upload-data-ae81b1e3)</ept> site.",
      "pos": [
        66018,
        66198
      ]
    },
    {
      "content": "The sample does the following:",
      "pos": [
        66200,
        66230
      ]
    },
    {
      "content": "Connects to an existing HDInsight service cluster.",
      "pos": [
        66234,
        66284
      ]
    },
    {
      "content": "Serializes several CSV files and uploads the result to Azure Blob storage.",
      "pos": [
        66287,
        66361
      ]
    },
    {
      "content": "(The CSV files are distributed together with the sample and represent an extract from AMEX Stock historical data distributed by <bpt id=\"p1\">[</bpt>Infochimps<ept id=\"p1\">](http://www.infochimps.com/)</ept> for the period 1970-2010.",
      "pos": [
        66362,
        66556
      ]
    },
    {
      "content": "The sample reads CSV file data, converts the records to instances of the <bpt id=\"p1\">**</bpt>Stock<ept id=\"p1\">**</ept> class, and then serializes them by using reflection.",
      "pos": [
        66557,
        66692
      ]
    },
    {
      "content": "Stock type definition is created from a JSON schema via the Microsoft Avro Library code generation utility.",
      "pos": [
        66693,
        66800
      ]
    },
    {
      "pos": [
        66803,
        66914
      ],
      "content": "Creates a new external table called <bpt id=\"p1\">**</bpt>Stocks<ept id=\"p1\">**</ept> in Hive, and links it to the data uploaded in the previous step."
    },
    {
      "pos": [
        66917,
        66974
      ],
      "content": "Executes a query by using Hive over the <bpt id=\"p1\">**</bpt>Stocks<ept id=\"p1\">**</ept> table."
    },
    {
      "content": "In addition, the sample performs a clean-up procedure before and after performing major operations.",
      "pos": [
        66976,
        67075
      ]
    },
    {
      "content": "During the clean-up, all of the related Azure Blob data and folders are removed, and the Hive table is dropped.",
      "pos": [
        67076,
        67187
      ]
    },
    {
      "content": "You can also invoke the clean-up procedure from the sample command line.",
      "pos": [
        67188,
        67260
      ]
    },
    {
      "content": "The sample has the following prerequisites:",
      "pos": [
        67262,
        67305
      ]
    },
    {
      "content": "An active Microsoft Azure subscription and its subscription ID.",
      "pos": [
        67309,
        67372
      ]
    },
    {
      "content": "A management certificate for the subscription with the corresponding private key.",
      "pos": [
        67375,
        67456
      ]
    },
    {
      "content": "The certificate should be installed in the current user private storage on the machine used to run the sample.",
      "pos": [
        67457,
        67567
      ]
    },
    {
      "content": "An active HDInsight cluster.",
      "pos": [
        67570,
        67598
      ]
    },
    {
      "content": "An Azure Storage account linked to the HDInsight cluster from the previous prerequisite, together with the corresponding primary or secondary access key.",
      "pos": [
        67601,
        67754
      ]
    },
    {
      "content": "All of the information from the prerequisites should be entered to the sample configuration file before the sample is run.",
      "pos": [
        67756,
        67878
      ]
    },
    {
      "content": "There are two possible ways to do it:",
      "pos": [
        67879,
        67916
      ]
    },
    {
      "content": "Edit the app.config file in the sample root directory and then build the sample",
      "pos": [
        67920,
        67999
      ]
    },
    {
      "content": "First build the sample, and then edit AvroHDISample.exe.config in the build directory",
      "pos": [
        68002,
        68087
      ]
    },
    {
      "content": "In both cases all edits should be done in the <bpt id=\"p1\">**</bpt><ph id=\"ph1\">&lt;appSettings&gt;</ph><ept id=\"p1\">**</ept> settings section.",
      "pos": [
        68089,
        68170
      ]
    },
    {
      "content": "Please follow the comments in the file.",
      "pos": [
        68171,
        68210
      ]
    },
    {
      "content": "The sample is run from the command line by executing the following command (where the .zip file with the sample was assumed to be extracted to C:\\AvroHDISample; if otherwise, use the relevant file path):",
      "pos": [
        68211,
        68414
      ]
    },
    {
      "content": "To clean up the cluster, run the following command:",
      "pos": [
        68461,
        68512
      ]
    },
    {
      "content": "test",
      "pos": [
        68743,
        68747
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"Serialize data with the Microsoft Avro Library | Microsoft Azure\"\n    description=\"Learn how Azure HDInsight uses Avro to serialize big data.\"\n    services=\"hdinsight\"\n    documentationCenter=\"\"\n    tags=\"azure-portal\"\n    authors=\"mumian\" \n    manager=\"paulettm\"\n    editor=\"cgronlun\"/>\n\n<tags\n    ms.service=\"hdinsight\"\n    ms.workload=\"big-data\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.date=\"07/09/2015\"\n    ms.author=\"jgao\"/>\n\n\n# Serialize data in Hadoop with the Microsoft Avro Library\n\nThis topic shows how to use the <a href=\"https://hadoopsdk.codeplex.com/wikipage?title=Avro%20Library\" target=\"_blank\">Microsoft Avro Library</a> to serialize objects and other data structures into streams in order to persist them to memory, a database, or a file, and also how to deserialize them to recover the original objects.\n\n\n##<a name=\"apacheAvro\"></a>Apache Avro\nThe <a href=\"https://hadoopsdk.codeplex.com/wikipage?title=Avro%20Library\" target=\"_blank\">Microsoft Avro Library</a> implements the Apache Avro data serialization system for the Microsoft.NET environment. Apache Avro provides a compact binary data interchange format for serialization. It uses <a href=\"http://www.json.org\" target=\"_blank\">JSON</a> to define a language-agnostic schema that underwrites language interoperability. Data serialized in one language can be read in another. Currently C, C++, C#, Java, PHP, Python, and Ruby are supported. Detailed information on the format can be found in the <a href=\"http://avro.apache.org/docs/current/spec.html\" target=\"_blank\">Apache Avro Specification</a>. Note that the current version of the Microsoft Avro Library does not support the remote procedure calls (RPCs) part of this specification.\n\nThe serialized representation of an object in the Avro system consists of two parts: schema and actual value. The Avro schema describes the language-independent data model of the serialized data with JSON. It is present side-by-side with a binary representation of data. Having the schema separate from the binary representation permits each object to be written with no per-value overheads, making serialization fast and the representation small.\n\n##<a name=\"hadoopScenario\"></a>The Hadoop scenario\nThe Apache Avro serialization format is widely used in Azure HDInsight and other Apache Hadoop environments. Avro provides a convenient way to represent complex data structures within a Hadoop MapReduce job. The format of Avro files (Avro object container file) has been designed to support the distributed MapReduce programming model. The key feature that enables the distribution is that the files are “splittable” in the sense that one can seek any point in a file and start reading from a particular block.\n\n##<a name=\"serializationMAL\"></a>Serialization in the Microsoft Avro Library\nThe .NET Library for Avro supports two ways of serializing objects:\n\n- **reflection** - The JSON schema for the types is automatically built from the data contract attributes of the .NET types to be serialized.\n- **generic record** - A JSON schema is explicitly specified in a record represented by the [**AvroRecord**](http://msdn.microsoft.com/library/microsoft.hadoop.avro.avrorecord.aspx) class when no .NET types are present to describe the schema for the data to be serialized.\n\nWhen the data schema is known to both the writer and reader of the stream, the data can be sent without its schema. In cases when an Avro object container file is used, the schema is stored within the file. Other parameters, such as the codec used for data compression, can be specified. These scenarios are outlined in more detail and illustrated in the code examples below.\n\n\n##<a name=\"prerequisites\"></a> Microsoft Avro Library prerequisites\n\n- <a href=\"http://www.microsoft.com/download/details.aspx?id=17851\" target=\"_blank\">Microsoft .NET Framework 4</a>\n- <a href=\"http://james.newtonking.com/json\" target=\"_blank\">Newtonsoft Json.NET</a> (6.0.4 or later)\n\nNote that the Newtonsoft.Json.dll dependency is downloaded automatically with the installation of the Microsoft Avro Library. The procedure for this is provided in the following section.\n\n##<a name=\"installation\"></a> Microsoft Avro Library installation\nThe Microsoft Avro Library is distributed as a NuGet package that can be installed from Visual Studio via the following procedure:\n\n1. Select the **Project** tab -> **Manage NuGet Packages...**\n2. Search for \"Microsoft.Hadoop.Avro\" in the **Search Online** box.\n3. Click the **Install** button next to **Microsoft Azure HDInsight Avro Library**.\n\nNote that the Newtonsoft.Json.dll (>=6.0.4) dependency is also downloaded automatically with the Microsoft Avro Library.\n\nYou may want to visit the <a href=\"https://hadoopsdk.codeplex.com/wikipage?title=Avro%20Library\" target=\"_blank\">Microsoft Avro Library home page</a> to read the current release notes.\n\n##<a name=\"sourceCode\"></a>Microsoft Avro Library source code\n\nThe Microsoft Avro Library source code is available at the <a href=\"https://hadoopsdk.codeplex.com/wikipage?title=Avro%20Library\" target=\"_blank\">Microsoft Avro Library home page</a>.\n\n##<a name=\"compiling\"></a>Compiling the schema by using the Microsoft Avro Library\n\nThe Microsoft Avro Library contains a code generation utility that allows creating C# types automatically based on the previously defined JSON schema. The code generation utility is not distributed as a binary executable, but can be easily built via the following procedure:\n\n1. Download the .zip file with the latest version of HDInsight SDK source code from <a href=\"http://hadoopsdk.codeplex.com/SourceControl/latest\" target=\"_blank\">Microsoft .NET SDK For Hadoop</a>. (Click the **Download** icon.)\n\n2. Extract the HDInsight SDK to a directory on the machine with .NET Framework 4 installed and connected to the Internet for downloading necessary dependency NuGet packages. Below we will assume that the source code is extracted to C:\\SDK.\n\n3. Go to the folder C:\\SDK\\src\\Microsoft.Hadoop.Avro.Tools and run build.bat. (The file will call MSBuild from the 32-bit distribution of the .NET Framework. If you would like to use the 64-bit version, edit build.bat, following the comments inside the file.) Ensure that the build is successful. (On some systems, MSBuild may produce warnings. These warnings do not affect the utility as long as there are no build errors.)\n\n4. The compiled utility is located in C:\\SDK\\Bin\\Unsigned\\Release\\Microsoft.Hadoop.Avro.Tools.\n\n\nTo get familiar with the command-line syntax, execute the following command from the folder where the code generation utility is located: `Microsoft.Hadoop.Avro.Tools help /c:codegen`\n\nTo test the utility, you can generate C# classes from the sample JSON schema file provided with the source code. Execute the following command:\n\n    Microsoft.Hadoop.Avro.Tools codegen /i:C:\\SDK\\src\\Microsoft.Hadoop.Avro.Tools\\SampleJSON\\SampleJSONSchema.avsc /o:\n\nThis is supposed to produce two C# files in the current directory: SensorData.cs and Location.cs.\n\nTo understand the logic that the code generation utility is using while converting the JSON schema to C# types, see the file GenerationVerification.feature located in C:\\SDK\\src\\Microsoft.Hadoop.Avro.Tools\\Doc.\n\nPlease note that namespaces are extracted from the JSON schema, using the logic described in the file mentioned in the previous paragraph. Namespaces extracted from the schema take precedence over whatever is provided with the /n parameter in the utility command line. If you want to override the namespaces contained within the schema, use the /nf parameter. For example, to change all namespaces from the SampleJSONSchema.avsc to my.own.nspace, execute the following command:\n\n    Microsoft.Hadoop.Avro.Tools codegen /i:C:\\SDK\\src\\Microsoft.Hadoop.Avro.Tools\\SampleJSON\\SampleJSONSchema.avsc /o:. /nf:my.own.nspace\n\n##<a name=\"samples\"></a>Guide to the samples for the Microsoft Avro Library\nSix examples provided in this topic illustrate different scenarios supported by the Microsoft Avro Library. The Microsoft Avro Library is designed to work with any stream. In these examples, data is manipulated via memory streams rather than file streams or databases for simplicity and consistency. The approach taken in a production environment will depend on the exact scenario requirements, data source and volume, performance constraints, and other factors.\n\nThe first two examples show how to serialize and deserialize data into memory stream buffers by using reflection and generic records. The schema in these two cases is assumed to be shared between the readers and writers out-of-band.\n\nThe third and fourth examples show how to serialize and deserialize data by using the Avro object container files. When data is stored in an Avro container file, its schema is always stored with it because the schema must be shared for deserialization.\n\nThe sample containing the first four examples can be downloaded from the <a href=\"http://code.msdn.microsoft.com/windowsazure/Serialize-data-with-the-86055923\" target=\"_blank\">Azure code samples</a> site.\n\nThe fifth example shows how to how to use a custom compression codec for Avro object container files. A sample containing the code for this example can be downloaded from the <a href=\"http://code.msdn.microsoft.com/windowsazure/Serialize-data-with-the-67159111\" target=\"_blank\">Azure code samples</a> site.\n\nThe sixth sample shows how to use Avro serialization to upload data to Azure Blob storage and then analyze it by using Hive with an HDInsight (Hadoop) cluster. It can be downloaded from the <a href=\"https://code.msdn.microsoft.com/windowsazure/Using-Avro-to-upload-data-ae81b1e3\" target=\"_blank\">Azure code samples</a> site.\n\nHere are links to the six samples discussed in the topic:\n\n * <a href=\"#Scenario1\">**Serialization with reflection**</a> - The JSON schema for types to be serialized is automatically built from the data contract attributes.\n * <a href=\"#Scenario2\">**Serialization with generic record**</a> - The JSON schema is explicitly specified in a record when no .NET type is available for reflection.\n * <a href=\"#Scenario3\">**Serialization using object container files with reflection**</a> - The JSON schema is automatically built and shared together with the serialized data via an Avro object container file.\n * <a href=\"#Scenario4\">**Serialization using object container files with generic record**</a> - The JSON schema is explicitly specified before the serialization and shared together with the data via an Avro object container file.\n * <a href=\"#Scenario5\">**Serialization using object container files with a custom compression codec**</a> - The example shows how to create an Avro object container file with a customized .NET implementation of the Deflate data compression codec.\n * <a href=\"#Scenario6\">**Using Avro to upload data for the Microsoft Azure HDInsight service**</a> - The example illustrates how Avro serialization interacts with the HDInsight service. An active Azure subscription and access to an Azure HDInsight cluster are required to run this example.\n\n###<a name=\"Scenario1\"></a>Sample 1: Serialization with reflection\n\nThe JSON schema for the types can be automatically built by the Microsoft Avro Library via reflection from the data contract attributes of the C# objects to be serialized. The Microsoft Avro Library creates an [**IAvroSeralizer<T>**](http://msdn.microsoft.com/library/dn627341.aspx) to identify the fields to be serialized.\n\nIn this example, objects (a **SensorData** class with a member **Location** struct) are serialized to a memory stream, and this stream is in turn deserialized. The result is then compared to the initial instance to confirm that the **SensorData** object recovered is identical to the original.\n\nThe schema in this example is assumed to be shared between the readers and writers, so the Avro object container format is not required. For an example of how to serialize and deserialize data into memory buffers by using reflection with the object container format when the schema must be shared with the data, see <a href=\"#Scenario3\">Serialization using object container files with reflection</a>.\n\n    namespace Microsoft.Hadoop.Avro.Sample\n    {\n        using System;\n        using System.Collections.Generic;\n        using System.IO;\n        using System.Linq;\n        using System.Runtime.Serialization;\n        using Microsoft.Hadoop.Avro.Container;\n        using Microsoft.Hadoop.Avro;\n\n        //Sample class used in serialization samples\n        [DataContract(Name = \"SensorDataValue\", Namespace = \"Sensors\")]\n        internal class SensorData\n        {\n            [DataMember(Name = \"Location\")]\n            public Location Position { get; set; }\n\n            [DataMember(Name = \"Value\")]\n            public byte[] Value { get; set; }\n        }\n\n        //Sample struct used in serialization samples\n        [DataContract]\n        internal struct Location\n        {\n            [DataMember]\n            public int Floor { get; set; }\n\n            [DataMember]\n            public int Room { get; set; }\n        }\n\n        //This class contains all methods demonstrating\n        //the usage of Microsoft Avro Library\n        public class AvroSample\n        {\n\n            //Serialize and deserialize sample data set represented as an object using reflection.\n            //No explicit schema definition is required - schema of serialized objects is automatically built.\n            public void SerializeDeserializeObjectUsingReflection()\n            {\n\n                Console.WriteLine(\"SERIALIZATION USING REFLECTION\\n\");\n                Console.WriteLine(\"Serializing Sample Data Set...\");\n\n                //Create a new AvroSerializer instance and specify a custom serialization strategy AvroDataContractResolver\n                //for serializing only properties attributed with DataContract/DateMember\n                var avroSerializer = AvroSerializer.Create<SensorData>();\n\n                //Create a memory stream buffer\n                using (var buffer = new MemoryStream())\n                {\n                    //Create a data set by using sample class and struct\n                    var expected = new SensorData { Value = new byte[] { 1, 2, 3, 4, 5 }, Position = new Location { Room = 243, Floor = 1 } };\n\n                    //Serialize the data to the specified stream\n                    avroSerializer.Serialize(buffer, expected);\n\n\n                    Console.WriteLine(\"Deserializing Sample Data Set...\");\n\n                    //Prepare the stream for deserializing the data\n                    buffer.Seek(0, SeekOrigin.Begin);\n\n                    //Deserialize data from the stream and cast it to the same type used for serialization\n                    var actual = avroSerializer.Deserialize(buffer);\n\n                    Console.WriteLine(\"Comparing Initial and Deserialized Data Sets...\");\n\n                    //Finally, verify that deserialized data matches the original one\n                    bool isEqual = this.Equal(expected, actual);\n\n                    Console.WriteLine(\"Result of Data Set Identity Comparison is {0}\", isEqual);\n\n                }\n            }\n\n            //\n            //Helper methods\n            //\n\n            //Comparing two SensorData objects\n            private bool Equal(SensorData left, SensorData right)\n            {\n                return left.Position.Equals(right.Position) && left.Value.SequenceEqual(right.Value);\n            }\n\n\n\n            static void Main()\n            {\n\n                string sectionDivider = \"---------------------------------------- \";\n\n                //Create an instance of AvroSample Class and invoke methods\n                //illustrating different serializing approaches\n                AvroSample Sample = new AvroSample();\n\n                //Serialization to memory using reflection\n                Sample.SerializeDeserializeObjectUsingReflection();\n\n                Console.WriteLine(sectionDivider);\n                Console.WriteLine(\"Press any key to exit.\");\n                Console.Read();\n            }\n        }\n    }\n    // The example is expected to display the following output:\n    // SERIALIZATION USING REFLECTION\n    //\n    // Serializing Sample Data Set...\n    // Deserializing Sample Data Set...\n    // Comparing Initial and Deserialized Data Sets...\n    // Result of Data Set Identity Comparison is True\n    // ----------------------------------------\n    // Press any key to exit.\n\n\n###<a name=\"Scenario2\"></a>Sample 2: Serialization with a generic record\n\nA JSON schema can be explicitly specified in a generic record when reflection cannot be used because the data cannot be represented via .NET classes with a data contract. This method is generally slower than using reflection. In such cases, the schema for the data may also be dynamic, i.e., not be known at compile time. Data represented as comma-separated values (CSV) files whose schema is unknown until it is transformed to the Avro format at run time is an example of this sort of dynamic scenario.\n\nThis example shows how to create and use an [**AvroRecord**](http://msdn.microsoft.com/library/microsoft.hadoop.avro.avrorecord.aspx) to explicitly specify a JSON schema, how to populate it with the data, and then how to serialize and deserialize it. The result is then compared to the initial instance to confirm that the record recovered is identical to the original.\n\nThe schema in this example is assumed to be shared between the readers and writers, so the Avro object container format is not required. For an example of how to serialize and deserialize data into memory buffers by using a generic record with the object container format when the schema must be included with the serialized data, see the <a href=\"#Scenario4\">Serialization using object container files with generic record</a> example.\n\n\n    namespace Microsoft.Hadoop.Avro.Sample\n    {\n    using System;\n    using System.Collections.Generic;\n    using System.IO;\n    using System.Linq;\n    using System.Runtime.Serialization;\n    using Microsoft.Hadoop.Avro.Container;\n    using Microsoft.Hadoop.Avro.Schema;\n    using Microsoft.Hadoop.Avro;\n\n    //This class contains all methods demonstrating\n    //the usage of Microsoft Avro Library\n    public class AvroSample\n    {\n\n        //Serialize and deserialize sample data set by using a generic record.\n        //A generic record is a special class with the schema explicitly defined in JSON.\n        //All serialized data should be mapped to the fields of the generic record,\n        //which in turn will be then serialized.\n        public void SerializeDeserializeObjectUsingGenericRecords()\n        {\n            Console.WriteLine(\"SERIALIZATION USING GENERIC RECORD\\n\");\n            Console.WriteLine(\"Defining the Schema and creating Sample Data Set...\");\n\n            //Define the schema in JSON\n            const string Schema = @\"{\n                                \"\"type\"\":\"\"record\"\",\n                                \"\"name\"\":\"\"Microsoft.Hadoop.Avro.Specifications.SensorData\"\",\n                                \"\"fields\"\":\n                                    [\n                                        {\n                                            \"\"name\"\":\"\"Location\"\",\n                                            \"\"type\"\":\n                                                {\n                                                    \"\"type\"\":\"\"record\"\",\n                                                    \"\"name\"\":\"\"Microsoft.Hadoop.Avro.Specifications.Location\"\",\n                                                    \"\"fields\"\":\n                                                        [\n                                                            { \"\"name\"\":\"\"Floor\"\", \"\"type\"\":\"\"int\"\" },\n                                                            { \"\"name\"\":\"\"Room\"\", \"\"type\"\":\"\"int\"\" }\n                                                        ]\n                                                }\n                                        },\n                                        { \"\"name\"\":\"\"Value\"\", \"\"type\"\":\"\"bytes\"\" }\n                                    ]\n                            }\";\n\n            //Create a generic serializer based on the schema\n            var serializer = AvroSerializer.CreateGeneric(Schema);\n            var rootSchema = serializer.WriterSchema as RecordSchema;\n\n            //Create a memory stream buffer\n            using (var stream = new MemoryStream())\n            {\n                //Create a generic record to represent the data\n                dynamic location = new AvroRecord(rootSchema.GetField(\"Location\").TypeSchema);\n                location.Floor = 1;\n                location.Room = 243;\n\n                dynamic expected = new AvroRecord(serializer.WriterSchema);\n                expected.Location = location;\n                expected.Value = new byte[] { 1, 2, 3, 4, 5 };\n\n                Console.WriteLine(\"Serializing Sample Data Set...\");\n\n                //Serialize the data\n                serializer.Serialize(stream, expected);\n\n                stream.Seek(0, SeekOrigin.Begin);\n\n                Console.WriteLine(\"Deserializing Sample Data Set...\");\n\n                //Deserialize the data into a generic record\n                dynamic actual = serializer.Deserialize(stream);\n\n                Console.WriteLine(\"Comparing Initial and Deserialized Data Sets...\");\n\n                //Finally, verify the results\n                bool isEqual = expected.Location.Floor.Equals(actual.Location.Floor);\n                isEqual = isEqual && expected.Location.Room.Equals(actual.Location.Room);\n                isEqual = isEqual && ((byte[])expected.Value).SequenceEqual((byte[])actual.Value);\n                Console.WriteLine(\"Result of Data Set Identity Comparison is {0}\", isEqual);\n            }\n        }\n\n        static void Main()\n        {\n\n            string sectionDivider = \"---------------------------------------- \";\n\n            //Create an instance of AvroSample class and invoke methods\n            //illustrating different serializing approaches\n            AvroSample Sample = new AvroSample();\n\n            //Serialization to memory using generic record\n            Sample.SerializeDeserializeObjectUsingGenericRecords();\n\n            Console.WriteLine(sectionDivider);\n            Console.WriteLine(\"Press any key to exit.\");\n            Console.Read();\n        }\n    }\n    }\n    // The example is expected to display the following output:\n    // SERIALIZATION USING GENERIC RECORD\n    //\n    // Defining the Schema and creating Sample Data Set...\n    // Serializing Sample Data Set...\n    // Deserializing Sample Data Set...\n    // Comparing Initial and Deserialized Data Sets...\n    // Result of Data Set Identity Comparison is True\n    // ----------------------------------------\n    // Press any key to exit.\n\n\n###<a name=\"Scenario3\"></a>Sample 3: Serialization using object container files and serialization with reflection\n\nThis example is similar to the scenario in the <a href=\"#Scenario1\"> first example</a>, where the schema is implicitly specified with reflection. The difference is that here, the schema is not assumed to be known to the reader that deserializes it. The **SensorData** objects to be serialized and their implicitly specified schema are stored in an Avro object container file represented by the [**AvroContainer**](http://msdn.microsoft.com/library/microsoft.hadoop.avro.container.avrocontainer.aspx) class.\n\nThe data is serialized in this example with [**SequentialWriter<SensorData>**](http://msdn.microsoft.com/library/dn627340.aspx) and deserialized with [**SequentialReader<SensorData>**](http://msdn.microsoft.com/library/dn627340.aspx). The result then is compared to the initial instances to ensure identity.\n\nThe data in the object container file is compressed via the default [**Deflate**][deflate-100] compression codec from .NET Framework 4. See the <a href=\"#Scenario5\"> fifth example</a> in this topic to learn how to use a more recent and superior version of the [**Deflate**][deflate-110] compression codec available in .NET Framework 4.5.\n\n    namespace Microsoft.Hadoop.Avro.Sample\n    {\n        using System;\n        using System.Collections.Generic;\n        using System.IO;\n        using System.Linq;\n        using System.Runtime.Serialization;\n        using Microsoft.Hadoop.Avro.Container;\n        using Microsoft.Hadoop.Avro;\n\n        //Sample class used in serialization samples\n        [DataContract(Name = \"SensorDataValue\", Namespace = \"Sensors\")]\n        internal class SensorData\n        {\n            [DataMember(Name = \"Location\")]\n            public Location Position { get; set; }\n\n            [DataMember(Name = \"Value\")]\n            public byte[] Value { get; set; }\n        }\n\n        //Sample struct used in serialization samples\n        [DataContract]\n        internal struct Location\n        {\n            [DataMember]\n            public int Floor { get; set; }\n\n            [DataMember]\n            public int Room { get; set; }\n        }\n\n        //This class contains all methods demonstrating\n        //the usage of Microsoft Avro Library\n        public class AvroSample\n        {\n\n            //Serializes and deserializes the sample data set by using reflection and Avro object container files.\n            //Serialized data is compressed with the Deflate codec.\n            public void SerializeDeserializeUsingObjectContainersReflection()\n            {\n\n                Console.WriteLine(\"SERIALIZATION USING REFLECTION AND AVRO OBJECT CONTAINER FILES\\n\");\n\n                //Path for Avro object container file\n                string path = \"AvroSampleReflectionDeflate.avro\";\n\n                //Create a data set by using sample class and struct\n                var testData = new List<SensorData>\n                        {\n                            new SensorData { Value = new byte[] { 1, 2, 3, 4, 5 }, Position = new Location { Room = 243, Floor = 1 } },\n                            new SensorData { Value = new byte[] { 6, 7, 8, 9 }, Position = new Location { Room = 244, Floor = 1 } }\n                        };\n\n                //Serializing and saving data to file.\n                //Creating a memory stream buffer.\n                using (var buffer = new MemoryStream())\n                {\n                    Console.WriteLine(\"Serializing Sample Data Set...\");\n\n                    //Create a SequentialWriter instance for type SensorData, which can serialize a sequence of SensorData objects to stream.\n                    //Data will be compressed using the Deflate codec.\n                    using (var w = AvroContainer.CreateWriter<SensorData>(buffer, Codec.Deflate))\n                    {\n                        using (var writer = new SequentialWriter<SensorData>(w, 24))\n                        {\n                            // Serialize the data to stream by using the sequential writer\n                            testData.ForEach(writer.Write);\n                        }\n                    }\n\n                    //Save stream to file\n                    Console.WriteLine(\"Saving serialized data to file...\");\n                    if (!WriteFile(buffer, path))\n                    {\n                        Console.WriteLine(\"Error during file operation. Quitting method\");\n                        return;\n                    }\n                }\n\n                //Reading and deserializing data.\n                //Creating a memory stream buffer.\n                using (var buffer = new MemoryStream())\n                {\n                    Console.WriteLine(\"Reading data from file...\");\n\n                    //Reading data from object container file\n                    if (!ReadFile(buffer, path))\n                    {\n                        Console.WriteLine(\"Error during file operation. Quitting method\");\n                        return;\n                    }\n\n                    Console.WriteLine(\"Deserializing Sample Data Set...\");\n\n                    //Prepare the stream for deserializing the data\n                    buffer.Seek(0, SeekOrigin.Begin);\n\n                    //Create a SequentialReader instance for type SensorData, which will deserialize all serialized objects from the given stream.\n                    //It allows iterating over the deserialized objects because it implements the IEnumerable<T> interface.\n                    using (var reader = new SequentialReader<SensorData>(\n                        AvroContainer.CreateReader<SensorData>(buffer, true)))\n                    {\n                        var results = reader.Objects;\n\n                        //Finally, verify that deserialized data matches the original one\n                        Console.WriteLine(\"Comparing Initial and Deserialized Data Sets...\");\n                        int count = 1;\n                        var pairs = testData.Zip(results, (serialized, deserialized) => new { expected = serialized, actual = deserialized });\n                        foreach (var pair in pairs)\n                        {\n                            bool isEqual = this.Equal(pair.expected, pair.actual);\n                            Console.WriteLine(\"For Pair {0} result of Data Set Identity Comparison is {1}\", count, isEqual);\n                            count++;\n                        }\n                    }\n                }\n\n                //Delete the file\n                RemoveFile(path);\n            }\n\n            //\n            //Helper methods\n            //\n\n            //Comparing two SensorData objects\n            private bool Equal(SensorData left, SensorData right)\n            {\n                return left.Position.Equals(right.Position) && left.Value.SequenceEqual(right.Value);\n            }\n\n            //Saving memory stream to a new file with the given path\n            private bool WriteFile(MemoryStream InputStream, string path)\n            {\n                if (!File.Exists(path))\n                {\n                    try\n                    {\n                        using (FileStream fs = File.Create(path))\n                        {\n                            InputStream.Seek(0, SeekOrigin.Begin);\n                            InputStream.CopyTo(fs);\n                        }\n                        return true;\n                    }\n                    catch (Exception e)\n                    {\n                        Console.WriteLine(\"The following exception was thrown during creation and writing to the file \\\"{0}\\\"\", path);\n                        Console.WriteLine(e.Message);\n                        return false;\n                    }\n                }\n                else\n                {\n                    Console.WriteLine(\"Can not create file \\\"{0}\\\". File already exists\", path);\n                    return false;\n\n                }\n            }\n\n            //Reading a file content by using the given path to a memory stream\n            private bool ReadFile(MemoryStream OutputStream, string path)\n            {\n                try\n                {\n                    using (FileStream fs = File.Open(path, FileMode.Open))\n                    {\n                        fs.CopyTo(OutputStream);\n                    }\n                    return true;\n                }\n                catch (Exception e)\n                {\n                    Console.WriteLine(\"The following exception was thrown during reading from the file \\\"{0}\\\"\", path);\n                    Console.WriteLine(e.Message);\n                    return false;\n                }\n            }\n\n            //Deleting file by using given path\n            private void RemoveFile(string path)\n            {\n                if (File.Exists(path))\n                {\n                    try\n                    {\n                        File.Delete(path);\n                    }\n                    catch (Exception e)\n                    {\n                        Console.WriteLine(\"The following exception was thrown during deleting the file \\\"{0}\\\"\", path);\n                        Console.WriteLine(e.Message);\n                    }\n                }\n                else\n                {\n                    Console.WriteLine(\"Can not delete file \\\"{0}\\\". File does not exist\", path);\n                }\n            }\n\n            static void Main()\n            {\n\n                string sectionDivider = \"---------------------------------------- \";\n\n                //Create an instance of AvroSample class and invoke methods\n                //illustrating different serializing approaches\n                AvroSample Sample = new AvroSample();\n\n                //Serialization using reflection to Avro object container file\n                Sample.SerializeDeserializeUsingObjectContainersReflection();\n\n                Console.WriteLine(sectionDivider);\n                Console.WriteLine(\"Press any key to exit.\");\n                Console.Read();\n            }\n        }\n    }\n    // The example is expected to display the following output:\n    // SERIALIZATION USING REFLECTION AND AVRO OBJECT CONTAINER FILES\n    //\n    // Serializing Sample Data Set...\n    // Saving serialized data to file...\n    // Reading data from file...\n    // Deserializing Sample Data Set...\n    // Comparing Initial and Deserialized Data Sets...\n    // For Pair 1 result of Data Set Identity Comparison is True\n    // For Pair 2 result of Data Set Identity Comparison is True\n    // ----------------------------------------\n    // Press any key to exit.\n\n\n###<a name=\"Scenario4\"></a>Sample 4: Serialization using object container files and serialization with generic record\n\nThis example is similar to the scenario in the <a href=\"#Scenario2\"> second example</a>, where the schema is explicitly specified with JSON. The difference is that here, the schema is not assumed to be known to the reader that deserializes it.\n\nThe test data set is collected into a list of [**AvroRecord**](http://msdn.microsoft.com/library/microsoft.hadoop.avro.avrorecord.aspx) objects via an explicitly defined JSON schema and then stored in an object container file represented by the [**AvroContainer**](http://msdn.microsoft.com/library/microsoft.hadoop.avro.container.avrocontainer.aspx) class. This container file creates a writer that is used to serialize the data, uncompressed, to a memory stream that is then saved to a file. The [**Codec.Null**](http://msdn.microsoft.com/library/microsoft.hadoop.avro.container.codec.null.aspx) parameter used for creating the reader specifies that this data will not be compressed.\n\nThe data is then read from the file and deserialized into a collection of objects. This collection is compared to the initial list of Avro records to confirm that they are identical.\n\n\n    namespace Microsoft.Hadoop.Avro.Sample\n    {\n        using System;\n        using System.Collections.Generic;\n        using System.IO;\n        using System.Linq;\n        using System.Runtime.Serialization;\n        using Microsoft.Hadoop.Avro.Container;\n        using Microsoft.Hadoop.Avro.Schema;\n        using Microsoft.Hadoop.Avro;\n\n        //This class contains all methods demonstrating\n        //the usage of Microsoft Avro Library\n        public class AvroSample\n        {\n\n            //Serializes and deserializes a sample data set by using a generic record and Avro object container files.\n            //Serialized data is not compressed.\n            public void SerializeDeserializeUsingObjectContainersGenericRecord()\n            {\n                Console.WriteLine(\"SERIALIZATION USING GENERIC RECORD AND AVRO OBJECT CONTAINER FILES\\n\");\n\n                //Path for Avro object container file\n                string path = \"AvroSampleGenericRecordNullCodec.avro\";\n\n                Console.WriteLine(\"Defining the Schema and creating Sample Data Set...\");\n\n                //Define the schema in JSON\n                const string Schema = @\"{\n                                \"\"type\"\":\"\"record\"\",\n                                \"\"name\"\":\"\"Microsoft.Hadoop.Avro.Specifications.SensorData\"\",\n                                \"\"fields\"\":\n                                    [\n                                        {\n                                            \"\"name\"\":\"\"Location\"\",\n                                            \"\"type\"\":\n                                                {\n                                                    \"\"type\"\":\"\"record\"\",\n                                                    \"\"name\"\":\"\"Microsoft.Hadoop.Avro.Specifications.Location\"\",\n                                                    \"\"fields\"\":\n                                                        [\n                                                            { \"\"name\"\":\"\"Floor\"\", \"\"type\"\":\"\"int\"\" },\n                                                            { \"\"name\"\":\"\"Room\"\", \"\"type\"\":\"\"int\"\" }\n                                                        ]\n                                                }\n                                        },\n                                        { \"\"name\"\":\"\"Value\"\", \"\"type\"\":\"\"bytes\"\" }\n                                    ]\n                            }\";\n\n                //Create a generic serializer based on the schema\n                var serializer = AvroSerializer.CreateGeneric(Schema);\n                var rootSchema = serializer.WriterSchema as RecordSchema;\n\n                //Create a generic record to represent the data\n                var testData = new List<AvroRecord>();\n\n                dynamic expected1 = new AvroRecord(rootSchema);\n                dynamic location1 = new AvroRecord(rootSchema.GetField(\"Location\").TypeSchema);\n                location1.Floor = 1;\n                location1.Room = 243;\n                expected1.Location = location1;\n                expected1.Value = new byte[] { 1, 2, 3, 4, 5 };\n                testData.Add(expected1);\n\n                dynamic expected2 = new AvroRecord(rootSchema);\n                dynamic location2 = new AvroRecord(rootSchema.GetField(\"Location\").TypeSchema);\n                location2.Floor = 1;\n                location2.Room = 244;\n                expected2.Location = location2;\n                expected2.Value = new byte[] { 6, 7, 8, 9 };\n                testData.Add(expected2);\n\n                //Serializing and saving data to file.\n                //Create a MemoryStream buffer.\n                using (var buffer = new MemoryStream())\n                {\n                    Console.WriteLine(\"Serializing Sample Data Set...\");\n\n                    //Create a SequentialWriter instance for type SensorData, which can serialize a sequence of SensorData objects to stream.\n                    //Data will not be compressed (Null compression codec).\n                    using (var writer = AvroContainer.CreateGenericWriter(Schema, buffer, Codec.Null))\n                    {\n                        using (var streamWriter = new SequentialWriter<object>(writer, 24))\n                        {\n                            // Serialize the data to stream by using the sequential writer\n                            testData.ForEach(streamWriter.Write);\n                        }\n                    }\n\n                    Console.WriteLine(\"Saving serialized data to file...\");\n\n                    //Save stream to file\n                    if (!WriteFile(buffer, path))\n                    {\n                        Console.WriteLine(\"Error during file operation. Quitting method\");\n                        return;\n                    }\n                }\n\n                //Reading and deserializing the data.\n                //Create a memory stream buffer.\n                using (var buffer = new MemoryStream())\n                {\n                    Console.WriteLine(\"Reading data from file...\");\n\n                    //Reading data from object container file\n                    if (!ReadFile(buffer, path))\n                    {\n                        Console.WriteLine(\"Error during file operation. Quitting method\");\n                        return;\n                    }\n\n                    Console.WriteLine(\"Deserializing Sample Data Set...\");\n\n                    //Prepare the stream for deserializing the data\n                    buffer.Seek(0, SeekOrigin.Begin);\n\n                    //Create a SequentialReader instance for type SensorData, which will deserialize all serialized objects from the given stream.\n                    //It allows iterating over the deserialized objects because it implements the IEnumerable<T> interface.\n                    using (var reader = AvroContainer.CreateGenericReader(buffer))\n                    {\n                        using (var streamReader = new SequentialReader<object>(reader))\n                        {\n                            var results = streamReader.Objects;\n\n                            Console.WriteLine(\"Comparing Initial and Deserialized Data Sets...\");\n\n                            //Finally, verify the results\n                            var pairs = testData.Zip(results, (serialized, deserialized) => new { expected = (dynamic)serialized, actual = (dynamic)deserialized });\n                            int count = 1;\n                            foreach (var pair in pairs)\n                            {\n                                bool isEqual = pair.expected.Location.Floor.Equals(pair.actual.Location.Floor);\n                                isEqual = isEqual && pair.expected.Location.Room.Equals(pair.actual.Location.Room);\n                                isEqual = isEqual && ((byte[])pair.expected.Value).SequenceEqual((byte[])pair.actual.Value);\n                                Console.WriteLine(\"For Pair {0} result of Data Set Identity Comparison is {1}\", count, isEqual.ToString());\n                                count++;\n                            }\n                        }\n                    }\n                }\n\n                //Delete the file\n                RemoveFile(path);\n            }\n\n            //\n            //Helper methods\n            //\n\n            //Saving memory stream to a new file with the given path\n            private bool WriteFile(MemoryStream InputStream, string path)\n            {\n                if (!File.Exists(path))\n                {\n                    try\n                    {\n                        using (FileStream fs = File.Create(path))\n                        {\n                            InputStream.Seek(0, SeekOrigin.Begin);\n                            InputStream.CopyTo(fs);\n                        }\n                        return true;\n                    }\n                    catch (Exception e)\n                    {\n                        Console.WriteLine(\"The following exception was thrown during creation and writing to the file \\\"{0}\\\"\", path);\n                        Console.WriteLine(e.Message);\n                        return false;\n                    }\n                }\n                else\n                {\n                    Console.WriteLine(\"Can not create file \\\"{0}\\\". File already exists\", path);\n                    return false;\n\n                }\n            }\n\n            //Reading a file content by using the given path to a memory stream\n            private bool ReadFile(MemoryStream OutputStream, string path)\n            {\n                try\n                {\n                    using (FileStream fs = File.Open(path, FileMode.Open))\n                    {\n                        fs.CopyTo(OutputStream);\n                    }\n                    return true;\n                }\n                catch (Exception e)\n                {\n                    Console.WriteLine(\"The following exception was thrown during reading from the file \\\"{0}\\\"\", path);\n                    Console.WriteLine(e.Message);\n                    return false;\n                }\n            }\n\n            //Deleting file by using the given path\n            private void RemoveFile(string path)\n            {\n                if (File.Exists(path))\n                {\n                    try\n                    {\n                        File.Delete(path);\n                    }\n                    catch (Exception e)\n                    {\n                        Console.WriteLine(\"The following exception was thrown during deleting the file \\\"{0}\\\"\", path);\n                        Console.WriteLine(e.Message);\n                    }\n                }\n                else\n                {\n                    Console.WriteLine(\"Can not delete file \\\"{0}\\\". File does not exist\", path);\n                }\n            }\n\n            static void Main()\n            {\n\n                string sectionDivider = \"---------------------------------------- \";\n\n                //Create an instance of the AvroSample class and invoke methods\n                //illustrating different serializing approaches\n                AvroSample Sample = new AvroSample();\n\n                //Serialization using generic record to Avro object container file\n                Sample.SerializeDeserializeUsingObjectContainersGenericRecord();\n\n                Console.WriteLine(sectionDivider);\n                Console.WriteLine(\"Press any key to exit.\");\n                Console.Read();\n            }\n        }\n    }\n    // The example is expected to display the following output:\n    // SERIALIZATION USING GENERIC RECORD AND AVRO OBJECT CONTAINER FILES\n    //\n    // Defining the Schema and creating Sample Data Set...\n    // Serializing Sample Data Set...\n    // Saving serialized data to file...\n    // Reading data from file...\n    // Deserializing Sample Data Set...\n    // Comparing Initial and Deserialized Data Sets...\n    // For Pair 1 result of Data Set Identity Comparison is True\n    // For Pair 2 result of Data Set Identity Comparison is True\n    // ----------------------------------------\n    // Press any key to exit.\n\n\n\n\n###<a name=\"Scenario5\"></a>Sample 5: Serialization using object container files with a custom compression codec\n\nThe fifth example shows how to how to use a custom compression codec for Avro object container files. A sample containing the code for this example can be downloaded from the [Azure code samples](http://code.msdn.microsoft.com/windowsazure/Serialize-data-with-the-67159111) site.\n\nThe [Avro Specification](http://avro.apache.org/docs/current/spec.html#Required+Codecs) allows usage of an optional compression codec (in addition to **Null** and **Deflate** defaults). This example is not implementing a completely new codec such as Snappy (mentioned as a supported optional codec in the [Avro Specification](http://avro.apache.org/docs/current/spec.html#snappy)). It shows how to use the .NET Framework 4.5 implementation of the [**Deflate**][deflate-110] codec, which provides a better compression algorithm based on the [zlib](http://zlib.net/) compression library than the default .NET Framework 4 version.\n\n\n    //\n    // This code needs to be compiled with the parameter Target Framework set as \".NET Framework 4.5\"\n    // to ensure the desired implementation of the Deflate compression algorithm is used.\n    // Ensure your C# project is set up accordingly.\n    //\n\n    namespace Microsoft.Hadoop.Avro.Sample\n    {\n        using System;\n        using System.Collections.Generic;\n        using System.Diagnostics;\n        using System.IO;\n        using System.IO.Compression;\n        using System.Linq;\n        using System.Runtime.Serialization;\n        using Microsoft.Hadoop.Avro.Container;\n        using Microsoft.Hadoop.Avro;\n\n        #region Defining objects for serialization\n        //Sample class used in serialization samples\n        [DataContract(Name = \"SensorDataValue\", Namespace = \"Sensors\")]\n        internal class SensorData\n        {\n            [DataMember(Name = \"Location\")]\n            public Location Position { get; set; }\n\n            [DataMember(Name = \"Value\")]\n            public byte[] Value { get; set; }\n        }\n\n        //Sample struct used in serialization samples\n        [DataContract]\n        internal struct Location\n        {\n            [DataMember]\n            public int Floor { get; set; }\n\n            [DataMember]\n            public int Room { get; set; }\n        }\n        #endregion\n\n        #region Defining custom codec based on .NET Framework V.4.5 Deflate\n        //Avro.NET codec class contains two methods,\n        //GetCompressedStreamOver(Stream uncompressed) and GetDecompressedStreamOver(Stream compressed),\n        //which are the key ones for data compression.\n        //To enable a custom codec, one needs to implement these methods for the required codec.\n\n        #region Defining Compression and Decompression Streams\n        //DeflateStream (class from System.IO.Compression namespace that implements Deflate algorithm)\n        //cannot be directly used for Avro because it does not support vital operations like Seek.\n        //Thus one needs to implement two classes inherited from stream\n        //(one for compressed and one for decompressed stream)\n        //that use Deflate compression and implement all required features.\n        internal sealed class CompressionStreamDeflate45 : Stream\n        {\n            private readonly Stream buffer;\n            private DeflateStream compressionStream;\n\n            public CompressionStreamDeflate45(Stream buffer)\n            {\n                Debug.Assert(buffer != null, \"Buffer is not allowed to be null.\");\n\n                this.compressionStream = new DeflateStream(buffer, CompressionLevel.Fastest, true);\n                this.buffer = buffer;\n            }\n\n            public override bool CanRead\n            {\n                get { return this.buffer.CanRead; }\n            }\n\n            public override bool CanSeek\n            {\n                get { return true; }\n            }\n\n            public override bool CanWrite\n            {\n                get { return this.buffer.CanWrite; }\n            }\n\n            public override void Flush()\n            {\n                this.compressionStream.Close();\n            }\n\n            public override long Length\n            {\n                get { return this.buffer.Length; }\n            }\n\n            public override long Position\n            {\n                get\n                {\n                    return this.buffer.Position;\n                }\n\n                set\n                {\n                    this.buffer.Position = value;\n                }\n            }\n\n            public override int Read(byte[] buffer, int offset, int count)\n            {\n                return this.buffer.Read(buffer, offset, count);\n            }\n\n            public override long Seek(long offset, SeekOrigin origin)\n            {\n                return this.buffer.Seek(offset, origin);\n            }\n\n            public override void SetLength(long value)\n            {\n                throw new NotSupportedException();\n            }\n\n            public override void Write(byte[] buffer, int offset, int count)\n            {\n                this.compressionStream.Write(buffer, offset, count);\n            }\n\n            protected override void Dispose(bool disposed)\n            {\n                base.Dispose(disposed);\n\n                if (disposed)\n                {\n                    this.compressionStream.Dispose();\n                    this.compressionStream = null;\n                }\n            }\n        }\n\n        internal sealed class DecompressionStreamDeflate45 : Stream\n        {\n            private readonly DeflateStream decompressed;\n\n            public DecompressionStreamDeflate45(Stream compressed)\n            {\n                this.decompressed = new DeflateStream(compressed, CompressionMode.Decompress, true);\n            }\n\n            public override bool CanRead\n            {\n                get { return true; }\n            }\n\n            public override bool CanSeek\n            {\n                get { return true; }\n            }\n\n            public override bool CanWrite\n            {\n                get { return false; }\n            }\n\n            public override void Flush()\n            {\n                this.decompressed.Close();\n            }\n\n            public override long Length\n            {\n                get { return this.decompressed.Length; }\n            }\n\n            public override long Position\n            {\n                get\n                {\n                    return this.decompressed.Position;\n                }\n\n                set\n                {\n                    throw new NotSupportedException();\n                }\n            }\n\n            public override int Read(byte[] buffer, int offset, int count)\n            {\n                return this.decompressed.Read(buffer, offset, count);\n            }\n\n            public override long Seek(long offset, SeekOrigin origin)\n            {\n                throw new NotSupportedException();\n            }\n\n            public override void SetLength(long value)\n            {\n                throw new NotSupportedException();\n            }\n\n            public override void Write(byte[] buffer, int offset, int count)\n            {\n                throw new NotSupportedException();\n            }\n\n            protected override void Dispose(bool disposing)\n            {\n                base.Dispose(disposing);\n\n                if (disposing)\n                {\n                    this.decompressed.Dispose();\n                }\n            }\n        }\n        #endregion\n\n        #region Define Codec\n        //Define the actual codec class containing the required methods for manipulating streams:\n        //GetCompressedStreamOver(Stream uncompressed) and GetDecompressedStreamOver(Stream compressed).\n        //Codec class uses classes for compressed and decompressed streams defined above.\n        internal sealed class DeflateCodec45 : Codec\n        {\n\n            //We merely use different IMPLEMENTATIONS of Deflate, so CodecName remains \"deflate\"\n            public static readonly string CodecName = \"deflate\";\n\n            public DeflateCodec45()\n                : base(CodecName)\n            {\n            }\n\n            public override Stream GetCompressedStreamOver(Stream decompressed)\n            {\n                if (decompressed == null)\n                {\n                    throw new ArgumentNullException(\"decompressed\");\n                }\n\n                return new CompressionStreamDeflate45(decompressed);\n            }\n\n            public override Stream GetDecompressedStreamOver(Stream compressed)\n            {\n                if (compressed == null)\n                {\n                    throw new ArgumentNullException(\"compressed\");\n                }\n\n                return new DecompressionStreamDeflate45(compressed);\n            }\n        }\n        #endregion\n\n        #region Define modified Codec Factory\n        //Define modified codec factory to be used in the reader.\n        //It will catch the attempt to use \"Deflate\" and provide  a custom codec.\n        //For all other cases, it will rely on the base class (CodecFactory).\n        internal sealed class CodecFactoryDeflate45 : CodecFactory\n        {\n\n            public override Codec Create(string codecName)\n            {\n                if (codecName == DeflateCodec45.CodecName)\n                    return new DeflateCodec45();\n                else\n                    return base.Create(codecName);\n            }\n        }\n        #endregion\n\n        #endregion\n\n        #region Sample Class with demonstration methods\n        //This class contains methods demonstrating\n        //the usage of Microsoft Avro Library\n        public class AvroSample\n        {\n\n            //Serializes and deserializes sample data set by using reflection and Avro object container files.\n            //Serialized data is compressed with the custom compression codec (Deflate of .NET Framework 4.5).\n            //\n            //This sample uses memory stream for all operations related to serialization, deserialization and\n            //object container manipulation, though file stream could be easily used.\n            public void SerializeDeserializeUsingObjectContainersReflectionCustomCodec()\n            {\n\n                Console.WriteLine(\"SERIALIZATION USING REFLECTION, AVRO OBJECT CONTAINER FILES AND CUSTOM CODEC\\n\");\n\n                //Path for Avro object container file\n                string path = \"AvroSampleReflectionDeflate45.avro\";\n\n                //Create a data set by using sample class and struct\n                var testData = new List<SensorData>\n                        {\n                            new SensorData { Value = new byte[] { 1, 2, 3, 4, 5 }, Position = new Location { Room = 243, Floor = 1 } },\n                            new SensorData { Value = new byte[] { 6, 7, 8, 9 }, Position = new Location { Room = 244, Floor = 1 } }\n                        };\n\n                //Serializing and saving data to file.\n                //Creating a memory stream buffer.\n                using (var buffer = new MemoryStream())\n                {\n                    Console.WriteLine(\"Serializing Sample Data Set...\");\n\n                    //Create a SequentialWriter instance for type SensorData, which can serialize a sequence of SensorData objects to stream.\n                    //Here the custom codec is introduced. For convenience, the next commented code line shows how to use built-in Deflate.\n                    //Note that because the sample deals with different IMPLEMENTATIONS of Deflate, built-in and custom codecs are interchangeable\n                    //in read-write operations.\n                    //using (var w = AvroContainer.CreateWriter<SensorData>(buffer, Codec.Deflate))\n                    using (var w = AvroContainer.CreateWriter<SensorData>(buffer, new DeflateCodec45()))\n                    {\n                        using (var writer = new SequentialWriter<SensorData>(w, 24))\n                        {\n                            // Serialize the data to stream using the sequential writer\n                            testData.ForEach(writer.Write);\n                        }\n                    }\n\n                    //Save stream to file\n                    Console.WriteLine(\"Saving serialized data to file...\");\n                    if (!WriteFile(buffer, path))\n                    {\n                        Console.WriteLine(\"Error during file operation. Quitting method\");\n                        return;\n                    }\n                }\n\n                //Reading and deserializing data.\n                //Creating a memory stream buffer.\n                using (var buffer = new MemoryStream())\n                {\n                    Console.WriteLine(\"Reading data from file...\");\n\n                    //Reading data from object container file\n                    if (!ReadFile(buffer, path))\n                    {\n                        Console.WriteLine(\"Error during file operation. Quitting method\");\n                        return;\n                    }\n\n                    Console.WriteLine(\"Deserializing Sample Data Set...\");\n\n                    //Prepare the stream for deserializing the data\n                    buffer.Seek(0, SeekOrigin.Begin);\n\n                    //Because of SequentialReader<T> constructor signature, an AvroSerializerSettings instance is required\n                    //when codec factory is explicitly specified.\n                    //You may comment the line below if you want to use built-in Deflate (see next comment).\n                    AvroSerializerSettings settings = new AvroSerializerSettings();\n\n                    //Create a SequentialReader instance for type SensorData, which will deserialize all serialized objects from the given stream.\n                    //It allows iterating over the deserialized objects because it implements the IEnumerable<T> interface.\n                    //Here the custom codec factory is introduced.\n                    //For convenience, the next commented code line shows how to use built-in Deflate\n                    //(no explicit Codec Factory parameter is required in this case).\n                    //Note that because the sample deals with different IMPLEMENTATIONS of Deflate, built-in and custom codecs are interchangeable\n                    //in read-write operations.\n                    //using (var reader = new SequentialReader<SensorData>(AvroContainer.CreateReader<SensorData>(buffer, true)))\n                    using (var reader = new SequentialReader<SensorData>(\n                        AvroContainer.CreateReader<SensorData>(buffer, true, settings, new CodecFactoryDeflate45())))\n                    {\n                        var results = reader.Objects;\n\n                        //Finally, verify that deserialized data matches the original one\n                        Console.WriteLine(\"Comparing Initial and Deserialized Data Sets...\");\n                        bool isEqual;\n                        int count = 1;\n                        var pairs = testData.Zip(results, (serialized, deserialized) => new { expected = serialized, actual = deserialized });\n                        foreach (var pair in pairs)\n                        {\n                            isEqual = this.Equal(pair.expected, pair.actual);\n                            Console.WriteLine(\"For Pair {0} result of Data Set Identity Comparison is {1}\", count, isEqual.ToString());\n                            count++;\n                        }\n                    }\n                }\n\n                //Delete the file\n                RemoveFile(path);\n            }\n        #endregion\n\n            #region Helper Methods\n\n            //Comparing two SensorData objects\n            private bool Equal(SensorData left, SensorData right)\n            {\n                return left.Position.Equals(right.Position) && left.Value.SequenceEqual(right.Value);\n            }\n\n            //Saving memory stream to a new file with the given path\n            private bool WriteFile(MemoryStream InputStream, string path)\n            {\n                if (!File.Exists(path))\n                {\n                    try\n                    {\n                        using (FileStream fs = File.Create(path))\n                        {\n                            InputStream.Seek(0, SeekOrigin.Begin);\n                            InputStream.CopyTo(fs);\n                        }\n                        return true;\n                    }\n                    catch (Exception e)\n                    {\n                        Console.WriteLine(\"The following exception was thrown during creation and writing to the file \\\"{0}\\\"\", path);\n                        Console.WriteLine(e.Message);\n                        return false;\n                    }\n                }\n                else\n                {\n                    Console.WriteLine(\"Can not create file \\\"{0}\\\". File already exists\", path);\n                    return false;\n\n                }\n            }\n\n            //Reading file content by using the given path to a memory stream\n            private bool ReadFile(MemoryStream OutputStream, string path)\n            {\n                try\n                {\n                    using (FileStream fs = File.Open(path, FileMode.Open))\n                    {\n                        fs.CopyTo(OutputStream);\n                    }\n                    return true;\n                }\n                catch (Exception e)\n                {\n                    Console.WriteLine(\"The following exception was thrown during reading from the file \\\"{0}\\\"\", path);\n                    Console.WriteLine(e.Message);\n                    return false;\n                }\n            }\n\n            //Deleting file by using given path\n            private void RemoveFile(string path)\n            {\n                if (File.Exists(path))\n                {\n                    try\n                    {\n                        File.Delete(path);\n                    }\n                    catch (Exception e)\n                    {\n                        Console.WriteLine(\"The following exception was thrown during deleting the file \\\"{0}\\\"\", path);\n                        Console.WriteLine(e.Message);\n                    }\n                }\n                else\n                {\n                    Console.WriteLine(\"Can not delete file \\\"{0}\\\". File does not exist\", path);\n                }\n            }\n            #endregion\n\n            static void Main()\n            {\n\n                string sectionDivider = \"---------------------------------------- \";\n\n                //Create an instance of AvroSample Class and invoke methods\n                //illustrating different serializing approaches\n                AvroSample Sample = new AvroSample();\n\n                //Serialization using reflection to Avro object container file using custom codec\n                Sample.SerializeDeserializeUsingObjectContainersReflectionCustomCodec();\n\n                Console.WriteLine(sectionDivider);\n                Console.WriteLine(\"Press any key to exit.\");\n                Console.Read();\n            }\n        }\n    }\n    // The example is expected to display the following output:\n    // SERIALIZATION USING REFLECTION, AVRO OBJECT CONTAINER FILES AND CUSTOM CODEC\n    //\n    // Serializing Sample Data Set...\n    // Saving serialized data to file...\n    // Reading data from file...\n    // Deserializing Sample Data Set...\n    // Comparing Initial and Deserialized Data Sets...\n    // For Pair 1 result of Data Set Identity Comparison is True\n    //For Pair 2 result of Data Set Identity Comparison is True\n    // ----------------------------------------\n    // Press any key to exit.\n\n###<a name=\"Scenario6\"></a>Sample 6: Using Avro to upload data for the Microsoft Azure HDInsight service\n\nThe sixth example illustrates some programming techniques related to interacting with the Azure HDInsight service. A sample containing the code for this example can be downloaded from the [Azure code samples](https://code.msdn.microsoft.com/windowsazure/Using-Avro-to-upload-data-ae81b1e3) site.\n\nThe sample does the following:\n\n* Connects to an existing HDInsight service cluster.\n* Serializes several CSV files and uploads the result to Azure Blob storage. (The CSV files are distributed together with the sample and represent an extract from AMEX Stock historical data distributed by [Infochimps](http://www.infochimps.com/) for the period 1970-2010. The sample reads CSV file data, converts the records to instances of the **Stock** class, and then serializes them by using reflection. Stock type definition is created from a JSON schema via the Microsoft Avro Library code generation utility.\n* Creates a new external table called **Stocks** in Hive, and links it to the data uploaded in the previous step.\n* Executes a query by using Hive over the **Stocks** table.\n\nIn addition, the sample performs a clean-up procedure before and after performing major operations. During the clean-up, all of the related Azure Blob data and folders are removed, and the Hive table is dropped. You can also invoke the clean-up procedure from the sample command line.\n\nThe sample has the following prerequisites:\n\n* An active Microsoft Azure subscription and its subscription ID.\n* A management certificate for the subscription with the corresponding private key. The certificate should be installed in the current user private storage on the machine used to run the sample.\n* An active HDInsight cluster.\n* An Azure Storage account linked to the HDInsight cluster from the previous prerequisite, together with the corresponding primary or secondary access key.\n\nAll of the information from the prerequisites should be entered to the sample configuration file before the sample is run. There are two possible ways to do it:\n\n* Edit the app.config file in the sample root directory and then build the sample\n* First build the sample, and then edit AvroHDISample.exe.config in the build directory\n\nIn both cases all edits should be done in the **<appSettings>** settings section. Please follow the comments in the file.\nThe sample is run from the command line by executing the following command (where the .zip file with the sample was assumed to be extracted to C:\\AvroHDISample; if otherwise, use the relevant file path):\n\n    AvroHDISample run C:\\AvroHDISample\\Data\n\nTo clean up the cluster, run the following command:\n\n    AvroHDISample clean\n\n\n\n\n[deflate-100]: http://msdn.microsoft.com/library/system.io.compression.deflatestream(v=vs.100).aspx\n[deflate-110]: http://msdn.microsoft.com/library/system.io.compression.deflatestream(v=vs.110).aspx\n\ntest\n"
}