{
  "nodes": [
    {
      "content": "Creating a Windows Store leaderboard app with .NET Backend | Microsoft Azure",
      "pos": [
        28,
        104
      ]
    },
    {
      "content": "Learn how to build a Windows Store leaderboard app using Azure Mobile Services with a .NET backend.",
      "pos": [
        124,
        223
      ]
    },
    {
      "content": "Creating a Leaderboard App with Azure Mobile Services .NET Backend",
      "pos": [
        570,
        636
      ]
    },
    {
      "content": "This tutorial shows how build a Windows Store app using Azure Mobile Services with a .NET backend.",
      "pos": [
        638,
        736
      ]
    },
    {
      "content": "Azure Mobile Services provides a scalable and secure backend with built-in authentication, monitoring, push notifications, and other features, plus a cross-platform client library for building mobile apps.",
      "pos": [
        737,
        942
      ]
    },
    {
      "content": "The .NET backend for Mobile Services is based on <bpt id=\"p1\">[</bpt>ASP.NET Web API<ept id=\"p1\">](http://asp.net/web-api)</ept>, and gives .NET developers a first-class way to create REST APIs.",
      "pos": [
        943,
        1099
      ]
    },
    {
      "content": "Overview",
      "pos": [
        1107,
        1115
      ]
    },
    {
      "content": "Web API is an open-source framework that gives .NET developers a first-class way to create REST APIs.",
      "pos": [
        1117,
        1218
      ]
    },
    {
      "content": "You can host a Web API solution on Azure Websites, on Azure Mobile Services using the .NET backend, or even self-hosted in a custom process.",
      "pos": [
        1219,
        1359
      ]
    },
    {
      "content": "Mobile Services is a hosting environment that is designed especially for mobile apps.",
      "pos": [
        1360,
        1445
      ]
    },
    {
      "content": "When you host your Web API service on Mobile Services, you get the following advantages in addition to data storage:",
      "pos": [
        1446,
        1562
      ]
    },
    {
      "content": "Built-in authentication with social providers and Azure Active Directory (AAD).",
      "pos": [
        1566,
        1645
      ]
    },
    {
      "content": "Push notifications to apps using device-specific notification services.",
      "pos": [
        1649,
        1720
      ]
    },
    {
      "content": "A full set of client libraries that make it easy to access your service from any app.",
      "pos": [
        1723,
        1808
      ]
    },
    {
      "content": "Built-in logging and diagnostics.",
      "pos": [
        1812,
        1845
      ]
    },
    {
      "content": "In this tutorial you will:",
      "pos": [
        1847,
        1873
      ]
    },
    {
      "content": "Create a REST API using Azure Mobile Services.",
      "pos": [
        1877,
        1923
      ]
    },
    {
      "content": "Publish the service to Azure.",
      "pos": [
        1926,
        1955
      ]
    },
    {
      "content": "Create a Windows Store app that consumes the service.",
      "pos": [
        1958,
        2011
      ]
    },
    {
      "content": "Use Entity Framework (EF) to create foreign key relations and data transfer objects (DTOs).",
      "pos": [
        2014,
        2105
      ]
    },
    {
      "content": "Use ASP.NET Web API to define a custom API.",
      "pos": [
        2108,
        2151
      ]
    },
    {
      "pos": [
        2153,
        2256
      ],
      "content": "This tutorial uses <bpt id=\"p1\">[</bpt>Visual Studio 2013 latest update<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?LinkID=390465)</ept>."
    },
    {
      "content": "About the sample app",
      "pos": [
        2263,
        2283
      ]
    },
    {
      "content": "A <bpt id=\"p1\">*</bpt>leaderboard<ept id=\"p1\">*</ept> shows a list of players for a game, along with their scores and the rank of each player.",
      "pos": [
        2285,
        2389
      ]
    },
    {
      "content": "A leaderboard might be part of a larger game, or could be a separate app.",
      "pos": [
        2390,
        2463
      ]
    },
    {
      "content": "A leaderboard is a real-world application, but is simple enough for a tutorial.",
      "pos": [
        2464,
        2543
      ]
    },
    {
      "content": "Here is a screen shot of the app:",
      "pos": [
        2544,
        2577
      ]
    },
    {
      "content": "To keep the app simple, there is no actual game.",
      "pos": [
        2587,
        2635
      ]
    },
    {
      "content": "Instead, you can add players and submit a score for each player.",
      "pos": [
        2636,
        2700
      ]
    },
    {
      "content": "When you submit a score, the mobile service calculates the new rankings.",
      "pos": [
        2701,
        2773
      ]
    },
    {
      "content": "On the back end, the mobile service creates a database with two tables:",
      "pos": [
        2774,
        2845
      ]
    },
    {
      "content": "Player.",
      "pos": [
        2849,
        2856
      ]
    },
    {
      "content": "Contains the player ID and name.",
      "pos": [
        2857,
        2889
      ]
    },
    {
      "content": "PlayerRank.",
      "pos": [
        2892,
        2903
      ]
    },
    {
      "content": "Contains a player's score and rank.",
      "pos": [
        2904,
        2939
      ]
    },
    {
      "content": "PlayerRank has a foreign key to Player.",
      "pos": [
        2941,
        2980
      ]
    },
    {
      "content": "Each player has zero or one PlayerRank.",
      "pos": [
        2981,
        3020
      ]
    },
    {
      "content": "In a real leaderboard app, PlayerRank might also have a game ID, so that a player could submit scores for more than one game.",
      "pos": [
        3022,
        3147
      ]
    },
    {
      "content": "The client app can perform the full set of CRUD operations on Players.",
      "pos": [
        3157,
        3227
      ]
    },
    {
      "content": "It can read or delete existing PlayerRank entities, but it cannot create or update them directly.",
      "pos": [
        3228,
        3325
      ]
    },
    {
      "content": "That's because the rank value is calculated by the service.",
      "pos": [
        3326,
        3385
      ]
    },
    {
      "content": "Instead, the client submits a score, and the service updates the ranks for all players.",
      "pos": [
        3386,
        3473
      ]
    },
    {
      "pos": [
        3475,
        3581
      ],
      "content": "Download the completed project <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](http://code.msdn.microsoft.com/Leaderboard-App-with-Azure-9acf63af)</ept>."
    },
    {
      "content": "Create the project",
      "pos": [
        3587,
        3605
      ]
    },
    {
      "content": "Launch Visual Studio and create a new ASP.NET Web Application project.",
      "pos": [
        3607,
        3677
      ]
    },
    {
      "content": "Name the project Leaderboard.",
      "pos": [
        3678,
        3707
      ]
    },
    {
      "content": "In Visual Studio 2013, the ASP.NET Web Application project includes a template for Azure Mobile Service.",
      "pos": [
        3717,
        3821
      ]
    },
    {
      "content": "Select this template and click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.",
      "pos": [
        3822,
        3860
      ]
    },
    {
      "content": "The project template includes an example controller and data object.",
      "pos": [
        3871,
        3939
      ]
    },
    {
      "content": "These aren't needed for the tutorial, so you can delete them from the project.",
      "pos": [
        3952,
        4030
      ]
    },
    {
      "content": "Also remove the references to TodoItem  in WebApiConfig.cs and LeaderboardContext.cs.",
      "pos": [
        4031,
        4116
      ]
    },
    {
      "content": "Add data models",
      "pos": [
        4121,
        4136
      ]
    },
    {
      "content": "You will use <bpt id=\"p1\">[</bpt>EF Code First<ept id=\"p1\">](http://msdn.microsoft.com/data/ee712907#codefirst)</ept> to define the database tables.",
      "pos": [
        4138,
        4248
      ]
    },
    {
      "content": "Under the DataObjects folder, add a class named <ph id=\"ph1\">`Player`</ph>.",
      "pos": [
        4249,
        4306
      ]
    },
    {
      "pos": [
        4519,
        4556
      ],
      "content": "Add another class named <ph id=\"ph1\">`PlayerRank`</ph>."
    },
    {
      "content": "Notice that both classes inherit from the <bpt id=\"p1\">**</bpt>EntityData<ept id=\"p1\">**</ept> class.",
      "pos": [
        4960,
        5023
      ]
    },
    {
      "content": "Deriving from <bpt id=\"p1\">**</bpt>EntityData<ept id=\"p1\">**</ept> makes it easy for the app consume the data, using the cross-platform client library for Azure Mobile Services.",
      "pos": [
        5024,
        5163
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>EntityData<ept id=\"p1\">**</ept> also makes it easier for an app to <bpt id=\"p2\">[</bpt>handle database write conflicts<ept id=\"p2\">](mobile-services-windows-store-dotnet-handle-database-conflicts.md)</ept>.",
      "pos": [
        5164,
        5315
      ]
    },
    {
      "content": "The <ph id=\"ph1\">`PlayerRank`</ph> class has a <bpt id=\"p1\">[</bpt>navigation property<ept id=\"p1\">](http://msdn.microsoft.com/data/jj713564.aspx)</ept> that points to the related <ph id=\"ph2\">`Player`</ph> entity.",
      "pos": [
        5317,
        5457
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>[ForeignKey]<ept id=\"p1\">**</ept> attribute tells EF that the <ph id=\"ph1\">`Player`</ph> property represents a foreign key.",
      "pos": [
        5458,
        5550
      ]
    },
    {
      "content": "Add Web API controllers",
      "pos": [
        5555,
        5578
      ]
    },
    {
      "content": "Next, you will add Web API controllers for <ph id=\"ph1\">`Player`</ph> and <ph id=\"ph2\">`PlayerRank`</ph>.",
      "pos": [
        5580,
        5649
      ]
    },
    {
      "content": "Instead of plain Web API controllers, you will add a special kind of controller called a <bpt id=\"p1\">*</bpt>table controller<ept id=\"p1\">*</ept>, designed specifically for Azure Mobile Services.",
      "pos": [
        5650,
        5807
      ]
    },
    {
      "pos": [
        5809,
        5881
      ],
      "content": "Right click the Controllers folder &gt;  <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>New Scaffolded Item<ept id=\"p2\">**</ept>."
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Add Scaffold<ept id=\"p1\">**</ept> dialog, expand <bpt id=\"p2\">**</bpt>Common<ept id=\"p2\">**</ept> on the left and select <bpt id=\"p3\">**</bpt>Azure Mobile Services<ept id=\"p3\">**</ept>.",
      "pos": [
        5892,
        5991
      ]
    },
    {
      "content": "Then select <bpt id=\"p1\">**</bpt>Azure Mobile Services Table Controller<ept id=\"p1\">**</ept>.",
      "pos": [
        5992,
        6047
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept>.",
      "pos": [
        6048,
        6062
      ]
    },
    {
      "pos": [
        6074,
        6107
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Add Controller<ept id=\"p1\">**</ept> dialog:"
    },
    {
      "pos": [
        6113,
        6150
      ],
      "content": "Under <bpt id=\"p1\">**</bpt>Model class<ept id=\"p1\">**</ept>, select Player."
    },
    {
      "pos": [
        6156,
        6214
      ],
      "content": "Under <bpt id=\"p1\">**</bpt>Data context class<ept id=\"p1\">**</ept>, select MobileServiceContext."
    },
    {
      "content": "Name the controller \"PlayerController\".",
      "pos": [
        6219,
        6258
      ]
    },
    {
      "pos": [
        6263,
        6277
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept>."
    },
    {
      "content": "This step adds a file named PlayerController.cs to the project.",
      "pos": [
        6280,
        6343
      ]
    },
    {
      "content": "The controller derives from <bpt id=\"p1\">**</bpt>TableController<ph id=\"ph1\">&lt;T&gt;</ph><ept id=\"p1\">**</ept>.",
      "pos": [
        6354,
        6405
      ]
    },
    {
      "content": "This class inherits <bpt id=\"p1\">**</bpt>ApiController<ept id=\"p1\">**</ept>, but is specialized for Azure Mobile Services.",
      "pos": [
        6406,
        6490
      ]
    },
    {
      "content": "Routing: The default route for a <bpt id=\"p1\">**</bpt>TableController<ept id=\"p1\">**</ept> is <ph id=\"ph1\">`/tables/{table_name}/{id}`</ph>, where <bpt id=\"p2\">*</bpt>table_name<ept id=\"p2\">*</ept> matches the entity name.",
      "pos": [
        6495,
        6623
      ]
    },
    {
      "content": "So the route for the Player controller is <bpt id=\"p1\">*</bpt>/tables/player/{id}<ept id=\"p1\">*</ept>.",
      "pos": [
        6624,
        6688
      ]
    },
    {
      "content": "This routing convention makes <bpt id=\"p1\">**</bpt>TableController<ept id=\"p1\">**</ept> consistent with the Mobile Services <bpt id=\"p2\">[</bpt>REST API<ept id=\"p2\">](http://msdn.microsoft.com/library/azure/jj710104.aspx)</ept>.",
      "pos": [
        6689,
        6841
      ]
    },
    {
      "content": "Data access: For database operations, the <bpt id=\"p1\">**</bpt>TableController<ept id=\"p1\">**</ept> class uses the <bpt id=\"p2\">**</bpt>IDomainManager<ept id=\"p2\">**</ept> interface, which defines an abstraction for data access.",
      "pos": [
        6844,
        6996
      ]
    },
    {
      "content": "The scaffolding uses <bpt id=\"p1\">**</bpt>EntityDomainManager<ept id=\"p1\">**</ept>, which is a concrete implementation of <bpt id=\"p2\">**</bpt>IDomainManager<ept id=\"p2\">**</ept> that wraps an EF context.",
      "pos": [
        6998,
        7126
      ]
    },
    {
      "content": "Now add a second controller for PlayerRank entities.",
      "pos": [
        7129,
        7181
      ]
    },
    {
      "content": "Follow the same steps, but choose PlayerRank for the model class.",
      "pos": [
        7182,
        7247
      ]
    },
    {
      "content": "Use the same data context class; don't create a new one.",
      "pos": [
        7248,
        7304
      ]
    },
    {
      "content": "Name the controller \"PlayerRankController\".",
      "pos": [
        7305,
        7348
      ]
    },
    {
      "content": "Use a DTO to return related entities",
      "pos": [
        7353,
        7389
      ]
    },
    {
      "pos": [
        7391,
        7446
      ],
      "content": "Recall that <ph id=\"ph1\">`PlayerRank`</ph> has a related <ph id=\"ph2\">`Player`</ph> entity:"
    },
    {
      "content": "The Mobile Service client library does not support navigation properties, and they will not be serialized.",
      "pos": [
        7659,
        7765
      ]
    },
    {
      "content": "For example, here is the raw HTTP response for GET <ph id=\"ph1\">`/tables/PlayerRank`</ph>:",
      "pos": [
        7766,
        7838
      ]
    },
    {
      "content": "Notice that <ph id=\"ph1\">`Player`</ph> is not included in the object graph.",
      "pos": [
        8175,
        8232
      ]
    },
    {
      "content": "To include the player, we can flatten the object graph by defining a <bpt id=\"p1\">*</bpt>data transfer object<ept id=\"p1\">*</ept> (DTO).",
      "pos": [
        8233,
        8331
      ]
    },
    {
      "content": "A DTO is an object that defines how data is sent over the network.",
      "pos": [
        8334,
        8400
      ]
    },
    {
      "content": "DTOs are useful whenever you want the wire format to look different than your database model.",
      "pos": [
        8401,
        8494
      ]
    },
    {
      "content": "To create a DTO for <ph id=\"ph1\">`PlayerRank`</ph>, add a new class named <ph id=\"ph2\">`PlayerRankDto`</ph> in the DataObjects folder.",
      "pos": [
        8495,
        8593
      ]
    },
    {
      "content": "In the <ph id=\"ph1\">`PlayerRankController`</ph> class, we'll use the LINQ <bpt id=\"p1\">**</bpt>Select<ept id=\"p1\">**</ept> method to convert <ph id=\"ph2\">`PlayerRank`</ph> instances to <ph id=\"ph3\">`PlayerRankDto`</ph> instances.",
      "pos": [
        8880,
        9017
      ]
    },
    {
      "content": "Update the <ph id=\"ph1\">`GetAllPlayerRank`</ph> and <ph id=\"ph2\">`GetPlayerRank`</ph> controller methods as follows:",
      "pos": [
        9018,
        9098
      ]
    },
    {
      "content": "With these changes, the two GET methods return <ph id=\"ph1\">`PlayerRankDto`</ph> objects to the client.",
      "pos": [
        9818,
        9903
      ]
    },
    {
      "content": "The <ph id=\"ph1\">`PlayerRankDto.PlayerName`</ph> property is set to the player name.",
      "pos": [
        9904,
        9970
      ]
    },
    {
      "content": "Here is an example response after making this change:",
      "pos": [
        9971,
        10024
      ]
    },
    {
      "content": "Notice that the JSON payload now includes the player names.",
      "pos": [
        10425,
        10484
      ]
    },
    {
      "content": "Instead of using LINQ Select statements, another option is to use AutoMapper.",
      "pos": [
        10486,
        10563
      ]
    },
    {
      "content": "This option requires some additional setup code, but enables automatic mapping from domain entities to DTOs.",
      "pos": [
        10564,
        10672
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Mapping between Database Types and Client Types in the .NET Backend using AutoMapper<ept id=\"p1\">](http://blogs.msdn.com/b/azuremobile/archive/2014/05/19/mapping-between-database-types-and-client-type-in-the-net-backend-using-automapper.aspx)</ept>.",
      "pos": [
        10673,
        10930
      ]
    },
    {
      "content": "Define a custom API to submit scores",
      "pos": [
        10935,
        10971
      ]
    },
    {
      "content": "The <ph id=\"ph1\">`PlayerRank`</ph> entity includes a <ph id=\"ph2\">`Rank`</ph> property.",
      "pos": [
        10973,
        11024
      ]
    },
    {
      "content": "This value is calculated by the server, and we don't want clients setting it.",
      "pos": [
        11025,
        11102
      ]
    },
    {
      "content": "Instead, clients will use a custom API to submit a player's score.",
      "pos": [
        11103,
        11169
      ]
    },
    {
      "content": "When the server gets a new score, it will update all of the player ranks.",
      "pos": [
        11171,
        11244
      ]
    },
    {
      "pos": [
        11246,
        11311
      ],
      "content": "First, add a class named <ph id=\"ph1\">`PlayerScore`</ph> to the DataObjects folder."
    },
    {
      "pos": [
        11509,
        11628
      ],
      "content": "In the <ph id=\"ph1\">`PlayerRankController`</ph> class, move the <ph id=\"ph2\">`MobileServiceContext`</ph> variable from the constructor to a class variable:"
    },
    {
      "pos": [
        12143,
        12200
      ],
      "content": "Delete the following methods from <ph id=\"ph1\">`PlayerRankController`</ph>:"
    },
    {
      "pos": [
        12265,
        12319
      ],
      "content": "Then add the following code to <ph id=\"ph1\">`PlayerRankController`</ph>:"
    },
    {
      "content": "The <ph id=\"ph1\">`PostPlayerScore`</ph> method takes a <ph id=\"ph2\">`PlayerScore`</ph> instance as input.",
      "pos": [
        13602,
        13671
      ]
    },
    {
      "content": "(The client will send the <ph id=\"ph1\">`PlayerScore`</ph> in an HTTP POST request.) The method does the following:",
      "pos": [
        13672,
        13768
      ]
    },
    {
      "pos": [
        13774,
        13857
      ],
      "content": "Adds a new <ph id=\"ph1\">`PlayerRank`</ph> for the player, if there isn't one in the database already."
    },
    {
      "content": "Updates the player's score.",
      "pos": [
        13862,
        13889
      ]
    },
    {
      "content": "Run a SQL query that batch updates all of the player ranks.",
      "pos": [
        13894,
        13953
      ]
    },
    {
      "pos": [
        13955,
        14020
      ],
      "content": "The <bpt id=\"p1\">**</bpt>[Route]<ept id=\"p1\">**</ept> attribute defines a custom route for this method:"
    },
    {
      "content": "You could also put the method into a separate controller.",
      "pos": [
        14048,
        14105
      ]
    },
    {
      "content": "There is no particular advantage either way, it just depends how you want to organize your code.",
      "pos": [
        14106,
        14202
      ]
    },
    {
      "content": "To learn more about the <bpt id=\"p1\">**</bpt>[Route]<ept id=\"p1\">**</ept> attribute, see <bpt id=\"p2\">[</bpt>Attribute Routing in Web API<ept id=\"p2\">](http://www.asp.net/web-api/overview/web-api-routing-and-actions/attribute-routing-in-web-api-2)</ept>.",
      "pos": [
        14203,
        14381
      ]
    },
    {
      "content": "Create the Windows Store app",
      "pos": [
        14386,
        14414
      ]
    },
    {
      "content": "In this section, I'll describe the Windows Store app that consumes the mobile service.",
      "pos": [
        14416,
        14502
      ]
    },
    {
      "content": "However, I won't focus much on the XAML or the UI.",
      "pos": [
        14503,
        14553
      ]
    },
    {
      "content": "Instead, I want to focus on the application logic.",
      "pos": [
        14554,
        14604
      ]
    },
    {
      "content": "You can download the complete project <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](http://code.msdn.microsoft.com/Leaderboard-App-with-Azure-9acf63af)</ept>.",
      "pos": [
        14605,
        14718
      ]
    },
    {
      "content": "Add a new Windows Store App project to the solution.",
      "pos": [
        14720,
        14772
      ]
    },
    {
      "content": "I used the Blank App (Windows) template.",
      "pos": [
        14773,
        14813
      ]
    },
    {
      "content": "Use NuGet Package Manager to add the Mobile Services client library.",
      "pos": [
        14826,
        14894
      ]
    },
    {
      "content": "In Visual Studio, from the <bpt id=\"p1\">**</bpt>Tools<ept id=\"p1\">**</ept> menu, select <bpt id=\"p2\">**</bpt>NuGet Package Manager<ept id=\"p2\">**</ept>.",
      "pos": [
        14895,
        14971
      ]
    },
    {
      "content": "Then select <bpt id=\"p1\">**</bpt>Package Manager Console<ept id=\"p1\">**</ept>.",
      "pos": [
        14972,
        15012
      ]
    },
    {
      "content": "In the Package Manager Console window, type the following command.",
      "pos": [
        15013,
        15079
      ]
    },
    {
      "content": "The -Project switch specifies which project to install the package to.",
      "pos": [
        15154,
        15224
      ]
    },
    {
      "content": "Add model classes",
      "pos": [
        15229,
        15246
      ]
    },
    {
      "content": "Create a folder named Models and add the following classes:",
      "pos": [
        15248,
        15307
      ]
    },
    {
      "content": "These classes correspond directly to the data entities in the mobile service.",
      "pos": [
        15880,
        15957
      ]
    },
    {
      "content": "Create a view model",
      "pos": [
        15963,
        15982
      ]
    },
    {
      "content": "Model-View-ViewModel (MVVM) is a variant of Model-View-Controller (MVC).",
      "pos": [
        15984,
        16056
      ]
    },
    {
      "content": "The MVVM pattern helps separate application logic from presentation.",
      "pos": [
        16057,
        16125
      ]
    },
    {
      "content": "The model represents the domain data (player, player rank, and player score).",
      "pos": [
        16129,
        16206
      ]
    },
    {
      "content": "The view model is an abstract representation of the view.",
      "pos": [
        16209,
        16266
      ]
    },
    {
      "content": "The view displays the view model and sends user input to the view model.",
      "pos": [
        16270,
        16342
      ]
    },
    {
      "content": "For a Windows Store app, the view is defined in XAML.",
      "pos": [
        16343,
        16396
      ]
    },
    {
      "pos": [
        16408,
        16449
      ],
      "content": "Add a class named <ph id=\"ph1\">`LeaderboardViewModel`</ph>."
    },
    {
      "pos": [
        16940,
        17046
      ],
      "content": "Implement <bpt id=\"p1\">**</bpt>INotifyPropertyChanged<ept id=\"p1\">**</ept> on the view model, so the view model can participate in data binding."
    },
    {
      "content": "Next, add observable properties.",
      "pos": [
        17667,
        17699
      ]
    },
    {
      "content": "The XAML will data bind to these properties.",
      "pos": [
        17700,
        17744
      ]
    },
    {
      "content": "The <ph id=\"ph1\">`IsPending`</ph> property is true while an async operation is pending on the service.",
      "pos": [
        19057,
        19141
      ]
    },
    {
      "content": "The <ph id=\"ph1\">`ErrorMessage`</ph> property holds any error message from the service.",
      "pos": [
        19142,
        19211
      ]
    },
    {
      "content": "Finally, add methods that call through to the service layer.",
      "pos": [
        19214,
        19274
      ]
    },
    {
      "content": "Add a MobileServiceClient instance",
      "pos": [
        22267,
        22301
      ]
    },
    {
      "pos": [
        22303,
        22392
      ],
      "content": "Open the <bpt id=\"p1\">*</bpt>App.xaml.cs<ept id=\"p1\">*</ept>file and add a <bpt id=\"p2\">**</bpt>MobileServiceClient<ept id=\"p2\">**</ept> instance to the <ph id=\"ph1\">`App`</ph> class."
    },
    {
      "content": "When you debug locally, the mobile service runs on IIS express.",
      "pos": [
        22856,
        22919
      ]
    },
    {
      "content": "Visual Studio assigns a random port number, so the local URL is http://localhost:<bpt id=\"p1\">*</bpt>port<ept id=\"p1\">*</ept>, where <bpt id=\"p2\">*</bpt>port<ept id=\"p2\">*</ept> is the port number.",
      "pos": [
        22920,
        23041
      ]
    },
    {
      "content": "To get the port number, start the service in Visual Studio by pressing F5 to debug.",
      "pos": [
        23042,
        23125
      ]
    },
    {
      "content": "Visual Studio will launch a browser and navigate to the service URL.",
      "pos": [
        23126,
        23194
      ]
    },
    {
      "content": "You can also find the local URL in the project properties, under <bpt id=\"p1\">**</bpt>Web<ept id=\"p1\">**</ept>.",
      "pos": [
        23196,
        23269
      ]
    },
    {
      "content": "Create the main page",
      "pos": [
        23274,
        23294
      ]
    },
    {
      "content": "In the main page, add an instance of the view model.",
      "pos": [
        23296,
        23348
      ]
    },
    {
      "content": "Then set the view model as the <bpt id=\"p1\">**</bpt>DataContext<ept id=\"p1\">**</ept> for the page.",
      "pos": [
        23349,
        23409
      ]
    },
    {
      "content": "As I mentioned earlier, I won't show all of the XAML for the app.",
      "pos": [
        23743,
        23808
      ]
    },
    {
      "content": "One benefit of the MVVM pattern is to separate presentation from app logic, so it's easy to change the UI, if you don't like the sample app.",
      "pos": [
        23809,
        23949
      ]
    },
    {
      "pos": [
        23951,
        24001
      ],
      "content": "The list of players is displayed in a <bpt id=\"p1\">**</bpt>ListBox<ept id=\"p1\">**</ept>:"
    },
    {
      "pos": [
        24133,
        24174
      ],
      "content": "Rankings are displayed in a <bpt id=\"p1\">**</bpt>ListView<ept id=\"p1\">**</ept>:"
    },
    {
      "content": "All data binding happens through the view model.",
      "pos": [
        24970,
        25018
      ]
    },
    {
      "content": "Publish your mobile service",
      "pos": [
        25023,
        25050
      ]
    },
    {
      "content": "In this step, you will publish your mobile service to Microsoft Azure and modify the app to use the live service.",
      "pos": [
        25052,
        25165
      ]
    },
    {
      "pos": [
        25167,
        25248
      ],
      "content": "In Solution Explorer, right-click the Leaderboard project and select <bpt id=\"p1\">**</bpt>Publish<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        25260,
        25319
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Publish<ept id=\"p1\">**</ept> dialog, click <bpt id=\"p2\">**</bpt>Azure Mobile Services<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        25331,
        25404
      ],
      "content": "If you are not signed into your Azure account already, click <bpt id=\"p1\">**</bpt>Sign In<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Select an existing Mobile Service, or click <bpt id=\"p1\">**</bpt>New<ept id=\"p1\">**</ept> to create a new one.",
      "pos": [
        25416,
        25488
      ]
    },
    {
      "content": "Then click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept> to publish.",
      "pos": [
        25489,
        25518
      ]
    },
    {
      "content": "The publishing process automatically creates the database.",
      "pos": [
        25530,
        25588
      ]
    },
    {
      "content": "You don't need to configure a connection string.",
      "pos": [
        25589,
        25637
      ]
    },
    {
      "content": "Now you are ready to connect the leaderboard app to the live service.",
      "pos": [
        25639,
        25708
      ]
    },
    {
      "content": "You need two things:",
      "pos": [
        25709,
        25729
      ]
    },
    {
      "content": "The URL of the service",
      "pos": [
        25733,
        25755
      ]
    },
    {
      "content": "The application key",
      "pos": [
        25758,
        25777
      ]
    },
    {
      "content": "You can get both from the Azure Management Portal.",
      "pos": [
        25779,
        25829
      ]
    },
    {
      "content": "In the Management Portal, click <bpt id=\"p1\">**</bpt>Mobile Services<ept id=\"p1\">**</ept>, and then click the mobile service.",
      "pos": [
        25830,
        25917
      ]
    },
    {
      "content": "The service URL is listed on the dashboard tab.",
      "pos": [
        25918,
        25965
      ]
    },
    {
      "content": "To get the application key, click <bpt id=\"p1\">**</bpt>Manage Keys<ept id=\"p1\">**</ept>.",
      "pos": [
        25966,
        26016
      ]
    },
    {
      "pos": [
        26028,
        26105
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Manage Access Keys<ept id=\"p1\">**</ept> dialog, copy the value for the application key."
    },
    {
      "pos": [
        26118,
        26206
      ],
      "content": "Pass the service URL and the application key to the <bpt id=\"p1\">**</bpt>MobileServiceClient<ept id=\"p1\">**</ept> constructor."
    },
    {
      "content": "Now when you run the app, it communicates with the real service.",
      "pos": [
        26564,
        26628
      ]
    },
    {
      "content": "Next Steps",
      "pos": [
        26634,
        26644
      ]
    },
    {
      "content": "[Learn more about Azure Mobile Services]",
      "pos": [
        26648,
        26688
      ]
    },
    {
      "content": "[Learn more about Web API]",
      "pos": [
        26691,
        26717
      ]
    },
    {
      "content": "[Handle database write conflicts]",
      "pos": [
        26720,
        26753
      ]
    },
    {
      "content": "[Add push notifications]; for example, when someone adds a new player or updates a score.",
      "pos": [
        26756,
        26845
      ]
    },
    {
      "content": "[Get started with authentication]",
      "pos": [
        26848,
        26881
      ]
    },
    {
      "content": "test",
      "pos": [
        29664,
        29668
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"Creating a Windows Store leaderboard app with .NET Backend | Microsoft Azure\" \n    description=\"Learn how to build a Windows Store leaderboard app using Azure Mobile Services with a .NET backend.\" \n    documentationCenter=\"windows\" \n    authors=\"MikeWasson\" \n    manager=\"dwrede\" \n    editor=\"\" \n    services=\"mobile-services\"/>\n\n<tags \n    ms.service=\"mobile-services\" \n    ms.workload=\"mobile\" \n    ms.tgt_pltfrm=\"mobile-windows-store\" \n    ms.devlang=\"dotnet\" \n    ms.topic=\"article\" \n    ms.date=\"06/24/2015\" \n    ms.author=\"glenga\"/>\n\n# Creating a Leaderboard App with Azure Mobile Services .NET Backend\n\nThis tutorial shows how build a Windows Store app using Azure Mobile Services with a .NET backend. Azure Mobile Services provides a scalable and secure backend with built-in authentication, monitoring, push notifications, and other features, plus a cross-platform client library for building mobile apps. The .NET backend for Mobile Services is based on [ASP.NET Web API](http://asp.net/web-api), and gives .NET developers a first-class way to create REST APIs.   \n\n## Overview\n\nWeb API is an open-source framework that gives .NET developers a first-class way to create REST APIs. You can host a Web API solution on Azure Websites, on Azure Mobile Services using the .NET backend, or even self-hosted in a custom process. Mobile Services is a hosting environment that is designed especially for mobile apps. When you host your Web API service on Mobile Services, you get the following advantages in addition to data storage:\n\n- Built-in authentication with social providers and Azure Active Directory (AAD). \n- Push notifications to apps using device-specific notification services.\n- A full set of client libraries that make it easy to access your service from any app. \n- Built-in logging and diagnostics.\n\nIn this tutorial you will:\n\n- Create a REST API using Azure Mobile Services.\n- Publish the service to Azure.\n- Create a Windows Store app that consumes the service.\n- Use Entity Framework (EF) to create foreign key relations and data transfer objects (DTOs).\n- Use ASP.NET Web API to define a custom API.\n\nThis tutorial uses [Visual Studio 2013 latest update](http://go.microsoft.com/fwlink/p/?LinkID=390465). \n\n\n## About the sample app\n\nA *leaderboard* shows a list of players for a game, along with their scores and the rank of each player. A leaderboard might be part of a larger game, or could be a separate app. A leaderboard is a real-world application, but is simple enough for a tutorial. Here is a screen shot of the app:\n\n![][1]\n\nTo keep the app simple, there is no actual game. Instead, you can add players and submit a score for each player. When you submit a score, the mobile service calculates the new rankings. On the back end, the mobile service creates a database with two tables:\n\n- Player. Contains the player ID and name.\n- PlayerRank. Contains a player's score and rank.\n\nPlayerRank has a foreign key to Player. Each player has zero or one PlayerRank.\n\nIn a real leaderboard app, PlayerRank might also have a game ID, so that a player could submit scores for more than one game.\n\n![][2]\n\nThe client app can perform the full set of CRUD operations on Players. It can read or delete existing PlayerRank entities, but it cannot create or update them directly. That's because the rank value is calculated by the service. Instead, the client submits a score, and the service updates the ranks for all players.\n\nDownload the completed project [here](http://code.msdn.microsoft.com/Leaderboard-App-with-Azure-9acf63af).\n\n\n## Create the project\n\nLaunch Visual Studio and create a new ASP.NET Web Application project. Name the project Leaderboard.\n\n![][3]\n\nIn Visual Studio 2013, the ASP.NET Web Application project includes a template for Azure Mobile Service. Select this template and click **OK**.\n\n![][4]\n \nThe project template includes an example controller and data object.  \n\n![][5]\n \nThese aren't needed for the tutorial, so you can delete them from the project. Also remove the references to TodoItem  in WebApiConfig.cs and LeaderboardContext.cs.\n\n## Add data models\n\nYou will use [EF Code First](http://msdn.microsoft.com/data/ee712907#codefirst) to define the database tables. Under the DataObjects folder, add a class named `Player`.\n\n    using Microsoft.WindowsAzure.Mobile.Service;\n    \n    namespace Leaderboard.DataObjects\n    {\n        public class Player : EntityData\n        {\n            public string Name { get; set; }\n        }\n    }\n\nAdd another class named `PlayerRank`.\n\n    using Microsoft.WindowsAzure.Mobile.Service;\n    using System.ComponentModel.DataAnnotations.Schema;\n    \n    namespace Leaderboard.DataObjects\n    {\n        public class PlayerRank : EntityData\n        {\n            public int Score { get; set; }\n            public int Rank { get; set; }\n    \n            [ForeignKey(\"Id\")]\n            public virtual Player Player { get; set; }\n        }\n    }\n\nNotice that both classes inherit from the **EntityData** class. Deriving from **EntityData** makes it easy for the app consume the data, using the cross-platform client library for Azure Mobile Services. **EntityData** also makes it easier for an app to [handle database write conflicts](mobile-services-windows-store-dotnet-handle-database-conflicts.md).\n\nThe `PlayerRank` class has a [navigation property](http://msdn.microsoft.com/data/jj713564.aspx) that points to the related `Player` entity. The **[ForeignKey]** attribute tells EF that the `Player` property represents a foreign key.\n\n## Add Web API controllers\n\nNext, you will add Web API controllers for `Player` and `PlayerRank`. Instead of plain Web API controllers, you will add a special kind of controller called a *table controller*, designed specifically for Azure Mobile Services.\n\nRight click the Controllers folder >  **Add** > **New Scaffolded Item**.\n\n![][6] \n\nIn the **Add Scaffold** dialog, expand **Common** on the left and select **Azure Mobile Services**. Then select **Azure Mobile Services Table Controller**. Click **Add**.\n\n![][7] \n \nIn the **Add Controller** dialog:\n\n1.  Under **Model class**, select Player. \n2.  Under **Data context class**, select MobileServiceContext.\n3.  Name the controller \"PlayerController\".\n4.  Click **Add**.\n\n\nThis step adds a file named PlayerController.cs to the project.\n\n![][8] \n\nThe controller derives from **TableController<T>**. This class inherits **ApiController**, but is specialized for Azure Mobile Services.\n \n- Routing: The default route for a **TableController** is `/tables/{table_name}/{id}`, where *table_name* matches the entity name. So the route for the Player controller is */tables/player/{id}*. This routing convention makes **TableController** consistent with the Mobile Services [REST API](http://msdn.microsoft.com/library/azure/jj710104.aspx).\n- Data access: For database operations, the **TableController** class uses the **IDomainManager** interface, which defines an abstraction for data access.  The scaffolding uses **EntityDomainManager**, which is a concrete implementation of **IDomainManager** that wraps an EF context. \n\nNow add a second controller for PlayerRank entities. Follow the same steps, but choose PlayerRank for the model class. Use the same data context class; don't create a new one. Name the controller \"PlayerRankController\".\n\n## Use a DTO to return related entities\n\nRecall that `PlayerRank` has a related `Player` entity: \n\n    public class PlayerRank : EntityData\n    {\n        public int Score { get; set; }\n        public int Rank { get; set; }\n\n        [ForeignKey(\"Id\")]\n        public virtual Player Player { get; set; }\n    }\n\nThe Mobile Service client library does not support navigation properties, and they will not be serialized. For example, here is the raw HTTP response for GET `/tables/PlayerRank`:\n\n    HTTP/1.1 200 OK\n    Cache-Control: no-cache\n    Pragma: no-cache\n    Content-Length: 97\n    Content-Type: application/json; charset=utf-8\n    Expires: 0\n    Server: Microsoft-IIS/8.0\n    Date: Mon, 21 Apr 2014 17:58:43 GMT\n    \n    [{\"id\":\"1\",\"rank\":1,\"score\":150},{\"id\":\"2\",\"rank\":3,\"score\":100},{\"id\":\"3\",\"rank\":1,\"score\":150}]\n\nNotice that `Player` is not included in the object graph. To include the player, we can flatten the object graph by defining a *data transfer object* (DTO). \n\nA DTO is an object that defines how data is sent over the network. DTOs are useful whenever you want the wire format to look different than your database model. To create a DTO for `PlayerRank`, add a new class named `PlayerRankDto` in the DataObjects folder.\n\n    namespace Leaderboard.DataObjects\n    {\n        public class PlayerRankDto\n        {\n            public string Id { get; set; }\n            public string PlayerName { get; set; }\n            public int Score { get; set; }\n            public int Rank { get; set; }\n        }\n    }\n\nIn the `PlayerRankController` class, we'll use the LINQ **Select** method to convert `PlayerRank` instances to `PlayerRankDto` instances. Update the `GetAllPlayerRank` and `GetPlayerRank` controller methods as follows:\n\n    // GET tables/PlayerRank\n    public IQueryable<PlayerRankDto> GetAllPlayerRank()\n    {\n        return Query().Select(x => new PlayerRankDto()\n        {\n            Id = x.Id,\n            PlayerName = x.Player.Name,\n            Score = x.Score,\n            Rank = x.Rank\n        });\n    }\n    \n    // GET tables/PlayerRank/48D68C86-6EA6-4C25-AA33-223FC9A27959\n    public SingleResult<PlayerRankDto> GetPlayerRank(string id)\n    {\n        var result = Lookup(id).Queryable.Select(x => new PlayerRankDto()\n        {\n            Id = x.Id,\n            PlayerName = x.Player.Name,\n            Score = x.Score,\n            Rank = x.Rank\n        });\n    \n        return SingleResult<PlayerRankDto>.Create(result);\n    }\n\nWith these changes, the two GET methods return `PlayerRankDto` objects to the client. The `PlayerRankDto.PlayerName` property is set to the player name. Here is an example response after making this change:\n\n    HTTP/1.1 200 OK\n    Cache-Control: no-cache\n    Pragma: no-cache\n    Content-Length: 160\n    Content-Type: application/json; charset=utf-8\n    Expires: 0\n    Server: Microsoft-IIS/8.0\n    Date: Mon, 21 Apr 2014 19:57:08 GMT\n    \n    [{\"id\":\"1\",\"playerName\":\"Alice\",\"score\":150,\"rank\":1},{\"id\":\"2\",\"playerName\":\"Bob\",\"score\":100,\"rank\":3},{\"id\":\"3\",\"playerName\":\"Charles\",\"score\":150,\"rank\":1}]\n\nNotice that the JSON payload now includes the player names.\n\nInstead of using LINQ Select statements, another option is to use AutoMapper. This option requires some additional setup code, but enables automatic mapping from domain entities to DTOs. For more information, see [Mapping between Database Types and Client Types in the .NET Backend using AutoMapper](http://blogs.msdn.com/b/azuremobile/archive/2014/05/19/mapping-between-database-types-and-client-type-in-the-net-backend-using-automapper.aspx).\n\n## Define a custom API to submit scores\n\nThe `PlayerRank` entity includes a `Rank` property. This value is calculated by the server, and we don't want clients setting it. Instead, clients will use a custom API to submit a player's score.  When the server gets a new score, it will update all of the player ranks.\n\nFirst, add a class named `PlayerScore` to the DataObjects folder.\n\n    namespace Leaderboard.DataObjects\n    {\n        public class PlayerScore\n        {\n            public string PlayerId { get; set; }\n            public int Score { get; set; }\n        }\n    }\n\nIn the `PlayerRankController` class, move the `MobileServiceContext` variable from the constructor to a class variable:\n\n    public class PlayerRankController : TableController<PlayerRank>\n    {\n        // Add this:\n        MobileServiceContext context = new MobileServiceContext();\n\n        protected override void Initialize(HttpControllerContext controllerContext)\n        {\n            base.Initialize(controllerContext);\n\n            // Delete this:\n            // MobileServiceContext context = new MobileServiceContext();\n            DomainManager = new EntityDomainManager<PlayerRank>(context, Request, Services);\n        }\n\n\nDelete the following methods from `PlayerRankController`:\n\n- `PatchPlayerRank` \n- `PostPlayerRank` \n- `DeletePlayerRank`\n\nThen add the following code to `PlayerRankController`:\n\n    [Route(\"api/score\")]\n    public async Task<IHttpActionResult> PostPlayerScore(PlayerScore score)\n    {\n        // Does this player exist?\n        var count = context.Players.Where(x => x.Id == score.PlayerId).Count();\n        if (count < 1)\n        {\n            return BadRequest();\n        }\n\n        // Try to find the PlayerRank entity for this player. If not found, create a new one.\n        PlayerRank rank = await context.PlayerRanks.FindAsync(score.PlayerId);\n        if (rank == null)\n        {\n            rank = new PlayerRank { Id = score.PlayerId };\n            rank.Score = score.Score;\n            context.PlayerRanks.Add(rank);\n        }\n        else\n        {\n            rank.Score = score.Score;\n        }\n\n        await context.SaveChangesAsync();\n\n        // Update rankings\n        // See http://stackoverflow.com/a/575799\n        const string updateCommand =\n            \"UPDATE r SET Rank = ((SELECT COUNT(*)+1 from {0}.PlayerRanks \" +\n            \"where Score > (select score from {0}.PlayerRanks where Id = r.Id)))\" +\n            \"FROM {0}.PlayerRanks as r\";\n\n        string command = String.Format(updateCommand, ServiceSettingsDictionary.GetSchemaName());\n        await context.Database.ExecuteSqlCommandAsync(command);\n\n        return Ok();\n    }\n\nThe `PostPlayerScore` method takes a `PlayerScore` instance as input. (The client will send the `PlayerScore` in an HTTP POST request.) The method does the following:\n\n1.  Adds a new `PlayerRank` for the player, if there isn't one in the database already.\n2.  Updates the player's score.\n3.  Run a SQL query that batch updates all of the player ranks.\n\nThe **[Route]** attribute defines a custom route for this method:\n\n    [Route(\"api/score\")]\n\nYou could also put the method into a separate controller. There is no particular advantage either way, it just depends how you want to organize your code.\nTo learn more about the **[Route]** attribute, see [Attribute Routing in Web API](http://www.asp.net/web-api/overview/web-api-routing-and-actions/attribute-routing-in-web-api-2).\n\n## Create the Windows Store app\n\nIn this section, I'll describe the Windows Store app that consumes the mobile service. However, I won't focus much on the XAML or the UI. Instead, I want to focus on the application logic. You can download the complete project [here](http://code.msdn.microsoft.com/Leaderboard-App-with-Azure-9acf63af).\n\nAdd a new Windows Store App project to the solution. I used the Blank App (Windows) template. \n\n![][10]\n \nUse NuGet Package Manager to add the Mobile Services client library. In Visual Studio, from the **Tools** menu, select **NuGet Package Manager**. Then select **Package Manager Console**. In the Package Manager Console window, type the following command.\n\n    Install-Package WindowsAzure.MobileServices -Project LeaderboardApp\n\nThe -Project switch specifies which project to install the package to.\n\n## Add model classes\n\nCreate a folder named Models and add the following classes:\n\n    namespace LeaderboardApp.Models\n    {\n        public class Player\n        {\n            public string Id { get; set; }\n            public string Name { get; set; }\n        }\n    \n        public class PlayerRank\n        {\n            public string Id { get; set; }\n            public string PlayerName { get; set; }\n            public int Score { get; set; }\n            public int Rank { get; set; }\n        }\n    \n        public class PlayerScore\n        {\n            public string PlayerId { get; set; }\n            public int Score { get; set; }\n        }\n    }\n\nThese classes correspond directly to the data entities in the mobile service.\n \n## Create a view model\n\nModel-View-ViewModel (MVVM) is a variant of Model-View-Controller (MVC). The MVVM pattern helps separate application logic from presentation.\n\n- The model represents the domain data (player, player rank, and player score).\n- The view model is an abstract representation of the view. \n- The view displays the view model and sends user input to the view model. For a Windows Store app, the view is defined in XAML.\n\n![][11] \n\nAdd a class named `LeaderboardViewModel`.\n\n    using LeaderboardApp.Models;\n    using Microsoft.WindowsAzure.MobileServices;\n    using System.ComponentModel;\n    using System.Net.Http;\n    using System.Threading.Tasks;\n    \n    namespace LeaderboardApp.ViewModel\n    {\n        class LeaderboardViewModel : INotifyPropertyChanged\n        {\n            MobileServiceClient _client;\n    \n            public LeaderboardViewModel(MobileServiceClient client)\n            {\n                _client = client;\n            }\n        }\n    }\n\nImplement **INotifyPropertyChanged** on the view model, so the view model can participate in data binding. \n\n    class LeaderboardViewModel : INotifyPropertyChanged\n    {\n        MobileServiceClient _client;\n\n        public LeaderboardViewModel(MobileServiceClient client)\n        {\n            _client = client;\n        }\n\n        // New code:\n        // INotifyPropertyChanged implementation\n        public event PropertyChangedEventHandler PropertyChanged;\n\n        public void NotifyPropertyChanged(string propertyName)\n        {\n            if (PropertyChanged != null)\n            {\n                PropertyChanged(this,\n                    new PropertyChangedEventArgs(propertyName));\n            }\n        }    \n    }\n\nNext, add observable properties. The XAML will data bind to these properties. \n\n    class LeaderboardViewModel : INotifyPropertyChanged\n    {\n        // ...\n\n        // New code:\n        // View model properties\n        private MobileServiceCollection<Player, Player> _Players;\n        public MobileServiceCollection<Player, Player> Players\n        {\n            get { return _Players; }\n            set\n            {\n                _Players = value;\n                NotifyPropertyChanged(\"Players\");\n            }\n        }\n\n        private MobileServiceCollection<PlayerRank, PlayerRank> _Ranks;\n        public MobileServiceCollection<PlayerRank, PlayerRank> Ranks\n        {\n            get { return _Ranks; }\n            set\n            {\n                _Ranks = value;\n                NotifyPropertyChanged(\"Ranks\");\n            }\n        }\n\n        private bool _IsPending;\n        public bool IsPending\n        {\n            get { return _IsPending; }\n            set\n            {\n                _IsPending = value;\n                NotifyPropertyChanged(\"IsPending\");\n            }\n        }\n\n        private string _ErrorMessage = null;\n        public string ErrorMessage\n        {\n            get { return _ErrorMessage; }\n            set\n            {\n                _ErrorMessage = value;\n                NotifyPropertyChanged(\"ErrorMessage\");\n            }\n        }\n    }\n\nThe `IsPending` property is true while an async operation is pending on the service. The `ErrorMessage` property holds any error message from the service. \n\nFinally, add methods that call through to the service layer. \n\n    class LeaderboardViewModel : INotifyPropertyChanged\n    {\n        // ...\n\n        // New code:\n        // Service operations\n        public async Task GetAllPlayersAsync()\n        {\n            IsPending = true;\n            ErrorMessage = null;\n\n            try\n            {\n                IMobileServiceTable<Player> table = _client.GetTable<Player>();\n                Players = await table.OrderBy(x => x.Name).ToCollectionAsync();\n            }\n            catch (MobileServiceInvalidOperationException ex)\n            {\n                ErrorMessage = ex.Message;\n            }\n            catch (HttpRequestException ex2)\n            {\n                ErrorMessage = ex2.Message;\n            }\n            finally\n            {\n                IsPending = false;\n            }\n        }\n\n        public async Task AddPlayerAsync(Player player)\n        {\n            IsPending = true;\n            ErrorMessage = null;\n\n            try\n            {\n                IMobileServiceTable<Player> table = _client.GetTable<Player>();\n                await table.InsertAsync(player);\n                Players.Add(player);\n            }\n            catch (MobileServiceInvalidOperationException ex)\n            {\n                ErrorMessage = ex.Message;\n            }\n            catch (HttpRequestException ex2)\n            {\n                ErrorMessage = ex2.Message;\n            }\n            finally\n            {\n                IsPending = false;\n            }\n        }\n\n        public async Task SubmitScoreAsync(Player player, int score)\n        {\n            IsPending = true;\n            ErrorMessage = null;\n\n            var playerScore = new PlayerScore()\n            {\n                PlayerId = player.Id,\n                Score = score\n            }; \n            \n            try\n            {\n                await _client.InvokeApiAsync<PlayerScore, object>(\"score\", playerScore);\n                await GetAllRanksAsync();\n            }\n            catch (MobileServiceInvalidOperationException ex)\n            {\n                ErrorMessage = ex.Message;\n            }\n            catch (HttpRequestException ex2)\n            {\n                ErrorMessage = ex2.Message;\n            }\n            finally\n            {\n                IsPending = false;\n            }\n        }\n\n        public async Task GetAllRanksAsync()\n        {\n            IsPending = true;\n            ErrorMessage = null;\n\n            try\n            {\n                IMobileServiceTable<PlayerRank> table = _client.GetTable<PlayerRank>();\n                Ranks = await table.OrderBy(x => x.Rank).ToCollectionAsync();\n            }\n            catch (MobileServiceInvalidOperationException ex)\n            {\n                ErrorMessage = ex.Message;\n            }\n            catch (HttpRequestException ex2)\n            {\n                ErrorMessage = ex2.Message;\n            }\n            finally\n            {\n                IsPending = false;\n            }\n         }    \n    }\n\n## Add a MobileServiceClient instance\n\nOpen the *App.xaml.cs*file and add a **MobileServiceClient** instance to the `App` class.\n\n    // New code:\n    using Microsoft.WindowsAzure.MobileServices;\n    \n    namespace LeaderboardApp\n    {\n        sealed partial class App : Application\n        {\n            // New code.\n            // TODO: Replace 'port' with the actual port number.\n            const string serviceUrl = \"http://localhost:port/\";\n            public static MobileServiceClient MobileService = new MobileServiceClient(serviceUrl);\n    \n    \n            // ...\n        }\n    }\n\nWhen you debug locally, the mobile service runs on IIS express. Visual Studio assigns a random port number, so the local URL is http://localhost:*port*, where *port* is the port number. To get the port number, start the service in Visual Studio by pressing F5 to debug. Visual Studio will launch a browser and navigate to the service URL.  You can also find the local URL in the project properties, under **Web**.\n\n## Create the main page\n\nIn the main page, add an instance of the view model. Then set the view model as the **DataContext** for the page.\n\n    public sealed partial class MainPage : Page\n    {\n        // New code:\n        LeaderboardViewModel viewModel = new LeaderboardViewModel(App.MobileService);\n\n        public MainPage()\n        {\n            this.InitializeComponent();\n            // New code:\n            this.DataContext = viewModel;\n        }\n\n       // ...\n\n\nAs I mentioned earlier, I won't show all of the XAML for the app. One benefit of the MVVM pattern is to separate presentation from app logic, so it's easy to change the UI, if you don't like the sample app.\n\nThe list of players is displayed in a **ListBox**:\n\n    <ListBox Width=\"200\" Height=\"400\" x:Name=\"PlayerListBox\" \n        ItemsSource=\"{Binding Players}\" DisplayMemberPath=\"Name\"/>\n\nRankings are displayed in a **ListView**:\n\n    <ListView x:Name=\"RankingsListView\" ItemsSource=\"{Binding Ranks}\" SelectionMode=\"None\">\n        <!-- Header and styles not shown -->\n        <ListView.ItemTemplate>\n            <DataTemplate>\n                <Grid>\n                    <Grid.ColumnDefinitions>\n                        <ColumnDefinition Width=\"*\"/>\n                        <ColumnDefinition Width=\"2*\"/>\n                        <ColumnDefinition Width=\"*\"/>\n                    </Grid.ColumnDefinitions>\n                    <TextBlock Text=\"{Binding Path=Rank}\"/>\n                    <TextBlock Text=\"{Binding Path=PlayerName}\" Grid.Column=\"1\"/>\n                    <TextBlock Text=\"{Binding Path=Score}\" Grid.Column=\"2\"/>\n                </Grid>\n            </DataTemplate>\n        </ListView.ItemTemplate>\n    </ListView>\n\nAll data binding happens through the view model.\n\n## Publish your mobile service\n\nIn this step, you will publish your mobile service to Microsoft Azure and modify the app to use the live service.\n\nIn Solution Explorer, right-click the Leaderboard project and select **Publish**.\n \n![][12]\n\nIn the **Publish** dialog, click **Azure Mobile Services**.\n\n![][13]\n \nIf you are not signed into your Azure account already, click **Sign In**.\n\n![][14]\n\n\nSelect an existing Mobile Service, or click **New** to create a new one. Then click **OK** to publish.\n\n![][15]\n \nThe publishing process automatically creates the database. You don't need to configure a connection string.\n\nNow you are ready to connect the leaderboard app to the live service. You need two things:\n\n- The URL of the service\n- The application key\n\nYou can get both from the Azure Management Portal. In the Management Portal, click **Mobile Services**, and then click the mobile service. The service URL is listed on the dashboard tab. To get the application key, click **Manage Keys**.\n\n![][16]\n \nIn the **Manage Access Keys** dialog, copy the value for the application key.\n\n![][17]\n\n \nPass the service URL and the application key to the **MobileServiceClient** constructor.\n\n    sealed partial class App : Application\n    {\n        // TODO: Replace these strings with the real URL and key.\n        const string serviceUrl = \"https://yourapp.azure-mobile.net/\";\n        const string appKey = \"YOUR ACCESSS KEY\";\n\n        public static MobileServiceClient MobileService = new MobileServiceClient(serviceUrl, appKey);\n\n       // ...\n\nNow when you run the app, it communicates with the real service. \n\n## Next Steps\n\n* [Learn more about Azure Mobile Services]\n* [Learn more about Web API]\n* [Handle database write conflicts]\n* [Add push notifications]; for example, when someone adds a new player or updates a score.\n* [Get started with authentication]\n\n<!-- Anchors. -->\n[Overview]: #overview\n[About the sample app]: #about-the-sample-app\n[Create the project]: #create-the-project\n[Add data models]: #add-data-models\n[Add Web API controllers]: #add-web-api-controllers\n[Use a DTO to return related entities]: #use-a-dto-to-return-related-entities\n[Define a custom API to submit scores]: #define-a-custom-api-to-submit-scores\n[Create the Windows Store app]: #create-the-windows-store-app\n[Add model classes]: #add-model-classes\n[Create a view model]: #create-a-view-model\n[Add a MobileServiceClient instance]: #add-a-mobileserviceclient-instance\n[Create the main page]: #create-the-main-page\n[Publish your mobile service]: #publish-your-mobile-service\n[Next Steps]: #next-steps\n\n<!-- Images. -->\n\n[1]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/01leaderboard.png\n[2]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/02leaderboard.png\n[3]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/03leaderboard.png\n[4]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/04leaderboard.png\n[5]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/05leaderboard.png\n[6]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/06leaderboard.png\n[7]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/07leaderboard.png\n[8]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/08leaderboard.png\n[9]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/09leaderboard.png\n[10]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/10leaderboard.png\n[11]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/11leaderboard.png\n[12]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/12leaderboard.png\n[13]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/13leaderboard.png\n[14]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/14leaderboard.png\n[15]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/15leaderboard.png\n[16]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/16leaderboard.png\n[17]: ./media/mobile-services-dotnet-backend-windows-store-dotnet-leaderboard/17leaderboard.png\n\n<!-- URLs. -->\n\n[Learn more about Azure Mobile Services]: /develop/mobile/resources/\n[Learn more about Web API]: http://asp.net/web-api\n[Handle database write conflicts]: mobile-services-windows-store-dotnet-handle-database-conflicts.md\n[Add push notifications]: ../notification-hubs-windows-store-dotnet-get-started.md\n[Get started with authentication]: /develop/mobile/tutorials/get-started-with-users-dotnet\n\n \ntest\n"
}