{
  "nodes": [
    {
      "content": "Analyze data from servers in Microsoft Azure",
      "pos": [
        26,
        70
      ]
    },
    {
      "content": "Search event and IIS logs for cloud services and virtual machines by enabling Azure diagnostics.",
      "pos": [
        88,
        184
      ]
    },
    {
      "content": "Analyze data from servers in Microsoft Azure",
      "pos": [
        496,
        540
      ]
    },
    {
      "content": "Operational Insights uses data from servers in your on-premises or cloud infrastructure.",
      "pos": [
        642,
        730
      ]
    },
    {
      "content": "You can collect machine data from Azure storage when generated by Azure diagnostics.",
      "pos": [
        731,
        815
      ]
    },
    {
      "content": "Using the data you collect from Azure storage, you can quickly search event and IIS logs for cloud services and virtual machines.",
      "pos": [
        817,
        946
      ]
    },
    {
      "content": "You can also get additional insights from your virtual machines by installing the Microsoft Monitoring Agent.",
      "pos": [
        947,
        1056
      ]
    },
    {
      "content": "The Update Assessment, Change Tracking, and SQL Assessment solutions all work with the Microsoft Monitoring Agent to provide deeper insights on your virtual machines.",
      "pos": [
        1058,
        1224
      ]
    },
    {
      "content": "If you haven’t already, you can <bpt id=\"p1\">[</bpt>add solutions<ept id=\"p1\">](operational-insights-setup-workspace.md)</ept> when you’re signed into the <bpt id=\"p2\">[</bpt>Operational Insights portal<ept id=\"p2\">](https://www.microsoft.com/oms/)</ept>.",
      "pos": [
        1225,
        1404
      ]
    },
    {
      "content": "For Azure virtual machines, there are two easy ways to enable agent-based data collection:",
      "pos": [
        1406,
        1496
      ]
    },
    {
      "content": "In the Microsoft Azure management portal",
      "pos": [
        1500,
        1540
      ]
    },
    {
      "content": "Using PowerShell",
      "pos": [
        1544,
        1560
      ]
    },
    {
      "pos": [
        1562,
        1761
      ],
      "content": "When using agent-based collection for log data, you must configure which logs to collect in the Log Management configuration page of the <bpt id=\"p1\">[</bpt>Operational Insights portal<ept id=\"p1\">](https://www.microsoft.com/oms/)</ept>."
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> If you’ve configured Operational Insights to index log data using Azure diagnostics and you configure the agent to collect logs, then the same logs will be indexed twice.",
      "pos": [
        1765,
        1948
      ]
    },
    {
      "content": "You will be charged normal data rates for both data sources.",
      "pos": [
        1949,
        2009
      ]
    },
    {
      "content": "If you have the agent installed, then you should collect log data using the agent and not index the logs collected by Azure diagnostics.",
      "pos": [
        2010,
        2146
      ]
    },
    {
      "content": "Microsoft Azure Management Portal",
      "pos": [
        2151,
        2184
      ]
    },
    {
      "pos": [
        2186,
        2345
      ],
      "content": "You can install the agent for Operational Insights from the <bpt id=\"p1\">[</bpt>Azure portal<ept id=\"p1\">](https://manage.windowsazure.com/#Workspaces/OperationalInsightExtension/Workspaces)</ept>."
    },
    {
      "content": "To install the agent for Operational Insights",
      "pos": [
        2351,
        2396
      ]
    },
    {
      "pos": [
        2400,
        2494
      ],
      "content": "In the Azure portal, go to your Operational Insights workspace and select the <bpt id=\"p1\">**</bpt>Servers<ept id=\"p1\">**</ept> tab."
    },
    {
      "content": "On the tab, you’ll see a list of your virtual machines.",
      "pos": [
        2498,
        2553
      ]
    },
    {
      "content": "Select the virtual machine you want to install the agent on and then click <bpt id=\"p1\">**</bpt>Enable Op Insights<ept id=\"p1\">**</ept>.",
      "pos": [
        2554,
        2652
      ]
    },
    {
      "content": "The agent is automatically installed and configured for your Operational Insights workspace.",
      "pos": [
        2654,
        2746
      ]
    },
    {
      "content": "Image of Operational Insights Servers page",
      "pos": [
        2750,
        2792
      ]
    },
    {
      "pos": [
        2858,
        3026
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> The <bpt id=\"p1\">[</bpt>Azure VM agent<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/dn832621.aspx)</ept> must be installed to automatically install the agent for Operational Insights."
    },
    {
      "content": "PowerShell",
      "pos": [
        3033,
        3043
      ]
    },
    {
      "content": "If you prefer scripting to make changes to your Azure virtual machines, then you can enable the Microsoft Monitoring Agent using PowerShell.",
      "pos": [
        3045,
        3185
      ]
    },
    {
      "pos": [
        3187,
        3384
      ],
      "content": "The Microsoft Monitoring Agent is an <bpt id=\"p1\">[</bpt>Azure virtual machine extension<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/dn832621.aspx)</ept> and you can manage it using PowerShell, as shown in the example below."
    },
    {
      "content": "When configuring using PowerShell, you need to provide the Workspace ID and Primary Key.",
      "pos": [
        3867,
        3955
      ]
    },
    {
      "content": "You can find your Workspace ID and Primary Key on the <bpt id=\"p1\">**</bpt>Settings<ept id=\"p1\">**</ept> page of the Operational Insights portal.",
      "pos": [
        3956,
        4063
      ]
    },
    {
      "content": "sources",
      "pos": [
        4067,
        4074
      ]
    },
    {
      "content": "Collect data using Azure diagnostics",
      "pos": [
        4143,
        4179
      ]
    },
    {
      "content": "Operational Insights can analyze data written to Azure storage by Azure diagnostics.",
      "pos": [
        4181,
        4265
      ]
    },
    {
      "content": "There are 2 main steps to perform:",
      "pos": [
        4266,
        4300
      ]
    },
    {
      "content": "Configure the collection of diagnostic data to Azure storage",
      "pos": [
        4304,
        4364
      ]
    },
    {
      "content": "Configure Operational Insights to analyze data in the storage account",
      "pos": [
        4367,
        4436
      ]
    },
    {
      "content": "The topics below describe how to enable collection of diagnostics data to Azure storage and then how to configure Operational Insights to analyze the data in Azure storage.",
      "pos": [
        4438,
        4610
      ]
    },
    {
      "content": "Azure Diagnostics is an Azure extensions that enables you to collect diagnostic data from a worker role, web role, or virtual machine running in Azure.",
      "pos": [
        4612,
        4763
      ]
    },
    {
      "content": "The data is stored in an Azure storage account and can then be used by Operational Insights.",
      "pos": [
        4764,
        4856
      ]
    },
    {
      "pos": [
        4859,
        5059
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> You'll be charged normal data rates for storage and transactions when you send diagnostics to a storage account and for when Operational Insights reads the data from your storage account."
    },
    {
      "content": "Azure Diagnostics can collect the following types of telemetry:",
      "pos": [
        5061,
        5124
      ]
    },
    {
      "content": "Data Source",
      "pos": [
        5126,
        5137
      ]
    },
    {
      "content": "Description",
      "pos": [
        5138,
        5149
      ]
    },
    {
      "content": "IIS Logs",
      "pos": [
        5159,
        5167
      ]
    },
    {
      "content": "Information about IIS web sites.",
      "pos": [
        5168,
        5200
      ]
    },
    {
      "content": "Azure Diagnostic infrastructure logs",
      "pos": [
        5201,
        5237
      ]
    },
    {
      "content": "Information about Diagnostics itself.",
      "pos": [
        5238,
        5275
      ]
    },
    {
      "content": "IIS Failed Request logs",
      "pos": [
        5276,
        5299
      ]
    },
    {
      "content": "Information about failed requests to an IIS site or application.",
      "pos": [
        5301,
        5365
      ]
    },
    {
      "content": "Windows Event logs",
      "pos": [
        5366,
        5384
      ]
    },
    {
      "content": "Information sent to the Windows event logging system.",
      "pos": [
        5385,
        5438
      ]
    },
    {
      "content": "Performance counters",
      "pos": [
        5439,
        5459
      ]
    },
    {
      "content": "Operating System and custom performance counters.",
      "pos": [
        5460,
        5509
      ]
    },
    {
      "content": "Crash dumps",
      "pos": [
        5510,
        5521
      ]
    },
    {
      "content": "Information about the state of the process in the event of an application crash.",
      "pos": [
        5522,
        5602
      ]
    },
    {
      "content": "Custom error logs",
      "pos": [
        5603,
        5620
      ]
    },
    {
      "content": "Logs created by your application or service.",
      "pos": [
        5621,
        5665
      ]
    },
    {
      "content": "NET EventSource",
      "pos": [
        5666,
        5681
      ]
    },
    {
      "pos": [
        5682,
        5836
      ],
      "content": "Events generated by your code using the .NET <bpt id=\"p1\">[</bpt>EventSource class<ept id=\"p1\">](https://msdn.microsoft.com/library/system.diagnostics.tracing.eventsource(v=vs.110).aspx)</ept>"
    },
    {
      "content": "Manifest based ETW",
      "pos": [
        5837,
        5855
      ]
    },
    {
      "content": "ETW events generated by any process",
      "pos": [
        5856,
        5891
      ]
    },
    {
      "content": "Syslog",
      "pos": [
        5892,
        5898
      ]
    },
    {
      "content": "Events sent to the Syslog or Rsyslog daemons",
      "pos": [
        5899,
        5943
      ]
    },
    {
      "content": "Currently, Operational Insights is able to analyze:",
      "pos": [
        5946,
        5997
      ]
    },
    {
      "content": "IIS logs from Web roles and virtual machines",
      "pos": [
        6001,
        6045
      ]
    },
    {
      "content": "Windows Event logs from Web roles, Worker roles and Azure virtual machines running a Windows operating system",
      "pos": [
        6048,
        6157
      ]
    },
    {
      "content": "Syslog from Azure virtual machines running a Linux operating system",
      "pos": [
        6160,
        6227
      ]
    },
    {
      "content": "The logs must be in the following locations:",
      "pos": [
        6229,
        6273
      ]
    },
    {
      "content": "WADWindowsEventLogsTable (Table Storage) – Contains information from Windows Event logs.",
      "pos": [
        6277,
        6365
      ]
    },
    {
      "content": "wad-iis-logfiles (Blob Storage) – Contains information about IIS logs.",
      "pos": [
        6368,
        6438
      ]
    },
    {
      "content": "LinuxsyslogVer2v0 (Table Storage) – Contains Linux syslog events.",
      "pos": [
        6441,
        6506
      ]
    },
    {
      "pos": [
        6510,
        6580
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> IIS logs from Azure Websites are not currently supported."
    },
    {
      "content": "For virtual machines, you also have the option of installing the <bpt id=\"p1\">[</bpt>Microsoft Monitoring Agent<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=517269)</ept> into your virtual machine to enable additional insights.",
      "pos": [
        6582,
        6779
      ]
    },
    {
      "content": "In addition to being able to analyze IIS logs and Event Logs you will also allow be able to perform additional analysis including configuration change tracking, SQL assessment and update assessment.",
      "pos": [
        6780,
        6978
      ]
    },
    {
      "pos": [
        6980,
        7216
      ],
      "content": "You can help us prioritize additional logs for Operational Insights to analyze by voting on our <bpt id=\"p1\">[</bpt>feedback page<ept id=\"p1\">](http://feedback.azure.com/forums/267889-azure-operational-insights/category/88086-log-management-and-log-collection-policy)</ept>."
    },
    {
      "content": "Enable Azure diagnostics in a Web role for IIS log and event collection",
      "pos": [
        7221,
        7292
      ]
    },
    {
      "content": "Refer to <bpt id=\"p1\">[</bpt>How To Enable Diagnostics in a Cloud Service<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/dn482131.aspx)</ept>.",
      "pos": [
        7294,
        7406
      ]
    },
    {
      "content": "You’ll use the basic information from there and customize the steps here for use with Microsoft Azure Operational Insights.",
      "pos": [
        7407,
        7530
      ]
    },
    {
      "content": "With Azure diagnostics enabled:",
      "pos": [
        7532,
        7563
      ]
    },
    {
      "content": "IIS logs are stored by default, with log data transferred at the scheduledTransferPeriod transfer interval.",
      "pos": [
        7567,
        7674
      ]
    },
    {
      "content": "Windows Event Logs are not transferred by default.",
      "pos": [
        7678,
        7728
      ]
    },
    {
      "content": "To enable diagnostics",
      "pos": [
        7734,
        7755
      ]
    },
    {
      "pos": [
        7757,
        8357
      ],
      "content": "To enable Windows Event Logs, or to change the scheduledTransferPeriod, configure Azure Diagnostics using the XML configuration file (diagnostics.wadcfg), as shown in <bpt id=\"p1\">[</bpt>Step 2: Add the diagnostics.wadcfg file to your Visual Studio solution<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/dn482131.aspx#BKMK_step2)</ept> and <bpt id=\"p2\">[</bpt>Step 3: Configure diagnostics for your application<ept id=\"p2\">](https://msdn.microsoft.com/library/azure/dn482131.aspx#BKMK_step3)</ept> in the How To Enable Diagnostics in a Cloud Service topic.The following example configuration file collects IIS Logs and all Events from the Application and System logs:"
    },
    {
      "pos": [
        9118,
        9396
      ],
      "content": "In <bpt id=\"p1\">[</bpt>Step 4: Configure storage of your diagnostics data<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/dn482131.aspx#BKMK_step4)</ept> of the How To Enable Diagnostics in a Cloud Service topic, ensure that your ConfigurationSettings specifies a storage account, as in the following example:"
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>AccountName<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>AccountKey<ept id=\"p2\">**</ept> values are found in the Microsoft Azure Management Portal in the storage account dashboard, under Manage Access Keys.",
      "pos": [
        9632,
        9788
      ]
    },
    {
      "content": "The protocol for the connection string must be <bpt id=\"p1\">**</bpt>https<ept id=\"p1\">**</ept>.",
      "pos": [
        9789,
        9846
      ]
    },
    {
      "content": "Once the updated diagnostic configuration is applied to your cloud service and it is writing diagnostics to Azure Storage, then you are ready to configure Operational Insights.",
      "pos": [
        9848,
        10024
      ]
    },
    {
      "content": "Enable Azure diagnostics in a virtual machine for event log and IIS log collection",
      "pos": [
        10029,
        10111
      ]
    },
    {
      "content": "Use the following procedure to enable Azure diagnostics in a virtual machine for Event Log and IIS log collection using the Microsoft Azure management portal.",
      "pos": [
        10113,
        10271
      ]
    },
    {
      "content": "To enable Azure diagnostics in a virtual machine with the Azure management portal",
      "pos": [
        10277,
        10358
      ]
    },
    {
      "content": "Install the VM Agent when you create a virtual machine.",
      "pos": [
        10363,
        10418
      ]
    },
    {
      "content": "If the virtual machine already exists, verify that the VM Agent is already installed.",
      "pos": [
        10419,
        10504
      ]
    },
    {
      "pos": [
        10511,
        10653
      ],
      "content": "If you use the default Azure management portal to create the virtual machine, perform a <bpt id=\"p1\">**</bpt>Custom Create<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Install the VM Agent<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        10660,
        10817
      ],
      "content": "If you use the new Azure management portal to create a virtual machine, select <bpt id=\"p1\">**</bpt>Optional Configuration<ept id=\"p1\">**</ept>, then <bpt id=\"p2\">**</bpt>Diagnostics<ept id=\"p2\">**</ept> and set <bpt id=\"p3\">**</bpt>Status<ept id=\"p3\">**</ept> to <bpt id=\"p4\">**</bpt>On<ept id=\"p4\">**</ept>."
    },
    {
      "content": "Upon completion, the VM will automatically have the Azure Diagnostics extension installed and running which will be responsible for collecting your diagnostics data.",
      "pos": [
        10823,
        10988
      ]
    },
    {
      "content": "Enable monitoring and configure event logging on an existing VM.",
      "pos": [
        10993,
        11057
      ]
    },
    {
      "content": "You can enable diagnostics at the VM level.",
      "pos": [
        11058,
        11101
      ]
    },
    {
      "content": "To enable diagnostics and then configure event logging, perform the following steps:",
      "pos": [
        11102,
        11186
      ]
    },
    {
      "content": "Select the VM.",
      "pos": [
        11194,
        11208
      ]
    },
    {
      "pos": [
        11216,
        11237
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Monitoring<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        11245,
        11267
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Diagnostics<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        11275,
        11304
      ],
      "content": "Set the <bpt id=\"p1\">**</bpt>Status<ept id=\"p1\">**</ept> to <bpt id=\"p2\">**</bpt>ON<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Select each diagnostics metric that you want to use.",
      "pos": [
        11312,
        11364
      ]
    },
    {
      "content": "Operational Insights can analyze Windows event system logs, Windows event application logs and IIS logs.",
      "pos": [
        11365,
        11469
      ]
    },
    {
      "pos": [
        11477,
        11490
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Using Azure PowerShell you can more precisely specify the events that are written to Azure Storage.",
      "pos": [
        11492,
        11591
      ]
    },
    {
      "content": "Refer to the Azure Diagnostics 1.2 Configuration Schema for a sample configuration file and detailed documentation on its schema.",
      "pos": [
        11592,
        11721
      ]
    },
    {
      "content": "Ensure that you install and configure Azure PowerShell version 0.8.7 or later from <bpt id=\"p1\">[</bpt>How to install and configure Azure PowerShell<ept id=\"p1\">](powershell-install-configure)</ept>.",
      "pos": [
        11722,
        11883
      ]
    },
    {
      "content": "If you have a version of Microsoft Azure Diagnostics installed that is earlier than version 1.2 you cannot use the new portal to enable or configure diagnostics.",
      "pos": [
        11884,
        12045
      ]
    },
    {
      "content": "You can enable and update the Agent using the following PowerShell script.",
      "pos": [
        12047,
        12121
      ]
    },
    {
      "content": "You can also use this script with custom logging configuration.",
      "pos": [
        12122,
        12185
      ]
    },
    {
      "content": "You will need to modify the script to set the storage account, service name and virtual machine name.",
      "pos": [
        12186,
        12287
      ]
    },
    {
      "content": "To enable diagnostics in a virtual machine with Azure PowerShell",
      "pos": [
        12293,
        12357
      ]
    },
    {
      "content": "Review the following script sample, copy it, modify it as needed, save the sample as a PowerShell script file, and then run the script.",
      "pos": [
        12359,
        12494
      ]
    },
    {
      "content": "Enable Azure Storage analysis by Operational Insights",
      "pos": [
        14074,
        14127
      ]
    },
    {
      "content": "Use the following procedure to enable storage analysis and configure Operational Insights to read from the Azure Storage account with Azure Diagnostics.",
      "pos": [
        14129,
        14281
      ]
    },
    {
      "content": "To enable analysis by Operational Insights",
      "pos": [
        14287,
        14329
      ]
    },
    {
      "content": "In the default Azure portal, navigate to your Operational Insights workspace and select the <bpt id=\"p1\">**</bpt>Storage<ept id=\"p1\">**</ept> tab.",
      "pos": [
        14334,
        14442
      ]
    },
    {
      "content": "<ph id=\"ph1\">![</ph>workspace storage tab<ph id=\"ph2\">](./media/operational-insights-analyze-data-azure/workspace-storage-tab.png)</ph>",
      "pos": [
        14443,
        14542
      ]
    },
    {
      "pos": [
        14546,
        14618
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Add a Storage Account<ept id=\"p1\">**</ept> to open the <bpt id=\"p2\">**</bpt>Add Storage Account<ept id=\"p2\">**</ept> box."
    },
    {
      "content": "Select the storage account that you want to use.",
      "pos": [
        14622,
        14670
      ]
    },
    {
      "pos": [
        14674,
        14775
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Data Type<ept id=\"p1\">**</ept> list, select a data type: either <bpt id=\"p2\">**</bpt>Events<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>IIS Logs<ept id=\"p3\">**</ept> or <bpt id=\"p4\">**</bpt>Syslog (Linux)<ept id=\"p4\">**</ept>."
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept> image.",
      "pos": [
        14779,
        14802
      ]
    },
    {
      "content": "<ph id=\"ph1\">![</ph>storage account box<ph id=\"ph2\">](./media/operational-insights-analyze-data-azure/storage-account.png)</ph>",
      "pos": [
        14807,
        14898
      ]
    },
    {
      "content": "Repeat the above steps for each data type and storage account combination that you want to collect.",
      "pos": [
        14902,
        15001
      ]
    },
    {
      "content": "In approximately 1 hour you will begin to see data from the storage account available for analysis within Operational Insights.",
      "pos": [
        15003,
        15130
      ]
    },
    {
      "content": "Related content",
      "pos": [
        15135,
        15150
      ]
    },
    {
      "content": "Connect computers directly to Operational Insights",
      "pos": [
        15155,
        15205
      ]
    },
    {
      "content": "Blog post: Enable Operational Insights for Azure Virtual machines",
      "pos": [
        15245,
        15310
      ]
    },
    {
      "content": "Next steps",
      "pos": [
        15415,
        15425
      ]
    },
    {
      "content": "Configure Proxy and Firewall settings (Optional)",
      "pos": [
        15428,
        15476
      ]
    }
  ],
  "content": "<properties\n   pageTitle=\"Analyze data from servers in Microsoft Azure\"\n   description=\"Search event and IIS logs for cloud services and virtual machines by enabling Azure diagnostics.\"\n   services=\"operational-insights\"\n   documentationCenter=\"\"\n   authors=\"bandersmsft\"\n   manager=\"jwhit\"\n   editor=\"\"/>\n\n<tags\n   ms.service=\"operational-insights\"\n   ms.devlang=\"na\"\n   ms.topic=\"get-started-article\"\n   ms.tgt_pltfrm=\"na\"\n   ms.workload=\"na\"\n   ms.date=\"08/05/2015\"\n   ms.author=\"banders\"/>\n# Analyze data from servers in Microsoft Azure\n\n[AZURE.INCLUDE [operational-insights-note-moms](../../includes/operational-insights-note-moms.md)]\n\nOperational Insights uses data from servers in your on-premises or cloud infrastructure. You can collect machine data from Azure storage when generated by Azure diagnostics.\n\nUsing the data you collect from Azure storage, you can quickly search event and IIS logs for cloud services and virtual machines. You can also get additional insights from your virtual machines by installing the Microsoft Monitoring Agent.\n\nThe Update Assessment, Change Tracking, and SQL Assessment solutions all work with the Microsoft Monitoring Agent to provide deeper insights on your virtual machines. If you haven’t already, you can [add solutions](operational-insights-setup-workspace.md) when you’re signed into the [Operational Insights portal](https://www.microsoft.com/oms/).\n\nFor Azure virtual machines, there are two easy ways to enable agent-based data collection:\n\n- In the Microsoft Azure management portal\n\n- Using PowerShell\n\nWhen using agent-based collection for log data, you must configure which logs to collect in the Log Management configuration page of the [Operational Insights portal](https://www.microsoft.com/oms/).\n\n >[AZURE.NOTE] If you’ve configured Operational Insights to index log data using Azure diagnostics and you configure the agent to collect logs, then the same logs will be indexed twice.\nYou will be charged normal data rates for both data sources.\nIf you have the agent installed, then you should collect log data using the agent and not index the logs collected by Azure diagnostics.\n\n## Microsoft Azure Management Portal\n\nYou can install the agent for Operational Insights from the [Azure portal](https://manage.windowsazure.com/#Workspaces/OperationalInsightExtension/Workspaces).\n\n### To install the agent for Operational Insights\n1. In the Azure portal, go to your Operational Insights workspace and select the **Servers** tab.\n2. On the tab, you’ll see a list of your virtual machines. Select the virtual machine you want to install the agent on and then click **Enable Op Insights**.\n\nThe agent is automatically installed and configured for your Operational Insights workspace.\n\n![Image of Operational Insights Servers page](./media/operational-insights-analyze-data-azure/servers.png)\n\n >[AZURE.NOTE] The [Azure VM agent](https://msdn.microsoft.com/library/azure/dn832621.aspx) must be installed to automatically install the agent for Operational Insights.\n\n\n\n## PowerShell\n\nIf you prefer scripting to make changes to your Azure virtual machines, then you can enable the Microsoft Monitoring Agent using PowerShell.\n\nThe Microsoft Monitoring Agent is an [Azure virtual machine extension](https://msdn.microsoft.com/library/azure/dn832621.aspx) and you can manage it using PowerShell, as shown in the example below.\n\n```powershell\nAdd-AzureAccount\n\n$workspaceId=\"enter workspace here\"\n$workspaceKey=\"enter workspace key here\"\n$hostedService=\"enter hosted service here\"\n\n$vm = Get-AzureVM –ServiceName $hostedService\nSet-AzureVMExtension -VM $vm -Publisher 'Microsoft.EnterpriseCloud.Monitoring' -ExtensionName 'MicrosoftMonitoringAgent' -Version '1.*' -PublicConfiguration \"{'workspaceId':  '$workspaceId'}\" -PrivateConfiguration \"{'workspaceKey': '$workspaceKey' }\" | Update-AzureVM -Verbose\n```\n\nWhen configuring using PowerShell, you need to provide the Workspace ID and Primary Key. You can find your Workspace ID and Primary Key on the **Settings** page of the Operational Insights portal.\n\n![sources](./media/operational-insights-analyze-data-azure/sources01.png)\n\n## Collect data using Azure diagnostics\n\nOperational Insights can analyze data written to Azure storage by Azure diagnostics. There are 2 main steps to perform:\n\n- Configure the collection of diagnostic data to Azure storage\n- Configure Operational Insights to analyze data in the storage account\n\nThe topics below describe how to enable collection of diagnostics data to Azure storage and then how to configure Operational Insights to analyze the data in Azure storage.\n\nAzure Diagnostics is an Azure extensions that enables you to collect diagnostic data from a worker role, web role, or virtual machine running in Azure. The data is stored in an Azure storage account and can then be used by Operational Insights.\n\n>[AZURE.NOTE] You'll be charged normal data rates for storage and transactions when you send diagnostics to a storage account and for when Operational Insights reads the data from your storage account.\n\nAzure Diagnostics can collect the following types of telemetry:\n\nData Source|Description\n ---|---\nIIS Logs|Information about IIS web sites.\nAzure Diagnostic infrastructure logs|Information about Diagnostics itself.\nIIS Failed Request logs |Information about failed requests to an IIS site or application.\nWindows Event logs|Information sent to the Windows event logging system.\nPerformance counters|Operating System and custom performance counters.\nCrash dumps|Information about the state of the process in the event of an application crash.\nCustom error logs|Logs created by your application or service.\nNET EventSource|Events generated by your code using the .NET [EventSource class](https://msdn.microsoft.com/library/system.diagnostics.tracing.eventsource(v=vs.110).aspx)\nManifest based ETW|ETW events generated by any process\nSyslog|Events sent to the Syslog or Rsyslog daemons\n\n\nCurrently, Operational Insights is able to analyze:\n\n- IIS logs from Web roles and virtual machines\n- Windows Event logs from Web roles, Worker roles and Azure virtual machines running a Windows operating system\n- Syslog from Azure virtual machines running a Linux operating system\n\nThe logs must be in the following locations:\n\n- WADWindowsEventLogsTable (Table Storage) – Contains information from Windows Event logs.\n- wad-iis-logfiles (Blob Storage) – Contains information about IIS logs.\n- LinuxsyslogVer2v0 (Table Storage) – Contains Linux syslog events.\n\n >[AZURE.NOTE] IIS logs from Azure Websites are not currently supported.\n\nFor virtual machines, you also have the option of installing the [Microsoft Monitoring Agent](http://go.microsoft.com/fwlink/?LinkId=517269) into your virtual machine to enable additional insights. In addition to being able to analyze IIS logs and Event Logs you will also allow be able to perform additional analysis including configuration change tracking, SQL assessment and update assessment.\n\nYou can help us prioritize additional logs for Operational Insights to analyze by voting on our [feedback page](http://feedback.azure.com/forums/267889-azure-operational-insights/category/88086-log-management-and-log-collection-policy).\n\n## Enable Azure diagnostics in a Web role for IIS log and event collection\n\nRefer to [How To Enable Diagnostics in a Cloud Service](https://msdn.microsoft.com/library/azure/dn482131.aspx). You’ll use the basic information from there and customize the steps here for use with Microsoft Azure Operational Insights.\n\nWith Azure diagnostics enabled:\n\n- IIS logs are stored by default, with log data transferred at the scheduledTransferPeriod transfer interval.\n\n- Windows Event Logs are not transferred by default.\n\n### To enable diagnostics\n\nTo enable Windows Event Logs, or to change the scheduledTransferPeriod, configure Azure Diagnostics using the XML configuration file (diagnostics.wadcfg), as shown in [Step 2: Add the diagnostics.wadcfg file to your Visual Studio solution](https://msdn.microsoft.com/library/azure/dn482131.aspx#BKMK_step2) and [Step 3: Configure diagnostics for your application](https://msdn.microsoft.com/library/azure/dn482131.aspx#BKMK_step3) in the How To Enable Diagnostics in a Cloud Service topic.The following example configuration file collects IIS Logs and all Events from the Application and System logs:\n\n    <?xml version=\"1.0\" encoding=\"utf-8\" ?>\n    <DiagnosticMonitorConfiguration xmlns=\"http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration\"\n          configurationChangePollInterval=\"PT1M\"\n          overallQuotaInMB=\"4096\">\n\n      <Directories bufferQuotaInMB=\"0\"\n         scheduledTransferPeriod=\"PT10M\">  \n        <!-- IISLogs are only relevant to Web roles -->\n        <IISLogs container=\"wad-iis\" directoryQuotaInMB=\"0\" />\n      </Directories>\n\n      <WindowsEventLog bufferQuotaInMB=\"0\"\n         scheduledTransferLogLevelFilter=\"Verbose\"\n         scheduledTransferPeriod=\"PT10M\">\n        <DataSource name=\"Application!*\" />\n        <DataSource name=\"System!*\" />\n      </WindowsEventLog>\n\n    </DiagnosticMonitorConfiguration>\n\n\nIn [Step 4: Configure storage of your diagnostics data](https://msdn.microsoft.com/library/azure/dn482131.aspx#BKMK_step4) of the How To Enable Diagnostics in a Cloud Service topic, ensure that your ConfigurationSettings specifies a storage account, as in the following example:\n\n\n    <ConfigurationSettings>\n       <Setting name=\"Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString\" value=\"DefaultEndpointsProtocol=https;AccountName=<AccountName>;AccountKey=<AccountKey>\"/>\n    </ConfigurationSettings>\n\n\nThe **AccountName** and **AccountKey** values are found in the Microsoft Azure Management Portal in the storage account dashboard, under Manage Access Keys. The protocol for the connection string must be **https**.\n\nOnce the updated diagnostic configuration is applied to your cloud service and it is writing diagnostics to Azure Storage, then you are ready to configure Operational Insights.\n\n## Enable Azure diagnostics in a virtual machine for event log and IIS log collection\n\nUse the following procedure to enable Azure diagnostics in a virtual machine for Event Log and IIS log collection using the Microsoft Azure management portal.\n\n### To enable Azure diagnostics in a virtual machine with the Azure management portal\n\n1. Install the VM Agent when you create a virtual machine. If the virtual machine already exists, verify that the VM Agent is already installed.\n    - If you use the default Azure management portal to create the virtual machine, perform a **Custom Create** and select **Install the VM Agent**.\n    - If you use the new Azure management portal to create a virtual machine, select **Optional Configuration**, then **Diagnostics** and set **Status** to **On**.\n\n    Upon completion, the VM will automatically have the Azure Diagnostics extension installed and running which will be responsible for collecting your diagnostics data.\n\n2. Enable monitoring and configure event logging on an existing VM. You can enable diagnostics at the VM level. To enable diagnostics and then configure event logging, perform the following steps:\n    1. Select the VM.\n    2. Click **Monitoring**.\n    3. Click **Diagnostics**.\n    4. Set the **Status** to **ON**.\n    5. Select each diagnostics metric that you want to use. Operational Insights can analyze Windows event system logs, Windows event application logs and IIS logs.\n    7. Click **OK**.\n\nUsing Azure PowerShell you can more precisely specify the events that are written to Azure Storage. Refer to the Azure Diagnostics 1.2 Configuration Schema for a sample configuration file and detailed documentation on its schema. Ensure that you install and configure Azure PowerShell version 0.8.7 or later from [How to install and configure Azure PowerShell](powershell-install-configure). If you have a version of Microsoft Azure Diagnostics installed that is earlier than version 1.2 you cannot use the new portal to enable or configure diagnostics.\n\nYou can enable and update the Agent using the following PowerShell script. You can also use this script with custom logging configuration. You will need to modify the script to set the storage account, service name and virtual machine name.\n\n### To enable diagnostics in a virtual machine with Azure PowerShell\n\nReview the following script sample, copy it, modify it as needed, save the sample as a PowerShell script file, and then run the script.\n\n\n    #Connect to Azure\n    Add-AzureAccount\n\n    # settings to change:\n    $wad_storage_account_name = \"myStorageAccount\"\n    $service_name = \"myService\"\n    $vm_name = \"myVM\"\n\n    #Construct Azure Diagnostics public config and convert to config format\n\n    # Collect just system error events:\n    $wad_xml_config = \"<WadCfg><DiagnosticMonitorConfiguration><WindowsEventLog scheduledTransferPeriod=\"\"PT1M\"\"><DataSource name=\"\"System!* \"\" /></WindowsEventLog></DiagnosticMonitorConfiguration></WadCfg>\"\n\n    $wad_b64_config = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($wad_xml_config))\n    $wad_public_config = [string]::Format(\"{{\"\"xmlCfg\"\":\"\"{0}\"\"}}\",$wad_b64_config)\n\n    #Construct Azure diagnostics private config\n\n    $wad_storage_account_key = (Get-AzureStorageKey $wad_storage_account_name).Primary\n    $wad_private_config = [string]::Format(\"{{\"\"storageAccountName\"\":\"\"{0}\"\",\"\"storageAccountKey\"\":\"\"{1}\"\"}}\",$wad_storage_account_name,$wad_storage_account_key)\n\n    #Enable Diagnostics Extension for Virtual Machine\n\n    $wad_extension_name = \"IaaSDiagnostics\"\n    $wad_publisher = \"Microsoft.Azure.Diagnostics\"\n    $wad_version = (Get-AzureVMAvailableExtension -Publisher $wad_publisher -ExtensionName $wad_extension_name).Version # Gets latest version of the extension\n\n    (Get-AzureVM -ServiceName $service_name -Name $vm_name) | Set-AzureVMExtension -ExtensionName $wad_extension_name -Publisher $wad_publisher -PublicConfiguration $wad_public_config -PrivateConfiguration $wad_private_config -Version $wad_version | Update-AzureVM\n\n\n## Enable Azure Storage analysis by Operational Insights\n\nUse the following procedure to enable storage analysis and configure Operational Insights to read from the Azure Storage account with Azure Diagnostics.\n\n### To enable analysis by Operational Insights\n\n1. In the default Azure portal, navigate to your Operational Insights workspace and select the **Storage** tab.\n![workspace storage tab](./media/operational-insights-analyze-data-azure/workspace-storage-tab.png)\n2. Click **Add a Storage Account** to open the **Add Storage Account** box.\n3. Select the storage account that you want to use.\n4. In the **Data Type** list, select a data type: either **Events**, **IIS Logs** or **Syslog (Linux)**.\n5. Click the **OK** image.<br>\n![storage account box](./media/operational-insights-analyze-data-azure/storage-account.png)\n6. Repeat the above steps for each data type and storage account combination that you want to collect.\n\nIn approximately 1 hour you will begin to see data from the storage account available for analysis within Operational Insights.\n\n## Related content\n\n- [Connect computers directly to Operational Insights](operational-insights-direct-agent)\n- [Blog post: Enable Operational Insights for Azure Virtual machines](http://azure.microsoft.com/updates/easily-enable-operational-insights-for-azure-virtual-machines/)\n\n## Next steps\n\n[Configure Proxy and Firewall settings (Optional)](../operational-insights-proxy-filewall.md)\n"
}