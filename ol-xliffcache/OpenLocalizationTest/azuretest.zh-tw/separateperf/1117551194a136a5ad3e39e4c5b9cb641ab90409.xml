{
  "nodes": [
    {
      "content": "Azure Mobile Engagement Android SDK Integration",
      "pos": [
        28,
        75
      ]
    },
    {
      "content": "Latest updates and procedures for Android SDK for Azure Mobile Engagement",
      "pos": [
        95,
        168
      ]
    },
    {
      "content": "How to Integrate Engagement on Android",
      "pos": [
        510,
        548
      ]
    },
    {
      "content": "[AZURE.SELECTOR]",
      "pos": [
        552,
        568
      ]
    },
    {
      "content": "Windows Universal",
      "pos": [
        573,
        590
      ]
    },
    {
      "content": "Windows Phone Silverlight",
      "pos": [
        653,
        678
      ]
    },
    {
      "content": "iOS",
      "pos": [
        741,
        744
      ]
    },
    {
      "content": "Android",
      "pos": [
        797,
        804
      ]
    },
    {
      "content": "This procedure describes the simplest way to activate Engagement's Analytics and Monitoring functions in your Android application.",
      "pos": [
        859,
        989
      ]
    },
    {
      "pos": [
        993,
        1093
      ],
      "content": "<ph id=\"ph1\">[AZURE.IMPORTANT]</ph> Your minimum Android SDK API level must be 10 or higher (Android 2.3.3 or higher)."
    },
    {
      "content": "The following steps are enough to activates the report of logs needed to compute all statistics regarding Users, Sessions, Activities, Crashes and Technicals.",
      "pos": [
        1096,
        1254
      ]
    },
    {
      "content": "The report of logs needed to compute other statistics like Events, Errors and Jobs must be done manually using the Engagement API (see <bpt id=\"p1\">[</bpt>How to use the advanced Mobile Engagement tagging API in your Android<ept id=\"p1\">](mobile-engagement-android-use-engagement-api.md)</ept> since these statistics are application dependent.",
      "pos": [
        1255,
        1560
      ]
    },
    {
      "content": "Embed the Engagement SDK and service into your Android project",
      "pos": [
        1564,
        1626
      ]
    },
    {
      "content": "Download the Android SDK from <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](http://go.microsoft.com/?linkid=9863935&amp;clcid=0x409)</ept>",
      "pos": [
        1628,
        1717
      ]
    },
    {
      "content": "Get <ph id=\"ph1\">`mobile-engagement-VERSION.jar`</ph> and put them into the <ph id=\"ph2\">`libs`</ph> folder of your Android project (create the libs folder if it does not exist yet).",
      "pos": [
        1718,
        1864
      ]
    },
    {
      "pos": [
        1868,
        2020
      ],
      "content": "[AZURE.IMPORTANT]\nIf you build your application package with ProGuard, you need to keep some classes. You can use the following configuration snippet:",
      "leadings": [
        "",
        "> "
      ],
      "nodes": [
        {
          "content": "If you build your application package with ProGuard, you need to keep some classes. You can use the following configuration snippet:",
          "pos": [
            18,
            150
          ],
          "nodes": [
            {
              "content": "If you build your application package with ProGuard, you need to keep some classes.",
              "pos": [
                0,
                83
              ]
            },
            {
              "content": "You can use the following configuration snippet:",
              "pos": [
                84,
                132
              ]
            }
          ]
        }
      ]
    },
    {
      "content": "Specify your Engagement connection string by calling the following method in the launcher activity:",
      "pos": [
        2258,
        2357
      ]
    },
    {
      "content": "The connection string for your application is displayed on Azure Portal.",
      "pos": [
        2654,
        2726
      ]
    },
    {
      "pos": [
        2732,
        2815
      ],
      "content": "If missing, add the following Android permissions (before the <ph id=\"ph1\">`&lt;application&gt;`</ph> tag):"
    },
    {
      "pos": [
        2982,
        3064
      ],
      "content": "Add the following section (between the <ph id=\"ph1\">`&lt;application&gt;`</ph> and <ph id=\"ph2\">`&lt;/application&gt;`</ph> tags):"
    },
    {
      "pos": [
        3324,
        3389
      ],
      "content": "Change <ph id=\"ph1\">`&lt;Your application name&gt;`</ph> by the name of your application."
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.TIP]</ph> The <ph id=\"ph2\">`android:label`</ph> attribute allows you to choose the name of the Engagement service as it will appear to the end-users in the \"Running services\" screen of their phone.",
      "pos": [
        3393,
        3574
      ]
    },
    {
      "content": "It is recommended to set this attribute to <ph id=\"ph1\">`\"&lt;Your application name&gt;Service\"`</ph> (e.g. <ph id=\"ph2\">`\"AcmeFunGameService\"`</ph>).",
      "pos": [
        3575,
        3683
      ]
    },
    {
      "pos": [
        3685,
        3911
      ],
      "content": "Specifying the <ph id=\"ph1\">`android:process`</ph> attribute ensures that the Engagement service will run in its own process (running Engagement in the same process as your application will make your main/UI thread potentially less responsive)."
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> Any code you place in <ph id=\"ph2\">`Application.onCreate()`</ph> and other application callbacks will be run for all your application's processes, including the Engagement service.",
      "pos": [
        3915,
        4090
      ]
    },
    {
      "content": "It may have unwanted side effects (like unneeded memory allocations and threads in the Engagement's process, duplicate broadcast receivers or services).",
      "pos": [
        4091,
        4243
      ]
    },
    {
      "pos": [
        4245,
        4397
      ],
      "content": "If you override <ph id=\"ph1\">`Application.onCreate()`</ph>, it's recommended to add the following code snippet at the beginning of your <ph id=\"ph2\">`Application.onCreate()`</ph> function:"
    },
    {
      "pos": [
        4614,
        4747
      ],
      "content": "You can do the same thing for <ph id=\"ph1\">`Application.onTerminate()`</ph>, <ph id=\"ph2\">`Application.onLowMemory()`</ph> and <ph id=\"ph3\">`Application.onConfigurationChanged(...)`</ph>."
    },
    {
      "pos": [
        4749,
        5063
      ],
      "content": "You can also extend <ph id=\"ph1\">`EngagementApplication`</ph> instead of extending <ph id=\"ph2\">`Application`</ph>: the callback <ph id=\"ph3\">`Application.onCreate()`</ph> does the process check and calls <ph id=\"ph4\">`Application.onApplicationProcessCreate()`</ph> only if the current process is not the one hosting the Engagement service, the same rules apply for the other callbacks."
    },
    {
      "content": "Basic reporting",
      "pos": [
        5067,
        5082
      ]
    },
    {
      "pos": [
        5088,
        5140
      ],
      "content": "Recommended method: overload your <ph id=\"ph1\">`Activity`</ph> classes"
    },
    {
      "pos": [
        5142,
        5499
      ],
      "content": "In order to activate the report of all the logs required by Engagement to compute Users, Sessions, Activities, Crashes and Technical statistics, you just have to make all your <ph id=\"ph1\">`*Activity`</ph> sub-classes inherit from the corresponding <ph id=\"ph2\">`Engagement*Activity`</ph> classes (e.g. if your legacy activity extends <ph id=\"ph3\">`ListActivity`</ph>, make it extends <ph id=\"ph4\">`EngagementListActivity`</ph>)."
    },
    {
      "content": "Without Engagement :",
      "pos": [
        5503,
        5523
      ]
    },
    {
      "content": "With Engagement :",
      "pos": [
        5967,
        5984
      ]
    },
    {
      "pos": [
        6476,
        6700
      ],
      "content": "<ph id=\"ph1\">[AZURE.IMPORTANT]</ph> When using <ph id=\"ph2\">`EngagementListActivity`</ph> or <ph id=\"ph3\">`EngagementExpandableListActivity`</ph>, make sure any call to <ph id=\"ph4\">`requestWindowFeature(...);`</ph> is made before the call to <ph id=\"ph5\">`super.onCreate(...);`</ph>, otherwise a crash will occur."
    },
    {
      "pos": [
        6702,
        6869
      ],
      "content": "We provide sub-classes of <ph id=\"ph1\">`FragmentActivity`</ph> and <ph id=\"ph2\">`MapActivity`</ph>, but to avoid problems with applications using <bpt id=\"p1\">**</bpt>ProGuard<ept id=\"p1\">**</ept>, we do not include them in <ph id=\"ph3\">`engagement.jar`</ph>."
    },
    {
      "content": "You can find these classes in the <ph id=\"ph1\">`src`</ph> folder, and can copy them into your project.",
      "pos": [
        6871,
        6955
      ]
    },
    {
      "content": "The classes are also in the <bpt id=\"p1\">**</bpt>JavaDoc<ept id=\"p1\">**</ept>.",
      "pos": [
        6956,
        6996
      ]
    },
    {
      "pos": [
        7002,
        7071
      ],
      "content": "Alternate method: call <ph id=\"ph1\">`startActivity()`</ph> and <ph id=\"ph2\">`endActivity()`</ph> manually"
    },
    {
      "pos": [
        7073,
        7233
      ],
      "content": "If you cannot or do not want to overload your <ph id=\"ph1\">`Activity`</ph> classes, you can instead start and end your activities by calling <ph id=\"ph2\">`EngagementAgent`</ph>'s methods directly."
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.IMPORTANT]</ph> The Android SDK never calls the <ph id=\"ph2\">`endActivity()`</ph> method, even when the application is closed (on Android, applications are actually never closed).",
      "pos": [
        7237,
        7400
      ]
    },
    {
      "content": "Thus, it is <bpt id=\"p1\">*</bpt>HIGHLY<ept id=\"p1\">*</ept> recommended to call the <ph id=\"ph1\">`startActivity()`</ph> method in the <ph id=\"ph2\">`onResume`</ph> callback of <bpt id=\"p2\">*</bpt>ALL<ept id=\"p2\">*</ept> your activities, and the <ph id=\"ph3\">`endActivity()`</ph> method in the <ph id=\"ph4\">`onPause()`</ph> callback of <bpt id=\"p3\">*</bpt>ALL<ept id=\"p3\">*</ept> your activities.",
      "pos": [
        7401,
        7608
      ]
    },
    {
      "content": "This is the only way to be sure that sessions will not be leaked.",
      "pos": [
        7609,
        7674
      ]
    },
    {
      "content": "If a session is leaked, the Engagement service will never disconnect from the Engagement backend (since the service stays connected as long as a session is pending).",
      "pos": [
        7675,
        7840
      ]
    },
    {
      "content": "Here is an example:",
      "pos": [
        7842,
        7861
      ]
    },
    {
      "pos": [
        8568,
        8697
      ],
      "content": "This example very similiar to the <ph id=\"ph1\">`EngagementActivity`</ph> class and its variants, whose source code is provided in the <ph id=\"ph2\">`src`</ph> folder."
    },
    {
      "content": "Test",
      "pos": [
        8701,
        8705
      ]
    },
    {
      "content": "Now please verify your integration by running your mobile app in an emulator or device and verifying that it registers a session on the Monitor tab.",
      "pos": [
        8707,
        8855
      ]
    },
    {
      "content": "The next sections are optional.",
      "pos": [
        8858,
        8889
      ]
    },
    {
      "content": "Location reporting",
      "pos": [
        8893,
        8911
      ]
    },
    {
      "pos": [
        8913,
        9052
      ],
      "content": "If you want locations to be reported, you need to add a few lines of configuration (between the <ph id=\"ph1\">`&lt;application&gt;`</ph> and <ph id=\"ph2\">`&lt;/application&gt;`</ph> tags)."
    },
    {
      "content": "Lazy area location reporting",
      "pos": [
        9058,
        9086
      ]
    },
    {
      "content": "Lazy area location reporting allows to report the country, region and locality associated to devices.",
      "pos": [
        9088,
        9189
      ]
    },
    {
      "content": "This type of location reporting only uses network locations (based on Cell ID or WIFI).",
      "pos": [
        9190,
        9277
      ]
    },
    {
      "content": "The device area is reported at most once per session.",
      "pos": [
        9278,
        9331
      ]
    },
    {
      "content": "The GPS is never used, and thus this type of location report has very few (not to say no) impact on the battery.",
      "pos": [
        9332,
        9444
      ]
    },
    {
      "content": "Reported areas are used to compute geographic statistics about users, sessions, events and errors.",
      "pos": [
        9446,
        9544
      ]
    },
    {
      "content": "They can also be used as criterion in Reach campaigns.",
      "pos": [
        9545,
        9599
      ]
    },
    {
      "content": "To enable lazy area location reporting, you can do it by using the configuration previously mentioned in this procedure :",
      "pos": [
        9601,
        9722
      ]
    },
    {
      "content": "You also need to add the following permission if missing:",
      "pos": [
        10056,
        10113
      ]
    },
    {
      "pos": [
        10204,
        10293
      ],
      "content": "Or you can keep using <ph id=\"ph1\">``ACCESS_FINE_LOCATION``</ph> if you already use it in your application."
    },
    {
      "content": "Real time location reporting",
      "pos": [
        10299,
        10327
      ]
    },
    {
      "content": "Real time location reporting allows to report the latitude and longitude associated to devices.",
      "pos": [
        10329,
        10424
      ]
    },
    {
      "content": "By default, this type of location reporting only uses network locations (based on Cell ID or WIFI), and the reporting is only active when the application runs in foreground (i.e. during a session).",
      "pos": [
        10425,
        10622
      ]
    },
    {
      "content": "Real time locations are <bpt id=\"p1\">*</bpt>NOT<ept id=\"p1\">*</ept> used to compute statistics.",
      "pos": [
        10624,
        10681
      ]
    },
    {
      "content": "Their only purpose is to allow the use of real time",
      "pos": [
        10682,
        10733
      ]
    },
    {
      "content": "geo-fencing \\&lt;Reach-Audience-geofencing\\&gt; criterion in Reach campaigns.",
      "pos": [
        10734,
        10805
      ]
    },
    {
      "content": "To enable real time location reporting, you can do it by using the configuration previously mentioned in this procedure :",
      "pos": [
        10807,
        10928
      ]
    },
    {
      "content": "You also need to add the following permission if missing:",
      "pos": [
        11262,
        11319
      ]
    },
    {
      "pos": [
        11410,
        11499
      ],
      "content": "Or you can keep using <ph id=\"ph1\">``ACCESS_FINE_LOCATION``</ph> if you already use it in your application."
    },
    {
      "content": "GPS based reporting",
      "pos": [
        11506,
        11525
      ]
    },
    {
      "content": "By default, real time location reporting only uses network based locations.",
      "pos": [
        11527,
        11602
      ]
    },
    {
      "content": "To enable the use of GPS based locations (which are far more precise), use the configuration object:",
      "pos": [
        11603,
        11703
      ]
    },
    {
      "content": "You also need to add the following permission if missing:",
      "pos": [
        12102,
        12159
      ]
    },
    {
      "content": "Background reporting",
      "pos": [
        12253,
        12273
      ]
    },
    {
      "content": "By default, real time location reporting is only active when the application runs in foreground (i.e. during a session).",
      "pos": [
        12275,
        12395
      ]
    },
    {
      "content": "To enable the reporting also in background, use the configuration object:",
      "pos": [
        12396,
        12469
      ]
    },
    {
      "pos": [
        12876,
        13001
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> When the application runs in background, only network based locations are reported, even if you enabled the GPS."
    },
    {
      "content": "The background location report will be stopped if the user reboots its device, you can add this to make it automatically restart at boot time:",
      "pos": [
        13003,
        13145
      ]
    },
    {
      "content": "You also need to add the following permission if missing:",
      "pos": [
        13456,
        13513
      ]
    },
    {
      "content": "Android M permissions",
      "pos": [
        13609,
        13630
      ]
    },
    {
      "content": "Starting with Android M, some permissions are managed at runtime and needs user approval.",
      "pos": [
        13632,
        13721
      ]
    },
    {
      "content": "The runtime permissions will be turned off by default for new app installations if you target Android API level 23.",
      "pos": [
        13723,
        13838
      ]
    },
    {
      "content": "Otherwise it will be turned on by default.",
      "pos": [
        13839,
        13881
      ]
    },
    {
      "content": "The user can enable/disable those permissions from the device settings menu.",
      "pos": [
        13883,
        13959
      ]
    },
    {
      "content": "Turning off permissions from system menu kills background processes of the application, this is a system behavior and has no impact on ability to receive push in background.",
      "pos": [
        13960,
        14133
      ]
    },
    {
      "content": "In the context of Mobile Engagement, the permissions that require approval at runtime are:",
      "pos": [
        14135,
        14225
      ]
    },
    {
      "pos": [
        14281,
        14361
      ],
      "content": "<ph id=\"ph1\">`WRITE_EXTERNAL_STORAGE`</ph> (only when targeting Android API level 23 for this one)"
    },
    {
      "content": "The external storage is used only for Reach big picture feature.",
      "pos": [
        14363,
        14427
      ]
    },
    {
      "content": "If you find asking users this permission to be disruptive, you can remove it if you used it only for Mobile Engagement but at the cost of disabling big picture feature.",
      "pos": [
        14428,
        14596
      ]
    },
    {
      "content": "For the location features, you should request permissions to user using a standard system dialog.",
      "pos": [
        14598,
        14695
      ]
    },
    {
      "content": "If the user approves, you need to tell <ph id=\"ph1\">``EngagementAgent``</ph> to take that change into account in real time (otherwise the change will be processed the next time the user launches the application).",
      "pos": [
        14696,
        14890
      ]
    },
    {
      "pos": [
        14892,
        15037
      ],
      "content": "Here is a code sample to use in an activity of your application to request permissions and forward the result if positive to <ph id=\"ph1\">``EngagementAgent``</ph>:"
    },
    {
      "content": "Advanced reporting",
      "pos": [
        16763,
        16781
      ]
    },
    {
      "content": "Optionally, if you want to report application specific events, errors and jobs, you need to use the Engagement API through the methods of the <ph id=\"ph1\">`EngagementAgent`</ph> class.",
      "pos": [
        16783,
        16949
      ]
    },
    {
      "content": "An object of this class can be retreived by calling the <ph id=\"ph1\">`EngagementAgent.getInstance()`</ph> static method.",
      "pos": [
        16950,
        17052
      ]
    },
    {
      "content": "The Engagement API allows to use all of Engagement's advanced capabilities and is detailed in the How to Use the",
      "pos": [
        17054,
        17166
      ]
    },
    {
      "content": "Engagement API on Android (as well as in the technical documentation of the <ph id=\"ph1\">`EngagementAgent`</ph> class).",
      "pos": [
        17167,
        17268
      ]
    },
    {
      "content": "Advanced configuration (in AndroidManifest.xml)",
      "pos": [
        17272,
        17319
      ]
    },
    {
      "content": "If you want to be sure that statistics are sent in real time when using Wifi or when the screen is off, add the following optional permission:",
      "pos": [
        17321,
        17463
      ]
    },
    {
      "pos": [
        17541,
        17644
      ],
      "content": "If you want to disable crash reports, add this (between the <ph id=\"ph1\">`&lt;application&gt;`</ph> and <ph id=\"ph2\">`&lt;/application&gt;`</ph> tags):"
    },
    {
      "content": "By default, the Engagement service reports logs in real time.",
      "pos": [
        17732,
        17793
      ]
    },
    {
      "content": "If your application reports logs very frequently, it is better to buffer the logs and to report them all at once on a regular time base (this is called the \"burst mode\").",
      "pos": [
        17794,
        17964
      ]
    },
    {
      "content": "To do so, add this (between the <ph id=\"ph1\">`&lt;application&gt;`</ph> and <ph id=\"ph2\">`&lt;/application&gt;`</ph> tags):",
      "pos": [
        17965,
        18040
      ]
    },
    {
      "content": "The burst mode slightly increase the battery life but has an impact on the Engagement Monitor: all sessions and jobs duration will be rounded to the burst threshold (thus, sessions and jobs shorter than the burst threshold may not be visible).",
      "pos": [
        18173,
        18416
      ]
    },
    {
      "content": "It is recommended to use a burst threshold no longer than 30000 (30s).",
      "pos": [
        18417,
        18487
      ]
    },
    {
      "content": "By default, the Engagement service establishes the connection with our servers as soon as the network is available.",
      "pos": [
        18489,
        18604
      ]
    },
    {
      "content": "If you want to postpone the connection, add this (between the <ph id=\"ph1\">`&lt;application&gt;`</ph> and <ph id=\"ph2\">`&lt;/application&gt;`</ph> tags):",
      "pos": [
        18605,
        18710
      ]
    },
    {
      "content": "By default, a session is ended 10s after the end of its last activity (which usually occurs by pressing the Home or Back key, by setting the phone idle or by jumping into another application).",
      "pos": [
        18823,
        19015
      ]
    },
    {
      "content": "This is to avoid a session split each time the user exit and return to the application very quickly (which can happen when he pick up a image, check a notification, etc.).",
      "pos": [
        19016,
        19187
      ]
    },
    {
      "content": "You may want to modify this parameter.",
      "pos": [
        19188,
        19226
      ]
    },
    {
      "content": "To do so, add this (between the <ph id=\"ph1\">`&lt;application&gt;`</ph> and <ph id=\"ph2\">`&lt;/application&gt;`</ph> tags):",
      "pos": [
        19227,
        19302
      ]
    },
    {
      "content": "Disable log reporting",
      "pos": [
        19425,
        19446
      ]
    },
    {
      "content": "Using a method call",
      "pos": [
        19452,
        19471
      ]
    },
    {
      "content": "If you want Engagement to stop sending logs, you can call:",
      "pos": [
        19473,
        19531
      ]
    },
    {
      "content": "This call is persistent: it uses a shared preferences file.",
      "pos": [
        19602,
        19661
      ]
    },
    {
      "content": "If Engagement is active when you call this function, it may take 1 minute for the service to stop.",
      "pos": [
        19663,
        19761
      ]
    },
    {
      "content": "However it won't launch the service at all the next time you launch the application.",
      "pos": [
        19762,
        19846
      ]
    },
    {
      "pos": [
        19848,
        19924
      ],
      "content": "You can enable log reporting again by calling the same function with <ph id=\"ph1\">`true`</ph>."
    },
    {
      "pos": [
        19930,
        19974
      ],
      "content": "Integration in your own <ph id=\"ph1\">`PreferenceActivity`</ph>"
    },
    {
      "pos": [
        19976,
        20093
      ],
      "content": "Instead of calling this function, you can also integrate this setting directly in your existing <ph id=\"ph1\">`PreferenceActivity`</ph>."
    },
    {
      "pos": [
        20095,
        20240
      ],
      "content": "You can configure Engagement to use your preferences file (with the desired mode) in the <ph id=\"ph1\">`AndroidManifest.xml`</ph> file with <ph id=\"ph2\">`application meta-data`</ph>:"
    },
    {
      "pos": [
        20246,
        20345
      ],
      "content": "The <ph id=\"ph1\">`engagement:agent:settings:name`</ph> key is used to define the name of the shared preferences file."
    },
    {
      "content": "The <ph id=\"ph1\">`engagement:agent:settings:mode`</ph> key is used to define the mode of the shared preferences file, you should use the same mode as in your <ph id=\"ph2\">`PreferenceActivity`</ph>.",
      "pos": [
        20350,
        20511
      ]
    },
    {
      "content": "The mode must be passed as a number: if you are using a combination of constant flags in your code, check the total value.",
      "pos": [
        20512,
        20634
      ]
    },
    {
      "pos": [
        20636,
        20745
      ],
      "content": "Engagement always use the <ph id=\"ph1\">`engagement:key`</ph> boolean key within the preferences file for managing this setting."
    },
    {
      "pos": [
        20747,
        20819
      ],
      "content": "The following example of <ph id=\"ph1\">`AndroidManifest.xml`</ph> shows the default values:"
    },
    {
      "pos": [
        21145,
        21234
      ],
      "content": "Then you can add a <ph id=\"ph1\">`CheckBoxPreference`</ph> in your preference layout like the following one:"
    },
    {
      "content": "test",
      "pos": [
        21593,
        21597
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"Azure Mobile Engagement Android SDK Integration\" \n    description=\"Latest updates and procedures for Android SDK for Azure Mobile Engagement\"\n    services=\"mobile-engagement\" \n    documentationCenter=\"mobile\" \n    authors=\"piyushjo\" \n    manager=\"dwrede\" \n    editor=\"\" />\n\n<tags \n    ms.service=\"mobile-engagement\" \n    ms.workload=\"mobile\" \n    ms.tgt_pltfrm=\"mobile-android\" \n    ms.devlang=\"Java\" \n    ms.topic=\"article\" \n    ms.date=\"08/10/2015\" \n    ms.author=\"piyushjo\" />\n\n#How to Integrate Engagement on Android\n\n> [AZURE.SELECTOR] \n- [Windows Universal](mobile-engagement-windows-store-integrate-engagement.md) \n- [Windows Phone Silverlight](mobile-engagement-windows-phone-integrate-engagement.md) \n- [iOS](mobile-engagement-ios-integrate-engagement.md) \n- [Android](mobile-engagement-android-integrate-engagement.md) \n\nThis procedure describes the simplest way to activate Engagement's Analytics and Monitoring functions in your Android application.\n\n> [AZURE.IMPORTANT] Your minimum Android SDK API level must be 10 or higher (Android 2.3.3 or higher).\n \nThe following steps are enough to activates the report of logs needed to compute all statistics regarding Users, Sessions, Activities, Crashes and Technicals. The report of logs needed to compute other statistics like Events, Errors and Jobs must be done manually using the Engagement API (see [How to use the advanced Mobile Engagement tagging API in your Android](mobile-engagement-android-use-engagement-api.md) since these statistics are application dependent.\n\n##Embed the Engagement SDK and service into your Android project\n\nDownload the Android SDK from [here](http://go.microsoft.com/?linkid=9863935&clcid=0x409)\nGet `mobile-engagement-VERSION.jar` and put them into the `libs` folder of your Android project (create the libs folder if it does not exist yet).\n\n> [AZURE.IMPORTANT]\n> If you build your application package with ProGuard, you need to keep some classes. You can use the following configuration snippet:\n>\n> \n            -keep public class * extends android.os.IInterface\n            -keep class com.microsoft.azure.engagement.reach.activity.EngagementWebAnnouncementActivity$EngagementReachContentJS {\n            <methods>;\n            }\n\nSpecify your Engagement connection string by calling the following method in the launcher activity:\n\n            EngagementConfiguration engagementConfiguration = new EngagementConfiguration();\n            engagementConfiguration.setConnectionString(\"Endpoint={appCollection}.{domain};AppId={appId};SdkKey={sdkKey}\");\n            EngagementAgent.getInstance(this).init(engagementConfiguration);\n\nThe connection string for your application is displayed on Azure Portal.\n\n-   If missing, add the following Android permissions (before the `<application>` tag):\n\n            <uses-permission android:name=\"android.permission.INTERNET\"/>\n            <uses-permission android:name=\"android.permission.ACCESS_NETWORK_STATE\"/>\n\n-   Add the following section (between the `<application>` and `</application>` tags):\n\n            <service\n              android:name=\"com.microsoft.azure.engagement.service.EngagementService\"\n              android:exported=\"false\"\n              android:label=\"<Your application name>Service\"\n              android:process=\":Engagement\"/>\n\n-   Change `<Your application name>` by the name of your application.\n\n> [AZURE.TIP] The `android:label` attribute allows you to choose the name of the Engagement service as it will appear to the end-users in the \"Running services\" screen of their phone. It is recommended to set this attribute to `\"<Your application name>Service\"` (e.g. `\"AcmeFunGameService\"`).\n\nSpecifying the `android:process` attribute ensures that the Engagement service will run in its own process (running Engagement in the same process as your application will make your main/UI thread potentially less responsive).\n\n> [AZURE.NOTE] Any code you place in `Application.onCreate()` and other application callbacks will be run for all your application's processes, including the Engagement service. It may have unwanted side effects (like unneeded memory allocations and threads in the Engagement's process, duplicate broadcast receivers or services).\n\nIf you override `Application.onCreate()`, it's recommended to add the following code snippet at the beginning of your `Application.onCreate()` function:\n\n             public void onCreate()\n             {\n               if (EngagementAgentUtils.isInDedicatedEngagementProcess(this))\n                 return;\n            \n               ... Your code...\n             }\n\nYou can do the same thing for `Application.onTerminate()`, `Application.onLowMemory()` and `Application.onConfigurationChanged(...)`.\n\nYou can also extend `EngagementApplication` instead of extending `Application`: the callback `Application.onCreate()` does the process check and calls `Application.onApplicationProcessCreate()` only if the current process is not the one hosting the Engagement service, the same rules apply for the other callbacks.\n\n##Basic reporting\n\n### Recommended method: overload your `Activity` classes\n\nIn order to activate the report of all the logs required by Engagement to compute Users, Sessions, Activities, Crashes and Technical statistics, you just have to make all your `*Activity` sub-classes inherit from the corresponding `Engagement*Activity` classes (e.g. if your legacy activity extends `ListActivity`, make it extends `EngagementListActivity`).\n\n**Without Engagement :**\n\n            package com.company.myapp;\n            \n            import android.app.Activity;\n            import android.os.Bundle;\n            \n            public class MyApp extends Activity\n            {\n              @Override\n              public void onCreate(Bundle savedInstanceState)\n              {\n                super.onCreate(savedInstanceState);\n                setContentView(R.layout.main);\n              }\n            }\n\n**With Engagement :**\n\n            package com.company.myapp;\n            \n            import com.microsoft.azure.engagement.activity.EngagementActivity;\n            import android.os.Bundle;\n            \n            public class MyApp extends EngagementActivity\n            {\n              @Override\n              public void onCreate(Bundle savedInstanceState)\n              {\n                super.onCreate(savedInstanceState);\n                setContentView(R.layout.main);\n              }\n            }\n\n> [AZURE.IMPORTANT] When using `EngagementListActivity` or `EngagementExpandableListActivity`, make sure any call to `requestWindowFeature(...);` is made before the call to `super.onCreate(...);`, otherwise a crash will occur.\n\nWe provide sub-classes of `FragmentActivity` and `MapActivity`, but to avoid problems with applications using **ProGuard**, we do not include them in `engagement.jar`.\n\nYou can find these classes in the `src` folder, and can copy them into your project. The classes are also in the **JavaDoc**.\n\n### Alternate method: call `startActivity()` and `endActivity()` manually\n\nIf you cannot or do not want to overload your `Activity` classes, you can instead start and end your activities by calling `EngagementAgent`'s methods directly.\n\n> [AZURE.IMPORTANT] The Android SDK never calls the `endActivity()` method, even when the application is closed (on Android, applications are actually never closed). Thus, it is *HIGHLY* recommended to call the `startActivity()` method in the `onResume` callback of *ALL* your activities, and the `endActivity()` method in the `onPause()` callback of *ALL* your activities. This is the only way to be sure that sessions will not be leaked. If a session is leaked, the Engagement service will never disconnect from the Engagement backend (since the service stays connected as long as a session is pending).\n\nHere is an example:\n\n            public class MyActivity extends Some3rdPartyActivity\n            {\n              @Override\n              protected void onResume()\n              {\n                super.onResume();\n                String activityNameOnEngagement = EngagementAgentUtils.buildEngagementActivityName(getClass()); // Uses short class name and removes \"Activity\" at the end.\n                EngagementAgent.getInstance(this).startActivity(this, activityNameOnEngagement, null);\n              }\n            \n              @Override\n              protected void onPause()\n              {\n                super.onPause();\n                EngagementAgent.getInstance(this).endActivity();\n              }\n            }\n\nThis example very similiar to the `EngagementActivity` class and its variants, whose source code is provided in the `src` folder.\n\n##Test\n\nNow please verify your integration by running your mobile app in an emulator or device and verifying that it registers a session on the Monitor tab. \n\nThe next sections are optional.\n\n##Location reporting\n\nIf you want locations to be reported, you need to add a few lines of configuration (between the `<application>` and `</application>` tags).\n\n### Lazy area location reporting\n\nLazy area location reporting allows to report the country, region and locality associated to devices. This type of location reporting only uses network locations (based on Cell ID or WIFI). The device area is reported at most once per session. The GPS is never used, and thus this type of location report has very few (not to say no) impact on the battery.\n\nReported areas are used to compute geographic statistics about users, sessions, events and errors. They can also be used as criterion in Reach campaigns.\n\nTo enable lazy area location reporting, you can do it by using the configuration previously mentioned in this procedure :\n\n    EngagementConfiguration engagementConfiguration = new EngagementConfiguration();\n    engagementConfiguration.setConnectionString(\"Endpoint={appCollection}.{domain};AppId={appId};SdkKey={sdkKey}\");\n    engagementConfiguration.setLazyAreaLocationReport(true);\n    EngagementAgent.getInstance(this).init(engagementConfiguration);\n\nYou also need to add the following permission if missing:\n\n            <uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\"/>\n\nOr you can keep using ``ACCESS_FINE_LOCATION`` if you already use it in your application.\n\n### Real time location reporting\n\nReal time location reporting allows to report the latitude and longitude associated to devices. By default, this type of location reporting only uses network locations (based on Cell ID or WIFI), and the reporting is only active when the application runs in foreground (i.e. during a session).\n\nReal time locations are *NOT* used to compute statistics. Their only purpose is to allow the use of real time\ngeo-fencing \\<Reach-Audience-geofencing\\> criterion in Reach campaigns.\n\nTo enable real time location reporting, you can do it by using the configuration previously mentioned in this procedure :\n\n    EngagementConfiguration engagementConfiguration = new EngagementConfiguration();\n    engagementConfiguration.setConnectionString(\"Endpoint={appCollection}.{domain};AppId={appId};SdkKey={sdkKey}\");\n    engagementConfiguration.setRealtimeLocationReport(true);\n    EngagementAgent.getInstance(this).init(engagementConfiguration);\n\nYou also need to add the following permission if missing:\n\n            <uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\"/>\n\nOr you can keep using ``ACCESS_FINE_LOCATION`` if you already use it in your application.\n\n#### GPS based reporting\n\nBy default, real time location reporting only uses network based locations. To enable the use of GPS based locations (which are far more precise), use the configuration object:\n\n    EngagementConfiguration engagementConfiguration = new EngagementConfiguration();\n    engagementConfiguration.setConnectionString(\"Endpoint={appCollection}.{domain};AppId={appId};SdkKey={sdkKey}\");\n    engagementConfiguration.setRealtimeLocationReport(true);\n    engagementConfiguration.setFineRealtimeLocationReport(true);\n    EngagementAgent.getInstance(this).init(engagementConfiguration);\n\nYou also need to add the following permission if missing:\n\n            <uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\"/>\n\n#### Background reporting\n\nBy default, real time location reporting is only active when the application runs in foreground (i.e. during a session). To enable the reporting also in background, use the configuration object:\n\n    EngagementConfiguration engagementConfiguration = new EngagementConfiguration();\n    engagementConfiguration.setConnectionString(\"Endpoint={appCollection}.{domain};AppId={appId};SdkKey={sdkKey}\");\n    engagementConfiguration.setRealtimeLocationReport(true);\n    engagementConfiguration.setBackgroundRealtimeLocationReport(true);\n    EngagementAgent.getInstance(this).init(engagementConfiguration);\n\n> [AZURE.NOTE] When the application runs in background, only network based locations are reported, even if you enabled the GPS.\n\nThe background location report will be stopped if the user reboots its device, you can add this to make it automatically restart at boot time:\n\n            <receiver android:name=\"com.microsoft.azure.engagement.EngagementLocationBootReceiver\"\n               android:exported=\"false\">\n               <intent-filter>\n                  <action android:name=\"android.intent.action.BOOT_COMPLETED\" />\n               </intent-filter>\n            </receiver>\n\nYou also need to add the following permission if missing:\n\n            <uses-permission android:name=\"android.permission.RECEIVE_BOOT_COMPLETED\" />\n\n### Android M permissions\n\nStarting with Android M, some permissions are managed at runtime and needs user approval.\n\nThe runtime permissions will be turned off by default for new app installations if you target Android API level 23. Otherwise it will be turned on by default.\n\nThe user can enable/disable those permissions from the device settings menu. Turning off permissions from system menu kills background processes of the application, this is a system behavior and has no impact on ability to receive push in background.\n\nIn the context of Mobile Engagement, the permissions that require approval at runtime are:\n\n- `ACCESS_COARSE_LOCATION`\n- `ACCESS_FINE_LOCATION`\n- `WRITE_EXTERNAL_STORAGE` (only when targeting Android API level 23 for this one)\n\nThe external storage is used only for Reach big picture feature. If you find asking users this permission to be disruptive, you can remove it if you used it only for Mobile Engagement but at the cost of disabling big picture feature.\n\nFor the location features, you should request permissions to user using a standard system dialog. If the user approves, you need to tell ``EngagementAgent`` to take that change into account in real time (otherwise the change will be processed the next time the user launches the application).\n\nHere is a code sample to use in an activity of your application to request permissions and forward the result if positive to ``EngagementAgent``:\n\n    @Override\n    public void onCreate(Bundle savedInstanceState)\n    {\n      /* Other code... */\n    \n      /* Request permissions */\n      requestPermissions();\n    }\n\n    @TargetApi(Build.VERSION_CODES.M)\n    private void requestPermissions()\n    {\n      /* Avoid crashing if not on Android M */\n      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M)\n      {\n        /*\n         * Request location permission, but this won't explain why it is needed to the user.\n         * The standard Android documentation explains with more details how to display a rationale activity to explain the user why the permission is needed in your application.\n         * Putting COARSE vs FINE has no impact here, they are part of the same group for runtime permission management.\n         */\n        if (checkSelfPermission(android.Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED)\n          requestPermissions(new String[] { android.Manifest.permission.ACCESS_FINE_LOCATION }, 0);\n    \n        /* Only if you want to keep features using external storage */\n        if (checkSelfPermission(android.Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED)\n          requestPermissions(new String[] { android.Manifest.permission.WRITE_EXTERNAL_STORAGE }, 1);\n      }\n    }\n\n    @Override\n    public void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults)\n    {\n      /* Only a positive location permission update requires engagement agent refresh, hence the request code matching from above function */\n      if (requestCode == 0 && grantResults[0] == PackageManager.PERMISSION_GRANTED)\n        getEngagementAgent().refreshPermissions();\n    }\n\n##Advanced reporting\n\nOptionally, if you want to report application specific events, errors and jobs, you need to use the Engagement API through the methods of the `EngagementAgent` class. An object of this class can be retreived by calling the `EngagementAgent.getInstance()` static method.\n\nThe Engagement API allows to use all of Engagement's advanced capabilities and is detailed in the How to Use the\nEngagement API on Android (as well as in the technical documentation of the `EngagementAgent` class).\n\n##Advanced configuration (in AndroidManifest.xml)\n\nIf you want to be sure that statistics are sent in real time when using Wifi or when the screen is off, add the following optional permission:\n\n            <uses-permission android:name=\"android.permission.WAKE_LOCK\"/>\n\nIf you want to disable crash reports, add this (between the `<application>` and `</application>` tags):\n\n            <meta-data android:name=\"engagement:reportCrash\" android:value=\"false\"/>\n\nBy default, the Engagement service reports logs in real time. If your application reports logs very frequently, it is better to buffer the logs and to report them all at once on a regular time base (this is called the \"burst mode\"). To do so, add this (between the `<application>` and `</application>` tags):\n\n            <meta-data android:name=\"engagement:burstThreshold\" android:value=\"<interval between too bursts (in milliseconds)>\"/>\n\nThe burst mode slightly increase the battery life but has an impact on the Engagement Monitor: all sessions and jobs duration will be rounded to the burst threshold (thus, sessions and jobs shorter than the burst threshold may not be visible). It is recommended to use a burst threshold no longer than 30000 (30s).\n\nBy default, the Engagement service establishes the connection with our servers as soon as the network is available. If you want to postpone the connection, add this (between the `<application>` and `</application>` tags):\n\n            <meta-data android:name=\"engagement:connection:delay\" android:value=\"<delay (in milliseconds)>\"/>\n\nBy default, a session is ended 10s after the end of its last activity (which usually occurs by pressing the Home or Back key, by setting the phone idle or by jumping into another application). This is to avoid a session split each time the user exit and return to the application very quickly (which can happen when he pick up a image, check a notification, etc.). You may want to modify this parameter. To do so, add this (between the `<application>` and `</application>` tags):\n\n            <meta-data android:name=\"engagement:sessionTimeout\" android:value=\"<session timeout (in milliseconds)>\"/>\n\n##Disable log reporting\n\n### Using a method call\n\nIf you want Engagement to stop sending logs, you can call:\n\n            EngagementAgent.getInstance(context).setEnabled(false);\n\nThis call is persistent: it uses a shared preferences file.\n\nIf Engagement is active when you call this function, it may take 1 minute for the service to stop. However it won't launch the service at all the next time you launch the application.\n\nYou can enable log reporting again by calling the same function with `true`.\n\n### Integration in your own `PreferenceActivity`\n\nInstead of calling this function, you can also integrate this setting directly in your existing `PreferenceActivity`.\n\nYou can configure Engagement to use your preferences file (with the desired mode) in the `AndroidManifest.xml` file with `application meta-data`:\n\n-   The `engagement:agent:settings:name` key is used to define the name of the shared preferences file.\n-   The `engagement:agent:settings:mode` key is used to define the mode of the shared preferences file, you should use the same mode as in your `PreferenceActivity`. The mode must be passed as a number: if you are using a combination of constant flags in your code, check the total value.\n\nEngagement always use the `engagement:key` boolean key within the preferences file for managing this setting.\n\nThe following example of `AndroidManifest.xml` shows the default values:\n\n            <application>\n                [...]\n                <meta-data\n                  android:name=\"engagement:agent:settings:name\"\n                  android:value=\"engagement.agent\" />\n                <meta-data\n                  android:name=\"engagement:agent:settings:mode\"\n                  android:value=\"0\" />\n\nThen you can add a `CheckBoxPreference` in your preference layout like the following one:\n\n            <CheckBoxPreference\n              android:key=\"engagement:enabled\"\n              android:defaultValue=\"true\"\n              android:title=\"Use Engagement\"\n              android:summaryOn=\"Engagement is enabled.\"\n              android:summaryOff=\"Engagement is disabled.\" />\n\n<!-- URLs. -->\n[Device API]: http://go.microsoft.com/?linkid=9876094\n \ntest\n"
}