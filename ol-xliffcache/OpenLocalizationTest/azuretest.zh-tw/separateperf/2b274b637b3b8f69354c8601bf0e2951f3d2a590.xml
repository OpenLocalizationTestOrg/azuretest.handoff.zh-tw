{
  "nodes": [
    {
      "content": "Azure virtual machine backup - Backup | Microsoft Azure",
      "pos": [
        27,
        82
      ]
    },
    {
      "content": "Learn how to backup an Azure virtual machine after registration",
      "pos": [
        101,
        164
      ]
    },
    {
      "content": "Backup Azure virtual machines",
      "pos": [
        488,
        517
      ]
    },
    {
      "content": "This article is the essential guide to backing up Azure virtual machines.",
      "pos": [
        518,
        591
      ]
    },
    {
      "content": "Before you proceed, ensure that all the <bpt id=\"p1\">[</bpt>prerequisites<ept id=\"p1\">](backup-azure-vms-introduction.md#prerequisites)</ept> have been met.",
      "pos": [
        592,
        710
      ]
    },
    {
      "content": "Backing up Azure virtual machines involves three key steps:",
      "pos": [
        712,
        771
      ]
    },
    {
      "content": "Three steps to backup an Azure virtual machine",
      "pos": [
        775,
        821
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> Virtual machine backup is local.",
      "pos": [
        874,
        919
      ]
    },
    {
      "content": "The backup vault from a specified Azure region will not allow you to backup virtual machines from another Azure region.",
      "pos": [
        920,
        1039
      ]
    },
    {
      "content": "Thus for every Azure region that has VMs that need backup, at least 1 backup vault must be created in that region.",
      "pos": [
        1040,
        1154
      ]
    },
    {
      "content": "1. Discover Azure virtual machines",
      "pos": [
        1159,
        1193
      ]
    },
    {
      "content": "The discovery process queries Azure for the list of virtual machines in the subscription, along with additional information like the Cloud Service name and the Region.",
      "pos": [
        1194,
        1361
      ]
    },
    {
      "content": "The discovery process should always be run as the first step.",
      "pos": [
        1362,
        1423
      ]
    },
    {
      "content": "This is to ensure that any new virtual machines added to the subscription are identified.",
      "pos": [
        1424,
        1513
      ]
    },
    {
      "content": "To trigger the discovery process",
      "pos": [
        1519,
        1551
      ]
    },
    {
      "pos": [
        1556,
        1698
      ],
      "content": "Navigate to the backup vault, which can be found under <bpt id=\"p1\">**</bpt>Recovery Services<ept id=\"p1\">**</ept> in the Azure portal, and then click the <bpt id=\"p2\">**</bpt>Registered Items<ept id=\"p2\">**</ept> tab."
    },
    {
      "pos": [
        1703,
        1820
      ],
      "content": "Choose the type of workload in the drop-down menu as <bpt id=\"p1\">**</bpt>Azure Virtual Machine<ept id=\"p1\">**</ept>, and then click the <bpt id=\"p2\">**</bpt>Select<ept id=\"p2\">**</ept> button."
    },
    {
      "content": "select workload",
      "pos": [
        1828,
        1843
      ]
    },
    {
      "pos": [
        1905,
        2035
      ],
      "content": "Click the **DISCOVER** button at the bottom of the page.\n ![discover button](./media/backup-azure-vms/discover-button-only.png)",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "Click the <bpt id=\"p1\">**</bpt>DISCOVER<ept id=\"p1\">**</ept> button at the bottom of the page.",
          "pos": [
            0,
            56
          ]
        },
        {
          "content": "<ph id=\"ph1\"> ![</ph>discover button<ph id=\"ph2\">](./media/backup-azure-vms/discover-button-only.png)</ph>",
          "pos": [
            57,
            127
          ]
        }
      ]
    },
    {
      "content": "The discovery process can run for a few minutes while the virtual machines are being tabulated.",
      "pos": [
        2040,
        2135
      ]
    },
    {
      "content": "A toast notification at the bottom of the screen appears while the discovery process is running.",
      "pos": [
        2136,
        2232
      ]
    },
    {
      "content": "discover vms",
      "pos": [
        2240,
        2252
      ]
    },
    {
      "content": "Once the discovery process is complete, a toast notification appears.",
      "pos": [
        2304,
        2373
      ]
    },
    {
      "content": "discover-done",
      "pos": [
        2381,
        2394
      ]
    },
    {
      "content": "2. Register Azure virtual machines",
      "pos": [
        2450,
        2484
      ]
    },
    {
      "content": "Before a virtual machine can be protected it needs to be registered with the Azure Backup service.",
      "pos": [
        2485,
        2583
      ]
    },
    {
      "content": "The primary goal of the Registration process is to associate the virtual machine with the Azure Backup service.",
      "pos": [
        2584,
        2695
      ]
    },
    {
      "content": "Registration is typically a one-time activity.",
      "pos": [
        2696,
        2742
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> The backup extension is not installed during the Registration step.",
      "pos": [
        2745,
        2825
      ]
    },
    {
      "content": "The installation and update of the backup agent is now part of the scheduled backup job.",
      "pos": [
        2826,
        2914
      ]
    },
    {
      "content": "To register virtual machines",
      "pos": [
        2920,
        2948
      ]
    },
    {
      "pos": [
        2953,
        3094
      ],
      "content": "Navigate to the backup vault, which can be found under <bpt id=\"p1\">**</bpt>Recovery Services<ept id=\"p1\">**</ept> in the Azure portal, and then click the <bpt id=\"p2\">**</bpt>Registered Items<ept id=\"p2\">**</ept> tab"
    },
    {
      "pos": [
        3099,
        3211
      ],
      "content": "Choose the type of workload in the drop-down menu as <bpt id=\"p1\">**</bpt>Azure Virtual Machine<ept id=\"p1\">**</ept> and then click the select button."
    },
    {
      "content": "select workload",
      "pos": [
        3219,
        3234
      ]
    },
    {
      "pos": [
        3296,
        3426
      ],
      "content": "Click the **REGISTER** button at the bottom of the page.\n ![register button](./media/backup-azure-vms/register-button-only.png)",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "Click the <bpt id=\"p1\">**</bpt>REGISTER<ept id=\"p1\">**</ept> button at the bottom of the page.",
          "pos": [
            0,
            56
          ]
        },
        {
          "content": "<ph id=\"ph1\"> ![</ph>register button<ph id=\"ph2\">](./media/backup-azure-vms/register-button-only.png)</ph>",
          "pos": [
            57,
            127
          ]
        }
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Register Items<ept id=\"p1\">**</ept> shortcut menu, choose the virtual machines that you would like to register.",
      "pos": [
        3431,
        3532
      ]
    },
    {
      "content": "If there are two or more virtual machines with the same name use the cloud service to distinguish between the virtual machines.",
      "pos": [
        3533,
        3660
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>Register<ept id=\"p1\">**</ept> operation can be done at scale, which means that multiple virtual machines can be selected at one time to be registered.",
      "pos": [
        3666,
        3803
      ]
    },
    {
      "content": "This greatly reduces the one-time effort spent in preparing the virtual machine for backup.",
      "pos": [
        3804,
        3895
      ]
    },
    {
      "content": "A job is created for each virtual machine that should be registered.",
      "pos": [
        3901,
        3969
      ]
    },
    {
      "content": "The toast notification shows the status of this activity.",
      "pos": [
        3970,
        4027
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>View Job<ept id=\"p1\">**</ept> to go to the <bpt id=\"p2\">**</bpt>Jobs<ept id=\"p2\">**</ept> page.",
      "pos": [
        4028,
        4074
      ]
    },
    {
      "content": "register job",
      "pos": [
        4082,
        4094
      ]
    },
    {
      "content": "The virtual machine also appears in the list of registered items and the status of the registration operation is shown.",
      "pos": [
        4150,
        4269
      ]
    },
    {
      "content": "Registering status 1",
      "pos": [
        4277,
        4297
      ]
    },
    {
      "content": "Once the operation is completed, the status in the portal will change to reflect the registered state.",
      "pos": [
        4351,
        4453
      ]
    },
    {
      "content": "Registration status 2",
      "pos": [
        4461,
        4482
      ]
    },
    {
      "content": "3. Protect: Backup Azure virtual machines",
      "pos": [
        4536,
        4577
      ]
    },
    {
      "content": "This step involves setting up a backup and retention policy for the virtual machine.",
      "pos": [
        4578,
        4662
      ]
    },
    {
      "content": "To protect a virtual machine, do the following steps:",
      "pos": [
        4663,
        4716
      ]
    },
    {
      "pos": [
        4721,
        4863
      ],
      "content": "Navigate to the backup vault, which can be found under <bpt id=\"p1\">**</bpt>Recovery Services<ept id=\"p1\">**</ept> in the Azure portal, and then click the <bpt id=\"p2\">**</bpt>Registered Items<ept id=\"p2\">**</ept> tab."
    },
    {
      "pos": [
        4867,
        4984
      ],
      "content": "Choose the type of workload in the drop-down menu as <bpt id=\"p1\">**</bpt>Azure Virtual Machine<ept id=\"p1\">**</ept>, and then click the <bpt id=\"p2\">**</bpt>Select<ept id=\"p2\">**</ept> button."
    },
    {
      "content": "Select workload in portal",
      "pos": [
        4992,
        5017
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>PROTECT<ept id=\"p1\">**</ept> button at the bottom of the page.",
      "pos": [
        5069,
        5124
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>Protect Items<ept id=\"p1\">**</ept> wizard appears.",
      "pos": [
        5125,
        5162
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>Protect Items<ept id=\"p1\">**</ept> wizard is where the virtual machines to be protected can be selected.",
      "pos": [
        5167,
        5258
      ]
    },
    {
      "content": "If there are two or more virtual machines with the same name use the cloud service to distinguish between the virtual machines.",
      "pos": [
        5259,
        5386
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>Protect<ept id=\"p1\">**</ept> operation can be done at scale, which means that multiple virtual machines can be selected at one time to be registered.",
      "pos": [
        5392,
        5528
      ]
    },
    {
      "content": "This greatly reduces the effort spent in protecting the virtual machine.",
      "pos": [
        5529,
        5601
      ]
    },
    {
      "content": "In the second screen of the <bpt id=\"p1\">**</bpt>Protect Items<ept id=\"p1\">**</ept> wizard, choose a backup and retention policy to back up the selected virtual machines.",
      "pos": [
        5606,
        5738
      ]
    },
    {
      "content": "Pick from an existing set of policies or define a new one.",
      "pos": [
        5739,
        5797
      ]
    },
    {
      "content": "In each backup vault, you can have multiple backup policies.",
      "pos": [
        5803,
        5863
      ]
    },
    {
      "content": "The policies reflect the details about how the backup should be scheduled and retained.",
      "pos": [
        5864,
        5951
      ]
    },
    {
      "content": "For example, one backup policy could be for daily backup at 10:00 P.M., while another backup policy could be for weekly backup at 6:00 A.M.",
      "pos": [
        5952,
        6091
      ]
    },
    {
      "content": "Multiple backup policies allow flexibility in scheduling backups for your virtual machine infrastructure.",
      "pos": [
        6092,
        6197
      ]
    },
    {
      "content": "Each backup policy can have multiple virtual machines that are associated with the policy.",
      "pos": [
        6203,
        6293
      ]
    },
    {
      "content": "The virtual machine can be associated with only one policy at any given point in time.",
      "pos": [
        6294,
        6380
      ]
    },
    {
      "content": "A job is created for each virtual machine to configure the protection policy and to associate the virtual machines to the policy.",
      "pos": [
        6385,
        6514
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>Jobs<ept id=\"p1\">**</ept> tab and choose the right filter to view the list of <bpt id=\"p2\">**</bpt>Configure Protection<ept id=\"p2\">**</ept> jobs.",
      "pos": [
        6515,
        6616
      ]
    },
    {
      "content": "Configure protection job",
      "pos": [
        6624,
        6648
      ]
    },
    {
      "content": "Post-protection activities",
      "pos": [
        6713,
        6739
      ]
    },
    {
      "content": "Installation of the backup extension",
      "pos": [
        6745,
        6781
      ]
    },
    {
      "content": "The Azure Backup service seamlessly handles the upgrade and patching of the backup extension without requiring any cumbersome user intervention.",
      "pos": [
        6783,
        6927
      ]
    },
    {
      "content": "This relieves the user of the �agent management overhead� that is typically associated with backup products.",
      "pos": [
        6928,
        7036
      ]
    },
    {
      "content": "Offline VMs",
      "pos": [
        7043,
        7054
      ]
    },
    {
      "content": "The backup extension is installed if the VM is running.",
      "pos": [
        7055,
        7110
      ]
    },
    {
      "content": "A running VM also provides the greatest chance of getting an application consistent point.",
      "pos": [
        7111,
        7201
      ]
    },
    {
      "content": "However, the Azure Backup service will continue to backup the VM even if the VM is turned off and the extension could not be installed (aka Offline VM).",
      "pos": [
        7202,
        7354
      ]
    },
    {
      "content": "The impact is seen in the consistency - in such a case the recovery point will be <bpt id=\"p1\">*</bpt>File-system consistent<ept id=\"p1\">*</ept>.",
      "pos": [
        7355,
        7462
      ]
    },
    {
      "content": "Initial backup",
      "pos": [
        7468,
        7482
      ]
    },
    {
      "content": "Once the virtual machine is protected with a policy, it shows up under the <bpt id=\"p1\">**</bpt>Protected Items<ept id=\"p1\">**</ept> tab with the status of <bpt id=\"p2\">*</bpt>Protected - (pending initial backup)<ept id=\"p2\">*</ept>.",
      "pos": [
        7483,
        7640
      ]
    },
    {
      "content": "By default, the first scheduled backup is the initial backup.",
      "pos": [
        7641,
        7702
      ]
    },
    {
      "content": "In order to trigger the initial backup immediately after configuring protection, use the <bpt id=\"p1\">**</bpt>Backup Now<ept id=\"p1\">**</ept> button at the bottom of the Protected Items page.",
      "pos": [
        7703,
        7856
      ]
    },
    {
      "content": "The Azure Backup service creates a backup job for the initial backup operation.",
      "pos": [
        7858,
        7937
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>Jobs<ept id=\"p1\">**</ept> tab to view the list of jobs.",
      "pos": [
        7938,
        7986
      ]
    },
    {
      "content": "As a part of the backup operation, the Azure Backup service issues a command to the backup extension in each virtual machines to flush all writes and take a consistent snapshot.",
      "pos": [
        7987,
        8164
      ]
    },
    {
      "content": "Backup in progress",
      "pos": [
        8168,
        8186
      ]
    },
    {
      "pos": [
        8238,
        8377
      ],
      "content": "Once the initial backup is completed, the Protection Status of the virtual machine in the <bpt id=\"p1\">**</bpt>Protected Items<ept id=\"p1\">**</ept> tab will show as <bpt id=\"p2\">*</bpt>Protected<ept id=\"p2\">*</ept>."
    },
    {
      "content": "Virtual machine is backed up with recovery point",
      "pos": [
        8381,
        8429
      ]
    },
    {
      "content": "Viewing backup status and details",
      "pos": [
        8486,
        8519
      ]
    },
    {
      "content": "Once protected, the virtual machine count also increases in the <bpt id=\"p1\">**</bpt>Dashboard<ept id=\"p1\">**</ept> page summary.",
      "pos": [
        8520,
        8611
      ]
    },
    {
      "content": "In addition, the <bpt id=\"p1\">**</bpt>Dashboard<ept id=\"p1\">**</ept> page shows the number of jobs from the last 24 hours that were successful, have failed, and are still in progress.",
      "pos": [
        8612,
        8757
      ]
    },
    {
      "content": "Clicking on any one category will drill down into that category in the <bpt id=\"p1\">**</bpt>Jobs<ept id=\"p1\">**</ept> page.",
      "pos": [
        8758,
        8843
      ]
    },
    {
      "content": "Status of backup in Dashboard page",
      "pos": [
        8847,
        8881
      ]
    },
    {
      "content": "Consistency of recovery points",
      "pos": [
        8941,
        8971
      ]
    },
    {
      "content": "When dealing with backup data, customers worry about the behavior of the VM after it has been restored.",
      "pos": [
        8972,
        9075
      ]
    },
    {
      "content": "The typical questions that customers ask are:",
      "pos": [
        9076,
        9121
      ]
    },
    {
      "content": "Will the virtual machine boot up?",
      "pos": [
        9125,
        9158
      ]
    },
    {
      "content": "Will the data be available on the disk (or) is there any data loss?",
      "pos": [
        9161,
        9228
      ]
    },
    {
      "content": "Will the application be able to read the data (or) is the data corrupted?",
      "pos": [
        9231,
        9304
      ]
    },
    {
      "content": "Will the data make sense to the application (or) is the data self-consistent when read by the application?",
      "pos": [
        9307,
        9413
      ]
    },
    {
      "content": "The following table explains the types of consistency that are encountered during Azure VM backup and restore.",
      "pos": [
        9415,
        9525
      ]
    },
    {
      "content": "Consistency",
      "pos": [
        9529,
        9540
      ]
    },
    {
      "content": "VSS-based",
      "pos": [
        9543,
        9552
      ]
    },
    {
      "content": "Explanation and details",
      "pos": [
        9555,
        9578
      ]
    },
    {
      "content": "Application consistency",
      "pos": [
        9621,
        9644
      ]
    },
    {
      "content": "Yes",
      "pos": [
        9647,
        9650
      ]
    },
    {
      "content": "This is the ideal place to be for Microsoft workloads as it ensures:",
      "pos": [
        9653,
        9721
      ]
    },
    {
      "content": "That the VM <bpt id=\"p1\">*</bpt>boots up<ept id=\"p1\">*</ept>.",
      "pos": [
        9730,
        9753
      ]
    },
    {
      "content": "There is <bpt id=\"p1\">*</bpt>no corruption<ept id=\"p1\">*</ept>.",
      "pos": [
        9758,
        9783
      ]
    },
    {
      "content": "There is <bpt id=\"p1\">*</bpt>no data loss<ept id=\"p1\">*</ept>.",
      "pos": [
        9788,
        9812
      ]
    },
    {
      "content": "The data is consistent to the application that uses the data, by involving the application at the time of backup -  using VSS.",
      "pos": [
        9817,
        9943
      ]
    },
    {
      "content": "The Volume Snapshot Service (VSS) ensures that data is written correctly to the storage.",
      "pos": [
        9949,
        10037
      ]
    },
    {
      "content": "Most Microsoft workloads have VSS writers that do workload-specific actions related to data consistency.",
      "pos": [
        10038,
        10142
      ]
    },
    {
      "content": "For example, Microsoft SQL Server has a VSS writer that ensures the writes to the transaction log file and the database are done correctly.",
      "pos": [
        10143,
        10282
      ]
    },
    {
      "content": "For Azure VM backup, getting an application consistent recovery point means that the backup extension was able to invoke the VSS workflow and complete <bpt id=\"p1\">*</bpt>correctly<ept id=\"p1\">*</ept> before the VM snapshot was taken.",
      "pos": [
        10291,
        10487
      ]
    },
    {
      "content": "Naturally, this means that the VSS writers of all the applications in the Azure VM have been invoked as well.",
      "pos": [
        10488,
        10597
      ]
    },
    {
      "content": "Learn the <bpt id=\"p1\">[</bpt>basics of VSS<ept id=\"p1\">](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx)</ept> dive deep into the details of <bpt id=\"p2\">[</bpt>how it works<ept id=\"p2\">](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx)</ept>.",
      "pos": [
        10605,
        10851
      ]
    },
    {
      "content": "File system consistency",
      "pos": [
        10856,
        10879
      ]
    },
    {
      "content": "Yes - for Windows machines",
      "pos": [
        10882,
        10908
      ]
    },
    {
      "content": "There are two scenarios where the recovery point can be file-system consistent:",
      "pos": [
        10911,
        10990
      ]
    },
    {
      "content": "Backup of Linux VMs in Azure, since Linux does not have an equivalent platform to VSS.",
      "pos": [
        10998,
        11084
      ]
    },
    {
      "content": "VSS failure during backup for Windows VMs in Azure.",
      "pos": [
        11088,
        11139
      ]
    },
    {
      "content": "In both these cases, the best that can be done is to ensure that:",
      "pos": [
        11150,
        11215
      ]
    },
    {
      "content": "The VM <bpt id=\"p1\">*</bpt>boots up<ept id=\"p1\">*</ept>.",
      "pos": [
        11225,
        11243
      ]
    },
    {
      "content": "There is <bpt id=\"p1\">*</bpt>no corruption<ept id=\"p1\">*</ept>.",
      "pos": [
        11248,
        11273
      ]
    },
    {
      "content": "There is <bpt id=\"p1\">*</bpt>no data loss<ept id=\"p1\">*</ept>.",
      "pos": [
        11277,
        11301
      ]
    },
    {
      "content": "Applications need to implement their own \"fix-up\" mechanism on the restored data.",
      "pos": [
        11307,
        11388
      ]
    },
    {
      "content": "Crash consistency",
      "pos": [
        11392,
        11409
      ]
    },
    {
      "content": "No",
      "pos": [
        11412,
        11414
      ]
    },
    {
      "content": "This situation is equivalent to a machine experiencing a \"crash\" (through either a soft or hard reset).",
      "pos": [
        11417,
        11520
      ]
    },
    {
      "content": "This typically happens when the Azure virtual machine is shut down at the time of backup.",
      "pos": [
        11521,
        11610
      ]
    },
    {
      "content": "For Azure virtual machine backup, getting a crash-consistent recovery point means that Azure Backup gives no guarantees around the consistency of the data on the storage medium - either from the perspective of the operating system or from the perspective of the application.",
      "pos": [
        11611,
        11885
      ]
    },
    {
      "content": "Only data that already exists on the disk at the time of backup is what gets captured and backed up.",
      "pos": [
        11886,
        11986
      ]
    },
    {
      "content": "While there are no guarantees, in most cases the OS will boot.",
      "pos": [
        11999,
        12061
      ]
    },
    {
      "content": "This is typically followed by a disk checking procedure like chkdsk to fix any corruption errors.",
      "pos": [
        12062,
        12159
      ]
    },
    {
      "content": "Any in-memory data or writes that have not been completely flushed to the disk will be lost.",
      "pos": [
        12160,
        12252
      ]
    },
    {
      "content": "The application typically follows with its own verification mechanism in case data rollback needs to be done.",
      "pos": [
        12253,
        12362
      ]
    },
    {
      "content": "For Azure VM backup, getting a crash consistent recovery point means that Azure Backup gives no guarantees around the consistency of the data on the storage - either from the OS perspective or the application's perspective.",
      "pos": [
        12363,
        12586
      ]
    },
    {
      "content": "This typically happens when the Azure VM is shut down at the time of backup.",
      "pos": [
        12587,
        12663
      ]
    },
    {
      "content": "As an example, if the transaction log has entries that are not present in the database, then the database software does a rollback till the data is consistent.",
      "pos": [
        12671,
        12830
      ]
    },
    {
      "content": "When dealing with data spread across multiple virtual disks (like spanned volumes), a crash-consistent recovery point provides no guarantees for the correctness of the data.",
      "pos": [
        12831,
        13004
      ]
    },
    {
      "content": "Performance and resource utilization",
      "pos": [
        13011,
        13047
      ]
    },
    {
      "content": "Like backup software that is deployed on-premises, backup of VMs in Azure also needs to be planned for capacity and resource utilization.",
      "pos": [
        13048,
        13185
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>Azure Storage limits<ept id=\"p1\">](azure-subscription-service-limits.md#storage-limits)</ept> will define how VM deployments are structured to get maximum performance with minimum impact to running workloads.",
      "pos": [
        13186,
        13380
      ]
    },
    {
      "content": "There are two main Azure Storage limits that impact backup performance:",
      "pos": [
        13381,
        13452
      ]
    },
    {
      "content": "Max egress per storage account",
      "pos": [
        13456,
        13486
      ]
    },
    {
      "content": "Total request rate per storage account",
      "pos": [
        13489,
        13527
      ]
    },
    {
      "content": "When the backup data is copied out of the customer storage account, it counts towards the IOPS and Egress (storage throughput) metrics of the storage account.",
      "pos": [
        13529,
        13687
      ]
    },
    {
      "content": "At the same time, the virtual machines are also running and consuming IOPS and throughput.",
      "pos": [
        13688,
        13778
      ]
    },
    {
      "content": "The goal is to ensure that the total traffic - backup and virtual machine - does not exceed the storage account limits.",
      "pos": [
        13779,
        13898
      ]
    },
    {
      "content": "Backup is greedy and tries to consume as many resources as it can, with the aim of completing backup as quickly as possible.",
      "pos": [
        13900,
        14024
      ]
    },
    {
      "content": "However, all IO operations are limited by the <bpt id=\"p1\">*</bpt>Target Throughput for Single Blob<ept id=\"p1\">*</ept> which has a limit of <bpt id=\"p2\">*</bpt>60MB per second<ept id=\"p2\">*</ept>.",
      "pos": [
        14025,
        14146
      ]
    },
    {
      "content": "In order to speed up the backup process, the backup of each disk of the VM is attempted <bpt id=\"p1\">*</bpt>in parallel<ept id=\"p1\">*</ept>.",
      "pos": [
        14147,
        14249
      ]
    },
    {
      "content": "Thus if a VM has 4 disks, then Azure Backup will attempt to backup all 4 disks in parallel.",
      "pos": [
        14250,
        14341
      ]
    },
    {
      "content": "Thus, the single most important factor that determines the backup traffic exiting from a customer storage account is the <bpt id=\"p1\">**</bpt>number of disks<ept id=\"p1\">**</ept> being backed up from the storage account.",
      "pos": [
        14342,
        14524
      ]
    },
    {
      "content": "A secondary factor that impacts the performance is the <bpt id=\"p1\">**</bpt>backup schedule<ept id=\"p1\">**</ept>.",
      "pos": [
        14526,
        14601
      ]
    },
    {
      "content": "If you configure all the VMs to backup at the same time, then the number of disks being backed up <bpt id=\"p1\">*</bpt>in parallel<ept id=\"p1\">*</ept> will increase - as Azure Backup will attempt to backup as many disks as possible.",
      "pos": [
        14602,
        14795
      ]
    },
    {
      "content": "So one way to reduce the backup traffic from a storage account is to ensure that different VMs are backed up at different times of the day, with no overlap.",
      "pos": [
        14796,
        14952
      ]
    },
    {
      "content": "Capacity planning",
      "pos": [
        14958,
        14975
      ]
    },
    {
      "content": "Putting all these factors together means that storage account usage needs to be planned properly.",
      "pos": [
        14976,
        15073
      ]
    },
    {
      "content": "Download the <bpt id=\"p1\">[</bpt>VM backup capacity planning excel sheet<ept id=\"p1\">](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33)</ept> to see the impact of your disk and backup schedule choices.",
      "pos": [
        15074,
        15257
      ]
    },
    {
      "content": "Backup throughput",
      "pos": [
        15263,
        15280
      ]
    },
    {
      "content": "For each disk being backed up, Azure Backup reads the blocks on the disk and stores only the changed data (incremental backup).",
      "pos": [
        15281,
        15408
      ]
    },
    {
      "content": "The table below shows average throughput values that can be expected from Azure Backup:",
      "pos": [
        15409,
        15496
      ]
    },
    {
      "content": "Backup operation",
      "pos": [
        15500,
        15516
      ]
    },
    {
      "content": "Best-case Throughput",
      "pos": [
        15519,
        15539
      ]
    },
    {
      "content": "Initial backup",
      "pos": [
        15578,
        15592
      ]
    },
    {
      "content": "160 Mbps",
      "pos": [
        15595,
        15603
      ]
    },
    {
      "content": "Incremental backup (DR)",
      "pos": [
        15608,
        15631
      ]
    },
    {
      "content": "640 Mbps",
      "pos": [
        15634,
        15642
      ]
    },
    {
      "content": "This throughput can drop significantly if there is a lot of dispersed churn on the disk that needs to be backed up",
      "pos": [
        15652,
        15766
      ]
    },
    {
      "content": "Using this you can estimate the amount of time that it will take to backup a disk of a given size.",
      "pos": [
        15770,
        15868
      ]
    },
    {
      "content": "Total VM backup time",
      "pos": [
        15874,
        15894
      ]
    },
    {
      "content": "While a majority of the time is spent in reading and copying data, there are other operations that contribute to the total time taken to backup a VM:",
      "pos": [
        15895,
        16044
      ]
    },
    {
      "pos": [
        16049,
        16136
      ],
      "content": "Time taken to <bpt id=\"p1\">[</bpt>install or update the backup extension<ept id=\"p1\">](backup-azure-vms.md#offline-vms)</ept>"
    },
    {
      "content": "Queue wait time : Since the service is processing backups from multiple customers, your backup operation might not start immediately.",
      "pos": [
        16140,
        16273
      ]
    },
    {
      "content": "The average wait time for a VM is 15-30 minutes.",
      "pos": [
        16274,
        16322
      ]
    },
    {
      "content": "Troubleshooting errors",
      "pos": [
        16328,
        16350
      ]
    },
    {
      "pos": [
        16351,
        16520
      ],
      "content": "Get an exhaustive list of workarounds to the errors that are faced during virtual machine backup: <bpt id=\"p1\">[</bpt>Troubleshoot virtual machine backup<ept id=\"p1\">](backup-azure-vms-troubleshoot.md)</ept>"
    },
    {
      "content": "Next steps",
      "pos": [
        16526,
        16536
      ]
    },
    {
      "content": "To learn more about getting started with Azure Backup, see:",
      "pos": [
        16538,
        16597
      ]
    },
    {
      "content": "Restore virtual machines",
      "pos": [
        16602,
        16626
      ]
    },
    {
      "content": "Manage virtual machines",
      "pos": [
        16660,
        16683
      ]
    },
    {
      "content": "test",
      "pos": [
        16714,
        16718
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"Azure virtual machine backup - Backup | Microsoft Azure\"\n    description=\"Learn how to backup an Azure virtual machine after registration\"\n    services=\"backup\"\n    documentationCenter=\"\"\n    authors=\"aashishr\"\n    manager=\"shreeshd\"\n    editor=\"\"/>\n\n<tags\n    ms.service=\"backup\"\n    ms.workload=\"storage-backup-recovery\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"na\"\n    ms.topic=\"hero-article\"\n    ms.date=\"09/01/2015\"\n    ms.author=\"aashishr\"; \"jimpark\"/>\n\n\n# Backup Azure virtual machines\nThis article is the essential guide to backing up Azure virtual machines. Before you proceed, ensure that all the [prerequisites](backup-azure-vms-introduction.md#prerequisites) have been met.\n\nBacking up Azure virtual machines involves three key steps:\n\n![Three steps to backup an Azure virtual machine](./media/backup-azure-vms/3-steps-for-backup.png)\n\n>[AZURE.NOTE] Virtual machine backup is local. The backup vault from a specified Azure region will not allow you to backup virtual machines from another Azure region. Thus for every Azure region that has VMs that need backup, at least 1 backup vault must be created in that region.\n\n## 1. Discover Azure virtual machines\nThe discovery process queries Azure for the list of virtual machines in the subscription, along with additional information like the Cloud Service name and the Region. The discovery process should always be run as the first step. This is to ensure that any new virtual machines added to the subscription are identified.\n\n### To trigger the discovery process\n\n1. Navigate to the backup vault, which can be found under **Recovery Services** in the Azure portal, and then click the **Registered Items** tab.\n\n2. Choose the type of workload in the drop-down menu as **Azure Virtual Machine**, and then click the **Select** button.\n\n    ![select workload](./media/backup-azure-vms/discovery-select-workload.png)\n\n3. Click the **DISCOVER** button at the bottom of the page.\n    ![discover button](./media/backup-azure-vms/discover-button-only.png)\n\n4. The discovery process can run for a few minutes while the virtual machines are being tabulated. A toast notification at the bottom of the screen appears while the discovery process is running.\n\n    ![discover vms](./media/backup-azure-vms/discovering-vms.png)\n\n5. Once the discovery process is complete, a toast notification appears.\n\n    ![discover-done](./media/backup-azure-vms/discovery-complete.png)\n\n##  2. Register Azure virtual machines\nBefore a virtual machine can be protected it needs to be registered with the Azure Backup service. The primary goal of the Registration process is to associate the virtual machine with the Azure Backup service. Registration is typically a one-time activity.\n\n>[AZURE.NOTE] The backup extension is not installed during the Registration step. The installation and update of the backup agent is now part of the scheduled backup job.\n\n### To register virtual machines\n\n1. Navigate to the backup vault, which can be found under **Recovery Services** in the Azure portal, and then click the **Registered Items** tab\n\n2. Choose the type of workload in the drop-down menu as **Azure Virtual Machine** and then click the select button.\n\n    ![select workload](./media/backup-azure-vms/discovery-select-workload.png)\n\n3. Click the **REGISTER** button at the bottom of the page.\n    ![register button](./media/backup-azure-vms/register-button-only.png)\n\n4. In the **Register Items** shortcut menu, choose the virtual machines that you would like to register. If there are two or more virtual machines with the same name use the cloud service to distinguish between the virtual machines.\n\n    The **Register** operation can be done at scale, which means that multiple virtual machines can be selected at one time to be registered. This greatly reduces the one-time effort spent in preparing the virtual machine for backup.\n\n\n5. A job is created for each virtual machine that should be registered. The toast notification shows the status of this activity. Click **View Job** to go to the **Jobs** page.\n\n    ![register job](./media/backup-azure-vms/register-create-job.png)\n\n6. The virtual machine also appears in the list of registered items and the status of the registration operation is shown.\n\n    ![Registering status 1](./media/backup-azure-vms/register-status01.png)\n\n7. Once the operation is completed, the status in the portal will change to reflect the registered state.\n\n    ![Registration status 2](./media/backup-azure-vms/register-status02.png)\n\n## 3. Protect: Backup Azure virtual machines\nThis step involves setting up a backup and retention policy for the virtual machine. To protect a virtual machine, do the following steps:\n\n1. Navigate to the backup vault, which can be found under **Recovery Services** in the Azure portal, and then click the **Registered Items** tab.\n2. Choose the type of workload in the drop-down menu as **Azure Virtual Machine**, and then click the **Select** button.\n\n    ![Select workload in portal](./media/backup-azure-vms/select-workload.png)\n\n3. Click the **PROTECT** button at the bottom of the page. The **Protect Items** wizard appears.\n\n4. The **Protect Items** wizard is where the virtual machines to be protected can be selected. If there are two or more virtual machines with the same name use the cloud service to distinguish between the virtual machines.\n\n    The **Protect** operation can be done at scale, which means that multiple virtual machines can be selected at one time to be registered. This greatly reduces the effort spent in protecting the virtual machine.\n\n5. In the second screen of the **Protect Items** wizard, choose a backup and retention policy to back up the selected virtual machines. Pick from an existing set of policies or define a new one.\n\n    In each backup vault, you can have multiple backup policies. The policies reflect the details about how the backup should be scheduled and retained. For example, one backup policy could be for daily backup at 10:00 P.M., while another backup policy could be for weekly backup at 6:00 A.M. Multiple backup policies allow flexibility in scheduling backups for your virtual machine infrastructure.\n\n    Each backup policy can have multiple virtual machines that are associated with the policy. The virtual machine can be associated with only one policy at any given point in time.\n\n6. A job is created for each virtual machine to configure the protection policy and to associate the virtual machines to the policy. Click the **Jobs** tab and choose the right filter to view the list of **Configure Protection** jobs.\n\n    ![Configure protection job](./media/backup-azure-vms/protect-configureprotection.png)\n\n\n## Post-protection activities\n\n### Installation of the backup extension\n\nThe Azure Backup service seamlessly handles the upgrade and patching of the backup extension without requiring any cumbersome user intervention. This relieves the user of the �agent management overhead� that is typically associated with backup products.\n\n#### Offline VMs\nThe backup extension is installed if the VM is running. A running VM also provides the greatest chance of getting an application consistent point. However, the Azure Backup service will continue to backup the VM even if the VM is turned off and the extension could not be installed (aka Offline VM). The impact is seen in the consistency - in such a case the recovery point will be *File-system consistent*.\n\n### Initial backup\nOnce the virtual machine is protected with a policy, it shows up under the **Protected Items** tab with the status of *Protected - (pending initial backup)*. By default, the first scheduled backup is the initial backup. In order to trigger the initial backup immediately after configuring protection, use the **Backup Now** button at the bottom of the Protected Items page.\n\nThe Azure Backup service creates a backup job for the initial backup operation. Click the **Jobs** tab to view the list of jobs. As a part of the backup operation, the Azure Backup service issues a command to the backup extension in each virtual machines to flush all writes and take a consistent snapshot.\n\n![Backup in progress](./media/backup-azure-vms/protect-inprogress.png)\n\nOnce the initial backup is completed, the Protection Status of the virtual machine in the **Protected Items** tab will show as *Protected*.\n\n![Virtual machine is backed up with recovery point](./media/backup-azure-vms/protect-backedupvm.png)\n\n\n### Viewing backup status and details\nOnce protected, the virtual machine count also increases in the **Dashboard** page summary. In addition, the **Dashboard** page shows the number of jobs from the last 24 hours that were successful, have failed, and are still in progress. Clicking on any one category will drill down into that category in the **Jobs** page.\n\n![Status of backup in Dashboard page](./media/backup-azure-vms/dashboard-protectedvms.png)\n\n\n## Consistency of recovery points\nWhen dealing with backup data, customers worry about the behavior of the VM after it has been restored. The typical questions that customers ask are:\n\n- Will the virtual machine boot up?\n- Will the data be available on the disk (or) is there any data loss?\n- Will the application be able to read the data (or) is the data corrupted?\n- Will the data make sense to the application (or) is the data self-consistent when read by the application?\n\nThe following table explains the types of consistency that are encountered during Azure VM backup and restore.\n\n| Consistency | VSS-based | Explanation and details |\n|-------------|-----------|---------|\n| Application consistency | Yes | This is the ideal place to be for Microsoft workloads as it ensures:<ol><li> That the VM *boots up*. <li>There is *no corruption*. <li>There is *no data loss*.<li> The data is consistent to the application that uses the data, by involving the application at the time of backup -  using VSS.</ol> The Volume Snapshot Service (VSS) ensures that data is written correctly to the storage. Most Microsoft workloads have VSS writers that do workload-specific actions related to data consistency. For example, Microsoft SQL Server has a VSS writer that ensures the writes to the transaction log file and the database are done correctly.<br><br> For Azure VM backup, getting an application consistent recovery point means that the backup extension was able to invoke the VSS workflow and complete *correctly* before the VM snapshot was taken. Naturally, this means that the VSS writers of all the applications in the Azure VM have been invoked as well.<br><br>Learn the [basics of VSS](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx) dive deep into the details of [how it works](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx). |\n| File system consistency | Yes - for Windows machines | There are two scenarios where the recovery point can be file-system consistent:<ul><li>Backup of Linux VMs in Azure, since Linux does not have an equivalent platform to VSS.<li>VSS failure during backup for Windows VMs in Azure.</li></ul> In both these cases, the best that can be done is to ensure that: <ol><li> The VM *boots up*. <li>There is *no corruption*.<li>There is *no data loss*.</ol> Applications need to implement their own \"fix-up\" mechanism on the restored data.|\n| Crash consistency | No | This situation is equivalent to a machine experiencing a \"crash\" (through either a soft or hard reset). This typically happens when the Azure virtual machine is shut down at the time of backup. For Azure virtual machine backup, getting a crash-consistent recovery point means that Azure Backup gives no guarantees around the consistency of the data on the storage medium - either from the perspective of the operating system or from the perspective of the application. Only data that already exists on the disk at the time of backup is what gets captured and backed up. <br/> <br/> While there are no guarantees, in most cases the OS will boot. This is typically followed by a disk checking procedure like chkdsk to fix any corruption errors. Any in-memory data or writes that have not been completely flushed to the disk will be lost. The application typically follows with its own verification mechanism in case data rollback needs to be done. For Azure VM backup, getting a crash consistent recovery point means that Azure Backup gives no guarantees around the consistency of the data on the storage - either from the OS perspective or the application's perspective. This typically happens when the Azure VM is shut down at the time of backup.<br><br>As an example, if the transaction log has entries that are not present in the database, then the database software does a rollback till the data is consistent. When dealing with data spread across multiple virtual disks (like spanned volumes), a crash-consistent recovery point provides no guarantees for the correctness of the data.|\n\n\n## Performance and resource utilization\nLike backup software that is deployed on-premises, backup of VMs in Azure also needs to be planned for capacity and resource utilization. The [Azure Storage limits](azure-subscription-service-limits.md#storage-limits) will define how VM deployments are structured to get maximum performance with minimum impact to running workloads. There are two main Azure Storage limits that impact backup performance:\n\n+ Max egress per storage account\n+ Total request rate per storage account\n\nWhen the backup data is copied out of the customer storage account, it counts towards the IOPS and Egress (storage throughput) metrics of the storage account. At the same time, the virtual machines are also running and consuming IOPS and throughput. The goal is to ensure that the total traffic - backup and virtual machine - does not exceed the storage account limits.\n\nBackup is greedy and tries to consume as many resources as it can, with the aim of completing backup as quickly as possible. However, all IO operations are limited by the *Target Throughput for Single Blob* which has a limit of *60MB per second*. In order to speed up the backup process, the backup of each disk of the VM is attempted *in parallel*. Thus if a VM has 4 disks, then Azure Backup will attempt to backup all 4 disks in parallel. Thus, the single most important factor that determines the backup traffic exiting from a customer storage account is the **number of disks** being backed up from the storage account.\n\nA secondary factor that impacts the performance is the **backup schedule**. If you configure all the VMs to backup at the same time, then the number of disks being backed up *in parallel* will increase - as Azure Backup will attempt to backup as many disks as possible. So one way to reduce the backup traffic from a storage account is to ensure that different VMs are backed up at different times of the day, with no overlap.\n\n### Capacity planning\nPutting all these factors together means that storage account usage needs to be planned properly. Download the [VM backup capacity planning excel sheet](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33) to see the impact of your disk and backup schedule choices.\n\n### Backup throughput\nFor each disk being backed up, Azure Backup reads the blocks on the disk and stores only the changed data (incremental backup). The table below shows average throughput values that can be expected from Azure Backup:\n\n| Backup operation | Best-case Throughput |\n| ---------------- | ---------- |\n| Initial backup | 160 Mbps |\n| Incremental backup (DR) | 640 Mbps <br><br> This throughput can drop significantly if there is a lot of dispersed churn on the disk that needs to be backed up |\n\nUsing this you can estimate the amount of time that it will take to backup a disk of a given size.\n\n### Total VM backup time\nWhile a majority of the time is spent in reading and copying data, there are other operations that contribute to the total time taken to backup a VM:\n\n1. Time taken to [install or update the backup extension](backup-azure-vms.md#offline-vms)\n2. Queue wait time : Since the service is processing backups from multiple customers, your backup operation might not start immediately. The average wait time for a VM is 15-30 minutes.\n\n\n## Troubleshooting errors\nGet an exhaustive list of workarounds to the errors that are faced during virtual machine backup: [Troubleshoot virtual machine backup](backup-azure-vms-troubleshoot.md)\n\n\n## Next steps\n\nTo learn more about getting started with Azure Backup, see:\n\n- [Restore virtual machines](backup-azure-restore-vms.md)\n- [Manage virtual machines](backup-azure-manage-vms.md)\n\ntest\n"
}