{
  "nodes": [
    {
      "content": "Configure a VNet-to-VNet connection | Microsoft Azure",
      "pos": [
        26,
        79
      ]
    },
    {
      "content": "How to connect Azure virtual networks together in the same or different subscriptions or regions.",
      "pos": [
        97,
        194
      ]
    },
    {
      "content": "Configure a VNet-to-VNet connection in the Azure Portal",
      "pos": [
        500,
        555
      ]
    },
    {
      "content": "[AZURE.SELECTOR]",
      "pos": [
        559,
        575
      ]
    },
    {
      "content": "Azure Portal",
      "pos": [
        579,
        591
      ]
    },
    {
      "content": "PowerShell - Azure Resource Manager",
      "pos": [
        651,
        686
      ]
    },
    {
      "content": "This article will walk you through connecting virtual networks together in the classic deployment mode by using a combination of the Azure Portal and PowerShell.",
      "pos": [
        721,
        882
      ]
    },
    {
      "content": "Connecting a virtual network to another virtual network (VNet-to-Vnet) is very similar to connecting a virtual network to an on-premises site location.",
      "pos": [
        886,
        1037
      ]
    },
    {
      "content": "Both connectivity types use a VPN gateway to provide a secure tunnel using IPsec/IKE.",
      "pos": [
        1038,
        1123
      ]
    },
    {
      "content": "The VNets you connect can be in different subscriptions and different regions.",
      "pos": [
        1124,
        1202
      ]
    },
    {
      "content": "You can even combine VNet to VNet communication with multi-site configurations.",
      "pos": [
        1203,
        1282
      ]
    },
    {
      "content": "This lets you establish network topologies that combine cross-premises connectivity with inter-virtual network connectivity, as shown in the diagram below:",
      "pos": [
        1283,
        1438
      ]
    },
    {
      "content": "VNet to VNet Connectivity Diagram",
      "pos": [
        1442,
        1475
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> Azure currently has two deployment modes: the classic deployment mode, and the Azure Resource Manager deployment mode.",
      "pos": [
        1553,
        1684
      ]
    },
    {
      "content": "The configuration cmdlets and steps differ between deployment modes.",
      "pos": [
        1685,
        1753
      ]
    },
    {
      "content": "This topic will walk you through connecting virtual networks that are created using the classic deployment mode.",
      "pos": [
        1754,
        1866
      ]
    },
    {
      "content": "If you want to connect virtual networks together that were created in Azure Resource Manager mode, see <bpt id=\"p1\">[</bpt>Configure a VNet-to-VNet connection using Azure Resource Manager and PowerShell<ept id=\"p1\">](vpn-gateway-vnet-vnet-rm-ps.md)</ept>.",
      "pos": [
        1867,
        2084
      ]
    },
    {
      "content": "If you want to connect a virtual network that was created in the classic mode to a virtual network created in Azure Resource Manager, see <bpt id=\"p1\">[</bpt>Connecting classic VNets to new VNets<ept id=\"p1\">](../virtual-network/virtual-networks-arm-asm-s2s.md)</ept>.",
      "pos": [
        2085,
        2315
      ]
    },
    {
      "content": "Why connect virtual networks?",
      "pos": [
        2320,
        2349
      ]
    },
    {
      "content": "You may want to connect virtual networks for the following reasons:",
      "pos": [
        2351,
        2418
      ]
    },
    {
      "content": "Cross region geo-redundancy and geo-presence",
      "pos": [
        2424,
        2468
      ]
    },
    {
      "content": "You can set up your own geo-replication or synchronization with secure connectivity without going over internet-facing endpoints.",
      "pos": [
        2477,
        2606
      ]
    },
    {
      "content": "With Azure Load Balancer and Microsoft or third-party clustering technology, you can setup highly available workload with geo-redundancy across multiple Azure regions.",
      "pos": [
        2613,
        2780
      ]
    },
    {
      "content": "One important example is to setup SQL Always On with Availability Groups spreading across multiple Azure regions.",
      "pos": [
        2781,
        2894
      ]
    },
    {
      "content": "Regional multi-tier applications with strong isolation boundary",
      "pos": [
        2900,
        2963
      ]
    },
    {
      "content": "Within the same region, you can setup multi-tier applications with multiple virtual networks connected together with strong isolation and secure inter-tier communication.",
      "pos": [
        2972,
        3142
      ]
    },
    {
      "content": "Cross subscription, inter-organization communication in Azure",
      "pos": [
        3148,
        3209
      ]
    },
    {
      "content": "If you have multiple Azure subscriptions, you can connect workloads from different subscriptions together securely between virtual networks.",
      "pos": [
        3218,
        3358
      ]
    },
    {
      "content": "For enterprises or service providers, you can enable cross organization communication with secure VPN technology within Azure.",
      "pos": [
        3365,
        3491
      ]
    },
    {
      "content": "VNet to VNet FAQ",
      "pos": [
        3496,
        3512
      ]
    },
    {
      "content": "The virtual networks can be in the same or different subscriptions.",
      "pos": [
        3516,
        3583
      ]
    },
    {
      "content": "The virtual networks can be in the same or different Azure regions (locations).",
      "pos": [
        3587,
        3666
      ]
    },
    {
      "content": "A cloud service or a load balancing endpoint CANNOT span across virtual networks, even if they are connected together.",
      "pos": [
        3670,
        3788
      ]
    },
    {
      "content": "Connecting multiple virtual networks together doesn't require any on-premises VPN gateways, unless cross-premises connectivity is required.",
      "pos": [
        3792,
        3931
      ]
    },
    {
      "content": "VNet-to-VNet supports connecting Azure Virtual Networks.",
      "pos": [
        3935,
        3991
      ]
    },
    {
      "content": "It does not support connecting virtual machines or cloud services NOT in a virtual network.",
      "pos": [
        3992,
        4083
      ]
    },
    {
      "content": "VNet-to-VNet requires Azure VPN gateways with dynamic routing VPNs.",
      "pos": [
        4087,
        4154
      ]
    },
    {
      "content": "Azure static routing VPN gateways are not supported.",
      "pos": [
        4155,
        4207
      ]
    },
    {
      "content": "Virtual network connectivity can be used simultaneously with multi-site VPNs, with a maximum of 10 VPN tunnels for a virtual network VPN gateway connecting to ether other virtual networks or on-premises sites.",
      "pos": [
        4211,
        4420
      ]
    },
    {
      "content": "The address spaces of the virtual networks and on-premises local network sites must not overlap.",
      "pos": [
        4424,
        4520
      ]
    },
    {
      "content": "Overlapping address spaces will cause the creation of virtual networks or uploading netcfg configuration files to fail.",
      "pos": [
        4521,
        4640
      ]
    },
    {
      "content": "Redundant tunnels between a pair of virtual networks are not supported.",
      "pos": [
        4644,
        4715
      ]
    },
    {
      "content": "All VPN tunnels of the virtual network, including P2S VPNs, share the available bandwidth on the Azure VPN gateway and the same VPN gateway uptime SLA in Azure.",
      "pos": [
        4719,
        4879
      ]
    },
    {
      "content": "VNet-to-VNet traffic travels across the Azure backbone.",
      "pos": [
        4883,
        4938
      ]
    },
    {
      "content": "Configure a VNet to VNet connection",
      "pos": [
        4943,
        4978
      ]
    },
    {
      "content": "In this procedure, we’ll walk you through connecting two virtual networks, VNet1 and VNet2.",
      "pos": [
        4980,
        5071
      ]
    },
    {
      "content": "You’ll need to be comfortable with networking in order to substitute the IP address ranges that are compatible with your network design requirements.",
      "pos": [
        5072,
        5221
      ]
    },
    {
      "content": "From an Azure virtual network, connecting to another Azure virtual network is the same as connecting to an on premises network via site-to-site (S2S) VPN.",
      "pos": [
        5222,
        5376
      ]
    },
    {
      "content": "This procedure primarily uses the Azure Portal, however, you must use Microsoft Azure PowerShell cmdlets to connect the VPN gateways.",
      "pos": [
        5378,
        5511
      ]
    },
    {
      "content": "Connecting VNet to VNet",
      "pos": [
        5515,
        5538
      ]
    },
    {
      "content": "There are 5 sections to plan and configure.",
      "pos": [
        5614,
        5657
      ]
    },
    {
      "content": "Configure each section in the order listed below:",
      "pos": [
        5658,
        5707
      ]
    },
    {
      "content": "Plan your IP address ranges",
      "pos": [
        5713,
        5740
      ]
    },
    {
      "content": "Create your virtual networks",
      "pos": [
        5776,
        5804
      ]
    },
    {
      "content": "Add local networks",
      "pos": [
        5841,
        5859
      ]
    },
    {
      "content": "Create the dynamic routing gateways for each VNet",
      "pos": [
        5886,
        5935
      ]
    },
    {
      "content": "Connect the VPN gateways",
      "pos": [
        5993,
        6017
      ]
    },
    {
      "content": "Plan your IP address ranges",
      "pos": [
        6051,
        6078
      ]
    },
    {
      "content": "It’s important to decide the ranges that you’ll use to configure your network configuration file (netcfg).",
      "pos": [
        6080,
        6186
      ]
    },
    {
      "content": "From the perspective of VNet1, VNet2 is just another VPN connection that’s defined in the Azure platform.",
      "pos": [
        6187,
        6292
      ]
    },
    {
      "content": "And from VNet2, VNet1 is just another VPN connection.",
      "pos": [
        6293,
        6346
      ]
    },
    {
      "content": "They’ll both be identifying each other as a local network site.",
      "pos": [
        6347,
        6410
      ]
    },
    {
      "content": "Keep in mind that you must make sure that none of your VNet ranges or local network ranges overlap in any way.",
      "pos": [
        6411,
        6521
      ]
    },
    {
      "content": "Table 1 shows an example of how to define your VNets.",
      "pos": [
        6523,
        6576
      ]
    },
    {
      "content": "Use the ranges below as a guideline only.",
      "pos": [
        6577,
        6618
      ]
    },
    {
      "content": "Write down the ranges that you’ll be using for your virtual networks.",
      "pos": [
        6619,
        6688
      ]
    },
    {
      "content": "You’ll need this information for later steps.",
      "pos": [
        6689,
        6734
      ]
    },
    {
      "content": "Table 1",
      "pos": [
        6738,
        6745
      ]
    },
    {
      "content": "Virtual Network",
      "pos": [
        6750,
        6765
      ]
    },
    {
      "content": "Virtual Network Site Definition",
      "pos": [
        6768,
        6799
      ]
    },
    {
      "content": "Local Network Site Definition",
      "pos": [
        6801,
        6830
      ]
    },
    {
      "content": "VNet1",
      "pos": [
        6916,
        6921
      ]
    },
    {
      "content": "VNet1 (10.1.0.0/16)",
      "pos": [
        6934,
        6953
      ]
    },
    {
      "content": "VNet2 (10.2.0.0/16)",
      "pos": [
        6967,
        6986
      ]
    },
    {
      "content": "VNet2",
      "pos": [
        6999,
        7004
      ]
    },
    {
      "content": "VNet2 (10.2.0.0/16)",
      "pos": [
        7017,
        7036
      ]
    },
    {
      "content": "VNet1 (10.1.0.0/16)",
      "pos": [
        7050,
        7069
      ]
    },
    {
      "content": "Create your virtual networks",
      "pos": [
        7085,
        7113
      ]
    },
    {
      "content": "For the purposes of this tutorial, we’ll create two virtual networks, VNet1 and VNet2.",
      "pos": [
        7115,
        7201
      ]
    },
    {
      "content": "Substitute your own values when creating your VNets.",
      "pos": [
        7202,
        7254
      ]
    },
    {
      "content": "For the purposes of this tutorial, we’ll use the following values for the VNets:",
      "pos": [
        7255,
        7335
      ]
    },
    {
      "content": "VNet1: Address Space = 10.1.0.0/16; Region=US West",
      "pos": [
        7337,
        7387
      ]
    },
    {
      "content": "VNet2: Address Space = 10.2.0.0/16; Region=Japan East",
      "pos": [
        7389,
        7442
      ]
    },
    {
      "pos": [
        7447,
        7483
      ],
      "content": "Log in to the <bpt id=\"p1\">**</bpt>Management Portal.<ept id=\"p1\">**</ept>"
    },
    {
      "content": "In the lower left-hand corner of the screen, click <bpt id=\"p1\">**</bpt>New<ept id=\"p1\">**</ept>.",
      "pos": [
        7488,
        7547
      ]
    },
    {
      "content": "In the navigation pane, click <bpt id=\"p1\">**</bpt>Network Services<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Virtual Network<ept id=\"p2\">**</ept>.",
      "pos": [
        7548,
        7635
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Custom Create<ept id=\"p1\">**</ept> to begin the configuration wizard.",
      "pos": [
        7636,
        7694
      ]
    },
    {
      "pos": [
        7696,
        7765
      ],
      "content": "<bpt id=\"p1\">**</bpt>On the Virtual Network Details page<ept id=\"p1\">**</ept>, enter the information below."
    },
    {
      "content": "Virtual Network Details",
      "pos": [
        7771,
        7794
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Name<ept id=\"p1\">**</ept> - Name your virtual network.",
      "pos": [
        7874,
        7911
      ]
    },
    {
      "content": "For example, VNet1.",
      "pos": [
        7912,
        7931
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Location<ept id=\"p1\">**</ept> – When you create a virtual network, you associate it with an Azure location (region).",
      "pos": [
        7936,
        8035
      ]
    },
    {
      "content": "For example, if you want your VMs that are deployed to your virtual network to be physically located in West US, select that location.",
      "pos": [
        8036,
        8170
      ]
    },
    {
      "content": "You can’t change the location associated with your virtual network after you create it.",
      "pos": [
        8171,
        8258
      ]
    },
    {
      "pos": [
        8262,
        8394
      ],
      "content": "<bpt id=\"p1\">**</bpt>On the DNS Servers and VPN Connectivity page<ept id=\"p1\">**</ept>, enter the following information, and then click the next arrow on the lower right."
    },
    {
      "content": "DNS Servers and VPN Connectivity",
      "pos": [
        8400,
        8432
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>DNS Servers<ept id=\"p1\">**</ept> - Enter the DNS server name and IP address, or select a previously registered DNS server from the dropdown.",
      "pos": [
        8513,
        8636
      ]
    },
    {
      "content": "This setting does not create a DNS server, it allows you to specify the DNS servers that you want to use for name resolution for this virtual network.",
      "pos": [
        8637,
        8787
      ]
    },
    {
      "content": "If you want to have name resolution between your virtual networks, you’ll have to configure your own DNS server, rather than using the name resolution that is provided by Azure.",
      "pos": [
        8788,
        8965
      ]
    },
    {
      "content": "Don’t select any of the checkboxes.",
      "pos": [
        8971,
        9006
      ]
    },
    {
      "content": "Just click the arrow on the lower right to move to the next screen.",
      "pos": [
        9007,
        9074
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>On the Virtual Network Address Spaces page<ept id=\"p1\">**</ept>, specify the address range that you want to use for your virtual network.",
      "pos": [
        9076,
        9196
      ]
    },
    {
      "content": "These are the dynamic IP addresses (DIPS) that will be assigned to the VMs and other role instances that you deploy to this virtual network.",
      "pos": [
        9197,
        9337
      ]
    },
    {
      "content": "It’s especially important to select a range that does not overlap with any of the ranges that are used for your on-premises network.",
      "pos": [
        9338,
        9470
      ]
    },
    {
      "content": "You’ll need to coordinate with your network administrator, who may need to carve out a range of IP addresses from your on-premises network address space for you to use for your virtual network.",
      "pos": [
        9471,
        9664
      ]
    },
    {
      "content": "Virtual Network Address Spaces page",
      "pos": [
        9671,
        9706
      ]
    },
    {
      "pos": [
        9784,
        9895
      ],
      "content": "<bpt id=\"p1\">**</bpt>Enter the following information<ept id=\"p1\">**</ept>, and then click the checkmark on the lower right to configure your network."
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Address Space<ept id=\"p1\">**</ept> - including Starting IP and Address Count.",
      "pos": [
        9901,
        9961
      ]
    },
    {
      "content": "Verify that the address spaces you specify don’t overlap any of the address spaces that you have on your on-premises network.",
      "pos": [
        9962,
        10087
      ]
    },
    {
      "content": "For this example, we’ll use 10.1.0.0/16 for VNet1.",
      "pos": [
        10088,
        10138
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Add subnet<ept id=\"p1\">**</ept> - including Starting IP and Address Count.",
      "pos": [
        10143,
        10200
      ]
    },
    {
      "content": "Additional subnets are not required, but you may want to create a separate subnet for VMs that will have static DIPS.",
      "pos": [
        10201,
        10318
      ]
    },
    {
      "content": "Or you might want to have your VMs in a subnet that is separate from your other role instances.",
      "pos": [
        10319,
        10414
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Click the checkmark<ept id=\"p1\">**</ept> on the lower right of the page and your virtual network will begin to create.",
      "pos": [
        10416,
        10517
      ]
    },
    {
      "content": "When it completes, you will see <bpt id=\"p1\">*</bpt>Created<ept id=\"p1\">*</ept> listed under <bpt id=\"p2\">*</bpt>Status<ept id=\"p2\">*</ept> on the <bpt id=\"p3\">*</bpt>Networks<ept id=\"p3\">*</ept> page in the Azure Portal.",
      "pos": [
        10518,
        10625
      ]
    },
    {
      "content": "Create another virtual network",
      "pos": [
        10630,
        10660
      ]
    },
    {
      "content": "Next, repeat the preceding steps to create another virtual network.",
      "pos": [
        10662,
        10729
      ]
    },
    {
      "content": "In this exercise, you'll later connect these two virtual networks.",
      "pos": [
        10730,
        10796
      ]
    },
    {
      "content": "Note that it's very important not to have duplicate or overlapping address spaces.",
      "pos": [
        10797,
        10879
      ]
    },
    {
      "content": "For the purposes of this tutorial, use these values:",
      "pos": [
        10880,
        10932
      ]
    },
    {
      "content": "VNet2",
      "pos": [
        10939,
        10944
      ]
    },
    {
      "pos": [
        10949,
        10980
      ],
      "content": "<bpt id=\"p1\">**</bpt>Address Space<ept id=\"p1\">**</ept> = 10.2.0.0/16"
    },
    {
      "pos": [
        10983,
        11006
      ],
      "content": "<bpt id=\"p1\">**</bpt>Region<ept id=\"p1\">**</ept> = Japan East"
    },
    {
      "content": "Add local networks",
      "pos": [
        11011,
        11029
      ]
    },
    {
      "content": "When you create a VNet-to-VNet configuration, you need to configure each VNet to identify each other as a local network site.",
      "pos": [
        11031,
        11156
      ]
    },
    {
      "content": "In this procedure, you’ll configure each VNet as a local network.",
      "pos": [
        11157,
        11222
      ]
    },
    {
      "content": "If you already have previously configured VNets, this is how you would add them as local networks in the Azure Portal.",
      "pos": [
        11223,
        11341
      ]
    },
    {
      "content": "In the lower left-hand corner of the screen, click <bpt id=\"p1\">**</bpt>New<ept id=\"p1\">**</ept>.",
      "pos": [
        11346,
        11405
      ]
    },
    {
      "content": "In the navigation pane, click <bpt id=\"p1\">**</bpt>Network Services<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Virtual Network<ept id=\"p2\">**</ept>.",
      "pos": [
        11406,
        11493
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Add Local Network<ept id=\"p1\">**</ept>",
      "pos": [
        11494,
        11521
      ]
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Specify your local network details<ept id=\"p1\">**</ept> page, for <bpt id=\"p2\">**</bpt>Name<ept id=\"p2\">**</ept>, enter the name of a virtual network that you want to use in your VNet-to-VNet configuration.",
      "pos": [
        11526,
        11684
      ]
    },
    {
      "content": "For this example, we’ll use VNet 1, as we’ll be pointing VNet2 to this virtual network for our configuration.",
      "pos": [
        11685,
        11794
      ]
    },
    {
      "content": "For VPN Device IP Address, use any IP address.",
      "pos": [
        11798,
        11844
      ]
    },
    {
      "content": "Typically, you’d use the actual external IP address for a VPN device.",
      "pos": [
        11845,
        11914
      ]
    },
    {
      "content": "For VNet-to-VNet configurations, you will use the Gateway IP address.",
      "pos": [
        11915,
        11984
      ]
    },
    {
      "content": "But, given that you’ve not created the gateway yet, we use the IP address that you specify here as a placeholder.",
      "pos": [
        11985,
        12098
      ]
    },
    {
      "content": "You will then go back into these settings and configure them with the corresponding gateway IP addresses once Azure generates it.",
      "pos": [
        12099,
        12228
      ]
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Specify the address page<ept id=\"p1\">**</ept>, you will put in the actual IP address range and address count for VNet1.",
      "pos": [
        12233,
        12342
      ]
    },
    {
      "content": "This must correspond exactly to the range that you specified earlier for VNet1.",
      "pos": [
        12343,
        12422
      ]
    },
    {
      "content": "After configuring VNet1 as a local network, go back and configure VNet2 using the values that correspond to that VNet.",
      "pos": [
        12427,
        12545
      ]
    },
    {
      "content": "Now you’ll point each VNet to the other as a local network.",
      "pos": [
        12550,
        12609
      ]
    },
    {
      "content": "In the Management Portal, go to the <bpt id=\"p1\">**</bpt>Configure<ept id=\"p1\">**</ept> page for VNet1.",
      "pos": [
        12610,
        12675
      ]
    },
    {
      "content": "Under <bpt id=\"p1\">**</bpt>site-to-site connectivity<ept id=\"p1\">**</ept>, select <bpt id=\"p2\">**</bpt>Connect to the local network<ept id=\"p2\">**</ept>, then select <bpt id=\"p3\">**</bpt>VNET2<ept id=\"p3\">**</ept> as the local network.",
      "pos": [
        12676,
        12797
      ]
    },
    {
      "content": "Connect to local network",
      "pos": [
        12803,
        12827
      ]
    },
    {
      "pos": [
        12908,
        13088
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>virtual network address spaces<ept id=\"p1\">**</ept> section on the same page, click <bpt id=\"p2\">**</bpt>add gateway subnet<ept id=\"p2\">**</ept>, then click the <bpt id=\"p3\">**</bpt>save<ept id=\"p3\">**</ept> icon at the bottom of the page to save your configuration."
    },
    {
      "content": "Repeat the step for VNet2 to specify VNet1 as a local network.",
      "pos": [
        13093,
        13155
      ]
    },
    {
      "content": "Create the dynamic routing gateways for each VNet",
      "pos": [
        13160,
        13209
      ]
    },
    {
      "content": "Now that you have each VNet configured, you’ll configure your VNet gateways.",
      "pos": [
        13211,
        13287
      ]
    },
    {
      "pos": [
        13292,
        13388
      ],
      "content": "On the <bpt id=\"p1\">**</bpt>Networks<ept id=\"p1\">**</ept> page, verify that the status column for your virtual network is <bpt id=\"p2\">**</bpt>Created<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        13393,
        13456
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Name<ept id=\"p1\">**</ept> column, click the name of your virtual network."
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Dashboard<ept id=\"p1\">**</ept> page, notice that this VNet doesn’t have a gateway configured yet.",
      "pos": [
        13461,
        13548
      ]
    },
    {
      "content": "You’ll see this status change as you go through the steps to configure your gateway.",
      "pos": [
        13549,
        13633
      ]
    },
    {
      "pos": [
        13638,
        13690
      ],
      "content": "At the bottom of the page, click <bpt id=\"p1\">**</bpt>Create Gateway<ept id=\"p1\">**</ept>."
    },
    {
      "content": "You must select <bpt id=\"p1\">**</bpt>Dynamic Routing<ept id=\"p1\">**</ept>.",
      "pos": [
        13694,
        13730
      ]
    },
    {
      "content": "When the system prompts you to confirm that you want the gateway created, click Yes.",
      "pos": [
        13731,
        13815
      ]
    },
    {
      "content": "Gateway type",
      "pos": [
        13821,
        13833
      ]
    },
    {
      "content": "When your gateway is creating, notice the gateway graphic on the page changes to yellow and says Creating Gateway.",
      "pos": [
        13914,
        14028
      ]
    },
    {
      "content": "It typically takes about 15 minutes for the gateway to create.",
      "pos": [
        14029,
        14091
      ]
    },
    {
      "content": "Repeat the same steps for your other VNet, being sure to select <bpt id=\"p1\">**</bpt>Dynamic Gateway<ept id=\"p1\">**</ept>.",
      "pos": [
        14096,
        14180
      ]
    },
    {
      "content": "You don’t need the first VNet gateway to complete before you begin to create the gateway for your other VNet.",
      "pos": [
        14181,
        14290
      ]
    },
    {
      "content": "When the gateway status changes to Connecting, the IP address for each gateway will be visible in the Dashboard.",
      "pos": [
        14295,
        14407
      ]
    },
    {
      "content": "Write down the IP address that corresponds to each VNet, taking care not to mix them up.",
      "pos": [
        14408,
        14496
      ]
    },
    {
      "content": "These are the IP addresses that will be used when you edit your placeholder IP addresses for the VPN Device in <bpt id=\"p1\">**</bpt>Local Networks<ept id=\"p1\">**</ept>.",
      "pos": [
        14497,
        14627
      ]
    },
    {
      "content": "Edit the local network",
      "pos": [
        14632,
        14654
      ]
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Local Networks<ept id=\"p1\">**</ept> page, click the name of the Local Network name that you want to edit, then click <bpt id=\"p2\">**</bpt>Edit<ept id=\"p2\">**</ept> at the bottom of the page.",
      "pos": [
        14659,
        14801
      ]
    },
    {
      "content": "For <bpt id=\"p1\">**</bpt>VPN Device IP address<ept id=\"p1\">**</ept>, input the IP address of the gateway that corresponds to the VNet.",
      "pos": [
        14802,
        14898
      ]
    },
    {
      "content": "For example, for VNet1, put in the gateway IP address assigned to VNet1.",
      "pos": [
        14899,
        14971
      ]
    },
    {
      "content": "Then click the arrow at the bottom of the page.",
      "pos": [
        14972,
        15019
      ]
    },
    {
      "pos": [
        15024,
        15133
      ],
      "content": "On the <bpt id=\"p1\">**</bpt>Specify the address space<ept id=\"p1\">**</ept> page, click the checkmark on the lower right without making any changes."
    },
    {
      "content": "Connect the VPN gateways",
      "pos": [
        15138,
        15162
      ]
    },
    {
      "content": "When all of the previous steps have been completed, you’ll set the IPsec/IKE pre-shared keys to be the same.",
      "pos": [
        15164,
        15272
      ]
    },
    {
      "content": "You can do this either using a REST API, or PowerShell cmdlet.",
      "pos": [
        15273,
        15335
      ]
    },
    {
      "content": "If you use PowerShell, verify that you have the latest version of the Microsoft Azure PowerShell cmdlets.",
      "pos": [
        15336,
        15441
      ]
    },
    {
      "content": "The examples below use PowerShell cmdlets to set the key value to A1b2C3D4.",
      "pos": [
        15442,
        15517
      ]
    },
    {
      "content": "Note that both use the same key value.",
      "pos": [
        15518,
        15556
      ]
    },
    {
      "content": "Edit the examples below to reflect your own values.",
      "pos": [
        15557,
        15608
      ]
    },
    {
      "content": "For VNet1",
      "pos": [
        15610,
        15619
      ]
    },
    {
      "content": "For VNet2",
      "pos": [
        15722,
        15731
      ]
    },
    {
      "content": "Wait for the connections to initialize.",
      "pos": [
        15834,
        15873
      ]
    },
    {
      "content": "Once the gateway has initialized, the gateway will look like the graphic below and your virtual networks are connected.",
      "pos": [
        15874,
        15993
      ]
    },
    {
      "content": "Gateway Status - Connected",
      "pos": [
        15997,
        16023
      ]
    },
    {
      "content": "Next Steps",
      "pos": [
        16104,
        16114
      ]
    },
    {
      "pos": [
        16117,
        16278
      ],
      "content": "If you want to add virtual machines to your virtual network, see <bpt id=\"p1\">[</bpt>How to Create a Custom Virtual Machine<ept id=\"p1\">](../virtual-machines/virtual-machines-create-custom.md)</ept>."
    },
    {
      "pos": [
        16280,
        16487
      ],
      "content": "If you want to configure a VNet connection using RRAS, see <bpt id=\"p1\">[</bpt>Configure a Site-to-Site VPN using Windows Server 2012 Routing and Remote Access Service (RRAS)<ept id=\"p1\">](https://msdn.microsoft.com/library/dn636917.aspx)</ept>."
    },
    {
      "pos": [
        16489,
        16642
      ],
      "content": "For information about the configuration schema, see <bpt id=\"p1\">[</bpt>Azure Virtual Network Configuration Schema<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/jj157100.aspx)</ept>."
    }
  ],
  "content": "<properties\n   pageTitle=\"Configure a VNet-to-VNet connection | Microsoft Azure\"\n   description=\"How to connect Azure virtual networks together in the same or different subscriptions or regions.\"\n   services=\"vpn-gateway\"\n   documentationCenter=\"na\"\n   authors=\"cherylmc\"\n   manager=\"carolz\"\n   editor=\"\"/>\n\n<tags\n   ms.service=\"vpn-gateway\"\n   ms.devlang=\"na\"\n   ms.topic=\"article\"\n   ms.tgt_pltfrm=\"na\"\n   ms.workload=\"infrastructure-services\"\n   ms.date=\"08/20/2015\"\n   ms.author=\"cherylmc\"/>\n\n\n# Configure a VNet-to-VNet connection in the Azure Portal\n\n> [AZURE.SELECTOR]\n- [Azure Portal](virtual-networks-configure-vnet-to-vnet-connection.md)\n- [PowerShell - Azure Resource Manager](vpn-gateway-vnet-vnet-rm-ps.md)\n\nThis article will walk you through connecting virtual networks together in the classic deployment mode by using a combination of the Azure Portal and PowerShell. \n\n\nConnecting a virtual network to another virtual network (VNet-to-Vnet) is very similar to connecting a virtual network to an on-premises site location. Both connectivity types use a VPN gateway to provide a secure tunnel using IPsec/IKE. The VNets you connect can be in different subscriptions and different regions. You can even combine VNet to VNet communication with multi-site configurations. This lets you establish network topologies that combine cross-premises connectivity with inter-virtual network connectivity, as shown in the diagram below:\n\n![VNet to VNet Connectivity Diagram](./media/virtual-networks-configure-vnet-to-vnet-connection/IC727360.png)\n\n\n>[AZURE.NOTE] Azure currently has two deployment modes: the classic deployment mode, and the Azure Resource Manager deployment mode. The configuration cmdlets and steps differ between deployment modes. This topic will walk you through connecting virtual networks that are created using the classic deployment mode. If you want to connect virtual networks together that were created in Azure Resource Manager mode, see [Configure a VNet-to-VNet connection using Azure Resource Manager and PowerShell](vpn-gateway-vnet-vnet-rm-ps.md). If you want to connect a virtual network that was created in the classic mode to a virtual network created in Azure Resource Manager, see [Connecting classic VNets to new VNets](../virtual-network/virtual-networks-arm-asm-s2s.md).\n\n## Why connect virtual networks?\n\nYou may want to connect virtual networks for the following reasons:\n\n- **Cross region geo-redundancy and geo-presence**\n    - You can set up your own geo-replication or synchronization with secure connectivity without going over internet-facing endpoints.\n    - With Azure Load Balancer and Microsoft or third-party clustering technology, you can setup highly available workload with geo-redundancy across multiple Azure regions. One important example is to setup SQL Always On with Availability Groups spreading across multiple Azure regions.\n\n- **Regional multi-tier applications with strong isolation boundary**\n    - Within the same region, you can setup multi-tier applications with multiple virtual networks connected together with strong isolation and secure inter-tier communication.\n\n- **Cross subscription, inter-organization communication in Azure**\n    - If you have multiple Azure subscriptions, you can connect workloads from different subscriptions together securely between virtual networks.\n    - For enterprises or service providers, you can enable cross organization communication with secure VPN technology within Azure.\n\n## VNet to VNet FAQ\n\n- The virtual networks can be in the same or different subscriptions.\n\n- The virtual networks can be in the same or different Azure regions (locations).\n\n- A cloud service or a load balancing endpoint CANNOT span across virtual networks, even if they are connected together.\n\n- Connecting multiple virtual networks together doesn't require any on-premises VPN gateways, unless cross-premises connectivity is required.\n\n- VNet-to-VNet supports connecting Azure Virtual Networks. It does not support connecting virtual machines or cloud services NOT in a virtual network.\n\n- VNet-to-VNet requires Azure VPN gateways with dynamic routing VPNs. Azure static routing VPN gateways are not supported.\n\n- Virtual network connectivity can be used simultaneously with multi-site VPNs, with a maximum of 10 VPN tunnels for a virtual network VPN gateway connecting to ether other virtual networks or on-premises sites.\n\n- The address spaces of the virtual networks and on-premises local network sites must not overlap. Overlapping address spaces will cause the creation of virtual networks or uploading netcfg configuration files to fail.\n\n- Redundant tunnels between a pair of virtual networks are not supported.\n\n- All VPN tunnels of the virtual network, including P2S VPNs, share the available bandwidth on the Azure VPN gateway and the same VPN gateway uptime SLA in Azure.\n\n- VNet-to-VNet traffic travels across the Azure backbone.\n\n## Configure a VNet to VNet connection\n\nIn this procedure, we’ll walk you through connecting two virtual networks, VNet1 and VNet2. You’ll need to be comfortable with networking in order to substitute the IP address ranges that are compatible with your network design requirements. From an Azure virtual network, connecting to another Azure virtual network is the same as connecting to an on premises network via site-to-site (S2S) VPN.\n\nThis procedure primarily uses the Azure Portal, however, you must use Microsoft Azure PowerShell cmdlets to connect the VPN gateways.\n\n![Connecting VNet to VNet](./media/virtual-networks-configure-vnet-to-vnet-connection/IC727361.png)\n\nThere are 5 sections to plan and configure. Configure each section in the order listed below:\n\n1. [Plan your IP address ranges](#plan-your-ip-address-ranges)\n2. [Create your virtual networks](#create-your-virtual-networks)\n3. [Add local networks](#add-local-networks)\n4. [Create the dynamic routing gateways for each VNet](#create-the-dynamic-routing-gateways-for-each-vnet)\n5. [Connect the VPN gateways](#connect-the-vpn-gateways)\n\n\n## Plan your IP address ranges\n\nIt’s important to decide the ranges that you’ll use to configure your network configuration file (netcfg). From the perspective of VNet1, VNet2 is just another VPN connection that’s defined in the Azure platform. And from VNet2, VNet1 is just another VPN connection. They’ll both be identifying each other as a local network site. Keep in mind that you must make sure that none of your VNet ranges or local network ranges overlap in any way.\n\nTable 1 shows an example of how to define your VNets. Use the ranges below as a guideline only. Write down the ranges that you’ll be using for your virtual networks. You’ll need this information for later steps.\n\n**Table 1**\n\n|Virtual Network  |Virtual Network Site Definition |Local Network Site Definition|\n|:----------------|:-------------------------------|:----------------------------|\n|VNet1            |VNet1 (10.1.0.0/16)             |VNet2 (10.2.0.0/16)          |\n|VNet2            |VNet2 (10.2.0.0/16)             |VNet1 (10.1.0.0/16)          |\n\n## Create your virtual networks\n\nFor the purposes of this tutorial, we’ll create two virtual networks, VNet1 and VNet2. Substitute your own values when creating your VNets. For the purposes of this tutorial, we’ll use the following values for the VNets:\n\nVNet1: Address Space = 10.1.0.0/16; Region=US West\n\nVNet2: Address Space = 10.2.0.0/16; Region=Japan East\n\n1. Log in to the **Management Portal.**\n\n2. In the lower left-hand corner of the screen, click **New**. In the navigation pane, click **Network Services**, and then click **Virtual Network**. Click **Custom Create** to begin the configuration wizard.\n\n**On the Virtual Network Details page**, enter the information below.\n\n  ![Virtual Network Details](./media/virtual-networks-configure-vnet-to-vnet-connection/IC736055.png)\n\n  - **Name** - Name your virtual network. For example, VNet1.\n  - **Location** – When you create a virtual network, you associate it with an Azure location (region). For example, if you want your VMs that are deployed to your virtual network to be physically located in West US, select that location. You can’t change the location associated with your virtual network after you create it.\n\n\n\n**On the DNS Servers and VPN Connectivity page**, enter the following information, and then click the next arrow on the lower right.\n\n  ![DNS Servers and VPN Connectivity](./media/virtual-networks-configure-vnet-to-vnet-connection/IC736056.jpg)  \n\n\n- **DNS Servers** - Enter the DNS server name and IP address, or select a previously registered DNS server from the dropdown. This setting does not create a DNS server, it allows you to specify the DNS servers that you want to use for name resolution for this virtual network. If you want to have name resolution between your virtual networks, you’ll have to configure your own DNS server, rather than using the name resolution that is provided by Azure.\n\n  - Don’t select any of the checkboxes. Just click the arrow on the lower right to move to the next screen.\n\n**On the Virtual Network Address Spaces page**, specify the address range that you want to use for your virtual network. These are the dynamic IP addresses (DIPS) that will be assigned to the VMs and other role instances that you deploy to this virtual network. It’s especially important to select a range that does not overlap with any of the ranges that are used for your on-premises network. You’ll need to coordinate with your network administrator, who may need to carve out a range of IP addresses from your on-premises network address space for you to use for your virtual network.\n\n\n  ![Virtual Network Address Spaces page](./media/virtual-networks-configure-vnet-to-vnet-connection/IC736057.jpg)\n\n  **Enter the following information**, and then click the checkmark on the lower right to configure your network.\n\n  - **Address Space** - including Starting IP and Address Count. Verify that the address spaces you specify don’t overlap any of the address spaces that you have on your on-premises network. For this example, we’ll use 10.1.0.0/16 for VNet1.\n  - **Add subnet** - including Starting IP and Address Count. Additional subnets are not required, but you may want to create a separate subnet for VMs that will have static DIPS. Or you might want to have your VMs in a subnet that is separate from your other role instances.\n\n**Click the checkmark** on the lower right of the page and your virtual network will begin to create. When it completes, you will see *Created* listed under *Status* on the *Networks* page in the Azure Portal.\n\n## Create another virtual network\n\nNext, repeat the preceding steps to create another virtual network. In this exercise, you'll later connect these two virtual networks. Note that it's very important not to have duplicate or overlapping address spaces. For the purposes of this tutorial, use these values: \n\n- **VNet2**\n- **Address Space** = 10.2.0.0/16\n- **Region** = Japan East\n\n## Add local networks\n\nWhen you create a VNet-to-VNet configuration, you need to configure each VNet to identify each other as a local network site. In this procedure, you’ll configure each VNet as a local network. If you already have previously configured VNets, this is how you would add them as local networks in the Azure Portal.\n\n1. In the lower left-hand corner of the screen, click **New**. In the navigation pane, click **Network Services**, and then click **Virtual Network**. Click **Add Local Network**\n\n2. On the **Specify your local network details** page, for **Name**, enter the name of a virtual network that you want to use in your VNet-to-VNet configuration. For this example, we’ll use VNet 1, as we’ll be pointing VNet2 to this virtual network for our configuration.\n\n  For VPN Device IP Address, use any IP address. Typically, you’d use the actual external IP address for a VPN device. For VNet-to-VNet configurations, you will use the Gateway IP address. But, given that you’ve not created the gateway yet, we use the IP address that you specify here as a placeholder. You will then go back into these settings and configure them with the corresponding gateway IP addresses once Azure generates it.\n\n3. On the **Specify the address page**, you will put in the actual IP address range and address count for VNet1. This must correspond exactly to the range that you specified earlier for VNet1.\n\n4. After configuring VNet1 as a local network, go back and configure VNet2 using the values that correspond to that VNet.\n\n5. Now you’ll point each VNet to the other as a local network. In the Management Portal, go to the **Configure** page for VNet1. Under **site-to-site connectivity**, select **Connect to the local network**, then select **VNET2** as the local network.\n\n  ![Connect to local network](./media/virtual-networks-configure-vnet-to-vnet-connection/IC736058.jpg)  \n\n6. In the **virtual network address spaces** section on the same page, click **add gateway subnet**, then click the **save** icon at the bottom of the page to save your configuration.\n\n7. Repeat the step for VNet2 to specify VNet1 as a local network.\n\n## Create the dynamic routing gateways for each VNet\n\nNow that you have each VNet configured, you’ll configure your VNet gateways.\n\n1. On the **Networks** page, verify that the status column for your virtual network is **Created**.\n\n2. In the **Name** column, click the name of your virtual network.\n\n3. On the **Dashboard** page, notice that this VNet doesn’t have a gateway configured yet. You’ll see this status change as you go through the steps to configure your gateway.\n\n4. At the bottom of the page, click **Create Gateway**.\n\n  You must select **Dynamic Routing**. When the system prompts you to confirm that you want the gateway created, click Yes.\n\n  ![Gateway type](./media/virtual-networks-configure-vnet-to-vnet-connection/IC717026.png)  \n\n5. When your gateway is creating, notice the gateway graphic on the page changes to yellow and says Creating Gateway. It typically takes about 15 minutes for the gateway to create.\n\n6. Repeat the same steps for your other VNet, being sure to select **Dynamic Gateway**. You don’t need the first VNet gateway to complete before you begin to create the gateway for your other VNet.\n\n7. When the gateway status changes to Connecting, the IP address for each gateway will be visible in the Dashboard. Write down the IP address that corresponds to each VNet, taking care not to mix them up. These are the IP addresses that will be used when you edit your placeholder IP addresses for the VPN Device in **Local Networks**.\n\n## Edit the local network\n\n1. On the **Local Networks** page, click the name of the Local Network name that you want to edit, then click **Edit** at the bottom of the page. For **VPN Device IP address**, input the IP address of the gateway that corresponds to the VNet. For example, for VNet1, put in the gateway IP address assigned to VNet1. Then click the arrow at the bottom of the page.\n\n2. On the **Specify the address space** page, click the checkmark on the lower right without making any changes.\n\n## Connect the VPN gateways\n\nWhen all of the previous steps have been completed, you’ll set the IPsec/IKE pre-shared keys to be the same. You can do this either using a REST API, or PowerShell cmdlet. If you use PowerShell, verify that you have the latest version of the Microsoft Azure PowerShell cmdlets. The examples below use PowerShell cmdlets to set the key value to A1b2C3D4. Note that both use the same key value. Edit the examples below to reflect your own values.\n\nFor VNet1\n\n    PS C:\\> Set-AzureVNetGatewayKey -VNetName VNet1 -LocalNetworkSiteName VNet2 -SharedKey A1b2C3D4\n\nFor VNet2\n\n    PS C:\\> Set-AzureVNetGatewayKey -VNetName VNet2 -LocalNetworkSiteName VNet1 -SharedKey A1b2C3D4\n\nWait for the connections to initialize. Once the gateway has initialized, the gateway will look like the graphic below and your virtual networks are connected.\n\n![Gateway Status - Connected](./media/virtual-networks-configure-vnet-to-vnet-connection/IC736059.jpg)  \n\n## Next Steps\n\n\nIf you want to add virtual machines to your virtual network, see [How to Create a Custom Virtual Machine](../virtual-machines/virtual-machines-create-custom.md).\n\nIf you want to configure a VNet connection using RRAS, see [Configure a Site-to-Site VPN using Windows Server 2012 Routing and Remote Access Service (RRAS)](https://msdn.microsoft.com/library/dn636917.aspx).\n\nFor information about the configuration schema, see [Azure Virtual Network Configuration Schema](https://msdn.microsoft.com/library/azure/jj157100.aspx). \n\n\n[1]: ../hdinsight-hbase-geo-replication-configure-vnets.md\n[2]: http://channel9.msdn.com/Series/Getting-started-with-Windows-Azure-HDInsight-Service/Configure-the-VPN-connectivity-between-two-Azure-virtual-networks\n \n"
}