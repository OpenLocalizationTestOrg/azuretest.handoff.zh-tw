{
  "nodes": [
    {
      "content": "Elastic database Split-Merge tool tutorial | Microsoft Azure",
      "pos": [
        82,
        142
      ]
    },
    {
      "content": "Splitting and Merging with elastic database tools",
      "pos": [
        161,
        210
      ]
    },
    {
      "content": "Elastic database Split-Merge tool tutorial",
      "pos": [
        645,
        687
      ]
    },
    {
      "content": "Download the Split-Merge packages",
      "pos": [
        692,
        725
      ]
    },
    {
      "pos": [
        729,
        832
      ],
      "content": "Download the latest NuGet version from <bpt id=\"p1\">[</bpt>NuGet<ept id=\"p1\">](http://docs.nuget.org/docs/start-here/installing-nuget)</ept>."
    },
    {
      "content": "Open a command prompt and navigate to the directory where you downloaded nuget.exe.",
      "pos": [
        836,
        919
      ]
    },
    {
      "content": "Download the latest Split-Merge package into the current directory with the below command:",
      "pos": [
        923,
        1013
      ]
    },
    {
      "content": "The steps above download the Split-Merge files to the current directory.",
      "pos": [
        1093,
        1165
      ]
    },
    {
      "content": "The files are placed in a directory named <bpt id=\"p1\">**</bpt>Microsoft.Azure.SqlDatabase.ElasticScale.Service.SplitMerge.x.x.xxx.x<ept id=\"p1\">**</ept> where <bpt id=\"p2\">*</bpt>x.x.xxx.x<ept id=\"p2\">*</ept> reflects the version number.",
      "pos": [
        1166,
        1328
      ]
    },
    {
      "content": "Find the Split-Merge Service files in the <bpt id=\"p1\">**</bpt>content\\splitmerge\\service<ept id=\"p1\">**</ept> sub-directory, and the Split-Merge PowerShell scripts (and required client .dlls) in the <bpt id=\"p2\">**</bpt>content\\splitmerge\\powershell<ept id=\"p2\">**</ept> sub-directory.",
      "pos": [
        1329,
        1539
      ]
    },
    {
      "content": "Prerequisites",
      "pos": [
        1544,
        1557
      ]
    },
    {
      "content": "Create an Azure SQL DB database that will be used as the Split-Merge status database.",
      "pos": [
        1562,
        1647
      ]
    },
    {
      "content": "Go to the <bpt id=\"p1\">[</bpt>Azure portal<ept id=\"p1\">](https://ms.portal.azure.com)</ept>.",
      "pos": [
        1648,
        1702
      ]
    },
    {
      "content": "Create a new <bpt id=\"p1\">**</bpt>SQL Database<ept id=\"p1\">**</ept>.",
      "pos": [
        1703,
        1733
      ]
    },
    {
      "content": "Fill in the database name and create a new user and password.",
      "pos": [
        1734,
        1795
      ]
    },
    {
      "content": "Be sure to record the name and password for later use.",
      "pos": [
        1796,
        1850
      ]
    },
    {
      "content": "Ensure that your Azure SQL DB server allows Azure Services to connect to it.",
      "pos": [
        1855,
        1931
      ]
    },
    {
      "content": "In the portal, in the <bpt id=\"p1\">**</bpt>Firewall Settings<ept id=\"p1\">**</ept>, ensure that the <bpt id=\"p2\">**</bpt>Allow access to Azure Services<ept id=\"p2\">**</ept> setting is set to <bpt id=\"p3\">**</bpt>On<ept id=\"p3\">**</ept>.",
      "pos": [
        1932,
        2053
      ]
    },
    {
      "content": "Click the \"save\" icon.",
      "pos": [
        2054,
        2076
      ]
    },
    {
      "content": "![Allowed services][1]",
      "pos": [
        2082,
        2104
      ]
    },
    {
      "content": "Create an Azure Storage account that will be used for diagnostics output.",
      "pos": [
        2109,
        2182
      ]
    },
    {
      "content": "Go to the Azure preview portal.",
      "pos": [
        2183,
        2214
      ]
    },
    {
      "content": "In the left bar, click <bpt id=\"p1\">**</bpt>New<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>Data + Storage<ept id=\"p2\">**</ept>, then <bpt id=\"p3\">**</bpt>Storage<ept id=\"p3\">**</ept>.",
      "pos": [
        2215,
        2290
      ]
    },
    {
      "content": "Create an Azure Cloud Service that will contain your Split-Merge service.",
      "pos": [
        2295,
        2368
      ]
    },
    {
      "content": "Go to the Azure preview portal.",
      "pos": [
        2370,
        2401
      ]
    },
    {
      "content": "In the left bar, click <bpt id=\"p1\">**</bpt>New<ept id=\"p1\">**</ept>, then <bpt id=\"p2\">**</bpt>Compute<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Cloud Service<ept id=\"p3\">**</ept>, and <bpt id=\"p4\">**</bpt>Create<ept id=\"p4\">**</ept>.",
      "pos": [
        2402,
        2486
      ]
    },
    {
      "content": "Configuring your Split-Merge service",
      "pos": [
        2493,
        2529
      ]
    },
    {
      "content": "Split-Merge service configuration",
      "pos": [
        2535,
        2568
      ]
    },
    {
      "pos": [
        2573,
        2790
      ],
      "content": "In the folder where you downloaded the Split/Merge bits, create a copy of the <bpt id=\"p1\">**</bpt>ServiceConfiguration.Template.cscfg<ept id=\"p1\">**</ept> file that shipped alongside <bpt id=\"p2\">**</bpt>SplitMergeService.cspkg<ept id=\"p2\">**</ept> and call it <bpt id=\"p3\">**</bpt>ServiceConfiguration.cscfg<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Open ServiceConfiguration.cscfg in your favorite text editor.",
      "pos": [
        2795,
        2856
      ]
    },
    {
      "content": "We recommend using Visual Studio as it will validate inputs such as the format of certificate thumbprints.",
      "pos": [
        2857,
        2963
      ]
    },
    {
      "content": "Either create a new database or choose an existing database to serve as the status database for Split/Merge operations and retrieve the connection string of that database.",
      "pos": [
        2968,
        3139
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Important<ept id=\"p1\">**</ept> At this time, the status database must use the Latin  collation (SQL\\_Latin1\\_General\\_CP1\\_CI\\_AS).",
      "pos": [
        3146,
        3260
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Windows Collation Name (Transact-SQL)<ept id=\"p1\">](https://msdn.microsoft.com/library/ms188046.aspx)</ept>.",
      "pos": [
        3261,
        3377
      ]
    },
    {
      "content": "With Azure SQL DB, the connection string typically is of the form:",
      "pos": [
        3383,
        3449
      ]
    },
    {
      "pos": [
        3610,
        3762
      ],
      "content": "Enter this connection string in the cscfg file in both the <bpt id=\"p1\">**</bpt>SplitMergeWeb<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>SplitMergeWorker<ept id=\"p2\">**</ept> role sections in the ElasticScaleMetadata setting."
    },
    {
      "pos": [
        3770,
        3930
      ],
      "content": "For the <bpt id=\"p1\">**</bpt>SplitMergeWorker<ept id=\"p1\">**</ept> role, enter a valid connection string to Azure storage for the <bpt id=\"p2\">**</bpt>WorkerRoleSynchronizationStorageAccountConnectionString<ept id=\"p2\">**</ept> setting."
    },
    {
      "content": "Configuring security",
      "pos": [
        3944,
        3964
      ]
    },
    {
      "pos": [
        3965,
        4149
      ],
      "content": "For detailed instructions to configure the security of the service, refer to the <bpt id=\"p1\">[</bpt>Split-Merge security configuration<ept id=\"p1\">](sql-database-elastic-scale-split-merge-security-configuration.md)</ept>."
    },
    {
      "content": "For the purposes of  a simple test deployment suitable to complete this tutorial, a minimal set of configuration steps will be performed to get the service up and running.",
      "pos": [
        4151,
        4322
      ]
    },
    {
      "content": "These steps enable only the one machine/account executing them to communicate with the service.",
      "pos": [
        4323,
        4418
      ]
    },
    {
      "content": "Creating a self-signed certificate",
      "pos": [
        4424,
        4458
      ]
    },
    {
      "pos": [
        4460,
        4646
      ],
      "content": "Create a new directory and from this directory execute the following command using a <bpt id=\"p1\">[</bpt>Developer Command Prompt for Visual Studio<ept id=\"p1\">](http://msdn.microsoft.com/library/ms229859.aspx)</ept> window:"
    },
    {
      "content": "You are asked for a password to protect the private key.",
      "pos": [
        4852,
        4908
      ]
    },
    {
      "content": "Enter a strong password and confirm it.",
      "pos": [
        4909,
        4948
      ]
    },
    {
      "content": "You are then prompted for the password to be used once more after that.",
      "pos": [
        4949,
        5020
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept> at the end to import it to the Trusted Certification Authorities Root store.",
      "pos": [
        5021,
        5111
      ]
    },
    {
      "content": "Create a PFX file",
      "pos": [
        5117,
        5134
      ]
    },
    {
      "content": "Execute the following command from the same window where makecert was executed; use the same password that you used to create the certificate:",
      "pos": [
        5136,
        5278
      ]
    },
    {
      "content": "Import the client certificate into the personal store",
      "pos": [
        5360,
        5413
      ]
    },
    {
      "pos": [
        5417,
        5466
      ],
      "content": "In Windows Explorer, double-click <bpt id=\"p1\">**</bpt>MyCert.pfx<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        5470,
        5550
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Certificate Import Wizard<ept id=\"p1\">**</ept> select <bpt id=\"p2\">**</bpt>Current User<ept id=\"p2\">**</ept> and click <bpt id=\"p3\">**</bpt>Next<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        5554,
        5595
      ],
      "content": "Confirm the file path and click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        5599,
        5687
      ],
      "content": "Type the password, leave <bpt id=\"p1\">**</bpt>Include all extended properties<ept id=\"p1\">**</ept> checked and click <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        5691,
        5774
      ],
      "content": "Leave <bpt id=\"p1\">**</bpt>Automatically select the certificate store[…]<ept id=\"p1\">**</ept> checked and click <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        5778,
        5806
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Finish<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Upload the PFX file to the cloud service",
      "pos": [
        5812,
        5852
      ]
    },
    {
      "pos": [
        5854,
        5913
      ],
      "content": "Go to the <bpt id=\"p1\">[</bpt>Azure preview portal<ept id=\"p1\">](https://portal.azure.com)</ept>."
    },
    {
      "pos": [
        5918,
        5944
      ],
      "content": "Select <bpt id=\"p1\">**</bpt>Cloud Services<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Select the cloud service you created above for the Split/Merge service.",
      "pos": [
        5948,
        6019
      ]
    },
    {
      "pos": [
        6023,
        6062
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Certificates<ept id=\"p1\">**</ept> on the top menu."
    },
    {
      "pos": [
        6066,
        6101
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Upload<ept id=\"p1\">**</ept> in the bottom bar."
    },
    {
      "content": "Select the PFX file and enter the same password as above.",
      "pos": [
        6105,
        6162
      ]
    },
    {
      "content": "Once completed, copy the certificate thumbprint from the new entry in the list.",
      "pos": [
        6166,
        6245
      ]
    },
    {
      "content": "Update the service configuration file",
      "pos": [
        6251,
        6288
      ]
    },
    {
      "content": "Paste the certificate thumbprint copied above into the thumbprint/value attribute of these settings.",
      "pos": [
        6290,
        6390
      ]
    },
    {
      "content": "For the web role:",
      "pos": [
        6391,
        6408
      ]
    },
    {
      "content": "For the worker role:",
      "pos": [
        6576,
        6596
      ]
    },
    {
      "content": "Please note that for production deployments separate certificates should be used for the CA, for encryption, the Server certificate and client certificates.",
      "pos": [
        7054,
        7210
      ]
    },
    {
      "content": "For detailed instructions on this, see <bpt id=\"p1\">[</bpt>Security Configuration<ept id=\"p1\">](sql-database-elastic-scale-split-merge-security-configuration.md)</ept>.",
      "pos": [
        7211,
        7341
      ]
    },
    {
      "content": "Deploying your Split-Merge service",
      "pos": [
        7347,
        7381
      ]
    },
    {
      "pos": [
        7386,
        7444
      ],
      "content": "Go to the <bpt id=\"p1\">[</bpt>Azure portal<ept id=\"p1\">](https://manage.windowsazure.com)</ept>."
    },
    {
      "pos": [
        7448,
        7548
      ],
      "content": "Click the <bpt id=\"p1\">**</bpt>Cloud Services<ept id=\"p1\">**</ept> tab on the left, and select the cloud service that you created earlier."
    },
    {
      "pos": [
        7552,
        7572
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Dashboard<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        7576,
        7655
      ],
      "content": "Choose the staging environment, then click <bpt id=\"p1\">**</bpt>Upload a new staging deployment<ept id=\"p1\">**</ept>."
    },
    {
      "content": "![Staging][3]",
      "pos": [
        7661,
        7674
      ]
    },
    {
      "content": "In the dialog box, enter a deployment label.",
      "pos": [
        7679,
        7723
      ]
    },
    {
      "content": "For both 'Package' and 'Configuration', click 'From Local' and choose the <bpt id=\"p1\">**</bpt>SplitMergeService.cspkg<ept id=\"p1\">**</ept> file and your .cscfg file that you configured earlier.",
      "pos": [
        7724,
        7880
      ]
    },
    {
      "pos": [
        7884,
        7991
      ],
      "content": "Ensure that the checkbox labeled <bpt id=\"p1\">**</bpt>Deploy even if one or more roles contain a single instance<ept id=\"p1\">**</ept> is checked."
    },
    {
      "content": "Hit the tick button in the bottom right to begin the deployment.",
      "pos": [
        7995,
        8059
      ]
    },
    {
      "content": "Expect it to take a few minutes to complete.",
      "pos": [
        8060,
        8104
      ]
    },
    {
      "content": "![Upload][4]",
      "pos": [
        8106,
        8118
      ]
    },
    {
      "content": "Deployment troubleshooting",
      "pos": [
        8124,
        8150
      ]
    },
    {
      "content": "If your web role fails to come online, it is likely a problem with the security configuration.",
      "pos": [
        8152,
        8246
      ]
    },
    {
      "content": "Check that the SSL is configured as described above.",
      "pos": [
        8247,
        8299
      ]
    },
    {
      "content": "If your worker role fails to come online, but your web role succeeds, it is most likely a problem connecting to the status database that you created earlier.",
      "pos": [
        8301,
        8458
      ]
    },
    {
      "content": "Make sure that the connection string in your .cscfg is accurate.",
      "pos": [
        8462,
        8526
      ]
    },
    {
      "content": "Check that the server and database exist, and that the user id and password are correct.",
      "pos": [
        8529,
        8617
      ]
    },
    {
      "content": "For Azure SQL DB, the connection string should be of the form:",
      "pos": [
        8620,
        8682
      ]
    },
    {
      "pos": [
        8840,
        8901
      ],
      "content": "Ensure that the server name does not begin with <bpt id=\"p1\">**</bpt>https://<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Ensure that your Azure SQL DB server allows Azure Services to connect to it.",
      "pos": [
        8904,
        8980
      ]
    },
    {
      "content": "To do this, open https://manage.windowsazure.com, click “SQL Databases” on the left, click “Servers” at the top, and select your server.",
      "pos": [
        8981,
        9117
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Configure<ept id=\"p1\">**</ept> at the top and ensure that the <bpt id=\"p2\">**</bpt>Azure Services<ept id=\"p2\">**</ept> setting is set to “Yes”.",
      "pos": [
        9118,
        9212
      ]
    },
    {
      "content": "(See the Prerequisites section at the top of this article).",
      "pos": [
        9213,
        9272
      ]
    },
    {
      "content": "Testing your Split-Merge service deployment",
      "pos": [
        9277,
        9320
      ]
    },
    {
      "content": "Connecting with a web browser",
      "pos": [
        9326,
        9355
      ]
    },
    {
      "content": "Determine the web endpoint of your Split-Merge service.",
      "pos": [
        9357,
        9412
      ]
    },
    {
      "content": "You can find this in the Azure Management Portal by going to the <bpt id=\"p1\">**</bpt>Dashboard<ept id=\"p1\">**</ept> of your cloud service and looking under <bpt id=\"p2\">**</bpt>Site URL<ept id=\"p2\">**</ept> on the right side.",
      "pos": [
        9413,
        9563
      ]
    },
    {
      "content": "Replace <bpt id=\"p1\">**</bpt>http://<ept id=\"p1\">**</ept> with <bpt id=\"p2\">**</bpt>https://<ept id=\"p2\">**</ept> since the default security settings disable the HTTP endpoint.",
      "pos": [
        9564,
        9664
      ]
    },
    {
      "content": "Load the page for this URL into your browser.",
      "pos": [
        9665,
        9710
      ]
    },
    {
      "content": "Testing with PowerShell scripts",
      "pos": [
        9716,
        9747
      ]
    },
    {
      "content": "The deployment and your environment can be tested by running the included sample PowerShell scripts.",
      "pos": [
        9749,
        9849
      ]
    },
    {
      "content": "The script files included are:",
      "pos": [
        9851,
        9881
      ]
    },
    {
      "pos": [
        9886,
        10012
      ],
      "content": "<bpt id=\"p1\">**</bpt>SetupSampleSplitMergeEnvironment.ps1<ept id=\"p1\">**</ept> - sets up a test data tier for Split/Merge (see table below for detailed description)"
    },
    {
      "pos": [
        10016,
        10139
      ],
      "content": "<bpt id=\"p1\">**</bpt>ExecuteSampleSplitMerge.ps1<ept id=\"p1\">**</ept> - executes test operations on the test data tier (see table below for detailed description)"
    },
    {
      "pos": [
        10143,
        10245
      ],
      "content": "<bpt id=\"p1\">**</bpt>GetMappings.ps1<ept id=\"p1\">**</ept> – top-level sample script that prints out the current state of the shard mappings."
    },
    {
      "pos": [
        10249,
        10325
      ],
      "content": "<bpt id=\"p1\">**</bpt>ShardManagement.psm1<ept id=\"p1\">**</ept>  – helper script that wraps the ShardManagement API"
    },
    {
      "pos": [
        10329,
        10412
      ],
      "content": "<bpt id=\"p1\">**</bpt>SqlDatabaseHelpers.psm1<ept id=\"p1\">**</ept> – helper script for creating and managing SQL databases"
    },
    {
      "content": "PowerShell file",
      "pos": [
        10456,
        10471
      ]
    },
    {
      "content": "Steps",
      "pos": [
        10485,
        10490
      ]
    },
    {
      "content": "SetupSampleSplitMergeEnvironment.ps1",
      "pos": [
        10531,
        10567
      ]
    },
    {
      "content": "Creates a shard map manager database",
      "pos": [
        10587,
        10623
      ]
    },
    {
      "content": "Creates 2 shard databases.",
      "pos": [
        10658,
        10684
      ]
    },
    {
      "content": "Creates a shard map for those database (deletes any existing shard maps on those databases).",
      "pos": [
        10714,
        10806
      ]
    },
    {
      "content": "Creates a small sample table in both the shards, and populates the table in one of the shards.",
      "pos": [
        10842,
        10936
      ]
    },
    {
      "content": "Declares the SchemaInfo for the sharded table.",
      "pos": [
        10971,
        11017
      ]
    },
    {
      "content": "PowerShell file",
      "pos": [
        11084,
        11099
      ]
    },
    {
      "content": "Steps",
      "pos": [
        11113,
        11118
      ]
    },
    {
      "content": "ExecuteSampleSplitMerge.ps1",
      "pos": [
        11157,
        11184
      ]
    },
    {
      "content": "Sends a split request to the Split-Merge Service web frontend, which splits half the data from the first shard to the second shard.",
      "pos": [
        11205,
        11336
      ]
    },
    {
      "content": "Polls the web frontend for the split request status and waits until the request completes.",
      "pos": [
        11371,
        11461
      ]
    },
    {
      "content": "Sends a merge request to the Split-Merge Service web frontend, which moves the data from the second shard back to the first shard.",
      "pos": [
        11496,
        11626
      ]
    },
    {
      "content": "Polls the web frontend for the merge request status and waits until the request completes.",
      "pos": [
        11661,
        11751
      ]
    },
    {
      "content": "Using PowerShell to verify your deployment",
      "pos": [
        11777,
        11819
      ]
    },
    {
      "content": "Open a new PowerShell window and navigate to the directory where you downloaded the Split-Merge package, and then navigate into the “powershell” directory.",
      "pos": [
        11827,
        11982
      ]
    },
    {
      "content": "Create an Azure SQL database server (or choose an existing server) where the shard map manager and shards will be created.",
      "pos": [
        11989,
        12111
      ]
    },
    {
      "content": "Execute the SetupSampleSplitMergeEnvironment.ps1 script to create the sample environment.",
      "pos": [
        12795,
        12884
      ]
    },
    {
      "content": "Execute the Getmappings.ps1 script to view the mappings that currently exist in the sample environment.",
      "pos": [
        13347,
        13450
      ]
    },
    {
      "pos": [
        13460,
        13628
      ],
      "content": ".\\GetMappings.ps1 `\n      -UserName 'mysqluser' `\n      -Password 'MySqlPassw0rd' `\n      -ShardMapManagerServerName 'abcdefghij.database.windows.net'",
      "leadings": [
        "",
        "      ",
        "      ",
        "      "
      ],
      "nodes": [
        {
          "content": ".\\GetMappings.ps1 <ph id=\"ph1\">`\n      -UserName 'mysqluser' `</ph>",
          "pos": [
            0,
            49
          ]
        },
        {
          "content": "-Password 'MySqlPassw0rd' `",
          "pos": [
            56,
            83
          ]
        },
        {
          "content": "-ShardMapManagerServerName 'abcdefghij.database.windows.net'",
          "pos": [
            90,
            150
          ]
        }
      ]
    },
    {
      "content": "Execute the ExecuteSampleSplitMerge.ps1 script to execute a split operation (moving half the data on the first shard to the second shard) and then a merge operation (moving the data back onto the first shard).",
      "pos": [
        13636,
        13845
      ]
    },
    {
      "content": "If you configured SSL and left the http endpoint disabled, ensure that you use the https:// endpoint instead.",
      "pos": [
        13846,
        13955
      ]
    },
    {
      "content": "Experiment with other data types!",
      "pos": [
        17943,
        17976
      ]
    },
    {
      "content": "All of these scripts take an optional -ShardKeyType parameter that allows you to specify the key type.",
      "pos": [
        17977,
        18079
      ]
    },
    {
      "content": "The default is Int32, but you can also specify Int64, Guid, or Binary.",
      "pos": [
        18080,
        18150
      ]
    },
    {
      "content": "Creating your own requests",
      "pos": [
        18155,
        18181
      ]
    },
    {
      "content": "The service can be used either by using the web UI or by importing and using the SplitMerge.psm1 PowerShell module which will submit your requests through the web role.",
      "pos": [
        18183,
        18351
      ]
    },
    {
      "content": "The Split-Merge service can move data in both sharded tables and reference tables.",
      "pos": [
        18353,
        18435
      ]
    },
    {
      "content": "A sharded table has a sharding key column and has different row data on each shard.",
      "pos": [
        18436,
        18519
      ]
    },
    {
      "content": "A reference table is not sharded so it contains the same row data on every shard.",
      "pos": [
        18520,
        18601
      ]
    },
    {
      "content": "Reference tables are useful for data that does not change often and is used to JOIN with sharded tables in queries.",
      "pos": [
        18602,
        18717
      ]
    },
    {
      "content": "In order to perform a split-merge operation, you must declare the sharded tables and reference tables that you want to have moved.",
      "pos": [
        18719,
        18849
      ]
    },
    {
      "content": "This is accomplished with the <bpt id=\"p1\">**</bpt>SchemaInfo<ept id=\"p1\">**</ept> API.",
      "pos": [
        18850,
        18899
      ]
    },
    {
      "content": "This API is in the <bpt id=\"p1\">**</bpt>Microsoft.Azure.SqlDatabase.ElasticScale.ShardManagement.Schema<ept id=\"p1\">**</ept> namespace.",
      "pos": [
        18900,
        18997
      ]
    },
    {
      "pos": [
        19005,
        19220
      ],
      "content": "For each sharded table, create a <bpt id=\"p1\">**</bpt>ShardedTableInfo<ept id=\"p1\">**</ept> object describing the table’s parent schema name (optional, defaults to “dbo”), the table name, and the column name in that table that contains the sharding key."
    },
    {
      "pos": [
        19227,
        19383
      ],
      "content": "For each reference table, create a <bpt id=\"p1\">**</bpt>ReferenceTableInfo<ept id=\"p1\">**</ept> object describing the table’s parent schema name (optional, defaults to “dbo”) and the table name."
    },
    {
      "pos": [
        19390,
        19453
      ],
      "content": "Add the above TableInfo objects to a new <bpt id=\"p1\">**</bpt>SchemaInfo<ept id=\"p1\">**</ept> object."
    },
    {
      "pos": [
        19460,
        19546
      ],
      "content": "Get a reference to a <bpt id=\"p1\">**</bpt>ShardMapManager<ept id=\"p1\">**</ept> object, and call <bpt id=\"p2\">**</bpt>GetSchemaInfoCollection<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        19553,
        19638
      ],
      "content": "Add the <bpt id=\"p1\">**</bpt>SchemaInfo<ept id=\"p1\">**</ept> to the <bpt id=\"p2\">**</bpt>SchemaInfoCollection<ept id=\"p2\">**</ept>, providing the shard map name."
    },
    {
      "content": "An example of this can be seen in the SetupSampleSplitMergeEnvironment.ps1 script.",
      "pos": [
        19640,
        19722
      ]
    },
    {
      "content": "Note that the Split-Merge service does not create the target database (or schema for any tables in the database) for you.",
      "pos": [
        19724,
        19845
      ]
    },
    {
      "content": "They must be pre-created before sending a request to the service.",
      "pos": [
        19846,
        19911
      ]
    },
    {
      "content": "Troubleshooting",
      "pos": [
        19917,
        19932
      ]
    },
    {
      "content": "You may see the below message when running the sample powershell scripts:",
      "pos": [
        19933,
        20006
      ]
    },
    {
      "content": "This error means that your SSL certificate is not configured correctly.",
      "pos": [
        20142,
        20213
      ]
    },
    {
      "content": "Please follow the instructions in section 'Connecting with a web browser'.",
      "pos": [
        20214,
        20288
      ]
    },
    {
      "content": "If you cannot submit requests you may see this:",
      "pos": [
        20290,
        20337
      ]
    },
    {
      "content": "[Exception] System.Data.SqlClient.SqlException (0x80131904): Could not find stored procedure 'dbo.InsertRequest'.",
      "pos": [
        20340,
        20453
      ]
    },
    {
      "content": "In this case, check your configuration file, in particular the setting for <bpt id=\"p1\">**</bpt>WorkerRoleSynchronizationStorageAccountConnectionString<ept id=\"p1\">**</ept>.",
      "pos": [
        20456,
        20591
      ]
    },
    {
      "content": "This error typically indicates that the worker role could not successfully initialize the metadata database on first use.",
      "pos": [
        20592,
        20713
      ]
    }
  ],
  "content": "<properties\n    title=\"Elastic database Split-Merge tool tutorial\"\n    pageTitle=\"Elastic database Split-Merge tool tutorial | Microsoft Azure\"\n    description=\"Splitting and Merging with elastic database tools\"\n    metaKeywords=\"elastic database tools, split and merge, Azure SQL Database sharding, elastic scale, splitting and merging elastic databases\"\n    services=\"sql-database\" documentationCenter=\"\"  \n    manager=\"jeffreyg\"\n    authors=\"sidneyh\"/>\n\n<tags\n    ms.service=\"sql-database\"\n    ms.workload=\"sql-database\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.date=\"08/14/2015\"\n    ms.author=\"sidneyh\" />\n\n# Elastic database Split-Merge tool tutorial\n\n## Download the Split-Merge packages\n1. Download the latest NuGet version from [NuGet](http://docs.nuget.org/docs/start-here/installing-nuget).\n2. Open a command prompt and navigate to the directory where you downloaded nuget.exe.\n3. Download the latest Split-Merge package into the current directory with the below command:\n`nuget install Microsoft.Azure.SqlDatabase.ElasticScale.Service.SplitMerge`  \n\nThe steps above download the Split-Merge files to the current directory. The files are placed in a directory named **Microsoft.Azure.SqlDatabase.ElasticScale.Service.SplitMerge.x.x.xxx.x** where *x.x.xxx.x* reflects the version number. Find the Split-Merge Service files in the **content\\splitmerge\\service** sub-directory, and the Split-Merge PowerShell scripts (and required client .dlls) in the **content\\splitmerge\\powershell** sub-directory.\n\n## Prerequisites\n\n1. Create an Azure SQL DB database that will be used as the Split-Merge status database. Go to the [Azure portal](https://ms.portal.azure.com). Create a new **SQL Database**. Fill in the database name and create a new user and password. Be sure to record the name and password for later use.\n\n2. Ensure that your Azure SQL DB server allows Azure Services to connect to it. In the portal, in the **Firewall Settings**, ensure that the **Allow access to Azure Services** setting is set to **On**. Click the \"save\" icon.\n\n    ![Allowed services][1]\n\n3. Create an Azure Storage account that will be used for diagnostics output. Go to the Azure preview portal. In the left bar, click **New**, click **Data + Storage**, then **Storage**.\n\n4. Create an Azure Cloud Service that will contain your Split-Merge service.  Go to the Azure preview portal. In the left bar, click **New**, then **Compute**, **Cloud Service**, and **Create**. \n\n\n## Configuring your Split-Merge service\n\n### Split-Merge service configuration\n\n1. In the folder where you downloaded the Split/Merge bits, create a copy of the **ServiceConfiguration.Template.cscfg** file that shipped alongside **SplitMergeService.cspkg** and call it **ServiceConfiguration.cscfg**.\n\n2. Open ServiceConfiguration.cscfg in your favorite text editor. We recommend using Visual Studio as it will validate inputs such as the format of certificate thumbprints.\n\n3. Either create a new database or choose an existing database to serve as the status database for Split/Merge operations and retrieve the connection string of that database. \n\n    **Important** At this time, the status database must use the Latin  collation (SQL\\_Latin1\\_General\\_CP1\\_CI\\_AS). For more information, see [Windows Collation Name (Transact-SQL)](https://msdn.microsoft.com/library/ms188046.aspx).\n\n    With Azure SQL DB, the connection string typically is of the form:\n\n        \"Server=myservername.database.windows.net; Database=mydatabasename;User ID=myuserID; Password=mypassword; Encrypt=True; Connection Timeout=30\" .\n4.    Enter this connection string in the cscfg file in both the **SplitMergeWeb** and **SplitMergeWorker** role sections in the ElasticScaleMetadata setting.\n\n5.    For the **SplitMergeWorker** role, enter a valid connection string to Azure storage for the **WorkerRoleSynchronizationStorageAccountConnectionString** setting.\n        \n### Configuring security\nFor detailed instructions to configure the security of the service, refer to the [Split-Merge security configuration](sql-database-elastic-scale-split-merge-security-configuration.md).\n\nFor the purposes of  a simple test deployment suitable to complete this tutorial, a minimal set of configuration steps will be performed to get the service up and running. These steps enable only the one machine/account executing them to communicate with the service.\n\n### Creating a self-signed certificate\n\nCreate a new directory and from this directory execute the following command using a [Developer Command Prompt for Visual Studio](http://msdn.microsoft.com/library/ms229859.aspx) window:\n\n    makecert ^\n    -n \"CN=*.cloudapp.net\" ^\n    -r -cy end -sky exchange -eku \"1.3.6.1.5.5.7.3.1,1.3.6.1.5.5.7.3.2\" ^\n    -a sha1 -len 2048 ^\n    -sr currentuser -ss root ^\n    -sv MyCert.pvk MyCert.cer\n\nYou are asked for a password to protect the private key. Enter a strong password and confirm it. You are then prompted for the password to be used once more after that. Click **Yes** at the end to import it to the Trusted Certification Authorities Root store.\n\n### Create a PFX file\n\nExecute the following command from the same window where makecert was executed; use the same password that you used to create the certificate:\n\n    pvk2pfx -pvk MyCert.pvk -spc MyCert.cer -pfx MyCert.pfx -pi <password>\n\n### Import the client certificate into the personal store\n1. In Windows Explorer, double-click **MyCert.pfx**.\n2. In the **Certificate Import Wizard** select **Current User** and click **Next**.\n3. Confirm the file path and click **Next**.\n4. Type the password, leave **Include all extended properties** checked and click **Next**.\n5. Leave **Automatically select the certificate store[…]** checked and click **Next**.\n6. Click **Finish** and **OK**.\n\n### Upload the PFX file to the cloud service\n\nGo to the [Azure preview portal](https://portal.azure.com).\n\n1. Select **Cloud Services**.\n2. Select the cloud service you created above for the Split/Merge service.\n3. Click **Certificates** on the top menu.\n4. Click **Upload** in the bottom bar.\n5. Select the PFX file and enter the same password as above.\n6. Once completed, copy the certificate thumbprint from the new entry in the list.\n\n### Update the service configuration file\n\nPaste the certificate thumbprint copied above into the thumbprint/value attribute of these settings.\nFor the web role:\n\n    <Setting name=\"DataEncryptionPrimaryCertificateThumbprint\" value=\"\" />\n    <Certificate name=\"DataEncryptionPrimary\" thumbprint=\"\" thumbprintAlgorithm=\"sha1\" />\n\nFor the worker role:\n\n    <Setting name=\"AdditionalTrustedRootCertificationAuthorities\" value=\"\" />\n    <Setting name=\"AllowedClientCertificateThumbprints\" value=\"\" />\n    <Setting name=\"DataEncryptionPrimaryCertificateThumbprint\" value=\"\" />\n    <Certificate name=\"SSL\" thumbprint=\"\" thumbprintAlgorithm=\"sha1\" />\n    <Certificate name=\"CA\" thumbprint=\"\" thumbprintAlgorithm=\"sha1\" />\n    <Certificate name=\"DataEncryptionPrimary\" thumbprint=\"\" thumbprintAlgorithm=\"sha1\" />\n\n\nPlease note that for production deployments separate certificates should be used for the CA, for encryption, the Server certificate and client certificates. For detailed instructions on this, see [Security Configuration](sql-database-elastic-scale-split-merge-security-configuration.md).\n\n### Deploying your Split-Merge service\n\n1. Go to the [Azure portal](https://manage.windowsazure.com).\n2. Click the **Cloud Services** tab on the left, and select the cloud service that you created earlier.\n3. Click **Dashboard**.\n4. Choose the staging environment, then click **Upload a new staging deployment**.\n\n    ![Staging][3]\n\n5. In the dialog box, enter a deployment label. For both 'Package' and 'Configuration', click 'From Local' and choose the **SplitMergeService.cspkg** file and your .cscfg file that you configured earlier.\n6. Ensure that the checkbox labeled **Deploy even if one or more roles contain a single instance** is checked.\n7. Hit the tick button in the bottom right to begin the deployment. Expect it to take a few minutes to complete.\n\n![Upload][4]\n\n\n## Deployment troubleshooting\n\nIf your web role fails to come online, it is likely a problem with the security configuration. Check that the SSL is configured as described above.\n\nIf your worker role fails to come online, but your web role succeeds, it is most likely a problem connecting to the status database that you created earlier.\n\n* Make sure that the connection string in your .cscfg is accurate.\n* Check that the server and database exist, and that the user id and password are correct.\n* For Azure SQL DB, the connection string should be of the form:\n\n        \"Server=myservername.database.windows.net; Database=mydatabasename;User ID=myuserID; Password=mypassword; Encrypt=True; Connection Timeout=30\" .\n\n* Ensure that the server name does not begin with **https://**.\n* Ensure that your Azure SQL DB server allows Azure Services to connect to it. To do this, open https://manage.windowsazure.com, click “SQL Databases” on the left, click “Servers” at the top, and select your server. Click **Configure** at the top and ensure that the **Azure Services** setting is set to “Yes”. (See the Prerequisites section at the top of this article).\n\n## Testing your Split-Merge service deployment\n\n### Connecting with a web browser\n\nDetermine the web endpoint of your Split-Merge service. You can find this in the Azure Management Portal by going to the **Dashboard** of your cloud service and looking under **Site URL** on the right side. Replace **http://** with **https://** since the default security settings disable the HTTP endpoint. Load the page for this URL into your browser.\n\n### Testing with PowerShell scripts\n\nThe deployment and your environment can be tested by running the included sample PowerShell scripts.\n\nThe script files included are:\n\n1. **SetupSampleSplitMergeEnvironment.ps1** - sets up a test data tier for Split/Merge (see table below for detailed description)\n2. **ExecuteSampleSplitMerge.ps1** - executes test operations on the test data tier (see table below for detailed description)\n3. **GetMappings.ps1** – top-level sample script that prints out the current state of the shard mappings.\n4. **ShardManagement.psm1**  – helper script that wraps the ShardManagement API\n5. **SqlDatabaseHelpers.psm1** – helper script for creating and managing SQL databases\n\n<table style=\"width:100%\">\n  <tr>\n    <th>PowerShell file</th>\n    <th>Steps</th>\n  </tr>\n  <tr>\n    <th rowspan=\"5\">SetupSampleSplitMergeEnvironment.ps1</th>\n    <td>1.    Creates a shard map manager database</td>\n  </tr>\n  <tr>\n    <td>2.    Creates 2 shard databases.\n  </tr>\n  <tr>\n    <td>3.    Creates a shard map for those database (deletes any existing shard maps on those databases). </td>\n  </tr>\n  <tr>\n    <td>4.    Creates a small sample table in both the shards, and populates the table in one of the shards.</td>\n  </tr>\n  <tr>\n    <td>5.    Declares the SchemaInfo for the sharded table.</td>\n  </tr>\n\n</table>\n\n<table style=\"width:100%\">\n  <tr>\n    <th>PowerShell file</th>\n    <th>Steps</th>\n  </tr>\n<tr>\n    <th rowspan=\"4\">ExecuteSampleSplitMerge.ps1 </th>\n    <td>1.    Sends a split request to the Split-Merge Service web frontend, which splits half the data from the first shard to the second shard.</td>\n  </tr>\n  <tr>\n    <td>2.    Polls the web frontend for the split request status and waits until the request completes.</td>\n  </tr>\n  <tr>\n    <td>3.    Sends a merge request to the Split-Merge Service web frontend, which moves the data from the second shard back to the first shard.</td>\n  </tr>\n  <tr>\n    <td>4.    Polls the web frontend for the merge request status and waits until the request completes.</td>\n  </tr>\n</table>\n\n##Using PowerShell to verify your deployment\n\n1.    Open a new PowerShell window and navigate to the directory where you downloaded the Split-Merge package, and then navigate into the “powershell” directory.\n2.    Create an Azure SQL database server (or choose an existing server) where the shard map manager and shards will be created.\n\n    Note: The SetupSampleSplitMergeEnvironment.ps1 script creates all these databases on the same server by default to keep the script simple. This is not a restriction of the Split-Merge Service itself.\n\n    A SQL authentication login with read/write access to the DBs will be needed for the Split-Merge service to move data and update the shard map. Since the Split-Merge Service runs in the cloud, it does not currently support Integrated Authentication.\n\n    Make sure the Azure SQL server is configured to allow access from the IP address of the machine running these scripts. You can find this setting under the Azure SQL server / configuration / allowed IP addresses.\n\n3.    Execute the SetupSampleSplitMergeEnvironment.ps1 script to create the sample environment.\n\n    Running this script will wipe out any existing shard map management data structures on the shard map manager database and the shards. It may be useful to rerun the script if you wish to re-initialize the shard map or shards.\n\n    Sample command line:\n\n        .\\SetupSampleSplitMergeEnvironment.ps1 `\n            -UserName 'mysqluser' `\n            -Password 'MySqlPassw0rd' `\n            -ShardMapManagerServerName 'abcdefghij.database.windows.net'\n\n4.    Execute the Getmappings.ps1 script to view the mappings that currently exist in the sample environment.\n\n        .\\GetMappings.ps1 `\n            -UserName 'mysqluser' `\n            -Password 'MySqlPassw0rd' `\n            -ShardMapManagerServerName 'abcdefghij.database.windows.net'\n\n5.    Execute the ExecuteSampleSplitMerge.ps1 script to execute a split operation (moving half the data on the first shard to the second shard) and then a merge operation (moving the data back onto the first shard). If you configured SSL and left the http endpoint disabled, ensure that you use the https:// endpoint instead.\n\n    Sample command line:\n\n        .\\ExecuteSampleSplitMerge.ps1 `\n            -UserName 'mysqluser' `\n            -Password 'MySqlPassw0rd' `\n            -ShardMapManagerServerName 'abcdefghij.database.windows.net' `\n            -SplitMergeServiceEndpoint 'https://mysplitmergeservice.cloudapp.net' `\n            -CertificateThumbprint '0123456789abcdef0123456789abcdef01234567'\n\n    If you receive the below error, it is most likely a problem with your Web endpoint’s certificate. Try connecting to the Web endpoint with your favorite Web browser and check if there is a certificate error.\n\n        Invoke-WebRequest : The underlying connection was closed: Could not establish trust relationship for the SSL/TLSsecure channel.\n\n    If it succeeded, the output should look like the below:\n\n        > .\\ExecuteSampleSplitMerge.ps1 -UserName 'mysqluser' -Password 'MySqlPassw0rd' -ShardMapManagerServerName 'abcdefghij.database.windows.net' -SplitMergeServiceEndpoint 'http://mysplitmergeservice.cloudapp.net' –CertificateThumbprint 0123456789abcdef0123456789abcdef01234567\n        Sending split request\n        Began split operation with id dc68dfa0-e22b-4823-886a-9bdc903c80f3\n        Polling split-merge request status. Press Ctrl-C to end\n        Progress: 0% | Status: Queued | Details: [Informational] Queued request\n        Progress: 5% | Status: Starting | Details: [Informational] Starting split-merge state machine for request.\n        Progress: 5% | Status: Starting | Details: [Informational] Performing data consistency checks on target     shards.\n        Progress: 20% | Status: CopyingReferenceTables | Details: [Informational] Moving reference tables from     source to target shard.\n        Progress: 20% | Status: CopyingReferenceTables | Details: [Informational] Waiting for reference tables copy     completion.\n        Progress: 20% | Status: CopyingReferenceTables | Details: [Informational] Moving reference tables from     source to target shard.\n        Progress: 44% | Status: CopyingShardedTables | Details: [Informational] Moving key range [100:110) of     Sharded tables\n        Progress: 44% | Status: CopyingShardedTables | Details: [Informational] Successfully copied key range     [100:110) for table [dbo].[MyShardedTable]\n        ...\n        ...\n        Progress: 90% | Status: Completing | Details: [Informational] Successfully deleted shardlets in table     [dbo].[MyShardedTable].\n        Progress: 90% | Status: Completing | Details: [Informational] Deleting any temp tables that were created     while processing the request.\n        Progress: 100% | Status: Succeeded | Details: [Informational] Successfully processed request.\n        Sending merge request\n        Began merge operation with id 6ffc308f-d006-466b-b24e-857242ec5f66\n        Polling request status. Press Ctrl-C to end\n        Progress: 0% | Status: Queued | Details: [Informational] Queued request\n        Progress: 5% | Status: Starting | Details: [Informational] Starting split-merge state machine for request.\n        Progress: 5% | Status: Starting | Details: [Informational] Performing data consistency checks on target     shards.\n        Progress: 20% | Status: CopyingReferenceTables | Details: [Informational] Moving reference tables from     source to target shard.\n        Progress: 44% | Status: CopyingShardedTables | Details: [Informational] Moving key range [100:110) of     Sharded tables\n        Progress: 44% | Status: CopyingShardedTables | Details: [Informational] Successfully copied key range     [100:110) for table [dbo].[MyShardedTable]\n        ...\n        ...\n        Progress: 90% | Status: Completing | Details: [Informational] Successfully deleted shardlets in table     [dbo].[MyShardedTable].\n        Progress: 90% | Status: Completing | Details: [Informational] Deleting any temp tables that were created     while processing the request.\n        Progress: 100% | Status: Succeeded | Details: [Informational] Successfully processed request.\n\n6.    Experiment with other data types! All of these scripts take an optional -ShardKeyType parameter that allows you to specify the key type. The default is Int32, but you can also specify Int64, Guid, or Binary.\n\n## Creating your own requests\n\nThe service can be used either by using the web UI or by importing and using the SplitMerge.psm1 PowerShell module which will submit your requests through the web role.\n\nThe Split-Merge service can move data in both sharded tables and reference tables. A sharded table has a sharding key column and has different row data on each shard. A reference table is not sharded so it contains the same row data on every shard. Reference tables are useful for data that does not change often and is used to JOIN with sharded tables in queries.\n\nIn order to perform a split-merge operation, you must declare the sharded tables and reference tables that you want to have moved. This is accomplished with the **SchemaInfo** API. This API is in the **Microsoft.Azure.SqlDatabase.ElasticScale.ShardManagement.Schema** namespace.\n\n1.    For each sharded table, create a **ShardedTableInfo** object describing the table’s parent schema name (optional, defaults to “dbo”), the table name, and the column name in that table that contains the sharding key.\n2.    For each reference table, create a **ReferenceTableInfo** object describing the table’s parent schema name (optional, defaults to “dbo”) and the table name.\n3.    Add the above TableInfo objects to a new **SchemaInfo** object.\n4.    Get a reference to a **ShardMapManager** object, and call **GetSchemaInfoCollection**.\n5.    Add the **SchemaInfo** to the **SchemaInfoCollection**, providing the shard map name.\n\nAn example of this can be seen in the SetupSampleSplitMergeEnvironment.ps1 script.\n\nNote that the Split-Merge service does not create the target database (or schema for any tables in the database) for you. They must be pre-created before sending a request to the service.\n\n\n## Troubleshooting\nYou may see the below message when running the sample powershell scripts:\n\n    Invoke-WebRequest : The underlying connection was closed: Could not establish trust relationship for the SSL/TLS secure channel.\n\nThis error means that your SSL certificate is not configured correctly. Please follow the instructions in section 'Connecting with a web browser'.\n\nIf you cannot submit requests you may see this:\n\n [Exception] System.Data.SqlClient.SqlException (0x80131904): Could not find stored procedure 'dbo.InsertRequest'. \n\nIn this case, check your configuration file, in particular the setting for **WorkerRoleSynchronizationStorageAccountConnectionString**. This error typically indicates that the worker role could not successfully initialize the metadata database on first use. \n\n[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]\n\n<!--Image references-->\n[1]: ./media/sql-database-elastic-scale-configure-deploy-split-and-merge/allowed-services.png\n[2]: ./media/sql-database-elastic-scale-configure-deploy-split-and-merge/manage.png\n[3]: ./media/sql-database-elastic-scale-configure-deploy-split-and-merge/staging.png\n[4]: ./media/sql-database-elastic-scale-configure-deploy-split-and-merge/upload.png\n[5]: ./media/sql-database-elastic-scale-configure-deploy-split-and-merge/storage.png\n "
}