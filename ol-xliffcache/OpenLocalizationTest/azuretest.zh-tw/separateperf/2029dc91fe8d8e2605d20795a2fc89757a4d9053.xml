{
  "nodes": [
    {
      "content": "Elastic database jobs overview",
      "pos": [
        72,
        102
      ]
    },
    {
      "content": "Illustrates the elastic database job service",
      "pos": [
        122,
        166
      ]
    },
    {
      "content": "Create and manage a SQL Database elastic database jobs using PowerShell (preview)",
      "pos": [
        528,
        609
      ]
    },
    {
      "content": "[AZURE.SELECTOR]",
      "pos": [
        613,
        629
      ]
    },
    {
      "content": "Azure portal",
      "pos": [
        633,
        645
      ]
    },
    {
      "content": "PowerShell",
      "pos": [
        698,
        708
      ]
    },
    {
      "content": "Overview",
      "pos": [
        755,
        763
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>Elastic Database jobs<ept id=\"p1\">**</ept> feature (preview) enables you to  reliably execute a Transact-SQL (T-SQL) script or apply a DACPAC across a group of databases including a custom-defined collection of databases, all databases in an <bpt id=\"p2\">[</bpt>Elastic Database pool (preview)<ept id=\"p2\">](sql-database-elastic-pool.md)</ept> or a shard set (created using <bpt id=\"p3\">[</bpt>Elastic Database client library<ept id=\"p3\">](sql-database-elastic-database-client-library.md)</ept>).",
      "pos": [
        765,
        1172
      ]
    },
    {
      "content": "While in preview, <bpt id=\"p1\">**</bpt>Elastic Database jobs<ept id=\"p1\">**</ept> is currently a customer-hosted Azure Cloud Service that enables the execution of ad-hoc and scheduled administrative tasks, which are called jobs.",
      "pos": [
        1173,
        1363
      ]
    },
    {
      "content": "Using this feature, you can easily and reliably manage large numbers of Azure SQL Databases at scale by running Transact-SQL scripts to perform administrative operations such as schema changes, credentials management, reference data updates, performance data collection or tenant (customer) telemetry collection.",
      "pos": [
        1364,
        1676
      ]
    },
    {
      "content": "For more information about Elastic Database jobs, see <bpt id=\"p1\">[</bpt>Elastic Database jobs overview<ept id=\"p1\">](sql-database-elastic-jobs-overview.md)</ept>.",
      "pos": [
        1677,
        1803
      ]
    },
    {
      "content": "With the PowerShell APIs for <bpt id=\"p1\">**</bpt>Elastic Database jobs<ept id=\"p1\">**</ept>, you have flexibility to define which group of databases against which scripts will execute.",
      "pos": [
        1805,
        1952
      ]
    },
    {
      "content": "Currently, <bpt id=\"p1\">**</bpt>Elastic Database jobs<ept id=\"p1\">**</ept> functionality via the Azure portal has reduced feature set and is limited to execution against Elastic Database pools.",
      "pos": [
        1953,
        2108
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Elastic Database jobs<ept id=\"p1\">**</ept> (preview) uses multiple Azure components to define the jobs to be performed, define when to perform the jobs, execute the jobs, track the success or failure of the jobs and optionally specify a results destination for results returning queries.",
      "pos": [
        2110,
        2380
      ]
    },
    {
      "content": "Since the Powershell APIs included in this preview contain additional functionality since the initial preview via the Portal, it is suggested you install the latest <bpt id=\"p1\">**</bpt>Elastic Database jobs<ept id=\"p1\">**</ept> components.",
      "pos": [
        2381,
        2583
      ]
    },
    {
      "content": "If already installed, you can simply upgrade the <bpt id=\"p1\">**</bpt>Elastic Database jobs<ept id=\"p1\">**</ept> components.",
      "pos": [
        2584,
        2670
      ]
    },
    {
      "content": "For more information about installation from <bpt id=\"p1\">[</bpt>Nuget<ept id=\"p1\">](https://www.nuget.org/packages/Microsoft.Azure.SqlDatabase.Jobs)</ept>, see <bpt id=\"p2\">[</bpt>Install the Elastic Database jobs components<ept id=\"p2\">](sql-database-elastic-jobs-service-installation.md)</ept>.",
      "pos": [
        2671,
        2892
      ]
    },
    {
      "content": "This article will show you how to create everything you need to create and manage <bpt id=\"p1\">**</bpt>Elastic Database jobs<ept id=\"p1\">**</ept>, except for the Azure subscription.",
      "pos": [
        2895,
        3038
      ]
    },
    {
      "content": "If you need an Azure subscription, simply click FREE TRIAL at the top of this page, and then come back to finish this article.",
      "pos": [
        3039,
        3165
      ]
    },
    {
      "content": "This topic extends on the sample found in <bpt id=\"p1\">[</bpt>Getting started with Elastic Database tools<ept id=\"p1\">](sql-database-elastic-scale-get-started.md)</ept>.",
      "pos": [
        3166,
        3297
      ]
    },
    {
      "content": "When completed, you will learn how to create and manage jobs to perform administrative operations against a group of sharded databases defined by a <bpt id=\"p1\">**</bpt>shard set<ept id=\"p1\">**</ept> and alternatively custom-collection of databases.",
      "pos": [
        3298,
        3509
      ]
    },
    {
      "content": "Prerequisites",
      "pos": [
        3514,
        3527
      ]
    },
    {
      "content": "An Azure subscription.",
      "pos": [
        3530,
        3552
      ]
    },
    {
      "content": "For a free trial, see <bpt id=\"p1\">[</bpt>Free one-month trial<ept id=\"p1\">](http://azure.microsoft.com/pricing/free-trial/)</ept>.",
      "pos": [
        3553,
        3646
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Elastic Database jobs<ept id=\"p1\">**</ept> PowerShell package must first be downloaded, imported and the Elastic Database jobs components installed.",
      "pos": [
        3649,
        3780
      ]
    },
    {
      "content": "Follow these steps: <bpt id=\"p1\">[</bpt>Installing Elastic Database jobs<ept id=\"p1\">](sql-database-elastic-jobs-service-installation.md)</ept>",
      "pos": [
        3781,
        3886
      ]
    },
    {
      "content": "Azure PowerShell version &gt;= 0.8.16.",
      "pos": [
        3889,
        3924
      ]
    },
    {
      "content": "Install the latest version (0.9.5) through the <bpt id=\"p1\">[</bpt>Web Platform Installer<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=320376)</ept>.",
      "pos": [
        3925,
        4046
      ]
    },
    {
      "content": "For detailed information, see <bpt id=\"p1\">[</bpt>How to install and configure Azure PowerShell<ept id=\"p1\">](powershell-install-configure.md)</ept>.",
      "pos": [
        4047,
        4158
      ]
    },
    {
      "content": "Select your Azure subscription",
      "pos": [
        4164,
        4194
      ]
    },
    {
      "content": "To select the subscription you need your subscription Id (<bpt id=\"p1\">**</bpt>-SubscriptionId<ept id=\"p1\">**</ept>) or subscription name (<bpt id=\"p2\">**</bpt>-SubscriptionName<ept id=\"p2\">**</ept>).",
      "pos": [
        4196,
        4320
      ]
    },
    {
      "content": "If you have multiple subscriptions you can run the <bpt id=\"p1\">**</bpt>Get-AzureSubscription<ept id=\"p1\">**</ept> cmdlet and copy the desired subscription information from the result set.",
      "pos": [
        4321,
        4471
      ]
    },
    {
      "content": "Once you have your subscription information, run the following commandlet to set this subscription as the default, namely the target for creating and managing jobs:",
      "pos": [
        4472,
        4636
      ]
    },
    {
      "pos": [
        4701,
        4876
      ],
      "content": "The <bpt id=\"p1\">[</bpt>PowerShell ISE<ept id=\"p1\">](https://technet.microsoft.com/library/dd315244.aspx)</ept> is recommended for usage to develop and execute PowerShell scripts against the Elastic Database jobs."
    },
    {
      "content": "Elastic Database jobs objects",
      "pos": [
        4881,
        4910
      ]
    },
    {
      "pos": [
        4912,
        5048
      ],
      "content": "The following table lists out all the object types of <bpt id=\"p1\">**</bpt>Elastic Database jobs<ept id=\"p1\">**</ept> along with its description and relevant PowerShell APIs."
    },
    {
      "content": "Object Type",
      "pos": [
        5092,
        5103
      ]
    },
    {
      "content": "Description",
      "pos": [
        5117,
        5128
      ]
    },
    {
      "content": "Related PowerShell APIs",
      "pos": [
        5142,
        5165
      ]
    },
    {
      "content": "Credential",
      "pos": [
        5194,
        5204
      ]
    },
    {
      "content": "Username and password to use when connecting to databases for execution of scripts or application of DACPACs.",
      "pos": [
        5218,
        5327
      ]
    },
    {
      "content": "The password is encrypted before sending to and storing in the Elastic Database Jobs database.",
      "pos": [
        5331,
        5425
      ]
    },
    {
      "content": "The password is decrypted by the Elastic Database Jobs service via the credential created and uploaded from the installation script.",
      "pos": [
        5427,
        5559
      ]
    },
    {
      "content": "Get-AzureSqlJobCredential",
      "pos": [
        5576,
        5601
      ]
    },
    {
      "content": "New-AzureSqlJobCredential",
      "pos": [
        5613,
        5638
      ]
    },
    {
      "content": "Set-AzureSqlJobCredential",
      "pos": [
        5645,
        5670
      ]
    },
    {
      "content": "Script",
      "pos": [
        5709,
        5715
      ]
    },
    {
      "content": "Transact-SQL script to be used for execution across databases.",
      "pos": [
        5729,
        5791
      ]
    },
    {
      "content": "The script should be authored to be idempotent since the service will retry execution of the script upon failures.",
      "pos": [
        5793,
        5907
      ]
    },
    {
      "content": "Get-AzureSqlJobContent",
      "pos": [
        5934,
        5956
      ]
    },
    {
      "content": "Get-AzureSqlJobContentDefinition",
      "pos": [
        5968,
        6000
      ]
    },
    {
      "content": "New-AzureSqlJobContent",
      "pos": [
        6012,
        6034
      ]
    },
    {
      "content": "Set-AzureSqlJobContentDefinition",
      "pos": [
        6046,
        6078
      ]
    },
    {
      "content": "DACPAC",
      "pos": [
        6117,
        6123
      ]
    },
    {
      "content": "Data-tier application <ph id=\"ph1\">&lt;/a&gt;</ph> package to be applied across databases.",
      "pos": [
        6196,
        6262
      ]
    },
    {
      "content": "Database Target",
      "pos": [
        6428,
        6443
      ]
    },
    {
      "content": "Database and server name pointing to an Azure SQL Database.",
      "pos": [
        6457,
        6516
      ]
    },
    {
      "content": "Shard Map Target",
      "pos": [
        6636,
        6652
      ]
    },
    {
      "content": "Combination of a database target and a credential to be used to determine information stored within an Elastic Database shard map.",
      "pos": [
        6666,
        6796
      ]
    },
    {
      "content": "Get-AzureSqlJobTarget",
      "pos": [
        6823,
        6844
      ]
    },
    {
      "content": "New-AzureSqlJobTarget",
      "pos": [
        6856,
        6877
      ]
    },
    {
      "content": "Set-AzureSqlJobTarget",
      "pos": [
        6889,
        6910
      ]
    },
    {
      "content": "Custom Collection Target",
      "pos": [
        6946,
        6970
      ]
    },
    {
      "content": "Defined group of databases to collectively use for execution.",
      "pos": [
        6984,
        7045
      ]
    },
    {
      "content": "Get-AzureSqlJobTarget",
      "pos": [
        7067,
        7088
      ]
    },
    {
      "content": "New-AzureSqlJobTarget",
      "pos": [
        7100,
        7121
      ]
    },
    {
      "content": "Custom Collection Child Target",
      "pos": [
        7157,
        7187
      ]
    },
    {
      "content": "Database target that is referenced from a custom collection.",
      "pos": [
        7201,
        7261
      ]
    },
    {
      "content": "Add-AzureSqlJobChildTarget",
      "pos": [
        7283,
        7309
      ]
    },
    {
      "content": "Remove-AzureSqlJobChildTarget",
      "pos": [
        7321,
        7350
      ]
    },
    {
      "content": "Job",
      "pos": [
        7387,
        7390
      ]
    },
    {
      "content": "Definition of parameters for a job that can be used to trigger execution or to fulfill a schedule.",
      "pos": [
        7412,
        7510
      ]
    },
    {
      "content": "Get-AzureSqlJob",
      "pos": [
        7541,
        7556
      ]
    },
    {
      "content": "New-AzureSqlJob",
      "pos": [
        7568,
        7583
      ]
    },
    {
      "content": "Set-AzureSqlJob",
      "pos": [
        7595,
        7610
      ]
    },
    {
      "content": "Job Execution",
      "pos": [
        7647,
        7660
      ]
    },
    {
      "content": "Container of tasks necessary to fulfill either executing a script or applying a DACPAC to a target using credentials for database connections with failures handled in accordance to an execution policy.",
      "pos": [
        7682,
        7883
      ]
    },
    {
      "content": "Get-AzureSqlJobExecution",
      "pos": [
        7914,
        7938
      ]
    },
    {
      "content": "Start-AzureSqlJobExecution",
      "pos": [
        7950,
        7976
      ]
    },
    {
      "content": "Stop-AzureSqlJobExecution",
      "pos": [
        7988,
        8013
      ]
    },
    {
      "content": "Wait-AzureSqlJobExecution",
      "pos": [
        8025,
        8050
      ]
    },
    {
      "content": "Job Task Execution",
      "pos": [
        8077,
        8095
      ]
    },
    {
      "content": "Single unit of work to fulfill a job.",
      "pos": [
        8117,
        8154
      ]
    },
    {
      "content": "If a job task is not able to successfully execute, the resulting exception message will be logged and a new matching job task will be created and executed in accordance to the specified execution policy.",
      "pos": [
        8166,
        8369
      ]
    },
    {
      "content": "Get-AzureSqlJobExecution",
      "pos": [
        8404,
        8428
      ]
    },
    {
      "content": "Start-AzureSqlJobExecution",
      "pos": [
        8440,
        8466
      ]
    },
    {
      "content": "Stop-AzureSqlJobExecution",
      "pos": [
        8478,
        8503
      ]
    },
    {
      "content": "Wait-AzureSqlJobExecution",
      "pos": [
        8515,
        8540
      ]
    },
    {
      "content": "Job Execution Policy",
      "pos": [
        8567,
        8587
      ]
    },
    {
      "content": "Controls job execution timeouts, retry limits and intervals between retries.",
      "pos": [
        8609,
        8685
      ]
    },
    {
      "content": "Elastic Database jobs includes a default job execution policy which cause essentially infinite retries of job task failures with exponential backoff of intervals between each retry.",
      "pos": [
        8697,
        8878
      ]
    },
    {
      "content": "Get-AzureSqlJobExecutionPolicy",
      "pos": [
        8909,
        8939
      ]
    },
    {
      "content": "New-AzureSqlJobExecutionPolicy",
      "pos": [
        8951,
        8981
      ]
    },
    {
      "content": "Set-AzureSqlJobExecutionPolicy",
      "pos": [
        8993,
        9023
      ]
    },
    {
      "content": "Schedule",
      "pos": [
        9060,
        9068
      ]
    },
    {
      "content": "Time based specification for execution to take place either on a reoccurring interval or at a single time.",
      "pos": [
        9090,
        9196
      ]
    },
    {
      "content": "Get-AzureSqlJobSchedule",
      "pos": [
        9227,
        9250
      ]
    },
    {
      "content": "New-AzureSqlJobSchedule",
      "pos": [
        9262,
        9285
      ]
    },
    {
      "content": "Set-AzureSqlJobSchedule",
      "pos": [
        9297,
        9320
      ]
    },
    {
      "content": "Job Triggers",
      "pos": [
        9357,
        9369
      ]
    },
    {
      "content": "A mapping between a job and a schedule to trigger job execution according to the schedule.",
      "pos": [
        9391,
        9481
      ]
    },
    {
      "content": "New-AzureSqlJobTrigger",
      "pos": [
        9512,
        9534
      ]
    },
    {
      "content": "Remove-AzureSqlJobTrigger",
      "pos": [
        9546,
        9571
      ]
    },
    {
      "content": "Supported Elastic Database jobs group types",
      "pos": [
        9607,
        9650
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Elastic Database jobs<ept id=\"p1\">**</ept> enables execution of Transact-SQL (T-SQL) scripts or application of DACPACs across a group of databases.",
      "pos": [
        9651,
        9781
      ]
    },
    {
      "content": "When a job is submitted to be executed across a group of databases, Elastic Database jobs will “expand” the job into child jobs where each which job performs the requested execution against a single database in the group.",
      "pos": [
        9782,
        10003
      ]
    },
    {
      "content": "The following is a list of current supported group types:",
      "pos": [
        10006,
        10063
      ]
    },
    {
      "pos": [
        10067,
        10333
      ],
      "content": "<bpt id=\"p1\">[</bpt>Shard Map<ept id=\"p1\">](sql-database-elastic-scale-shard-map-management.md)</ept>: When a job is submitted to target a shard map, jobs will first query the shard map to determine its current set of shards and then expand the job to child jobs matching each shard within the shard map."
    },
    {
      "content": "Custom Collection: Specified to point to a custom defined set of databases.",
      "pos": [
        10336,
        10411
      ]
    },
    {
      "content": "When a job is submitted to target a custom collection, jobs will expand the job to child jobs matching each database currently defined within the custom collection.",
      "pos": [
        10412,
        10576
      ]
    },
    {
      "content": "Setting the Elastic Database jobs connection",
      "pos": [
        10581,
        10625
      ]
    },
    {
      "content": "After loading the PowerShell module, the connection needs to be set to the Elastic Database jobs <bpt id=\"p1\">*</bpt>Control Database<ept id=\"p1\">*</ept> prior to using the jobs APIs.",
      "pos": [
        10626,
        10771
      ]
    },
    {
      "content": "Invocation of this cmdlet will trigger a credential window to pop up requesting the user name/password supplied when installing Elastic Database jobs.",
      "pos": [
        10772,
        10922
      ]
    },
    {
      "content": "All examples provided within this topic assume that this first step has already been performed.",
      "pos": [
        10923,
        11018
      ]
    },
    {
      "content": "Open a connection to the Elastic Database jobs:",
      "pos": [
        11020,
        11067
      ]
    },
    {
      "content": "Encrypted credentials within the Elastic Database jobs",
      "pos": [
        11130,
        11184
      ]
    },
    {
      "content": "Database credentials can be inserted into Elastic Database jobs <bpt id=\"p1\">*</bpt>Control Database<ept id=\"p1\">*</ept>  with its password encrypted.",
      "pos": [
        11185,
        11297
      ]
    },
    {
      "content": "It is necessary to store credentials to enable jobs to be executed at a later time, including using job schedules.",
      "pos": [
        11298,
        11412
      ]
    },
    {
      "content": "Encryption works through a certificate created as part of the installation script.",
      "pos": [
        11415,
        11497
      ]
    },
    {
      "content": "The installation script creates and uploads the certificate into the Azure Cloud Service for decryption of the stored encrypted passwords.",
      "pos": [
        11498,
        11636
      ]
    },
    {
      "content": "The Azure Cloud Service later stores the public key within the Elastic Database jobs <bpt id=\"p1\">*</bpt>Control Database<ept id=\"p1\">*</ept> which enables the PowerShell API or Azure portal interface to encrypt a provided password without requiring the certificate to be locally installed.",
      "pos": [
        11637,
        11889
      ]
    },
    {
      "content": "While the credential passwords are encrypted and secure from users with read-only access to Elastic Database jobs objects, it is possible for a malicious user with read-write access to Elastic Database Jobs objects to extract out a password.",
      "pos": [
        11892,
        12133
      ]
    },
    {
      "content": "Credentials are designed to be reused across job executions.",
      "pos": [
        12134,
        12194
      ]
    },
    {
      "content": "Credentials are passed to target databases when establishing connections.",
      "pos": [
        12195,
        12268
      ]
    },
    {
      "content": "There are currently not any restrictions on the target databases used for each credential so it is possible for a malicious user to add a database target for a database in their control and subsequently start a job targeting this database to gain knowledge of the credential's password.",
      "pos": [
        12269,
        12555
      ]
    },
    {
      "content": "There are security best practices for Elastic Database jobs:",
      "pos": [
        12557,
        12617
      ]
    },
    {
      "content": "Limit usage of the APIs to trusted individuals.",
      "pos": [
        12621,
        12668
      ]
    },
    {
      "content": "Credentials should have the least privileges necessary to perform the job task.",
      "pos": [
        12671,
        12750
      ]
    },
    {
      "content": "More information can be seen within this <bpt id=\"p1\">[</bpt>Authorization and Permissions<ept id=\"p1\">](https://msdn.microsoft.com/library/bb669084.aspx)</ept> SQL Server MSDN article.",
      "pos": [
        12752,
        12899
      ]
    },
    {
      "content": "Creating an encrypted credential for job execution across databases",
      "pos": [
        12905,
        12972
      ]
    },
    {
      "pos": [
        12973,
        13141
      ],
      "content": "To create a new encrypted credential, the Get-Credential cmdlet will prompt for a user name and password that can be passed to the <bpt id=\"p1\">**</bpt>New-AzureSqlJobCredential<ept id=\"p1\">**</ept> cmdlet."
    },
    {
      "content": "Updating Credentials",
      "pos": [
        13368,
        13388
      ]
    },
    {
      "pos": [
        13389,
        13551
      ],
      "content": "To update an existing credential to support the case when passwords change, use the <bpt id=\"p1\">**</bpt>Set-AzureSqlJobCredential<ept id=\"p1\">**</ept> cmdlet and set the <bpt id=\"p2\">**</bpt>CredentialName<ept id=\"p2\">**</ept> parameter."
    },
    {
      "content": "Defining an Elastic Database Shard Map Target",
      "pos": [
        13686,
        13731
      ]
    },
    {
      "content": "Execute a job against all databases in a shard set (created using <bpt id=\"p1\">[</bpt>Elastic Database client library<ept id=\"p1\">](sql-database-elastic-database-client-library.md)</ept>) using a shard map as the database target.",
      "pos": [
        13732,
        13923
      ]
    },
    {
      "content": "This example is dependent on you creating a sharded application using the Elastic Database client library.",
      "pos": [
        13924,
        14030
      ]
    },
    {
      "content": "Download and run the <bpt id=\"p1\">[</bpt>Getting started with Elastic Database tools sample<ept id=\"p1\">](sql-database-elastic-scale-get-started.md)</ept>.",
      "pos": [
        14031,
        14148
      ]
    },
    {
      "content": "Create a shard map manager using the sample app",
      "pos": [
        14153,
        14200
      ]
    },
    {
      "content": "Here you will create a shard map manager along with several shards, followed by insertion of data into the shards.",
      "pos": [
        14202,
        14316
      ]
    },
    {
      "content": "If you happen to already have shards setup, you can skip the following steps and move to the next section.",
      "pos": [
        14317,
        14423
      ]
    },
    {
      "content": "Build and run the <bpt id=\"p1\">**</bpt>Getting started with Elastic Database tools<ept id=\"p1\">**</ept> sample application.",
      "pos": [
        14428,
        14513
      ]
    },
    {
      "content": "Follow the steps until step 7 in the section <bpt id=\"p1\">[</bpt>Download and run the sample app<ept id=\"p1\">](sql-database-elastic-scale-get-started.md#Getting-started-with-elastic-database-tools)</ept>.",
      "pos": [
        14514,
        14680
      ]
    },
    {
      "content": "At the end of Step 7, you will see the following command prompt:",
      "pos": [
        14681,
        14745
      ]
    },
    {
      "content": "![command prompt][1]",
      "pos": [
        14751,
        14771
      ]
    },
    {
      "content": "In the command window, type \"1\" and press <bpt id=\"p1\">**</bpt>Enter<ept id=\"p1\">**</ept>.",
      "pos": [
        14777,
        14829
      ]
    },
    {
      "content": "This creates the shard map manager, and adds two shards to the server.",
      "pos": [
        14830,
        14900
      ]
    },
    {
      "content": "Then type \"3\" and press <bpt id=\"p1\">**</bpt>Enter<ept id=\"p1\">**</ept>; repeat the action four times.",
      "pos": [
        14901,
        14965
      ]
    },
    {
      "content": "This inserts sample data rows in your shards.",
      "pos": [
        14966,
        15011
      ]
    },
    {
      "pos": [
        15019,
        15123
      ],
      "content": "The <bpt id=\"p1\">[</bpt>Azure preview portal<ept id=\"p1\">](https://portal.azure.com)</ept> should show three new databases in your v12 server:"
    },
    {
      "content": "![Visual Studio confirmation][2]",
      "pos": [
        15129,
        15161
      ]
    },
    {
      "content": "Now create a shard map target, using the <bpt id=\"p1\">**</bpt>New-AzureSqlJobTarget<ept id=\"p1\">**</ept> cmdlet.",
      "pos": [
        15163,
        15237
      ]
    },
    {
      "content": "The shard map manager database must be set as a database target and then the specific shard map is specified as a target.",
      "pos": [
        15238,
        15359
      ]
    },
    {
      "content": "Create a T-SQL Script for execution across databases",
      "pos": [
        16034,
        16086
      ]
    },
    {
      "content": "When creating T-SQL scripts for execution, it is highly recommended to build them to be idempotent and resilient against failures.",
      "pos": [
        16088,
        16218
      ]
    },
    {
      "content": "Elastic Database jobs will retry execution of a script whenever execution encounters a failure, regardless of the classification of the failure.",
      "pos": [
        16219,
        16363
      ]
    },
    {
      "pos": [
        16365,
        16510
      ],
      "content": "Use the <bpt id=\"p1\">**</bpt>New-AzureSqlJobContent<ept id=\"p1\">**</ept> cmdlet to create and save a script for execution and set the <bpt id=\"p2\">**</bpt>-ContentName<ept id=\"p2\">**</ept> and <bpt id=\"p3\">**</bpt>-CommandText<ept id=\"p3\">**</ept> parameters."
    },
    {
      "content": "Create a new script from a file",
      "pos": [
        17007,
        17038
      ]
    },
    {
      "content": "If the T-SQL script is defined within a file, the following script could be used to import the script:",
      "pos": [
        17039,
        17141
      ]
    },
    {
      "content": "Update a T-SQL Script for Execution across Databases",
      "pos": [
        17412,
        17464
      ]
    },
    {
      "content": "The following PowerShell script can be used to update the T-SQL command text for an existing script.",
      "pos": [
        17468,
        17568
      ]
    },
    {
      "content": "Set the following variables to reflect the desired script definition to be set:",
      "pos": [
        17570,
        17649
      ]
    },
    {
      "content": "Update the definition to an existing script",
      "pos": [
        18410,
        18453
      ]
    },
    {
      "content": "Create a Job to execute a script across an shard map",
      "pos": [
        18583,
        18635
      ]
    },
    {
      "content": "The following PowerShell script can be used to start a job for execution of a script across each shard in an Elastic Scale shard map.",
      "pos": [
        18637,
        18770
      ]
    },
    {
      "content": "Set the following variables to reflect the desired script and target:",
      "pos": [
        18772,
        18841
      ]
    },
    {
      "content": "Execute a job",
      "pos": [
        19427,
        19440
      ]
    },
    {
      "content": "The following PowerShell script can be used to execute an existing job:",
      "pos": [
        19443,
        19514
      ]
    },
    {
      "content": "Update the following variable to reflect the desired job name to have executed:",
      "pos": [
        19516,
        19595
      ]
    },
    {
      "content": "Retrieve the state of a single job execution",
      "pos": [
        19727,
        19771
      ]
    },
    {
      "pos": [
        19773,
        19894
      ],
      "content": "Use the <bpt id=\"p1\">**</bpt>Get-AzureSqlJobExecution<ept id=\"p1\">**</ept> cmdlets and set the <bpt id=\"p2\">**</bpt>JobExecutionId<ept id=\"p2\">**</ept> parameter to view the state of job execution."
    },
    {
      "pos": [
        20048,
        20270
      ],
      "content": "Use the same <bpt id=\"p1\">**</bpt>Get-AzureSqlJobExecution<ept id=\"p1\">**</ept> cmdlet with the <bpt id=\"p2\">**</bpt>IncludeChildren<ept id=\"p2\">**</ept> parameter to view the state of child job executions, namely the specific state for each job execution against each database targeted by the job."
    },
    {
      "content": "View the state across multiple job executions",
      "pos": [
        20447,
        20492
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>Get-AzureSqlJobExecution<ept id=\"p1\">**</ept> cmdlet has multiple optional parameters that can be used to display multiple job executions, filtered through the provided parameters.",
      "pos": [
        20494,
        20661
      ]
    },
    {
      "content": "The following demonstrates some of the possible ways to use Get-AzureSqlJobExecution:",
      "pos": [
        20662,
        20747
      ]
    },
    {
      "content": "Retrieve all active top level job executions:",
      "pos": [
        20749,
        20794
      ]
    },
    {
      "content": "Retrieve all top level job executions, including inactive job executions:",
      "pos": [
        20826,
        20899
      ]
    },
    {
      "content": "Retrieve all child job executions of a provided job execution ID, including inactive job executions:",
      "pos": [
        20948,
        21048
      ]
    },
    {
      "content": "Retrieve all job executions created using a schedule / job combination, including inactive jobs:",
      "pos": [
        21223,
        21319
      ]
    },
    {
      "content": "Retrieve all jobs targeting a specified shard map, including inactive jobs:",
      "pos": [
        21480,
        21555
      ]
    },
    {
      "content": "Retrieve all jobs targeting a specified custom collection, including inactive jobs:",
      "pos": [
        21940,
        22023
      ]
    },
    {
      "content": "Retrieve the list of job task executions within a specific job execution:",
      "pos": [
        22235,
        22308
      ]
    },
    {
      "content": "Retrieve job task execution details:",
      "pos": [
        22477,
        22513
      ]
    },
    {
      "content": "The following PowerShell script can be used to view the details of a job task execution, which is particularly useful when debugging execution failures.",
      "pos": [
        22515,
        22667
      ]
    },
    {
      "content": "Retrieve failures within job task executions",
      "pos": [
        22853,
        22897
      ]
    },
    {
      "content": "The JobTaskExecution object includes a property for the Lifecycle of the task along with a Message property.",
      "pos": [
        22899,
        23007
      ]
    },
    {
      "content": "If a job task execution failed, the Lifecycle property will be set to <bpt id=\"p1\">*</bpt>Failed<ept id=\"p1\">*</ept> and the Message property will be set to the resulting exception message and its stack.",
      "pos": [
        23008,
        23173
      ]
    },
    {
      "content": "If a job did not succeed, it is important to view the details of job tasks that did not succeed for a given job.",
      "pos": [
        23174,
        23286
      ]
    },
    {
      "content": "Waiting for a job execution to complete",
      "pos": [
        23622,
        23661
      ]
    },
    {
      "content": "The following PowerShell script can be used to wait for a job task to complete:",
      "pos": [
        23663,
        23742
      ]
    },
    {
      "content": "Create a custom execution policy",
      "pos": [
        23854,
        23886
      ]
    },
    {
      "content": "Elastic Database jobs supports creating custom execution policies that can be applied when starting jobs.",
      "pos": [
        23888,
        23993
      ]
    },
    {
      "content": "Execution policies currently allow for defining:",
      "pos": [
        23997,
        24045
      ]
    },
    {
      "content": "Name: Identifier for the execution policy.",
      "pos": [
        24049,
        24091
      ]
    },
    {
      "content": "Job Timeout: Total time before a job will be canceled by Elastic Database Jobs.",
      "pos": [
        24094,
        24173
      ]
    },
    {
      "content": "Initial Retry Interval: Interval to wait before first retry.",
      "pos": [
        24176,
        24236
      ]
    },
    {
      "content": "Maximum Retry Interval: Cap of retry intervals to use.",
      "pos": [
        24239,
        24293
      ]
    },
    {
      "content": "Retry Interval Backoff Coefficient: Coefficient used to calculate the next interval between retries.",
      "pos": [
        24296,
        24396
      ]
    },
    {
      "content": "The following formula is used: (Initial Retry Interval) * Math.pow((Interval Backoff Coefficient), (Number of Retries) - 2).",
      "pos": [
        24398,
        24522
      ]
    },
    {
      "content": "Maximum Attempts: The maximum number of retry attempts to perform within a job.",
      "pos": [
        24526,
        24605
      ]
    },
    {
      "content": "The default execution policy uses the following values:",
      "pos": [
        24607,
        24662
      ]
    },
    {
      "content": "Name: Default execution policy",
      "pos": [
        24666,
        24696
      ]
    },
    {
      "content": "Job Timeout: 1 week",
      "pos": [
        24699,
        24718
      ]
    },
    {
      "content": "Initial Retry Interval:  100 milliseconds",
      "pos": [
        24721,
        24762
      ]
    },
    {
      "content": "Maximum Retry Interval: 30 minutes",
      "pos": [
        24765,
        24799
      ]
    },
    {
      "content": "Retry Interval Coefficient: 2",
      "pos": [
        24802,
        24831
      ]
    },
    {
      "content": "Maximum Attempts: 2,147,483,647",
      "pos": [
        24834,
        24865
      ]
    },
    {
      "content": "Create the desired execution policy:",
      "pos": [
        24867,
        24903
      ]
    },
    {
      "content": "Update a custom execution policy",
      "pos": [
        25526,
        25558
      ]
    },
    {
      "content": "Update the desired execution policy to update:",
      "pos": [
        25560,
        25606
      ]
    },
    {
      "content": "Cancel a job",
      "pos": [
        26243,
        26255
      ]
    },
    {
      "content": "Elastic Database Jobs supports cancellation requests of jobs.",
      "pos": [
        26257,
        26318
      ]
    },
    {
      "content": "If Elastic Database Jobs detects a cancellation request for a job currently being executed, it will attempt to stop the job.",
      "pos": [
        26320,
        26444
      ]
    },
    {
      "content": "There are two different ways that Elastic Database Jobs can perform a cancellation:",
      "pos": [
        26446,
        26529
      ]
    },
    {
      "content": "Canceling Currently Executing Tasks: If a cancellation is detected while a task is currently running, a cancellation will be attempted within the currently executing aspect of the task.",
      "pos": [
        26534,
        26719
      ]
    },
    {
      "content": "For example: If there is a long running query currently being performed when a cancellation is attempted, there will be an attempt to cancel the query.",
      "pos": [
        26721,
        26872
      ]
    },
    {
      "content": "Canceling Task Retries: If a cancellation is detected by the control thread before a task is launched for execution, the control thread will avoid launching the task and declare the request as canceled.",
      "pos": [
        26876,
        27078
      ]
    },
    {
      "content": "If a job cancellation is requested for a parent job, the cancellation request will be honored for the parent job and for all of its child jobs.",
      "pos": [
        27080,
        27223
      ]
    },
    {
      "pos": [
        27226,
        27346
      ],
      "content": "To submit a cancellation request, use the <bpt id=\"p1\">**</bpt>Stop-AzureSqlJobExecution<ept id=\"p1\">**</ept> cmdlet and set the <bpt id=\"p2\">**</bpt>JobExecutionId<ept id=\"p2\">**</ept> parameter."
    },
    {
      "content": "Delete a job by name and the job's history",
      "pos": [
        27457,
        27499
      ]
    },
    {
      "content": "Elastic Database jobs supports asynchronous deletion of jobs.",
      "pos": [
        27501,
        27562
      ]
    },
    {
      "content": "A job can be marked for deletion and the system will delete the job and all its job history after all job executions have completed for the job.",
      "pos": [
        27563,
        27707
      ]
    },
    {
      "content": "The system will not automatically cancel active job executions.",
      "pos": [
        27708,
        27771
      ]
    },
    {
      "content": "Instead, Stop-AzureSqlJobExecution must be invoked to cancel active job executions.",
      "pos": [
        27775,
        27858
      ]
    },
    {
      "pos": [
        27860,
        27957
      ],
      "content": "To trigger job deletion, use the <bpt id=\"p1\">**</bpt>Remove-AzureSqlJob<ept id=\"p1\">**</ept> cmdlet and set the <bpt id=\"p2\">**</bpt>JobName<ept id=\"p2\">**</ept> parameter."
    },
    {
      "content": "Create a custom database target",
      "pos": [
        28033,
        28064
      ]
    },
    {
      "content": "Custom database targets can be defined in Elastic Database jobs which can be used either for execution directly or for inclusion within a custom database group.",
      "pos": [
        28065,
        28225
      ]
    },
    {
      "content": "Since <bpt id=\"p1\">**</bpt>Elastic Database pools<ept id=\"p1\">**</ept> are not yet directly supported via the PowerShell APIs, you simply create a custom database target and custom database collection target which encompasses all the databases in the pool.",
      "pos": [
        28226,
        28444
      ]
    },
    {
      "content": "Set the following variables to reflect the desired database information:",
      "pos": [
        28446,
        28518
      ]
    },
    {
      "content": "Create a custom database collection target",
      "pos": [
        28699,
        28741
      ]
    },
    {
      "content": "A custom database collection target can be defined to enable execution across multiple defined database targets.",
      "pos": [
        28742,
        28854
      ]
    },
    {
      "content": "After a database group is created, databases can be associated to the custom collection target.",
      "pos": [
        28855,
        28950
      ]
    },
    {
      "content": "Set the following variables to reflect the desired custom collection target configuration:",
      "pos": [
        28952,
        29042
      ]
    },
    {
      "content": "Add databases to a custom database collection target",
      "pos": [
        29184,
        29236
      ]
    },
    {
      "content": "Database targets can be associated with custom database collection targets to create a group of databases.",
      "pos": [
        29238,
        29344
      ]
    },
    {
      "content": "Whenever a job is created that targets a custom database collection target, it will be expanded to target the databases associated to the group at the time of execution.",
      "pos": [
        29345,
        29514
      ]
    },
    {
      "content": "Add the desired database to a specific custom collection:",
      "pos": [
        29516,
        29573
      ]
    },
    {
      "content": "Review the databases within a custom database collection target",
      "pos": [
        29862,
        29925
      ]
    },
    {
      "pos": [
        29927,
        30043
      ],
      "content": "Use the <bpt id=\"p1\">**</bpt>Get-AzureSqlJobTarget<ept id=\"p1\">**</ept> cmdlet to retrieve the child databases within a custom database collection target."
    },
    {
      "content": "Create a job to execute a script across a custom database collection target",
      "pos": [
        30302,
        30377
      ]
    },
    {
      "content": "Use the <bpt id=\"p1\">**</bpt>New-AzureSqlJob<ept id=\"p1\">**</ept> cmdlet to create a job against a group of databases defined by a custom database collection target.",
      "pos": [
        30379,
        30506
      ]
    },
    {
      "content": "Elastic Database jobs will expand the job into multiple child jobs each corresponding to a database associated with the custom database collection target and ensure that the script is executed against each database.",
      "pos": [
        30507,
        30722
      ]
    },
    {
      "content": "Again, it is important that scripts are idempotent to be resilient to retries.",
      "pos": [
        30723,
        30801
      ]
    },
    {
      "content": "Data collection across databases",
      "pos": [
        31197,
        31229
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Elastic Database jobs<ept id=\"p1\">**</ept> supports executing a query across a group of databases and sends the results to a specified database’s table.",
      "pos": [
        31231,
        31366
      ]
    },
    {
      "content": "The table can be queried after the fact to see the query’s results from each database.",
      "pos": [
        31367,
        31453
      ]
    },
    {
      "content": "This provides an asynchronous mechanism to execute a query across many databases.",
      "pos": [
        31454,
        31535
      ]
    },
    {
      "content": "Failure cases such as one of the databases being temporarily unavailable are handled automatically via retries.",
      "pos": [
        31536,
        31647
      ]
    },
    {
      "content": "The specified destination table will be automatically created if it does not yet exist matching the schema of the returned result set.",
      "pos": [
        31649,
        31783
      ]
    },
    {
      "content": "If a script execution returns multiple result sets, Elastic Database jobs will only send the first one to the provided destination table.",
      "pos": [
        31784,
        31921
      ]
    },
    {
      "content": "The following PowerShell script can be used to execute a script collecting its results into a specified table.",
      "pos": [
        31923,
        32033
      ]
    },
    {
      "content": "This script assumes that a T-SQL script has been created which outputs a single result set and a custom database collection target has been created.",
      "pos": [
        32034,
        32182
      ]
    },
    {
      "content": "Set the following to reflect the desired script, credentials, and execution target:",
      "pos": [
        32184,
        32267
      ]
    },
    {
      "content": "Create and start a job for data collection scenarios",
      "pos": [
        32827,
        32879
      ]
    },
    {
      "content": "Create a schedule for job execution using a job trigger",
      "pos": [
        33425,
        33480
      ]
    },
    {
      "content": "The following PowerShell script can be used to create a reoccurring schedule.",
      "pos": [
        33482,
        33559
      ]
    },
    {
      "content": "This script uses a minute interval, but New-AzureSqlJobSchedule also supports -DayInterval, -HourInterval, -MonthInterval, and -WeekInterval parameters.",
      "pos": [
        33560,
        33712
      ]
    },
    {
      "content": "Schedules that execute only once can be created by passing -OneTime.",
      "pos": [
        33713,
        33781
      ]
    },
    {
      "content": "Create a new schedule:",
      "pos": [
        33783,
        33805
      ]
    },
    {
      "content": "Create a job trigger to have a job executed on a time schedule",
      "pos": [
        34071,
        34133
      ]
    },
    {
      "content": "A job trigger can be defined to have a job executed according to a time schedule.",
      "pos": [
        34135,
        34216
      ]
    },
    {
      "content": "The following PowerShell script can be used to create a job trigger.",
      "pos": [
        34217,
        34285
      ]
    },
    {
      "content": "Set the following variables to correspond to the desired job and schedule:",
      "pos": [
        34287,
        34361
      ]
    },
    {
      "content": "Remove a scheduled association to stop job from executing on schedule",
      "pos": [
        34550,
        34619
      ]
    },
    {
      "content": "To discontinue reoccurring job execution through a job trigger, the job trigger can be removed.",
      "pos": [
        34621,
        34716
      ]
    },
    {
      "content": "Remove a job trigger to stop a job from being executed according to a schedule using the <bpt id=\"p1\">**</bpt>Remove-AzureSqlJobTrigger<ept id=\"p1\">**</ept> cmdlet.",
      "pos": [
        34718,
        34844
      ]
    },
    {
      "content": "Retrieve job triggers bound to a time schedule",
      "pos": [
        34993,
        35039
      ]
    },
    {
      "content": "The following PowerShell script can be used to obtain and display the job triggers registered to a particular time schedule.",
      "pos": [
        35041,
        35165
      ]
    },
    {
      "content": "Retrieve job triggers bound to a job",
      "pos": [
        35310,
        35346
      ]
    },
    {
      "content": "The following PowerShell script can be used to obtain and display schedules containing a registered job.",
      "pos": [
        35349,
        35453
      ]
    },
    {
      "content": "Create a Data-tier Application Deployment (DACPAC) for execution across databases",
      "pos": [
        35577,
        35658
      ]
    },
    {
      "content": "Elastic Database jobs can be used to deploy a data-tier application (DACPAC) to a group of databases.",
      "pos": [
        35660,
        35761
      ]
    },
    {
      "content": "To create a DACPAC, please refer to this documentation.",
      "pos": [
        35762,
        35817
      ]
    },
    {
      "content": "For Elastic Database Jobs to deploy a DACPAC to a group of databases, the DACPAC must be accessible to the service.",
      "pos": [
        35819,
        35934
      ]
    },
    {
      "content": "It is recommended to upload a created DACPAC to Azure Storage and create a signed URI for the DACPAC.",
      "pos": [
        35935,
        36036
      ]
    },
    {
      "content": "The following PowerShell script can be used to insert a DACPAC into Elastic Database Jobs:",
      "pos": [
        36038,
        36128
      ]
    },
    {
      "content": "Updating a Data-tier Application Deployment (DACPAC) for execution across databases",
      "pos": [
        36304,
        36387
      ]
    },
    {
      "content": "Existing DACPACs registered within Elastic Database Jobs can be updated to point to new URIs.",
      "pos": [
        36389,
        36482
      ]
    },
    {
      "content": "The following PowerShell script can be used to update the DACPAC URI on an existing registered DACPAC:",
      "pos": [
        36483,
        36585
      ]
    },
    {
      "content": "Create a Job to Apply a Data-tier Application Deployment (DACPAC) across databases",
      "pos": [
        36788,
        36870
      ]
    },
    {
      "content": "After a DACPAC has been created within Elastic Database Jobs, a job can be created to apply the DACPAC across a group of databases.",
      "pos": [
        36872,
        37003
      ]
    },
    {
      "content": "The following PowerShell script can be used to create a DACPAC job across a custom collection of databases:",
      "pos": [
        37005,
        37112
      ]
    }
  ],
  "content": "<properties \n    title=\"Elastic database jobs overview\" \n    pageTitle=\"Elastic database jobs overview\" \n    description=\"Illustrates the elastic database job service\" \n    metaKeywords=\"azure sql database elastic databases\" \n    services=\"sql-database\" documentationCenter=\"\"  \n    manager=\"jeffreyg\" \n    authors=\"ddove\"/>\n\n<tags \n    ms.service=\"sql-database\" \n    ms.workload=\"sql-database\" \n    ms.tgt_pltfrm=\"na\" \n    ms.devlang=\"na\" \n    ms.topic=\"article\" \n    ms.date=\"08/04/2015\" \n    ms.author=\"ddove; sidneyh\" />\n\n# Create and manage a SQL Database elastic database jobs using PowerShell (preview)\n\n> [AZURE.SELECTOR]\n- [Azure portal](sql-database-elastic-jobs-create-and-manage.md)\n- [PowerShell](sql-database-elastic-jobs-powershell.md)\n\n## Overview\n\nThe **Elastic Database jobs** feature (preview) enables you to  reliably execute a Transact-SQL (T-SQL) script or apply a DACPAC across a group of databases including a custom-defined collection of databases, all databases in an [Elastic Database pool (preview)](sql-database-elastic-pool.md) or a shard set (created using [Elastic Database client library](sql-database-elastic-database-client-library.md)). While in preview, **Elastic Database jobs** is currently a customer-hosted Azure Cloud Service that enables the execution of ad-hoc and scheduled administrative tasks, which are called jobs. Using this feature, you can easily and reliably manage large numbers of Azure SQL Databases at scale by running Transact-SQL scripts to perform administrative operations such as schema changes, credentials management, reference data updates, performance data collection or tenant (customer) telemetry collection. For more information about Elastic Database jobs, see [Elastic Database jobs overview](sql-database-elastic-jobs-overview.md).\n\nWith the PowerShell APIs for **Elastic Database jobs**, you have flexibility to define which group of databases against which scripts will execute. Currently, **Elastic Database jobs** functionality via the Azure portal has reduced feature set and is limited to execution against Elastic Database pools.\n\n**Elastic Database jobs** (preview) uses multiple Azure components to define the jobs to be performed, define when to perform the jobs, execute the jobs, track the success or failure of the jobs and optionally specify a results destination for results returning queries. Since the Powershell APIs included in this preview contain additional functionality since the initial preview via the Portal, it is suggested you install the latest **Elastic Database jobs** components. If already installed, you can simply upgrade the **Elastic Database jobs** components. For more information about installation from [Nuget](https://www.nuget.org/packages/Microsoft.Azure.SqlDatabase.Jobs), see [Install the Elastic Database jobs components](sql-database-elastic-jobs-service-installation.md). \n\nThis article will show you how to create everything you need to create and manage **Elastic Database jobs**, except for the Azure subscription. If you need an Azure subscription, simply click FREE TRIAL at the top of this page, and then come back to finish this article. This topic extends on the sample found in [Getting started with Elastic Database tools](sql-database-elastic-scale-get-started.md). When completed, you will learn how to create and manage jobs to perform administrative operations against a group of sharded databases defined by a **shard set** and alternatively custom-collection of databases.\n\n## Prerequisites\n* An Azure subscription. For a free trial, see [Free one-month trial](http://azure.microsoft.com/pricing/free-trial/).\n* **Elastic Database jobs** PowerShell package must first be downloaded, imported and the Elastic Database jobs components installed. Follow these steps: [Installing Elastic Database jobs](sql-database-elastic-jobs-service-installation.md)\n* Azure PowerShell version >= 0.8.16. Install the latest version (0.9.5) through the [Web Platform Installer](http://go.microsoft.com/fwlink/p/?linkid=320376). For detailed information, see [How to install and configure Azure PowerShell](powershell-install-configure.md).\n\n### Select your Azure subscription\n\nTo select the subscription you need your subscription Id (**-SubscriptionId**) or subscription name (**-SubscriptionName**). If you have multiple subscriptions you can run the **Get-AzureSubscription** cmdlet and copy the desired subscription information from the result set. Once you have your subscription information, run the following commandlet to set this subscription as the default, namely the target for creating and managing jobs:\n\n    Select-AzureSubscription -SubscriptionId {SubscriptionID}\n\nThe [PowerShell ISE](https://technet.microsoft.com/library/dd315244.aspx) is recommended for usage to develop and execute PowerShell scripts against the Elastic Database jobs.\n\n## Elastic Database jobs objects\n\nThe following table lists out all the object types of **Elastic Database jobs** along with its description and relevant PowerShell APIs.\n\n<table style=\"width:100%\">\n  <tr>\n    <th>Object Type</th>\n    <th>Description</th>\n    <th>Related PowerShell APIs</th>\n  </tr>\n  <tr>\n    <td>Credential</td>\n    <td>Username and password to use when connecting to databases for execution of scripts or application of DACPACs. <p>The password is encrypted before sending to and storing in the Elastic Database Jobs database.  The password is decrypted by the Elastic Database Jobs service via the credential created and uploaded from the installation script.</td>\n    <td><p>Get-AzureSqlJobCredential</p>\n    <p>New-AzureSqlJobCredential</p><p>Set-AzureSqlJobCredential</p></td></td>\n  </tr>\n\n  <tr>\n    <td>Script</td>\n    <td>Transact-SQL script to be used for execution across databases.  The script should be authored to be idempotent since the service will retry execution of the script upon failures.\n    </td>\n    <td>\n    <p>Get-AzureSqlJobContent</p>\n    <p>Get-AzureSqlJobContentDefinition</p>\n    <p>New-AzureSqlJobContent</p>\n    <p>Set-AzureSqlJobContentDefinition</p>\n    </td>\n  </tr>\n\n  <tr>\n    <td>DACPAC</td>\n    <td><a href=\"https://msdn.microsoft.com/library/ee210546.aspx\">Data-tier application </a> package to be applied across databases.\n\n    </td>\n    <td>\n    <p>Get-AzureSqlJobContent</p>\n    <p>New-AzureSqlJobContent</p>\n    <p>Set-AzureSqlJobContentDefinition</p>\n    </td>\n  </tr>\n  <tr>\n    <td>Database Target</td>\n    <td>Database and server name pointing to an Azure SQL Database.\n\n    </td>\n    <td>\n    <p>Get-AzureSqlJobTarget</p>\n    <p>New-AzureSqlJobTarget</p>\n    </td>\n  </tr>\n  <tr>\n    <td>Shard Map Target</td>\n    <td>Combination of a database target and a credential to be used to determine information stored within an Elastic Database shard map.\n    </td>\n    <td>\n    <p>Get-AzureSqlJobTarget</p>\n    <p>New-AzureSqlJobTarget</p>\n    <p>Set-AzureSqlJobTarget</p>\n    </td>\n  </tr>\n<tr>\n    <td>Custom Collection Target</td>\n    <td>Defined group of databases to collectively use for execution.</td>\n    <td>\n    <p>Get-AzureSqlJobTarget</p>\n    <p>New-AzureSqlJobTarget</p>\n    </td>\n  </tr>\n<tr>\n    <td>Custom Collection Child Target</td>\n    <td>Database target that is referenced from a custom collection.</td>\n    <td>\n    <p>Add-AzureSqlJobChildTarget</p>\n    <p>Remove-AzureSqlJobChildTarget</p>\n    </td>\n  </tr>\n\n<tr>\n    <td>Job</td>\n    <td>\n    <p>Definition of parameters for a job that can be used to trigger execution or to fulfill a schedule.</p>\n    </td>\n    <td>\n    <p>Get-AzureSqlJob</p>\n    <p>New-AzureSqlJob</p>\n    <p>Set-AzureSqlJob</p>\n    </td>\n  </tr>\n\n<tr>\n    <td>Job Execution</td>\n    <td>\n    <p>Container of tasks necessary to fulfill either executing a script or applying a DACPAC to a target using credentials for database connections with failures handled in accordance to an execution policy.</p>\n    </td>\n    <td>\n    <p>Get-AzureSqlJobExecution</p>\n    <p>Start-AzureSqlJobExecution</p>\n    <p>Stop-AzureSqlJobExecution</p>\n    <p>Wait-AzureSqlJobExecution</p>\n  </tr>\n\n<tr>\n    <td>Job Task Execution</td>\n    <td>\n    <p>Single unit of work to fulfill a job.</p>\n    <p>If a job task is not able to successfully execute, the resulting exception message will be logged and a new matching job task will be created and executed in accordance to the specified execution policy.</p></p>\n    </td>\n    <td>\n    <p>Get-AzureSqlJobExecution</p>\n    <p>Start-AzureSqlJobExecution</p>\n    <p>Stop-AzureSqlJobExecution</p>\n    <p>Wait-AzureSqlJobExecution</p>\n  </tr>\n\n<tr>\n    <td>Job Execution Policy</td>\n    <td>\n    <p>Controls job execution timeouts, retry limits and intervals between retries.</p>\n    <p>Elastic Database jobs includes a default job execution policy which cause essentially infinite retries of job task failures with exponential backoff of intervals between each retry.</p>\n    </td>\n    <td>\n    <p>Get-AzureSqlJobExecutionPolicy</p>\n    <p>New-AzureSqlJobExecutionPolicy</p>\n    <p>Set-AzureSqlJobExecutionPolicy</p>\n    </td>\n  </tr>\n\n<tr>\n    <td>Schedule</td>\n    <td>\n    <p>Time based specification for execution to take place either on a reoccurring interval or at a single time.</p>\n    </td>\n    <td>\n    <p>Get-AzureSqlJobSchedule</p>\n    <p>New-AzureSqlJobSchedule</p>\n    <p>Set-AzureSqlJobSchedule</p>\n    </td>\n  </tr>\n\n<tr>\n    <td>Job Triggers</td>\n    <td>\n    <p>A mapping between a job and a schedule to trigger job execution according to the schedule.</p>\n    </td>\n    <td>\n    <p>New-AzureSqlJobTrigger</p>\n    <p>Remove-AzureSqlJobTrigger</p>\n    </td>\n  </tr>\n</table>\n\n## Supported Elastic Database jobs group types\n**Elastic Database jobs** enables execution of Transact-SQL (T-SQL) scripts or application of DACPACs across a group of databases. When a job is submitted to be executed across a group of databases, Elastic Database jobs will “expand” the job into child jobs where each which job performs the requested execution against a single database in the group.\n \nThe following is a list of current supported group types:\n\n* [Shard Map](sql-database-elastic-scale-shard-map-management.md): When a job is submitted to target a shard map, jobs will first query the shard map to determine its current set of shards and then expand the job to child jobs matching each shard within the shard map.\n* Custom Collection: Specified to point to a custom defined set of databases. When a job is submitted to target a custom collection, jobs will expand the job to child jobs matching each database currently defined within the custom collection.\n\n## Setting the Elastic Database jobs connection\nAfter loading the PowerShell module, the connection needs to be set to the Elastic Database jobs *Control Database* prior to using the jobs APIs. Invocation of this cmdlet will trigger a credential window to pop up requesting the user name/password supplied when installing Elastic Database jobs. All examples provided within this topic assume that this first step has already been performed.\n\nOpen a connection to the Elastic Database jobs:\n\n    Use-AzureSqlJobConnection -CurrentAzureSubscription \n\n## Encrypted credentials within the Elastic Database jobs\nDatabase credentials can be inserted into Elastic Database jobs *Control Database*  with its password encrypted. It is necessary to store credentials to enable jobs to be executed at a later time, including using job schedules.\n \nEncryption works through a certificate created as part of the installation script. The installation script creates and uploads the certificate into the Azure Cloud Service for decryption of the stored encrypted passwords. The Azure Cloud Service later stores the public key within the Elastic Database jobs *Control Database* which enables the PowerShell API or Azure portal interface to encrypt a provided password without requiring the certificate to be locally installed.\n \nWhile the credential passwords are encrypted and secure from users with read-only access to Elastic Database jobs objects, it is possible for a malicious user with read-write access to Elastic Database Jobs objects to extract out a password. Credentials are designed to be reused across job executions. Credentials are passed to target databases when establishing connections. There are currently not any restrictions on the target databases used for each credential so it is possible for a malicious user to add a database target for a database in their control and subsequently start a job targeting this database to gain knowledge of the credential's password.\n\nThere are security best practices for Elastic Database jobs:\n\n* Limit usage of the APIs to trusted individuals.\n* Credentials should have the least privileges necessary to perform the job task.  More information can be seen within this [Authorization and Permissions](https://msdn.microsoft.com/library/bb669084.aspx) SQL Server MSDN article.\n\n### Creating an encrypted credential for job execution across databases\nTo create a new encrypted credential, the Get-Credential cmdlet will prompt for a user name and password that can be passed to the **New-AzureSqlJobCredential** cmdlet.\n\n    $credentialName = \"{Credential Name}\"\n    $databaseCredential = Get-Credential\n    $credential = New-AzureSqlJobCredential -Credential $databaseCredential -CredentialName $credentialName\n    Write-Output $credential\n\n### Updating Credentials\nTo update an existing credential to support the case when passwords change, use the **Set-AzureSqlJobCredential** cmdlet and set the **CredentialName** parameter.\n\n    $credentialName = \"{Credential Name}\"\n    Set-AzureSqlJobCredential -CredentialName $credentialName -Credential $credential \n\n## Defining an Elastic Database Shard Map Target\nExecute a job against all databases in a shard set (created using [Elastic Database client library](sql-database-elastic-database-client-library.md)) using a shard map as the database target. This example is dependent on you creating a sharded application using the Elastic Database client library. Download and run the [Getting started with Elastic Database tools sample](sql-database-elastic-scale-get-started.md).\n\n###Create a shard map manager using the sample app\n\nHere you will create a shard map manager along with several shards, followed by insertion of data into the shards. If you happen to already have shards setup, you can skip the following steps and move to the next section.\n\n1. Build and run the **Getting started with Elastic Database tools** sample application. Follow the steps until step 7 in the section [Download and run the sample app](sql-database-elastic-scale-get-started.md#Getting-started-with-elastic-database-tools). At the end of Step 7, you will see the following command prompt:\n\n    ![command prompt][1]\n\n2.  In the command window, type \"1\" and press **Enter**. This creates the shard map manager, and adds two shards to the server. Then type \"3\" and press **Enter**; repeat the action four times. This inserts sample data rows in your shards.\n  \n3.  The [Azure preview portal](https://portal.azure.com) should show three new databases in your v12 server:\n\n    ![Visual Studio confirmation][2]\n\nNow create a shard map target, using the **New-AzureSqlJobTarget** cmdlet. The shard map manager database must be set as a database target and then the specific shard map is specified as a target.\n\n    $shardMapCredentialName = \"{Credential Name}\"\n    $shardMapDatabaseName = \"{ShardMapDatabaseName}\" #example: ElasticScaleStarterKit_ShardMapManagerDb\n    $shardMapDatabaseServerName = \"{ShardMapServerName}\"\n    $shardMapName = \"{MyShardMap}\" #example: CustomerIDShardMap\n    $shardMapDatabaseTarget = New-AzureSqlJobTarget -DatabaseName $shardMapDatabaseName -ServerName $shardMapDatabaseServerName\n    $shardMapTarget = New-AzureSqlJobTarget -ShardMapManagerCredentialName $shardMapCredentialName -ShardMapManagerDatabaseName $shardMapDatabaseName -ShardMapManagerServerName $shardMapDatabaseServerName -ShardMapName $shardMapName\n    Write-Output $shardMapTarget\n\n## Create a T-SQL Script for execution across databases\n\nWhen creating T-SQL scripts for execution, it is highly recommended to build them to be idempotent and resilient against failures. Elastic Database jobs will retry execution of a script whenever execution encounters a failure, regardless of the classification of the failure.\n\nUse the **New-AzureSqlJobContent** cmdlet to create and save a script for execution and set the **-ContentName** and **-CommandText** parameters.\n\n    $scriptName = \"Create a TestTable\"\n\n    $scriptCommandText = \"\n    IF NOT EXISTS (SELECT name FROM sys.tables WHERE name = 'TestTable')\n    BEGIN\n        CREATE TABLE TestTable(\n            TestTableId INT PRIMARY KEY IDENTITY,\n            InsertionTime DATETIME2\n        );\n    END\n    GO\n    INSERT INTO TestTable(InsertionTime) VALUES (sysutcdatetime());\n    GO\"\n\n    $script = New-AzureSqlJobContent -ContentName $scriptName -CommandText $scriptCommandText\n    Write-Output $script\n\n### Create a new script from a file\nIf the T-SQL script is defined within a file, the following script could be used to import the script:\n\n    $scriptName = \"My Script Imported from a File\"\n    $scriptPath = \"{Path to SQL File}\"\n    $scriptCommandText = Get-Content -Path $scriptPath\n    $script = New-AzureSqlJobContent -ContentName $scriptName -CommandText $scriptCommandText\n    Write-Output $script\n\n### Update a T-SQL Script for Execution across Databases  \n\nThe following PowerShell script can be used to update the T-SQL command text for an existing script.\n\nSet the following variables to reflect the desired script definition to be set:\n\n    $scriptName = \"Create a TestTable\"\n    $scriptUpdateComment = \"Adding AdditionalInformation column to TestTable\"\n    $scriptCommandText = \"\n    IF NOT EXISTS (SELECT name FROM sys.tables WHERE name = 'TestTable')\n    BEGIN\n    CREATE TABLE TestTable(\n        TestTableId INT PRIMARY KEY IDENTITY,\n        InsertionTime DATETIME2\n    );\n    END\n    GO\n\n    IF NOT EXISTS (SELECT columns.name FROM sys.columns INNER JOIN sys.tables on columns.object_id = tables.object_id WHERE tables.name = 'TestTable' AND columns.name = 'AdditionalInformation')\n    BEGIN\n    ALTER TABLE TestTable\n    ADD AdditionalInformation NVARCHAR(400);\n    END\n    GO\n\n    INSERT INTO TestTable(InsertionTime, AdditionalInformation) VALUES (sysutcdatetime(), 'test');\n    GO\"\n\n### Update the definition to an existing script\n\n    Set-AzureSqlJobContentDefinition -ContentName $scriptName -CommandText $scriptCommandText -Comment $scriptUpdateComment \n\n##Create a Job to execute a script across an shard map\n\nThe following PowerShell script can be used to start a job for execution of a script across each shard in an Elastic Scale shard map.\n\nSet the following variables to reflect the desired script and target:\n\n    $jobName = \"{Job Name}\"\n    $scriptName = \"{Script Name}\"\n    $shardMapServerName = \"{Shard Map Server Name}\"\n    $shardMapDatabaseName = \"{Shard Map Database Name}\"\n    $shardMapName = \"{Shard Map Name}\"\n    $credentialName = \"{Credential Name}\"\n    $shardMapTarget = Get-AzureSqlJobTarget -ShardMapManagerDatabaseName $shardMapDatabaseName -ShardMapManagerServerName $shardMapServerName -ShardMapName $shardMapName \n    $job = New-AzureSqlJob -ContentName $scriptName -CredentialName $credentialName -JobName $jobName -TargetId $shardMapTarget.TargetId\n    Write-Output $job\n\n##Execute a job \n\nThe following PowerShell script can be used to execute an existing job:\n\nUpdate the following variable to reflect the desired job name to have executed:\n\n    $jobName = \"{Job Name}\"\n    $jobExecution = Start-AzureSqlJobExecution -JobName $jobName \n    Write-Output $jobExecution\n \n## Retrieve the state of a single job execution\n\nUse the **Get-AzureSqlJobExecution** cmdlets and set the **JobExecutionId** parameter to view the state of job execution.\n\n    $jobExecutionId = \"{Job Execution Id}\"\n    $jobExecution = Get-AzureSqlJobExecution -JobExecutionId $jobExecutionId\n    Write-Output $jobExecution\n\nUse the same **Get-AzureSqlJobExecution** cmdlet with the **IncludeChildren** parameter to view the state of child job executions, namely the specific state for each job execution against each database targeted by the job.\n\n    $jobExecutionId = \"{Job Execution Id}\"\n    $jobExecutions = Get-AzureSqlJobExecution -JobExecutionId $jobExecutionId -IncludeChildren\n    Write-Output $jobExecutions \n\n## View the state across multiple job executions\n\nThe **Get-AzureSqlJobExecution** cmdlet has multiple optional parameters that can be used to display multiple job executions, filtered through the provided parameters. The following demonstrates some of the possible ways to use Get-AzureSqlJobExecution:\n\nRetrieve all active top level job executions:\n\n    Get-AzureSqlJobExecution\n\nRetrieve all top level job executions, including inactive job executions:\n\n    Get-AzureSqlJobExecution -IncludeInactive\n\nRetrieve all child job executions of a provided job execution ID, including inactive job executions:\n\n    $parentJobExecutionId = \"{Job Execution Id}\"\n    Get-AzureSqlJobExecution -AzureSqlJobExecution -JobExecutionId $parentJobExecutionId –IncludeInactive -IncludeChildren\n\nRetrieve all job executions created using a schedule / job combination, including inactive jobs:\n\n    $jobName = \"{Job Name}\"\n    $scheduleName = \"{Schedule Name}\"\n    Get-AzureSqlJobExecution -JobName $jobName -ScheduleName $scheduleName -IncludeInactive\n\nRetrieve all jobs targeting a specified shard map, including inactive jobs:\n\n    $shardMapServerName = \"{Shard Map Server Name}\"\n    $shardMapDatabaseName = \"{Shard Map Database Name}\"\n    $shardMapName = \"{Shard Map Name}\"\n    $target = Get-AzureSqlJobTarget -ShardMapManagerDatabaseName $shardMapDatabaseName -ShardMapManagerServerName $shardMapServerName -ShardMapName $shardMapName\n    Get-AzureSqlJobExecution -TargetId $target.TargetId –IncludeInactive\n\nRetrieve all jobs targeting a specified custom collection, including inactive jobs:\n\n    $customCollectionName = \"{Custom Collection Name}\"\n    $target = Get-AzureSqlJobTarget -CustomCollectionName $customCollectionName\n    Get-AzureSqlJobExecution -TargetId $target.TargetId –IncludeInactive\n \nRetrieve the list of job task executions within a specific job execution:\n\n    $jobExecutionId = \"{Job Execution Id}\"\n    $jobTaskExecutions = Get-AzureSqlJobTaskExecution -JobExecutionId $jobExecutionId\n    Write-Output $jobTaskExecutions \n\nRetrieve job task execution details:\n\nThe following PowerShell script can be used to view the details of a job task execution, which is particularly useful when debugging execution failures.\n\n    $jobTaskExecutionId = \"{Job Task Execution Id}\"\n    $jobTaskExecution = Get-AzureSqlJobTaskExecution -JobTaskExecutionId $jobTaskExecutionId\n    Write-Output $jobTaskExecution\n\n## Retrieve failures within job task executions\n\nThe JobTaskExecution object includes a property for the Lifecycle of the task along with a Message property. If a job task execution failed, the Lifecycle property will be set to *Failed* and the Message property will be set to the resulting exception message and its stack. If a job did not succeed, it is important to view the details of job tasks that did not succeed for a given job.\n\n    $jobExecutionId = \"{Job Execution Id}\"\n    $jobTaskExecutions = Get-AzureSqlJobTaskExecution -JobExecutionId $jobExecutionId\n    Foreach($jobTaskExecution in $jobTaskExecutions) \n        {\n        if($jobTaskExecution.Lifecycle -ne 'Succeeded')\n            {\n            Write-Output $jobTaskExecution\n            }\n        }\n\n## Waiting for a job execution to complete\n\nThe following PowerShell script can be used to wait for a job task to complete:\n\n    $jobExecutionId = \"{Job Execution Id}\"\n    Wait-AzureSqlJobExecution -JobExecutionId $jobExecutionId \n\n## Create a custom execution policy\n\nElastic Database jobs supports creating custom execution policies that can be applied when starting jobs.\n  \nExecution policies currently allow for defining:\n\n* Name: Identifier for the execution policy.\n* Job Timeout: Total time before a job will be canceled by Elastic Database Jobs.\n* Initial Retry Interval: Interval to wait before first retry.\n* Maximum Retry Interval: Cap of retry intervals to use.\n* Retry Interval Backoff Coefficient: Coefficient used to calculate the next interval between retries.  The following formula is used: (Initial Retry Interval) * Math.pow((Interval Backoff Coefficient), (Number of Retries) - 2). \n* Maximum Attempts: The maximum number of retry attempts to perform within a job.\n\nThe default execution policy uses the following values:\n\n* Name: Default execution policy\n* Job Timeout: 1 week\n* Initial Retry Interval:  100 milliseconds\n* Maximum Retry Interval: 30 minutes\n* Retry Interval Coefficient: 2\n* Maximum Attempts: 2,147,483,647\n\nCreate the desired execution policy:\n\n    $executionPolicyName = \"{Execution Policy Name}\"\n    $initialRetryInterval = New-TimeSpan -Seconds 10\n    $jobTimeout = New-TimeSpan -Minutes 30\n    $maximumAttempts = 999999\n    $maximumRetryInterval = New-TimeSpan -Minutes 1\n    $retryIntervalBackoffCoefficient = 1.5\n    $executionPolicy = New-AzureSqlJobExecutionPolicy -ExecutionPolicyName $executionPolicyName -InitialRetryInterval $initialRetryInterval -JobTimeout $jobTimeout -MaximumAttempts $maximumAttempts -MaximumRetryInterval $maximumRetryInterval -RetryIntervalBackoffCoefficient $retryIntervalBackoffCoefficient\n    Write-Output $executionPolicy\n\n### Update a custom execution policy\n\nUpdate the desired execution policy to update:\n\n    $executionPolicyName = \"{Execution Policy Name}\"\n    $initialRetryInterval = New-TimeSpan -Seconds 15\n    $jobTimeout = New-TimeSpan -Minutes 30\n    $maximumAttempts = 999999\n    $maximumRetryInterval = New-TimeSpan -Minutes 1\n    $retryIntervalBackoffCoefficient = 1.5\n    $updatedExecutionPolicy = Set-AzureSqlJobExecutionPolicy -ExecutionPolicyName $executionPolicyName -InitialRetryInterval $initialRetryInterval -JobTimeout $jobTimeout -MaximumAttempts $maximumAttempts -MaximumRetryInterval $maximumRetryInterval -RetryIntervalBackoffCoefficient $retryIntervalBackoffCoefficient\n    Write-Output $updatedExecutionPolicy\n \n## Cancel a job\n\nElastic Database Jobs supports cancellation requests of jobs.  If Elastic Database Jobs detects a cancellation request for a job currently being executed, it will attempt to stop the job.\n\nThere are two different ways that Elastic Database Jobs can perform a cancellation:\n\n1. Canceling Currently Executing Tasks: If a cancellation is detected while a task is currently running, a cancellation will be attempted within the currently executing aspect of the task.  For example: If there is a long running query currently being performed when a cancellation is attempted, there will be an attempt to cancel the query.\n2. Canceling Task Retries: If a cancellation is detected by the control thread before a task is launched for execution, the control thread will avoid launching the task and declare the request as canceled.\n\nIf a job cancellation is requested for a parent job, the cancellation request will be honored for the parent job and for all of its child jobs.\n \nTo submit a cancellation request, use the **Stop-AzureSqlJobExecution** cmdlet and set the **JobExecutionId** parameter.\n\n    $jobExecutionId = \"{Job Execution Id}\"\n    Stop-AzureSqlJobExecution -JobExecutionId $jobExecutionId\n\n## Delete a job by name and the job's history\n\nElastic Database jobs supports asynchronous deletion of jobs. A job can be marked for deletion and the system will delete the job and all its job history after all job executions have completed for the job. The system will not automatically cancel active job executions.  \n\nInstead, Stop-AzureSqlJobExecution must be invoked to cancel active job executions.\n\nTo trigger job deletion, use the **Remove-AzureSqlJob** cmdlet and set the **JobName** parameter.\n\n    $jobName = \"{Job Name}\"\n    Remove-AzureSqlJob -JobName $jobName\n \n## Create a custom database target\nCustom database targets can be defined in Elastic Database jobs which can be used either for execution directly or for inclusion within a custom database group. Since **Elastic Database pools** are not yet directly supported via the PowerShell APIs, you simply create a custom database target and custom database collection target which encompasses all the databases in the pool.\n\nSet the following variables to reflect the desired database information:\n\n    $databaseName = \"{Database Name}\"\n    $databaseServerName = \"{Server Name}\"\n    New-AzureSqlJobDatabaseTarget -DatabaseName $databaseName -ServerName $databaseServerName \n\n## Create a custom database collection target\nA custom database collection target can be defined to enable execution across multiple defined database targets. After a database group is created, databases can be associated to the custom collection target.\n\nSet the following variables to reflect the desired custom collection target configuration:\n\n    $customCollectionName = \"{Custom Database Collection Name}\"\n    New-AzureSqlJobTarget -CustomCollectionName $customCollectionName \n\n### Add databases to a custom database collection target\n\nDatabase targets can be associated with custom database collection targets to create a group of databases. Whenever a job is created that targets a custom database collection target, it will be expanded to target the databases associated to the group at the time of execution.\n\nAdd the desired database to a specific custom collection:\n\n    $serverName = \"{Database Server Name}\"\n    $databaseName = \"{Database Name}\"\n    $customCollectionName = \"{Custom Database Collection Name}\"\n    Add-AzureSqlJobChildTarget -CustomCollectionName $customCollectionName -DatabaseName $databaseName -ServerName $databaseServerName \n\n#### Review the databases within a custom database collection target\n\nUse the **Get-AzureSqlJobTarget** cmdlet to retrieve the child databases within a custom database collection target. \n \n    $customCollectionName = \"{Custom Database Collection Name}\"\n    $target = Get-AzureSqlJobTarget -CustomCollectionName $customCollectionName\n    $childTargets = Get-AzureSqlJobTarget -ParentTargetId $target.TargetId\n    Write-Output $childTargets\n\n### Create a job to execute a script across a custom database collection target\n\nUse the **New-AzureSqlJob** cmdlet to create a job against a group of databases defined by a custom database collection target. Elastic Database jobs will expand the job into multiple child jobs each corresponding to a database associated with the custom database collection target and ensure that the script is executed against each database. Again, it is important that scripts are idempotent to be resilient to retries.\n\n    $jobName = \"{Job Name}\"\n    $scriptName = \"{Script Name}\"\n    $customCollectionName = \"{Custom Collection Name}\"\n    $credentialName = \"{Credential Name}\"\n    $target = Get-AzureSqlJobTarget -CustomCollectionName $customCollectionName\n    $job = New-AzureSqlJob -JobName $jobName -CredentialName $credentialName -ContentName $scriptName -TargetId $target.TargetId\n    Write-Output $job\n\n## Data collection across databases\n\n**Elastic Database jobs** supports executing a query across a group of databases and sends the results to a specified database’s table. The table can be queried after the fact to see the query’s results from each database. This provides an asynchronous mechanism to execute a query across many databases. Failure cases such as one of the databases being temporarily unavailable are handled automatically via retries.\n\nThe specified destination table will be automatically created if it does not yet exist matching the schema of the returned result set. If a script execution returns multiple result sets, Elastic Database jobs will only send the first one to the provided destination table.\n\nThe following PowerShell script can be used to execute a script collecting its results into a specified table. This script assumes that a T-SQL script has been created which outputs a single result set and a custom database collection target has been created.\n\nSet the following to reflect the desired script, credentials, and execution target:\n\n    $jobName = \"{Job Name}\"\n    $scriptName = \"{Script Name}\"\n    $executionCredentialName = \"{Execution Credential Name}\"\n    $customCollectionName = \"{Custom Collection Name}\"\n    $destinationCredentialName = \"{Destination Credential Name}\"\n    $destinationServerName = \"{Destination Server Name}\"\n    $destinationDatabaseName = \"{Destination Database Name}\"\n    $destinationSchemaName = \"{Destination Schema Name}\"\n    $destinationTableName = \"{Destination Table Name}\"\n    $target = Get-AzureSqlJobTarget -CustomCollectionName $customCollectionName\n\n### Create and start a job for data collection scenarios\n    $job = New-AzureSqlJob -JobName $jobName -CredentialName $executionCredentialName -ContentName $scriptName -ResultSetDestinationServerName $destinationServerName -ResultSetDestinationDatabaseName $destinationDatabaseName -ResultSetDestinationSchemaName $destinationSchemaName -ResultSetDestinationTableName $destinationTableName -ResultSetDestinationCredentialName $destinationCredentialName -TargetId $target.TargetId\n    Write-Output $job\n    $jobExecution = Start-AzureSqlJobExecution -JobName $jobName\n    Write-Output $jobExecution\n\n## Create a schedule for job execution using a job trigger\n\nThe following PowerShell script can be used to create a reoccurring schedule. This script uses a minute interval, but New-AzureSqlJobSchedule also supports -DayInterval, -HourInterval, -MonthInterval, and -WeekInterval parameters. Schedules that execute only once can be created by passing -OneTime.\n\nCreate a new schedule:\n\n    $scheduleName = \"Every one minute\"\n    $minuteInterval = 1\n    $startTime = (Get-Date).ToUniversalTime()\n    $schedule = New-AzureSqlJobSchedule -MinuteInterval $minuteInterval -ScheduleName $scheduleName -StartTime $startTime \n    Write-Output $schedule\n\n### Create a job trigger to have a job executed on a time schedule\n\nA job trigger can be defined to have a job executed according to a time schedule. The following PowerShell script can be used to create a job trigger.\n\nSet the following variables to correspond to the desired job and schedule:\n\n    $jobName = \"{Job Name}\"\n    $scheduleName = \"{Schedule Name}\"\n    $jobTrigger = New-AzureSqlJobTrigger -ScheduleName $scheduleName –JobName $jobName\n    Write-Output $jobTrigger\n\n### Remove a scheduled association to stop job from executing on schedule\n\nTo discontinue reoccurring job execution through a job trigger, the job trigger can be removed. \nRemove a job trigger to stop a job from being executed according to a schedule using the **Remove-AzureSqlJobTrigger** cmdlet.\n\n    $jobName = \"{Job Name}\"\n    $scheduleName = \"{Schedule Name}\"\n    Remove-AzureSqlJobTrigger -ScheduleName $scheduleName -JobName $jobName\n\n### Retrieve job triggers bound to a time schedule\n\nThe following PowerShell script can be used to obtain and display the job triggers registered to a particular time schedule.\n\n    $scheduleName = \"{Schedule Name}\"\n    $jobTriggers = Get-AzureSqlJobTrigger -ScheduleName $scheduleName\n    Write-Output $jobTriggers\n\n### Retrieve job triggers bound to a job \n\nThe following PowerShell script can be used to obtain and display schedules containing a registered job.\n\n    $jobName = \"{Job Name}\"\n    $jobTriggers = Get-AzureSqlJobTrigger -JobName $jobName\n    Write-Output $jobTriggers\n\n## Create a Data-tier Application Deployment (DACPAC) for execution across databases\n\nElastic Database jobs can be used to deploy a data-tier application (DACPAC) to a group of databases. To create a DACPAC, please refer to this documentation.  For Elastic Database Jobs to deploy a DACPAC to a group of databases, the DACPAC must be accessible to the service. It is recommended to upload a created DACPAC to Azure Storage and create a signed URI for the DACPAC.\n\nThe following PowerShell script can be used to insert a DACPAC into Elastic Database Jobs:\n\n    $dacpacUri = \"{Uri}\"\n    $dacpacName = \"{Dacpac Name}\"\n    $dacpac = New-AzureSqlJobContent -DacpacUri $dacpacUri -ContentName $dacpacName \n    Write-Output $dacpac\n\n### Updating a Data-tier Application Deployment (DACPAC) for execution across databases\n\nExisting DACPACs registered within Elastic Database Jobs can be updated to point to new URIs.\nThe following PowerShell script can be used to update the DACPAC URI on an existing registered DACPAC:\n\n    $dacpacName = \"{Dacpac Name}\"\n    $newDacpacUri = \"{Uri}\"\n    $updatedDacpac = Set-AzureSqlJobDacpacDefinition -ContentName $dacpacName -DacpacUri $newDacpacUri\n    Write-Output $updatedDacpac\n\n## Create a Job to Apply a Data-tier Application Deployment (DACPAC) across databases\n\nAfter a DACPAC has been created within Elastic Database Jobs, a job can be created to apply the DACPAC across a group of databases.  The following PowerShell script can be used to create a DACPAC job across a custom collection of databases:\n\n    $jobName = \"{Job Name}\"\n    $dacpacName = \"{Dacpac Name}\"\n    $customCollectionName = \"{Custom Collection Name}\"\n    $credentialName = \"{Credential Name}\"\n    $target = Get-AzureSqlJobTarget -CustomCollectionName $customCollectionName\n    $job = New-AzureSqlJob -JobName $jobName -CredentialName $credentialName -ContentName $dacpacName -TargetId $target.TargetId\n    Write-Output $job \n\n[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]\n\n<!--Image references-->\n[1]: ./media/sql-database-elastic-jobs-powershell/cmd-prompt.png\n[2]: ./media/sql-database-elastic-jobs-powershell/portal.png\n<!--anchors-->\n"
}