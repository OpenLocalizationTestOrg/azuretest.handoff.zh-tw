{
  "nodes": [
    {
      "content": "Get started with an HPC Pack cluster to run Excel and SOA workloads | Microsoft Azure",
      "pos": [
        24,
        109
      ]
    },
    {
      "content": ".",
      "pos": [
        125,
        126
      ]
    },
    {
      "content": "Get started with an HPC Pack cluster in Azure to run Excel and SOA workloads",
      "pos": [
        404,
        480
      ]
    },
    {
      "content": "This article shows you how to deploy an HPC Pack cluster on Azure infrastructure services (IaaS) using an Azure quickstart template or an Azure PowerShell deployment script.",
      "pos": [
        482,
        655
      ]
    },
    {
      "content": "You'll use Azure Marketplace VM images designed to run Microsoft Excel or service-oriented architecture (SOA) workloads with HPC Pack.",
      "pos": [
        656,
        790
      ]
    },
    {
      "content": "You can use the cluster to run simple Excel HPC and SOA services from an on-premises client computer.",
      "pos": [
        791,
        892
      ]
    },
    {
      "content": "The Excel HPC services include Excel workbook offloading and Excel user-defined functions, or UDFs.",
      "pos": [
        893,
        992
      ]
    },
    {
      "content": "At a high level the following diagram shows the HPC Pack cluster you'll create.",
      "pos": [
        994,
        1073
      ]
    },
    {
      "content": "![HPC cluster with nodes running Excel workloads][scenario]",
      "pos": [
        1075,
        1134
      ]
    },
    {
      "content": "Prerequisites",
      "pos": [
        1139,
        1152
      ]
    },
    {
      "pos": [
        1156,
        1370
      ],
      "content": "<bpt id=\"p1\">**</bpt>Client computer<ept id=\"p1\">**</ept> - You'll need a Windows-based client computer to run the Azure PowerShell cluster deployment script (if you choose that deployment method) and to submit sample Excel and SOA jobs to the cluster."
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Azure subscription<ept id=\"p1\">**</ept> - If you don't have an account, you can create a free trial account in just a couple of minutes.",
      "pos": [
        1374,
        1493
      ]
    },
    {
      "content": "For details, see <bpt id=\"p1\">[</bpt>Azure Free Trial<ept id=\"p1\">](http://azure.microsoft.com/pricing/free-trial/)</ept>.",
      "pos": [
        1494,
        1578
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Cores quota<ept id=\"p1\">**</ept> - You might need to increase the quota of cores, especially if you choose to deploy several cluster nodes with multicore VM sizes.",
      "pos": [
        1582,
        1728
      ]
    },
    {
      "content": "If you are using an Azure quickstart template, be aware that the cores quota in Resource Manager is per Azure region, and you might need to increase the quota in a specific region.",
      "pos": [
        1729,
        1909
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>Azure subscription limits, quotas, and constraints<ept id=\"p1\">](../azure-subscription-service-limits.md)</ept>.",
      "pos": [
        1910,
        2008
      ]
    },
    {
      "content": "To increase a quota, you can <bpt id=\"p1\">[</bpt>open an online customer support request<ept id=\"p1\">](http://azure.microsoft.com/blog/2014/06/04/azure-limits-quotas-increase-requests/)</ept> at no charge.",
      "pos": [
        2009,
        2176
      ]
    },
    {
      "content": "Step 1.",
      "pos": [
        2182,
        2189
      ]
    },
    {
      "content": "Set up an HPC Pack cluster in Azure",
      "pos": [
        2190,
        2225
      ]
    },
    {
      "content": "We'll show you two ways to set up the cluster: first, using an Azure quickstart template and the Azure Preview Portal; and second, using an Azure PowerShell deployment script.",
      "pos": [
        2227,
        2402
      ]
    },
    {
      "content": "Use a quickstart template",
      "pos": [
        2409,
        2434
      ]
    },
    {
      "content": "Use an Azure quickstart template to quickly and easily deploy an HPC Pack cluster in the Azure Preview portal.",
      "pos": [
        2435,
        2545
      ]
    },
    {
      "content": "When you open the template in the portal, you get a simple UI where you enter the settings for your cluster.",
      "pos": [
        2546,
        2654
      ]
    },
    {
      "content": "Here are the steps.",
      "pos": [
        2655,
        2674
      ]
    },
    {
      "content": "Visit the <bpt id=\"p1\">[</bpt>Create HPC Cluster template page on GitHub<ept id=\"p1\">](https://github.com/Azure/azure-quickstart-templates/tree/master/create-hpc-cluster)</ept>.",
      "pos": [
        2679,
        2818
      ]
    },
    {
      "content": "If you want, review information about the template and the source code.",
      "pos": [
        2819,
        2890
      ]
    },
    {
      "pos": [
        2895,
        2989
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Deploy to Azure<ept id=\"p1\">**</ept> to start a deployment with the template in the Azure Preview portal."
    },
    {
      "content": "![Deploy template to Azure][github]",
      "pos": [
        2995,
        3030
      ]
    },
    {
      "content": "In the portal, follow these steps to enter the parameters for the HPC cluster template.",
      "pos": [
        3035,
        3122
      ]
    },
    {
      "content": "a.",
      "pos": [
        3128,
        3130
      ]
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Edit Template<ept id=\"p1\">**</ept> page, click <bpt id=\"p2\">**</bpt>Save<ept id=\"p2\">**</ept>.",
      "pos": [
        3131,
        3177
      ]
    },
    {
      "content": "![Save the template][template]",
      "pos": [
        3183,
        3213
      ]
    },
    {
      "content": "b.",
      "pos": [
        3219,
        3221
      ]
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Parameters<ept id=\"p1\">**</ept> page, enter values for the template parameters.",
      "pos": [
        3222,
        3291
      ]
    },
    {
      "content": "(Click the icon next to each setting for help information.) Sample values are shown in the following screen.",
      "pos": [
        3292,
        3400
      ]
    },
    {
      "content": "This example will create a new HPC Pack cluster named <bpt id=\"p1\">*</bpt>hpc01<ept id=\"p1\">*</ept> in the <bpt id=\"p2\">*</bpt>hpc.local<ept id=\"p2\">*</ept> domain consisting of a head node and 2 compute nodes.",
      "pos": [
        3401,
        3535
      ]
    },
    {
      "content": "The compute nodes will be created from an HPC Pack VM image including Microsoft Excel.",
      "pos": [
        3536,
        3622
      ]
    },
    {
      "content": "![Enter parameters][parameters]",
      "pos": [
        3628,
        3659
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph>The head node VM will be created automatically from the <bpt id=\"p1\">[</bpt>latest Marketplace  image<ept id=\"p1\">](http://azure.microsoft.com/marketplace/partners/microsoft/hpcpack2012r2onwindowsserver2012r2/)</ept> of HPC Pack 2012 R2 on Windows Server 2012 R2.",
      "pos": [
        3666,
        3903
      ]
    },
    {
      "content": "Currently the image is based on HPC Pack 2012 R2 Update 2.",
      "pos": [
        3904,
        3962
      ]
    },
    {
      "content": "Compute node VMs will be created from the latest image of the selected compute node family.",
      "pos": [
        3974,
        4065
      ]
    },
    {
      "content": "Select the <bpt id=\"p1\">**</bpt>ComputeNode<ept id=\"p1\">**</ept> option for the latest HPC Pack 2012 R2 Update 2 compute image for general purposes.",
      "pos": [
        4066,
        4176
      ]
    },
    {
      "content": "Select <bpt id=\"p1\">**</bpt>ComputeNodeWithExcel<ept id=\"p1\">**</ept> option for the latest HPC Pack compute node image that includes an evaluation version of Microsoft Excel Professional Plus 2013.",
      "pos": [
        4177,
        4337
      ]
    },
    {
      "content": "If you want to deploy a cluster for general SOA sessions or for Excel UDF offloading, choose the <bpt id=\"p1\">**</bpt>ComputeNode<ept id=\"p1\">**</ept> option (without Excel installed).",
      "pos": [
        4338,
        4484
      ]
    },
    {
      "content": "When using  <bpt id=\"p1\">**</bpt>ComputeNodeWithExcel<ept id=\"p1\">**</ept> for production workloads, you'll need to provide a valid Excel license to activate Excel on the compute nodes.",
      "pos": [
        4496,
        4643
      ]
    },
    {
      "content": "Otherwise, the evaluation version of Excel could be expired within 30 days, and running the Excel workbook would constantly fail with the COMExeption (0x800AC472).",
      "pos": [
        4644,
        4807
      ]
    },
    {
      "content": "If this happens, you may log on the head node to clusrun “%ProgramFiles(x86)%\\Microsoft Office\\Office15\\OSPPREARM.exe” on all Excel compute nodes via HPC Cluster Manager console to rearm Excel for another 30 days of evaluation time.",
      "pos": [
        4808,
        5040
      ]
    },
    {
      "content": "The max rearm time for the grace period is 2, after that you may need to provide a valid Excel license.",
      "pos": [
        5041,
        5144
      ]
    },
    {
      "content": "c.",
      "pos": [
        5150,
        5152
      ]
    },
    {
      "content": "Choose the subscription.",
      "pos": [
        5153,
        5177
      ]
    },
    {
      "content": "d.",
      "pos": [
        5183,
        5185
      ]
    },
    {
      "content": "Create a new resource group for the cluster, such as <bpt id=\"p1\">*</bpt>hpc01RG<ept id=\"p1\">*</ept>.",
      "pos": [
        5186,
        5249
      ]
    },
    {
      "content": "e.",
      "pos": [
        5255,
        5257
      ]
    },
    {
      "content": "Choose a location for the resource group, such as East US.",
      "pos": [
        5258,
        5316
      ]
    },
    {
      "content": "f.",
      "pos": [
        5322,
        5324
      ]
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Legal terms<ept id=\"p1\">**</ept> page, review the terms.",
      "pos": [
        5325,
        5371
      ]
    },
    {
      "content": "If you agree, click <bpt id=\"p1\">**</bpt>Buy<ept id=\"p1\">**</ept>.",
      "pos": [
        5372,
        5400
      ]
    },
    {
      "content": "g.",
      "pos": [
        5406,
        5408
      ]
    },
    {
      "content": "When you are finished setting the values for the template, click <bpt id=\"p1\">**</bpt>Create<ept id=\"p1\">**</ept> .",
      "pos": [
        5409,
        5486
      ]
    },
    {
      "content": "![Create the cluster][create]",
      "pos": [
        5492,
        5521
      ]
    },
    {
      "content": "When the deployment completes (it typically takes around 30 minutes), export the cluster certificate file from the cluster head node.",
      "pos": [
        5527,
        5660
      ]
    },
    {
      "content": "In a later step this public certificate will be imported on the client computer to provide the server-side authentication for secure HTTP binding.",
      "pos": [
        5661,
        5807
      ]
    },
    {
      "content": "a.",
      "pos": [
        5813,
        5815
      ]
    },
    {
      "content": "Connect to the head node by Remote Desktop from the Azure Preview portal.",
      "pos": [
        5816,
        5889
      ]
    },
    {
      "content": "![Connect to the head node][connect]",
      "pos": [
        5896,
        5932
      ]
    },
    {
      "content": "b.",
      "pos": [
        5938,
        5940
      ]
    },
    {
      "content": "Use standard procedures to use Certificate Manager to export the head node certificate (located under Cert:\\LocalMachine\\My) without the private key.",
      "pos": [
        5941,
        6090
      ]
    },
    {
      "content": "In this example, export <bpt id=\"p1\">*</bpt>CN = hpc01.eastus.cloudapp.azure.com<ept id=\"p1\">*</ept>.",
      "pos": [
        6091,
        6154
      ]
    },
    {
      "content": "![Export the certificate][cert]",
      "pos": [
        6160,
        6191
      ]
    },
    {
      "content": "Use the HPC Pack IaaS Deployment script",
      "pos": [
        6197,
        6236
      ]
    },
    {
      "content": "The HPC Pack IaaS deployment script provides another versatile way to deploy an HPC Pack cluster.",
      "pos": [
        6238,
        6335
      ]
    },
    {
      "content": "It runs in Azure Service Management (ASM) mode, whereas the template runs in Azure Resource Manager (ARM) mode.",
      "pos": [
        6336,
        6447
      ]
    },
    {
      "content": "Also, the script is compatible with a subscription in either the Azure Global or Azure China service.",
      "pos": [
        6448,
        6549
      ]
    },
    {
      "content": "Additional prerequisites",
      "pos": [
        6553,
        6577
      ]
    },
    {
      "pos": [
        6583,
        6733
      ],
      "content": "<bpt id=\"p1\">**</bpt>Azure PowerShell<ept id=\"p1\">**</ept> - <bpt id=\"p2\">[</bpt>Install and configure Azure PowerShell<ept id=\"p2\">](../powershell-install-configure.md)</ept> (version 0.8.10 or later) on your client computer."
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>HPC Pack IaaS deployment script<ept id=\"p1\">**</ept> - Download and unpack the latest version of the script from the <bpt id=\"p2\">[</bpt>Microsoft Download Center<ept id=\"p2\">](https://www.microsoft.com/download/details.aspx?id=44949)</ept>.",
      "pos": [
        6737,
        6923
      ]
    },
    {
      "content": "Check the version of the script by running <ph id=\"ph1\">`New-HPCIaaSCluster.ps1 –Version`</ph>.",
      "pos": [
        6924,
        7001
      ]
    },
    {
      "content": "This article is based on version 4.4.0 or later of the script.",
      "pos": [
        7002,
        7064
      ]
    },
    {
      "content": "Create the configuration file",
      "pos": [
        7068,
        7097
      ]
    },
    {
      "content": "The HPC Pack IaaS deployment script uses an XML configuration file as input which describes the infrastructure of the HPC cluster.",
      "pos": [
        7102,
        7232
      ]
    },
    {
      "content": "To deploy a cluster consisting of a head node and 18 compute nodes created from the compute node image that includes Microsoft Excel, substitute values for your environment into the following sample configuration file.",
      "pos": [
        7233,
        7451
      ]
    },
    {
      "content": "For more information about the configuration file, see the Manual.rtf file in the script folder or the <bpt id=\"p1\">[</bpt>script documentation<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/dn864734.aspx)</ept>.",
      "pos": [
        7452,
        7634
      ]
    },
    {
      "content": "Notes about the configuration file",
      "pos": [
        8864,
        8898
      ]
    },
    {
      "pos": [
        8904,
        8984
      ],
      "content": "The <bpt id=\"p1\">**</bpt>VMName<ept id=\"p1\">**</ept> of the head node must be exactly the same as the <bpt id=\"p2\">**</bpt>ServiceName<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        8988,
        9090
      ],
      "content": "Make sure you specify <bpt id=\"p1\">**</bpt>EnableWebPortal<ept id=\"p1\">**</ept> so that the head node certificate is generated and exported."
    },
    {
      "content": "The post-configuration PowerShell script PostConfig.ps1 configures certain settings on the head node such as setting up the Azure storage connection string, removing the compute node role from the head node, and bringing all nodes online when they are deployed.",
      "pos": [
        9094,
        9355
      ]
    },
    {
      "content": "A sample script follows.",
      "pos": [
        9356,
        9380
      ]
    },
    {
      "content": "Run the script",
      "pos": [
        10457,
        10471
      ]
    },
    {
      "content": "Open the PowerShell console on the client computer as an administrator.",
      "pos": [
        10478,
        10549
      ]
    },
    {
      "content": "Change directory to the script folder (E:\\IaaSClusterScript in this example).",
      "pos": [
        10554,
        10631
      ]
    },
    {
      "content": "Run the command below to deploy the HPC Pack cluster.",
      "pos": [
        10677,
        10730
      ]
    },
    {
      "content": "This example assumes that the configuration file is located in E:\\HPCDemoConfig.xml.",
      "pos": [
        10731,
        10815
      ]
    },
    {
      "content": "The HPC Pack deployment script will run for some time.",
      "pos": [
        10919,
        10973
      ]
    },
    {
      "content": "One thing the script wil do is to export and download the cluster certificate and save it in the current user’s Documents folder on the client computer.",
      "pos": [
        10974,
        11126
      ]
    },
    {
      "content": "The script will generate a message similar to the following.",
      "pos": [
        11127,
        11187
      ]
    },
    {
      "content": "In a following step you'll import the certificate in the appropriate certificate store.",
      "pos": [
        11188,
        11275
      ]
    },
    {
      "content": "Step 2.",
      "pos": [
        11612,
        11619
      ]
    },
    {
      "content": "Offload Excel workbooks and run UDFs from an on-premises client",
      "pos": [
        11620,
        11683
      ]
    },
    {
      "content": "Offload Excel workbooks",
      "pos": [
        11689,
        11712
      ]
    },
    {
      "content": "Follow these steps to offload an Excel workbook to run on the HPC Pack cluster in Azure.",
      "pos": [
        11714,
        11802
      ]
    },
    {
      "content": "To do this, you must have Excel 2010 or 2013 already installed on the client computer.",
      "pos": [
        11803,
        11889
      ]
    },
    {
      "content": "Use one of the methods in Step 1 to deploy an HPC Pack cluster with the Excel compute node image.",
      "pos": [
        11894,
        11991
      ]
    },
    {
      "content": "Obtain the cluster certificate file (.cer) and cluster username and password.",
      "pos": [
        11992,
        12069
      ]
    },
    {
      "content": "On the client computer, import the cluster certificate under Cert:\\CurrentUser\\Root.",
      "pos": [
        12074,
        12158
      ]
    },
    {
      "content": "Make sure Excel is installed.",
      "pos": [
        12163,
        12192
      ]
    },
    {
      "content": "Create an Excel.exe.config file with the following contents in the same folder with Excel.exe on the client computer.",
      "pos": [
        12193,
        12310
      ]
    },
    {
      "content": "This ensures that the HPC Pack 2012 R2 Excel COM add-in will load successfully.",
      "pos": [
        12311,
        12390
      ]
    },
    {
      "content": "Download the full <bpt id=\"p1\">[</bpt>HPC Pack 2012 R2 Update 2 installation<ept id=\"p1\">](http://www.microsoft.com/download/details.aspx?id=47755)</ept> and install the HPC Pack client,",
      "pos": [
        12602,
        12750
      ]
    },
    {
      "content": "or download and install the <bpt id=\"p1\">[</bpt>HPC Pack 2012 R2 Update 2 client utilities<ept id=\"p1\">](https://www.microsoft.com/download/details.aspx?id=47754)</ept> and the appropriate Visual C++ 2010 redistributable for your computer (<bpt id=\"p2\">[</bpt>x64<ept id=\"p2\">](http://www.microsoft.com/download/details.aspx?id=14632)</ept>, <bpt id=\"p3\">[</bpt>x86<ept id=\"p3\">](https://www.microsoft.com/download/details.aspx?id=5555)</ept>).",
      "pos": [
        12751,
        13081
      ]
    },
    {
      "pos": [
        13087,
        13268
      ],
      "content": "In this example, we use a sample Excel workbook named ConvertiblePricing_Complete.xlsb, available for download <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](https://www.microsoft.com/en-us/download/details.aspx?id=2939)</ept>."
    },
    {
      "content": "Copy the Excel workbook to a working folder such as D:\\Excel\\Run.",
      "pos": [
        13274,
        13339
      ]
    },
    {
      "content": "Open the Excel workbook.",
      "pos": [
        13345,
        13369
      ]
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Develop<ept id=\"p1\">**</ept> ribbon, click <bpt id=\"p2\">**</bpt>COM Add-Ins<ept id=\"p2\">**</ept> and confirm that the HPC Pack Excel COM add-in is loaded successfully as shown in the following screen.",
      "pos": [
        13370,
        13522
      ]
    },
    {
      "content": "![Excel add-in for HPC Pack][addin]",
      "pos": [
        13528,
        13563
      ]
    },
    {
      "content": "Edit the VBA macro HPCControlMacros in Excel by changing the commented lines as shown in the following script.",
      "pos": [
        13569,
        13679
      ]
    },
    {
      "content": "Substitute appropriate values for your environment.",
      "pos": [
        13680,
        13731
      ]
    },
    {
      "content": "![Excel macro for HPC Pack][macro]",
      "pos": [
        13737,
        13771
      ]
    },
    {
      "content": "Copy the Excel work book to an upload directory such as D:\\Excel\\Upload, as specified in the HPC_DependsFiles constant in the VBA macro.",
      "pos": [
        14622,
        14758
      ]
    },
    {
      "pos": [
        14764,
        14856
      ],
      "content": "Click the <bpt id=\"p1\">**</bpt>Cluster<ept id=\"p1\">**</ept> button on the worksheet to run the workbook on the Azure IaaS cluster."
    },
    {
      "content": "Run Excel UDFs",
      "pos": [
        14862,
        14876
      ]
    },
    {
      "content": "To run Excel UDFs, follow the preceding steps 1 – 3 to set up the client computer.",
      "pos": [
        14878,
        14960
      ]
    },
    {
      "content": "For Excel UDFs, you don't need to have the Excel application installed on compute nodes, so you could choose a normal compute node image in Step 1 instead of the compute node image with Excel.",
      "pos": [
        14961,
        15153
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> There is a 34 character limit in the Excel 2010 and 2013 cluster connector dialog box.",
      "pos": [
        15156,
        15255
      ]
    },
    {
      "content": "If the full cluster name is longer, e.g. hpcexcelhn01.southeastasia.cloudapp.azure.com, it won't fit in the dialog box.",
      "pos": [
        15256,
        15375
      ]
    },
    {
      "content": "The workaround is to apply the Update 2 QFE KB3085833 (download <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](http://www.microsoft.com/en-us/download/details.aspx?id=48725)</ept>) for SOA Session API on the client machine, then set a machine wide variable e.g. <bpt id=\"p2\">*</bpt>CCP_IAASHN<ept id=\"p2\">*</ept> with the value of the long cluster name and input <bpt id=\"p3\">*</bpt>%CCP_IAASHN%<ept id=\"p3\">*</ept> in the dialog box as the cluster head node name.",
      "pos": [
        15376,
        15718
      ]
    },
    {
      "content": "After the cluster is successfully deployed, continue with the following steps to run a sample built-in Excel UDF.",
      "pos": [
        15720,
        15833
      ]
    },
    {
      "content": "For customized Excel UDFs, see these <bpt id=\"p1\">[</bpt>resources<ept id=\"p1\">](http://social.technet.microsoft.com/wiki/contents/articles/1198.windows-hpc-and-microsoft-excel-resources-for-building-cluster-ready-workbooks.aspx)</ept> to build the XLLs and deploy them on the IaaS cluster.",
      "pos": [
        15834,
        16086
      ]
    },
    {
      "content": "Open a new Excel workbook.",
      "pos": [
        16092,
        16118
      ]
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Develop<ept id=\"p1\">**</ept> ribbon, click <bpt id=\"p2\">**</bpt>Add-Ins<ept id=\"p2\">**</ept>.",
      "pos": [
        16119,
        16164
      ]
    },
    {
      "content": "Then, in the dialog box, click <bpt id=\"p1\">**</bpt>Browse<ept id=\"p1\">**</ept>, navigate to the %CCP_HOME%Bin\\XLL32 folder, and select the sample ClusterUDF32.xll.",
      "pos": [
        16165,
        16291
      ]
    },
    {
      "content": "![Select the UDF][udf]",
      "pos": [
        16297,
        16319
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>Options<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">**</bpt>Advanced<ept id=\"p3\">**</ept>.",
      "pos": [
        16325,
        16369
      ]
    },
    {
      "content": "Under <bpt id=\"p1\">**</bpt>Formulas<ept id=\"p1\">**</ept> check <bpt id=\"p2\">**</bpt>Allow user-defined XLL functions to run a compute cluster<ept id=\"p2\">**</ept>.",
      "pos": [
        16370,
        16457
      ]
    },
    {
      "content": "Then click <bpt id=\"p1\">**</bpt>Options<ept id=\"p1\">**</ept> and enter the full cluster name in <bpt id=\"p2\">**</bpt>Cluster head node name<ept id=\"p2\">**</ept>.",
      "pos": [
        16458,
        16543
      ]
    },
    {
      "content": "(As noted previously this input box is limited to 34 characters, so a long cluster name may not fit.",
      "pos": [
        16544,
        16644
      ]
    },
    {
      "content": "You can configure a shorter full name when you deploy a clusters via the IaaS deployment script.)",
      "pos": [
        16645,
        16742
      ]
    },
    {
      "content": "![Configure the UDF][options]",
      "pos": [
        16748,
        16777
      ]
    },
    {
      "content": "Click the cell with value =XllGetComputerNameC() and press Enter to run the UDF calculation on the IaaS cluster.",
      "pos": [
        16783,
        16895
      ]
    },
    {
      "content": "The function will simply retrieve the name of the compute node on which the UDF runs.",
      "pos": [
        16896,
        16981
      ]
    },
    {
      "content": "For the first run, a credentials dialog box prompts for the username and password to connect to the IaaS cluster.",
      "pos": [
        16982,
        17095
      ]
    },
    {
      "content": "![Run UDF][run]",
      "pos": [
        17101,
        17116
      ]
    },
    {
      "content": "When there are a lot of cells to calculate, press Alt-Shift-Ctrl + F9 to run the calculation on all cells.",
      "pos": [
        17122,
        17228
      ]
    },
    {
      "content": "Step 3.",
      "pos": [
        17233,
        17240
      ]
    },
    {
      "content": "Run a SOA workload from an on-premises client",
      "pos": [
        17241,
        17286
      ]
    },
    {
      "content": "To run general SOA applications on the HPC Pack IaaS cluster, first use one of the methods in Step 1 to deploy the IaaS cluster, using a generic compute node image (because you will not need Excel on the compute nodes).",
      "pos": [
        17288,
        17507
      ]
    },
    {
      "content": "Then follow these steps.",
      "pos": [
        17508,
        17532
      ]
    },
    {
      "content": "After retrieving the cluster certificate, import it on the client computer under Cert:\\CurrentUser\\Root.",
      "pos": [
        17537,
        17641
      ]
    },
    {
      "pos": [
        17646,
        17905
      ],
      "content": "Install the <bpt id=\"p1\">[</bpt>HPC Pack 2012 R2 Update 2 SDK<ept id=\"p1\">](http://www.microsoft.com/download/details.aspx?id=47756)</ept> and <bpt id=\"p2\">[</bpt>HPC Pack 2012 R2 Update 2 client utilities<ept id=\"p2\">](https://www.microsoft.com/download/details.aspx?id=47754)</ept> so you can develop and run SOA client applications."
    },
    {
      "content": "Download the HellowWorldR2 <bpt id=\"p1\">[</bpt>sample code<ept id=\"p1\">](https://www.microsoft.com/download/details.aspx?id=41633)</ept>.",
      "pos": [
        17910,
        18009
      ]
    },
    {
      "content": "Open the HelloWorldR2.sln in Visual Studio 2010 or 2012.",
      "pos": [
        18010,
        18066
      ]
    },
    {
      "content": "Build the EchoService project first and deploy the service to the IaaS cluster in the same way you deploy to an on-premises cluster.",
      "pos": [
        18071,
        18203
      ]
    },
    {
      "content": "For detailed steps, see the Readme.doc in HelloWordR2.",
      "pos": [
        18204,
        18258
      ]
    },
    {
      "content": "Modify and build the HellowWorldR2 and other projects as described below to generate the SOA client applications running on an Azure IaaS cluster from an on-premises client computer.",
      "pos": [
        18259,
        18441
      ]
    },
    {
      "content": "Use Http binding with Azure storage queue",
      "pos": [
        18447,
        18488
      ]
    },
    {
      "content": "To use Http binding with an Azure storage queue, make a few changes to the sample code.",
      "pos": [
        18490,
        18577
      ]
    },
    {
      "content": "Update the cluster name.",
      "pos": [
        18581,
        18605
      ]
    },
    {
      "content": "Optionally, use default TransportScheme in SessionStartInfo or explicitly set it to Http.",
      "pos": [
        18792,
        18881
      ]
    },
    {
      "content": "Use default binding for the BrokerClient.",
      "pos": [
        18943,
        18984
      ]
    },
    {
      "content": "Or set explicitly using the basicHttpBinding.",
      "pos": [
        19187,
        19232
      ]
    },
    {
      "content": "Optionally, set the UseAzureQueue flag to true in SessionStartInfo.",
      "pos": [
        19525,
        19592
      ]
    },
    {
      "content": "If not set, it will be set to true by default when the cluster name has Azure domain suffixes and the TransportScheme is Http.",
      "pos": [
        19593,
        19719
      ]
    },
    {
      "content": "Use Http binding without Azure storage queue",
      "pos": [
        19768,
        19812
      ]
    },
    {
      "content": "To do this, explicitly set UseAzureQueue flag to false in the SessionStartInfo.",
      "pos": [
        19814,
        19893
      ]
    },
    {
      "content": "Use NetTcp binding",
      "pos": [
        19940,
        19958
      ]
    },
    {
      "content": "To use NetTcp binding, the configuration is like connecting to an on-premises cluster.",
      "pos": [
        19960,
        20046
      ]
    },
    {
      "content": "You'll need to open a few endpoints on the head node VM.",
      "pos": [
        20047,
        20103
      ]
    },
    {
      "content": "In the Azure Management Portal do the following.",
      "pos": [
        20104,
        20152
      ]
    },
    {
      "content": "Stop the VM.",
      "pos": [
        20158,
        20170
      ]
    },
    {
      "content": "Add the TCP ports 9090, 9087, 9091, 9094 for the Session, Broker, Broker worker and Data services, respectively",
      "pos": [
        20175,
        20286
      ]
    },
    {
      "content": "![Configure endpoints][endpoint]",
      "pos": [
        20292,
        20324
      ]
    },
    {
      "content": "Start the VM.",
      "pos": [
        20329,
        20342
      ]
    },
    {
      "content": "The SOA client application requires no changes except altering the head name to the IaaS cluster full name.",
      "pos": [
        20344,
        20451
      ]
    },
    {
      "content": "Next steps",
      "pos": [
        20456,
        20466
      ]
    },
    {
      "pos": [
        20470,
        20706
      ],
      "content": "See <bpt id=\"p1\">[</bpt>these resources<ept id=\"p1\">](http://social.technet.microsoft.com/wiki/contents/articles/1198.windows-hpc-and-microsoft-excel-resources-for-building-cluster-ready-workbooks.aspx)</ept> for more information about running Excel workloads with HPC Pack."
    },
    {
      "pos": [
        20710,
        20878
      ],
      "content": "See <bpt id=\"p1\">[</bpt>Managing SOA Services in Microsoft HPC Pack<ept id=\"p1\">](https://technet.microsoft.com/library/ff919412.aspx)</ept> for more about deploying and managing SOA services with HPC Pack."
    }
  ],
  "content": "<properties\n pageTitle=\"Get started with an HPC Pack cluster to run Excel and SOA workloads | Microsoft Azure\"\n description=\".\"\n services=\"virtual-machines\"\n documentationCenter=\"\"\n authors=\"dlepow\"\n manager=\"timlt\"\n editor=\"\"/>\n<tags\nms.service=\"virtual-machines\"\n ms.devlang=\"na\"\n ms.topic=\"article\"\n ms.tgt_pltfrm=\"vm-windows\"\n ms.workload=\"big-compute\"\n ms.date=\"08/18/2015\"\n ms.author=\"danlep\"/>\n\n# Get started with an HPC Pack cluster in Azure to run Excel and SOA workloads\n\nThis article shows you how to deploy an HPC Pack cluster on Azure infrastructure services (IaaS) using an Azure quickstart template or an Azure PowerShell deployment script. You'll use Azure Marketplace VM images designed to run Microsoft Excel or service-oriented architecture (SOA) workloads with HPC Pack. You can use the cluster to run simple Excel HPC and SOA services from an on-premises client computer. The Excel HPC services include Excel workbook offloading and Excel user-defined functions, or UDFs.\n\nAt a high level the following diagram shows the HPC Pack cluster you'll create.\n\n![HPC cluster with nodes running Excel workloads][scenario]\n\n## Prerequisites\n\n* **Client computer** - You'll need a Windows-based client computer to run the Azure PowerShell cluster deployment script (if you choose that deployment method) and to submit sample Excel and SOA jobs to the cluster.\n\n* **Azure subscription** - If you don't have an account, you can create a free trial account in just a couple of minutes. For details, see [Azure Free Trial](http://azure.microsoft.com/pricing/free-trial/).\n\n* **Cores quota** - You might need to increase the quota of cores, especially if you choose to deploy several cluster nodes with multicore VM sizes. If you are using an Azure quickstart template, be aware that the cores quota in Resource Manager is per Azure region, and you might need to increase the quota in a specific region. See [Azure subscription limits, quotas, and constraints](../azure-subscription-service-limits.md). To increase a quota, you can [open an online customer support request](http://azure.microsoft.com/blog/2014/06/04/azure-limits-quotas-increase-requests/) at no charge.\n\n\n## Step 1. Set up an HPC Pack cluster in Azure\n\nWe'll show you two ways to set up the cluster: first, using an Azure quickstart template and the Azure Preview Portal; and second, using an Azure PowerShell deployment script.\n\n\n### Use a quickstart template\nUse an Azure quickstart template to quickly and easily deploy an HPC Pack cluster in the Azure Preview portal. When you open the template in the portal, you get a simple UI where you enter the settings for your cluster. Here are the steps.\n\n1. Visit the [Create HPC Cluster template page on GitHub](https://github.com/Azure/azure-quickstart-templates/tree/master/create-hpc-cluster). If you want, review information about the template and the source code.\n\n2. Click **Deploy to Azure** to start a deployment with the template in the Azure Preview portal.\n\n    ![Deploy template to Azure][github]\n\n3. In the portal, follow these steps to enter the parameters for the HPC cluster template.\n\n    a. On the **Edit Template** page, click **Save**.\n\n    ![Save the template][template]\n\n    b. On the **Parameters** page, enter values for the template parameters. (Click the icon next to each setting for help information.) Sample values are shown in the following screen. This example will create a new HPC Pack cluster named *hpc01* in the *hpc.local* domain consisting of a head node and 2 compute nodes. The compute nodes will be created from an HPC Pack VM image including Microsoft Excel.\n\n    ![Enter parameters][parameters]\n\n    >[AZURE.NOTE]The head node VM will be created automatically from the [latest Marketplace  image](http://azure.microsoft.com/marketplace/partners/microsoft/hpcpack2012r2onwindowsserver2012r2/) of HPC Pack 2012 R2 on Windows Server 2012 R2. Currently the image is based on HPC Pack 2012 R2 Update 2.\n    >\n    >Compute node VMs will be created from the latest image of the selected compute node family. Select the **ComputeNode** option for the latest HPC Pack 2012 R2 Update 2 compute image for general purposes. Select **ComputeNodeWithExcel** option for the latest HPC Pack compute node image that includes an evaluation version of Microsoft Excel Professional Plus 2013. If you want to deploy a cluster for general SOA sessions or for Excel UDF offloading, choose the **ComputeNode** option (without Excel installed).\n    >\n    >When using  **ComputeNodeWithExcel** for production workloads, you'll need to provide a valid Excel license to activate Excel on the compute nodes. Otherwise, the evaluation version of Excel could be expired within 30 days, and running the Excel workbook would constantly fail with the COMExeption (0x800AC472). If this happens, you may log on the head node to clusrun “%ProgramFiles(x86)%\\Microsoft Office\\Office15\\OSPPREARM.exe” on all Excel compute nodes via HPC Cluster Manager console to rearm Excel for another 30 days of evaluation time. The max rearm time for the grace period is 2, after that you may need to provide a valid Excel license.\n\n    c. Choose the subscription.\n\n    d. Create a new resource group for the cluster, such as *hpc01RG*.\n\n    e. Choose a location for the resource group, such as East US.\n\n    f. On the **Legal terms** page, review the terms. If you agree, click **Buy**.\n\n    g. When you are finished setting the values for the template, click **Create** .\n\n    ![Create the cluster][create]\n\n3.  When the deployment completes (it typically takes around 30 minutes), export the cluster certificate file from the cluster head node. In a later step this public certificate will be imported on the client computer to provide the server-side authentication for secure HTTP binding.\n\n    a. Connect to the head node by Remote Desktop from the Azure Preview portal.\n\n     ![Connect to the head node][connect]\n\n    b. Use standard procedures to use Certificate Manager to export the head node certificate (located under Cert:\\LocalMachine\\My) without the private key. In this example, export *CN = hpc01.eastus.cloudapp.azure.com*.\n\n    ![Export the certificate][cert]\n\n### Use the HPC Pack IaaS Deployment script\n\nThe HPC Pack IaaS deployment script provides another versatile way to deploy an HPC Pack cluster. It runs in Azure Service Management (ASM) mode, whereas the template runs in Azure Resource Manager (ARM) mode. Also, the script is compatible with a subscription in either the Azure Global or Azure China service.\n\n**Additional prerequisites**\n\n* **Azure PowerShell** - [Install and configure Azure PowerShell](../powershell-install-configure.md) (version 0.8.10 or later) on your client computer.\n\n* **HPC Pack IaaS deployment script** - Download and unpack the latest version of the script from the [Microsoft Download Center](https://www.microsoft.com/download/details.aspx?id=44949). Check the version of the script by running `New-HPCIaaSCluster.ps1 –Version`. This article is based on version 4.4.0 or later of the script.\n\n**Create the configuration file**\n\n The HPC Pack IaaS deployment script uses an XML configuration file as input which describes the infrastructure of the HPC cluster. To deploy a cluster consisting of a head node and 18 compute nodes created from the compute node image that includes Microsoft Excel, substitute values for your environment into the following sample configuration file. For more information about the configuration file, see the Manual.rtf file in the script folder or the [script documentation](https://msdn.microsoft.com/library/azure/dn864734.aspx).\n\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<IaaSClusterConfig>\n  <Subscription>\n    <SubscriptionName>MySubscription</SubscriptionName>\n    <StorageAccount>hpc01</StorageAccount>\n  </Subscription>\n  <Location>West US</Location>\n  <VNet>\n    <VNetName>hpc-vnet01</VNetName>\n    <SubnetName>Subnet-1</SubnetName>\n  </VNet>\n  <Domain>\n    <DCOption>NewDC</DCOption>\n    <DomainFQDN>hpc.local</DomainFQDN>\n    <DomainController>\n      <VMName>HPCExcelDC01</VMName>\n      <ServiceName>HPCExcelDC01</ServiceName>\n      <VMSize>Medium</VMSize>\n    </DomainController>\n  </Domain>\n   <Database>\n    <DBOption>LocalDB</DBOption>\n  </Database>\n  <HeadNode>\n    <VMName>HPCExcelHN01</VMName>\n    <ServiceName>HPCExcelHN01</ServiceName>\n    <VMSize>Large</VMSize>\n    <EnableRESTAPI/>\n    <EnableWebPortal/>\n<PostConfigScript>C:\\tests\\PostConfig.ps1</PostConfigScript>\n  </HeadNode>\n  <ComputeNodes>\n    <VMNamePattern>HPCExcelCN%00%</VMNamePattern>\n    <ServiceName>HPCExcelCN01</ServiceName>\n    <VMSize>Medium</VMSize>\n    <NodeCount>18</NodeCount>\n    <ImageName HPCPackInstalled=\"true\">96316178b0644ae08bc4e037635ce104__HPC-Pack-2012R2-Update2-CN-Excel-4.4.4864.0-WS2012R2-ENU</ImageName>\n  </ComputeNodes>\n</IaaSClusterConfig>\n```\n\n**Notes about the configuration file**\n\n* The **VMName** of the head node must be exactly the same as the **ServiceName**.\n\n* Make sure you specify **EnableWebPortal** so that the head node certificate is generated and exported.\n\n* The post-configuration PowerShell script PostConfig.ps1 configures certain settings on the head node such as setting up the Azure storage connection string, removing the compute node role from the head node, and bringing all nodes online when they are deployed. A sample script follows.\n\n```\n    # add the HPC Pack powershell cmdlets\n        Add-PSSnapin Microsoft.HPC\n\n    # set the Azure storage connection string for the cluster\n        Set-HpcClusterProperty -AzureStorageConnectionString 'DefaultEndpointsProtocol=https;AccountName=<yourstorageaccountname>;AccountKey=<yourstorageaccountkey>'\n\n    # remove the compute node role for head node to make sure the Excel workbook won’t run on head node\n        Get-HpcNode -GroupName HeadNodes | Set-HpcNodeState -State offline | Set-HpcNode -Role BrokerNode\n\n    # total number of nodes in the deployment including the head node and compute nodes\n        $TotalNumOfNodes = 19\n\n        $ErrorActionPreference = 'SilentlyContinue'\n\n    # bring nodes online when they are deployed until all nodes are online\n        while ($true)\n        {\n          Get-HpcNode -State Offline | Set-HpcNodeState -State Online -Confirm:$false\n          $OnlineNodes = @(Get-HpcNode -State Online)\n          if ($OnlineNodes.Count -eq $TotalNumOfNodes)\n          {\n             break\n          }\n          sleep 60\n        }\n```\n\n**Run the script**\n\n1. Open the PowerShell console on the client computer as an administrator.\n\n2. Change directory to the script folder (E:\\IaaSClusterScript in this example).\n\n    ```\n    cd E:\\IaaSClusterScript\n```\n\n4. Run the command below to deploy the HPC Pack cluster. This example assumes that the configuration file is located in E:\\HPCDemoConfig.xml.\n\n    ```\n    .\\New-HpcIaaSCluster.ps1 –ConfigFile E:\\HPCDemoConfig.xml –AdminUserName MyAdminName\n```\n\nThe HPC Pack deployment script will run for some time. One thing the script wil do is to export and download the cluster certificate and save it in the current user’s Documents folder on the client computer. The script will generate a message similar to the following. In a following step you'll import the certificate in the appropriate certificate store.\n\n```\nYou have enabled REST API or web portal on HPC Pack head node. Please import the following certificate in the Trusted Root Certification Authorities certificate store on the computer where you are submitting job or accessing the HPC web portal:\n C:\\Users\\hpcuser\\Documents\\HPCWebComponent_HPCExcelHN004_2015070716\n2011.cer\n```\n\n## Step 2. Offload Excel workbooks and run UDFs from an on-premises client\n\n### Offload Excel workbooks\n\nFollow these steps to offload an Excel workbook to run on the HPC Pack cluster in Azure. To do this, you must have Excel 2010 or 2013 already installed on the client computer.\n\n1. Use one of the methods in Step 1 to deploy an HPC Pack cluster with the Excel compute node image. Obtain the cluster certificate file (.cer) and cluster username and password.\n\n2. On the client computer, import the cluster certificate under Cert:\\CurrentUser\\Root.\n\n3. Make sure Excel is installed. Create an Excel.exe.config file with the following contents in the same folder with Excel.exe on the client computer. This ensures that the HPC Pack 2012 R2 Excel COM add-in will load successfully.\n\n    ```\n<?xml version=\"1.0\"?>\n<configuration>\n  <startup useLegacyV2RuntimeActivationPolicy=\"true\">\n    <supportedRuntime version=\"v4.0\" sku=\".NETFramework,Version=v4.0\"/>\n  </startup>\n</configuration>\n```\n4.  Download the full [HPC Pack 2012 R2 Update 2 installation](http://www.microsoft.com/download/details.aspx?id=47755) and install the HPC Pack client,\nor download and install the [HPC Pack 2012 R2 Update 2 client utilities](https://www.microsoft.com/download/details.aspx?id=47754) and the appropriate Visual C++ 2010 redistributable for your computer ([x64](http://www.microsoft.com/download/details.aspx?id=14632), [x86](https://www.microsoft.com/download/details.aspx?id=5555)).\n\n5.  In this example, we use a sample Excel workbook named ConvertiblePricing_Complete.xlsb, available for download [here](https://www.microsoft.com/en-us/download/details.aspx?id=2939).\n\n6.  Copy the Excel workbook to a working folder such as D:\\Excel\\Run.\n\n7.  Open the Excel workbook. On the **Develop** ribbon, click **COM Add-Ins** and confirm that the HPC Pack Excel COM add-in is loaded successfully as shown in the following screen.\n\n    ![Excel add-in for HPC Pack][addin]\n\n8.  Edit the VBA macro HPCControlMacros in Excel by changing the commented lines as shown in the following script. Substitute appropriate values for your environment.\n\n    ![Excel macro for HPC Pack][macro]\n\n    ```\n    'Private Const HPC_ClusterScheduler = \"HEADNODE_NAME\"\n    Private Const HPC_ClusterScheduler = \"hpc01.eastus.cloudapp.azure.com\"\n\n    'Private Const HPC_NetworkShare = \"\\\\PATH\\TO\\SHARE\\DIRECTORY\"\n    Private Const HPC_DependFiles = \"D:\\Excel\\Upload\\ConvertiblePricing_Complete.xlsb=ConvertiblePricing_Complete.xlsb\"\n\n    'HPCExcelClient.Initialize ActiveWorkbook\n    HPCExcelClient.Initialize ActiveWorkbook, HPC_DependFiles\n\n    'HPCWorkbookPath = HPC_NetworkShare & Application.PathSeparator & ActiveWorkbook.name\n    HPCWorkbookPath = \"ConvertiblePricing_Complete.xlsb\"\n\n    'HPCExcelClient.OpenSession headNode:=HPC_ClusterScheduler, remoteWorkbookPath:=HPCWorkbookPath\n    HPCExcelClient.OpenSession headNode:=HPC_ClusterScheduler, remoteWorkbookPath:=HPCWorkbookPath, UserName:=\"hpc\\azureuser\", Password:=\"<YourPassword>\"\n```\n\n9.  Copy the Excel work book to an upload directory such as D:\\Excel\\Upload, as specified in the HPC_DependsFiles constant in the VBA macro.\n\n10. Click the **Cluster** button on the worksheet to run the workbook on the Azure IaaS cluster.\n\n### Run Excel UDFs\n\nTo run Excel UDFs, follow the preceding steps 1 – 3 to set up the client computer. For Excel UDFs, you don't need to have the Excel application installed on compute nodes, so you could choose a normal compute node image in Step 1 instead of the compute node image with Excel.\n\n>[AZURE.NOTE] There is a 34 character limit in the Excel 2010 and 2013 cluster connector dialog box. If the full cluster name is longer, e.g. hpcexcelhn01.southeastasia.cloudapp.azure.com, it won't fit in the dialog box. The workaround is to apply the Update 2 QFE KB3085833 (download [here](http://www.microsoft.com/en-us/download/details.aspx?id=48725)) for SOA Session API on the client machine, then set a machine wide variable e.g. *CCP_IAASHN* with the value of the long cluster name and input *%CCP_IAASHN%* in the dialog box as the cluster head node name.\n\nAfter the cluster is successfully deployed, continue with the following steps to run a sample built-in Excel UDF. For customized Excel UDFs, see these [resources](http://social.technet.microsoft.com/wiki/contents/articles/1198.windows-hpc-and-microsoft-excel-resources-for-building-cluster-ready-workbooks.aspx) to build the XLLs and deploy them on the IaaS cluster.\n\n1.  Open a new Excel workbook. On the **Develop** ribbon, click **Add-Ins**. Then, in the dialog box, click **Browse**, navigate to the %CCP_HOME%Bin\\XLL32 folder, and select the sample ClusterUDF32.xll.\n\n    ![Select the UDF][udf]\n\n2.  Click **File** > **Options** > **Advanced**. Under **Formulas** check **Allow user-defined XLL functions to run a compute cluster**. Then click **Options** and enter the full cluster name in **Cluster head node name**. (As noted previously this input box is limited to 34 characters, so a long cluster name may not fit. You can configure a shorter full name when you deploy a clusters via the IaaS deployment script.)\n\n    ![Configure the UDF][options]\n\n3.  Click the cell with value =XllGetComputerNameC() and press Enter to run the UDF calculation on the IaaS cluster. The function will simply retrieve the name of the compute node on which the UDF runs. For the first run, a credentials dialog box prompts for the username and password to connect to the IaaS cluster.\n\n    ![Run UDF][run]\n\n    When there are a lot of cells to calculate, press Alt-Shift-Ctrl + F9 to run the calculation on all cells.\n\n## Step 3. Run a SOA workload from an on-premises client\n\nTo run general SOA applications on the HPC Pack IaaS cluster, first use one of the methods in Step 1 to deploy the IaaS cluster, using a generic compute node image (because you will not need Excel on the compute nodes). Then follow these steps.\n\n1. After retrieving the cluster certificate, import it on the client computer under Cert:\\CurrentUser\\Root.\n\n2. Install the [HPC Pack 2012 R2 Update 2 SDK](http://www.microsoft.com/download/details.aspx?id=47756) and [HPC Pack 2012 R2 Update 2 client utilities](https://www.microsoft.com/download/details.aspx?id=47754) so you can develop and run SOA client applications.\n\n3. Download the HellowWorldR2 [sample code](https://www.microsoft.com/download/details.aspx?id=41633). Open the HelloWorldR2.sln in Visual Studio 2010 or 2012.\n\n4. Build the EchoService project first and deploy the service to the IaaS cluster in the same way you deploy to an on-premises cluster. For detailed steps, see the Readme.doc in HelloWordR2. Modify and build the HellowWorldR2 and other projects as described below to generate the SOA client applications running on an Azure IaaS cluster from an on-premises client computer.\n\n### Use Http binding with Azure storage queue\n\nTo use Http binding with an Azure storage queue, make a few changes to the sample code.\n\n* Update the cluster name.\n\n    ```\n// Before\nconst string headnode = \"[headnode]\";\n// After e.g.\nconst string headnode = \"hpc01.eastus.cloudapp.azure.com\";\nor\nconst string headnode = \"hpc01.cloudapp.net\";\n```\n\n* Optionally, use default TransportScheme in SessionStartInfo or explicitly set it to Http.\n\n```\n    info.TransportScheme = TransportScheme.Http;\n```\n\n* Use default binding for the BrokerClient.\n\n    ```\n// Before\nusing (BrokerClient<IService1> client = new BrokerClient<IService1>(session, binding))\n// After\nusing (BrokerClient<IService1> client = new BrokerClient<IService1>(session))\n```\n\n    Or set explicitly using the basicHttpBinding.\n\n    ```\nBasicHttpBinding binding = new BasicHttpBinding(BasicHttpSecurityMode.TransportWithMessageCredential);\nbinding.Security.Message.ClientCredentialType = BasicHttpMessageCredentialType.UserName;    binding.Security.Transport.ClientCredentialType = HttpClientCredentialType.None;\n```\n\n* Optionally, set the UseAzureQueue flag to true in SessionStartInfo. If not set, it will be set to true by default when the cluster name has Azure domain suffixes and the TransportScheme is Http.\n\n    ```\n    info.UseAzureQueue = true;\n```\n\n###Use Http binding without Azure storage queue\n\nTo do this, explicitly set UseAzureQueue flag to false in the SessionStartInfo.\n\n```\n    info.UseAzureQueue = false;\n```\n\n### Use NetTcp binding\n\nTo use NetTcp binding, the configuration is like connecting to an on-premises cluster. You'll need to open a few endpoints on the head node VM. In the Azure Management Portal do the following.\n\n\n1. Stop the VM.\n\n2. Add the TCP ports 9090, 9087, 9091, 9094 for the Session, Broker, Broker worker and Data services, respectively\n\n    ![Configure endpoints][endpoint]\n\n3. Start the VM.\n\nThe SOA client application requires no changes except altering the head name to the IaaS cluster full name.\n\n## Next steps\n\n* See [these resources](http://social.technet.microsoft.com/wiki/contents/articles/1198.windows-hpc-and-microsoft-excel-resources-for-building-cluster-ready-workbooks.aspx) for more information about running Excel workloads with HPC Pack.\n\n* See [Managing SOA Services in Microsoft HPC Pack](https://technet.microsoft.com/library/ff919412.aspx) for more about deploying and managing SOA services with HPC Pack.\n\n<!--Image references-->\n[scenario]: ./media/virtual-machines-excel-cluster-hpcpack/scenario.png\n[github]: ./media/virtual-machines-excel-cluster-hpcpack/github.png\n[template]: ./media/virtual-machines-excel-cluster-hpcpack/template.png\n[parameters]: ./media/virtual-machines-excel-cluster-hpcpack/parameters.png\n[create]: ./media/virtual-machines-excel-cluster-hpcpack/create.png\n[connect]: ./media/virtual-machines-excel-cluster-hpcpack/connect.png\n[cert]: ./media/virtual-machines-excel-cluster-hpcpack/cert.png\n[addin]: ./media/virtual-machines-excel-cluster-hpcpack/addin.png\n[macro]: ./media/virtual-machines-excel-cluster-hpcpack/macro.png\n[options]: ./media/virtual-machines-excel-cluster-hpcpack/options.png\n[run]: ./media/virtual-machines-excel-cluster-hpcpack/run.png\n[endpoint]: ./media/virtual-machines-excel-cluster-hpcpack/endpoint.png\n[udf]: ./media/virtual-machines-excel-cluster-hpcpack/udf.png\n"
}