{
  "nodes": [
    {
      "content": "Serve Content from Azure CDN in Your Web Application",
      "pos": [
        28,
        80
      ]
    },
    {
      "content": "A tutorial that teaches you how to use content from a CDN to improve the performance of your Web application.",
      "pos": [
        100,
        209
      ]
    },
    {
      "content": "Serve Content from Azure CDN in Your Web Application",
      "pos": [
        515,
        567
      ]
    },
    {
      "content": "This tutorial shows you how to take advantage of Azure CDN to improve the reach and performance of your Web application.",
      "pos": [
        571,
        691
      ]
    },
    {
      "content": "Azure CDN can help improve the performance of your Web application when:",
      "pos": [
        692,
        764
      ]
    },
    {
      "content": "You have many links to static or semi-static content on your pages",
      "pos": [
        768,
        834
      ]
    },
    {
      "content": "Your application is accessed by clients globally",
      "pos": [
        837,
        885
      ]
    },
    {
      "content": "You want to offload traffic from your Web server",
      "pos": [
        888,
        936
      ]
    },
    {
      "pos": [
        939,
        1155
      ],
      "content": "You want to reduce the number of concurrent client connections to your Web server (there is a great discussion on this at <bpt id=\"p1\">[</bpt>Bundling and Minification<ept id=\"p1\">](http://www.asp.net/mvc/tutorials/mvc-4/bundling-and-minification)</ept>)"
    },
    {
      "content": "You want to increase the perceived load/refresh time of your pages",
      "pos": [
        1159,
        1225
      ]
    },
    {
      "content": "What you will learn",
      "pos": [
        1230,
        1249
      ]
    },
    {
      "content": "In this tutorial, you will learn how to do the following:",
      "pos": [
        1254,
        1311
      ]
    },
    {
      "content": "Serve static content from an Azure CDN endpoint",
      "pos": [
        1318,
        1365
      ]
    },
    {
      "content": "Automate content upload from your ASP.NET application to your CDN endpoint",
      "pos": [
        1381,
        1455
      ]
    },
    {
      "content": "Configure the CDN cache to reflect the desired content update",
      "pos": [
        1471,
        1532
      ]
    },
    {
      "content": "Serve fresh content immediately using query strings",
      "pos": [
        1548,
        1599
      ]
    },
    {
      "content": "What you will need",
      "pos": [
        1613,
        1631
      ]
    },
    {
      "content": "This tutorial has the following prerequisites:",
      "pos": [
        1636,
        1682
      ]
    },
    {
      "content": "An active <bpt id=\"p1\">[</bpt>Microsoft Azure account<ept id=\"p1\">](/account/)</ept>.",
      "pos": [
        1688,
        1735
      ]
    },
    {
      "content": "You can sign up for a trial account",
      "pos": [
        1736,
        1771
      ]
    },
    {
      "pos": [
        1776,
        1896
      ],
      "content": "Visual Studio 2013 with <bpt id=\"p1\">[</bpt>Azure SDK<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=323510&amp;clcid=0x409)</ept> for blob management GUI"
    },
    {
      "pos": [
        1901,
        2068
      ],
      "content": "<bpt id=\"p1\">[</bpt>Azure PowerShell<ept id=\"p1\">](http://go.microsoft.com/?linkid=9811175&amp;clcid=0x409)</ept> (used by <bpt id=\"p2\">[</bpt>Automate content upload from your ASP.NET application to your CDN endpoint<ept id=\"p2\">](#upload)</ept>)"
    },
    {
      "pos": [
        2072,
        2137
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> You need an Azure account to complete this tutorial:"
    },
    {
      "pos": [
        2142,
        2388
      ],
      "content": "You can <bpt id=\"p1\">[</bpt>open an Azure account for free<ept id=\"p1\">](/pricing/free-trial/?WT.mc_id=A261C142F)</ept> - You get credits you can use to try out paid Azure services, and even after they're used up you can keep the account and use free Azure services, such as Websites."
    },
    {
      "pos": [
        2393,
        2580
      ],
      "content": "You can <bpt id=\"p1\">[</bpt>activate MSDN subscriber benefits<ept id=\"p1\">](/pricing/member-offers/msdn-benefits-details/)</ept> - Your MSDN subscription gives you credits every month that you can use for paid Azure services."
    },
    {
      "content": "Serve static content from an Azure CDN endpoint",
      "pos": [
        2607,
        2654
      ]
    },
    {
      "content": "In this tutorial section, you will learn how to create a CDN and use it to serve your static content.",
      "pos": [
        2659,
        2760
      ]
    },
    {
      "content": "The major steps involved are:",
      "pos": [
        2761,
        2790
      ]
    },
    {
      "content": "Create a storage account",
      "pos": [
        2795,
        2819
      ]
    },
    {
      "content": "Create a CDN linked to the storage account",
      "pos": [
        2823,
        2865
      ]
    },
    {
      "content": "Create a blob container in your storage account",
      "pos": [
        2869,
        2916
      ]
    },
    {
      "content": "Upload content to your blob container",
      "pos": [
        2920,
        2957
      ]
    },
    {
      "content": "Link to the the content you uploaded using its CDN URL",
      "pos": [
        2961,
        3015
      ]
    },
    {
      "content": "Let's get to it.",
      "pos": [
        3017,
        3033
      ]
    },
    {
      "content": "Follow the steps below to start using the Azure CDN:",
      "pos": [
        3034,
        3086
      ]
    },
    {
      "pos": [
        3091,
        3190
      ],
      "content": "To create a CDN endpoint, log into your <bpt id=\"p1\">[</bpt>Azure management portal<ept id=\"p1\">](http://manage.windowsazure.com/)</ept>."
    },
    {
      "content": "Create a storage account by clicking <bpt id=\"p1\">**</bpt>New &gt; Data Services &gt; Storage &gt; Quick Create<ept id=\"p1\">**</ept>.",
      "pos": [
        3195,
        3281
      ]
    },
    {
      "content": "Specify a URL, a location, and click <bpt id=\"p1\">**</bpt>Create Storage Account<ept id=\"p1\">**</ept>.",
      "pos": [
        3282,
        3346
      ]
    },
    {
      "pos": [
        3438,
        3567
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> Note that I'm using East Asia as the region as it is far enough away for me to test my CDN from North America later."
    },
    {
      "content": "Once the new storage account's status is <bpt id=\"p1\">**</bpt>Online<ept id=\"p1\">**</ept>, create a new CDN endpoint that's tied to the storage account you created.",
      "pos": [
        3572,
        3698
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>New &gt; App Services &gt; CDN &gt; Quick Create<ept id=\"p1\">**</ept>.",
      "pos": [
        3699,
        3749
      ]
    },
    {
      "content": "Select the storage account you created and click <bpt id=\"p1\">**</bpt>Create<ept id=\"p1\">**</ept>.",
      "pos": [
        3750,
        3810
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> Once your CDN is created, the Azure portal will show you its URL and the origin domain that it's tied to.",
      "pos": [
        3901,
        4019
      ]
    },
    {
      "content": "However, it can take awhile for the CDN endpoint's configuration to be fully propagated to all the node locations.",
      "pos": [
        4020,
        4134
      ]
    },
    {
      "content": "Test your CDN endpoint to make sure that it's online by pinging it.",
      "pos": [
        4141,
        4208
      ]
    },
    {
      "content": "If your CDN endpoint has not propagated to all the nodes, you will see a message similar to the one below.",
      "pos": [
        4209,
        4315
      ]
    },
    {
      "content": "Wait another hour and test again.",
      "pos": [
        4410,
        4443
      ]
    },
    {
      "content": "Once your CDN endpoint has finished propagating to the nodes, it should respond to your pings.",
      "pos": [
        4444,
        4538
      ]
    },
    {
      "content": "At this point, you can already see where the CDN endpoint determines to be the closest CDN node to you.",
      "pos": [
        4635,
        4738
      ]
    },
    {
      "content": "From my desktop computer, the responding IP address is <bpt id=\"p1\">**</bpt>93.184.215.201<ept id=\"p1\">**</ept>.",
      "pos": [
        4739,
        4813
      ]
    },
    {
      "content": "Plug it into a site like <bpt id=\"p1\">[</bpt>www.ip-address.org<ept id=\"p1\">](http://www.ip-address.org)</ept> and see that the server is located in Washington D.C.",
      "pos": [
        4814,
        4940
      ]
    },
    {
      "pos": [
        5030,
        5181
      ],
      "content": "For a list of all CDN node locations, see <bpt id=\"p1\">[</bpt>Azure Content Delivery Network (CDN) Node Locations<ept id=\"p1\">](http://msdn.microsoft.com/library/azure/gg680302.aspx)</ept>."
    },
    {
      "pos": [
        5186,
        5284
      ],
      "content": "Back in the Azure portal, in the <bpt id=\"p1\">**</bpt>CDN<ept id=\"p1\">**</ept> tab, click the name of the CDN endpoint you just created."
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Enable Query String<ept id=\"p1\">**</ept> to enable query strings in the Azure CDN cache.",
      "pos": [
        5386,
        5463
      ]
    },
    {
      "content": "Once you enable this, the same link accessed with different query strings will be cached as separate entries.",
      "pos": [
        5464,
        5573
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> While enabling the query string is not necessary for this part of the tutorial, you want to do this as early as possible for convenience sake since any change here is going to take time to propagate to the rest of the nodes, and you don't want any non-query-string-enabled content to clog up the CDN cache (updating CDN content will be discussed later).",
      "pos": [
        5677,
        6043
      ]
    },
    {
      "content": "You will find out how to take advantage of this in <bpt id=\"p1\">[</bpt>Serve fresh content immediately through query strings<ept id=\"p1\">](#query)</ept>.",
      "pos": [
        6044,
        6159
      ]
    },
    {
      "pos": [
        6164,
        6255
      ],
      "content": "In Visual Studio 2013, in Server Explorer, click the <bpt id=\"p1\">**</bpt>Connect to Microsoft Azure<ept id=\"p1\">**</ept> button."
    },
    {
      "content": "Follow the prompt to sign into your Azure account.",
      "pos": [
        6345,
        6395
      ]
    },
    {
      "content": "Once you sign in, expand the <bpt id=\"p1\">**</bpt>Microsoft Azure &gt; Storage &gt; your storage account<ept id=\"p1\">**</ept>.",
      "pos": [
        6401,
        6483
      ]
    },
    {
      "content": "Right-click <bpt id=\"p1\">**</bpt>Blob<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Create Blob Container<ept id=\"p2\">**</ept>.",
      "pos": [
        6484,
        6542
      ]
    },
    {
      "pos": [
        6632,
        6679
      ],
      "content": "Specify a blob container name and click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>."
    },
    {
      "content": "In Server Explorer, double-click the blob container you created to manage it.",
      "pos": [
        6769,
        6846
      ]
    },
    {
      "content": "You should see the management interface in the center pane.",
      "pos": [
        6847,
        6906
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>Upload Blob<ept id=\"p1\">**</ept> button to upload images, scripts, or stylesheets that are used by your Web pages into the blob container.",
      "pos": [
        6996,
        7127
      ]
    },
    {
      "content": "The upload progress will be shown in the <bpt id=\"p1\">**</bpt>Azure Activity Log<ept id=\"p1\">**</ept>, and the blobs will appear in the container view when they are uploaded.",
      "pos": [
        7128,
        7264
      ]
    },
    {
      "content": "Now that you have uploaded the blobs, you must make them public for you to access them.",
      "pos": [
        7355,
        7442
      ]
    },
    {
      "content": "In Server Explorer, right-click the container and select <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept>.",
      "pos": [
        7443,
        7515
      ]
    },
    {
      "content": "Set the <bpt id=\"p1\">**</bpt>Public Read Access<ept id=\"p1\">**</ept> property to <bpt id=\"p2\">**</bpt>Blob<ept id=\"p2\">**</ept>.",
      "pos": [
        7516,
        7568
      ]
    },
    {
      "content": "Test the public access of your blobs by navigating to the URL for one of the blobs in a browser.",
      "pos": [
        7659,
        7755
      ]
    },
    {
      "content": "For example, I can test the first image in my uploaded list with <ph id=\"ph1\">`http://cephalinstorage.blob.core.windows.net/cdn/cephas_lin.png`</ph>.",
      "pos": [
        7756,
        7887
      ]
    },
    {
      "content": "Note that I'm not using the HTTPS address given in the blob management interface in Visual Studio.",
      "pos": [
        7893,
        7991
      ]
    },
    {
      "content": "By using HTTP, you test whether the content is publicly accessible, which is a requirement for Azure CDN.",
      "pos": [
        7992,
        8097
      ]
    },
    {
      "content": "If you can see the blob rendered properly in your browser, change the URL from <ph id=\"ph1\">`http://&lt;yourStorageAccountName&gt;.blob.core.windows.net`</ph> to the URL of your Azure CDN.",
      "pos": [
        8103,
        8267
      ]
    },
    {
      "content": "In my case, to test the first image at my CDN endpoint, I would use <ph id=\"ph1\">`http://az623979.vo.msecnd.net/cdn/cephas_lin.png`</ph>.",
      "pos": [
        8268,
        8387
      ]
    },
    {
      "pos": [
        8394,
        8490
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> You can find the CDN endpoint's URL in the Azure management portal, in the CDN tab."
    },
    {
      "content": "If you compare the performance of direct blob access and CDN access, you can see the performance gain from using Azure CDN.",
      "pos": [
        8496,
        8619
      ]
    },
    {
      "content": "Below is the Internet Explorer 11 F12 developer tools screenshot for blob URL access of my image:",
      "pos": [
        8620,
        8717
      ]
    },
    {
      "content": "And for CDN URL access of the same image",
      "pos": [
        8813,
        8853
      ]
    },
    {
      "content": "Pay attention to the numbers for the <bpt id=\"p1\">**</bpt>Request<ept id=\"p1\">**</ept> timing, which is the time to first byte, or the time taken to send the request and receive the first response from the server.",
      "pos": [
        8949,
        9124
      ]
    },
    {
      "content": "When I access the blob, which is hosted in the East Asia region, it takes 266 ms for me - since the request must traverse the entire Pacific Ocean just to get to the server.",
      "pos": [
        9125,
        9298
      ]
    },
    {
      "content": "However, when I access the Azure CDN, it takes only 16 ms, which is nearly a <bpt id=\"p1\">**</bpt>20-fold gain in performance<ept id=\"p1\">**</ept>!",
      "pos": [
        9299,
        9408
      ]
    },
    {
      "content": "Now, it's just a matter of using the new link in your Web page.",
      "pos": [
        9418,
        9481
      ]
    },
    {
      "content": "For example, I can add the following image tag:",
      "pos": [
        9482,
        9529
      ]
    },
    {
      "content": "In this section, you have learned how to create a CDN endpoint, upload content to it, and link to CDN contentfrom any Web page.",
      "pos": [
        9617,
        9744
      ]
    },
    {
      "content": "Automate content upload from your ASP.NET application to your CDN endpoint",
      "pos": [
        9771,
        9845
      ]
    },
    {
      "content": "If you want to easily upload all of the static content in your ASP.NET Web application to your CDN endpoint, or if your deploy your Web application using continuous delivery (for an example, see <bpt id=\"p1\">[</bpt>Continuous Delivery for Cloud Services in Azure<ept id=\"p1\">](../cloud-services/cloud-services-dotnet-continuous-delivery.md)</ept>), you can use Azure PowerShell to automate the synchronization of the latest content files to Azure blobs every time you deploy your Web application.",
      "pos": [
        9850,
        10308
      ]
    },
    {
      "content": "For example, you can run the script at <bpt id=\"p1\">[</bpt>Upload Content Files from ASP.NET Application to Azure Blobs<ept id=\"p1\">](http://gallery.technet.microsoft.com/scriptcenter/Upload-Content-Files-from-41c2142a)</ept> upload all the content files in an ASP.NET application.",
      "pos": [
        10309,
        10552
      ]
    },
    {
      "content": "To use this script:",
      "pos": [
        10553,
        10572
      ]
    },
    {
      "pos": [
        10577,
        10637
      ],
      "content": "From the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> menu, run <bpt id=\"p2\">**</bpt>Microsoft Azure PowerShell<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        10641,
        10767
      ],
      "content": "In the Azure PowerShell window, run <ph id=\"ph1\">`Get-AzurePublishSettingsFile`</ph> to download a publish settings file for your Azure account."
    },
    {
      "content": "Once you have downloaded your publish settings file, run the following:",
      "pos": [
        10771,
        10842
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> Once you import your publish settings file, it will be the default Azure account used for all Azure PowerShell sessions.",
      "pos": [
        10918,
        11051
      ]
    },
    {
      "content": "This means that the above steps only need to be done once.",
      "pos": [
        11052,
        11110
      ]
    },
    {
      "content": "Download the script from the <bpt id=\"p1\">[</bpt>download page<ept id=\"p1\">](http://gallery.technet.microsoft.com/scriptcenter/Upload-Content-Files-from-41c2142a)</ept>.",
      "pos": [
        11119,
        11250
      ]
    },
    {
      "content": "Save it into your ASP.NET application's project folder.",
      "pos": [
        11251,
        11306
      ]
    },
    {
      "pos": [
        11310,
        11369
      ],
      "content": "Right-click the downloaded script and click <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        11373,
        11391
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Unblock<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Open a PowerShell window and run the following:",
      "pos": [
        11395,
        11442
      ]
    },
    {
      "content": "This script uploads all files from your <bpt id=\"p1\">*</bpt>\\Content<ept id=\"p1\">*</ept> and <bpt id=\"p2\">*</bpt>\\Scripts<ept id=\"p2\">*</ept> folders to the specified storage account and container.",
      "pos": [
        11595,
        11716
      ]
    },
    {
      "content": "It has the following advantages:",
      "pos": [
        11717,
        11749
      ]
    },
    {
      "content": "Automatically replicate the file structure of your Visual Studio project",
      "pos": [
        11755,
        11827
      ]
    },
    {
      "content": "Automatically create blob containers as needed",
      "pos": [
        11832,
        11878
      ]
    },
    {
      "content": "Reuse the same Azure storage account and CDN endpoint for multiple Web applications, each in a separate blob container",
      "pos": [
        11883,
        12001
      ]
    },
    {
      "content": "Easily update the Azure CDN with new content.",
      "pos": [
        12006,
        12051
      ]
    },
    {
      "content": "For more information on updating content, see <bpt id=\"p1\">[</bpt>Configure the CDN cache to reflect the desired content update<ept id=\"p1\">](#update)</ept>.",
      "pos": [
        12052,
        12171
      ]
    },
    {
      "content": "For the <ph id=\"ph1\">`-StorageContainer`</ph> parameter, it makes sense to use the name of your Web application, or the Visual Studio project name.",
      "pos": [
        12173,
        12302
      ]
    },
    {
      "content": "Whereas I used the generic \"cdn\" as the container name previously, using the name of your Web application allows related content to be organized into the same easily identifiable container.",
      "pos": [
        12303,
        12492
      ]
    },
    {
      "content": "Once the content has finished uploading, you can link to anything in your <bpt id=\"p1\">*</bpt>\\Content<ept id=\"p1\">*</ept> and <bpt id=\"p2\">*</bpt>\\Scripts<ept id=\"p2\">*</ept> folder in your HTML code, such as in your .cshtml files, using <ph id=\"ph1\">`http://&lt;yourCDNName&gt;.vo.msecnd.net/&lt;containerName&gt;`</ph>.",
      "pos": [
        12494,
        12710
      ]
    },
    {
      "content": "Here is an example of something I can use in a Razor view:",
      "pos": [
        12711,
        12769
      ]
    },
    {
      "pos": [
        12867,
        13079
      ],
      "content": "For an example of integrating PowerShell scripts into your continuous delivery configuration, see <bpt id=\"p1\">[</bpt>Continuous Delivery for Cloud Services in Azure<ept id=\"p1\">](../cloud-services/cloud-services-dotnet-continuous-delivery.md)</ept>."
    },
    {
      "content": "Configure the CDN cache to reflect the desired content update",
      "pos": [
        13107,
        13168
      ]
    },
    {
      "content": "Now, suppose after you have uploaded the static files from your Web app in a blob container, you make a change to one of the files in your project and upload it to the blob container again.",
      "pos": [
        13173,
        13362
      ]
    },
    {
      "content": "You may think that it's automatically updated to your CDN endpoint, but are actually puzzled why you don't see the update reflected when you access the content's CDN URL.",
      "pos": [
        13363,
        13533
      ]
    },
    {
      "content": "The truth is that the CDN does indeed automatically update from your blob storage, but it does so by applying a default 7-day caching rule to the content.",
      "pos": [
        13536,
        13690
      ]
    },
    {
      "content": "This means that once a CDN node pulls your content from blob storage, the same content is not refreshed until it expires in the cache.",
      "pos": [
        13691,
        13825
      ]
    },
    {
      "content": "The good news is that you can customize cache expiration.",
      "pos": [
        13827,
        13884
      ]
    },
    {
      "content": "Similar to most browsers, Azure CDN respects the expiration time specified in the content's Cache-Control header.",
      "pos": [
        13885,
        13998
      ]
    },
    {
      "content": "You can specify a custom Cache-Control header value by navigating to the blob container in the Azure portal and editing the blob properties.",
      "pos": [
        13999,
        14139
      ]
    },
    {
      "content": "The screenshot below shows cache expiration set to 1 hour (3600 seconds).",
      "pos": [
        14140,
        14213
      ]
    },
    {
      "content": "You can also do this in your PowerShell script to set all blobs' Cache-Control headers.",
      "pos": [
        14297,
        14384
      ]
    },
    {
      "content": "For the script in <bpt id=\"p1\">[</bpt>Automate content upload from your ASP.NET application to your CDN endpoint<ept id=\"p1\">](#upload)</ept>, find the following code snippet:",
      "pos": [
        14385,
        14522
      ]
    },
    {
      "content": "and modify it as follows:",
      "pos": [
        14752,
        14777
      ]
    },
    {
      "content": "You may still need to wait for the full 7-day cached content on your Azure CDN to expire before it pulls the new content, with the new Cache-Control header.",
      "pos": [
        15046,
        15202
      ]
    },
    {
      "content": "This illustrates the fact that custom caching values do not help if you want your content update to go live immediately, such as JavaScript or CSS updates.",
      "pos": [
        15203,
        15358
      ]
    },
    {
      "content": "However, you can work around this issue by renamiving the files or versioning them through query strings.",
      "pos": [
        15359,
        15464
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Serve fresh content immediately using query strings<ept id=\"p1\">](#query)</ept>.",
      "pos": [
        15465,
        15553
      ]
    },
    {
      "content": "There is, of course, a time and place for caching.",
      "pos": [
        15555,
        15605
      ]
    },
    {
      "content": "For example, you may have content that does not require the frequent update, such as the upcoming World Cup games that can be refreshed every 3 hours, but gets enough global traffic that you want to offload it from your own Web server.",
      "pos": [
        15606,
        15841
      ]
    },
    {
      "content": "That can be a good candidate to use the Azure CDN caching.",
      "pos": [
        15842,
        15900
      ]
    },
    {
      "content": "Serve fresh content immediately using query strings",
      "pos": [
        15926,
        15977
      ]
    },
    {
      "content": "In Azure CDN, you can enable query strings so that content from URLs with specific query strings are cached separately.",
      "pos": [
        15982,
        16101
      ]
    },
    {
      "content": "This is a great feature to use if you want to push certain content updates to the client browsers immediately instead of waiting for the cached CDN content to expire.",
      "pos": [
        16102,
        16268
      ]
    },
    {
      "content": "Suppose I publish my Web page with a version number in the URL.",
      "pos": [
        16269,
        16332
      ]
    },
    {
      "content": "When I publish a CSS update and use a different version number in my CSS URL:",
      "pos": [
        16442,
        16519
      ]
    },
    {
      "content": "To a CDN endpoint that has query strings enabled, the two URLs are unique to each other, and it will make a new request to my Web server to retrieve the new <bpt id=\"p1\">*</bpt>bootstrap.css<ept id=\"p1\">*</ept>.",
      "pos": [
        16629,
        16802
      ]
    },
    {
      "content": "To a CDN endpoint that doesn't have query strings enabled, however, these are the same URL, and it will simply serve the cached <bpt id=\"p1\">*</bpt>bootstrap.css<ept id=\"p1\">*</ept>.",
      "pos": [
        16803,
        16947
      ]
    },
    {
      "content": "The trick then is to update the version number automatically.",
      "pos": [
        16950,
        17011
      ]
    },
    {
      "content": "In Visual Studio, this is easy to do.",
      "pos": [
        17012,
        17049
      ]
    },
    {
      "content": "In a .cshtml file where I would use the link above, I can specify a version number based on the assembly number.",
      "pos": [
        17050,
        17162
      ]
    },
    {
      "content": "If you change the assembly number as part of every publish cycle, then you can likewise be sure to get a unique version number every time you publish your Web app, which will remain the same until the next publish cycle.",
      "pos": [
        17474,
        17694
      ]
    },
    {
      "content": "Or, you can make Visual Studio automatically increment the assembly version number every time the Web app builds by opening <bpt id=\"p1\">*</bpt>Properties\\AssemblyInfo.cs<ept id=\"p1\">*</ept> in your Visual Studio project and use <ph id=\"ph1\">`*`</ph> in <ph id=\"ph2\">`AssemblyVersion`</ph>.",
      "pos": [
        17695,
        17911
      ]
    },
    {
      "content": "For example:",
      "pos": [
        17912,
        17924
      ]
    },
    {
      "content": "What about bundled scripts and stylesheets in ASP.NET?",
      "pos": [
        17973,
        18027
      ]
    },
    {
      "pos": [
        18032,
        18314
      ],
      "content": "With <bpt id=\"p1\">[</bpt>Azure App Service Web Apps<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=529714)</ept> and <bpt id=\"p2\">[</bpt>Azure Cloud Services<ept id=\"p2\">](/services/cloud-services/)</ept>, you get the best Azure CDN integration with <bpt id=\"p3\">[</bpt>ASP.NET bundling and minification<ept id=\"p3\">](http://www.asp.net/mvc/tutorials/mvc-4/bundling-and-minification)</ept>."
    },
    {
      "content": "Integrating Azure App Service or Azure Cloud Services with Azure CDN gives you the following advantages:",
      "pos": [
        18317,
        18421
      ]
    },
    {
      "pos": [
        18425,
        18592
      ],
      "content": "Integrate content deployment (images, scripts, and stylesheets) as part of your Azure web app's <bpt id=\"p1\">[</bpt>continuous deployment<ept id=\"p1\">](../web-sites-publish-source-control.md)</ept> process"
    },
    {
      "content": "Easily upgrade your CDN-served NuGet packages, such as jQuery or Bootstrap versions",
      "pos": [
        18595,
        18678
      ]
    },
    {
      "content": "Manage your Web application and your CDN-served content from the same Visual Studio interface",
      "pos": [
        18682,
        18775
      ]
    },
    {
      "content": "For related tutorials, see:",
      "pos": [
        18777,
        18804
      ]
    },
    {
      "content": "Use Azure CDN in Azure App Service",
      "pos": [
        18808,
        18842
      ]
    },
    {
      "content": "Integrate a cloud service with Azure CDN",
      "pos": [
        18876,
        18916
      ]
    },
    {
      "content": "Without integration with Azure App Service Web Apps or Azure Cloud Services, it is possible to use Azure CDN for your script bundles, with the following caveats:",
      "pos": [
        18950,
        19111
      ]
    },
    {
      "content": "You must manually upload the bundled scripts to blob storage.",
      "pos": [
        19115,
        19176
      ]
    },
    {
      "content": "A programmatic solution is proposed at <bpt id=\"p1\">[</bpt>stackoverflow<ept id=\"p1\">](http://stackoverflow.com/a/13736433)</ept>.",
      "pos": [
        19177,
        19269
      ]
    },
    {
      "content": "In your .cshtml files, transform the rendered script/CSS tags to use the Azure CDN.",
      "pos": [
        19272,
        19355
      ]
    },
    {
      "content": "For example:",
      "pos": [
        19356,
        19368
      ]
    },
    {
      "content": "More Information",
      "pos": [
        19483,
        19499
      ]
    },
    {
      "content": "Overview of the Azure Content Delivery Network (CDN)",
      "pos": [
        19506,
        19558
      ]
    },
    {
      "content": "Use Azure CDN in Azure App Service",
      "pos": [
        19580,
        19614
      ]
    },
    {
      "content": "Integrate a cloud service with Azure CDN",
      "pos": [
        19648,
        19688
      ]
    },
    {
      "content": "How to Map Content Delivery Network (CDN) Content to a Custom Domain",
      "pos": [
        19724,
        19792
      ]
    },
    {
      "content": "Using CDN for Azure",
      "pos": [
        19852,
        19871
      ]
    },
    {
      "content": "test",
      "pos": [
        19899,
        19903
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"Serve Content from Azure CDN in Your Web Application\" \n    description=\"A tutorial that teaches you how to use content from a CDN to improve the performance of your Web application.\" \n    services=\"cdn\" \n    documentationCenter=\".net\" \n    authors=\"cephalin\" \n    manager=\"wpickett\" \n    editor=\"jimbe\"/>\n\n<tags \n    ms.service=\"cdn\" \n    ms.workload=\"web\" \n    ms.tgt_pltfrm=\"na\" \n    ms.devlang=\"dotnet\" \n    ms.topic=\"article\" \n    ms.date=\"09/01/2015\" \n    ms.author=\"cephalin\"/>\n\n# Serve Content from Azure CDN in Your Web Application #\n\nThis tutorial shows you how to take advantage of Azure CDN to improve the reach and performance of your Web application. Azure CDN can help improve the performance of your Web application when:\n\n- You have many links to static or semi-static content on your pages\n- Your application is accessed by clients globally\n- You want to offload traffic from your Web server\n- You want to reduce the number of concurrent client connections to your Web server (there is a great discussion on this at [Bundling and Minification](http://www.asp.net/mvc/tutorials/mvc-4/bundling-and-minification)) \n- You want to increase the perceived load/refresh time of your pages\n\n## What you will learn ##\n\nIn this tutorial, you will learn how to do the following:\n\n-   [Serve static content from an Azure CDN endpoint](#deploy)\n-   [Automate content upload from your ASP.NET application to your CDN endpoint](#upload)\n-   [Configure the CDN cache to reflect the desired content update](#update)\n-   [Serve fresh content immediately using query strings](#query)\n\n## What you will need ##\n\nThis tutorial has the following prerequisites:\n\n-   An active [Microsoft Azure account](/account/). You can sign up for a trial account\n-   Visual Studio 2013 with [Azure SDK](http://go.microsoft.com/fwlink/p/?linkid=323510&clcid=0x409) for blob management GUI\n-   [Azure PowerShell](http://go.microsoft.com/?linkid=9811175&clcid=0x409) (used by [Automate content upload from your ASP.NET application to your CDN endpoint](#upload))\n\n> [AZURE.NOTE] You need an Azure account to complete this tutorial:\n> + You can [open an Azure account for free](/pricing/free-trial/?WT.mc_id=A261C142F) - You get credits you can use to try out paid Azure services, and even after they're used up you can keep the account and use free Azure services, such as Websites.\n> + You can [activate MSDN subscriber benefits](/pricing/member-offers/msdn-benefits-details/) - Your MSDN subscription gives you credits every month that you can use for paid Azure services.\n\n<a name=\"static\"></a>\n## Serve static content from an Azure CDN endpoint ##\n\nIn this tutorial section, you will learn how to create a CDN and use it to serve your static content. The major steps involved are:\n\n1. Create a storage account\n2. Create a CDN linked to the storage account\n3. Create a blob container in your storage account\n4. Upload content to your blob container\n5. Link to the the content you uploaded using its CDN URL\n\nLet's get to it. Follow the steps below to start using the Azure CDN:\n\n1. To create a CDN endpoint, log into your [Azure management portal](http://manage.windowsazure.com/). \n1. Create a storage account by clicking **New > Data Services > Storage > Quick Create**. Specify a URL, a location, and click **Create Storage Account**. \n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-1.PNG)\n\n    >[AZURE.NOTE] Note that I'm using East Asia as the region as it is far enough away for me to test my CDN from North America later.\n\n2. Once the new storage account's status is **Online**, create a new CDN endpoint that's tied to the storage account you created. Click **New > App Services > CDN > Quick Create**. Select the storage account you created and click **Create**.\n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-2.PNG)\n\n    >[AZURE.NOTE] Once your CDN is created, the Azure portal will show you its URL and the origin domain that it's tied to. However, it can take awhile for the CDN endpoint's configuration to be fully propagated to all the node locations.  \n\n3. Test your CDN endpoint to make sure that it's online by pinging it. If your CDN endpoint has not propagated to all the nodes, you will see a message similar to the one below.\n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-3-fail.PNG)\n\n    Wait another hour and test again. Once your CDN endpoint has finished propagating to the nodes, it should respond to your pings.\n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-3-succeed.PNG)\n\n4. At this point, you can already see where the CDN endpoint determines to be the closest CDN node to you. From my desktop computer, the responding IP address is **93.184.215.201**. Plug it into a site like [www.ip-address.org](http://www.ip-address.org) and see that the server is located in Washington D.C.\n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-4.PNG)\n\n    For a list of all CDN node locations, see [Azure Content Delivery Network (CDN) Node Locations](http://msdn.microsoft.com/library/azure/gg680302.aspx).\n\n3. Back in the Azure portal, in the **CDN** tab, click the name of the CDN endpoint you just created.\n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-2-enablequerya.PNG)\n\n3. Click **Enable Query String** to enable query strings in the Azure CDN cache. Once you enable this, the same link accessed with different query strings will be cached as separate entries.\n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-2-enablequeryb.PNG)\n\n    >[AZURE.NOTE] While enabling the query string is not necessary for this part of the tutorial, you want to do this as early as possible for convenience sake since any change here is going to take time to propagate to the rest of the nodes, and you don't want any non-query-string-enabled content to clog up the CDN cache (updating CDN content will be discussed later). You will find out how to take advantage of this in [Serve fresh content immediately through query strings](#query).\n\n6. In Visual Studio 2013, in Server Explorer, click the **Connect to Microsoft Azure** button.\n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-5.PNG)\n\n7.  Follow the prompt to sign into your Azure account. \n8.  Once you sign in, expand the **Microsoft Azure > Storage > your storage account**. Right-click **Blob** and select **Create Blob Container**.\n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-6.PNG)\n\n8.  Specify a blob container name and click **OK**.\n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-7.PNG)\n\n9.  In Server Explorer, double-click the blob container you created to manage it. You should see the management interface in the center pane.\n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-8.PNG)\n\n10. Click the **Upload Blob** button to upload images, scripts, or stylesheets that are used by your Web pages into the blob container. The upload progress will be shown in the **Azure Activity Log**, and the blobs will appear in the container view when they are uploaded. \n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-9.PNG)\n\n11. Now that you have uploaded the blobs, you must make them public for you to access them. In Server Explorer, right-click the container and select **Properties**. Set the **Public Read Access** property to **Blob**.\n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-10.PNG)\n\n12. Test the public access of your blobs by navigating to the URL for one of the blobs in a browser. For example, I can test the first image in my uploaded list with `http://cephalinstorage.blob.core.windows.net/cdn/cephas_lin.png`.\n\n    Note that I'm not using the HTTPS address given in the blob management interface in Visual Studio. By using HTTP, you test whether the content is publicly accessible, which is a requirement for Azure CDN.\n\n13. If you can see the blob rendered properly in your browser, change the URL from `http://<yourStorageAccountName>.blob.core.windows.net` to the URL of your Azure CDN. In my case, to test the first image at my CDN endpoint, I would use `http://az623979.vo.msecnd.net/cdn/cephas_lin.png`.\n\n    >[AZURE.NOTE] You can find the CDN endpoint's URL in the Azure management portal, in the CDN tab.\n\n    If you compare the performance of direct blob access and CDN access, you can see the performance gain from using Azure CDN. Below is the Internet Explorer 11 F12 developer tools screenshot for blob URL access of my image:\n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-11-blob.PNG)\n\n    And for CDN URL access of the same image \n\n    ![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-static-11-cdn.PNG)\n\n    Pay attention to the numbers for the **Request** timing, which is the time to first byte, or the time taken to send the request and receive the first response from the server. When I access the blob, which is hosted in the East Asia region, it takes 266 ms for me - since the request must traverse the entire Pacific Ocean just to get to the server. However, when I access the Azure CDN, it takes only 16 ms, which is nearly a **20-fold gain in performance**!\n    \n15. Now, it's just a matter of using the new link in your Web page. For example, I can add the following image tag:\n\n        <img alt=\"Mugshot\" src=\"http://az623979.vo.msecnd.net/cdn/cephas_lin.png\" />\n\nIn this section, you have learned how to create a CDN endpoint, upload content to it, and link to CDN contentfrom any Web page.\n\n<a name=\"upload\"></a>\n## Automate content upload from your ASP.NET application to your CDN endpoint ##\n\nIf you want to easily upload all of the static content in your ASP.NET Web application to your CDN endpoint, or if your deploy your Web application using continuous delivery (for an example, see [Continuous Delivery for Cloud Services in Azure](../cloud-services/cloud-services-dotnet-continuous-delivery.md)), you can use Azure PowerShell to automate the synchronization of the latest content files to Azure blobs every time you deploy your Web application. For example, you can run the script at [Upload Content Files from ASP.NET Application to Azure Blobs](http://gallery.technet.microsoft.com/scriptcenter/Upload-Content-Files-from-41c2142a) upload all the content files in an ASP.NET application. To use this script:\n\n4. From the **Start** menu, run **Microsoft Azure PowerShell**.\n5. In the Azure PowerShell window, run `Get-AzurePublishSettingsFile` to download a publish settings file for your Azure account.\n6. Once you have downloaded your publish settings file, run the following: \n\n        Import-AzurePublishSettingsFile \"<yourDownloadedFilePath>\"\n\n    >[AZURE.NOTE] Once you import your publish settings file, it will be the default Azure account used for all Azure PowerShell sessions. This means that the above steps only need to be done once.\n    \n1. Download the script from the [download page](http://gallery.technet.microsoft.com/scriptcenter/Upload-Content-Files-from-41c2142a). Save it into your ASP.NET application's project folder.\n2. Right-click the downloaded script and click **Properties**.\n3. Click **Unblock**.\n4. Open a PowerShell window and run the following:\n\n        cd <ProjectFolder>\n        .\\UploadContentToAzureBlobs.ps1 -StorageAccount \"<yourStorageAccountName>\" -StorageContainer \"<yourContainerName>\"\n\nThis script uploads all files from your *\\Content* and *\\Scripts* folders to the specified storage account and container. It has the following advantages:\n\n-   Automatically replicate the file structure of your Visual Studio project\n-   Automatically create blob containers as needed\n-   Reuse the same Azure storage account and CDN endpoint for multiple Web applications, each in a separate blob container\n-   Easily update the Azure CDN with new content. For more information on updating content, see [Configure the CDN cache to reflect the desired content update](#update).\n\nFor the `-StorageContainer` parameter, it makes sense to use the name of your Web application, or the Visual Studio project name. Whereas I used the generic \"cdn\" as the container name previously, using the name of your Web application allows related content to be organized into the same easily identifiable container.\n\nOnce the content has finished uploading, you can link to anything in your *\\Content* and *\\Scripts* folder in your HTML code, such as in your .cshtml files, using `http://<yourCDNName>.vo.msecnd.net/<containerName>`. Here is an example of something I can use in a Razor view: \n\n    <img alt=\"Mugshot\" src=\"http://az623979.vo.msecnd.net/MyMvcApp/Content/cephas_lin.png\" />\n\nFor an example of integrating PowerShell scripts into your continuous delivery configuration, see [Continuous Delivery for Cloud Services in Azure](../cloud-services/cloud-services-dotnet-continuous-delivery.md). \n\n<a name=\"update\"></a>\n## Configure the CDN cache to reflect the desired content update ##\n\nNow, suppose after you have uploaded the static files from your Web app in a blob container, you make a change to one of the files in your project and upload it to the blob container again. You may think that it's automatically updated to your CDN endpoint, but are actually puzzled why you don't see the update reflected when you access the content's CDN URL. \n\nThe truth is that the CDN does indeed automatically update from your blob storage, but it does so by applying a default 7-day caching rule to the content. This means that once a CDN node pulls your content from blob storage, the same content is not refreshed until it expires in the cache.\n\nThe good news is that you can customize cache expiration. Similar to most browsers, Azure CDN respects the expiration time specified in the content's Cache-Control header. You can specify a custom Cache-Control header value by navigating to the blob container in the Azure portal and editing the blob properties. The screenshot below shows cache expiration set to 1 hour (3600 seconds). \n\n![](media/cdn-serve-content-from-cdn-in-your-web-application/cdn-updates-1.PNG)\n\nYou can also do this in your PowerShell script to set all blobs' Cache-Control headers. For the script in [Automate content upload from your ASP.NET application to your CDN endpoint](#upload), find the following code snippet:\n\n    Set-AzureStorageBlobContent `\n        -Container $StorageContainer `\n        -Context $context `\n        -File $file.FullName `\n        -Blob $blobFileName `\n        -Properties @{ContentType=$contentType} `\n        -Force\n\nand modify it as follows:  \n\n    Set-AzureStorageBlobContent `\n        -Container $StorageContainer `\n        -Context $context `\n        -File $file.FullName `\n        -Blob $blobFileName `\n        -Properties @{ContentType=$contentType; CacheControl=\"public, max-age=3600\"} `\n        -Force\n\nYou may still need to wait for the full 7-day cached content on your Azure CDN to expire before it pulls the new content, with the new Cache-Control header. This illustrates the fact that custom caching values do not help if you want your content update to go live immediately, such as JavaScript or CSS updates. However, you can work around this issue by renamiving the files or versioning them through query strings. For more information, see [Serve fresh content immediately using query strings](#query).\n\nThere is, of course, a time and place for caching. For example, you may have content that does not require the frequent update, such as the upcoming World Cup games that can be refreshed every 3 hours, but gets enough global traffic that you want to offload it from your own Web server. That can be a good candidate to use the Azure CDN caching.\n\n<a name=\"query\"></a>\n## Serve fresh content immediately using query strings ##\n\nIn Azure CDN, you can enable query strings so that content from URLs with specific query strings are cached separately. This is a great feature to use if you want to push certain content updates to the client browsers immediately instead of waiting for the cached CDN content to expire. Suppose I publish my Web page with a version number in the URL.\n  \n    <link href=\"http://az623979.vo.msecnd.net/MyMvcApp/Content/bootstrap.css?v=3.0.0\" rel=\"stylesheet\"/>\n\nWhen I publish a CSS update and use a different version number in my CSS URL:  \n\n    <link href=\"http://az623979.vo.msecnd.net/MyMvcApp/Content/bootstrap.css?v=3.1.1\" rel=\"stylesheet\"/>\n\nTo a CDN endpoint that has query strings enabled, the two URLs are unique to each other, and it will make a new request to my Web server to retrieve the new *bootstrap.css*. To a CDN endpoint that doesn't have query strings enabled, however, these are the same URL, and it will simply serve the cached *bootstrap.css*. \n\nThe trick then is to update the version number automatically. In Visual Studio, this is easy to do. In a .cshtml file where I would use the link above, I can specify a version number based on the assembly number.  \n\n    @{\n        var cdnVersion = System.Reflection.Assembly.GetAssembly(\n            typeof(MyMvcApp.Controllers.HomeController))\n            .GetName().Version.ToString();\n    }\n    \n    ...\n    \n    <link href=\"http://az623979.vo.msecnd.net/MyMvcApp/Content/bootstrap.css?v=@cdnVersion\" rel=\"stylesheet\"/>\n\nIf you change the assembly number as part of every publish cycle, then you can likewise be sure to get a unique version number every time you publish your Web app, which will remain the same until the next publish cycle. Or, you can make Visual Studio automatically increment the assembly version number every time the Web app builds by opening *Properties\\AssemblyInfo.cs* in your Visual Studio project and use `*` in `AssemblyVersion`. For example:\n\n    [assembly: AssemblyVersion(\"1.0.0.*\")]\n\n## What about bundled scripts and stylesheets in ASP.NET? ##\n\nWith [Azure App Service Web Apps](http://go.microsoft.com/fwlink/?LinkId=529714) and [Azure Cloud Services](/services/cloud-services/), you get the best Azure CDN integration with [ASP.NET bundling and minification](http://www.asp.net/mvc/tutorials/mvc-4/bundling-and-minification). \n\nIntegrating Azure App Service or Azure Cloud Services with Azure CDN gives you the following advantages:\n\n- Integrate content deployment (images, scripts, and stylesheets) as part of your Azure web app's [continuous deployment](../web-sites-publish-source-control.md) process\n- Easily upgrade your CDN-served NuGet packages, such as jQuery or Bootstrap versions \n- Manage your Web application and your CDN-served content from the same Visual Studio interface\n\nFor related tutorials, see:\n- [Use Azure CDN in Azure App Service](../cdn-websites-with-cdn.md)\n- [Integrate a cloud service with Azure CDN](cdn-cloud-service-with-cdn.md)\n\nWithout integration with Azure App Service Web Apps or Azure Cloud Services, it is possible to use Azure CDN for your script bundles, with the following caveats:\n\n- You must manually upload the bundled scripts to blob storage. A programmatic solution is proposed at [stackoverflow](http://stackoverflow.com/a/13736433).\n- In your .cshtml files, transform the rendered script/CSS tags to use the Azure CDN. For example:\n\n        @Html.Raw(Styles.Render(\"~/Content/css\").ToString().Insert(0, \"http://<yourCDNName>.vo.msecnd.net\"))\n\n## More Information ##\n- [Overview of the Azure Content Delivery Network (CDN)](cdn-overview.md)\n- [Use Azure CDN in Azure App Service](../cdn-websites-with-cdn.md)\n- [Integrate a cloud service with Azure CDN](cdn-cloud-service-with-cdn.md)\n- [How to Map Content Delivery Network (CDN) Content to a Custom Domain](http://msdn.microsoft.com/library/azure/gg680307.aspx)\n- [Using CDN for Azure](cdn-how-to-use-cdn.md)\n \n\ntest\n"
}