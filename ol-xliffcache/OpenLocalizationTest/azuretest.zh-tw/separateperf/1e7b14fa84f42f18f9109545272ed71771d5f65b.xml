{
  "nodes": [
    {
      "content": "Integrate a cloud service with Azure CDN",
      "pos": [
        28,
        68
      ]
    },
    {
      "content": "A tutorial that teaches you how to deploy a cloud service that serves content from an integrated Azure CDN endpoint",
      "pos": [
        88,
        203
      ]
    },
    {
      "pos": [
        527,
        588
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"intro\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph> Integrate a cloud service with Azure CDN"
    },
    {
      "content": "A cloud service can be integrated with Azure CDN, serving any content from the cloud service's <ph id=\"ph1\">`~/CDN`</ph> path.",
      "pos": [
        591,
        699
      ]
    },
    {
      "content": "This approach gives you the following advantages:",
      "pos": [
        700,
        749
      ]
    },
    {
      "content": "Easily deploy and update images, scripts, and stylesheets in your cloud service's project directories",
      "pos": [
        753,
        854
      ]
    },
    {
      "content": "Easily upgrade the NuGet packages in your cloud service, such as jQuery or Bootstrap versions",
      "pos": [
        857,
        950
      ]
    },
    {
      "content": "Manage your Web application and your CDN-served content all from the same Visual Studio interface",
      "pos": [
        954,
        1051
      ]
    },
    {
      "content": "Unified deployment workflow for your Web application and your CDN-served content",
      "pos": [
        1054,
        1134
      ]
    },
    {
      "content": "Integrate ASP.NET bundling and minification with Azure CDN",
      "pos": [
        1137,
        1195
      ]
    },
    {
      "content": "What you will learn",
      "pos": [
        1200,
        1219
      ]
    },
    {
      "content": "In this tutorial, you will learn how to:",
      "pos": [
        1224,
        1264
      ]
    },
    {
      "content": "Integrate an Azure CDN endpoint with your cloud service and serve static content in your Web pages from Azure CDN",
      "pos": [
        1271,
        1384
      ]
    },
    {
      "content": "Configure cache settings for static content in your cloud service",
      "pos": [
        1400,
        1465
      ]
    },
    {
      "content": "Serve content from controller actions through Azure CDN",
      "pos": [
        1482,
        1537
      ]
    },
    {
      "content": "Serve bundled and minified content through Azure CDN while preserving the script debugging experience in Visual Studio",
      "pos": [
        1557,
        1675
      ]
    },
    {
      "content": "Configure fallback your scripts and CSS when your Azure CDN is offline",
      "pos": [
        1693,
        1763
      ]
    },
    {
      "content": "What you will build",
      "pos": [
        1781,
        1800
      ]
    },
    {
      "content": "You will deploy a cloud service Web role using the default ASP.NET MVC template, add code to serve content from an integrated Azure CDN, such as an image, controller action results, and the default JavaScript and CSS files, and also write code to configure the fallback mechanism for bundles served in the event that the CDN is offline.",
      "pos": [
        1805,
        2141
      ]
    },
    {
      "content": "What you will need",
      "pos": [
        2146,
        2164
      ]
    },
    {
      "content": "This tutorial has the following prerequisites:",
      "pos": [
        2169,
        2215
      ]
    },
    {
      "pos": [
        2221,
        2267
      ],
      "content": "An active <bpt id=\"p1\">[</bpt>Microsoft Azure account<ept id=\"p1\">](/account/)</ept>"
    },
    {
      "pos": [
        2272,
        2368
      ],
      "content": "Visual Studio 2013 with <bpt id=\"p1\">[</bpt>Azure SDK<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=323510&amp;clcid=0x409)</ept>"
    },
    {
      "pos": [
        2372,
        2437
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> You need an Azure account to complete this tutorial:"
    },
    {
      "pos": [
        2442,
        2669
      ],
      "content": "You can <bpt id=\"p1\">[</bpt>open an Azure account for free<ept id=\"p1\">](/pricing/free-trial/)</ept> - You get credits you can use to try out paid Azure services, and even after they're used up you can keep the account and use free Azure services, such as Websites."
    },
    {
      "pos": [
        2674,
        2861
      ],
      "content": "You can <bpt id=\"p1\">[</bpt>activate MSDN subscriber benefits<ept id=\"p1\">](/pricing/member-offers/msdn-benefits-details/)</ept> - Your MSDN subscription gives you credits every month that you can use for paid Azure services."
    },
    {
      "content": "Deploy a cloud service with an integrated CDN endpoint",
      "pos": [
        2888,
        2942
      ]
    },
    {
      "content": "In this section, you will deploy the default ASP.NET MVC application template in Visual Studio 2013 to a cloud service Web role, and then integrate it with a new CDN endpoint.",
      "pos": [
        2947,
        3122
      ]
    },
    {
      "content": "Follow the instructions below:",
      "pos": [
        3123,
        3153
      ]
    },
    {
      "content": "In Visual Studio 2013, create a new Azure cloud service from the menu bar by going to <bpt id=\"p1\">**</bpt>File &gt; New &gt; Project &gt; Cloud &gt; Azure Cloud Service<ept id=\"p1\">**</ept>.",
      "pos": [
        3158,
        3299
      ]
    },
    {
      "content": "Give it a name and click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.",
      "pos": [
        3300,
        3332
      ]
    },
    {
      "content": "Select <bpt id=\"p1\">**</bpt>ASP.NET Web Role<ept id=\"p1\">**</ept> and click the <bpt id=\"p2\">**</bpt>&gt;<ept id=\"p2\">**</ept> button.",
      "pos": [
        3405,
        3460
      ]
    },
    {
      "content": "Click OK.",
      "pos": [
        3461,
        3470
      ]
    },
    {
      "pos": [
        3543,
        3575
      ],
      "content": "Select <bpt id=\"p1\">**</bpt>MVC<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Now, publish this Web role to an Azure cloud service.",
      "pos": [
        3649,
        3702
      ]
    },
    {
      "content": "Right-click the cloud service project and select <bpt id=\"p1\">**</bpt>Publish<ept id=\"p1\">**</ept>.",
      "pos": [
        3703,
        3764
      ]
    },
    {
      "pos": [
        3835,
        3913
      ],
      "content": "If you have not yet signed into Microsoft Azure, click the <bpt id=\"p1\">**</bpt>Sign In<ept id=\"p1\">**</ept> button."
    },
    {
      "content": "In the sign-in page, sign in with the Microsoft account you used to activate your Azure account.",
      "pos": [
        3989,
        4085
      ]
    },
    {
      "pos": [
        4089,
        4127
      ],
      "content": "Once you're signed in, click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Assuming that you haven't created a cloud service or storage account, Visual Studio will help you create both.",
      "pos": [
        4205,
        4315
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Create Cloud Service and Account<ept id=\"p1\">**</ept> dialog, type the desired service name.",
      "pos": [
        4316,
        4398
      ]
    },
    {
      "content": "Then, click <bpt id=\"p1\">**</bpt>Create<ept id=\"p1\">**</ept>.",
      "pos": [
        4399,
        4422
      ]
    },
    {
      "pos": [
        4515,
        4592
      ],
      "content": "In the publish settings page, verify the configuration and click <bpt id=\"p1\">**</bpt>Publish<ept id=\"p1\">**</ept>."
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> The publishing process for cloud services takes a long time.",
      "pos": [
        4672,
        4745
      ]
    },
    {
      "content": "The Enable Web Deploy for all roles option can make debugging your cloud service much quicker by providing fast (but temporary) updates to your Web roles.",
      "pos": [
        4746,
        4900
      ]
    },
    {
      "content": "For more information on this option, see <bpt id=\"p1\">[</bpt>Publishing a Cloud Service using the Azure Tools<ept id=\"p1\">](http://msdn.microsoft.com/library/ff683672.aspx)</ept>.",
      "pos": [
        4901,
        5042
      ]
    },
    {
      "pos": [
        5048,
        5210
      ],
      "content": "When the <bpt id=\"p1\">**</bpt>Microsoft Azure Activity Log<ept id=\"p1\">**</ept> shows that publishing status is <bpt id=\"p2\">**</bpt>Completed<ept id=\"p2\">**</ept>, you will create a CDN endpoint that's integrated with this cloud service."
    },
    {
      "pos": [
        5216,
        5315
      ],
      "content": "To create a CDN endpoint, log into your <bpt id=\"p1\">[</bpt>Azure management portal<ept id=\"p1\">](http://manage.windowsazure.com/)</ept>."
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>New<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>App Services<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">**</bpt>CDN<ept id=\"p3\">**</ept> &gt; <bpt id=\"p4\">**</bpt>Quick Create<ept id=\"p4\">**</ept>.",
      "pos": [
        5320,
        5382
      ]
    },
    {
      "content": "Select <bpt id=\"p1\">*</bpt><bpt id=\"p2\">*</bpt>http://<ept id=\"p2\">*</ept>&amp;lt;servicename&gt;<ept id=\"p1\">*</ept>.cloudapp.net/cdn/** and click <bpt id=\"p3\">**</bpt>Create<ept id=\"p3\">**</ept>.",
      "pos": [
        5383,
        5459
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> Once your CDN endpoint is created, the Azure portal will show you its URL and the origin domain that it's integrated with.",
      "pos": [
        5533,
        5668
      ]
    },
    {
      "content": "However, it can take awhile for the new CDN endpoint's configuration to be fully propagated to all the CDN node locations.",
      "pos": [
        5669,
        5791
      ]
    },
    {
      "content": "Note that the CDN endpoint is tied to the path <bpt id=\"p1\">**</bpt>cdn/<ept id=\"p1\">**</ept> of your cloud service.",
      "pos": [
        5798,
        5876
      ]
    },
    {
      "content": "You can either create a <bpt id=\"p1\">**</bpt>cdn<ept id=\"p1\">**</ept> folder in your <bpt id=\"p2\">**</bpt>WebRole1<ept id=\"p2\">**</ept> project, or you can use URL rewrite to strip all incoming links of this path.",
      "pos": [
        5877,
        6014
      ]
    },
    {
      "content": "In this tutorial, you will take the latter route.",
      "pos": [
        6015,
        6064
      ]
    },
    {
      "pos": [
        6069,
        6167
      ],
      "content": "Back in the Azure portal, in the <bpt id=\"p1\">**</bpt>CDN<ept id=\"p1\">**</ept> tab, click the name of the CDN endpoint you just created."
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Enable Query String<ept id=\"p1\">**</ept> to enable query strings in the CDN cache.",
      "pos": [
        6243,
        6314
      ]
    },
    {
      "content": "Once you enable this, the same link accessed with different query strings will be cached as separate entries.",
      "pos": [
        6315,
        6424
      ]
    },
    {
      "pos": [
        6502,
        6855
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> While enabling the query string is not necessary for this tutorial section, you want to do this as early as possible for convenience since any change here is going to take time to propagate to all the CDN nodes, and you don't want any non-query-string-enabled content to clog up the CDN cache (updating CDN content will be discussed later)."
    },
    {
      "content": "Ping your CDN endpoint to make sure that it's propagated to the CDN nodes.",
      "pos": [
        6860,
        6934
      ]
    },
    {
      "content": "You may need to wait up to an hour before it will respond to pings.",
      "pos": [
        6935,
        7002
      ]
    },
    {
      "pos": [
        7072,
        7210
      ],
      "content": "Back in Visual Studio 2013, open <bpt id=\"p1\">**</bpt>Web.config<ept id=\"p1\">**</ept> in your <bpt id=\"p2\">**</bpt>WebRole1<ept id=\"p2\">**</ept> project and add the following code into the <ph id=\"ph1\">`&lt;system.webServer&gt;`</ph> tag:"
    },
    {
      "content": "Publish the cloud service again.",
      "pos": [
        7562,
        7594
      ]
    },
    {
      "content": "Right-click the cloud service project and select <bpt id=\"p1\">**</bpt>Publish<ept id=\"p1\">**</ept>.",
      "pos": [
        7595,
        7656
      ]
    },
    {
      "content": "When the publishing status is <bpt id=\"p1\">**</bpt>Completed<ept id=\"p1\">**</ept>, open a browser window and navigate to <bpt id=\"p2\">*</bpt><bpt id=\"p3\">*</bpt>http://<ept id=\"p3\">*</ept>&amp;lt;cdnName&gt;<ept id=\"p2\">*</ept>.vo.msecnd.net/Content/bootstrap.css**.",
      "pos": [
        7727,
        7872
      ]
    },
    {
      "content": "In my setup, this URL is:",
      "pos": [
        7873,
        7898
      ]
    },
    {
      "content": "Which corresponds to the following origin URL at the CDN endpoint:",
      "pos": [
        7965,
        8031
      ]
    },
    {
      "content": "After URL rewrite in my Web app, the actual file that gets cached to my CDN cache is:",
      "pos": [
        8108,
        8193
      ]
    },
    {
      "pos": [
        8266,
        8439
      ],
      "content": "When you navigate to <bpt id=\"p1\">*</bpt><bpt id=\"p2\">*</bpt>http://<ept id=\"p2\">*</ept>&amp;lt;cdnName&gt;<ept id=\"p1\">*</ept>.vo.msecnd.net/Content/bootstrap.css**, you will be prompted to download the bootstrap.css that came from your published Web app."
    },
    {
      "content": "You can similarly access any publicly accessible URL at <bpt id=\"p1\">*</bpt><bpt id=\"p2\">*</bpt>http://<ept id=\"p2\">*</ept>&amp;lt;serviceName&gt;<ept id=\"p1\">*</ept>.cloudapp.net/**, straight from your CDN endpoint.",
      "pos": [
        8510,
        8643
      ]
    },
    {
      "content": "For example:",
      "pos": [
        8644,
        8656
      ]
    },
    {
      "content": "A .js file from the /Script path",
      "pos": [
        8662,
        8694
      ]
    },
    {
      "content": "Any content file from the /Content path",
      "pos": [
        8699,
        8738
      ]
    },
    {
      "content": "Any controller/action",
      "pos": [
        8743,
        8764
      ]
    },
    {
      "content": "If the query string is enabled at your CDN endpoint, any URL with query strings",
      "pos": [
        8770,
        8849
      ]
    },
    {
      "content": "In fact, with the above configuration, you can host the entire cloud service from <bpt id=\"p1\">*</bpt><bpt id=\"p2\">*</bpt>http://<ept id=\"p2\">*</ept>&amp;lt;cdnName&gt;<ept id=\"p1\">*</ept>.vo.msecnd.net/**.",
      "pos": [
        8851,
        8974
      ]
    },
    {
      "content": "If I navigate to <bpt id=\"p1\">**</bpt>http://az632148.vo.msecnd.net/<ept id=\"p1\">**</ept>, I get the action result from Home/Index.",
      "pos": [
        8975,
        9068
      ]
    },
    {
      "content": "This does not mean, however, that it's always a good idea (or generally a good idea) to serve an entire cloud service through Azure CDN.",
      "pos": [
        9129,
        9265
      ]
    },
    {
      "content": "Some of the caveats are:",
      "pos": [
        9266,
        9290
      ]
    },
    {
      "content": "This approach requires your entire site to be public, because Azure CDN cannot serve any private content.",
      "pos": [
        9296,
        9401
      ]
    },
    {
      "pos": [
        9406,
        9640
      ],
      "content": "If the CDN endpoint goes offline for any reason, whether scheduled maintenance or user error, your entire cloud service goes offline unless the customers can be redirected to the origin URL <bpt id=\"p1\">*</bpt><bpt id=\"p2\">*</bpt>http://<ept id=\"p2\">*</ept>&amp;lt;serviceName&gt;<ept id=\"p1\">*</ept>.cloudapp.net/**."
    },
    {
      "content": "Even with the custom Cache-Control settings (see <bpt id=\"p1\">[</bpt>Configure caching options for static files in your cloud service<ept id=\"p1\">](#caching)</ept>), a CDN endpoint does not improve the performance of highly-dynamic content.",
      "pos": [
        9646,
        9848
      ]
    },
    {
      "content": "If you tried to load the home page from your CDN endpoint as shown above, notice that it took at least 5 seconds to load the default home page the first time, which is a fairly simple page.",
      "pos": [
        9849,
        10038
      ]
    },
    {
      "content": "Imagine what would happen to the client experience if this page contains dynamic content that must update every minute.",
      "pos": [
        10039,
        10158
      ]
    },
    {
      "content": "Serving dynamic content from a CDN endpoint requires short cache expiration, which translates to frequent cache misses at the CDN endpoint.",
      "pos": [
        10159,
        10298
      ]
    },
    {
      "content": "This hurts the performance of your cloud service and defeats the purpose of a CDN.",
      "pos": [
        10299,
        10381
      ]
    },
    {
      "content": "The alternative is to determine which content to serve from Azure CDN on a case-by-case basis in your cloud service.",
      "pos": [
        10383,
        10499
      ]
    },
    {
      "content": "To that end, you have already seen how to access individual content files from the CDN endpoint.",
      "pos": [
        10500,
        10596
      ]
    },
    {
      "content": "I will show you how to serve a specific controller action through the CDN endpoint in <bpt id=\"p1\">[</bpt>Serve content from controller actions through Azure CDN<ept id=\"p1\">](#controller)</ept>.",
      "pos": [
        10597,
        10754
      ]
    },
    {
      "content": "You can specify a more restrictive URL rewrite rule to limit the content accessible through your CDN endpoint.",
      "pos": [
        10756,
        10866
      ]
    },
    {
      "content": "For example, to limit URL rewrite to the <bpt id=\"p1\">*</bpt>\\Scripts<ept id=\"p1\">*</ept> folder, change the above rewrite rule as follows:",
      "pos": [
        10867,
        10968
      ]
    },
    {
      "content": "Configure caching options for static files in your cloud service",
      "pos": [
        11169,
        11233
      ]
    },
    {
      "content": "With Azure CDN integration in your cloud service, you can specify how you want static content to be cached in the CDN endpoint.",
      "pos": [
        11238,
        11365
      ]
    },
    {
      "content": "To do this, open <bpt id=\"p1\">*</bpt>Web.config<ept id=\"p1\">*</ept> from your Web role project (e.g. WebRole1) and add a <ph id=\"ph1\">`&lt;staticContent&gt;`</ph> element to <ph id=\"ph2\">`&lt;system.webServer&gt;`</ph>.",
      "pos": [
        11366,
        11499
      ]
    },
    {
      "content": "The XML below configures the cache to expire in 3 days.",
      "pos": [
        11500,
        11555
      ]
    },
    {
      "content": "Once you do this, all static files in your cloud service will observe the same rule in your CDN cache.",
      "pos": [
        11746,
        11848
      ]
    },
    {
      "content": "For more granular control of cache settings, add a <bpt id=\"p1\">*</bpt>Web.config<ept id=\"p1\">*</ept> file into a folder and add your settings there.",
      "pos": [
        11849,
        11960
      ]
    },
    {
      "content": "For example, add a <bpt id=\"p1\">*</bpt>Web.config<ept id=\"p1\">*</ept> file to the <bpt id=\"p2\">*</bpt>\\Content<ept id=\"p2\">*</ept> folder and replace the content with the following XML:",
      "pos": [
        11961,
        12070
      ]
    },
    {
      "pos": [
        12327,
        12416
      ],
      "content": "This setting causes all static files from the <bpt id=\"p1\">*</bpt>\\Content<ept id=\"p1\">*</ept> folder to be cached for 15 days."
    },
    {
      "pos": [
        12418,
        12603
      ],
      "content": "For more information on how to configure the <ph id=\"ph1\">`&lt;clientCache&gt;`</ph> element, see <bpt id=\"p1\">[</bpt>Client Cache &amp;lt;clientCache&gt;<ept id=\"p1\">](http://www.iis.net/configreference/system.webserver/staticcontent/clientcache)</ept>."
    },
    {
      "pos": [
        12605,
        12785
      ],
      "content": "In <bpt id=\"p1\">[</bpt>Serve content from controller actions through Azure CDN<ept id=\"p1\">](#controller)</ept>, I will also show you how you can configure cache settings for controller action results in the CDN cache."
    },
    {
      "content": "Serve content from controller actions through Azure CDN",
      "pos": [
        12816,
        12871
      ]
    },
    {
      "content": "When you integrate a cloud service Web role with Azure CDN, it is relatively easy to serve content from controller actions through the Azure CDN.",
      "pos": [
        12876,
        13021
      ]
    },
    {
      "content": "Other than serving your cloud service directly through Azure CDN (demonstrated above), <bpt id=\"p1\">[</bpt>Maarten Balliauw<ept id=\"p1\">](https://twitter.com/maartenballiauw)</ept> shows you how to do it with a fun MemeGenerator controller in <bpt id=\"p2\">[</bpt>Reducing latency on the web with the Azure CDN<ept id=\"p2\">](http://channel9.msdn.com/events/TechDays/Techdays-2014-the-Netherlands/Reducing-latency-on-the-web-with-the-Windows-Azure-CDN)</ept>.",
      "pos": [
        13022,
        13403
      ]
    },
    {
      "content": "I will simply reproduce it here.",
      "pos": [
        13404,
        13436
      ]
    },
    {
      "pos": [
        13438,
        13617
      ],
      "content": "Suppose in your cloud service you want to generate memes based on a young Chuck Norris image (photo by <bpt id=\"p1\">[</bpt>Alan Light<ept id=\"p1\">](http://www.flickr.com/photos/alan-light/218493788/)</ept>) like this:"
    },
    {
      "content": "You have a simple <ph id=\"ph1\">`Index`</ph> action that allows the customers to specify the superlatives in the image, then generates the meme once they post to the action.",
      "pos": [
        13682,
        13836
      ]
    },
    {
      "content": "Since it's Chuck Norris, you would expect this page to become wildly popular globally.",
      "pos": [
        13837,
        13923
      ]
    },
    {
      "content": "This is a good example of serving semi-dynamic content with Azure CDN.",
      "pos": [
        13924,
        13994
      ]
    },
    {
      "content": "Follow the steps above to setup this controller action:",
      "pos": [
        13997,
        14052
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">*</bpt>\\Controllers<ept id=\"p1\">*</ept> folder, create a new .cs file called <bpt id=\"p2\">*</bpt>MemeGeneratorController.cs<ept id=\"p2\">*</ept> and replace the content with the following code.",
      "pos": [
        14057,
        14193
      ]
    },
    {
      "content": "Be sure to replace the highlighted portion with your CDN name.",
      "pos": [
        14194,
        14256
      ]
    },
    {
      "pos": [
        18751,
        18819
      ],
      "content": "Right-click in the default <ph id=\"ph1\">`Index()`</ph> action and select <bpt id=\"p1\">**</bpt>Add View<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        18886,
        18930
      ],
      "content": "Accept the settings below and click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        19002,
        19137
      ],
      "content": "Open the new <bpt id=\"p1\">*</bpt>Views\\MemeGenerator\\Index.cshtml<ept id=\"p1\">*</ept> and replace the content with the following simple HTML for submitting the superlatives:"
    },
    {
      "pos": [
        19511,
        19638
      ],
      "content": "Publish the cloud service again and navigate to <bpt id=\"p1\">*</bpt><bpt id=\"p2\">*</bpt>http://<ept id=\"p2\">*</ept>&amp;lt;serviceName&gt;<ept id=\"p1\">*</ept>.cloudapp.net/MemeGenerator/Index** in your browser."
    },
    {
      "content": "When you submit the form values to <ph id=\"ph1\">`/MemeGenerator/Index`</ph>, the <ph id=\"ph2\">`Index_Post`</ph> action method returns a link to the <ph id=\"ph3\">`Show`</ph> action method with the respective input identifier.",
      "pos": [
        19641,
        19811
      ]
    },
    {
      "content": "When you click the link, you reach the following code:",
      "pos": [
        19812,
        19866
      ]
    },
    {
      "content": "If your local debugger is attached, then you will get the regular debug experience with a local redirect.",
      "pos": [
        20671,
        20776
      ]
    },
    {
      "content": "If it's running in the cloud service, then it will redirect to:",
      "pos": [
        20777,
        20840
      ]
    },
    {
      "content": "Which corresponds to the following origin URL at your CDN endpoint:",
      "pos": [
        20940,
        21007
      ]
    },
    {
      "content": "After URL rewrite rule previously applied, the actual file that gets cached to your CDN endpoint is:",
      "pos": [
        21118,
        21218
      ]
    },
    {
      "content": "You can then use the <ph id=\"ph1\">`OutputCacheAttribute`</ph> attribute on the <ph id=\"ph2\">`Generate`</ph> method to specify how the action result should be cached, which Azure CDN will honor.",
      "pos": [
        21325,
        21482
      ]
    },
    {
      "content": "The code below specify a cache expiration of 1 hour (3,600 seconds).",
      "pos": [
        21483,
        21551
      ]
    },
    {
      "content": "Likewise, you can serve up content from any controller action in your cloud service through your Azure CDN, with the desired caching option.",
      "pos": [
        21651,
        21791
      ]
    },
    {
      "content": "In the next section, I will show you how to serve the bundled and minified scripts and CSS through Azure CDN.",
      "pos": [
        21793,
        21902
      ]
    },
    {
      "content": "Integrate ASP.NET bundling and minification with Azure CDN",
      "pos": [
        21932,
        21990
      ]
    },
    {
      "content": "Scripts and CSS stylesheets change infrequently and are prime candidates for the Azure CDN cache.",
      "pos": [
        21995,
        22092
      ]
    },
    {
      "content": "Serving the entire Web role through your Azure CDN is the easiest way to integrate bundling and minification with Azure CDN.",
      "pos": [
        22093,
        22217
      ]
    },
    {
      "content": "However, as you may not want to do this, I will show you how to do it while preserving the desired develper experience of ASP.NET bundling and minification, such as:",
      "pos": [
        22218,
        22383
      ]
    },
    {
      "content": "Great debug mode experience",
      "pos": [
        22389,
        22416
      ]
    },
    {
      "content": "Streamlined deployment",
      "pos": [
        22421,
        22443
      ]
    },
    {
      "content": "Immediate updates to clients for script/CSS version upgrades",
      "pos": [
        22448,
        22508
      ]
    },
    {
      "content": "Fallback mechanism when your CDN endpoint fails",
      "pos": [
        22513,
        22560
      ]
    },
    {
      "content": "Minimize code modification",
      "pos": [
        22565,
        22591
      ]
    },
    {
      "pos": [
        22593,
        22852
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>WebRole1<ept id=\"p1\">**</ept> project that you created in <bpt id=\"p2\">[</bpt>Integrate an Azure CDN endpoint with your Azure website and serve static content in your Web pages from Azure CDN<ept id=\"p2\">](#deploy)</ept>, open <bpt id=\"p3\">*</bpt>App_Start\\BundleConfig.cs<ept id=\"p3\">*</ept> and take a look at the <ph id=\"ph1\">`bundles.Add()`</ph> method calls."
    },
    {
      "content": "The first <ph id=\"ph1\">`bundles.Add()`</ph> statement adds a script bundle at the virtual directory <ph id=\"ph2\">`~/bundles/jquery`</ph>.",
      "pos": [
        23065,
        23166
      ]
    },
    {
      "content": "Then, open <bpt id=\"p1\">*</bpt>Views\\Shared\\_Layout.cshtml<ept id=\"p1\">*</ept> to see how the script bundle tag is rendered.",
      "pos": [
        23167,
        23253
      ]
    },
    {
      "content": "You should be able to find the following line of Razor code:",
      "pos": [
        23254,
        23314
      ]
    },
    {
      "pos": [
        23357,
        23487
      ],
      "content": "When this Razor code is run in the Azure Web role, it will render a <ph id=\"ph1\">`&lt;script&gt;`</ph> tag for the script bundle similar to the following:"
    },
    {
      "pos": [
        23582,
        23757
      ],
      "content": "However, when it is run in Visual Studio by typing <ph id=\"ph1\">`F5`</ph>, it will render each script file in the bundle individually (in the case above, only one script file is in the bundle):"
    },
    {
      "content": "This enables you to debug the JavaScript code in your development environment while reducing concurrent client connections (bundling) and improving file download performance (minification) in production.",
      "pos": [
        23814,
        24017
      ]
    },
    {
      "content": "It's a great feature to preserve with Azure CDN integration.",
      "pos": [
        24018,
        24078
      ]
    },
    {
      "content": "Furthermore, since the rendered bundle already contains an automatically generated version string, you want to replicate that functionality so the whenever you update your jQuery version through NuGet, it can be updated at the client side as soon as possible.",
      "pos": [
        24079,
        24338
      ]
    },
    {
      "content": "Follow the steps below to integration ASP.NET bundling and minification with your CDN endpoint.",
      "pos": [
        24340,
        24435
      ]
    },
    {
      "content": "Back in <bpt id=\"p1\">*</bpt>App_Start\\BundleConfig.cs<ept id=\"p1\">*</ept>, modify the <ph id=\"ph1\">`bundles.Add()`</ph> methods to use a different <bpt id=\"p2\">[</bpt>Bundle constructor<ept id=\"p2\">](http://msdn.microsoft.com/library/jj646464.aspx)</ept>, one that specifies a CDN address.",
      "pos": [
        24440,
        24635
      ]
    },
    {
      "content": "To do this, replace the <ph id=\"ph1\">`RegisterBundles`</ph> method definition with the following code:",
      "pos": [
        24636,
        24720
      ]
    },
    {
      "pos": [
        26277,
        26344
      ],
      "content": "Be sure to replace <ph id=\"ph1\">`&lt;yourCDNName&gt;`</ph> with the name of your Azure CDN."
    },
    {
      "content": "In plain words, you are setting <ph id=\"ph1\">`bundles.UseCdn = true`</ph> and added a carefully crafted CDN URL to each bundle.",
      "pos": [
        26350,
        26459
      ]
    },
    {
      "content": "For example, the first constructor in the code:",
      "pos": [
        26460,
        26507
      ]
    },
    {
      "content": "is the same as:",
      "pos": [
        26600,
        26615
      ]
    },
    {
      "content": "This constructor tells ASP.NET bundling and minification to render individual script files when debugged locally, but use the specified CDN address to access the script in question.",
      "pos": [
        26756,
        26937
      ]
    },
    {
      "content": "However, note two important characteristics with this carefully crafted CDN URL:",
      "pos": [
        26938,
        27018
      ]
    },
    {
      "pos": [
        27032,
        27215
      ],
      "content": "The origin for this CDN URL is <ph id=\"ph1\">`http://&lt;yourCloudService&gt;.cloudapp.net/bundles/jquery?v=&lt;W.X.Y.Z&gt;`</ph>, which is actually the virtual directory of the script bundle in your cloud service."
    },
    {
      "content": "Since you are using CDN constructor, the CDN script tag for the bundle no longer contains the automatically generated version string in the rendered URL.",
      "pos": [
        27224,
        27377
      ]
    },
    {
      "content": "You must manually generate a unique version string every time the script bundle is modified to force a cache miss at your Azure CDN.",
      "pos": [
        27378,
        27510
      ]
    },
    {
      "content": "At the same time, this unique version string must remain constant through the life of the deployment to maximize cache hits at your Azure CDN after the bundle is deployed.",
      "pos": [
        27511,
        27682
      ]
    },
    {
      "content": "The query string v=&lt;W.X.Y.Z&gt; pulls from <bpt id=\"p1\">*</bpt>Properties\\AssemblyInfo.cs<ept id=\"p1\">*</ept> in your Web role project.",
      "pos": [
        27691,
        27785
      ]
    },
    {
      "content": "You can have a deployment workflow that includes incrementing the assembly version every time you publish to Azure.",
      "pos": [
        27786,
        27901
      ]
    },
    {
      "content": "Or, you can just modify <bpt id=\"p1\">*</bpt>Properties\\AssemblyInfo.cs<ept id=\"p1\">*</ept> in your project to automatically increment the version string every time you build, using the wildcard character '*'.",
      "pos": [
        27902,
        28072
      ]
    },
    {
      "content": "For example:",
      "pos": [
        28073,
        28085
      ]
    },
    {
      "content": "Any other strategy to streamline generating a unique string for the life of a deployment will work here.",
      "pos": [
        28155,
        28259
      ]
    },
    {
      "content": "Republish the cloud service and access the home page.",
      "pos": [
        28264,
        28317
      ]
    },
    {
      "content": "View the HTML code for the page.",
      "pos": [
        28323,
        28355
      ]
    },
    {
      "content": "You should be able to see the CDN URL rendered, with a unique version string every time you republish changes to your cloud service.",
      "pos": [
        28356,
        28488
      ]
    },
    {
      "content": "For example:",
      "pos": [
        28489,
        28501
      ]
    },
    {
      "pos": [
        28975,
        29050
      ],
      "content": "In Visual Studio, debug the cloud service in Visual Studio by typing <ph id=\"ph1\">`F5`</ph>.,"
    },
    {
      "content": "View the HTML code for the page.",
      "pos": [
        29056,
        29088
      ]
    },
    {
      "content": "You will still see each script file individually rendered so that you can have a consistent debug experience in Visual Studio.",
      "pos": [
        29089,
        29215
      ]
    },
    {
      "content": "Fallback mechanism for CDN URLs",
      "pos": [
        29701,
        29732
      ]
    },
    {
      "content": "When your Azure CDN endpoint fails for any reason, you want your Web page to be smart enough to access your origin Web server as the fallback option for loading JavaScript or Bootstrap.",
      "pos": [
        29737,
        29922
      ]
    },
    {
      "content": "It's serious enough to lose images on your website due to CDN unavailability, but much more severe to lose crucial page functionality provided by your scripts and stylesheets.",
      "pos": [
        29923,
        30098
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>Bundle<ept id=\"p1\">](http://msdn.microsoft.com/library/system.web.optimization.bundle.aspx)</ept> class contains a property called <bpt id=\"p2\">[</bpt>CdnFallbackExpression<ept id=\"p2\">](http://msdn.microsoft.com/library/system.web.optimization.bundle.cdnfallbackexpression.aspx)</ept> that enables you to configure the fallback mechanism for CDN failure.",
      "pos": [
        30100,
        30403
      ]
    },
    {
      "content": "To use this property, follow the steps below:",
      "pos": [
        30404,
        30449
      ]
    },
    {
      "pos": [
        30454,
        30711
      ],
      "content": "In your Web role project, open <bpt id=\"p1\">*</bpt>App_Start\\BundleConfig.cs<ept id=\"p1\">*</ept>, where you added a CDN URL in each <bpt id=\"p2\">[</bpt>Bundle constructor<ept id=\"p2\">](http://msdn.microsoft.com/library/jj646464.aspx)</ept>, and make the following highlighted changes to add fallback mechanism to the default bundles:"
    },
    {
      "content": "When <ph id=\"ph1\">`CdnFallbackExpression`</ph> is not null, script is injected into the HTML to test whether the bundle is loaded successfully and, if not, access the bundle directly from the origin Web server.",
      "pos": [
        32844,
        33036
      ]
    },
    {
      "content": "This property needs to be set to a JavaScript expression that tests whether the respective CDN bundle is loaded properly.",
      "pos": [
        33037,
        33158
      ]
    },
    {
      "content": "The expression needed to test each bundle differs according to the content.",
      "pos": [
        33159,
        33234
      ]
    },
    {
      "content": "For the default bundles above:",
      "pos": [
        33235,
        33265
      ]
    },
    {
      "pos": [
        33279,
        33328
      ],
      "content": "<ph id=\"ph1\">`window.jquery`</ph> is defined in jquery-{version}.js"
    },
    {
      "pos": [
        33337,
        33383
      ],
      "content": "<ph id=\"ph1\">`$.validator`</ph> is defined in jquery.validate.js"
    },
    {
      "pos": [
        33392,
        33448
      ],
      "content": "<ph id=\"ph1\">`window.Modernizr`</ph> is defined in modernizer-{version}.js"
    },
    {
      "pos": [
        33457,
        33496
      ],
      "content": "<ph id=\"ph1\">`$.fn.modal`</ph> is defined in bootstrap.js"
    },
    {
      "content": "You might have noticed that I did not set CdnFallbackExpression for the <ph id=\"ph1\">`~/Cointent/css`</ph> bundle.",
      "pos": [
        33506,
        33602
      ]
    },
    {
      "content": "This is because currently there is a <bpt id=\"p1\">[</bpt>bug in System.Web.Optimization<ept id=\"p1\">](https://aspnetoptimization.codeplex.com/workitem/104)</ept> that injects a <ph id=\"ph1\">`&lt;script&gt;`</ph> tag for the fallback CSS instead of the expected <ph id=\"ph2\">`&lt;link&gt;`</ph> tag.",
      "pos": [
        33603,
        33815
      ]
    },
    {
      "pos": [
        33825,
        34013
      ],
      "content": "There is, however, a good <bpt id=\"p1\">[</bpt>Style Bundle Fallback<ept id=\"p1\">](https://github.com/EmberConsultingGroup/StyleBundleFallback)</ept> offered by <bpt id=\"p2\">[</bpt>Ember Consulting Group<ept id=\"p2\">](https://github.com/EmberConsultingGroup)</ept>."
    },
    {
      "pos": [
        34019,
        34321
      ],
      "content": "To use the workaround for CSS, create a new .cs file in your Web role project's <bpt id=\"p1\">*</bpt>App_Start<ept id=\"p1\">*</ept> folder called <bpt id=\"p2\">*</bpt>StyleBundleExtensions.cs<ept id=\"p2\">*</ept>, and replace its content with the <bpt id=\"p3\">[</bpt>code from GitHub<ept id=\"p3\">](https://github.com/EmberConsultingGroup/StyleBundleFallback/blob/master/Website/App_Start/StyleBundleExtensions.cs)</ept>."
    },
    {
      "pos": [
        34327,
        34433
      ],
      "content": "In <bpt id=\"p1\">*</bpt>App_Start\\StyleFundleExtensions.cs<ept id=\"p1\">*</ept>, rename the namespace to your Web role's name (e.g. <bpt id=\"p2\">**</bpt>WebRole1<ept id=\"p2\">**</ept>)."
    },
    {
      "pos": [
        34439,
        34558
      ],
      "content": "Go back to <ph id=\"ph1\">`App_Start\\BundleConfig.cs`</ph> and modify the last <ph id=\"ph2\">`bundles.Add`</ph> statement with the following highlighted code:"
    },
    {
      "content": "This new extension method uses the same idea to inject script in the HTML to check the DOM for the a matching class name, rule name, and rule value defined in the CSS bundle, and falls back to the origin Web server if it fails to find the match.",
      "pos": [
        34853,
        35098
      ]
    },
    {
      "content": "Publish the cloud service again and access the home page.",
      "pos": [
        35103,
        35160
      ]
    },
    {
      "content": "View the HTML code for the page.",
      "pos": [
        35166,
        35198
      ]
    },
    {
      "content": "You should find injected scripts similar to the following:",
      "pos": [
        35199,
        35257
      ]
    },
    {
      "pos": [
        37193,
        37326
      ],
      "content": "Note that injected script for the CSS bundle still contains the errant remnant from the <ph id=\"ph1\">`CdnFallbackExpression`</ph> property in the line:"
    },
    {
      "content": "But since the first part of the || expression will always return true (in the line directly above that), the document.write() function will never run.",
      "pos": [
        37413,
        37563
      ]
    },
    {
      "content": "More Information",
      "pos": [
        37568,
        37584
      ]
    },
    {
      "content": "Overview of the Azure Content Delivery Network (CDN)",
      "pos": [
        37591,
        37643
      ]
    },
    {
      "content": "Serve Content from Azure CDN in Your Web Application",
      "pos": [
        37703,
        37755
      ]
    },
    {
      "content": "Integrate an Azure Website with Azure CDN",
      "pos": [
        37815,
        37856
      ]
    },
    {
      "content": "ASP.NET Bundling and Minification",
      "pos": [
        37887,
        37920
      ]
    },
    {
      "content": "Using CDN for Azure",
      "pos": [
        37991,
        38010
      ]
    },
    {
      "content": "test",
      "pos": [
        38032,
        38036
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"Integrate a cloud service with Azure CDN\" \n    description=\"A tutorial that teaches you how to deploy a cloud service that serves content from an integrated Azure CDN endpoint\" \n    services=\"cdn, cloud-services\" \n    documentationCenter=\".net\" \n    authors=\"cephalin\" \n    manager=\"wpickett\" \n    editor=\"tysonn\"/>\n\n<tags \n    ms.service=\"cdn\" \n    ms.workload=\"tbd\" \n    ms.tgt_pltfrm=\"na\" \n    ms.devlang=\"dotnet\" \n    ms.topic=\"article\" \n    ms.date=\"09/01/2015\" \n    ms.author=\"cephalin\"/>\n\n\n# <a name=\"intro\"></a> Integrate a cloud service with Azure CDN \n\nA cloud service can be integrated with Azure CDN, serving any content from the cloud service's `~/CDN` path. This approach gives you the following advantages:\n\n- Easily deploy and update images, scripts, and stylesheets in your cloud service's project directories\n- Easily upgrade the NuGet packages in your cloud service, such as jQuery or Bootstrap versions \n- Manage your Web application and your CDN-served content all from the same Visual Studio interface\n- Unified deployment workflow for your Web application and your CDN-served content\n- Integrate ASP.NET bundling and minification with Azure CDN\n\n## What you will learn ##\n\nIn this tutorial, you will learn how to:\n\n-   [Integrate an Azure CDN endpoint with your cloud service and serve static content in your Web pages from Azure CDN](#deploy)\n-   [Configure cache settings for static content in your cloud service](#caching)\n-   [Serve content from controller actions through Azure CDN](#controller)\n-   [Serve bundled and minified content through Azure CDN while preserving the script debugging experience in Visual Studio](#bundling)\n-   [Configure fallback your scripts and CSS when your Azure CDN is offline](#fallback) \n\n## What you will build ##\n\nYou will deploy a cloud service Web role using the default ASP.NET MVC template, add code to serve content from an integrated Azure CDN, such as an image, controller action results, and the default JavaScript and CSS files, and also write code to configure the fallback mechanism for bundles served in the event that the CDN is offline.\n\n## What you will need ##\n\nThis tutorial has the following prerequisites:\n\n-   An active [Microsoft Azure account](/account/)\n-   Visual Studio 2013 with [Azure SDK](http://go.microsoft.com/fwlink/p/?linkid=323510&clcid=0x409)\n\n> [AZURE.NOTE] You need an Azure account to complete this tutorial:\n> + You can [open an Azure account for free](/pricing/free-trial/) - You get credits you can use to try out paid Azure services, and even after they're used up you can keep the account and use free Azure services, such as Websites.\n> + You can [activate MSDN subscriber benefits](/pricing/member-offers/msdn-benefits-details/) - Your MSDN subscription gives you credits every month that you can use for paid Azure services.\n\n<a name=\"deploy\"></a>\n## Deploy a cloud service with an integrated CDN endpoint ##\n\nIn this section, you will deploy the default ASP.NET MVC application template in Visual Studio 2013 to a cloud service Web role, and then integrate it with a new CDN endpoint. Follow the instructions below:\n\n1. In Visual Studio 2013, create a new Azure cloud service from the menu bar by going to **File > New > Project > Cloud > Azure Cloud Service**. Give it a name and click **OK**.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-cs-1-new-project.PNG)\n\n2. Select **ASP.NET Web Role** and click the **>** button. Click OK.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-cs-2-select-role.PNG)\n\n3. Select **MVC** and click **OK**.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-cs-3-mvc-template.PNG)\n\n4. Now, publish this Web role to an Azure cloud service. Right-click the cloud service project and select **Publish**.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-cs-4-publish-a.png)\n\n5. If you have not yet signed into Microsoft Azure, click the **Sign In** button.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-cs-5-publish-signin.png)\n\n6. In the sign-in page, sign in with the Microsoft account you used to activate your Azure account.\n7. Once you're signed in, click **Next**.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-cs-6-publish-signedin.png)\n\n8. Assuming that you haven't created a cloud service or storage account, Visual Studio will help you create both. In the **Create Cloud Service and Account** dialog, type the desired service name. Then, click **Create**.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-cs-7-publish-createserviceandstorage.png)\n\n9. In the publish settings page, verify the configuration and click **Publish**.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-cs-8-publish-finalize.png)\n\n    >[AZURE.NOTE] The publishing process for cloud services takes a long time. The Enable Web Deploy for all roles option can make debugging your cloud service much quicker by providing fast (but temporary) updates to your Web roles. For more information on this option, see [Publishing a Cloud Service using the Azure Tools](http://msdn.microsoft.com/library/ff683672.aspx).\n\n    When the **Microsoft Azure Activity Log** shows that publishing status is **Completed**, you will create a CDN endpoint that's integrated with this cloud service. \n\n1. To create a CDN endpoint, log into your [Azure management portal](http://manage.windowsazure.com/). \n2. Click **New** > **App Services** > **CDN** > **Quick Create**. Select **http://*&lt;servicename>*.cloudapp.net/cdn/** and click **Create**.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-cs-10-createcdn.png)\n\n    >[AZURE.NOTE] Once your CDN endpoint is created, the Azure portal will show you its URL and the origin domain that it's integrated with. However, it can take awhile for the new CDN endpoint's configuration to be fully propagated to all the CDN node locations. \n\n    Note that the CDN endpoint is tied to the path **cdn/** of your cloud service. You can either create a **cdn** folder in your **WebRole1** project, or you can use URL rewrite to strip all incoming links of this path. In this tutorial, you will take the latter route.\n\n3. Back in the Azure portal, in the **CDN** tab, click the name of the CDN endpoint you just created.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-cs-11-disablequerya.png)\n\n3. Click **Enable Query String** to enable query strings in the CDN cache. Once you enable this, the same link accessed with different query strings will be cached as separate entries.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-cs-12-disablequeryb.png)\n\n    >[AZURE.NOTE] While enabling the query string is not necessary for this tutorial section, you want to do this as early as possible for convenience since any change here is going to take time to propagate to all the CDN nodes, and you don't want any non-query-string-enabled content to clog up the CDN cache (updating CDN content will be discussed later).\n\n3. Ping your CDN endpoint to make sure that it's propagated to the CDN nodes. You may need to wait up to an hour before it will respond to pings.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-cs-13-testcdn.png)\n\n2. Back in Visual Studio 2013, open **Web.config** in your **WebRole1** project and add the following code into the `<system.webServer>` tag:  \n\n        <system.webServer>\n          <rewrite>\n            <rules>\n              <rule name=\"RewriteIncomingCdnRequest\" stopProcessing=\"true\">\n                <match url=\"^cdn/(.*)$\"/>\n                <action type=\"Rewrite\" url=\"{R:1}\"/>\n              </rule>\n            </rules>\n          </rewrite>\n          ...\n        </system.webServer>\n\n4. Publish the cloud service again. Right-click the cloud service project and select **Publish**.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-cs-4-publish-a.png)\n\n1. When the publishing status is **Completed**, open a browser window and navigate to **http://*&lt;cdnName>*.vo.msecnd.net/Content/bootstrap.css**. In my setup, this URL is:\n\n        http://az632148.vo.msecnd.net/Content/bootstrap.css\n\n    Which corresponds to the following origin URL at the CDN endpoint:\n\n        http://cephalinservice.cloudapp.net/cdn/Content/bootstrap.css\n\n    After URL rewrite in my Web app, the actual file that gets cached to my CDN cache is:\n\n        http://cephalinservice.cloudapp.net/Content/bootstrap.css\n\n    When you navigate to **http://*&lt;cdnName>*.vo.msecnd.net/Content/bootstrap.css**, you will be prompted to download the bootstrap.css that came from your published Web app. \n\n    ![](media/cdn-cloud-service-with-cdn/cdn-1-browser-access.PNG)\n\nYou can similarly access any publicly accessible URL at **http://*&lt;serviceName>*.cloudapp.net/**, straight from your CDN endpoint. For example:\n\n-   A .js file from the /Script path\n-   Any content file from the /Content path\n-   Any controller/action \n-   If the query string is enabled at your CDN endpoint, any URL with query strings\n\nIn fact, with the above configuration, you can host the entire cloud service from **http://*&lt;cdnName>*.vo.msecnd.net/**. If I navigate to **http://az632148.vo.msecnd.net/**, I get the action result from Home/Index.\n\n![](media/cdn-cloud-service-with-cdn/cdn-2-home-page.PNG)\n\nThis does not mean, however, that it's always a good idea (or generally a good idea) to serve an entire cloud service through Azure CDN. Some of the caveats are:\n\n-   This approach requires your entire site to be public, because Azure CDN cannot serve any private content.\n-   If the CDN endpoint goes offline for any reason, whether scheduled maintenance or user error, your entire cloud service goes offline unless the customers can be redirected to the origin URL **http://*&lt;serviceName>*.cloudapp.net/**. \n-   Even with the custom Cache-Control settings (see [Configure caching options for static files in your cloud service](#caching)), a CDN endpoint does not improve the performance of highly-dynamic content. If you tried to load the home page from your CDN endpoint as shown above, notice that it took at least 5 seconds to load the default home page the first time, which is a fairly simple page. Imagine what would happen to the client experience if this page contains dynamic content that must update every minute. Serving dynamic content from a CDN endpoint requires short cache expiration, which translates to frequent cache misses at the CDN endpoint. This hurts the performance of your cloud service and defeats the purpose of a CDN.\n\nThe alternative is to determine which content to serve from Azure CDN on a case-by-case basis in your cloud service. To that end, you have already seen how to access individual content files from the CDN endpoint. I will show you how to serve a specific controller action through the CDN endpoint in [Serve content from controller actions through Azure CDN](#controller).\n\nYou can specify a more restrictive URL rewrite rule to limit the content accessible through your CDN endpoint. For example, to limit URL rewrite to the *\\Scripts* folder, change the above rewrite rule as follows:\n   \n    <rule name=\"RewriteIncomingCdnRequest\" stopProcessing=\"true\">\n      <match url=\"^cdn/Scripts/(.*)$\"/>\n      <action type=\"Rewrite\" url=\"Scripts/{R:1}\"/>\n    </rule>\n\n<a name=\"caching\"></a>\n## Configure caching options for static files in your cloud service ##\n\nWith Azure CDN integration in your cloud service, you can specify how you want static content to be cached in the CDN endpoint. To do this, open *Web.config* from your Web role project (e.g. WebRole1) and add a `<staticContent>` element to `<system.webServer>`. The XML below configures the cache to expire in 3 days.  \n\n    <system.webServer>\n      <staticContent>\n        <clientCache cacheControlMode=\"UseMaxAge\" cacheControlMaxAge=\"3.00:00:00\"/>\n      </staticContent>\n      ...\n    </system.webServer>\n\nOnce you do this, all static files in your cloud service will observe the same rule in your CDN cache. For more granular control of cache settings, add a *Web.config* file into a folder and add your settings there. For example, add a *Web.config* file to the *\\Content* folder and replace the content with the following XML:\n\n    <?xml version=\"1.0\"?>\n    <configuration>\n      <system.webServer>\n        <staticContent>\n          <clientCache cacheControlMode=\"UseMaxAge\" cacheControlMaxAge=\"15.00:00:00\"/>\n        </staticContent>\n      </system.webServer>\n    </configuration>\n\nThis setting causes all static files from the *\\Content* folder to be cached for 15 days.\n\nFor more information on how to configure the `<clientCache>` element, see [Client Cache &lt;clientCache>](http://www.iis.net/configreference/system.webserver/staticcontent/clientcache).\n\nIn [Serve content from controller actions through Azure CDN](#controller), I will also show you how you can configure cache settings for controller action results in the CDN cache.\n\n<a name=\"controller\"></a>\n## Serve content from controller actions through Azure CDN ##\n\nWhen you integrate a cloud service Web role with Azure CDN, it is relatively easy to serve content from controller actions through the Azure CDN. Other than serving your cloud service directly through Azure CDN (demonstrated above), [Maarten Balliauw](https://twitter.com/maartenballiauw) shows you how to do it with a fun MemeGenerator controller in [Reducing latency on the web with the Azure CDN](http://channel9.msdn.com/events/TechDays/Techdays-2014-the-Netherlands/Reducing-latency-on-the-web-with-the-Windows-Azure-CDN). I will simply reproduce it here.\n\nSuppose in your cloud service you want to generate memes based on a young Chuck Norris image (photo by [Alan Light](http://www.flickr.com/photos/alan-light/218493788/)) like this:\n\n![](media/cdn-cloud-service-with-cdn/cdn-5-memegenerator.PNG)\n\nYou have a simple `Index` action that allows the customers to specify the superlatives in the image, then generates the meme once they post to the action. Since it's Chuck Norris, you would expect this page to become wildly popular globally. This is a good example of serving semi-dynamic content with Azure CDN. \n\nFollow the steps above to setup this controller action:\n\n1. In the *\\Controllers* folder, create a new .cs file called *MemeGeneratorController.cs* and replace the content with the following code. Be sure to replace the highlighted portion with your CDN name.  \n\n        using System;\n        using System.Collections.Generic;\n        using System.Diagnostics;\n        using System.Drawing;\n        using System.IO;\n        using System.Net;\n        using System.Web.Hosting;\n        using System.Web.Mvc;\n        using System.Web.UI;\n        \n        namespace WebRole1.Controllers\n        {\n            public class MemeGeneratorController : Controller\n            {\n                static readonly Dictionary<string, Tuple<string ,string>> Memes = new Dictionary<string, Tuple<string, string>>();\n        \n                public ActionResult Index()\n                {\n                    return View();\n                }\n        \n                [HttpPost, ActionName(\"Index\")]\n                public ActionResult Index_Post(string top, string bottom)\n                {\n                    var identifier = Guid.NewGuid().ToString();\n                    if (!Memes.ContainsKey(identifier))\n                    {\n                        Memes.Add(identifier, new Tuple<string, string>(top, bottom));\n                    }\n        \n                    return Content(\"<a href=\\\"\" + Url.Action(\"Show\", new {id = identifier}) + \"\\\">here's your meme</a>\");\n                }\n        \n                [OutputCache(VaryByParam = \"*\", Duration = 1, Location = OutputCacheLocation.Downstream)]\n                public ActionResult Show(string id)\n                {\n                    Tuple<string, string> data = null;\n                    if (!Memes.TryGetValue(id, out data))\n                    {\n                        return new HttpStatusCodeResult(HttpStatusCode.NotFound);\n                    }\n        \n                    if (Debugger.IsAttached) // Preserve the debug experience\n                    {\n                        return Redirect(string.Format(\"/MemeGenerator/Generate?top={0}&bottom={1}\", data.Item1, data.Item2));\n                    }\n                    else // Get content from Azure CDN\n                    {\n                        return Redirect(string.Format(\"http://<yourCdnName>.vo.msecnd.net/MemeGenerator/Generate?top={0}&bottom={1}\", data.Item1, data.Item2));\n                    }\n                }\n        \n                [OutputCache(VaryByParam = \"*\", Duration = 3600, Location = OutputCacheLocation.Downstream)]\n                public ActionResult Generate(string top, string bottom)\n                {\n                    string imageFilePath = HostingEnvironment.MapPath(\"~/Content/chuck.bmp\");\n                    Bitmap bitmap = (Bitmap)Image.FromFile(imageFilePath);\n        \n                    using (Graphics graphics = Graphics.FromImage(bitmap))\n                    {\n                        SizeF size = new SizeF();\n                        using (Font arialFont = FindBestFitFont(bitmap, graphics, top.ToUpperInvariant(), new Font(\"Arial Narrow\", 100), out size))\n                        {\n                            graphics.DrawString(top.ToUpperInvariant(), arialFont, Brushes.White, new PointF(((bitmap.Width - size.Width) / 2), 10f));\n                        }\n                        using (Font arialFont = FindBestFitFont(bitmap, graphics, bottom.ToUpperInvariant(), new Font(\"Arial Narrow\", 100), out size))\n                        {\n                            graphics.DrawString(bottom.ToUpperInvariant(), arialFont, Brushes.White, new PointF(((bitmap.Width - size.Width) / 2), bitmap.Height - 10f - arialFont.Height));\n                        }\n                    }\n        \n                    MemoryStream ms = new MemoryStream();\n                    bitmap.Save(ms, System.Drawing.Imaging.ImageFormat.Png);\n                    return File(ms.ToArray(), \"image/png\");\n                }\n        \n                private Font FindBestFitFont(Image i, Graphics g, String text, Font font, out SizeF size)\n                {\n                    // Compute actual size, shrink if needed\n                    while (true)\n                    {\n                        size = g.MeasureString(text, font);\n        \n                        // It fits, back out\n                        if (size.Height < i.Height &&\n                             size.Width < i.Width) { return font; }\n        \n                        // Try a smaller font (90% of old size)\n                        Font oldFont = font;\n                        font = new Font(font.Name, (float)(font.Size * .9), font.Style);\n                        oldFont.Dispose();\n                    }\n                }\n            }\n        }\n\n2. Right-click in the default `Index()` action and select **Add View**.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-6-addview.PNG)\n\n3.  Accept the settings below and click **Add**.\n\n    ![](media/cdn-cloud-service-with-cdn/cdn-7-configureview.PNG)\n\n4. Open the new *Views\\MemeGenerator\\Index.cshtml* and replace the content with the following simple HTML for submitting the superlatives:\n\n        <h2>Meme Generator</h2>\n        \n        <form action=\"\" method=\"post\">\n            <input type=\"text\" name=\"top\" placeholder=\"Enter top text here\" />\n            <br />\n            <input type=\"text\" name=\"bottom\" placeholder=\"Enter bottom text here\" />\n            <br />\n            <input class=\"btn\" type=\"submit\" value=\"Generate meme\" />\n        </form>\n\n5. Publish the cloud service again and navigate to **http://*&lt;serviceName>*.cloudapp.net/MemeGenerator/Index** in your browser. \n\nWhen you submit the form values to `/MemeGenerator/Index`, the `Index_Post` action method returns a link to the `Show` action method with the respective input identifier. When you click the link, you reach the following code:  \n\n    [OutputCache(VaryByParam = &quot;*&quot;, Duration = 1, Location = OutputCacheLocation.Downstream)]\n    public ActionResult Show(string id)\n    {\n        Tuple&lt;string, string&gt; data = null;\n        if (!Memes.TryGetValue(id, out data))\n        {\n            return new HttpStatusCodeResult(HttpStatusCode.NotFound);\n        }\n    \n        if (Debugger.IsAttached) // Preserve the debug experience\n        {\n            return Redirect(string.Format(&quot;/MemeGenerator/Generate?top={0}&bottom={1}&quot;, data.Item1, data.Item2));\n        }\n        else // Get content from Azure CDN\n        {\n            return Redirect(string.Format(&quot;http://<mark>&lt;cdnName&gt;</mark>.vo.msecnd.net/MemeGenerator/Generate?top={0}&amp;bottom={1}&quot;, data.Item1, data.Item2));\n        }\n    }\n    \nIf your local debugger is attached, then you will get the regular debug experience with a local redirect. If it's running in the cloud service, then it will redirect to:\n\n    http://<yourCDNName>.vo.msecnd.net/MemeGenerator/Generate?top=<formInput>&bottom=<formInput>\n\nWhich corresponds to the following origin URL at your CDN endpoint:\n\n    http://<youCloudServiceName>.cloudapp.net/cdn/MemeGenerator/Generate?top=<formInput>&bottom=<formInput>\n\nAfter URL rewrite rule previously applied, the actual file that gets cached to your CDN endpoint is:\n\n    http://<youCloudServiceName>.cloudapp.net/MemeGenerator/Generate?top=<formInput>&bottom=<formInput>\n\nYou can then use the `OutputCacheAttribute` attribute on the `Generate` method to specify how the action result should be cached, which Azure CDN will honor. The code below specify a cache expiration of 1 hour (3,600 seconds).\n\n    [OutputCache(VaryByParam = \"*\", Duration = 3600, Location = OutputCacheLocation.Downstream)]\n\nLikewise, you can serve up content from any controller action in your cloud service through your Azure CDN, with the desired caching option.\n\nIn the next section, I will show you how to serve the bundled and minified scripts and CSS through Azure CDN. \n\n<a name=\"bundling\"></a>\n## Integrate ASP.NET bundling and minification with Azure CDN ##\n\nScripts and CSS stylesheets change infrequently and are prime candidates for the Azure CDN cache. Serving the entire Web role through your Azure CDN is the easiest way to integrate bundling and minification with Azure CDN. However, as you may not want to do this, I will show you how to do it while preserving the desired develper experience of ASP.NET bundling and minification, such as:\n\n-   Great debug mode experience\n-   Streamlined deployment\n-   Immediate updates to clients for script/CSS version upgrades\n-   Fallback mechanism when your CDN endpoint fails\n-   Minimize code modification\n\nIn the **WebRole1** project that you created in [Integrate an Azure CDN endpoint with your Azure website and serve static content in your Web pages from Azure CDN](#deploy), open *App_Start\\BundleConfig.cs* and take a look at the `bundles.Add()` method calls.\n\n    public static void RegisterBundles(BundleCollection bundles)\n    {\n        bundles.Add(new ScriptBundle(\"~/bundles/jquery\").Include(\n                    \"~/Scripts/jquery-{version}.js\"));\n        ...\n    }\n\nThe first `bundles.Add()` statement adds a script bundle at the virtual directory `~/bundles/jquery`. Then, open *Views\\Shared\\_Layout.cshtml* to see how the script bundle tag is rendered. You should be able to find the following line of Razor code:\n\n    @Scripts.Render(\"~/bundles/jquery\")\n\nWhen this Razor code is run in the Azure Web role, it will render a `<script>` tag for the script bundle similar to the following: \n\n    <script src=\"/bundles/jquery?v=FVs3ACwOLIVInrAl5sdzR2jrCDmVOWFbZMY6g6Q0ulE1\"></script>\n\nHowever, when it is run in Visual Studio by typing `F5`, it will render each script file in the bundle individually (in the case above, only one script file is in the bundle):\n\n    <script src=\"/Scripts/jquery-1.10.2.js\"></script>\n\nThis enables you to debug the JavaScript code in your development environment while reducing concurrent client connections (bundling) and improving file download performance (minification) in production. It's a great feature to preserve with Azure CDN integration. Furthermore, since the rendered bundle already contains an automatically generated version string, you want to replicate that functionality so the whenever you update your jQuery version through NuGet, it can be updated at the client side as soon as possible.\n\nFollow the steps below to integration ASP.NET bundling and minification with your CDN endpoint.\n\n1. Back in *App_Start\\BundleConfig.cs*, modify the `bundles.Add()` methods to use a different [Bundle constructor](http://msdn.microsoft.com/library/jj646464.aspx), one that specifies a CDN address. To do this, replace the `RegisterBundles` method definition with the following code:  \n\n        public static void RegisterBundles(BundleCollection bundles)\n        {\n            bundles.UseCdn = true;\n            var version = System.Reflection.Assembly.GetAssembly(typeof(Controllers.HomeController))\n                .GetName().Version.ToString();\n            var cdnUrl = \"http://<yourCDNName>.vo.msecnd.net/{0}?v=\" + version;\n        \n            bundles.Add(new ScriptBundle(\"~/bundles/jquery\", string.Format(cdnUrl, \"bundles/jquery\")).Include(\n                        \"~/Scripts/jquery-{version}.js\"));\n        \n            bundles.Add(new ScriptBundle(\"~/bundles/jqueryval\", string.Format(cdnUrl, \"bundles/jqueryval\")).Include(\n                        \"~/Scripts/jquery.validate*\"));\n        \n            // Use the development version of Modernizr to develop with and learn from. Then, when you're\n            // ready for production, use the build tool at http://modernizr.com to pick only the tests you need.\n            bundles.Add(new ScriptBundle(\"~/bundles/modernizr\", string.Format(cdnUrl, \"bundles/modernizer\")).Include(\n                        \"~/Scripts/modernizr-*\"));\n        \n            bundles.Add(new ScriptBundle(\"~/bundles/bootstrap\", string.Format(cdnUrl, \"bundles/bootstrap\")).Include(\n                        \"~/Scripts/bootstrap.js\",\n                        \"~/Scripts/respond.js\"));\n        \n            bundles.Add(new StyleBundle(\"~/Content/css\", string.Format(cdnUrl, \"Content/css\")).Include(\n                        \"~/Content/bootstrap.css\",\n                        \"~/Content/site.css\"));\n        }\n\n    Be sure to replace `<yourCDNName>` with the name of your Azure CDN.\n\n    In plain words, you are setting `bundles.UseCdn = true` and added a carefully crafted CDN URL to each bundle. For example, the first constructor in the code:\n\n        new ScriptBundle(\"~/bundles/jquery\", string.Format(cdnUrl, \"bundles/jquery\"))\n\n    is the same as: \n\n        new ScriptBundle(\"~/bundles/jquery\", string.Format(cdnUrl, \"http://<yourCDNName>.vo.msecnd.net/bundles/jquery?v=<W.X.Y.Z>\"))\n\n    This constructor tells ASP.NET bundling and minification to render individual script files when debugged locally, but use the specified CDN address to access the script in question. However, note two important characteristics with this carefully crafted CDN URL:\n    \n    -   The origin for this CDN URL is `http://<yourCloudService>.cloudapp.net/bundles/jquery?v=<W.X.Y.Z>`, which is actually the virtual directory of the script bundle in your cloud service.\n    -   Since you are using CDN constructor, the CDN script tag for the bundle no longer contains the automatically generated version string in the rendered URL. You must manually generate a unique version string every time the script bundle is modified to force a cache miss at your Azure CDN. At the same time, this unique version string must remain constant through the life of the deployment to maximize cache hits at your Azure CDN after the bundle is deployed.\n    -   The query string v=<W.X.Y.Z> pulls from *Properties\\AssemblyInfo.cs* in your Web role project. You can have a deployment workflow that includes incrementing the assembly version every time you publish to Azure. Or, you can just modify *Properties\\AssemblyInfo.cs* in your project to automatically increment the version string every time you build, using the wildcard character '*'. For example:\n    \n            [assembly: AssemblyVersion(\"1.0.0.*\")]\n    \n        Any other strategy to streamline generating a unique string for the life of a deployment will work here.\n\n3. Republish the cloud service and access the home page.\n \n4. View the HTML code for the page. You should be able to see the CDN URL rendered, with a unique version string every time you republish changes to your cloud service. For example:  \n\n        ...\n        \n        <link href=\"http://az632148.vo.msecnd.net/Content/css?v=1.0.0.25449\" rel=\"stylesheet\"/>\n        \n        <script src=\"http://az632148.vo.msecnd.net/bundles/modernizer?v=1.0.0.25449\"></script>\n        \n        ...\n        \n        <script src=\"http://az632148.vo.msecnd.net/bundles/jquery?v=1.0.0.25449\"></script>\n        \n        <script src=\"http://az632148.vo.msecnd.net/bundles/bootstrap?v=1.0.0.25449\"></script>\n        \n        ...\n\n5. In Visual Studio, debug the cloud service in Visual Studio by typing `F5`., \n\n6. View the HTML code for the page. You will still see each script file individually rendered so that you can have a consistent debug experience in Visual Studio.  \n\n        ...\n        \n            <link href=\"/Content/bootstrap.css\" rel=\"stylesheet\"/>\n        <link href=\"/Content/site.css\" rel=\"stylesheet\"/>\n        \n            <script src=\"/Scripts/modernizr-2.6.2.js\"></script>\n        \n        ...\n        \n            <script src=\"/Scripts/jquery-1.10.2.js\"></script>\n        \n            <script src=\"/Scripts/bootstrap.js\"></script>\n        <script src=\"/Scripts/respond.js\"></script>\n        \n        ...   \n\n<a name=\"fallback\"></a>\n## Fallback mechanism for CDN URLs ##\n\nWhen your Azure CDN endpoint fails for any reason, you want your Web page to be smart enough to access your origin Web server as the fallback option for loading JavaScript or Bootstrap. It's serious enough to lose images on your website due to CDN unavailability, but much more severe to lose crucial page functionality provided by your scripts and stylesheets.\n\nThe [Bundle](http://msdn.microsoft.com/library/system.web.optimization.bundle.aspx) class contains a property called [CdnFallbackExpression](http://msdn.microsoft.com/library/system.web.optimization.bundle.cdnfallbackexpression.aspx) that enables you to configure the fallback mechanism for CDN failure. To use this property, follow the steps below:\n\n1. In your Web role project, open *App_Start\\BundleConfig.cs*, where you added a CDN URL in each [Bundle constructor](http://msdn.microsoft.com/library/jj646464.aspx), and make the following highlighted changes to add fallback mechanism to the default bundles:  \n\n        public static void RegisterBundles(BundleCollection bundles)\n        {\n            var version = System.Reflection.Assembly.GetAssembly(typeof(BundleConfig))\n                .GetName().Version.ToString();\n            var cdnUrl = &quot;http://cdnurl.vo.msecnd.net/.../{0}?&quot; + version;\n            bundles.UseCdn = true;\n        \n            bundles.Add(new ScriptBundle(&quot;~/bundles/jquery&quot;, string.Format(cdnUrl, &quot;bundles/jquery&quot;)) \n                        <mark>{ CdnFallbackExpression = &quot;window.jquery&quot; }</mark>\n                        .Include(&quot;~/Scripts/jquery-{version}.js&quot;));\n        \n            bundles.Add(new ScriptBundle(&quot;~/bundles/jqueryval&quot;, string.Format(cdnUrl, &quot;bundles/jqueryval&quot;)) \n                        <mark>{ CdnFallbackExpression = &quot;$.validator&quot; }</mark>\n                        .Include(&quot;~/Scripts/jquery.validate*&quot;));\n        \n            // Use the development version of Modernizr to develop with and learn from. Then, when you&#39;re\n            // ready for production, use the build tool at http://modernizr.com to pick only the tests you need.\n            bundles.Add(new ScriptBundle(&quot;~/bundles/modernizr&quot;, string.Format(cdnUrl, &quot;bundles/modernizer&quot;)) \n                        <mark>{ CdnFallbackExpression = &quot;window.Modernizr&quot; }</mark>\n                        .Include(&quot;~/Scripts/modernizr-*&quot;));\n        \n            bundles.Add(new ScriptBundle(&quot;~/bundles/bootstrap&quot;, string.Format(cdnUrl, &quot;bundles/bootstrap&quot;))     \n                        <mark>{ CdnFallbackExpression = &quot;$.fn.modal&quot; }</mark>\n                        .Include(\n                                &quot;~/Scripts/bootstrap.js&quot;,\n                                &quot;~/Scripts/respond.js&quot;));\n        \n            bundles.Add(new StyleBundle(&quot;~/Content/css&quot;, string.Format(cdnUrl, &quot;Content/css&quot;)).Include(\n                        &quot;~/Content/bootstrap.css&quot;,\n                        &quot;~/Content/site.css&quot;));\n        }\n\n    When `CdnFallbackExpression` is not null, script is injected into the HTML to test whether the bundle is loaded successfully and, if not, access the bundle directly from the origin Web server. This property needs to be set to a JavaScript expression that tests whether the respective CDN bundle is loaded properly. The expression needed to test each bundle differs according to the content. For the default bundles above:\n    \n    -   `window.jquery` is defined in jquery-{version}.js\n    -   `$.validator` is defined in jquery.validate.js\n    -   `window.Modernizr` is defined in modernizer-{version}.js\n    -   `$.fn.modal` is defined in bootstrap.js\n    \n    You might have noticed that I did not set CdnFallbackExpression for the `~/Cointent/css` bundle. This is because currently there is a [bug in System.Web.Optimization](https://aspnetoptimization.codeplex.com/workitem/104) that injects a `<script>` tag for the fallback CSS instead of the expected `<link>` tag.\n    \n    There is, however, a good [Style Bundle Fallback](https://github.com/EmberConsultingGroup/StyleBundleFallback) offered by [Ember Consulting Group](https://github.com/EmberConsultingGroup). \n\n2. To use the workaround for CSS, create a new .cs file in your Web role project's *App_Start* folder called *StyleBundleExtensions.cs*, and replace its content with the [code from GitHub](https://github.com/EmberConsultingGroup/StyleBundleFallback/blob/master/Website/App_Start/StyleBundleExtensions.cs). \n\n4. In *App_Start\\StyleFundleExtensions.cs*, rename the namespace to your Web role's name (e.g. **WebRole1**). \n\n3. Go back to `App_Start\\BundleConfig.cs` and modify the last `bundles.Add` statement with the following highlighted code:  \n\n        bundles.Add(new StyleBundle(\"~/Content/css\", string.Format(cdnUrl, \"Content/css\"))\n            <mark>.IncludeFallback(\"~/Content/css\", \"sr-only\", \"width\", \"1px\")</mark>\n            .Include(\n                  \"~/Content/bootstrap.css\",\n                  \"~/Content/site.css\"));\n\n    This new extension method uses the same idea to inject script in the HTML to check the DOM for the a matching class name, rule name, and rule value defined in the CSS bundle, and falls back to the origin Web server if it fails to find the match.\n\n4. Publish the cloud service again and access the home page. \n\n5. View the HTML code for the page. You should find injected scripts similar to the following:    \n\n        ...\n        \n        <link href=\"http://az632148.vo.msecnd.net/Content/css?v=1.0.0.25474\" rel=\"stylesheet\"/>\n        <script>(function() {\n                        var loadFallback,\n                            len = document.styleSheets.length;\n                        for (var i = 0; i < len; i++) {\n                            var sheet = document.styleSheets[i];\n                            if (sheet.href.indexOf('http://az632148.vo.msecnd.net/Content/css?v=1.0.0.25474') !== -1) {\n                                var meta = document.createElement('meta');\n                                meta.className = 'sr-only';\n                                document.head.appendChild(meta);\n                                var value = window.getComputedStyle(meta).getPropertyValue('width');\n                                document.head.removeChild(meta);\n                                if (value !== '1px') {\n                                    document.write('<link href=\"/Content/css\" rel=\"stylesheet\" type=\"text/css\" />');\n                                }\n                            }\n                        }\n                        return true;\n                    }())||document.write('<script src=\"/Content/css\"><\\/script>');</script>\n        \n            <script src=\"http://az632148.vo.msecnd.net/bundles/modernizer?v=1.0.0.25474\"></script>\n        <script>(window.Modernizr)||document.write('<script src=\"/bundles/modernizr\"><\\/script>');</script>\n        \n        ... \n        \n            <script src=\"http://az632148.vo.msecnd.net/bundles/jquery?v=1.0.0.25474\"></script>\n        <script>(window.jquery)||document.write('<script src=\"/bundles/jquery\"><\\/script>');</script>\n        \n            <script src=\"http://az632148.vo.msecnd.net/bundles/bootstrap?v=1.0.0.25474\"></script>\n        <script>($.fn.modal)||document.write('<script src=\"/bundles/bootstrap\"><\\/script>');</script>\n        \n        ...\n\n\n    Note that injected script for the CSS bundle still contains the errant remnant from the `CdnFallbackExpression` property in the line:\n\n        }())||document.write('<script src=\"/Content/css\"><\\/script>');</script>\n\n    But since the first part of the || expression will always return true (in the line directly above that), the document.write() function will never run.\n\n## More Information ##\n- [Overview of the Azure Content Delivery Network (CDN)](http://msdn.microsoft.com/library/azure/ff919703.aspx)\n- [Serve Content from Azure CDN in Your Web Application](cdn-serve-content-from-cdn-in-your-web-application.md)\n- [Integrate an Azure Website with Azure CDN](cdn-websites-with-cdn.md)\n- [ASP.NET Bundling and Minification](http://www.asp.net/mvc/tutorials/mvc-4/bundling-and-minification)\n- [Using CDN for Azure](cdn-how-to-use.md)\n\ntest\n"
}