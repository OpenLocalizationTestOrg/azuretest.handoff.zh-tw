{
  "nodes": [
    {
      "content": "End-to-End Troubleshooting using Azure Storage Metrics and Logging, AzCopy, and Message Analyzer | Microsoft Azure",
      "pos": [
        28,
        142
      ]
    },
    {
      "content": "A tutorial demonstrating end-to-end troubleshooting with Azure Storage Analytics, AzCopy, and Microsoft Message Analyzer",
      "pos": [
        162,
        282
      ]
    },
    {
      "content": "End-to-End Troubleshooting using Azure Storage Metrics and Logging, AzCopy, and Message Analyzer",
      "pos": [
        576,
        672
      ]
    },
    {
      "content": "Overview",
      "pos": [
        678,
        686
      ]
    },
    {
      "content": "Diagnosing and troubleshooting is a key skill for building and supporting client applications with Microsoft Azure Storage.",
      "pos": [
        688,
        811
      ]
    },
    {
      "content": "Due to the distributed nature of an Azure application, diagnosing and troubleshooting errors and performance issues may be more complex than in traditional environments.",
      "pos": [
        812,
        981
      ]
    },
    {
      "content": "In this tutorial, we will demonstrate how to identify client certain errors that may affect performance, and troubleshoot those errors from end-to-end using tools provided by Microsoft and Azure Storage, in order to optimize the client application.",
      "pos": [
        983,
        1231
      ]
    },
    {
      "content": "This tutorial provides a hands-on exploration of an end-to-end troubleshooting scenario.",
      "pos": [
        1234,
        1322
      ]
    },
    {
      "content": "For an in-depth conceptual guide to troubleshooting Azure storage applications, see <bpt id=\"p1\">[</bpt>Monitor, diagnose, and troubleshoot Storage<ept id=\"p1\">](../articles/storage-monitoring-diagnosing-troubleshooting.md)</ept>.",
      "pos": [
        1323,
        1515
      ]
    },
    {
      "content": "Tools for troubleshooting Azure Storage applications",
      "pos": [
        1521,
        1573
      ]
    },
    {
      "content": "To troubleshoot client applications using Microsoft Azure Storage, you can use a combination of tools to determine when an issue has occurred and what the cause of the problem may be.",
      "pos": [
        1575,
        1758
      ]
    },
    {
      "content": "These tools include:",
      "pos": [
        1759,
        1779
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Azure Storage Analytics<ept id=\"p1\">**</ept>.",
      "pos": [
        1783,
        1811
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>Azure Storage Analytics<ept id=\"p1\">](http://msdn.microsoft.com/library/azure/hh343270.aspx)</ept> provides metrics and logging for Azure Storage.",
      "pos": [
        1812,
        1940
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Storage metrics<ept id=\"p1\">**</ept> tracks transaction metrics and capacity metrics for your storage account.",
      "pos": [
        1947,
        2040
      ]
    },
    {
      "content": "Using metrics, you can determine how your application is performing according to a variety of different measures.",
      "pos": [
        2041,
        2154
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>Storage Analytics Metrics Table Schema<ept id=\"p1\">](http://msdn.microsoft.com/library/azure/hh343264.aspx)</ept> for more information about the types of metrics tracked by Storage Analytics.",
      "pos": [
        2155,
        2332
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Storage logging<ept id=\"p1\">**</ept> logs each request to the Azure Storage services to a server-side log.",
      "pos": [
        2341,
        2430
      ]
    },
    {
      "content": "The log tracks detailed data for each request, including the operation performed, the status of the operation, and latency information.",
      "pos": [
        2431,
        2566
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>Storage Analytics Log Format<ept id=\"p1\">](http://msdn.microsoft.com/library/azure/hh343259.aspx)</ept> for more information about the request and response data that is written to the logs by Storage Analytics.",
      "pos": [
        2567,
        2763
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>The Azure Management Portal<ept id=\"p1\">**</ept>.",
      "pos": [
        2767,
        2799
      ]
    },
    {
      "content": "You can configure metrics and logging for your storage account in the portal.",
      "pos": [
        2800,
        2877
      ]
    },
    {
      "content": "You can also view charts and graphs that show how your application is performing over time, and configure alerts in the portal to notify you if your application performs differently than expected for a specified metric.",
      "pos": [
        2878,
        3097
      ]
    },
    {
      "content": "This tutorial shows how to monitor your storage account using the <bpt id=\"p1\">[</bpt>Azure Management Portal<ept id=\"p1\">](https://manage.windowsazure.com/)</ept>.",
      "pos": [
        3108,
        3234
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>How to monitor a storage account<ept id=\"p1\">](storage-monitor-storage-account.md)</ept> for information about configuring monitoring in the portal.",
      "pos": [
        3235,
        3369
      ]
    },
    {
      "pos": [
        3375,
        3517
      ],
      "content": "You can also use the <bpt id=\"p1\">[</bpt>Azure Preview Portal<ept id=\"p1\">](https://portal.azure.com/)</ept> for the latest experience, but note that it is still a preview release."
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>AzCopy<ept id=\"p1\">**</ept>.",
      "pos": [
        3522,
        3533
      ]
    },
    {
      "content": "Server logs for Azure Storage are stored as blobs, so you can use AzCopy to copy the log blobs to a local directory for analysis using Microsoft Message Analyzer.",
      "pos": [
        3534,
        3696
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>How to use AzCopy with Microsoft Azure Storage<ept id=\"p1\">](storage-use-azcopy.md)</ept> for more information about AzCopy.",
      "pos": [
        3697,
        3807
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Microsoft Message Analyzer<ept id=\"p1\">**</ept>.",
      "pos": [
        3811,
        3842
      ]
    },
    {
      "content": "Message Analyzer is a tool that consumes log files and displays log data in a visual format that makes it easy to filter, search, and group log data into useful sets that you can use to analyze errors and performance issues.",
      "pos": [
        3843,
        4067
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>Microsoft Message Analyzer Operating Guide<ept id=\"p1\">](http://technet.microsoft.com/library/jj649776.aspx)</ept> for more information about Message Analyzer.",
      "pos": [
        4068,
        4213
      ]
    },
    {
      "content": "About the sample scenario",
      "pos": [
        4218,
        4243
      ]
    },
    {
      "content": "For this tutorial, we'll examine a scenario where Azure Storage metrics indicates a low percent success rate for an application that calls Azure storage.",
      "pos": [
        4245,
        4398
      ]
    },
    {
      "content": "The low percent success rate metric (shown as <bpt id=\"p1\">**</bpt>PercentSuccess<ept id=\"p1\">**</ept> in the Azure portal and in the metrics tables) tracks operations that succeed, but that return an HTTP status code that is greater than 299.",
      "pos": [
        4399,
        4604
      ]
    },
    {
      "content": "In the server-side storage log files, these operations are recorded with a transaction status of <bpt id=\"p1\">**</bpt>ClientOtherErrors<ept id=\"p1\">**</ept>.",
      "pos": [
        4605,
        4724
      ]
    },
    {
      "content": "For more details about the low percent success metric, see <bpt id=\"p1\">[</bpt>Metrics show low PercentSuccess or analytics log entries have operations with transaction status of ClientOtherErrors<ept id=\"p1\">](storage-monitoring-diagnosing-troubleshooting.md#metrics-show-low-percent-success)</ept>.",
      "pos": [
        4725,
        4987
      ]
    },
    {
      "content": "Azure Storage operations may return HTTP status codes greater than 299 as part of their normal functionality.",
      "pos": [
        4989,
        5098
      ]
    },
    {
      "content": "But these errors in some cases indicate that you may be able to optimize your client application for improved performance.",
      "pos": [
        5099,
        5221
      ]
    },
    {
      "content": "In this scenario, we'll consider a low percent success rate to be anything below 100%.",
      "pos": [
        5224,
        5310
      ]
    },
    {
      "content": "You can choose a different metric level, however, according to your needs.",
      "pos": [
        5311,
        5385
      ]
    },
    {
      "content": "We recommend that during testing of your application, you establish a baseline tolerance for your key performance metrics.",
      "pos": [
        5386,
        5508
      ]
    },
    {
      "content": "For example, you might determine, based on testing, that your application should have a consistent percent success rate of 90%, or 85%.",
      "pos": [
        5509,
        5644
      ]
    },
    {
      "content": "If your metrics data shows that the application is deviating from that number, then you can investigate what may be causing the increase.",
      "pos": [
        5645,
        5782
      ]
    },
    {
      "content": "For our sample scenario, once we've established that the percent success rate metric is below 100%, we will examine the logs to find the errors that correlate to the metrics, and use them to figure out what is causing the lower percent success rate.",
      "pos": [
        5785,
        6034
      ]
    },
    {
      "content": "We'll look specifically at errors in the 400 range.",
      "pos": [
        6035,
        6086
      ]
    },
    {
      "content": "Then we'll more closely investigate 404 (Not Found) errors.",
      "pos": [
        6087,
        6146
      ]
    },
    {
      "content": "Some causes of 400-range errors",
      "pos": [
        6152,
        6183
      ]
    },
    {
      "content": "The examples below shows a sampling of some 400-range errors for requests against Azure Blob Storage, and their possible causes.",
      "pos": [
        6185,
        6313
      ]
    },
    {
      "content": "Any of these errors, as well as errors in the 300 range and the 500 range, can contribute to a low percent success rate.",
      "pos": [
        6314,
        6434
      ]
    },
    {
      "content": "Note that the lists below are far from complete.",
      "pos": [
        6437,
        6485
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>Status and Error Codes<ept id=\"p1\">](http://msdn.microsoft.com/library/azure/dd179382.aspx)</ept> on MSDN for details about general Azure Storage errors and about errors specific to each of the storage services.",
      "pos": [
        6486,
        6683
      ]
    },
    {
      "content": "Status Code 404 (Not Found) Examples",
      "pos": [
        6687,
        6723
      ]
    },
    {
      "content": "Occurs when a read operation against a container or blob fails because the blob or container is not found.",
      "pos": [
        6727,
        6833
      ]
    },
    {
      "content": "Occurs if a container or blob has been deleted by another client before this request.",
      "pos": [
        6837,
        6922
      ]
    },
    {
      "content": "Occurs if you are using an API call that creates the container or blob after checking whether it exists.",
      "pos": [
        6926,
        7030
      ]
    },
    {
      "content": "The CreateIfNotExists APIs make a HEAD call first to check for the existence of the container or blob; if it does not exist, a 404 error is returned, and then a second PUT call is made to write the container or blob.",
      "pos": [
        7031,
        7247
      ]
    },
    {
      "content": "Status Code 409 (Conflict) Examples",
      "pos": [
        7251,
        7286
      ]
    },
    {
      "content": "Occurs if you use a Create API to create a new container or blob, without checking for existence first, and a container or blob with that name already exists.",
      "pos": [
        7292,
        7450
      ]
    },
    {
      "content": "Occurs if a container is being deleted, and you attempt to create a new container with the same name before the deletion operation is complete.",
      "pos": [
        7454,
        7597
      ]
    },
    {
      "content": "Occurs if you specify a lease on a container or blob, and there is already a lease present.",
      "pos": [
        7600,
        7691
      ]
    },
    {
      "content": "Status Code 412 (Precondition Failed) Examples",
      "pos": [
        7696,
        7742
      ]
    },
    {
      "content": "Occurs when the condition specified by a conditional header has not been met.",
      "pos": [
        7748,
        7825
      ]
    },
    {
      "content": "Occurs when the lease ID specified does not match the lease ID on the container or blob.",
      "pos": [
        7828,
        7916
      ]
    },
    {
      "content": "Generate log files for analysis",
      "pos": [
        7921,
        7952
      ]
    },
    {
      "content": "In this tutorial, we'll use Message Analyzer to work with three different types of log files, although you could choose to work with any one of these:",
      "pos": [
        7954,
        8104
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>server log<ept id=\"p1\">**</ept>, which is created when you enable Azure Storage logging.",
      "pos": [
        8108,
        8183
      ]
    },
    {
      "content": "The server log contains data about each operation called against one of the Azure Storage services - blob, queue, table, and file.",
      "pos": [
        8184,
        8314
      ]
    },
    {
      "content": "The server log indicates which operation was called and what status code was returned, as well as other details about the request and response.",
      "pos": [
        8315,
        8458
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>.NET client log<ept id=\"p1\">**</ept>, which is created when you enable client-side logging from within your .NET application.",
      "pos": [
        8461,
        8573
      ]
    },
    {
      "content": "The client log includes detailed information about how the client prepares the request and receives and processes the response.",
      "pos": [
        8574,
        8701
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>HTTP network trace log<ept id=\"p1\">**</ept>, which collects data on HTTP/HTTPS request and response data, including for operations against Azure Storage.",
      "pos": [
        8705,
        8845
      ]
    },
    {
      "content": "In this tutorial, we'll generate the network trace via Message Analyzer.",
      "pos": [
        8846,
        8918
      ]
    },
    {
      "content": "Configure server-side logging and metrics",
      "pos": [
        8924,
        8965
      ]
    },
    {
      "content": "First, we'll need to configure Azure Storage logging and metrics, so that we have data from the client application to analyze.",
      "pos": [
        8967,
        9093
      ]
    },
    {
      "content": "You can configure logging and metrics in a variety of ways - via the Azure Management Portal, by using PowerShell, or programmatically.",
      "pos": [
        9094,
        9229
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>Enabling Storage Metrics and Viewing Metrics Data<ept id=\"p1\">](http://msdn.microsoft.com/library/azure/dn782843.aspx)</ept> and <bpt id=\"p2\">[</bpt>Enabling Storage Logging and Accessing Log Data<ept id=\"p2\">](http://msdn.microsoft.com/library/azure/dn782840.aspx)</ept> on MSDN for details about configuring logging and metrics.",
      "pos": [
        9230,
        9508
      ]
    },
    {
      "content": "Via the Management Portal",
      "pos": [
        9512,
        9537
      ]
    },
    {
      "pos": [
        9541,
        9715
      ],
      "content": "To configure logging and metrics for your storage account using the portal, follow the instructions at <bpt id=\"p1\">[</bpt>How to monitor a storage account<ept id=\"p1\">](storage-monitor-storage-account.md)</ept>."
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> It's not possible to set minute metrics using the Azure Management Portal.",
      "pos": [
        9719,
        9806
      ]
    },
    {
      "content": "However, we recommend that you do set them for the purposes of this tutorial, and for investigating performance issues with your application.",
      "pos": [
        9807,
        9948
      ]
    },
    {
      "content": "You can set minute metrics using PowerShell as shown below, or programmatically, or via the Azure Preview Portal.",
      "pos": [
        9949,
        10062
      ]
    },
    {
      "content": "Note that the Azure Management Portal cannot display minute metrics, only hourly metrics.",
      "pos": [
        10067,
        10156
      ]
    },
    {
      "content": "Via PowerShell",
      "pos": [
        10161,
        10175
      ]
    },
    {
      "pos": [
        10179,
        10309
      ],
      "content": "To get started with PowerShell for Azure, see <bpt id=\"p1\">[</bpt>How to install and configure Azure PowerShell<ept id=\"p1\">](../install-configure-powershell.md)</ept>."
    },
    {
      "pos": [
        10314,
        10459
      ],
      "content": "Use the <bpt id=\"p1\">[</bpt>Add-AzureAccount<ept id=\"p1\">](http://msdn.microsoft.com/library/azure/dn722528.aspx)</ept> cmdlet to add your Azure user account to the PowerShell window:"
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Sign in to Microsoft Azure<ept id=\"p1\">**</ept> window, type the email address and password associated with your account.",
      "pos": [
        10502,
        10613
      ]
    },
    {
      "content": "Azure authenticates and saves the credential information, and then closes the window.",
      "pos": [
        10614,
        10699
      ]
    },
    {
      "content": "Set the default storage account to the storage account you are using for the tutorial by executing these commands in the PowerShell window:",
      "pos": [
        10703,
        10842
      ]
    },
    {
      "content": "Enable storage logging for the Blob service:",
      "pos": [
        11071,
        11115
      ]
    },
    {
      "pos": [
        11277,
        11370
      ],
      "content": "Enable storage metrics for the Blob service, making sure to set <bpt id=\"p1\">**</bpt>-MetricsType<ept id=\"p1\">**</ept> to <ph id=\"ph1\">`Minute`</ph>:"
    },
    {
      "content": "Configure .NET client-side logging",
      "pos": [
        11543,
        11577
      ]
    },
    {
      "content": "To configure client-side logging for a .NET application, enable .NET diagnostics in the application's configuration file (web.config or app.config).",
      "pos": [
        11579,
        11727
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>Client-side Logging using the Storage Client Library<ept id=\"p1\">](http://msdn.microsoft.com/library/azure/dn782839.aspx)</ept> and <bpt id=\"p2\">[</bpt>Client-side Logging with the Microsoft Azure Storage SDK for Java<ept id=\"p2\">](http://msdn.microsoft.com/library/azure/dn782844.aspx)</ept> on MSDN for details.",
      "pos": [
        11728,
        11989
      ]
    },
    {
      "content": "The client-side log includes detailed information about how the client prepares the request and receives and processes the response.",
      "pos": [
        11991,
        12123
      ]
    },
    {
      "content": "Client-side logging is configured within the app.config or web.config file in your application.",
      "pos": [
        12125,
        12220
      ]
    },
    {
      "content": "For details, see <bpt id=\"p1\">[</bpt>Client-side logging using the Storage Client Library<ept id=\"p1\">](http://msdn.microsoft.com/library/azure/dn782839.aspx)</ept> on MSDN.",
      "pos": [
        12221,
        12356
      ]
    },
    {
      "content": "The Storage Client Library stores client-side log data in the location specified in the application's configuration file (web.config or app.config).",
      "pos": [
        12358,
        12506
      ]
    },
    {
      "content": "Collect a network trace",
      "pos": [
        12513,
        12536
      ]
    },
    {
      "content": "You can use Message Analyzer to collect an HTTP/HTTPS network trace while your client application is running.",
      "pos": [
        12538,
        12647
      ]
    },
    {
      "content": "Message Analyzer uses <bpt id=\"p1\">[</bpt>Fiddler<ept id=\"p1\">](http://www.telerik.com/fiddler)</ept> on the back end.",
      "pos": [
        12648,
        12728
      ]
    },
    {
      "content": "Before you collect the network trace, we recommend that you configure Fiddler to record unencrypted HTTPS traffic:",
      "pos": [
        12729,
        12843
      ]
    },
    {
      "pos": [
        12848,
        12907
      ],
      "content": "Install <bpt id=\"p1\">[</bpt>Fiddler<ept id=\"p1\">](http://www.telerik.com/download/fiddler)</ept>."
    },
    {
      "content": "Launch Fiddler.",
      "pos": [
        12911,
        12926
      ]
    },
    {
      "pos": [
        12930,
        12965
      ],
      "content": "Select <bpt id=\"p1\">**</bpt>Tools | Fiddler Options<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        12969,
        13095
      ],
      "content": "In the Options dialog, ensure that <bpt id=\"p1\">**</bpt>Capture HTTPS CONNECTs<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Decrypt HTTPS Traffic<ept id=\"p2\">**</ept> are both selected, as shown below."
    },
    {
      "content": "Configure Fiddler Options",
      "pos": [
        13099,
        13124
      ]
    },
    {
      "content": "For the tutorial, collect and save a network trace first in Message Analyzer, then create an analysis session to analyze the trace and the logs.",
      "pos": [
        13186,
        13330
      ]
    },
    {
      "content": "To collect a network trace in Message Analyzer:",
      "pos": [
        13331,
        13378
      ]
    },
    {
      "pos": [
        13383,
        13454
      ],
      "content": "In Message Analyzer, select <bpt id=\"p1\">**</bpt>File | Quick Trace | Unencrypted HTTPS<ept id=\"p1\">**</ept>."
    },
    {
      "content": "The trace will begin immediately.",
      "pos": [
        13458,
        13491
      ]
    },
    {
      "content": "Select <bpt id=\"p1\">**</bpt>Stop<ept id=\"p1\">**</ept> to stop the trace so that we can configure it to trace storage traffic only.",
      "pos": [
        13492,
        13584
      ]
    },
    {
      "pos": [
        13588,
        13632
      ],
      "content": "Select <bpt id=\"p1\">**</bpt>Edit<ept id=\"p1\">**</ept> to edit the tracing session."
    },
    {
      "pos": [
        13636,
        13726
      ],
      "content": "Select the <bpt id=\"p1\">**</bpt>Configure<ept id=\"p1\">**</ept> link to the right of the <bpt id=\"p2\">**</bpt>Microsoft-Pef-WebProxy<ept id=\"p2\">**</ept> ETW provider."
    },
    {
      "pos": [
        13730,
        13794
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Advanced Settings<ept id=\"p1\">**</ept> dialog, click the <bpt id=\"p2\">**</bpt>Provider<ept id=\"p2\">**</ept> tab."
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Hostname Filter<ept id=\"p1\">**</ept> field, specify your storage endpoints, separated by spaces.",
      "pos": [
        13798,
        13884
      ]
    },
    {
      "content": "For example, you can specify your endpoints as follows; change <ph id=\"ph1\">`storagesample`</ph> to the name of your storage account:",
      "pos": [
        13885,
        14000
      ]
    },
    {
      "pos": [
        14142,
        14314
      ],
      "content": "Exit the dialog, and click <bpt id=\"p1\">**</bpt>Restart<ept id=\"p1\">**</ept> to begin collecting the trace with the hostname filter in place, so that only Azure Storage network traffic is included in the trace."
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> After you have finished collecting your network trace, we strongly recommend that you revert the settings that you may have changed in Fiddler to decrypt HTTPS traffic.",
      "pos": [
        14317,
        14498
      ]
    },
    {
      "content": "In the Fiddler Options dialog, deselect the <bpt id=\"p1\">**</bpt>Capture HTTPS CONNECTs<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Decrypt HTTPS Traffic<ept id=\"p2\">**</ept> checkboxes.",
      "pos": [
        14499,
        14611
      ]
    },
    {
      "pos": [
        14613,
        14734
      ],
      "content": "See <bpt id=\"p1\">[</bpt>Using the Network Tracing Features<ept id=\"p1\">](http://technet.microsoft.com/library/jj674819.aspx)</ept> on Technet for more details."
    },
    {
      "content": "Review metrics data in the portal",
      "pos": [
        14739,
        14772
      ]
    },
    {
      "content": "Once your application has been running for a period of time, you can review the metrics charts that appear in the portal to observe how your service has been performing.",
      "pos": [
        14774,
        14943
      ]
    },
    {
      "content": "First, we'll add the <bpt id=\"p1\">**</bpt>Success Percentage<ept id=\"p1\">**</ept> metric to the Monitoring page:",
      "pos": [
        14944,
        15018
      ]
    },
    {
      "content": "Navigate to the Dashboard for your storage account in the Management Portal, then select Monitor to view the monitoring page.",
      "pos": [
        15023,
        15148
      ]
    },
    {
      "pos": [
        15152,
        15215
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Add Metrics<ept id=\"p1\">**</ept> to display the <bpt id=\"p2\">**</bpt>Choose Metrics<ept id=\"p2\">**</ept> dialog."
    },
    {
      "content": "Scroll down to find the <bpt id=\"p1\">**</bpt>Success Percentage<ept id=\"p1\">**</ept> group, expand it, then select <bpt id=\"p2\">**</bpt>Aggregate<ept id=\"p2\">**</ept>, as shown in the picture below.",
      "pos": [
        15219,
        15341
      ]
    },
    {
      "content": "This metric aggregates success percentage data from all Blob operations.",
      "pos": [
        15342,
        15414
      ]
    },
    {
      "content": "Choose Metrics",
      "pos": [
        15418,
        15432
      ]
    },
    {
      "content": "In the portal, you'll now see <bpt id=\"p1\">**</bpt>Success Percentage<ept id=\"p1\">**</ept> in the monitoring chart, along with any other metrics you may have added (up to six can be displayed on the chart at once).",
      "pos": [
        15500,
        15676
      ]
    },
    {
      "content": "In the picture below, you can see that the percent success rate is somewhat below 100%, which is the scenario we'll investigate next by analyzing the logs in Message Analyzer:",
      "pos": [
        15677,
        15852
      ]
    },
    {
      "content": "Metrics chart in portal",
      "pos": [
        15856,
        15879
      ]
    },
    {
      "pos": [
        15946,
        16109
      ],
      "content": "For more details on adding metrics to the Monitoring page, see <bpt id=\"p1\">[</bpt>How to: Add metrics to the metrics table<ept id=\"p1\">](storage-monitor-storage-account.md#addmonitoringmetrics)</ept>."
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> It may take some time for your metrics data to appear in the portal after you enable storage metrics.",
      "pos": [
        16113,
        16227
      ]
    },
    {
      "content": "This is because hourly metrics for the previous hour are not displayed in the portal until the current hour has elapsed.",
      "pos": [
        16228,
        16348
      ]
    },
    {
      "content": "Also, minute metrics are not currently displayed in the portal.",
      "pos": [
        16349,
        16412
      ]
    },
    {
      "content": "So depending on when you enable metrics, it may take up to two hours to see metrics data.",
      "pos": [
        16413,
        16502
      ]
    },
    {
      "content": "Use AzCopy to copy server logs to a local directory",
      "pos": [
        16507,
        16558
      ]
    },
    {
      "content": "Azure Storage writes server log data to blobs, while metrics are written to tables.",
      "pos": [
        16560,
        16643
      ]
    },
    {
      "content": "Log blobs are available in the well-known <ph id=\"ph1\">`$logs`</ph> container for your storage account.",
      "pos": [
        16644,
        16729
      ]
    },
    {
      "content": "Log blobs are named hierarchically by year, month, day, and hour, so that you can easily locate the range of time you wish to investigate.",
      "pos": [
        16730,
        16868
      ]
    },
    {
      "content": "For example, in the <ph id=\"ph1\">`storagesample`</ph> account, the container for the log blobs for 01/02/2015, from 8-9 am, is <ph id=\"ph2\">`https://storagesample.blob.core.windows.net/$logs/blob/2015/01/08/0800`</ph>.",
      "pos": [
        16869,
        17051
      ]
    },
    {
      "content": "The individual blobs in this container are named sequentially, beginning with <ph id=\"ph1\">`000000.log`</ph>.",
      "pos": [
        17052,
        17143
      ]
    },
    {
      "content": "You can use the AzCopy command-line tool to download these server-side log files to a location of your choice on your local machine.",
      "pos": [
        17145,
        17277
      ]
    },
    {
      "content": "For example, you can use the following command to download the log files for blob operations that took place on January 2, 2015 to the folder <ph id=\"ph1\">`C:\\Temp\\Logs\\Server`</ph>; replace <ph id=\"ph2\">`&lt;storageaccountname&gt;`</ph> with the name of your storage account, and <ph id=\"ph3\">`&lt;storageaccountkey&gt;`</ph> with your account access key:",
      "pos": [
        17278,
        17568
      ]
    },
    {
      "content": "AzCopy is available for download on the <bpt id=\"p1\">[</bpt>Azure Downloads<ept id=\"p1\">](http://azure.microsoft.com/downloads/)</ept> page.",
      "pos": [
        17740,
        17842
      ]
    },
    {
      "content": "For details about using AzCopy, see <bpt id=\"p1\">[</bpt>How to use AzCopy with Microsoft Azure Storage<ept id=\"p1\">](storage-use-azcopy.md)</ept>.",
      "pos": [
        17843,
        17951
      ]
    },
    {
      "pos": [
        17953,
        18158
      ],
      "content": "For additional information about downloading server-side logs, see <bpt id=\"p1\">[</bpt>Enabling Storage Logging and Accessing Log Data<ept id=\"p1\">](http://msdn.microsoft.com/library/azure/dn782840.aspx#DownloadingStorageLogginglogdata)</ept>."
    },
    {
      "content": "Use Microsoft Message Analyzer to analyze log data",
      "pos": [
        18164,
        18214
      ]
    },
    {
      "content": "Microsoft Message Analyzer is a tool for capturing, displaying, and analyzing protocol messaging traffic, events, and other system or application messages in troubleshooting and diagnostic scenarios.",
      "pos": [
        18216,
        18415
      ]
    },
    {
      "content": "Message Analyzer also enables you to load, aggregate, and analyze data from log and saved trace files.",
      "pos": [
        18416,
        18518
      ]
    },
    {
      "content": "For more information about Message Analyzer, see <bpt id=\"p1\">[</bpt>Microsoft Message Analyzer Operating Guide<ept id=\"p1\">](http://technet.microsoft.com/library/jj649776.aspx)</ept>.",
      "pos": [
        18519,
        18665
      ]
    },
    {
      "content": "Message Analyzer includes assets for Azure Storage that help you to analyze server, client, and network logs.",
      "pos": [
        18667,
        18776
      ]
    },
    {
      "content": "In this section, we'll discuss how to use those tools to address the issue of low percent success in the storage logs.",
      "pos": [
        18777,
        18895
      ]
    },
    {
      "content": "Download and install Message Analyzer and the Azure Storage Assets",
      "pos": [
        18901,
        18967
      ]
    },
    {
      "pos": [
        18972,
        19115
      ],
      "content": "Download <bpt id=\"p1\">[</bpt>Message Analyzer<ept id=\"p1\">](http://www.microsoft.com/download/details.aspx?id=44226)</ept> from the Microsoft Download Center, and run the installer."
    },
    {
      "content": "Launch Message Analyzer.",
      "pos": [
        19119,
        19143
      ]
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> page, navigate to <bpt id=\"p2\">**</bpt>Downloads<ept id=\"p2\">**</ept>, then filter on <bpt id=\"p3\">**</bpt>Azure Storage<ept id=\"p3\">**</ept>.",
      "pos": [
        19147,
        19230
      ]
    },
    {
      "content": "You will see the Azure Storage Assets, as shown in the picture below.",
      "pos": [
        19231,
        19300
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Sync All Displayed Items<ept id=\"p1\">**</ept> to install the Azure Storage Assets.",
      "pos": [
        19304,
        19375
      ]
    },
    {
      "content": "The available assets include:",
      "pos": [
        19376,
        19405
      ]
    },
    {
      "pos": [
        19413,
        19612
      ],
      "content": "<bpt id=\"p1\">**</bpt>Azure Storage Color Rules:<ept id=\"p1\">**</ept> Azure Storage color rules enable you to define special filters that use color, text, and font styles to highlight messages that contain specific information in a trace."
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Azure Storage Charts:<ept id=\"p1\">**</ept> Azure Storage charts are predefined charts that graph server log data.",
      "pos": [
        19619,
        19715
      ]
    },
    {
      "content": "Note that to use Azure Storage charts at this time, you may only load the server log into the Analysis Grid.",
      "pos": [
        19716,
        19824
      ]
    },
    {
      "pos": [
        19831,
        19984
      ],
      "content": "<bpt id=\"p1\">**</bpt>Azure Storage Parsers:<ept id=\"p1\">**</ept> The Azure Storage parsers parse the Azure Storage client, server, and HTTP logs in order to display them in the Analysis Grid."
    },
    {
      "pos": [
        19991,
        20121
      ],
      "content": "<bpt id=\"p1\">**</bpt>Azure Storage Filters:<ept id=\"p1\">**</ept> Azure Storage filters are predefined criteria that you can use to query your data in the Analysis Grid."
    },
    {
      "pos": [
        20128,
        20252
      ],
      "content": "<bpt id=\"p1\">**</bpt>Azure Storage View Layouts:<ept id=\"p1\">**</ept> Azure Storage view layouts are predefined column layouts and groupings in the Analysis Grid."
    },
    {
      "content": "Restart Message Analyzer after you've installed the assets.",
      "pos": [
        20256,
        20315
      ]
    },
    {
      "content": "Message Analyzer Start Page",
      "pos": [
        20319,
        20346
      ]
    },
    {
      "pos": [
        20409,
        20502
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> Install all of the Azure Storage assets shown for the purposes of this tutorial."
    },
    {
      "content": "Import your log files into Message Analyzer",
      "pos": [
        20508,
        20551
      ]
    },
    {
      "content": "You can import all of your saved log files (server-side, client-side, and network) into a single session in Microsoft Message Analyzer for analysis.",
      "pos": [
        20553,
        20701
      ]
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept> menu in Microsoft Message Analyzer, click <bpt id=\"p2\">**</bpt>New Session<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Blank Session<ept id=\"p3\">**</ept>.",
      "pos": [
        20706,
        20814
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>New Session<ept id=\"p1\">**</ept> dialog, enter a name for your analysis session.",
      "pos": [
        20815,
        20885
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Session Details<ept id=\"p1\">**</ept> panel, click on the <bpt id=\"p2\">**</bpt>Files<ept id=\"p2\">**</ept> button.",
      "pos": [
        20886,
        20950
      ]
    },
    {
      "pos": [
        20955,
        21169
      ],
      "content": "To load the network trace data generated by Message Analyzer, click on <bpt id=\"p1\">**</bpt>Add Files<ept id=\"p1\">**</ept>, browse to the location where you saved your .matp file from your web tracing session, select the .matp file, and click <bpt id=\"p2\">**</bpt>Open<ept id=\"p2\">**</ept>."
    },
    {
      "content": "To load the server-side log data, click on <bpt id=\"p1\">**</bpt>Add Files<ept id=\"p1\">**</ept>, browse to the location where you downloaded your server-side logs, select the log files for the time range you want to analyze, and click <bpt id=\"p2\">**</bpt>Open<ept id=\"p2\">**</ept>.",
      "pos": [
        21174,
        21379
      ]
    },
    {
      "content": "Then, in the <bpt id=\"p1\">**</bpt>Session Details<ept id=\"p1\">**</ept> panel, set the <bpt id=\"p2\">**</bpt>Text Log Configuration<ept id=\"p2\">**</ept> drop-down for each server-side log file to <bpt id=\"p3\">**</bpt>AzureStorageLog<ept id=\"p3\">**</ept> to ensure that Microsoft Message Analyzer can parse the log file correctly.",
      "pos": [
        21380,
        21593
      ]
    },
    {
      "content": "To load the client-side log data, click on <bpt id=\"p1\">**</bpt>Add Files<ept id=\"p1\">**</ept>, browse to the location where you saved your client-side logs, select the log files you want to analyze, and click <bpt id=\"p2\">**</bpt>Open<ept id=\"p2\">**</ept>.",
      "pos": [
        21597,
        21778
      ]
    },
    {
      "content": "Then, in the <bpt id=\"p1\">**</bpt>Session Details<ept id=\"p1\">**</ept> panel, set the <bpt id=\"p2\">**</bpt>Text Log Configuration<ept id=\"p2\">**</ept> drop-down for each client-side log file to <bpt id=\"p3\">**</bpt>AzureStorageClientDotNetV4<ept id=\"p3\">**</ept> to ensure that Microsoft Message Analyzer can parse the log file correctly.",
      "pos": [
        21779,
        22003
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> in the <bpt id=\"p2\">**</bpt>New Session<ept id=\"p2\">**</ept> dialog to load and parse the log data.",
      "pos": [
        22007,
        22084
      ]
    },
    {
      "content": "The log data displays in the Message Analyzer Analysis Grid.",
      "pos": [
        22085,
        22145
      ]
    },
    {
      "content": "The picture below shows an example session configured with server, client, and network trace log files.",
      "pos": [
        22147,
        22250
      ]
    },
    {
      "content": "Configure Message Analyzer Session",
      "pos": [
        22254,
        22288
      ]
    },
    {
      "content": "Note that Message Analyzer loads log files into memory.",
      "pos": [
        22356,
        22411
      ]
    },
    {
      "content": "If you have a large set of log data, you will want to filter it in order to get the best performance from Message Analyzer.",
      "pos": [
        22412,
        22535
      ]
    },
    {
      "content": "First, determine the time frame that you are interested in reviewing, and keep this time frame as small as possible.",
      "pos": [
        22537,
        22653
      ]
    },
    {
      "content": "In many cases you will want to review a period of minutes or hours at most.",
      "pos": [
        22654,
        22729
      ]
    },
    {
      "content": "Import the smallest set of logs that can meet your needs.",
      "pos": [
        22730,
        22787
      ]
    },
    {
      "content": "If you still have a large amount of log data, then you may want to specify a session filter to filter your log data before you load it.",
      "pos": [
        22789,
        22924
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Session Filter<ept id=\"p1\">**</ept> box, select the <bpt id=\"p2\">**</bpt>Library<ept id=\"p2\">**</ept> button to choose a predefined filter; for example, choose <bpt id=\"p3\">**</bpt>Global Time Filter I<ept id=\"p3\">**</ept> from the Azure Storage filters to filter on a time interval.",
      "pos": [
        22925,
        23122
      ]
    },
    {
      "content": "You can then edit the filter criteria to specify the starting and ending timestamp for the interval you want to see.",
      "pos": [
        23123,
        23239
      ]
    },
    {
      "content": "You can also filter on a particular status code; for example, you can choose to load only log entries where the status code is 404.",
      "pos": [
        23240,
        23371
      ]
    },
    {
      "pos": [
        23373,
        23545
      ],
      "content": "For more information about importing log data into Microsoft Message Analyzer, see <bpt id=\"p1\">[</bpt>Retrieving Message Data<ept id=\"p1\">](http://technet.microsoft.com/library/dn772437.aspx)</ept> on TechNet."
    },
    {
      "content": "Use the client request ID to correlate log file data",
      "pos": [
        23551,
        23603
      ]
    },
    {
      "content": "The Azure Storage Client Library automatically generates a unique client request ID for every request.",
      "pos": [
        23605,
        23707
      ]
    },
    {
      "content": "This value is written to the client log, the server log, and the network trace, so you can use it to correlate data across all three logs within Message Analyzer.",
      "pos": [
        23708,
        23870
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>Client request ID<ept id=\"p1\">](storage-monitoring-diagnosing-troubleshooting.md#client-request-id)</ept> for additional information about the client request ID.",
      "pos": [
        23871,
        24018
      ]
    },
    {
      "content": "The sections below describe how to use pre-configured and custom layout views to correlate and group data based on the client request ID.",
      "pos": [
        24020,
        24157
      ]
    },
    {
      "content": "Select a view layout to display in the Analysis Grid",
      "pos": [
        24163,
        24215
      ]
    },
    {
      "content": "The Storage Assets for Message Analyzer include Azure Storage View Layouts, which are pre-configured views that you can use to display your data with useful groupings and columns for different scenarios.",
      "pos": [
        24217,
        24420
      ]
    },
    {
      "content": "You can also create custom view layouts and save them for reuse.",
      "pos": [
        24421,
        24485
      ]
    },
    {
      "content": "The picture below shows the <bpt id=\"p1\">**</bpt>View Layout<ept id=\"p1\">**</ept> menu, available by selecting <bpt id=\"p2\">**</bpt>View Layout<ept id=\"p2\">**</ept> from the toolbar ribbon.",
      "pos": [
        24488,
        24601
      ]
    },
    {
      "content": "The view layouts for Azure Storage are grouped under the <bpt id=\"p1\">**</bpt>Azure Storage<ept id=\"p1\">**</ept> node in the menu.",
      "pos": [
        24602,
        24694
      ]
    },
    {
      "content": "You can search for <ph id=\"ph1\">`Azure Storage`</ph> in the search box to filter on Azure Storage view layouts only.",
      "pos": [
        24695,
        24793
      ]
    },
    {
      "content": "You can also select the star next to a view layout to make it a favorite and display it at the top of the menu.",
      "pos": [
        24794,
        24905
      ]
    },
    {
      "content": "View Layout menu",
      "pos": [
        24909,
        24925
      ]
    },
    {
      "content": "To begin with, select <bpt id=\"p1\">**</bpt>Grouped by ClientRequestID and Module<ept id=\"p1\">**</ept>.",
      "pos": [
        24986,
        25050
      ]
    },
    {
      "content": "This view layout groups log data from all three logs first by client request ID, then by source log file (or <bpt id=\"p1\">**</bpt>Module<ept id=\"p1\">**</ept> in Message Analyzer).",
      "pos": [
        25051,
        25192
      ]
    },
    {
      "content": "With this view, you can drill down into a particular client request ID, and see data from all three log files for that client request ID.",
      "pos": [
        25193,
        25330
      ]
    },
    {
      "content": "The picture below shows this layout view applied to the sample log data, with a subset of columns displayed.",
      "pos": [
        25332,
        25440
      ]
    },
    {
      "content": "You can see that for a particular client request ID, the Analysis Grid displays data from the client log, server log, and network trace.",
      "pos": [
        25441,
        25577
      ]
    },
    {
      "content": "Azure Storage View Layout",
      "pos": [
        25581,
        25606
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> Different log files have different columns, so when data from multiple log files is displayed in the Analysis Grid, some columns may not contain any data for a given row.",
      "pos": [
        25688,
        25871
      ]
    },
    {
      "content": "For example, in the picture above, the",
      "pos": [
        25872,
        25910
      ]
    },
    {
      "content": "client log rows do not show any data for the <bpt id=\"p1\">**</bpt>Timestamp<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>TimeElapsed<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Source<ept id=\"p3\">**</ept>, and <bpt id=\"p4\">**</bpt>Destination<ept id=\"p4\">**</ept> columns, because these columns do not exist in the client log, but do exist in the network trace.",
      "pos": [
        25912,
        26118
      ]
    },
    {
      "content": "Similarly, the <bpt id=\"p1\">**</bpt>Timestamp<ept id=\"p1\">**</ept> column displays timestamp data from the server log, but no data is displayed for the <bpt id=\"p2\">**</bpt>TimeElapsed<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Source<ept id=\"p3\">**</ept>, and <bpt id=\"p4\">**</bpt>Destination<ept id=\"p4\">**</ept> columns, which are not part of the server log.",
      "pos": [
        26119,
        26328
      ]
    },
    {
      "content": "In addition to using the Azure Storage view layouts, you can also define and save your own view layouts.",
      "pos": [
        26331,
        26435
      ]
    },
    {
      "content": "You can select other desired fields for grouping data and save the grouping as part of your custom layout as well.",
      "pos": [
        26436,
        26550
      ]
    },
    {
      "content": "Apply color rules to the Analysis Grid",
      "pos": [
        26557,
        26595
      ]
    },
    {
      "content": "The Storage Assets also include color rules, which offer a visual means to identify different types of errors in the Analysis Grid.",
      "pos": [
        26597,
        26728
      ]
    },
    {
      "content": "The predefined color rules apply to HTTP errors, so they appear only for the server log and network trace.",
      "pos": [
        26729,
        26835
      ]
    },
    {
      "content": "To apply color rules, select <bpt id=\"p1\">**</bpt>Color Rules<ept id=\"p1\">**</ept> from the toolbar ribbon.",
      "pos": [
        26837,
        26906
      ]
    },
    {
      "content": "You'll see the Azure Storage color rules in the menu.",
      "pos": [
        26907,
        26960
      ]
    },
    {
      "content": "For the tutorial, select <bpt id=\"p1\">**</bpt>Client Errors (StatusCode between 400 and 499)<ept id=\"p1\">**</ept>, as shown in the picture below.",
      "pos": [
        26961,
        27068
      ]
    },
    {
      "content": "Azure Storage View Layout",
      "pos": [
        27072,
        27097
      ]
    },
    {
      "content": "In addition to using the Azure Storage color rules, you can also define and save your own color rules.",
      "pos": [
        27158,
        27260
      ]
    },
    {
      "content": "Group and filter log data to find 400-range errors",
      "pos": [
        27266,
        27316
      ]
    },
    {
      "content": "Next, we'll group and filter the log data to find all errors in the 400 range.",
      "pos": [
        27318,
        27396
      ]
    },
    {
      "pos": [
        27401,
        27509
      ],
      "content": "Locate the <bpt id=\"p1\">**</bpt>StatusCode<ept id=\"p1\">**</ept> column in the Analysis Grid, right-click the column heading, and select <bpt id=\"p2\">**</bpt>Group<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Next, group on the <bpt id=\"p1\">**</bpt>ClientRequestId<ept id=\"p1\">**</ept> column.",
      "pos": [
        27513,
        27559
      ]
    },
    {
      "content": "You'll see that the data in the Analysis Grid is now organized by status code and by client request ID.",
      "pos": [
        27560,
        27663
      ]
    },
    {
      "content": "Display the View Filter tool window if it is not already displayed.",
      "pos": [
        27667,
        27734
      ]
    },
    {
      "content": "On the toolbar ribbon, select <bpt id=\"p1\">**</bpt>Tool Windows<ept id=\"p1\">**</ept>, then <bpt id=\"p2\">**</bpt>View Filter<ept id=\"p2\">**</ept>.",
      "pos": [
        27735,
        27804
      ]
    },
    {
      "pos": [
        27808,
        27950
      ],
      "content": "To filter the log data to display only 400-range errors, add the following filter criteria to the <bpt id=\"p1\">**</bpt>View Filter<ept id=\"p1\">**</ept> window, and click <bpt id=\"p2\">**</bpt>Apply<ept id=\"p2\">**</ept>:"
    },
    {
      "content": "The picture below shows the results of this grouping and filter.",
      "pos": [
        28087,
        28151
      ]
    },
    {
      "content": "Expanding the <bpt id=\"p1\">**</bpt>ClientRequestID<ept id=\"p1\">**</ept> field beneath the grouping for status code 409, for example, shows an operation that resulted in that status code.",
      "pos": [
        28152,
        28300
      ]
    },
    {
      "content": "Azure Storage View Layout",
      "pos": [
        28304,
        28329
      ]
    },
    {
      "content": "After applying this filter, you'll see that rows from the client log are excluded, as the client log does not include a <bpt id=\"p1\">**</bpt>StatusCode<ept id=\"p1\">**</ept> column.",
      "pos": [
        28391,
        28533
      ]
    },
    {
      "content": "To begin with, we'll review the server and network trace logs to locate 404 errors, and then we'll return to the client log to examine the client operations that led to them.",
      "pos": [
        28534,
        28708
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> You can filter on the <bpt id=\"p1\">**</bpt>StatusCode<ept id=\"p1\">**</ept> column and still display data from all three logs, including the client log, if you add an expression to the filter that includes log entries where the status code is null.",
      "pos": [
        28711,
        28933
      ]
    },
    {
      "content": "To construct this filter expression, use:",
      "pos": [
        28934,
        28975
      ]
    },
    {
      "content": "This filter returns all rows from the client log and only rows from the server log and HTTP log where the status code is greater than 400.",
      "pos": [
        29041,
        29179
      ]
    },
    {
      "content": "If you apply it to the view layout grouped by client request ID and module, you can search or scroll through the log entries to find ones where all three logs are represented.",
      "pos": [
        29180,
        29355
      ]
    },
    {
      "content": "Filter log data to find 404 errors",
      "pos": [
        29364,
        29398
      ]
    },
    {
      "content": "The Storage Assets include predefined filters that you can use to narrow log data to find the errors or trends you are looking for.",
      "pos": [
        29400,
        29531
      ]
    },
    {
      "content": "Next, we'll apply two predefined filters: one that filters the server and network trace logs for 404 errors, and one that filters the data on a specified time range.",
      "pos": [
        29532,
        29697
      ]
    },
    {
      "content": "Display the View Filter tool window if it is not already displayed.",
      "pos": [
        29702,
        29769
      ]
    },
    {
      "content": "On the toolbar ribbon, select <bpt id=\"p1\">**</bpt>Tool Windows<ept id=\"p1\">**</ept>, then <bpt id=\"p2\">**</bpt>View Filter<ept id=\"p2\">**</ept>.",
      "pos": [
        29770,
        29839
      ]
    },
    {
      "content": "In the View Filter window, select <bpt id=\"p1\">**</bpt>Library<ept id=\"p1\">**</ept>, and search on <ph id=\"ph1\">`Azure Storage`</ph> to find the Azure Storage filters.",
      "pos": [
        29843,
        29954
      ]
    },
    {
      "content": "Select the filter for <bpt id=\"p1\">**</bpt>404 (Not Found) messages in all logs<ept id=\"p1\">**</ept>.",
      "pos": [
        29955,
        30018
      ]
    },
    {
      "pos": [
        30022,
        30107
      ],
      "content": "Display the <bpt id=\"p1\">**</bpt>Library<ept id=\"p1\">**</ept> menu again, and locate and select the <bpt id=\"p2\">**</bpt>Global Time Filter<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Edit the timestamps shown in the filter to the range you wish to view.",
      "pos": [
        30111,
        30181
      ]
    },
    {
      "content": "This will help to narrow the range of data to analyze.",
      "pos": [
        30182,
        30236
      ]
    },
    {
      "content": "Your filter should appear similar to the example below.",
      "pos": [
        30240,
        30295
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Apply<ept id=\"p1\">**</ept> to apply the filter to the Analysis Grid.",
      "pos": [
        30296,
        30353
      ]
    },
    {
      "content": "Azure Storage View Layout",
      "pos": [
        30517,
        30542
      ]
    },
    {
      "content": "Analyze your log data",
      "pos": [
        30611,
        30632
      ]
    },
    {
      "content": "Now that you have grouped and filtered your data, you can examine the details of individual requests that generated 404 errors.",
      "pos": [
        30634,
        30761
      ]
    },
    {
      "content": "In the current view layout, the data is grouped by client request ID, then by log source.",
      "pos": [
        30762,
        30851
      ]
    },
    {
      "content": "Since we are filtering on requests where the StatusCode field contains 404, we'll see only the server and network trace data, not the client log data.",
      "pos": [
        30852,
        31002
      ]
    },
    {
      "content": "The picture below shows a specific request where a Get Blob operation yielded a 404 because the blob did not exist.",
      "pos": [
        31004,
        31119
      ]
    },
    {
      "content": "Note that some columns have been removed from the standard view in order to display the relevant data.",
      "pos": [
        31120,
        31222
      ]
    },
    {
      "content": "Filtered Server and Network Trace Logs",
      "pos": [
        31226,
        31264
      ]
    },
    {
      "content": "Next, we'll correlate this client request ID with the client log data to see what actions the client was taking when the error happened.",
      "pos": [
        31334,
        31470
      ]
    },
    {
      "content": "You can display a new Analysis Grid view for this session to view the client log data, which opens in a second tab:",
      "pos": [
        31471,
        31586
      ]
    },
    {
      "content": "First, copy the value of the <bpt id=\"p1\">**</bpt>ClientRequestId<ept id=\"p1\">**</ept> field to the clipboard.",
      "pos": [
        31591,
        31663
      ]
    },
    {
      "content": "You can do this by selecting either row, locating the <bpt id=\"p1\">**</bpt>ClientRequestId<ept id=\"p1\">**</ept> field, right-clicking on the data value, and choosing <bpt id=\"p2\">**</bpt>Copy 'ClientRequestId'<ept id=\"p2\">**</ept>.",
      "pos": [
        31664,
        31819
      ]
    },
    {
      "content": "On the toolbar ribbon, select <bpt id=\"p1\">**</bpt>New Viewer<ept id=\"p1\">**</ept>, then select <bpt id=\"p2\">**</bpt>Analysis Grid<ept id=\"p2\">**</ept> to open a new tab.",
      "pos": [
        31824,
        31918
      ]
    },
    {
      "content": "The new tab shows all data in your log files, without grouping, filtering, or color rules.",
      "pos": [
        31919,
        32009
      ]
    },
    {
      "content": "On the toolbar ribbon, select <bpt id=\"p1\">**</bpt>View Layout<ept id=\"p1\">**</ept>, then select <bpt id=\"p2\">**</bpt>All .NET Client Columns<ept id=\"p2\">**</ept> under the <bpt id=\"p3\">**</bpt>Azure Storage<ept id=\"p3\">**</ept> section.",
      "pos": [
        32014,
        32137
      ]
    },
    {
      "content": "This view layout shows data from the client log as well as the server and network trace logs.",
      "pos": [
        32138,
        32231
      ]
    },
    {
      "content": "By default it is sorted on the <bpt id=\"p1\">**</bpt>MessageNumber<ept id=\"p1\">**</ept> column.",
      "pos": [
        32232,
        32288
      ]
    },
    {
      "content": "Next, search the client log for the client request ID.",
      "pos": [
        32292,
        32346
      ]
    },
    {
      "content": "On the toolbar ribbon, select <bpt id=\"p1\">**</bpt>Find Messages<ept id=\"p1\">**</ept>, then specify a custom filter on the client request ID in the <bpt id=\"p2\">**</bpt>Find<ept id=\"p2\">**</ept> field.",
      "pos": [
        32347,
        32472
      ]
    },
    {
      "content": "Use this syntax for the filter, specifying your own client request ID:",
      "pos": [
        32473,
        32543
      ]
    },
    {
      "content": "Message Analyzer locates and selects the first log entry where the search criteria matches the client request ID.",
      "pos": [
        32613,
        32726
      ]
    },
    {
      "content": "In the client log, there are several entries for each client request ID, so you may want to group them on the <bpt id=\"p1\">**</bpt>ClientRequestId<ept id=\"p1\">**</ept> field to make it easier to see them all together.",
      "pos": [
        32727,
        32906
      ]
    },
    {
      "content": "The picture below shows all of the messages in the client log for the specified client request ID.",
      "pos": [
        32907,
        33005
      ]
    },
    {
      "content": "Client log showing 404 errors",
      "pos": [
        33010,
        33039
      ]
    },
    {
      "content": "Using the data shown in the view layouts in these two tabs, you can analyze the request data to determine what may have caused the error.",
      "pos": [
        33109,
        33246
      ]
    },
    {
      "content": "You can also look at requests that preceded this one to see if a previous event may have led to the 404 error.",
      "pos": [
        33247,
        33357
      ]
    },
    {
      "content": "For example, you can review the client log entries preceding this client request ID to determine whether the blob may have been deleted, or if the error was due to the client application calling a CreateIfNotExists API on a container or blob.",
      "pos": [
        33358,
        33600
      ]
    },
    {
      "content": "In the client log, you can find the blob's address in the <bpt id=\"p1\">**</bpt>Description<ept id=\"p1\">**</ept> field; in the server and network trace logs, this information appears in the <bpt id=\"p2\">**</bpt>Summary<ept id=\"p2\">**</ept> field.",
      "pos": [
        33601,
        33770
      ]
    },
    {
      "content": "Once you know the address of the blob that yielded the 404 error, you can investigate further.",
      "pos": [
        33772,
        33866
      ]
    },
    {
      "content": "If you search the log entries for other messages associated with operations on the same blob, you can check whether the client previously deleted the entity.",
      "pos": [
        33867,
        34024
      ]
    },
    {
      "content": "Analyze other types of storage errors",
      "pos": [
        34030,
        34067
      ]
    },
    {
      "content": "Now that you are familiar with using Message Analyzer to analyze your log data, you can analyze other types of errors using view layouts, color rules, and searching/filtering.",
      "pos": [
        34069,
        34244
      ]
    },
    {
      "content": "The tables below lists some issues you may encounter and the filter criteria you can use to locate them.",
      "pos": [
        34245,
        34349
      ]
    },
    {
      "content": "For more information on constructing filters and the Message Analyzer filtering language, see <bpt id=\"p1\">[</bpt>Filtering Message Data<ept id=\"p1\">](http://technet.microsoft.com/library/jj819365.aspx)</ept>.",
      "pos": [
        34350,
        34521
      ]
    },
    {
      "content": "To Investigate",
      "pos": [
        34528,
        34543
      ]
    },
    {
      "content": "Use Filter Expression",
      "pos": [
        34643,
        34665
      ]
    },
    {
      "content": "Expression Applies to Log (Client, Server,   Network, All)",
      "pos": [
        34902,
        34960
      ]
    },
    {
      "content": "Unexpected delays in message delivery on a queue",
      "pos": [
        35414,
        35462
      ]
    },
    {
      "content": "AzureStorageClientDotNetV4.Description   contains \"Retrying failed operation.\"",
      "pos": [
        35529,
        35607
      ]
    },
    {
      "content": "Client",
      "pos": [
        35788,
        35794
      ]
    },
    {
      "content": "HTTP Increase in PercentThrottlingError",
      "pos": [
        35857,
        35896
      ]
    },
    {
      "content": "HTTP.Response.StatusCode   == 500 &amp;#124;&amp;#124; HTTP.Response.StatusCode == 503",
      "pos": [
        35972,
        36050
      ]
    },
    {
      "content": "Network",
      "pos": [
        36241,
        36248
      ]
    },
    {
      "content": "Increase in PercentTimeoutError",
      "pos": [
        36310,
        36341
      ]
    },
    {
      "content": "HTTP.Response.StatusCode   == 500",
      "pos": [
        36425,
        36458
      ]
    },
    {
      "content": "Network",
      "pos": [
        36684,
        36691
      ]
    },
    {
      "content": "Increase in PercentTimeoutError (all)",
      "pos": [
        36753,
        36790
      ]
    },
    {
      "content": "*StatusCode   == 500",
      "pos": [
        36868,
        36888
      ]
    },
    {
      "content": "All",
      "pos": [
        37127,
        37130
      ]
    },
    {
      "content": "Increase in PercentNetworkError",
      "pos": [
        37196,
        37227
      ]
    },
    {
      "content": "AzureStorageClientDotNetV4.EventLogEntry.Level   &lt; 2",
      "pos": [
        37311,
        37363
      ]
    },
    {
      "content": "Client",
      "pos": [
        37570,
        37576
      ]
    },
    {
      "content": "HTTP 403 (Forbidden) messages",
      "pos": [
        37639,
        37668
      ]
    },
    {
      "content": "HTTP.Response.StatusCode   == 403",
      "pos": [
        37754,
        37787
      ]
    },
    {
      "content": "Network",
      "pos": [
        38013,
        38020
      ]
    },
    {
      "content": "HTTP 404 (Not found) messages",
      "pos": [
        38082,
        38111
      ]
    },
    {
      "content": "HTTP.Response.StatusCode   == 404",
      "pos": [
        38197,
        38230
      ]
    },
    {
      "content": "Network",
      "pos": [
        38456,
        38463
      ]
    },
    {
      "content": "404 (all)",
      "pos": [
        38525,
        38534
      ]
    },
    {
      "content": "*StatusCode   == 404",
      "pos": [
        38640,
        38660
      ]
    },
    {
      "content": "All",
      "pos": [
        38899,
        38902
      ]
    },
    {
      "content": "Shared Access Signature (SAS) authorization issue",
      "pos": [
        38968,
        39017
      ]
    },
    {
      "content": "AzureStorageLog.RequestStatus ==  \"SASAuthorizationError\"",
      "pos": [
        39083,
        39140
      ]
    },
    {
      "content": "Network",
      "pos": [
        39342,
        39349
      ]
    },
    {
      "content": "HTTP 409 (Conflict) messages",
      "pos": [
        39411,
        39439
      ]
    },
    {
      "content": "HTTP.Response.StatusCode   == 409",
      "pos": [
        39526,
        39559
      ]
    },
    {
      "content": "Network",
      "pos": [
        39785,
        39792
      ]
    },
    {
      "content": "409 (all)",
      "pos": [
        39854,
        39863
      ]
    },
    {
      "content": "*StatusCode   == 409",
      "pos": [
        39969,
        39989
      ]
    },
    {
      "content": "All",
      "pos": [
        40228,
        40231
      ]
    },
    {
      "content": "Low PercentSuccess or analytics log entries have   operations with transaction status of ClientOtherErrors",
      "pos": [
        40297,
        40403
      ]
    },
    {
      "content": "AzureStorageLog.RequestStatus ==   \"ClientOtherError\"",
      "pos": [
        40412,
        40465
      ]
    },
    {
      "content": "Server",
      "pos": [
        40671,
        40677
      ]
    },
    {
      "content": "Nagle   Warning",
      "pos": [
        40740,
        40755
      ]
    },
    {
      "content": "((AzureStorageLog.EndToEndLatencyMS   - AzureStorageLog.ServerLatencyMS) &gt; (AzureStorageLog.ServerLatencyMS *   1.5)) and (AzureStorageLog.RequestPacketSize &lt;1460) and (AzureStorageLog.EndToEndLatencyMS -   AzureStorageLog.ServerLatencyMS &gt;= 200)",
      "pos": [
        40855,
        41101
      ]
    },
    {
      "content": "Server",
      "pos": [
        41114,
        41120
      ]
    },
    {
      "content": "Range of   time in Server and Network logs",
      "pos": [
        41183,
        41225
      ]
    },
    {
      "content": "Timestamp   &gt;= 2014-10-20T16:36:38 and #Timestamp &lt;= 2014-10-20T16:36:39",
      "pos": [
        41299,
        41371
      ]
    },
    {
      "content": "Server, Network",
      "pos": [
        41557,
        41572
      ]
    },
    {
      "content": "Range of   time in Server logs",
      "pos": [
        41626,
        41656
      ]
    },
    {
      "content": "AzureStorageLog.Timestamp   &gt;= 2014-10-20T16:36:38 and AzureStorageLog.Timestamp &lt;=   2014-10-20T16:36:39",
      "pos": [
        41741,
        41846
      ]
    },
    {
      "content": "Server",
      "pos": [
        42000,
        42006
      ]
    },
    {
      "content": "Next steps",
      "pos": [
        42069,
        42079
      ]
    },
    {
      "content": "For more information about troubleshooting end-to-end scenarios in Azure Storage, see these resources:",
      "pos": [
        42081,
        42183
      ]
    },
    {
      "content": "Monitor, diagnose, and troubleshoot Storage",
      "pos": [
        42188,
        42231
      ]
    },
    {
      "content": "Storage Analytics",
      "pos": [
        42334,
        42351
      ]
    },
    {
      "content": "How to monitor a storage account",
      "pos": [
        42411,
        42443
      ]
    },
    {
      "content": "How to use AzCopy with Microsoft Azure Storage",
      "pos": [
        42484,
        42530
      ]
    },
    {
      "content": "Microsoft Message Analyzer Operating Guide",
      "pos": [
        42558,
        42600
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"End-to-End Troubleshooting using Azure Storage Metrics and Logging, AzCopy, and Message Analyzer | Microsoft Azure\" \n    description=\"A tutorial demonstrating end-to-end troubleshooting with Azure Storage Analytics, AzCopy, and Microsoft Message Analyzer\" \n    services=\"storage\" \n    documentationCenter=\"dotnet\" \n    authors=\"tamram\" \n    manager=\"adinah\"/>\n\n<tags \n    ms.service=\"storage\" \n    ms.workload=\"storage\" \n    ms.tgt_pltfrm=\"na\" \n    ms.devlang=\"dotnet\" \n    ms.topic=\"article\" \n    ms.date=\"06/22/2015\" \n    ms.author=\"tamram\"/>\n\n# End-to-End Troubleshooting using Azure Storage Metrics and Logging, AzCopy, and Message Analyzer \n\n## Overview\n\nDiagnosing and troubleshooting is a key skill for building and supporting client applications with Microsoft Azure Storage. Due to the distributed nature of an Azure application, diagnosing and troubleshooting errors and performance issues may be more complex than in traditional environments.\n\nIn this tutorial, we will demonstrate how to identify client certain errors that may affect performance, and troubleshoot those errors from end-to-end using tools provided by Microsoft and Azure Storage, in order to optimize the client application. \n\nThis tutorial provides a hands-on exploration of an end-to-end troubleshooting scenario. For an in-depth conceptual guide to troubleshooting Azure storage applications, see [Monitor, diagnose, and troubleshoot Storage](../articles/storage-monitoring-diagnosing-troubleshooting.md). \n\n## Tools for troubleshooting Azure Storage applications\n\nTo troubleshoot client applications using Microsoft Azure Storage, you can use a combination of tools to determine when an issue has occurred and what the cause of the problem may be. These tools include:\n\n- **Azure Storage Analytics**. [Azure Storage Analytics](http://msdn.microsoft.com/library/azure/hh343270.aspx) provides metrics and logging for Azure Storage.\n    - **Storage metrics** tracks transaction metrics and capacity metrics for your storage account. Using metrics, you can determine how your application is performing according to a variety of different measures. See [Storage Analytics Metrics Table Schema](http://msdn.microsoft.com/library/azure/hh343264.aspx) for more information about the types of metrics tracked by Storage Analytics. \n\n    - **Storage logging** logs each request to the Azure Storage services to a server-side log. The log tracks detailed data for each request, including the operation performed, the status of the operation, and latency information. See [Storage Analytics Log Format](http://msdn.microsoft.com/library/azure/hh343259.aspx) for more information about the request and response data that is written to the logs by Storage Analytics.\n\n- **The Azure Management Portal**. You can configure metrics and logging for your storage account in the portal. You can also view charts and graphs that show how your application is performing over time, and configure alerts in the portal to notify you if your application performs differently than expected for a specified metric. \n    \n    This tutorial shows how to monitor your storage account using the [Azure Management Portal](https://manage.windowsazure.com/). See [How to monitor a storage account](storage-monitor-storage-account.md) for information about configuring monitoring in the portal.\n\n    You can also use the [Azure Preview Portal](https://portal.azure.com/) for the latest experience, but note that it is still a preview release. \n\n- **AzCopy**. Server logs for Azure Storage are stored as blobs, so you can use AzCopy to copy the log blobs to a local directory for analysis using Microsoft Message Analyzer. See [How to use AzCopy with Microsoft Azure Storage](storage-use-azcopy.md) for more information about AzCopy.\n\n- **Microsoft Message Analyzer**. Message Analyzer is a tool that consumes log files and displays log data in a visual format that makes it easy to filter, search, and group log data into useful sets that you can use to analyze errors and performance issues. See [Microsoft Message Analyzer Operating Guide](http://technet.microsoft.com/library/jj649776.aspx) for more information about Message Analyzer.\n\n## About the sample scenario\n\nFor this tutorial, we'll examine a scenario where Azure Storage metrics indicates a low percent success rate for an application that calls Azure storage. The low percent success rate metric (shown as **PercentSuccess** in the Azure portal and in the metrics tables) tracks operations that succeed, but that return an HTTP status code that is greater than 299. In the server-side storage log files, these operations are recorded with a transaction status of **ClientOtherErrors**. For more details about the low percent success metric, see [Metrics show low PercentSuccess or analytics log entries have operations with transaction status of ClientOtherErrors](storage-monitoring-diagnosing-troubleshooting.md#metrics-show-low-percent-success).\n\nAzure Storage operations may return HTTP status codes greater than 299 as part of their normal functionality. But these errors in some cases indicate that you may be able to optimize your client application for improved performance. \n\nIn this scenario, we'll consider a low percent success rate to be anything below 100%. You can choose a different metric level, however, according to your needs. We recommend that during testing of your application, you establish a baseline tolerance for your key performance metrics. For example, you might determine, based on testing, that your application should have a consistent percent success rate of 90%, or 85%. If your metrics data shows that the application is deviating from that number, then you can investigate what may be causing the increase. \n\nFor our sample scenario, once we've established that the percent success rate metric is below 100%, we will examine the logs to find the errors that correlate to the metrics, and use them to figure out what is causing the lower percent success rate. We'll look specifically at errors in the 400 range. Then we'll more closely investigate 404 (Not Found) errors.\n\n### Some causes of 400-range errors\n\nThe examples below shows a sampling of some 400-range errors for requests against Azure Blob Storage, and their possible causes. Any of these errors, as well as errors in the 300 range and the 500 range, can contribute to a low percent success rate. \n\nNote that the lists below are far from complete. See [Status and Error Codes](http://msdn.microsoft.com/library/azure/dd179382.aspx) on MSDN for details about general Azure Storage errors and about errors specific to each of the storage services.\n\n**Status Code 404 (Not Found) Examples**\n\nOccurs when a read operation against a container or blob fails because the blob or container is not found.\n\n- Occurs if a container or blob has been deleted by another client before this request. \n- Occurs if you are using an API call that creates the container or blob after checking whether it exists. The CreateIfNotExists APIs make a HEAD call first to check for the existence of the container or blob; if it does not exist, a 404 error is returned, and then a second PUT call is made to write the container or blob.\n\n**Status Code 409 (Conflict) Examples**\n\n- Occurs if you use a Create API to create a new container or blob, without checking for existence first, and a container or blob with that name already exists. \n- Occurs if a container is being deleted, and you attempt to create a new container with the same name before the deletion operation is complete.\n- Occurs if you specify a lease on a container or blob, and there is already a lease present.\n \n**Status Code 412 (Precondition Failed) Examples**\n\n- Occurs when the condition specified by a conditional header has not been met.\n- Occurs when the lease ID specified does not match the lease ID on the container or blob.\n\n## Generate log files for analysis\n\nIn this tutorial, we'll use Message Analyzer to work with three different types of log files, although you could choose to work with any one of these:\n\n- The **server log**, which is created when you enable Azure Storage logging. The server log contains data about each operation called against one of the Azure Storage services - blob, queue, table, and file. The server log indicates which operation was called and what status code was returned, as well as other details about the request and response.\n- The **.NET client log**, which is created when you enable client-side logging from within your .NET application. The client log includes detailed information about how the client prepares the request and receives and processes the response. \n- The **HTTP network trace log**, which collects data on HTTP/HTTPS request and response data, including for operations against Azure Storage. In this tutorial, we'll generate the network trace via Message Analyzer.\n\n### Configure server-side logging and metrics\n\nFirst, we'll need to configure Azure Storage logging and metrics, so that we have data from the client application to analyze. You can configure logging and metrics in a variety of ways - via the Azure Management Portal, by using PowerShell, or programmatically. See [Enabling Storage Metrics and Viewing Metrics Data](http://msdn.microsoft.com/library/azure/dn782843.aspx) and [Enabling Storage Logging and Accessing Log Data](http://msdn.microsoft.com/library/azure/dn782840.aspx) on MSDN for details about configuring logging and metrics.\n\n**Via the Management Portal**\n\nTo configure logging and metrics for your storage account using the portal, follow the instructions at [How to monitor a storage account](storage-monitor-storage-account.md).\n\n> [AZURE.NOTE] It's not possible to set minute metrics using the Azure Management Portal. However, we recommend that you do set them for the purposes of this tutorial, and for investigating performance issues with your application. You can set minute metrics using PowerShell as shown below, or programmatically, or via the Azure Preview Portal.\n>\n> Note that the Azure Management Portal cannot display minute metrics, only hourly metrics. \n\n**Via PowerShell**\n\nTo get started with PowerShell for Azure, see [How to install and configure Azure PowerShell](../install-configure-powershell.md).\n\n1. Use the [Add-AzureAccount](http://msdn.microsoft.com/library/azure/dn722528.aspx) cmdlet to add your Azure user account to the PowerShell window:\n\n    ```\n    Add-AzureAccount\n    ```\n\n2. In the **Sign in to Microsoft Azure** window, type the email address and password associated with your account. Azure authenticates and saves the credential information, and then closes the window.\n3. Set the default storage account to the storage account you are using for the tutorial by executing these commands in the PowerShell window:\n\n    ```\n    $SubscriptionName = 'Your subscription name'\n    $StorageAccountName = 'yourstorageaccount' \n    Set-AzureSubscription -CurrentStorageAccountName $StorageAccountName -SubscriptionName $SubscriptionName \n    ```\n\n4. Enable storage logging for the Blob service: \n \n    ```\n    Set-AzureStorageServiceLoggingProperty -ServiceType Blob -LoggingOperations Read,Write,Delete -PassThru -RetentionDays 7 -Version 1.0 \n    ```\n5. Enable storage metrics for the Blob service, making sure to set **-MetricsType** to `Minute`:\n\n    ```\n    Set-AzureStorageServiceMetricsProperty -ServiceType Blob -MetricsType Minute -MetricsLevel ServiceAndApi -PassThru -RetentionDays 7 -Version 1.0 \n    ```\n\n### Configure .NET client-side logging\n\nTo configure client-side logging for a .NET application, enable .NET diagnostics in the application's configuration file (web.config or app.config). See [Client-side Logging using the Storage Client Library](http://msdn.microsoft.com/library/azure/dn782839.aspx) and [Client-side Logging with the Microsoft Azure Storage SDK for Java](http://msdn.microsoft.com/library/azure/dn782844.aspx) on MSDN for details.\n\nThe client-side log includes detailed information about how the client prepares the request and receives and processes the response.\n\nClient-side logging is configured within the app.config or web.config file in your application. For details, see [Client-side logging using the Storage Client Library](http://msdn.microsoft.com/library/azure/dn782839.aspx) on MSDN.\n\nThe Storage Client Library stores client-side log data in the location specified in the application's configuration file (web.config or app.config). \n\n### Collect a network trace\n\nYou can use Message Analyzer to collect an HTTP/HTTPS network trace while your client application is running. Message Analyzer uses [Fiddler](http://www.telerik.com/fiddler) on the back end. Before you collect the network trace, we recommend that you configure Fiddler to record unencrypted HTTPS traffic:\n\n1. Install [Fiddler](http://www.telerik.com/download/fiddler).\n2. Launch Fiddler.\n2. Select **Tools | Fiddler Options**.\n3. In the Options dialog, ensure that **Capture HTTPS CONNECTs** and **Decrypt HTTPS Traffic** are both selected, as shown below.\n\n![Configure Fiddler Options](./media/storage-e2e-troubleshooting/fiddler-options-1.png)\n\nFor the tutorial, collect and save a network trace first in Message Analyzer, then create an analysis session to analyze the trace and the logs. To collect a network trace in Message Analyzer:\n\n1. In Message Analyzer, select **File | Quick Trace | Unencrypted HTTPS**.\n2. The trace will begin immediately. Select **Stop** to stop the trace so that we can configure it to trace storage traffic only.\n3. Select **Edit** to edit the tracing session.\n4. Select the **Configure** link to the right of the **Microsoft-Pef-WebProxy** ETW provider.\n5. In the **Advanced Settings** dialog, click the **Provider** tab.\n6. In the **Hostname Filter** field, specify your storage endpoints, separated by spaces. For example, you can specify your endpoints as follows; change `storagesample` to the name of your storage account:\n    \n    ``` \n    storagesample.blob.core.windows.net storagesample.queue.core.windows.net storagesample.table.core.windows.net \n    ```\n\n7. Exit the dialog, and click **Restart** to begin collecting the trace with the hostname filter in place, so that only Azure Storage network traffic is included in the trace.\n\n>[AZURE.NOTE] After you have finished collecting your network trace, we strongly recommend that you revert the settings that you may have changed in Fiddler to decrypt HTTPS traffic. In the Fiddler Options dialog, deselect the **Capture HTTPS CONNECTs** and **Decrypt HTTPS Traffic** checkboxes.\n\nSee [Using the Network Tracing Features](http://technet.microsoft.com/library/jj674819.aspx) on Technet for more details.\n\n## Review metrics data in the portal\n\nOnce your application has been running for a period of time, you can review the metrics charts that appear in the portal to observe how your service has been performing. First, we'll add the **Success Percentage** metric to the Monitoring page:\n\n1. Navigate to the Dashboard for your storage account in the Management Portal, then select Monitor to view the monitoring page.\n2. Click **Add Metrics** to display the **Choose Metrics** dialog.\n3. Scroll down to find the **Success Percentage** group, expand it, then select **Aggregate**, as shown in the picture below. This metric aggregates success percentage data from all Blob operations.\n\n![Choose Metrics](./media/storage-e2e-troubleshooting/choose-metrics-portal-1.png)\n\nIn the portal, you'll now see **Success Percentage** in the monitoring chart, along with any other metrics you may have added (up to six can be displayed on the chart at once). In the picture below, you can see that the percent success rate is somewhat below 100%, which is the scenario we'll investigate next by analyzing the logs in Message Analyzer:\n\n![Metrics chart in portal](./media/storage-e2e-troubleshooting/portal-metrics-chart-1.png)\n\nFor more details on adding metrics to the Monitoring page, see [How to: Add metrics to the metrics table](storage-monitor-storage-account.md#addmonitoringmetrics).\n\n> [AZURE.NOTE] It may take some time for your metrics data to appear in the portal after you enable storage metrics. This is because hourly metrics for the previous hour are not displayed in the portal until the current hour has elapsed. Also, minute metrics are not currently displayed in the portal. So depending on when you enable metrics, it may take up to two hours to see metrics data.\n\n## Use AzCopy to copy server logs to a local directory\n\nAzure Storage writes server log data to blobs, while metrics are written to tables. Log blobs are available in the well-known `$logs` container for your storage account. Log blobs are named hierarchically by year, month, day, and hour, so that you can easily locate the range of time you wish to investigate. For example, in the `storagesample` account, the container for the log blobs for 01/02/2015, from 8-9 am, is `https://storagesample.blob.core.windows.net/$logs/blob/2015/01/08/0800`. The individual blobs in this container are named sequentially, beginning with `000000.log`.\n\nYou can use the AzCopy command-line tool to download these server-side log files to a location of your choice on your local machine. For example, you can use the following command to download the log files for blob operations that took place on January 2, 2015 to the folder `C:\\Temp\\Logs\\Server`; replace `<storageaccountname>` with the name of your storage account, and `<storageaccountkey>` with your account access key:\n\n    AzCopy.exe /Source:http://<storageaccountname>.blob.core.windows.net/$logs /Dest:C:\\Temp\\Logs\\Server /Pattern:\"blob/2015/01/02\" /SourceKey:<storageaccountkey> /S /V\n\nAzCopy is available for download on the [Azure Downloads](http://azure.microsoft.com/downloads/) page. For details about using AzCopy, see [How to use AzCopy with Microsoft Azure Storage](storage-use-azcopy.md).\n\nFor additional information about downloading server-side logs, see [Enabling Storage Logging and Accessing Log Data](http://msdn.microsoft.com/library/azure/dn782840.aspx#DownloadingStorageLogginglogdata). \n\n## Use Microsoft Message Analyzer to analyze log data\n\nMicrosoft Message Analyzer is a tool for capturing, displaying, and analyzing protocol messaging traffic, events, and other system or application messages in troubleshooting and diagnostic scenarios. Message Analyzer also enables you to load, aggregate, and analyze data from log and saved trace files. For more information about Message Analyzer, see [Microsoft Message Analyzer Operating Guide](http://technet.microsoft.com/library/jj649776.aspx).\n\nMessage Analyzer includes assets for Azure Storage that help you to analyze server, client, and network logs. In this section, we'll discuss how to use those tools to address the issue of low percent success in the storage logs.\n\n### Download and install Message Analyzer and the Azure Storage Assets\n\n1. Download [Message Analyzer](http://www.microsoft.com/download/details.aspx?id=44226) from the Microsoft Download Center, and run the installer.\n2. Launch Message Analyzer.\n3. On the **Start** page, navigate to **Downloads**, then filter on **Azure Storage**. You will see the Azure Storage Assets, as shown in the picture below.\n4. Click **Sync All Displayed Items** to install the Azure Storage Assets. The available assets include: \n    - **Azure Storage Color Rules:** Azure Storage color rules enable you to define special filters that use color, text, and font styles to highlight messages that contain specific information in a trace.\n    - **Azure Storage Charts:** Azure Storage charts are predefined charts that graph server log data. Note that to use Azure Storage charts at this time, you may only load the server log into the Analysis Grid.\n    - **Azure Storage Parsers:** The Azure Storage parsers parse the Azure Storage client, server, and HTTP logs in order to display them in the Analysis Grid.\n    - **Azure Storage Filters:** Azure Storage filters are predefined criteria that you can use to query your data in the Analysis Grid.\n    - **Azure Storage View Layouts:** Azure Storage view layouts are predefined column layouts and groupings in the Analysis Grid.\n4. Restart Message Analyzer after you've installed the assets.\n\n![Message Analyzer Start Page](./media/storage-e2e-troubleshooting/mma-start-page-1.png)\n\n> [AZURE.NOTE] Install all of the Azure Storage assets shown for the purposes of this tutorial.\n\n### Import your log files into Message Analyzer\n\nYou can import all of your saved log files (server-side, client-side, and network) into a single session in Microsoft Message Analyzer for analysis.\n\n1. On the **File** menu in Microsoft Message Analyzer, click **New Session**, and then click **Blank Session**. In the **New Session** dialog, enter a name for your analysis session. In the **Session Details** panel, click on the **Files** button. \n1. To load the network trace data generated by Message Analyzer, click on **Add Files**, browse to the location where you saved your .matp file from your web tracing session, select the .matp file, and click **Open**. \n1. To load the server-side log data, click on **Add Files**, browse to the location where you downloaded your server-side logs, select the log files for the time range you want to analyze, and click **Open**. Then, in the **Session Details** panel, set the **Text Log Configuration** drop-down for each server-side log file to **AzureStorageLog** to ensure that Microsoft Message Analyzer can parse the log file correctly.\n1. To load the client-side log data, click on **Add Files**, browse to the location where you saved your client-side logs, select the log files you want to analyze, and click **Open**. Then, in the **Session Details** panel, set the **Text Log Configuration** drop-down for each client-side log file to **AzureStorageClientDotNetV4** to ensure that Microsoft Message Analyzer can parse the log file correctly.\n1. Click **Start** in the **New Session** dialog to load and parse the log data. The log data displays in the Message Analyzer Analysis Grid.\n\nThe picture below shows an example session configured with server, client, and network trace log files.\n\n![Configure Message Analyzer Session](./media/storage-e2e-troubleshooting/configure-mma-session-1.png)\n\nNote that Message Analyzer loads log files into memory. If you have a large set of log data, you will want to filter it in order to get the best performance from Message Analyzer.\n\nFirst, determine the time frame that you are interested in reviewing, and keep this time frame as small as possible. In many cases you will want to review a period of minutes or hours at most. Import the smallest set of logs that can meet your needs.\n\nIf you still have a large amount of log data, then you may want to specify a session filter to filter your log data before you load it. In the **Session Filter** box, select the **Library** button to choose a predefined filter; for example, choose **Global Time Filter I** from the Azure Storage filters to filter on a time interval. You can then edit the filter criteria to specify the starting and ending timestamp for the interval you want to see. You can also filter on a particular status code; for example, you can choose to load only log entries where the status code is 404.\n\nFor more information about importing log data into Microsoft Message Analyzer, see [Retrieving Message Data](http://technet.microsoft.com/library/dn772437.aspx) on TechNet.\n\n### Use the client request ID to correlate log file data\n\nThe Azure Storage Client Library automatically generates a unique client request ID for every request. This value is written to the client log, the server log, and the network trace, so you can use it to correlate data across all three logs within Message Analyzer. See [Client request ID](storage-monitoring-diagnosing-troubleshooting.md#client-request-id) for additional information about the client request ID.\n\nThe sections below describe how to use pre-configured and custom layout views to correlate and group data based on the client request ID.\n\n### Select a view layout to display in the Analysis Grid\n\nThe Storage Assets for Message Analyzer include Azure Storage View Layouts, which are pre-configured views that you can use to display your data with useful groupings and columns for different scenarios. You can also create custom view layouts and save them for reuse. \n\nThe picture below shows the **View Layout** menu, available by selecting **View Layout** from the toolbar ribbon. The view layouts for Azure Storage are grouped under the **Azure Storage** node in the menu. You can search for `Azure Storage` in the search box to filter on Azure Storage view layouts only. You can also select the star next to a view layout to make it a favorite and display it at the top of the menu.\n\n![View Layout menu](./media/storage-e2e-troubleshooting/view-layout-menu.png)\n\nTo begin with, select **Grouped by ClientRequestID and Module**. This view layout groups log data from all three logs first by client request ID, then by source log file (or **Module** in Message Analyzer). With this view, you can drill down into a particular client request ID, and see data from all three log files for that client request ID.\n\nThe picture below shows this layout view applied to the sample log data, with a subset of columns displayed. You can see that for a particular client request ID, the Analysis Grid displays data from the client log, server log, and network trace.\n\n![Azure Storage View Layout](./media/storage-e2e-troubleshooting/view-layout-client-request-id-module.png)\n\n>[AZURE.NOTE] Different log files have different columns, so when data from multiple log files is displayed in the Analysis Grid, some columns may not contain any data for a given row. For example, in the picture above, the \nclient log rows do not show any data for the **Timestamp**, **TimeElapsed**, **Source**, and **Destination** columns, because these columns do not exist in the client log, but do exist in the network trace. Similarly, the **Timestamp** column displays timestamp data from the server log, but no data is displayed for the **TimeElapsed**, **Source**, and **Destination** columns, which are not part of the server log. \n\nIn addition to using the Azure Storage view layouts, you can also define and save your own view layouts. You can select other desired fields for grouping data and save the grouping as part of your custom layout as well. \n\n### Apply color rules to the Analysis Grid\n\nThe Storage Assets also include color rules, which offer a visual means to identify different types of errors in the Analysis Grid. The predefined color rules apply to HTTP errors, so they appear only for the server log and network trace.\n\nTo apply color rules, select **Color Rules** from the toolbar ribbon. You'll see the Azure Storage color rules in the menu. For the tutorial, select **Client Errors (StatusCode between 400 and 499)**, as shown in the picture below.\n\n![Azure Storage View Layout](./media/storage-e2e-troubleshooting/color-rules-menu.png)\n\nIn addition to using the Azure Storage color rules, you can also define and save your own color rules.\n\n### Group and filter log data to find 400-range errors\n\nNext, we'll group and filter the log data to find all errors in the 400 range.\n\n1. Locate the **StatusCode** column in the Analysis Grid, right-click the column heading, and select **Group**.\n2. Next, group on the **ClientRequestId** column. You'll see that the data in the Analysis Grid is now organized by status code and by client request ID.\n1. Display the View Filter tool window if it is not already displayed. On the toolbar ribbon, select **Tool Windows**, then **View Filter**.\n2. To filter the log data to display only 400-range errors, add the following filter criteria to the **View Filter** window, and click **Apply**:\n\n        (AzureStorageLog.StatusCode >= 400 && AzureStorageLog.StatusCode <=499) || (HTTP.StatusCode >= 400 && HTTP.StatusCode <= 499)\n\nThe picture below shows the results of this grouping and filter. Expanding the **ClientRequestID** field beneath the grouping for status code 409, for example, shows an operation that resulted in that status code.\n\n![Azure Storage View Layout](./media/storage-e2e-troubleshooting/400-range-errors1.png)\n\nAfter applying this filter, you'll see that rows from the client log are excluded, as the client log does not include a **StatusCode** column. To begin with, we'll review the server and network trace logs to locate 404 errors, and then we'll return to the client log to examine the client operations that led to them.\n\n>[AZURE.NOTE] You can filter on the **StatusCode** column and still display data from all three logs, including the client log, if you add an expression to the filter that includes log entries where the status code is null. To construct this filter expression, use:\n>\n> <code>&#42;StatusCode >= 400 or !&#42;StatusCode</code> \n>\n> This filter returns all rows from the client log and only rows from the server log and HTTP log where the status code is greater than 400. If you apply it to the view layout grouped by client request ID and module, you can search or scroll through the log entries to find ones where all three logs are represented.   \n\n### Filter log data to find 404 errors\n\nThe Storage Assets include predefined filters that you can use to narrow log data to find the errors or trends you are looking for. Next, we'll apply two predefined filters: one that filters the server and network trace logs for 404 errors, and one that filters the data on a specified time range.\n\n1. Display the View Filter tool window if it is not already displayed. On the toolbar ribbon, select **Tool Windows**, then **View Filter**.\n2. In the View Filter window, select **Library**, and search on `Azure Storage` to find the Azure Storage filters. Select the filter for **404 (Not Found) messages in all logs**.\n3. Display the **Library** menu again, and locate and select the **Global Time Filter**.\n4. Edit the timestamps shown in the filter to the range you wish to view. This will help to narrow the range of data to analyze.\n5. Your filter should appear similar to the example below. Click **Apply** to apply the filter to the Analysis Grid.\n\n        ((AzureStorageLog.StatusCode == 404 || HTTP.StatusCode == 404)) And \n        (#Timestamp >= 2014-10-20T16:36:38 and #Timestamp <= 2014-10-20T16:36:39)\n\n![Azure Storage View Layout](./media/storage-e2e-troubleshooting/404-filtered-errors1.png)\n\n### Analyze your log data\n\nNow that you have grouped and filtered your data, you can examine the details of individual requests that generated 404 errors. In the current view layout, the data is grouped by client request ID, then by log source. Since we are filtering on requests where the StatusCode field contains 404, we'll see only the server and network trace data, not the client log data.\n\nThe picture below shows a specific request where a Get Blob operation yielded a 404 because the blob did not exist. Note that some columns have been removed from the standard view in order to display the relevant data.\n\n![Filtered Server and Network Trace Logs](./media/storage-e2e-troubleshooting/server-filtered-404-error.png)\n\nNext, we'll correlate this client request ID with the client log data to see what actions the client was taking when the error happened. You can display a new Analysis Grid view for this session to view the client log data, which opens in a second tab:\n\n1. First, copy the value of the **ClientRequestId** field to the clipboard. You can do this by selecting either row, locating the **ClientRequestId** field, right-clicking on the data value, and choosing **Copy 'ClientRequestId'**. \n1. On the toolbar ribbon, select **New Viewer**, then select **Analysis Grid** to open a new tab. The new tab shows all data in your log files, without grouping, filtering, or color rules. \n2. On the toolbar ribbon, select **View Layout**, then select **All .NET Client Columns** under the **Azure Storage** section. This view layout shows data from the client log as well as the server and network trace logs. By default it is sorted on the **MessageNumber** column.\n3. Next, search the client log for the client request ID. On the toolbar ribbon, select **Find Messages**, then specify a custom filter on the client request ID in the **Find** field. Use this syntax for the filter, specifying your own client request ID:\n\n        *ClientRequestId == \"398bac41-7725-484b-8a69-2a9e48fc669a\"\n\nMessage Analyzer locates and selects the first log entry where the search criteria matches the client request ID. In the client log, there are several entries for each client request ID, so you may want to group them on the **ClientRequestId** field to make it easier to see them all together. The picture below shows all of the messages in the client log for the specified client request ID. \n\n![Client log showing 404 errors](./media/storage-e2e-troubleshooting/client-log-analysis-grid1.png)\n\nUsing the data shown in the view layouts in these two tabs, you can analyze the request data to determine what may have caused the error. You can also look at requests that preceded this one to see if a previous event may have led to the 404 error. For example, you can review the client log entries preceding this client request ID to determine whether the blob may have been deleted, or if the error was due to the client application calling a CreateIfNotExists API on a container or blob. In the client log, you can find the blob's address in the **Description** field; in the server and network trace logs, this information appears in the **Summary** field.\n\nOnce you know the address of the blob that yielded the 404 error, you can investigate further. If you search the log entries for other messages associated with operations on the same blob, you can check whether the client previously deleted the entity. \n\n## Analyze other types of storage errors\n\nNow that you are familiar with using Message Analyzer to analyze your log data, you can analyze other types of errors using view layouts, color rules, and searching/filtering. The tables below lists some issues you may encounter and the filter criteria you can use to locate them. For more information on constructing filters and the Message Analyzer filtering language, see [Filtering Message Data](http://technet.microsoft.com/library/jj819365.aspx).\n\n|    To Investigate                                                                                               |    Use Filter Expression                                                                                                                                                                                                                                        |    Expression Applies to Log (Client, Server,   Network, All)    |\n|------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|\n|    Unexpected delays in message delivery on a queue                                                              |    AzureStorageClientDotNetV4.Description   contains \"Retrying failed operation.\"                                                                                                                                                                                |    Client                                                        |\n|    HTTP Increase in PercentThrottlingError                                                                       |    HTTP.Response.StatusCode   == 500 &#124;&#124; HTTP.Response.StatusCode == 503                                                                                                                                                                                          |    Network                                                       |\n|    Increase in PercentTimeoutError                                                                               |    HTTP.Response.StatusCode   == 500                                                                                                                                                                                                                             |    Network                                                       |\n|    Increase in PercentTimeoutError (all)                                                                         |    *StatusCode   == 500                                                                                                                                                                                                                                          |    All                                                           |\n|    Increase in PercentNetworkError                                                                               |    AzureStorageClientDotNetV4.EventLogEntry.Level   < 2                                                                                                                                                                                                          |    Client                                                        |\n|    HTTP 403 (Forbidden) messages                                                                                 |    HTTP.Response.StatusCode   == 403                                                                                                                                                                                                                             |    Network                                                       |\n|    HTTP 404 (Not found) messages                                                                                 |    HTTP.Response.StatusCode   == 404                                                                                                                                                                                                                             |    Network                                                       |\n|    404 (all)                                                                                                     |    *StatusCode   == 404                                                                                                                                                                                                                                          |    All                                                           |\n|    Shared Access Signature (SAS) authorization issue                                                             |    AzureStorageLog.RequestStatus ==  \"SASAuthorizationError\"                                                                                                                                                                                                     |    Network                                                       |\n|    HTTP 409 (Conflict) messages                                                                                  |    HTTP.Response.StatusCode   == 409                                                                                                                                                                                                                             |    Network                                                       |\n|    409 (all)                                                                                                     |    *StatusCode   == 409                                                                                                                                                                                                                                          |    All                                                           |\n|    Low PercentSuccess or analytics log entries have   operations with transaction status of ClientOtherErrors    |    AzureStorageLog.RequestStatus ==   \"ClientOtherError\"                                                                                                                                                                                                         |    Server                                                        |\n|    Nagle   Warning                                                                                               |    ((AzureStorageLog.EndToEndLatencyMS   - AzureStorageLog.ServerLatencyMS) > (AzureStorageLog.ServerLatencyMS *   1.5)) and (AzureStorageLog.RequestPacketSize <1460) and (AzureStorageLog.EndToEndLatencyMS -   AzureStorageLog.ServerLatencyMS >= 200)        |    Server                                                        |\n|    Range of   time in Server and Network logs                                                                    |    #Timestamp   >= 2014-10-20T16:36:38 and #Timestamp <= 2014-10-20T16:36:39                                                                                                                                                                                     |    Server, Network                                               |\n|    Range of   time in Server logs                                                                                |    AzureStorageLog.Timestamp   >= 2014-10-20T16:36:38 and AzureStorageLog.Timestamp <=   2014-10-20T16:36:39                                                                                                                                                     |    Server                                                        |\n\n\n## Next steps\n\nFor more information about troubleshooting end-to-end scenarios in Azure Storage, see these resources:\n\n- [Monitor, diagnose, and troubleshoot Storage](http://azure.microsoft.com/documentation/articles/storage-monitoring-diagnosing-troubleshooting/)\n- [Storage Analytics](http://msdn.microsoft.com/library/azure/hh343270.aspx)\n- [How to monitor a storage account](storage-monitor-storage-account.md)\n- [How to use AzCopy with Microsoft Azure Storage](storage-use-azcopy.md)\n- [Microsoft Message Analyzer Operating Guide](http://technet.microsoft.com/library/jj649776.aspx)\n \n \n"
}