{
  "nodes": [
    {
      "content": "Add push notifications to your Mobile Services app (Xamarin.iOS) - Mobile Services",
      "pos": [
        27,
        109
      ]
    },
    {
      "content": "Learn how to use push notifications in Xamarin.iOS apps with Azure Mobile Services.",
      "pos": [
        128,
        211
      ]
    },
    {
      "content": "Add push notifications to your Mobile Services app",
      "pos": [
        542,
        592
      ]
    },
    {
      "content": "Overview",
      "pos": [
        718,
        726
      ]
    },
    {
      "content": "This topic shows you how to use Azure Mobile Services to send push notifications to a Xamarin.iOS 8 app.",
      "pos": [
        728,
        832
      ]
    },
    {
      "content": "In this tutorial you add push notifications using the Apple Push Notification service (APNS) to the <bpt id=\"p1\">[</bpt><ept id=\"p1\">Get started with Mobile Services]</ept> project.",
      "pos": [
        833,
        976
      ]
    },
    {
      "content": "When complete, your mobile service will send a push notification each time a record is inserted.",
      "pos": [
        977,
        1073
      ]
    },
    {
      "content": "This tutorial requires the following:",
      "pos": [
        1075,
        1112
      ]
    },
    {
      "content": "An iOS 8 device (you cannot test push notifications in the iOS Simulator)",
      "pos": [
        1116,
        1189
      ]
    },
    {
      "content": "iOS Developer Program membership",
      "pos": [
        1192,
        1224
      ]
    },
    {
      "content": "Xamarin.iOS Studio",
      "pos": [
        1228,
        1246
      ]
    },
    {
      "content": "Azure Mobile Services Component",
      "pos": [
        1251,
        1282
      ]
    },
    {
      "pos": [
        1286,
        1447
      ],
      "content": "<ph id=\"ph1\">[AZURE.IMPORTANT]</ph> Because of APNS requirements, you must deploy and test push notifications on an iOS capable device (iPhone or iPad) instead of in the emulator."
    },
    {
      "content": "APNS uses certificates to authenticate your mobile service.",
      "pos": [
        1449,
        1508
      ]
    },
    {
      "content": "Follow these instructions to create the necessary certificates and upload it to your Mobile Service.",
      "pos": [
        1509,
        1609
      ]
    },
    {
      "content": "For the official APNS feature documentation, see <bpt id=\"p1\">[</bpt><ept id=\"p1\">Apple Push Notification Service]</ept>.",
      "pos": [
        1610,
        1693
      ]
    },
    {
      "pos": [
        1698,
        1770
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"certificates\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Generate the Certificate Signing Request file"
    },
    {
      "content": "First you must generate the Certificate Signing Request (CSR) file, which is used by Apple to generate a signed certificate.",
      "pos": [
        1772,
        1896
      ]
    },
    {
      "pos": [
        1901,
        1950
      ],
      "content": "From Utilities, run the <bpt id=\"p1\">**</bpt>Keychain Access tool<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        1955,
        2085
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Keychain Access<ept id=\"p1\">**</ept>, expand <bpt id=\"p2\">**</bpt>Certificate Assistant<ept id=\"p2\">**</ept>, then click <bpt id=\"p3\">**</bpt>Request a Certificate from a Certificate Authority...<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        2102,
        2244
      ],
      "content": "Enter your <bpt id=\"p1\">**</bpt>User Email Address<ept id=\"p1\">**</ept>, type in a <bpt id=\"p2\">**</bpt>Common Name<ept id=\"p2\">**</ept> value, make sure that <bpt id=\"p3\">**</bpt>Saved to disk<ept id=\"p3\">**</ept> is selected, and then click <bpt id=\"p4\">**</bpt>Continue<ept id=\"p4\">**</ept>."
    },
    {
      "pos": [
        2261,
        2390
      ],
      "content": "Type a name for the Certificate Signing Request (CSR) file in <bpt id=\"p1\">**</bpt>Save As<ept id=\"p1\">**</ept>, select the location in <bpt id=\"p2\">**</bpt>Where<ept id=\"p2\">**</ept>, then click <bpt id=\"p3\">**</bpt>Save<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Remember the location you chose.",
      "pos": [
        2408,
        2440
      ]
    },
    {
      "content": "Next, you will register your app with Apple, enable push notifications, and upload this exported CSR to create a push certificate.",
      "pos": [
        2442,
        2572
      ]
    },
    {
      "pos": [
        2577,
        2640
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"register\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Register your app for push notifications"
    },
    {
      "content": "To be able to send push notifications to an iOS app from mobile services, you must register your application with Apple and register for push notifications.",
      "pos": [
        2642,
        2798
      ]
    },
    {
      "pos": [
        2803,
        3140
      ],
      "content": "If you have not already registered your app, navigate to the <ph id=\"ph1\">&lt;a href=\"http://go.microsoft.com/fwlink/p/?LinkId=272456\" target=\"_blank\"&gt;</ph>iOS Provisioning Portal<ph id=\"ph2\">&lt;/a&gt;</ph> at the Apple Developer Center, log on with your Apple ID, click <bpt id=\"p1\">**</bpt>Identifiers<ept id=\"p1\">**</ept>, then click <bpt id=\"p2\">**</bpt>App IDs<ept id=\"p2\">**</ept>, and finally click on the <bpt id=\"p3\">**</bpt>+<ept id=\"p3\">**</ept> sign to create an app ID for your app."
    },
    {
      "content": "Type a name for your app in <bpt id=\"p1\">**</bpt>Description<ept id=\"p1\">**</ept>, enter and remember the unique <bpt id=\"p2\">**</bpt>Bundle Identifier<ept id=\"p2\">**</ept>, check the \"Push Notifications\" option in the \"App Services\" section, and then click <bpt id=\"p3\">**</bpt>Continue<ept id=\"p3\">**</ept>.",
      "pos": [
        3159,
        3354
      ]
    },
    {
      "content": "This example uses the ID <bpt id=\"p1\">**</bpt>MobileServices.Quickstart<ept id=\"p1\">**</ept> but you may not reuse this same ID, as app IDs must be unique across all users.",
      "pos": [
        3355,
        3489
      ]
    },
    {
      "content": "As such, it is recommended that you append your full name or initials after the app name.",
      "pos": [
        3490,
        3579
      ]
    },
    {
      "content": "This generates your app ID and requests you to <bpt id=\"p1\">**</bpt>Submit<ept id=\"p1\">**</ept> the information.",
      "pos": [
        3599,
        3673
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Submit<ept id=\"p1\">**</ept>.",
      "pos": [
        3674,
        3691
      ]
    },
    {
      "content": "Once you click <bpt id=\"p1\">**</bpt>Submit<ept id=\"p1\">**</ept>, you will see the <bpt id=\"p2\">**</bpt>Registration complete<ept id=\"p2\">**</ept> screen, as shown below.",
      "pos": [
        3711,
        3804
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Done<ept id=\"p1\">**</ept>.",
      "pos": [
        3805,
        3820
      ]
    },
    {
      "content": "Locate the app ID that you just created, and click on its row.",
      "pos": [
        3839,
        3901
      ]
    },
    {
      "content": "Clicking on the app ID will display details on the app and app ID.",
      "pos": [
        3921,
        3987
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>Settings<ept id=\"p1\">**</ept> button.",
      "pos": [
        3988,
        4018
      ]
    },
    {
      "pos": [
        4037,
        4175
      ],
      "content": "Scroll to the bottom of the screen, and click the <bpt id=\"p1\">**</bpt>Create Certificate...<ept id=\"p1\">**</ept> button under the section <bpt id=\"p2\">**</bpt>Development Push SSL Certificate<ept id=\"p2\">**</ept>."
    },
    {
      "content": "This displays the \"Add iOS Certificate\" assistant.",
      "pos": [
        4195,
        4245
      ]
    },
    {
      "content": "Note: This tutorial uses a development certificate.",
      "pos": [
        4251,
        4302
      ]
    },
    {
      "content": "The same process is used when registering a production certificate.",
      "pos": [
        4303,
        4370
      ]
    },
    {
      "content": "Just make sure that you set the same certificate type when you upload the certificate to Mobile Services.",
      "pos": [
        4371,
        4476
      ]
    },
    {
      "pos": [
        4481,
        4589
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Choose File<ept id=\"p1\">**</ept>, browse to the location where you saved the CSR file earlier, then click <bpt id=\"p2\">**</bpt>Generate<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        4608,
        4706
      ],
      "content": "After the certificate is created by the portal, click the <bpt id=\"p1\">**</bpt>Download<ept id=\"p1\">**</ept> button, and click <bpt id=\"p2\">**</bpt>Done<ept id=\"p2\">**</ept>."
    },
    {
      "content": "This downloads the signing certificate and saves it to your computer in your Downloads folder.",
      "pos": [
        4728,
        4822
      ]
    },
    {
      "pos": [
        4840,
        4950
      ],
      "content": "Note: By default, the downloaded file a development certificate is named <ph id=\"ph1\">&lt;strong&gt;</ph>aps_development.cer<ph id=\"ph2\">&lt;/strong&gt;</ph>."
    },
    {
      "pos": [
        4955,
        5024
      ],
      "content": "Double-click the downloaded push certificate <bpt id=\"p1\">**</bpt>aps_development.cer<ept id=\"p1\">**</ept>."
    },
    {
      "content": "This installs the new certificate in the Keychain, as shown below:",
      "pos": [
        5030,
        5096
      ]
    },
    {
      "pos": [
        5115,
        5266
      ],
      "content": "Note: The name in your certificate might be different, but it will be prefixed with <ph id=\"ph1\">&lt;strong&gt;</ph>Apple Development iOS Push Notification Services:<ph id=\"ph2\">&lt;/strong&gt;</ph>."
    },
    {
      "content": "Later, you will use this certificate to generate a .p12 file and upload it to Mobile Services to enable authentication with APNS.",
      "pos": [
        5268,
        5397
      ]
    },
    {
      "pos": [
        5402,
        5465
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"profile\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Create a provisioning profile for the app"
    },
    {
      "content": "Back in the <ph id=\"ph1\">&lt;a href=\"http://go.microsoft.com/fwlink/p/?LinkId=272456\" target=\"_blank\"&gt;</ph>iOS Provisioning Portal<ph id=\"ph2\">&lt;/a&gt;</ph>, select <bpt id=\"p1\">**</bpt>Provisioning Profiles<ept id=\"p1\">**</ept>, select <bpt id=\"p2\">**</bpt>All<ept id=\"p2\">**</ept>, and then click the <bpt id=\"p3\">**</bpt>+<ept id=\"p3\">**</ept> button to create a new profile.",
      "pos": [
        5470,
        5691
      ]
    },
    {
      "content": "This launches the <bpt id=\"p1\">**</bpt>Add iOS Provisiong Profile<ept id=\"p1\">**</ept> Wizard.",
      "pos": [
        5692,
        5748
      ]
    },
    {
      "pos": [
        5767,
        5875
      ],
      "content": "Select <bpt id=\"p1\">**</bpt>iOS App Development<ept id=\"p1\">**</ept> under <bpt id=\"p2\">**</bpt>Development<ept id=\"p2\">**</ept> as the provisiong profile type, and click <bpt id=\"p3\">**</bpt>Continue<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        5880,
        6002
      ],
      "content": "Next, select the app ID for the Mobile Services Quickstart app from the <bpt id=\"p1\">**</bpt>App ID<ept id=\"p1\">**</ept> drop-down list, and click <bpt id=\"p2\">**</bpt>Continue<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        6021,
        6123
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Select certificates<ept id=\"p1\">**</ept> screen, select the certificate created earlier, and click <bpt id=\"p2\">**</bpt>Continue<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        6142,
        6214
      ],
      "content": "Next, select the <bpt id=\"p1\">**</bpt>Devices<ept id=\"p1\">**</ept> to use for testing, and click <bpt id=\"p2\">**</bpt>Continue<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        6233,
        6330
      ],
      "content": "Finally, pick a name for the profile in <bpt id=\"p1\">**</bpt>Profile Name<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>Generate<ept id=\"p2\">**</ept>, and click <bpt id=\"p3\">**</bpt>Done<ept id=\"p3\">**</ept>."
    },
    {
      "content": "This creates a new provisioning profile.",
      "pos": [
        6350,
        6390
      ]
    },
    {
      "pos": [
        6409,
        6495
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"configure-mobileServices\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Configure Mobile Services to send push requests"
    },
    {
      "content": "After you have registered your app with APNS and configured your project, you must next configure your mobile service to integrate with APNS.",
      "pos": [
        6497,
        6638
      ]
    },
    {
      "pos": [
        6643,
        6778
      ],
      "content": "In Keychain Access, right-click the new certificate, click <bpt id=\"p1\">**</bpt>Export<ept id=\"p1\">**</ept>, name your file, select the <bpt id=\"p2\">**</bpt>.p12<ept id=\"p2\">**</ept> format, then click <bpt id=\"p3\">**</bpt>Save<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Make a note of the file name and location of the exported certificate.",
      "pos": [
        6797,
        6867
      ]
    },
    {
      "pos": [
        6872,
        6964
      ],
      "content": "Log on to the <bpt id=\"p1\">[</bpt><ept id=\"p1\">Azure Management Portal]</ept>, click <bpt id=\"p2\">**</bpt>Mobile Services<ept id=\"p2\">**</ept>, and then click your app."
    },
    {
      "pos": [
        6982,
        7069
      ],
      "content": "Click the <bpt id=\"p1\">**</bpt>Push<ept id=\"p1\">**</ept> tab and click <bpt id=\"p2\">**</bpt>Upload<ept id=\"p2\">**</ept> under <bpt id=\"p3\">**</bpt>apple push notification settings<ept id=\"p3\">**</ept>."
    },
    {
      "content": "This displays the Upload Certificate dialog.",
      "pos": [
        7088,
        7132
      ]
    },
    {
      "pos": [
        7137,
        7311
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept>, select the exported certificate .p12 file, enter the <bpt id=\"p2\">**</bpt>Password<ept id=\"p2\">**</ept>, make sure that the correct <bpt id=\"p3\">**</bpt>Mode<ept id=\"p3\">**</ept> is selected, click the check icon, then click <bpt id=\"p4\">**</bpt>Save<ept id=\"p4\">**</ept>."
    },
    {
      "content": "Your mobile service is now configured to work with APNS.",
      "pos": [
        7326,
        7382
      ]
    },
    {
      "pos": [
        7387,
        7453
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"configure-app\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Configure your Xamarin.iOS application"
    },
    {
      "pos": [
        7458,
        7567
      ],
      "content": "In Xamarin.Studio, open <bpt id=\"p1\">**</bpt>Info.plist<ept id=\"p1\">**</ept>, and update the <bpt id=\"p2\">**</bpt>Bundle Identifier<ept id=\"p2\">**</ept> with the ID you created earlier."
    },
    {
      "pos": [
        7586,
        7705
      ],
      "content": "Scroll down to <bpt id=\"p1\">**</bpt>Background Modes<ept id=\"p1\">**</ept> and check the <bpt id=\"p2\">**</bpt>Enable Background Modes<ept id=\"p2\">**</ept> box and the <bpt id=\"p3\">**</bpt>Remote notifications<ept id=\"p3\">**</ept> box."
    },
    {
      "pos": [
        7724,
        7800
      ],
      "content": "Double click your project in the Solution Panel to open <bpt id=\"p1\">**</bpt>Project Options<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        7806,
        7961
      ],
      "content": "Choose <bpt id=\"p1\">**</bpt>iOS Bundle Signing<ept id=\"p1\">**</ept> under <bpt id=\"p2\">**</bpt>Build<ept id=\"p2\">**</ept>, and select the corresponding <bpt id=\"p3\">**</bpt>Identity<ept id=\"p3\">**</ept> and <bpt id=\"p4\">**</bpt>Provisioning profile<ept id=\"p4\">**</ept> you had just set up for this project."
    },
    {
      "content": "This ensures that the Xamarin project uses the new profile for code signing.",
      "pos": [
        7981,
        8057
      ]
    },
    {
      "content": "For the official Xamarin device provisioning documentation, see <bpt id=\"p1\">[</bpt><ept id=\"p1\">Xamarin Device Provisioning]</ept>.",
      "pos": [
        8058,
        8152
      ]
    },
    {
      "pos": [
        8157,
        8214
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"add-push\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Add push notifications to your app"
    },
    {
      "content": "In Xamarin.Studio, open the AppDelegate.cs file and add the following property:",
      "pos": [
        8219,
        8298
      ]
    },
    {
      "pos": [
        8352,
        8411
      ],
      "content": "Open the <bpt id=\"p1\">**</bpt>TodoItem<ept id=\"p1\">**</ept> class and add the following property:"
    },
    {
      "pos": [
        8518,
        8587
      ],
      "content": "In <bpt id=\"p1\">**</bpt>QSTodoService<ept id=\"p1\">**</ept>, override the existing client declaration to be:"
    },
    {
      "pos": [
        8657,
        8766
      ],
      "content": "Then add the following method so <bpt id=\"p1\">**</bpt>AppDelegate<ept id=\"p1\">**</ept> can acquire the client later to register push notifications:"
    },
    {
      "pos": [
        8891,
        8952
      ],
      "content": "In <bpt id=\"p1\">**</bpt>AppDelegate<ept id=\"p1\">**</ept>, override the <bpt id=\"p2\">**</bpt>FinishedLaunching<ept id=\"p2\">**</ept> event:"
    },
    {
      "pos": [
        9561,
        9637
      ],
      "content": "In <bpt id=\"p1\">**</bpt>AppDelegate<ept id=\"p1\">**</ept>, override the <bpt id=\"p2\">**</bpt>RegisteredForRemoteNotifications<ept id=\"p2\">**</ept> event:"
    },
    {
      "pos": [
        10283,
        10353
      ],
      "content": "In <bpt id=\"p1\">**</bpt>AppDelegate<ept id=\"p1\">**</ept>, override the <bpt id=\"p2\">**</bpt>ReceivedRemoteNotification<ept id=\"p2\">**</ept> event:"
    },
    {
      "pos": [
        10865,
        11023
      ],
      "content": "In <bpt id=\"p1\">**</bpt>TodoListViewController<ept id=\"p1\">**</ept>, modify the <bpt id=\"p2\">**</bpt>OnAdd<ept id=\"p2\">**</ept> action to get the device token stored in <bpt id=\"p3\">**</bpt>AppDelegeate<ept id=\"p3\">**</ept>, and store it into the <bpt id=\"p4\">**</bpt>TodoItem<ept id=\"p4\">**</ept> being added."
    },
    {
      "content": "Your app is now updated to support push notifications.",
      "pos": [
        11285,
        11339
      ]
    },
    {
      "pos": [
        11344,
        11433
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"update-scripts\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Update the registered insert script in the Management Portal"
    },
    {
      "pos": [
        11438,
        11525
      ],
      "content": "In the Management Portal, click the <bpt id=\"p1\">**</bpt>Data<ept id=\"p1\">**</ept> tab and then click the <bpt id=\"p2\">**</bpt>TodoItem<ept id=\"p2\">**</ept> table."
    },
    {
      "pos": [
        11543,
        11607
      ],
      "content": "In <bpt id=\"p1\">**</bpt>todoitem<ept id=\"p1\">**</ept>, click the <bpt id=\"p2\">**</bpt>Script<ept id=\"p2\">**</ept> tab and select <bpt id=\"p3\">**</bpt>Insert<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        11626,
        11717
      ],
      "content": "This displays the function that is invoked when an insert occurs in the <bpt id=\"p1\">**</bpt>TodoItem<ept id=\"p1\">**</ept> table."
    },
    {
      "pos": [
        11722,
        11799
      ],
      "content": "Replace the insert function with the following code, and then click <bpt id=\"p1\">**</bpt>Save<ept id=\"p1\">**</ept>:"
    },
    {
      "pos": [
        12365,
        12523
      ],
      "content": "This registers a new insert script, which uses the <bpt id=\"p1\">[</bpt><ept id=\"p1\">apns object]</ept> to send a push notification (the inserted text) to the device provided in the insert request."
    },
    {
      "pos": [
        12529,
        12652
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> This script delays sending the notification to give you time to close the app to receive a toast notification."
    },
    {
      "pos": [
        12657,
        12711
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"test\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Test push notifications in your app"
    },
    {
      "pos": [
        12716,
        12852
      ],
      "content": "Press the <bpt id=\"p1\">**</bpt>Run<ept id=\"p1\">**</ept> button to build the project and start the app in an iOS capable device, then click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept> to accept push notifications"
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> You must explicitly accept push notifications from your app.",
      "pos": [
        12871,
        12944
      ]
    },
    {
      "content": "This request only occurs the first time that the app runs.",
      "pos": [
        12945,
        13003
      ]
    },
    {
      "pos": [
        13008,
        13116
      ],
      "content": "In the app, type meaningful text, such as <bpt id=\"p1\">_</bpt>A new Mobile Services task<ept id=\"p1\">_</ept> and then click the plus (<bpt id=\"p2\">**</bpt>+<ept id=\"p2\">**</ept>) icon."
    },
    {
      "pos": [
        13134,
        13220
      ],
      "content": "Verify that a notification is received, then click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept> to dismiss the notification."
    },
    {
      "content": "Repeat step 2 and immediately close the app, then verify that the following toast is shown.",
      "pos": [
        13238,
        13329
      ]
    },
    {
      "content": "You have successfully completed this tutorial.",
      "pos": [
        13344,
        13390
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"Add push notifications to your Mobile Services app (Xamarin.iOS) - Mobile Services\"\n    description=\"Learn how to use push notifications in Xamarin.iOS apps with Azure Mobile Services.\"\n    documentationCenter=\"xamarin\"\n    authors=\"ysxu\"\n    manager=\"dwrede\"\n    services=\"mobile-services\"\n    editor=\"\"/>\n\n<tags\n    ms.service=\"mobile-services\"\n    ms.workload=\"mobile\"\n    ms.tgt_pltfrm=\"mobile-xamarin-ios\"\n    ms.devlang=\"objective-c\"\n    ms.topic=\"article\"\n    ms.date=\"08/18/2015\"\n    ms.author=\"yuaxu\"/>\n\n# Add push notifications to your Mobile Services app\n\n[AZURE.INCLUDE [mobile-services-selector-get-started-push](../../includes/mobile-services-selector-get-started-push.md)]\n\n##Overview\n\nThis topic shows you how to use Azure Mobile Services to send push notifications to a Xamarin.iOS 8 app. In this tutorial you add push notifications using the Apple Push Notification service (APNS) to the [Get started with Mobile Services] project. When complete, your mobile service will send a push notification each time a record is inserted.\n\nThis tutorial requires the following:\n\n+ An iOS 8 device (you cannot test push notifications in the iOS Simulator)\n+ iOS Developer Program membership\n+ [Xamarin.iOS Studio]\n+ [Azure Mobile Services Component]\n\n>[AZURE.IMPORTANT] Because of APNS requirements, you must deploy and test push notifications on an iOS capable device (iPhone or iPad) instead of in the emulator.\n\nAPNS uses certificates to authenticate your mobile service. Follow these instructions to create the necessary certificates and upload it to your Mobile Service. For the official APNS feature documentation, see [Apple Push Notification Service].\n\n## <a name=\"certificates\"></a>Generate the Certificate Signing Request file\n\nFirst you must generate the Certificate Signing Request (CSR) file, which is used by Apple to generate a signed certificate.\n\n1. From Utilities, run the **Keychain Access tool**.\n\n2. Click **Keychain Access**, expand **Certificate Assistant**, then click **Request a Certificate from a Certificate Authority...**.\n\n    ![][5]\n\n3. Enter your **User Email Address**, type in a **Common Name** value, make sure that **Saved to disk** is selected, and then click **Continue**.\n\n    ![][6]\n\n4. Type a name for the Certificate Signing Request (CSR) file in **Save As**, select the location in **Where**, then click **Save**.\n\n    ![][7]\n\n    Remember the location you chose.\n\nNext, you will register your app with Apple, enable push notifications, and upload this exported CSR to create a push certificate.\n\n## <a name=\"register\"></a>Register your app for push notifications\n\nTo be able to send push notifications to an iOS app from mobile services, you must register your application with Apple and register for push notifications.\n\n1. If you have not already registered your app, navigate to the <a href=\"http://go.microsoft.com/fwlink/p/?LinkId=272456\" target=\"_blank\">iOS Provisioning Portal</a> at the Apple Developer Center, log on with your Apple ID, click **Identifiers**, then click **App IDs**, and finally click on the **+** sign to create an app ID for your app.\n\n    ![][102]\n\n2. Type a name for your app in **Description**, enter and remember the unique **Bundle Identifier**, check the \"Push Notifications\" option in the \"App Services\" section, and then click **Continue**. This example uses the ID **MobileServices.Quickstart** but you may not reuse this same ID, as app IDs must be unique across all users. As such, it is recommended that you append your full name or initials after the app name.\n\n    ![][103]\n\n    This generates your app ID and requests you to **Submit** the information. Click **Submit**.\n\n    ![][104]\n\n    Once you click **Submit**, you will see the **Registration complete** screen, as shown below. Click **Done**.\n\n    ![][105]\n\n3. Locate the app ID that you just created, and click on its row.\n\n    ![][106]\n\n    Clicking on the app ID will display details on the app and app ID. Click the **Settings** button.\n\n    ![][107]\n\n4. Scroll to the bottom of the screen, and click the **Create Certificate...** button under the section **Development Push SSL Certificate**.\n\n    ![][108]\n\n    This displays the \"Add iOS Certificate\" assistant.\n\n    Note: This tutorial uses a development certificate. The same process is used when registering a production certificate. Just make sure that you set the same certificate type when you upload the certificate to Mobile Services.\n\n5. Click **Choose File**, browse to the location where you saved the CSR file earlier, then click **Generate**.\n\n    ![][110]\n\n6. After the certificate is created by the portal, click the **Download** button, and click **Done**.\n\n    ![][111]  \n\n    This downloads the signing certificate and saves it to your computer in your Downloads folder.\n\n    ![][9]\n\n    Note: By default, the downloaded file a development certificate is named <strong>aps_development.cer</strong>.\n\n7. Double-click the downloaded push certificate **aps_development.cer**.\n\n    This installs the new certificate in the Keychain, as shown below:\n\n    ![][10]\n\n    Note: The name in your certificate might be different, but it will be prefixed with <strong>Apple Development iOS Push Notification Services:</strong>.\n\nLater, you will use this certificate to generate a .p12 file and upload it to Mobile Services to enable authentication with APNS.\n\n## <a name=\"profile\"></a>Create a provisioning profile for the app\n\n1. Back in the <a href=\"http://go.microsoft.com/fwlink/p/?LinkId=272456\" target=\"_blank\">iOS Provisioning Portal</a>, select **Provisioning Profiles**, select **All**, and then click the **+** button to create a new profile. This launches the **Add iOS Provisiong Profile** Wizard.\n\n    ![][112]\n\n2. Select **iOS App Development** under **Development** as the provisiong profile type, and click **Continue**.\n\n3. Next, select the app ID for the Mobile Services Quickstart app from the **App ID** drop-down list, and click **Continue**.\n\n    ![][113]\n\n4. In the **Select certificates** screen, select the certificate created earlier, and click **Continue**.\n\n    ![][114]\n\n5. Next, select the **Devices** to use for testing, and click **Continue**.\n\n    ![][115]\n\n6. Finally, pick a name for the profile in **Profile Name**, click **Generate**, and click **Done**.\n\n    ![][116]\n\n    This creates a new provisioning profile.\n\n    ![][117]\n\n## <a name=\"configure-mobileServices\"></a>Configure Mobile Services to send push requests\n\nAfter you have registered your app with APNS and configured your project, you must next configure your mobile service to integrate with APNS.\n\n1. In Keychain Access, right-click the new certificate, click **Export**, name your file, select the **.p12** format, then click **Save**.\n\n    ![][28]\n\n    Make a note of the file name and location of the exported certificate.\n\n2. Log on to the [Azure Management Portal], click **Mobile Services**, and then click your app.\n\n    ![][18]\n\n3. Click the **Push** tab and click **Upload** under **apple push notification settings**.\n\n    ![][19]\n\n    This displays the Upload Certificate dialog.\n\n4. Click **File**, select the exported certificate .p12 file, enter the **Password**, make sure that the correct **Mode** is selected, click the check icon, then click **Save**.\n\n    ![][20]\n\nYour mobile service is now configured to work with APNS.\n\n## <a name=\"configure-app\"></a>Configure your Xamarin.iOS application\n\n1. In Xamarin.Studio, open **Info.plist**, and update the **Bundle Identifier** with the ID you created earlier.\n\n    ![][121]\n\n2. Scroll down to **Background Modes** and check the **Enable Background Modes** box and the **Remote notifications** box.\n\n    ![][122]\n\n3. Double click your project in the Solution Panel to open **Project Options**.\n\n4.  Choose **iOS Bundle Signing** under **Build**, and select the corresponding **Identity** and **Provisioning profile** you had just set up for this project.\n\n    ![][120]\n\n    This ensures that the Xamarin project uses the new profile for code signing. For the official Xamarin device provisioning documentation, see [Xamarin Device Provisioning].\n\n## <a name=\"add-push\"></a>Add push notifications to your app\n\n1. In Xamarin.Studio, open the AppDelegate.cs file and add the following property:\n\n        public string DeviceToken { get; set; }\n\n2. Open the **TodoItem** class and add the following property:\n\n        [JsonProperty(PropertyName = \"deviceToken\")]\n        public string DeviceToken { get; set; }\n\n3. In **QSTodoService**, override the existing client declaration to be:\n\n        public MobileServiceClient client { get; private set; }\n\n4. Then add the following method so **AppDelegate** can acquire the client later to register push notifications:\n\n        public MobileServiceClient GetClient {\n            get{\n                return client;\n            }\n        }\n\n5. In **AppDelegate**, override the **FinishedLaunching** event:\n\n        public override bool FinishedLaunching(UIApplication application, NSDictionary launchOptions)\n        {\n            // registers for push for iOS8\n            var settings = UIUserNotificationSettings.GetSettingsForTypes(\n                UIUserNotificationType.Alert\n                | UIUserNotificationType.Badge\n                | UIUserNotificationType.Sound,\n                new NSSet());\n\n            UIApplication.SharedApplication.RegisterUserNotificationSettings(settings);\n            UIApplication.SharedApplication.RegisterForRemoteNotifications();\n\n            return true;\n        }\n\n6. In **AppDelegate**, override the **RegisteredForRemoteNotifications** event:\n\n        public override void RegisteredForRemoteNotifications(UIApplication application, NSData deviceToken)\n        {\n            // Modify device token\n            DeviceToken = deviceToken.Description;\n            DeviceToken = DeviceToken.Trim ('<', '>').Replace (\" \", \"\");\n\n            // Get Mobile Services client\n            MobileServiceClient client = QSTodoService.DefaultService.GetClient;\n\n            // Register for push with Mobile Services\n            IEnumerable<string> tag = new List<string>() { \"uniqueTag\" };\n            var push = client.GetPush ();\n            push.RegisterNativeAsync (DeviceToken, tag);\n        }\n\n7. In **AppDelegate**, override the **ReceivedRemoteNotification** event:\n\n        public override void ReceivedRemoteNotification(UIApplication application, NSDictionary userInfo)\n        {\n            Debug.WriteLine(userInfo.ToString());\n            NSObject inAppMessage;\n\n            bool success = userInfo.TryGetValue(new NSString(\"inAppMessage\"), out inAppMessage);\n\n            if (success)\n            {\n                var alert = new UIAlertView(\"Got push notification\", inAppMessage.ToString(), null, \"OK\", null);\n                alert.Show();\n            }\n        }\n\n8. In **TodoListViewController**, modify the **OnAdd** action to get the device token stored in **AppDelegeate**, and store it into the **TodoItem** being added.\n\n        string deviceToken = ((AppDelegate)UIApplication.SharedApplication.Delegate).DeviceToken;\n\n        var newItem = new TodoItem()\n        {\n            Text = itemText.Text,\n            Complete = false,\n            DeviceToken = deviceToken\n        };\n\nYour app is now updated to support push notifications.\n\n## <a name=\"update-scripts\"></a>Update the registered insert script in the Management Portal\n\n1. In the Management Portal, click the **Data** tab and then click the **TodoItem** table.\n\n    ![][21]\n\n2. In **todoitem**, click the **Script** tab and select **Insert**.\n\n    ![][22]\n\n    This displays the function that is invoked when an insert occurs in the **TodoItem** table.\n\n3. Replace the insert function with the following code, and then click **Save**:\n\n        function insert(item, user, request) {\n            request.execute();\n            // Set timeout to delay the notification, to provide time for the\n            // app to be closed on the device to demonstrate toast notifications\n            setTimeout(function() {\n                push.apns.send(\"uniqueTag\", {\n                    alert: \"Toast: \" + item.text,\n                    payload: {\n                        inAppMessage: \"Hey, a new item arrived: '\" + item.text + \"'\"\n                    }\n                });\n            }, 2500);\n        }\n\n    This registers a new insert script, which uses the [apns object] to send a push notification (the inserted text) to the device provided in the insert request.\n\n   >[AZURE.NOTE] This script delays sending the notification to give you time to close the app to receive a toast notification.\n\n## <a name=\"test\"></a>Test push notifications in your app\n\n1. Press the **Run** button to build the project and start the app in an iOS capable device, then click **OK** to accept push notifications\n\n    ![][23]\n\n   >[AZURE.NOTE] You must explicitly accept push notifications from your app. This request only occurs the first time that the app runs.\n\n2. In the app, type meaningful text, such as _A new Mobile Services task_ and then click the plus (**+**) icon.\n\n    ![][24]\n\n3. Verify that a notification is received, then click **OK** to dismiss the notification.\n\n    ![][25]\n\n4. Repeat step 2 and immediately close the app, then verify that the following toast is shown.\n\n    ![][26]\n\nYou have successfully completed this tutorial.\n\n<!-- Anchors. -->\n[Generate the certificate signing request]: #certificates\n[Register your app and enable push notifications]: #register\n[Create a provisioning profile for the app]: #profile\n[Configure Mobile Services]: #configure-mobileServices\n[Configure the Xamarin.iOS App]: #configure-app\n[Update scripts to send push notifications]: #update-scripts\n[Add push notifications to the app]: #add-push\n[Insert data to receive notifications]: #test\n\n<!-- Images. -->\n\n[5]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-step5.png\n[6]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-step6.png\n[7]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-step7.png\n\n[9]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-step9.png\n[10]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-step10.png\n\n[17]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-step17.png\n[18]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-selection.png\n[19]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-push-tab-ios.png\n[20]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-push-tab-ios-upload.png\n[21]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-portal-data-tables.png\n[22]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-insert-script-push2.png\n[23]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-quickstart-push1-ios.png\n[24]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-quickstart-push2-ios.png\n[25]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-quickstart-push3-ios.png\n[26]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-quickstart-push4-ios.png\n[28]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-step18.png\n\n[101]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-01.png\n[102]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-02.png\n[103]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-03.png\n[104]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-04.png\n[105]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-05.png\n[106]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-06.png\n[107]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-07.png\n[108]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-08.png\n\n[110]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-10.png\n[111]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-11.png\n[112]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-12.png\n[113]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-13.png\n[114]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-14.png\n[115]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-15.png\n[116]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-16.png\n[117]: ./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-17.png\n\n[120]:./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-20.png\n[121]:./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-21.png\n[122]:./media/partner-xamarin-mobile-services-ios-get-started-push/mobile-services-ios-push-22.png\n\n[Xamarin.iOS Studio]: http://xamarin.com/platform\n[Install Xcode]: https://go.microsoft.com/fwLink/p/?LinkID=266532\n[iOS Provisioning Portal]: http://go.microsoft.com/fwlink/p/?LinkId=272456\n[Mobile Services iOS SDK]: https://go.microsoft.com/fwLink/p/?LinkID=266533\n[Apple Push Notification Service]: http://go.microsoft.com/fwlink/p/?LinkId=272584\n[Get started with Mobile Services]: mobile-services-ios-get-started.md\n\n[Xamarin Device Provisioning]: http://developer.xamarin.com/guides/ios/getting_started/installation/device_provisioning/\n\n\n[Azure Management Portal]: https://manage.windowsazure.com/\n[apns object]: http://go.microsoft.com/fwlink/p/?LinkId=272333\n[Azure Mobile Services Component]: http://components.xamarin.com/view/azure-mobile-services/\n[completed example project]: http://go.microsoft.com/fwlink/p/?LinkId=331303\n[Xamarin.iOS]: http://xamarin.com/download\n"
}