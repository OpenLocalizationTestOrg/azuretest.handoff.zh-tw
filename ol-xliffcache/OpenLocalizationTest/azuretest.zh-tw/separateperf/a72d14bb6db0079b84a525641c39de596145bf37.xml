{
  "nodes": [
    {
      "content": "Create an ASP.NET MVC app with auth and SQL DB and deploy to Azure App Service",
      "pos": [
        28,
        106
      ]
    },
    {
      "content": "Learn how to develop an ASP.NET MVC 5 app with a SQL Database back-end, add authentication and authorization, and deploy it to Azure.",
      "pos": [
        126,
        259
      ]
    },
    {
      "content": "Create an ASP.NET MVC app with auth and SQL DB and deploy to Azure App Service",
      "pos": [
        618,
        696
      ]
    },
    {
      "content": "This tutorial shows you how to build a secure ASP.NET MVC 5 web app that enables users to log in with credentials from Facebook or Google.",
      "pos": [
        698,
        836
      ]
    },
    {
      "content": "You will also deploy the application to <bpt id=\"p1\">[</bpt>App Service<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=529714)</ept>.",
      "pos": [
        837,
        938
      ]
    },
    {
      "content": "You can open an Azure account for free, and if you don't already have Visual Studio 2013, the SDK automatically installs Visual Studio 2013 for Web Express.",
      "pos": [
        940,
        1096
      ]
    },
    {
      "content": "You can start developing for Azure for free.",
      "pos": [
        1097,
        1141
      ]
    },
    {
      "content": "This tutorial assumes that you have no prior experience using Azure.",
      "pos": [
        1143,
        1211
      ]
    },
    {
      "content": "On completing this tutorial, you'll have a secure data-driven web application up and running in the cloud and using a cloud database.",
      "pos": [
        1212,
        1345
      ]
    },
    {
      "content": "You'll learn:",
      "pos": [
        1347,
        1360
      ]
    },
    {
      "pos": [
        1364,
        1518
      ],
      "content": "How to create a secure ASP.NET MVC 5 project and publish it to <bpt id=\"p1\">[</bpt>App Service Web Apps<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=529714)</ept> in Azure App Service."
    },
    {
      "pos": [
        1521,
        1642
      ],
      "content": "How to use <bpt id=\"p1\">[</bpt>OAuth<ept id=\"p1\">]</ept><bpt id=\"p2\">(</bpt>http://oauth.net/ <ept id=\"p2\">\"http://oauth.net/\")</ept> and the ASP.NET membership database to secure your application."
    },
    {
      "content": "How to use a SQL database to store data in Azure.",
      "pos": [
        1645,
        1694
      ]
    },
    {
      "content": "You'll build a simple contact list web app that is built on ASP.NET MVC 5 and uses the ADO.NET Entity Framework for database access.",
      "pos": [
        1696,
        1828
      ]
    },
    {
      "content": "The following illustration shows the login page for the completed application:",
      "pos": [
        1829,
        1907
      ]
    },
    {
      "content": "login page",
      "pos": [
        1911,
        1921
      ]
    },
    {
      "pos": [
        1930,
        2172
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> To create the pretty social login buttons in the screenshot above, please view the blog post entitled <bpt id=\"p1\">[</bpt>Pretty social login buttons for ASP.NET MVC 5<ept id=\"p1\">](http://www.jerriepelser.com/blog/pretty-social-login-buttons-for-asp-net-mvc-5)</ept>"
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> To complete this tutorial, you need a Microsoft Azure account.",
      "pos": [
        2175,
        2250
      ]
    },
    {
      "content": "If you don't have an account, you can <bpt id=\"p1\">[</bpt>activate your MSDN subscriber benefits<ept id=\"p1\">](../en-us/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A261C142F)</ept> or <bpt id=\"p2\">[</bpt>sign up for a free trial<ept id=\"p2\">](../en-us/pricing/free-trial/?WT.mc_id=A261C142F)</ept>.",
      "pos": [
        2251,
        2483
      ]
    },
    {
      "content": "If you want to get started with Azure App Service before signing up for an Azure account, go to <bpt id=\"p1\">[</bpt>Try App Service<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=523751)</ept>, where you can immediately create a short-lived starter web app in App Service.",
      "pos": [
        2486,
        2726
      ]
    },
    {
      "content": "No credit cards required; no commitments.",
      "pos": [
        2727,
        2768
      ]
    },
    {
      "content": "To set up your development environment, you must install <bpt id=\"p1\">[</bpt>Visual Studio 2013 Update 4<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=390521)</ept> or higher, and the latest version of the <bpt id=\"p2\">[</bpt>Azure SDK for Visual Studio 2013<ept id=\"p2\">](http://go.microsoft.com/fwlink/?linkid=324322&amp;clcid=0x409)</ept>.",
      "pos": [
        2770,
        3039
      ]
    },
    {
      "content": "This article was written for Visual Studio Update 4 and SDK 2.5.1.",
      "pos": [
        3040,
        3106
      ]
    },
    {
      "content": "Create an ASP.NET MVC 5 application",
      "pos": [
        3111,
        3146
      ]
    },
    {
      "content": "Create the project",
      "pos": [
        3152,
        3170
      ]
    },
    {
      "pos": [
        3175,
        3221
      ],
      "content": "From the <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept> menu, click <bpt id=\"p2\">**</bpt>New Project<ept id=\"p2\">**</ept>."
    },
    {
      "content": "New Project in File menu",
      "pos": [
        3229,
        3253
      ]
    },
    {
      "pos": [
        3353,
        3496
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>New Project<ept id=\"p1\">**</ept> dialog box, expand <bpt id=\"p2\">**</bpt>C#<ept id=\"p2\">**</ept> and select <bpt id=\"p3\">**</bpt>Web<ept id=\"p3\">**</ept> under <bpt id=\"p4\">**</bpt>Installed Templates<ept id=\"p4\">**</ept>, and then select <bpt id=\"p5\">**</bpt>ASP.NET Web Application<ept id=\"p5\">**</ept>."
    },
    {
      "pos": [
        3501,
        3558
      ],
      "content": "Name the application <bpt id=\"p1\">**</bpt>ContactManager<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>."
    },
    {
      "content": "New Project dialog box",
      "pos": [
        3566,
        3588
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept> Make sure you enter \"ContactManager\".",
      "pos": [
        3692,
        3739
      ]
    },
    {
      "content": "Code blocks that you'll be copying later assume that the project name is ContactManager.",
      "pos": [
        3740,
        3828
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>New ASP.NET Project<ept id=\"p1\">**</ept> dialog box, select the <bpt id=\"p2\">**</bpt>MVC<ept id=\"p2\">**</ept> template.",
      "pos": [
        3834,
        3905
      ]
    },
    {
      "content": "Verify <bpt id=\"p1\">**</bpt>Authentication<ept id=\"p1\">**</ept> is set to <bpt id=\"p2\">**</bpt>Individual User Accounts<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Host in the cloud<ept id=\"p3\">**</ept> is checked and <bpt id=\"p4\">**</bpt>Web App<ept id=\"p4\">**</ept> is selected.",
      "pos": [
        3906,
        4033
      ]
    },
    {
      "content": "New ASP.NET Project dialog box",
      "pos": [
        4041,
        4071
      ]
    },
    {
      "content": "The configuration wizard will suggest a unique name based on <bpt id=\"p1\">*</bpt>ContactManager<ept id=\"p1\">*</ept>.",
      "pos": [
        4170,
        4248
      ]
    },
    {
      "content": "You must decide whether to create a new App Service plan and resource group.",
      "pos": [
        4249,
        4325
      ]
    },
    {
      "content": "For guidance on deciding whether to create a new plan or resource group, see <bpt id=\"p1\">[</bpt>Azure App Service plans in-depth overview<ept id=\"p1\">](../app-service/azure-web-sites-web-hosting-plans-in-depth-overview.md)</ept>.",
      "pos": [
        4326,
        4518
      ]
    },
    {
      "content": "For this tutorial, you will probably want to create at least a new resource group.",
      "pos": [
        4519,
        4601
      ]
    },
    {
      "content": "Select a region near you.",
      "pos": [
        4602,
        4627
      ]
    },
    {
      "content": "You can use <bpt id=\"p1\">[</bpt>azurespeed.com<ept id=\"p1\">]</ept><bpt id=\"p2\">(http://www.azurespeed.com/ \"</bpt>AzureSpeed.com<ept id=\"p2\">\")</ept> to find the lowest latency data center.",
      "pos": [
        4628,
        4741
      ]
    },
    {
      "content": "You will set up the database in the next step so do not click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept> yet.",
      "pos": [
        4742,
        4815
      ]
    },
    {
      "content": "New plan and resource group",
      "pos": [
        4823,
        4850
      ]
    },
    {
      "pos": [
        4955,
        5081
      ],
      "content": "If you haven't created a database server before, select <bpt id=\"p1\">**</bpt>Create new server<ept id=\"p1\">**</ept>, enter a database name, user name, and password."
    },
    {
      "content": "Use new database",
      "pos": [
        5089,
        5105
      ]
    },
    {
      "content": "If you have a database server, use that to create a new database.",
      "pos": [
        5199,
        5264
      ]
    },
    {
      "content": "Database servers are a precious resource, and you generally want to create multiple databases on the same server for testing and development rather than creating a database server per database.",
      "pos": [
        5265,
        5458
      ]
    },
    {
      "content": "Make sure your web app and database are in the same region.",
      "pos": [
        5459,
        5518
      ]
    },
    {
      "content": "Use exsiting database",
      "pos": [
        5526,
        5547
      ]
    },
    {
      "content": "Set the page header and footer",
      "pos": [
        5650,
        5680
      ]
    },
    {
      "pos": [
        5686,
        5770
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept> open the <bpt id=\"p2\">*</bpt>Layout.cshtml<ept id=\"p2\">*</ept> file in the <bpt id=\"p3\">*</bpt>Views\\Shared<ept id=\"p3\">*</ept> folder."
    },
    {
      "content": "_Layout.cshtml in Solution Explorer",
      "pos": [
        5778,
        5813
      ]
    },
    {
      "content": "Replace the markup in the  <bpt id=\"p1\">*</bpt>Layout.cshtml<ept id=\"p1\">*</ept> file with the following code.",
      "pos": [
        5830,
        5902
      ]
    },
    {
      "content": "The changes are highlighted below.",
      "pos": [
        5903,
        5937
      ]
    },
    {
      "content": "Run the application locally",
      "pos": [
        7893,
        7920
      ]
    },
    {
      "content": "Press CTRL+F5 to run the app.",
      "pos": [
        7925,
        7954
      ]
    },
    {
      "content": "The application home page appears in the default browser.",
      "pos": [
        7960,
        8017
      ]
    },
    {
      "content": "Web app running locally",
      "pos": [
        8025,
        8048
      ]
    },
    {
      "content": "This is all you need to do for now to create the application that you'll deploy to Azure.",
      "pos": [
        8137,
        8226
      ]
    },
    {
      "content": "Enable SSL for the Project",
      "pos": [
        8232,
        8258
      ]
    },
    {
      "content": "Enable SSL.",
      "pos": [
        8266,
        8277
      ]
    },
    {
      "content": "In Solution Explorer, click the <bpt id=\"p1\">**</bpt>ContactManager<ept id=\"p1\">**</ept> project, then click F4 to bring up the properties dialog.",
      "pos": [
        8278,
        8386
      ]
    },
    {
      "content": "Change <bpt id=\"p1\">**</bpt>SSL Enabled<ept id=\"p1\">**</ept> to true.",
      "pos": [
        8387,
        8418
      ]
    },
    {
      "content": "Copy the <bpt id=\"p1\">**</bpt>SSL URL<ept id=\"p1\">**</ept>.",
      "pos": [
        8419,
        8440
      ]
    },
    {
      "content": "The SSL URL will be https://localhost:44300/ unless you've previously created SSL web apps.",
      "pos": [
        8441,
        8532
      ]
    },
    {
      "content": "enable SSL",
      "pos": [
        8540,
        8550
      ]
    },
    {
      "pos": [
        8564,
        8655
      ],
      "content": "In Solution Explorer, right click the <bpt id=\"p1\">**</bpt>Contact Manager<ept id=\"p1\">**</ept> project and click <bpt id=\"p2\">**</bpt>Properties<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        8659,
        8690
      ],
      "content": "In the left tab, click <bpt id=\"p1\">**</bpt>Web<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        8694,
        8774
      ],
      "content": "Change the <bpt id=\"p1\">**</bpt>Project Url<ept id=\"p1\">**</ept> to use the <bpt id=\"p2\">**</bpt>SSL URL<ept id=\"p2\">**</ept> and save the page (Control S)."
    },
    {
      "content": "enable SSL",
      "pos": [
        8782,
        8792
      ]
    },
    {
      "content": "Verify Internet Explorer is the browser Visual Studio launches as shown in the image below:",
      "pos": [
        8886,
        8977
      ]
    },
    {
      "content": "default browser",
      "pos": [
        8985,
        9000
      ]
    },
    {
      "content": "The browser selector lets you specify the browser Visual Studio launches.",
      "pos": [
        9094,
        9167
      ]
    },
    {
      "content": "browser selector",
      "pos": [
        9175,
        9191
      ]
    },
    {
      "content": "You can select multiple browsers and have Visual Studio update each browser when you make changes.",
      "pos": [
        9285,
        9383
      ]
    },
    {
      "content": "For more information see <bpt id=\"p1\">[</bpt>Using Browser Link in Visual Studio 2013<ept id=\"p1\">](http://www.asp.net/visual-studio/overview/2013/using-browser-link)</ept>.",
      "pos": [
        9384,
        9519
      ]
    },
    {
      "content": "Press CTRL+F5 to run the application.",
      "pos": [
        9525,
        9562
      ]
    },
    {
      "content": "Follow the instructions to trust the self-signed certificate that IIS Express has generated.",
      "pos": [
        9563,
        9655
      ]
    },
    {
      "content": "instructions to trust the self-signed certificate that IIS Express has generated",
      "pos": [
        9664,
        9744
      ]
    },
    {
      "pos": [
        9837,
        9964
      ],
      "content": "Read the <bpt id=\"p1\">**</bpt>Security Warning<ept id=\"p1\">**</ept> dialog and then click <bpt id=\"p2\">**</bpt>Yes<ept id=\"p2\">**</ept> if you want to install the certificate representing  <bpt id=\"p3\">**</bpt>localhost<ept id=\"p3\">**</ept>."
    },
    {
      "content": "localhost IIS Express certificate warning",
      "pos": [
        9972,
        10013
      ]
    },
    {
      "pos": [
        10107,
        10162
      ],
      "content": "IE shows the <bpt id=\"p1\">*</bpt>Home<ept id=\"p1\">*</ept> page and there are no SSL warnings."
    },
    {
      "content": "IE with localhost SSL and no warnings",
      "pos": [
        10171,
        10208
      ]
    },
    {
      "content": "Google Chrome also accepts the certificate and will show HTTPS content without a warning.",
      "pos": [
        10302,
        10391
      ]
    },
    {
      "content": "Firefox uses its own certificate store, so it will display a warning.",
      "pos": [
        10392,
        10461
      ]
    },
    {
      "content": "FireFox Cert Warning",
      "pos": [
        10470,
        10490
      ]
    },
    {
      "content": "Deploy the application to Azure",
      "pos": [
        10583,
        10614
      ]
    },
    {
      "pos": [
        10619,
        10731
      ],
      "content": "In Visual Studio, right-click the project in <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Publish<ept id=\"p2\">**</ept> from the context menu."
    },
    {
      "content": "Publish in project context menu",
      "pos": [
        10739,
        10770
      ]
    },
    {
      "pos": [
        10875,
        10908
      ],
      "content": "The <bpt id=\"p1\">**</bpt>Publish Web<ept id=\"p1\">**</ept> wizard opens."
    },
    {
      "pos": [
        10913,
        10966
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Publish Web<ept id=\"p1\">**</ept> dialog box, click <bpt id=\"p2\">**</bpt>Publish<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Publish",
      "pos": [
        10974,
        10981
      ]
    },
    {
      "content": "The application you created is now running in the cloud.",
      "pos": [
        11074,
        11130
      ]
    },
    {
      "content": "The next time you deploy the application, only the changed (or new) files will be deployed.",
      "pos": [
        11131,
        11222
      ]
    },
    {
      "content": "Running in Cloud",
      "pos": [
        11230,
        11246
      ]
    },
    {
      "content": "Add a database to the application",
      "pos": [
        11338,
        11371
      ]
    },
    {
      "content": "Next, you'll update the app to add the ability to display and update contacts and store the data in a database.",
      "pos": [
        11373,
        11484
      ]
    },
    {
      "content": "The app will use the Entity Framework (EF) to create the database and to read and update data.",
      "pos": [
        11485,
        11579
      ]
    },
    {
      "content": "Add data model classes for the contacts",
      "pos": [
        11585,
        11624
      ]
    },
    {
      "content": "You begin by creating a simple data model in code.",
      "pos": [
        11626,
        11676
      ]
    },
    {
      "pos": [
        11681,
        11772
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, right-click the Models folder, click <bpt id=\"p2\">**</bpt>Add<ept id=\"p2\">**</ept>, and then <bpt id=\"p3\">**</bpt>Class<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Add Class in Models folder context menu",
      "pos": [
        11780,
        11819
      ]
    },
    {
      "pos": [
        11911,
        12008
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Add New Item<ept id=\"p1\">**</ept> dialog box, name the new class file <bpt id=\"p2\">*</bpt>Contact.cs<ept id=\"p2\">*</ept>, and then click <bpt id=\"p3\">**</bpt>Add<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Add New Item dialog box",
      "pos": [
        12016,
        12039
      ]
    },
    {
      "content": "Replace the contents of the Contacts.cs file with the following code.",
      "pos": [
        12055,
        12124
      ]
    },
    {
      "pos": [
        12735,
        12877
      ],
      "content": "The <bpt id=\"p1\">**</bpt>Contacts<ept id=\"p1\">**</ept> class defines the data that you will store for each contact, plus a primary key, <bpt id=\"p2\">*</bpt>ContactID<ept id=\"p2\">*</ept>, that is needed by the database."
    },
    {
      "content": "Create web pages that enable app users to work with the contacts",
      "pos": [
        12883,
        12947
      ]
    },
    {
      "content": "The ASP.NET MVC scaffolding feature can automatically generate code that performs create, read, update, and delete (CRUD) actions.",
      "pos": [
        12949,
        13079
      ]
    },
    {
      "content": "Add a Controller and a view for the data",
      "pos": [
        13084,
        13124
      ]
    },
    {
      "content": "Build the project <bpt id=\"p1\">**</bpt>(Ctrl+Shift+B)<ept id=\"p1\">**</ept>.",
      "pos": [
        13129,
        13166
      ]
    },
    {
      "content": "(You must build the project before using the scaffolding mechanism.)",
      "pos": [
        13167,
        13235
      ]
    },
    {
      "pos": [
        13240,
        13350
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, right-click the Controllers folder and click <bpt id=\"p2\">**</bpt>Add<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Controller<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Add Controller in Controllers folder context menu",
      "pos": [
        13358,
        13407
      ]
    },
    {
      "pos": [
        13425,
        13533
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Add Scaffold<ept id=\"p1\">**</ept> dialog box, select <bpt id=\"p2\">**</bpt>MVC 5 Controller with views, using EF<ept id=\"p2\">**</ept> and then click <bpt id=\"p3\">**</bpt>Add<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Add Scaffold dlg",
      "pos": [
        13545,
        13561
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Model class<ept id=\"p1\">**</ept> dropdown box, select <bpt id=\"p2\">**</bpt>Contact (ContactManager.Models)<ept id=\"p2\">**</ept>.",
      "pos": [
        13654,
        13734
      ]
    },
    {
      "content": "(See the image below.)",
      "pos": [
        13735,
        13757
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Data context class<ept id=\"p1\">**</ept>, select <bpt id=\"p2\">**</bpt>ApplicationDbContext (ContactManager.Models)<ept id=\"p2\">**</ept>.",
      "pos": [
        13761,
        13848
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>ApplicationDbContext<ept id=\"p1\">**</ept> will be used for both the membership DB and our contact data.",
      "pos": [
        13849,
        13939
      ]
    },
    {
      "pos": [
        13943,
        14031
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Controller name<ept id=\"p1\">**</ept> text entry box, enter \"CmController\" for the controller name."
    },
    {
      "content": "New data ctx dlg",
      "pos": [
        14040,
        14056
      ]
    },
    {
      "pos": [
        14148,
        14162
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        14167,
        14273
      ],
      "content": "Visual Studio creates a controller methods and views for CRUD database operations for <bpt id=\"p1\">**</bpt>Contact<ept id=\"p1\">**</ept> objects."
    },
    {
      "content": "Enable Migrations, create the database, add sample data and a data initializer",
      "pos": [
        14278,
        14356
      ]
    },
    {
      "pos": [
        14361,
        14541
      ],
      "content": "The next task is to enable the <bpt id=\"p1\">[</bpt>Code First Migrations<ept id=\"p1\">](http://msdn.microsoft.com/library/hh770484.aspx)</ept> feature in order to create the database based on the data model you created."
    },
    {
      "pos": [
        14546,
        14770
      ],
      "content": "In the **Tools** menu, select **NuGet Package Manager** and then **Package Manager Console**.\n ![Package Manager Console in Tools menu](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/SS6.png)",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "In the <bpt id=\"p1\">**</bpt>Tools<ept id=\"p1\">**</ept> menu, select <bpt id=\"p2\">**</bpt>NuGet Package Manager<ept id=\"p2\">**</ept> and then <bpt id=\"p3\">**</bpt>Package Manager Console<ept id=\"p3\">**</ept>.",
          "pos": [
            0,
            93
          ]
        },
        {
          "content": "<ph id=\"ph1\"> ![</ph>Package Manager Console in Tools menu<ph id=\"ph2\">](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/SS6.png)</ph>",
          "pos": [
            94,
            221
          ]
        }
      ]
    },
    {
      "pos": [
        14775,
        14846
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Package Manager Console<ept id=\"p1\">**</ept> window, enter the following command:"
    },
    {
      "pos": [
        14878,
        15060
      ],
      "content": "The <bpt id=\"p1\">**</bpt>enable-migrations<ept id=\"p1\">**</ept> command creates a <bpt id=\"p2\">*</bpt>Migrations<ept id=\"p2\">*</ept> folder, and it puts in that folder a <bpt id=\"p3\">*</bpt>Configuration.cs<ept id=\"p3\">*</ept> file that you can edit to seed the database and configure Migrations."
    },
    {
      "pos": [
        15066,
        15137
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Package Manager Console<ept id=\"p1\">**</ept> window, enter the following command:"
    },
    {
      "pos": [
        15175,
        15633
      ],
      "content": "The **add-migration Initial** command generates a file named **&lt;date_stamp&gt;Initial** in the *Migrations* folder that creates the database. The first parameter ( **Initial** ) is arbitrary and is used to create the name of the file. You can see the new class files in **Solution Explorer**.\n In the **Initial** class, the **Up** method creates the Contacts table, and the **Down** method (used when you want to return to the previous state) drops it.",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "The **add-migration Initial** command generates a file named **&lt;date_stamp&gt;Initial** in the *Migrations* folder that creates the database. The first parameter ( **Initial** ) is arbitrary and is used to create the name of the file. You can see the new class files in **Solution Explorer**.",
          "pos": [
            0,
            295
          ],
          "nodes": [
            {
              "content": "The <bpt id=\"p1\">**</bpt>add-migration Initial<ept id=\"p1\">**</ept> command generates a file named <bpt id=\"p2\">**</bpt>&amp;lt;date_stamp&amp;gt;Initial<ept id=\"p2\">**</ept> in the <bpt id=\"p3\">*</bpt>Migrations<ept id=\"p3\">*</ept> folder that creates the database.",
              "pos": [
                0,
                144
              ]
            },
            {
              "content": "The first parameter ( <bpt id=\"p1\">**</bpt>Initial<ept id=\"p1\">**</ept> ) is arbitrary and is used to create the name of the file.",
              "pos": [
                145,
                237
              ]
            },
            {
              "content": "You can see the new class files in <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>.",
              "pos": [
                238,
                295
              ]
            }
          ]
        },
        {
          "content": "In the <bpt id=\"p1\">**</bpt>Initial<ept id=\"p1\">**</ept> class, the <bpt id=\"p2\">**</bpt>Up<ept id=\"p2\">**</ept> method creates the Contacts table, and the <bpt id=\"p3\">**</bpt>Down<ept id=\"p3\">**</ept> method (used when you want to return to the previous state) drops it.",
          "pos": [
            297,
            455
          ]
        }
      ]
    },
    {
      "pos": [
        15637,
        15681
      ],
      "content": "Open the <bpt id=\"p1\">*</bpt>Migrations\\Configuration.cs<ept id=\"p1\">*</ept> file."
    },
    {
      "content": "Add the following namespace.",
      "pos": [
        15686,
        15714
      ]
    },
    {
      "pos": [
        15761,
        15811
      ],
      "content": "Replace the <bpt id=\"p1\">*</bpt>Seed<ept id=\"p1\">*</ept> method with the following code:"
    },
    {
      "content": "This code initializes (seeds) the database with the contact information.",
      "pos": [
        17561,
        17633
      ]
    },
    {
      "content": "For more information on seeding the database, see <bpt id=\"p1\">[</bpt>Seeding and Debugging Entity Framework (EF) DBs<ept id=\"p1\">](http://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx)</ept>.",
      "pos": [
        17634,
        17838
      ]
    },
    {
      "pos": [
        17844,
        17897
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Package Manager Console<ept id=\"p1\">**</ept> enter the command:"
    },
    {
      "content": "Package Manager Console commands",
      "pos": [
        17930,
        17962
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>update-database<ept id=\"p1\">**</ept> runs the first migration which creates the database.",
      "pos": [
        17981,
        18057
      ]
    },
    {
      "content": "By default, the database is created as a SQL Server Express LocalDB database.",
      "pos": [
        18058,
        18135
      ]
    },
    {
      "pos": [
        18141,
        18260
      ],
      "content": "Press CTRL+F5 to run the application, and then click the <bpt id=\"p1\">**</bpt>CM Demo<ept id=\"p1\">**</ept> link; or navigate to https://localhost:(port#)/Cm."
    },
    {
      "content": "The application shows the seed data and provides edit, details and delete links.",
      "pos": [
        18267,
        18347
      ]
    },
    {
      "content": "You can create, edit, delete and view data.",
      "pos": [
        18348,
        18391
      ]
    },
    {
      "content": "MVC view of data",
      "pos": [
        18399,
        18415
      ]
    },
    {
      "content": "Add an OAuth2 Provider",
      "pos": [
        18428,
        18450
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>OAuth<ept id=\"p1\">]</ept><bpt id=\"p2\">(</bpt>http://oauth.net/ <ept id=\"p2\">\"http://oauth.net/\")</ept> is an open protocol that allows secure authorization in a simple and standard method from web, mobile, and desktop applications.",
      "pos": [
        18452,
        18627
      ]
    },
    {
      "content": "The ASP.NET MVC internet template uses OAuth to expose Facebook, Twitter, Google and Microsoft as authentication providers.",
      "pos": [
        18628,
        18751
      ]
    },
    {
      "content": "Although this tutorial uses only Google as the authentication provider, you can easily modify the code to use any of these providers.",
      "pos": [
        18752,
        18885
      ]
    },
    {
      "content": "The steps to implement other providers are very similar to the steps you will see in this tutorial.",
      "pos": [
        18886,
        18985
      ]
    },
    {
      "content": "To use Facebook as an authentication provider, see my tutorial <bpt id=\"p1\">[</bpt>MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on <ept id=\"p1\">](http://www.asp.net/mvc/tutorials/mvc-5/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on)</ept>.",
      "pos": [
        18986,
        19239
      ]
    },
    {
      "content": "In addition to authentication, the tutorial will also use roles to implement authorization.",
      "pos": [
        19241,
        19332
      ]
    },
    {
      "content": "Only those users you add to the <bpt id=\"p1\">*</bpt>canEdit<ept id=\"p1\">*</ept> role will be able to change data (that is, create, edit, or delete contacts).",
      "pos": [
        19333,
        19452
      ]
    },
    {
      "content": "Follow the instructions in my tutorial <bpt id=\"p1\">[</bpt>MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on <ept id=\"p1\">](http://www.asp.net/mvc/tutorials/mvc-5/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on#goog)</ept>  under <bpt id=\"p2\">**</bpt>Creating a Google app for OAuth 2 to set up a Google app for OAuth2<ept id=\"p2\">**</ept>.",
      "pos": [
        19454,
        19767
      ]
    },
    {
      "content": "Run and test the app to verify you can log on using Google authentication.",
      "pos": [
        19768,
        19842
      ]
    },
    {
      "content": "Using the Membership API",
      "pos": [
        19847,
        19871
      ]
    },
    {
      "content": "In this section you will add a local user and the <bpt id=\"p1\">*</bpt>canEdit<ept id=\"p1\">*</ept> role to the membership database.",
      "pos": [
        19872,
        19964
      ]
    },
    {
      "content": "Only those users in the <bpt id=\"p1\">*</bpt>canEdit<ept id=\"p1\">*</ept> role will be able to edit data.",
      "pos": [
        19965,
        20030
      ]
    },
    {
      "content": "A best practice is to name roles by the actions they can perform, so <bpt id=\"p1\">*</bpt>canEdit<ept id=\"p1\">*</ept> is preferred over a role called <bpt id=\"p2\">*</bpt>admin<ept id=\"p2\">*</ept>.",
      "pos": [
        20031,
        20150
      ]
    },
    {
      "content": "When your application evolves you can add new roles such as <bpt id=\"p1\">*</bpt>canDeleteMembers<ept id=\"p1\">*</ept> rather than the less descriptive <bpt id=\"p2\">*</bpt>superAdmin<ept id=\"p2\">*</ept>.",
      "pos": [
        20151,
        20276
      ]
    },
    {
      "pos": [
        20281,
        20366
      ],
      "content": "Open the <bpt id=\"p1\">*</bpt>migrations\\configuration.cs<ept id=\"p1\">*</ept> file and add the following <ph id=\"ph1\">`using`</ph> statements:"
    },
    {
      "pos": [
        20470,
        20527
      ],
      "content": "Add the following <bpt id=\"p1\">**</bpt>AddUserAndRole<ept id=\"p1\">**</ept> method to the class:"
    },
    {
      "pos": [
        21210,
        21255
      ],
      "content": "Call the new method from the <bpt id=\"p1\">**</bpt>Seed<ept id=\"p1\">**</ept> method:"
    },
    {
      "pos": [
        21506,
        21562
      ],
      "content": "The following images shows the changes to <bpt id=\"p1\">*</bpt>Seed<ept id=\"p1\">*</ept> method:"
    },
    {
      "content": "code image",
      "pos": [
        21570,
        21580
      ]
    },
    {
      "content": "This code creates a new role called <bpt id=\"p1\">*</bpt>canEdit<ept id=\"p1\">*</ept>, creates a new local user <bpt id=\"p2\">*</bpt>user1@contoso.com<ept id=\"p2\">*</ept>, and adds <bpt id=\"p3\">*</bpt>user1@contoso.com<ept id=\"p3\">*</ept> to the <bpt id=\"p4\">*</bpt>canEdit<ept id=\"p4\">*</ept> role.",
      "pos": [
        21674,
        21818
      ]
    },
    {
      "content": "For more information, see my <bpt id=\"p1\">[</bpt>ASP.NET Identity tutorials<ept id=\"p1\">](http://www.asp.net/identity/overview/features-api)</ept>.",
      "pos": [
        21819,
        21928
      ]
    },
    {
      "content": "Use Temporary Code to Add New Social Login Users to the canEdit Role",
      "pos": [
        21933,
        22001
      ]
    },
    {
      "content": "In this section you will temporarily modify the <bpt id=\"p1\">**</bpt>ExternalLoginConfirmation<ept id=\"p1\">**</ept> method in the Account controller to add new users registering with an OAuth provider to the <bpt id=\"p2\">*</bpt>canEdit<ept id=\"p2\">*</ept> role.",
      "pos": [
        22006,
        22191
      ]
    },
    {
      "content": "We will temporarily modify the <bpt id=\"p1\">**</bpt>ExternalLoginConfirmation<ept id=\"p1\">**</ept> method to automatically add new users to an administrative role.",
      "pos": [
        22192,
        22317
      ]
    },
    {
      "content": "Until we provide a tool to add and manage roles, we'll use the temporary automatic registration code below.",
      "pos": [
        22318,
        22425
      ]
    },
    {
      "content": "We hope to provide a tool similar to <bpt id=\"p1\">[</bpt>WSAT<ept id=\"p1\">](http://msdn.microsoft.com/en-us/library/ms228053.aspx)</ept> in the future which allow you to create and edit user accounts and roles.",
      "pos": [
        22426,
        22598
      ]
    },
    {
      "pos": [
        22604,
        22712
      ],
      "content": "Open the <bpt id=\"p1\">**</bpt>Controllers\\AccountController.cs<ept id=\"p1\">**</ept> file and navigate to the <bpt id=\"p2\">**</bpt>ExternalLoginConfirmation<ept id=\"p2\">**</ept> method."
    },
    {
      "pos": [
        22716,
        22798
      ],
      "content": "Add the following call to <bpt id=\"p1\">**</bpt>AddToRoleAsync<ept id=\"p1\">**</ept> just before the <bpt id=\"p2\">**</bpt>SignInAsync<ept id=\"p2\">**</ept> call."
    },
    {
      "content": "The code above adds the newly registered user to the \"canEdit\" role, which gives them access to action methods that change (edit) data.",
      "pos": [
        22866,
        23001
      ]
    },
    {
      "content": "Later in the tutorial you will deploy the application to Azure, where you will log-on with Google or another third party authentication provider.",
      "pos": [
        24535,
        24680
      ]
    },
    {
      "content": "This will add your newly registered account to the <bpt id=\"p1\">*</bpt>canEdit<ept id=\"p1\">*</ept> role.",
      "pos": [
        24681,
        24747
      ]
    },
    {
      "content": "Anyone who finds your web app's URL and has a Google ID can then register and update your database.",
      "pos": [
        24748,
        24847
      ]
    },
    {
      "content": "To prevent other people from doing that, you can stop the site.",
      "pos": [
        24848,
        24911
      ]
    },
    {
      "content": "You'll be able to verify who is in the <bpt id=\"p1\">*</bpt>canEdit<ept id=\"p1\">*</ept> role by examining the database.",
      "pos": [
        24912,
        24992
      ]
    },
    {
      "pos": [
        24994,
        25084
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Package Manager Console<ept id=\"p1\">**</ept> hit the up arrow key to bring up the following command:"
    },
    {
      "content": "Run the  <bpt id=\"p1\">**</bpt>Update-Database<ept id=\"p1\">**</ept> command which will run the <bpt id=\"p2\">**</bpt>Seed<ept id=\"p2\">**</ept> method, and that will run the <bpt id=\"p3\">**</bpt>AddUserAndRole<ept id=\"p3\">**</ept> you just added.",
      "pos": [
        25111,
        25240
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>AddUserAndRole<ept id=\"p1\">**</ept> will create the user <bpt id=\"p2\">*</bpt>user1@contoso.com<ept id=\"p2\">*</ept> and add her to the <bpt id=\"p3\">*</bpt>canEdit<ept id=\"p3\">*</ept> role.",
      "pos": [
        25241,
        25339
      ]
    },
    {
      "content": "Protect the Application with SSL and the Authorize Attribute",
      "pos": [
        25344,
        25404
      ]
    },
    {
      "content": "In this section you will apply the <bpt id=\"p1\">[</bpt>Authorize<ept id=\"p1\">](http://msdn.microsoft.com/library/system.web.mvc.authorizeattribute.aspx)</ept> attribute to restrict access to the action methods.",
      "pos": [
        25409,
        25581
      ]
    },
    {
      "content": "Anonymous users will be able to view the <bpt id=\"p1\">**</bpt>Index<ept id=\"p1\">**</ept> action method of the home controller only.",
      "pos": [
        25582,
        25675
      ]
    },
    {
      "content": "Registered users will be able to see contact data (The <bpt id=\"p1\">**</bpt>Index<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Details<ept id=\"p2\">**</ept> pages of the Cm controller), the About, and the Contact pages.",
      "pos": [
        25676,
        25819
      ]
    },
    {
      "content": "Only users in the <bpt id=\"p1\">*</bpt>canEdit<ept id=\"p1\">*</ept> role will be able to access action methods that change data.",
      "pos": [
        25820,
        25908
      ]
    },
    {
      "content": "Add the <bpt id=\"p1\">[</bpt>Authorize<ept id=\"p1\">](http://msdn.microsoft.com/library/system.web.mvc.authorizeattribute.aspx)</ept> filter and the <bpt id=\"p2\">[</bpt>RequireHttps<ept id=\"p2\">](http://msdn.microsoft.com/library/system.web.mvc.requirehttpsattribute.aspx)</ept> filter to the application.",
      "pos": [
        25913,
        26140
      ]
    },
    {
      "content": "An alternative approach is to add the <bpt id=\"p1\">[</bpt>Authorize<ept id=\"p1\">](http://msdn.microsoft.com/library/system.web.mvc.authorizeattribute.aspx)</ept> attribute and the <bpt id=\"p2\">[</bpt>RequireHttps<ept id=\"p2\">](http://msdn.microsoft.com/library/system.web.mvc.requirehttpsattribute.aspx)</ept> attribute to each controller, but it's considered a security best practice to apply them to the entire application.",
      "pos": [
        26141,
        26490
      ]
    },
    {
      "content": "By adding them globally, every new controller and action method you add will automatically be protected, you won't need to remember to apply them.",
      "pos": [
        26491,
        26637
      ]
    },
    {
      "content": "For more information see <bpt id=\"p1\">[</bpt>Securing your ASP.NET MVC  App and the new AllowAnonymous Attribute<ept id=\"p1\">](http://blogs.msdn.com/b/rickandy/archive/2012/03/23/securing-your-asp-net-mvc-4-app-and-the-new-allowanonymous-attribute.aspx)</ept>.",
      "pos": [
        26638,
        26860
      ]
    },
    {
      "content": "Open the <bpt id=\"p1\">*</bpt>App_Start\\FilterConfig.cs<ept id=\"p1\">*</ept> file and replace the <bpt id=\"p2\">*</bpt>RegisterGlobalFilters<ept id=\"p2\">*</ept> method with the following (which adds the two filters):",
      "pos": [
        26861,
        26998
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>Authorize<ept id=\"p1\">](http://msdn.microsoft.com/library/system.web.mvc.authorizeattribute.aspx)</ept> filter applied in the code above will prevent anonymous users from accessing any methods in the application.",
      "pos": [
        27295,
        27493
      ]
    },
    {
      "content": "You will use the <bpt id=\"p1\">[</bpt>AllowAnonymous<ept id=\"p1\">](http://blogs.msdn.com/b/rickandy/archive/2012/03/23/securing-your-asp-net-mvc-4-app-and-the-new-allowanonymous-attribute.aspx)</ept> attribute to opt out of the authorization requirement in a couple methods, so anonymous users can log in and can view the home page.",
      "pos": [
        27494,
        27787
      ]
    },
    {
      "content": "The  <bpt id=\"p1\">[</bpt>RequireHttps<ept id=\"p1\">](http://msdn.microsoft.com/library/system.web.mvc.requirehttpsattribute.aspx)</ept> will require all access to the web app be through HTTPS.",
      "pos": [
        27788,
        27941
      ]
    },
    {
      "content": "Add the <bpt id=\"p1\">[</bpt>AllowAnonymous<ept id=\"p1\">](http://blogs.msdn.com/b/rickandy/archive/2012/03/23/securing-your-asp-net-mvc-4-app-and-the-new-allowanonymous-attribute.aspx)</ept> attribute to the <bpt id=\"p2\">**</bpt>Index<ept id=\"p2\">**</ept> method of the Home controller.",
      "pos": [
        27946,
        28155
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>AllowAnonymous<ept id=\"p1\">](http://blogs.msdn.com/b/rickandy/archive/2012/03/23/securing-your-asp-net-mvc-4-app-and-the-new-allowanonymous-attribute.aspx)</ept> attribute enables you to white-list the methods you want to opt out of authorization.",
      "pos": [
        28156,
        28389
      ]
    },
    {
      "pos": [
        28572,
        28701
      ],
      "content": "Do a global search for <bpt id=\"p1\">*</bpt>AllowAnonymous<ept id=\"p1\">*</ept>, you can see it is used in the log in and registration methods of the Account controller."
    },
    {
      "content": "In <bpt id=\"p1\">*</bpt>CmController.cs<ept id=\"p1\">*</ept>, add <ph id=\"ph1\">`[Authorize(Roles = \"canEdit\")]`</ph> to the HttpGet and HttpPost methods that change data (Create, Edit, Delete, every action method except Index and Details) in the <bpt id=\"p2\">*</bpt>Cm<ept id=\"p2\">*</ept> controller.",
      "pos": [
        28705,
        28909
      ]
    },
    {
      "content": "A portion of the completed code is shown below:",
      "pos": [
        28910,
        28957
      ]
    },
    {
      "pos": [
        30380,
        30457
      ],
      "content": "If you are still logged in from a previous session, hit the <bpt id=\"p1\">**</bpt>Log out<ept id=\"p1\">**</ept> link."
    },
    {
      "content": "Click on the <bpt id=\"p1\">**</bpt>About<ept id=\"p1\">**</ept> or <bpt id=\"p2\">**</bpt>Contact<ept id=\"p2\">**</ept> links.",
      "pos": [
        30461,
        30505
      ]
    },
    {
      "content": "You will be redirected to the log in page because anonymous users cannot view those pages.",
      "pos": [
        30506,
        30596
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>Register as a new user<ept id=\"p1\">**</ept> link and add a local user with email <bpt id=\"p2\">*</bpt>joe@contoso.com<ept id=\"p2\">*</ept>.",
      "pos": [
        30601,
        30693
      ]
    },
    {
      "content": "Verify <bpt id=\"p1\">*</bpt>Joe<ept id=\"p1\">*</ept> can view the Home, About and Contact pages.",
      "pos": [
        30694,
        30750
      ]
    },
    {
      "content": "login",
      "pos": [
        30759,
        30764
      ]
    },
    {
      "pos": [
        30857,
        30910
      ],
      "content": "Click the <bpt id=\"p1\">*</bpt>CM Demo<ept id=\"p1\">*</ept> link and verify you see the data."
    },
    {
      "pos": [
        30915,
        31051
      ],
      "content": "Click an edit link on the page, you will be redirected to the log in page (because a new local user is not added to the <bpt id=\"p1\">*</bpt>canEdit<ept id=\"p1\">*</ept> role)."
    },
    {
      "pos": [
        31055,
        31460
      ],
      "content": "Log in as *user1@contoso.com* with password of \"P_assw0rd1\" (the \"0\" in \"word\" is a zero). You will be redirected to the edit page you previously selected. <br/>\nIf you can't log in with that account and password, try copying the password from the source code and pasting it. If you still can't log in, check the **UserName** column of the **AspNetUsers** table to verify *user1@contoso.com* was added.",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "Log in as *user1@contoso.com* with password of \"P_assw0rd1\" (the \"0\" in \"word\" is a zero). You will be redirected to the edit page you previously selected. ",
          "pos": [
            0,
            156
          ],
          "nodes": [
            {
              "content": "Log in as <bpt id=\"p1\">*</bpt>user1@contoso.com<ept id=\"p1\">*</ept> with password of \"P_assw0rd1\" (the \"0\" in \"word\" is a zero).",
              "pos": [
                0,
                90
              ]
            },
            {
              "content": "You will be redirected to the edit page you previously selected.",
              "pos": [
                91,
                155
              ]
            }
          ]
        },
        {
          "content": "If you can't log in with that account and password, try copying the password from the source code and pasting it. If you still can't log in, check the **UserName** column of the **AspNetUsers** table to verify *user1@contoso.com* was added.",
          "pos": [
            162,
            402
          ],
          "nodes": [
            {
              "content": "If you can't log in with that account and password, try copying the password from the source code and pasting it.",
              "pos": [
                0,
                113
              ]
            },
            {
              "content": "If you still can't log in, check the <bpt id=\"p1\">**</bpt>UserName<ept id=\"p1\">**</ept> column of the <bpt id=\"p2\">**</bpt>AspNetUsers<ept id=\"p2\">**</ept> table to verify <bpt id=\"p3\">*</bpt>user1@contoso.com<ept id=\"p3\">*</ept> was added.",
              "pos": [
                114,
                240
              ]
            }
          ]
        }
      ]
    },
    {
      "content": "Verify you can make data changes.",
      "pos": [
        31466,
        31499
      ]
    },
    {
      "content": "Deploy the app to Azure",
      "pos": [
        31504,
        31527
      ]
    },
    {
      "pos": [
        31532,
        31644
      ],
      "content": "In Visual Studio, right-click the project in <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Publish<ept id=\"p2\">**</ept> from the context menu."
    },
    {
      "content": "Publish in project context menu",
      "pos": [
        31652,
        31683
      ]
    },
    {
      "pos": [
        31705,
        31738
      ],
      "content": "The <bpt id=\"p1\">**</bpt>Publish Web<ept id=\"p1\">**</ept> wizard opens."
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>Settings<ept id=\"p1\">**</ept> tab on the left side of the <bpt id=\"p2\">**</bpt>Publish Web<ept id=\"p2\">**</ept> dialog box.",
      "pos": [
        31743,
        31821
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>v<ept id=\"p1\">**</ept> icon to select the <bpt id=\"p2\">**</bpt>Remote connection string<ept id=\"p2\">**</ept> for <bpt id=\"p3\">**</bpt>ApplicationDbContext<ept id=\"p3\">**</ept> and select the  <bpt id=\"p4\">**</bpt>ContactManagerNN_db<ept id=\"p4\">**</ept>.",
      "pos": [
        31822,
        31955
      ]
    },
    {
      "pos": [
        32068,
        32142
      ],
      "content": "Under <bpt id=\"p1\">**</bpt>ContactManagerContext<ept id=\"p1\">**</ept>, select <bpt id=\"p2\">**</bpt>Execute Code First Migrations<ept id=\"p2\">**</ept>."
    },
    {
      "content": "settings",
      "pos": [
        32150,
        32158
      ]
    },
    {
      "pos": [
        32251,
        32269
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Publish<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        32273,
        32364
      ],
      "content": "Log in as <bpt id=\"p1\">*</bpt>user1@contoso.com<ept id=\"p1\">*</ept> (with password of \"P_assw0rd1\") and verify you can edit data."
    },
    {
      "content": "Log out.",
      "pos": [
        32368,
        32376
      ]
    },
    {
      "pos": [
        32380,
        32557
      ],
      "content": "Go to the <bpt id=\"p1\">[</bpt>Google Developers Console<ept id=\"p1\">](https://console.developers.google.com/)</ept> and on the <bpt id=\"p2\">**</bpt>Credentials<ept id=\"p2\">**</ept> tab update the redirect URIS and JavaScript Orgins to use the Azure URL."
    },
    {
      "content": "Log in using Google or Facebook.",
      "pos": [
        32561,
        32593
      ]
    },
    {
      "content": "That will add the Google or Facebook account to the <bpt id=\"p1\">**</bpt>canEdit<ept id=\"p1\">**</ept> role.",
      "pos": [
        32594,
        32663
      ]
    },
    {
      "content": "If you get an HTTP 400 error with the message <bpt id=\"p1\">*</bpt>The redirect URI in the request: https://contactmanager{my version}.azurewebsites.net/signin-google did not match a registered redirect URI.<ept id=\"p1\">*</ept>, you'll have to wait until the changes you made are propagated.",
      "pos": [
        32664,
        32916
      ]
    },
    {
      "content": "If you get this error after more than a few minutes, verify the URIs are correct.",
      "pos": [
        32917,
        32998
      ]
    },
    {
      "content": "Stop the web app to prevent other people from registering",
      "pos": [
        33004,
        33061
      ]
    },
    {
      "pos": [
        33068,
        33117
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Server Explorer<ept id=\"p1\">**</ept>, navigate to <bpt id=\"p2\">**</bpt>Web Apps<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        33121,
        33168
      ],
      "content": "Right click on the web app and select <bpt id=\"p1\">**</bpt>Stop<ept id=\"p1\">**</ept>."
    },
    {
      "content": "stop web app",
      "pos": [
        33177,
        33189
      ]
    },
    {
      "pos": [
        33282,
        33452
      ],
      "content": "Alternatively, from the <bpt id=\"p1\">[</bpt>Azure Portal<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=529715)</ept>, you can select the web app, then click the <bpt id=\"p2\">**</bpt>stop<ept id=\"p2\">**</ept> icon at the bottom of the page."
    },
    {
      "content": "stop web app portal",
      "pos": [
        33460,
        33479
      ]
    },
    {
      "content": "Remove AddToRoleAsync, Publish, and Test",
      "pos": [
        33576,
        33616
      ]
    },
    {
      "pos": [
        33621,
        33807
      ],
      "content": "Comment out or remove the following code from the **ExternalLoginConfirmation** method in the Account controller: \n             `await UserManager.AddToRoleAsync(user.Id, \"canEdit\");`",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "Comment out or remove the following code from the <bpt id=\"p1\">**</bpt>ExternalLoginConfirmation<ept id=\"p1\">**</ept> method in the Account controller:",
          "pos": [
            0,
            113
          ]
        }
      ]
    },
    {
      "content": "Build the project (which saves the file changes and verifies you don't have any compile errors).",
      "pos": [
        33811,
        33907
      ]
    },
    {
      "pos": [
        33911,
        33983
      ],
      "content": "Right-click the project in <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Publish<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>Start Preview<ept id=\"p1\">**</ept> button.",
      "pos": [
        34129,
        34164
      ]
    },
    {
      "content": "Only the files that need to be updated are deployed.",
      "pos": [
        34165,
        34217
      ]
    },
    {
      "content": "Start the web app from Visual Studio or from the Portal.",
      "pos": [
        34221,
        34277
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>You won't be able to publish while the web app is stopped<ept id=\"p1\">**</ept>.",
      "pos": [
        34278,
        34340
      ]
    },
    {
      "content": "start web app",
      "pos": [
        34348,
        34361
      ]
    },
    {
      "pos": [
        34454,
        34501
      ],
      "content": "Go back to Visual Studio and click <bpt id=\"p1\">**</bpt>Publish<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Your Azure App opens up in your default browser.",
      "pos": [
        34505,
        34553
      ]
    },
    {
      "content": "If you are logged in, log out so you can view the home page as an anonymous user.",
      "pos": [
        34554,
        34635
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>About<ept id=\"p1\">**</ept> link.",
      "pos": [
        34641,
        34666
      ]
    },
    {
      "content": "You'll be redirected to the Log in page.",
      "pos": [
        34667,
        34707
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>Register<ept id=\"p1\">**</ept> link on the Log in page and create local account.",
      "pos": [
        34711,
        34783
      ]
    },
    {
      "content": "We will use this local account to verify you can access the read only pages but you cannot access pages that change data (which are protected by the <bpt id=\"p1\">*</bpt>canEdit<ept id=\"p1\">*</ept> role).",
      "pos": [
        34784,
        34949
      ]
    },
    {
      "content": "Later on in the tutorial we will remove local account access.",
      "pos": [
        34950,
        35011
      ]
    },
    {
      "content": "Register",
      "pos": [
        35020,
        35028
      ]
    },
    {
      "pos": [
        35121,
        35180
      ],
      "content": "Verify you can navigate to the <bpt id=\"p1\">*</bpt>About<ept id=\"p1\">*</ept> and <bpt id=\"p2\">*</bpt>Contact<ept id=\"p2\">*</ept> pages."
    },
    {
      "content": "Log off",
      "pos": [
        35188,
        35195
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>CM Demo<ept id=\"p1\">**</ept> link to navigate to the <bpt id=\"p2\">**</bpt>Cm<ept id=\"p2\">**</ept> controller.",
      "pos": [
        35288,
        35352
      ]
    },
    {
      "content": "Alternatively, you can append <bpt id=\"p1\">*</bpt>Cm<ept id=\"p1\">*</ept> to the URL.",
      "pos": [
        35353,
        35399
      ]
    },
    {
      "content": "CM page",
      "pos": [
        35408,
        35415
      ]
    },
    {
      "content": "Click an Edit link.",
      "pos": [
        35509,
        35528
      ]
    },
    {
      "content": "You will be redirected to the log in page.",
      "pos": [
        35529,
        35571
      ]
    },
    {
      "content": "Under <bpt id=\"p1\">**</bpt>Use another service to log in<ept id=\"p1\">**</ept>, Click Google or Facebook and log in with the account you previously registered.",
      "pos": [
        35572,
        35692
      ]
    },
    {
      "content": "(If you're working quickly and your session cookie has not timed out, you will be automatically logged in with the Google or Facebook account you previously used.)",
      "pos": [
        35693,
        35856
      ]
    },
    {
      "pos": [
        35860,
        36238
      ],
      "content": "Verify you can edit data while logged into that account.\n **Note:** You cannot log out of Google from this app and log into a different google account with the same browser. If you are using one browser, you will have to navigate to Google and log out. You can log on with another account from the same third party authenticator (such as Google) by using a different browser.",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "Verify you can edit data while logged into that account.",
          "pos": [
            0,
            56
          ]
        },
        {
          "content": " **Note:** You cannot log out of Google from this app and log into a different google account with the same browser. If you are using one browser, you will have to navigate to Google and log out. You can log on with another account from the same third party authenticator (such as Google) by using a different browser.",
          "pos": [
            57,
            375
          ],
          "nodes": [
            {
              "content": "<bpt id=\"p1\"> **</bpt>Note:<ept id=\"p1\">**</ept> You cannot log out of Google from this app and log into a different google account with the same browser.",
              "pos": [
                0,
                116
              ]
            },
            {
              "content": "If you are using one browser, you will have to navigate to Google and log out.",
              "pos": [
                117,
                195
              ]
            },
            {
              "content": "You can log on with another account from the same third party authenticator (such as Google) by using a different browser.",
              "pos": [
                196,
                318
              ]
            }
          ]
        }
      ]
    },
    {
      "content": "If you have not filled out the first and last name of your Google account information, a NullReferenceException will occur.",
      "pos": [
        36240,
        36363
      ]
    },
    {
      "content": "Examine the SQL Azure DB",
      "pos": [
        36369,
        36393
      ]
    },
    {
      "pos": [
        36401,
        36454
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Server Explorer<ept id=\"p1\">**</ept>, navigate to the <bpt id=\"p2\">**</bpt>ContactDB<ept id=\"p2\">**</ept>"
    },
    {
      "pos": [
        36458,
        36537
      ],
      "content": "Right click on <bpt id=\"p1\">**</bpt>ContactDB<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Open in SQL Server Object Explorer<ept id=\"p2\">**</ept>."
    },
    {
      "content": "open in SSOX",
      "pos": [
        36546,
        36558
      ]
    },
    {
      "content": "If you haven't connected to this database previously, you may be prompted to add a firewall rule to enable access for your current IP address.",
      "pos": [
        36653,
        36795
      ]
    },
    {
      "content": "The IP address will be pre-filled.",
      "pos": [
        36796,
        36830
      ]
    },
    {
      "content": "Simply, click <bpt id=\"p1\">**</bpt>Add Firewall Rule<ept id=\"p1\">**</ept> to enable access.",
      "pos": [
        36831,
        36884
      ]
    },
    {
      "content": "add firewall rule",
      "pos": [
        36892,
        36909
      ]
    },
    {
      "content": "Then, log in to the database with the user name and password that you specified when creating the database.",
      "pos": [
        37022,
        37129
      ]
    },
    {
      "pos": [
        37136,
        37202
      ],
      "content": "Right click on the <bpt id=\"p1\">**</bpt>AspNetUsers<ept id=\"p1\">**</ept> table and select <bpt id=\"p2\">**</bpt>View Data<ept id=\"p2\">**</ept>."
    },
    {
      "content": "CM page",
      "pos": [
        37210,
        37217
      ]
    },
    {
      "content": "Note the Id from the Google account you registered with to be in the <bpt id=\"p1\">**</bpt>canEdit<ept id=\"p1\">**</ept> role, and the Id of <bpt id=\"p2\">*</bpt>user1@contoso.com<ept id=\"p2\">*</ept>.",
      "pos": [
        37311,
        37432
      ]
    },
    {
      "content": "These should be the only users in the <bpt id=\"p1\">**</bpt>canEdit<ept id=\"p1\">**</ept> role.",
      "pos": [
        37433,
        37488
      ]
    },
    {
      "content": "(You'll verify that in the next step.)",
      "pos": [
        37489,
        37527
      ]
    },
    {
      "content": "CM page",
      "pos": [
        37535,
        37542
      ]
    },
    {
      "pos": [
        37634,
        37729
      ],
      "content": "In <bpt id=\"p1\">**</bpt>SQL Server Object Explorer<ept id=\"p1\">**</ept>, right click on <bpt id=\"p2\">**</bpt>AspNetUserRoles<ept id=\"p2\">**</ept> and select <bpt id=\"p3\">**</bpt>View Data<ept id=\"p3\">**</ept>."
    },
    {
      "content": "CM page",
      "pos": [
        37737,
        37744
      ]
    },
    {
      "pos": [
        37834,
        37922
      ],
      "content": "Verify the <bpt id=\"p1\">**</bpt>UserId<ept id=\"p1\">**</ept> is from <bpt id=\"p2\">*</bpt>user1@contoso.com<ept id=\"p2\">*</ept> and the Google account you registered."
    },
    {
      "content": "Next steps",
      "pos": [
        37929,
        37939
      ]
    },
    {
      "content": "Follow my tutorials which build on this sample:",
      "pos": [
        37941,
        37988
      ]
    },
    {
      "content": "Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset",
      "pos": [
        37995,
        38083
      ]
    },
    {
      "content": "ASP.NET MVC 5 app with SMS and email Two-Factor Authentication",
      "pos": [
        38213,
        38275
      ]
    },
    {
      "content": "Best practices for deploying passwords and other sensitive data to ASP.NET and Azure",
      "pos": [
        38393,
        38477
      ]
    },
    {
      "pos": [
        38619,
        38960
      ],
      "content": "<bpt id=\"p1\">[</bpt>Create an ASP.NET MVC 5 App with Facebook and Google OAuth2<ept id=\"p1\">](http://www.asp.net/mvc/tutorials/mvc-5/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on )</ept> This includes instructions on how to add profile data to the user registration DB and for detailed instructions on using Facebook as an authentication provider."
    },
    {
      "content": "Getting Started with ASP.NET MVC 5",
      "pos": [
        38966,
        39000
      ]
    },
    {
      "pos": [
        39072,
        39272
      ],
      "content": "To enable the social login buttons shown at the top of this tutorial, see <bpt id=\"p1\">[</bpt>Pretty social login buttons for ASP.NET MVC 5<ept id=\"p1\">](http://www.beabigrockstar.com/pretty-social-login-buttons-for-asp-net-mvc-5/)</ept>."
    },
    {
      "pos": [
        39274,
        39522
      ],
      "content": "Tom Dykstra's excellent <bpt id=\"p1\">[</bpt>Getting Started with EF and MVC<ept id=\"p1\">](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application)</ept> will show you more advanced MVC and EF programming."
    },
    {
      "pos": [
        39524,
        39792
      ],
      "content": "This tutorial and the sample application was written by <bpt id=\"p1\">[</bpt>Rick Anderson<ept id=\"p1\">](http://blogs.msdn.com/b/rickandy/)</ept> (Twitter <bpt id=\"p2\">[</bpt>@RickAndMSFT<ept id=\"p2\">](https://twitter.com/RickAndMSFT)</ept>) with assistance from Tom Dykstra and Barry Dorrans (Twitter <bpt id=\"p3\">[</bpt>@blowdart<ept id=\"p3\">](https://twitter.com/blowdart)</ept>)."
    },
    {
      "content": "<bpt id=\"p1\">***</bpt>Please leave feedback<ept id=\"p1\">***</ept> on what you liked or what you would like to see improved, not only about the tutorial itself but also about the products that it demonstrates.",
      "pos": [
        39795,
        39965
      ]
    },
    {
      "content": "Your feedback will help us prioritize improvements.",
      "pos": [
        39966,
        40017
      ]
    },
    {
      "content": "You can also request and vote on new topics at <bpt id=\"p1\">[</bpt>Show Me How With Code<ept id=\"p1\">](http://aspnet.uservoice.com/forums/228522-show-me-how-with-code)</ept>.",
      "pos": [
        40018,
        40154
      ]
    },
    {
      "content": "What's changed",
      "pos": [
        40159,
        40173
      ]
    },
    {
      "pos": [
        40176,
        40344
      ],
      "content": "For a guide to the change from Websites to App Service see: <bpt id=\"p1\">[</bpt>Azure App Service and Its Impact on Existing Azure Services<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=529714)</ept>"
    },
    {
      "pos": [
        40347,
        40506
      ],
      "content": "For a guide to the change of the old portal to the new portal see: <bpt id=\"p1\">[</bpt>Reference for navigating the preview portal<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=529715)</ept>"
    },
    {
      "content": "test",
      "pos": [
        43815,
        43819
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"Create an ASP.NET MVC app with auth and SQL DB and deploy to Azure App Service\" \n    description=\"Learn how to develop an ASP.NET MVC 5 app with a SQL Database back-end, add authentication and authorization, and deploy it to Azure.\" \n    services=\"app-service\\web\" \n    documentationCenter=\".net\" \n    authors=\"Rick-Anderson\" \n    writer=\"Rick-Anderson\" \n    manager=\"wpickett\" \n    editor=\"\"/>\n\n<tags \n    ms.service=\"app-service-web\" \n    ms.workload=\"web\" \n    ms.tgt_pltfrm=\"na\" \n    ms.devlang=\"dotnet\" \n    ms.topic=\"article\" \n    ms.date=\"08/07/2015\" \n    ms.author=\"riande\"/> \n\n\n\n# Create an ASP.NET MVC app with auth and SQL DB and deploy to Azure App Service\n\nThis tutorial shows you how to build a secure ASP.NET MVC 5 web app that enables users to log in with credentials from Facebook or Google. You will also deploy the application to [App Service](http://go.microsoft.com/fwlink/?LinkId=529714).\n\nYou can open an Azure account for free, and if you don't already have Visual Studio 2013, the SDK automatically installs Visual Studio 2013 for Web Express. You can start developing for Azure for free.\n\nThis tutorial assumes that you have no prior experience using Azure. On completing this tutorial, you'll have a secure data-driven web application up and running in the cloud and using a cloud database.\n\nYou'll learn:\n\n* How to create a secure ASP.NET MVC 5 project and publish it to [App Service Web Apps](http://go.microsoft.com/fwlink/?LinkId=529714) in Azure App Service.\n* How to use [OAuth](http://oauth.net/ \"http://oauth.net/\") and the ASP.NET membership database to secure your application.\n* How to use a SQL database to store data in Azure.\n\nYou'll build a simple contact list web app that is built on ASP.NET MVC 5 and uses the ADO.NET Entity Framework for database access. The following illustration shows the login page for the completed application:\n\n![login page][rxb]\n\n>[AZURE.NOTE] To create the pretty social login buttons in the screenshot above, please view the blog post entitled [Pretty social login buttons for ASP.NET MVC 5](http://www.jerriepelser.com/blog/pretty-social-login-buttons-for-asp-net-mvc-5)\n\n>[AZURE.NOTE] To complete this tutorial, you need a Microsoft Azure account. If you don't have an account, you can [activate your MSDN subscriber benefits](../en-us/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A261C142F) or [sign up for a free trial](../en-us/pricing/free-trial/?WT.mc_id=A261C142F).\n\n>If you want to get started with Azure App Service before signing up for an Azure account, go to [Try App Service](http://go.microsoft.com/fwlink/?LinkId=523751), where you can immediately create a short-lived starter web app in App Service. No credit cards required; no commitments.\n\nTo set up your development environment, you must install [Visual Studio 2013 Update 4](http://go.microsoft.com/fwlink/?LinkId=390521) or higher, and the latest version of the [Azure SDK for Visual Studio 2013](http://go.microsoft.com/fwlink/?linkid=324322&clcid=0x409). This article was written for Visual Studio Update 4 and SDK 2.5.1.\n\n## Create an ASP.NET MVC 5 application\n\n### Create the project\n\n1. From the **File** menu, click **New Project**.\n\n    ![New Project in File menu](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/gs13newproj.png)\n\n1. In the **New Project** dialog box, expand **C#** and select **Web** under **Installed Templates**, and then select **ASP.NET Web Application**.\n\n1. Name the application **ContactManager** and click **OK**.\n\n    ![New Project dialog box](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/GS13newprojdb.png)\n \n    **Note:** Make sure you enter \"ContactManager\". Code blocks that you'll be copying later assume that the project name is ContactManager. \n\n1. In the **New ASP.NET Project** dialog box, select the **MVC** template. Verify **Authentication** is set to **Individual User Accounts**, **Host in the cloud** is checked and **Web App** is selected.\n\n    ![New ASP.NET Project dialog box](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/newproject.png)\n\n1. The configuration wizard will suggest a unique name based on *ContactManager*. You must decide whether to create a new App Service plan and resource group. For guidance on deciding whether to create a new plan or resource group, see [Azure App Service plans in-depth overview](../app-service/azure-web-sites-web-hosting-plans-in-depth-overview.md). For this tutorial, you will probably want to create at least a new resource group. Select a region near you. You can use [azurespeed.com](http://www.azurespeed.com/ \"AzureSpeed.com\") to find the lowest latency data center. You will set up the database in the next step so do not click **OK** yet.\n\n    ![New plan and resource group](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/newplanandgroup.png)\n \n2. If you haven't created a database server before, select **Create new server**, enter a database name, user name, and password.\n\n    ![Use new database](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/newdb.png)\n\n3. If you have a database server, use that to create a new database. Database servers are a precious resource, and you generally want to create multiple databases on the same server for testing and development rather than creating a database server per database. Make sure your web app and database are in the same region.\n\n    ![Use exsiting database](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/useexistingdb.png)\n\n### Set the page header and footer\n\n\n1. In **Solution Explorer** open the *Layout.cshtml* file in the *Views\\Shared* folder.\n\n    ![_Layout.cshtml in Solution Explorer][newapp004]\n\n1. Replace the markup in the  *Layout.cshtml* file with the following code. The changes are highlighted below.\n\n        <!DOCTYPE html>\n        <html>\n        <head>\n            <meta charset=\"utf-8\" />\n            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n            <title>@ViewBag.Title - Contact Manager</title>\n            @Styles.Render(\"~/Content/css\")\n            @Scripts.Render(\"~/bundles/modernizr\")\n        \n        </head>\n        <body>\n            <div class=\"navbar navbar-inverase navbar-fixed-top\">\n                <div class=\"container\">\n                    <div class=\"navbar-header\">\n                        <button type=\"button\" class=\"navbar-toggle\" data-toggle=\"collapse\" data-target=\".navbar-collapse\">\n                            <span class=\"icon-bar\"></span>\n                            <span class=\"icon-bar\"></span>\n                            <span class=\"icon-bar\"></span>\n                        </button>\n                        @Html.ActionLink(\"CM Demo\", \"Index\", \"Cm\", new { area = \"\" }, new { @class = \"navbar-brand\" })\n                    </div>\n                    <div class=\"navbar-collapse collapse\">\n                        <ul class=\"nav navbar-nav\">\n                            <li>@Html.ActionLink(\"Home\", \"Index\", \"Home\")</li>\n                            <li>@Html.ActionLink(\"About\", \"About\", \"Home\")</li>\n                            <li>@Html.ActionLink(\"Contact\", \"Contact\", \"Home\")</li>\n                        </ul>\n                        @Html.Partial(\"_LoginPartial\")\n                    </div>\n                </div>\n            </div>\n            <div class=\"container body-content\">\n                @RenderBody()\n                <hr />\n                <footer>\n                    <p>&copy; @DateTime.Now.Year - Contact Manager</p>\n                </footer>\n            </div>\n        \n            @Scripts.Render(\"~/bundles/jquery\")\n            @Scripts.Render(\"~/bundles/bootstrap\")\n            @RenderSection(\"scripts\", required: false)\n        </body>\n        </html>\n\n### Run the application locally\n\n1. Press CTRL+F5 to run the app.\n\n    The application home page appears in the default browser.\n\n    ![Web app running locally](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rr2.png)\n\nThis is all you need to do for now to create the application that you'll deploy to Azure. \n\n## Enable SSL for the Project ##\n\n1. Enable SSL. In Solution Explorer, click the **ContactManager** project, then click F4 to bring up the properties dialog. Change **SSL Enabled** to true. Copy the **SSL URL**. The SSL URL will be https://localhost:44300/ unless you've previously created SSL web apps.\n\n    ![enable SSL][rxSSL]\n \n1. In Solution Explorer, right click the **Contact Manager** project and click **Properties**.\n1. In the left tab, click **Web**.\n1. Change the **Project Url** to use the **SSL URL** and save the page (Control S).\n\n    ![enable SSL](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rrr1.png)\n \n1. Verify Internet Explorer is the browser Visual Studio launches as shown in the image below:\n\n    ![default browser](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/ss12.PNG)\n\n    The browser selector lets you specify the browser Visual Studio launches.\n\n    ![browser selector](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/ss13.png)\n\n    You can select multiple browsers and have Visual Studio update each browser when you make changes. For more information see [Using Browser Link in Visual Studio 2013](http://www.asp.net/visual-studio/overview/2013/using-browser-link).\n\n\n1. Press CTRL+F5 to run the application. Follow the instructions to trust the self-signed certificate that IIS Express has generated.\n\n     ![instructions to trust the self-signed certificate that IIS Express has generated](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/ss26.PNG)\n\n1. Read the **Security Warning** dialog and then click **Yes** if you want to install the certificate representing  **localhost**.\n\n    ![localhost IIS Express certificate warning ](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/ss27.PNG)\n\n1. IE shows the *Home* page and there are no SSL warnings.\n\n     ![IE with localhost SSL and no warnings](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/ss28.PNG)\n\n    Google Chrome also accepts the certificate and will show HTTPS content without a warning. Firefox uses its own certificate store, so it will display a warning.\n\n     ![FireFox Cert Warning](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/ss30.PNG)\n\n## Deploy the application to Azure\n\n1. In Visual Studio, right-click the project in **Solution Explorer** and select **Publish** from the context menu.\n\n    ![Publish in project context menu](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/GS13publish.png)\n    \n    The **Publish Web** wizard opens.\n\n1. In the **Publish Web** dialog box, click **Publish**.\n\n    ![Publish](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rr3.png)\n\n    The application you created is now running in the cloud. The next time you deploy the application, only the changed (or new) files will be deployed.\n\n    ![Running in Cloud](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/ss4.PNG)\n\n## Add a database to the application\n\nNext, you'll update the app to add the ability to display and update contacts and store the data in a database. The app will use the Entity Framework (EF) to create the database and to read and update data.\n\n### Add data model classes for the contacts\n\nYou begin by creating a simple data model in code.\n\n1. In **Solution Explorer**, right-click the Models folder, click **Add**, and then **Class**.\n\n    ![Add Class in Models folder context menu](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rr5.png)\n\n2. In the **Add New Item** dialog box, name the new class file *Contact.cs*, and then click **Add**.\n\n    ![Add New Item dialog box][adddb002]\n\n3. Replace the contents of the Contacts.cs file with the following code.\n\n        using System.ComponentModel.DataAnnotations;\n        using System.Globalization;\n        namespace ContactManager.Models\n        {\n            public class Contact\n            {\n                public int ContactId { get; set; }\n                public string Name { get; set; }\n                public string Address { get; set; }\n                public string City { get; set; }\n                public string State { get; set; }\n                public string Zip { get; set; }\n                [DataType(DataType.EmailAddress)]\n                public string Email { get; set; }\n            }\n        }\nThe **Contacts** class defines the data that you will store for each contact, plus a primary key, *ContactID*, that is needed by the database.\n\n### Create web pages that enable app users to work with the contacts\n\nThe ASP.NET MVC scaffolding feature can automatically generate code that performs create, read, update, and delete (CRUD) actions.\n\n## Add a Controller and a view for the data\n\n1. Build the project **(Ctrl+Shift+B)**. (You must build the project before using the scaffolding mechanism.) \n1. In **Solution Explorer**, right-click the Controllers folder and click **Add**, and then click **Controller**.\n\n    ![Add Controller in Controllers folder context menu][addcode001]\n\n5. In the **Add Scaffold** dialog box, select **MVC 5 Controller with views, using EF** and then click **Add**.\n    \n    ![Add Scaffold dlg](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rr6.png)\n\n\n1. In the **Model class** dropdown box, select **Contact (ContactManager.Models)**. (See the image below.)\n1. In the **Data context class**, select **ApplicationDbContext (ContactManager.Models)**. The **ApplicationDbContext** will be used for both the membership DB and our contact data.\n1. In the **Controller name** text entry box, enter \"CmController\" for the controller name. \n\n    ![New data ctx dlg](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/ss5.PNG)\n\n1. Click **Add**.\n\n   Visual Studio creates a controller methods and views for CRUD database operations for **Contact** objects.\n\n## Enable Migrations, create the database, add sample data and a data initializer ##\n\nThe next task is to enable the [Code First Migrations](http://msdn.microsoft.com/library/hh770484.aspx) feature in order to create the database based on the data model you created.\n\n1. In the **Tools** menu, select **NuGet Package Manager** and then **Package Manager Console**.\n    ![Package Manager Console in Tools menu](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/SS6.png)\n\n2. In the **Package Manager Console** window, enter the following command:\n\n        enable-migrations\n    The **enable-migrations** command creates a *Migrations* folder, and it puts in that folder a *Configuration.cs* file that you can edit to seed the database and configure Migrations. \n\n2. In the **Package Manager Console** window, enter the following command:\n\n        add-migration Initial\n\n\n    The **add-migration Initial** command generates a file named **&lt;date_stamp&gt;Initial** in the *Migrations* folder that creates the database. The first parameter ( **Initial** ) is arbitrary and is used to create the name of the file. You can see the new class files in **Solution Explorer**.\n    In the **Initial** class, the **Up** method creates the Contacts table, and the **Down** method (used when you want to return to the previous state) drops it.\n3. Open the *Migrations\\Configuration.cs* file. \n4. Add the following namespace. \n\n         using ContactManager.Models;\n\n\n\n5. Replace the *Seed* method with the following code:\n\n        protected override void Seed(ContactManager.Models.ApplicationDbContext context)\n        {\n            context.Contacts.AddOrUpdate(p => p.Name,\n               new Contact\n               {\n                   Name = \"Debra Garcia\",\n                   Address = \"1234 Main St\",\n                   City = \"Redmond\",\n                   State = \"WA\",\n                   Zip = \"10999\",\n                   Email = \"debra@example.com\",\n               },\n                new Contact\n                {\n                    Name = \"Thorsten Weinrich\",\n                    Address = \"5678 1st Ave W\",\n                    City = \"Redmond\",\n                    State = \"WA\",\n                    Zip = \"10999\",\n                    Email = \"thorsten@example.com\",\n                },\n                new Contact\n                {\n                    Name = \"Yuhong Li\",\n                    Address = \"9012 State st\",\n                    City = \"Redmond\",\n                    State = \"WA\",\n                    Zip = \"10999\",\n                    Email = \"yuhong@example.com\",\n                },\n                new Contact\n                {\n                    Name = \"Jon Orton\",\n                    Address = \"3456 Maple St\",\n                    City = \"Redmond\",\n                    State = \"WA\",\n                    Zip = \"10999\",\n                    Email = \"jon@example.com\",\n                },\n                new Contact\n                {\n                    Name = \"Diliana Alexieva-Bosseva\",\n                    Address = \"7890 2nd Ave E\",\n                    City = \"Redmond\",\n                    State = \"WA\",\n                    Zip = \"10999\",\n                    Email = \"diliana@example.com\",\n                }\n                );\n        }\n\n    This code initializes (seeds) the database with the contact information. For more information on seeding the database, see [Seeding and Debugging Entity Framework (EF) DBs](http://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx).\n\n\n6. In the **Package Manager Console** enter the command:\n\n        update-database\n\n    ![Package Manager Console commands][addcode009]\n\n    The **update-database** runs the first migration which creates the database. By default, the database is created as a SQL Server Express LocalDB database. \n\n7. Press CTRL+F5 to run the application, and then click the **CM Demo** link; or navigate to https://localhost:(port#)/Cm. \n\n    The application shows the seed data and provides edit, details and delete links. You can create, edit, delete and view data.\n\n    ![MVC view of data][rx2]\n\n\n\n## Add an OAuth2 Provider\n\n[OAuth](http://oauth.net/ \"http://oauth.net/\") is an open protocol that allows secure authorization in a simple and standard method from web, mobile, and desktop applications. The ASP.NET MVC internet template uses OAuth to expose Facebook, Twitter, Google and Microsoft as authentication providers. Although this tutorial uses only Google as the authentication provider, you can easily modify the code to use any of these providers. The steps to implement other providers are very similar to the steps you will see in this tutorial. To use Facebook as an authentication provider, see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on ](http://www.asp.net/mvc/tutorials/mvc-5/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on).\n\nIn addition to authentication, the tutorial will also use roles to implement authorization. Only those users you add to the *canEdit* role will be able to change data (that is, create, edit, or delete contacts).\n\nFollow the instructions in my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on ](http://www.asp.net/mvc/tutorials/mvc-5/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on#goog)  under **Creating a Google app for OAuth 2 to set up a Google app for OAuth2**. Run and test the app to verify you can log on using Google authentication.\n\n## Using the Membership API\nIn this section you will add a local user and the *canEdit* role to the membership database. Only those users in the *canEdit* role will be able to edit data. A best practice is to name roles by the actions they can perform, so *canEdit* is preferred over a role called *admin*. When your application evolves you can add new roles such as *canDeleteMembers* rather than the less descriptive *superAdmin*.\n\n1. Open the *migrations\\configuration.cs* file and add the following `using` statements:\n\n        using Microsoft.AspNet.Identity;\n        using Microsoft.AspNet.Identity.EntityFramework;\n\n1. Add the following **AddUserAndRole** method to the class:\n\n         bool AddUserAndRole(ContactManager.Models.ApplicationDbContext context)\n         {\n            IdentityResult ir;\n            var rm = new RoleManager\n                (new RoleStore(context));\n            ir = rm.Create(new IdentityRole(\"canEdit\"));\n            var um = new UserManager(\n                new UserStore(context));\n            var user = new ApplicationUser()\n            {\n               UserName = \"user1@contoso.com\",\n            };\n            ir = um.Create(user, \"P_assw0rd1\");\n            if (ir.Succeeded == false)\n               return ir.Succeeded;\n            ir = um.AddToRole(user.Id, \"canEdit\");\n            return ir.Succeeded;\n         }\n\n1. Call the new method from the **Seed** method:\n\n        protected override void Seed(ContactManager.Models.ApplicationDbContext context)\n        {\n            AddUserAndRole(context);\n            context.Contacts.AddOrUpdate(p => p.Name,\n                // Code removed for brevity\n        }\n\n    The following images shows the changes to *Seed* method:\n\n    ![code image](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/ss24.PNG)\n\n    This code creates a new role called *canEdit*, creates a new local user *user1@contoso.com*, and adds *user1@contoso.com* to the *canEdit* role. For more information, see my [ASP.NET Identity tutorials](http://www.asp.net/identity/overview/features-api).\n\n## Use Temporary Code to Add New Social Login Users to the canEdit Role  ##\nIn this section you will temporarily modify the **ExternalLoginConfirmation** method in the Account controller to add new users registering with an OAuth provider to the *canEdit* role. We will temporarily modify the **ExternalLoginConfirmation** method to automatically add new users to an administrative role. Until we provide a tool to add and manage roles, we'll use the temporary automatic registration code below. We hope to provide a tool similar to [WSAT](http://msdn.microsoft.com/en-us/library/ms228053.aspx) in the future which allow you to create and edit user accounts and roles. \n\n1. Open the **Controllers\\AccountController.cs** file and navigate to the **ExternalLoginConfirmation** method.\n1. Add the following call to **AddToRoleAsync** just before the **SignInAsync** call.\n\n        await UserManager.AddToRoleAsync(user.Id, \"canEdit\");\n\n   The code above adds the newly registered user to the \"canEdit\" role, which gives them access to action methods that change (edit) data.\n\n          // POST: /Account/ExternalLoginConfirmation\n          [HttpPost]\n          [AllowAnonymous]\n          [ValidateAntiForgeryToken]\n          public async Task ExternalLoginConfirmation(ExternalLoginConfirmationViewModel model, string returnUrl)\n          {\n             if (User.Identity.IsAuthenticated)\n             {\n                return RedirectToAction(\"Index\", \"Manage\");\n             }\n             if (ModelState.IsValid)\n             {\n                // Get the information about the user from the external login provider\n                var info = await AuthenticationManager.GetExternalLoginInfoAsync();\n                if (info == null)\n                {\n                   return View(\"ExternalLoginFailure\");\n                }\n                var user = new ApplicationUser { UserName = model.Email, Email = model.Email };\n                var result = await UserManager.CreateAsync(user);\n                if (result.Succeeded)\n                {\n                   result = await UserManager.AddLoginAsync(user.Id, info.Login);\n                   if (result.Succeeded)\n                   {\n                      await UserManager.AddToRoleAsync(user.Id, \"canEdit\");\n                      await SignInManager.SignInAsync(user, isPersistent: false, rememberBrowser: false);\n                      return RedirectToLocal(returnUrl);\n                   }\n                }\n                AddErrors(result);\n             }\n             ViewBag.ReturnUrl = returnUrl;\n             return View(model);\n          }\n\nLater in the tutorial you will deploy the application to Azure, where you will log-on with Google or another third party authentication provider. This will add your newly registered account to the *canEdit* role. Anyone who finds your web app's URL and has a Google ID can then register and update your database. To prevent other people from doing that, you can stop the site. You'll be able to verify who is in the *canEdit* role by examining the database.\n\nIn the **Package Manager Console** hit the up arrow key to bring up the following command:\n\n        Update-Database\n\nRun the  **Update-Database** command which will run the **Seed** method, and that will run the **AddUserAndRole** you just added. The **AddUserAndRole** will create the user *user1@contoso.com* and add her to the *canEdit* role.\n\n## Protect the Application with SSL and the Authorize Attribute ##\n\nIn this section you will apply the [Authorize](http://msdn.microsoft.com/library/system.web.mvc.authorizeattribute.aspx) attribute to restrict access to the action methods. Anonymous users will be able to view the **Index** action method of the home controller only. Registered users will be able to see contact data (The **Index** and **Details** pages of the Cm controller), the About, and the Contact pages. Only users in the *canEdit* role will be able to access action methods that change data.\n\n1. Add the [Authorize](http://msdn.microsoft.com/library/system.web.mvc.authorizeattribute.aspx) filter and the [RequireHttps](http://msdn.microsoft.com/library/system.web.mvc.requirehttpsattribute.aspx) filter to the application. An alternative approach is to add the [Authorize](http://msdn.microsoft.com/library/system.web.mvc.authorizeattribute.aspx) attribute and the [RequireHttps](http://msdn.microsoft.com/library/system.web.mvc.requirehttpsattribute.aspx) attribute to each controller, but it's considered a security best practice to apply them to the entire application. By adding them globally, every new controller and action method you add will automatically be protected, you won't need to remember to apply them. For more information see [Securing your ASP.NET MVC  App and the new AllowAnonymous Attribute](http://blogs.msdn.com/b/rickandy/archive/2012/03/23/securing-your-asp-net-mvc-4-app-and-the-new-allowanonymous-attribute.aspx). Open the *App_Start\\FilterConfig.cs* file and replace the *RegisterGlobalFilters* method with the following (which adds the two filters):\n\n        public static void\n        RegisterGlobalFilters(GlobalFilterCollection filters)\n        {\n            filters.Add(new HandleErrorAttribute());\n            filters.Add(new System.Web.Mvc.AuthorizeAttribute());\n            filters.Add(new RequireHttpsAttribute());\n        }\n        \n    The [Authorize](http://msdn.microsoft.com/library/system.web.mvc.authorizeattribute.aspx) filter applied in the code above will prevent anonymous users from accessing any methods in the application. You will use the [AllowAnonymous](http://blogs.msdn.com/b/rickandy/archive/2012/03/23/securing-your-asp-net-mvc-4-app-and-the-new-allowanonymous-attribute.aspx) attribute to opt out of the authorization requirement in a couple methods, so anonymous users can log in and can view the home page. The  [RequireHttps](http://msdn.microsoft.com/library/system.web.mvc.requirehttpsattribute.aspx) will require all access to the web app be through HTTPS.\n\n1. Add the [AllowAnonymous](http://blogs.msdn.com/b/rickandy/archive/2012/03/23/securing-your-asp-net-mvc-4-app-and-the-new-allowanonymous-attribute.aspx) attribute to the **Index** method of the Home controller. The [AllowAnonymous](http://blogs.msdn.com/b/rickandy/archive/2012/03/23/securing-your-asp-net-mvc-4-app-and-the-new-allowanonymous-attribute.aspx) attribute enables you to white-list the methods you want to opt out of authorization. \n\n        public class HomeController : Controller\n        {\n          [AllowAnonymous]\n          public ActionResult Index()\n          {\n             return View();\n          }\n\n2. Do a global search for *AllowAnonymous*, you can see it is used in the log in and registration methods of the Account controller.\n1. In *CmController.cs*, add `[Authorize(Roles = \"canEdit\")]` to the HttpGet and HttpPost methods that change data (Create, Edit, Delete, every action method except Index and Details) in the *Cm* controller. A portion of the completed code is shown below: \n\n        // GET: Cm/Create\n        [Authorize(Roles = \"canEdit\")]\n        public ActionResult Create()\n        {\n           return View(new Contact { Address = \"123 N 456 W\",\n            City=\"Great Falls\", Email = \"ab@cd.com\", Name=\"Joe Smith\", State=\"MT\",\n           Zip = \"59405\"});\n        }\n        // POST: Cm/Create\n        // To protect from overposting attacks, please enable the specific properties you want to bind to, for \n        // more details see http://go.microsoft.com/fwlink/?LinkId=317598.\n        [HttpPost]\n        [ValidateAntiForgeryToken]\n         [Authorize(Roles = \"canEdit\")]\n        public ActionResult Create([Bind(Include = \"ContactId,Name,Address,City,State,Zip,Email\")] Contact contact)\n        {\n            if (ModelState.IsValid)\n            {\n                db.Contacts.Add(contact);\n                db.SaveChanges();\n                return RedirectToAction(\"Index\");\n            }\n            return View(contact);\n        }\n        // GET: Cm/Edit/5\n        [Authorize(Roles = \"canEdit\")]\n        public ActionResult Edit(int? id)\n        {\n            if (id == null)\n            {\n                return new HttpStatusCodeResult(HttpStatusCode.BadRequest);\n            }\n            Contact contact = db.Contacts.Find(id);\n            if (contact == null)\n            {\n                return HttpNotFound();\n            }\n            return View(contact);\n        }\n        \n1. If you are still logged in from a previous session, hit the **Log out** link.\n1. Click on the **About** or **Contact** links. You will be redirected to the log in page because anonymous users cannot view those pages. \n1. Click the **Register as a new user** link and add a local user with email *joe@contoso.com*. Verify *Joe* can view the Home, About and Contact pages. \n\n    ![login](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/ss14.PNG)\n\n1. Click the *CM Demo* link and verify you see the data. \n1. Click an edit link on the page, you will be redirected to the log in page (because a new local user is not added to the *canEdit* role).\n1. Log in as *user1@contoso.com* with password of \"P_assw0rd1\" (the \"0\" in \"word\" is a zero). You will be redirected to the edit page you previously selected. <br/>\n   If you can't log in with that account and password, try copying the password from the source code and pasting it. If you still can't log in, check the **UserName** column of the **AspNetUsers** table to verify *user1@contoso.com* was added. \n\n1. Verify you can make data changes.\n\n## Deploy the app to Azure\n\n1. In Visual Studio, right-click the project in **Solution Explorer** and select **Publish** from the context menu.\n\n    ![Publish in project context menu][firsdeploy003]\n\n    The **Publish Web** wizard opens.\n\n1. Click the **Settings** tab on the left side of the **Publish Web** dialog box. Click the **v** icon to select the **Remote connection string** for **ApplicationDbContext** and select the  **ContactManagerNN_db**.\n\n   \n    ![settings](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rrc2.png)\n\n1. Under **ContactManagerContext**, select **Execute Code First Migrations**.\n\n    ![settings](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rrc3.png)\n\n1. Click **Publish**.\n1. Log in as *user1@contoso.com* (with password of \"P_assw0rd1\") and verify you can edit data.\n1. Log out.\n1. Go to the [Google Developers Console](https://console.developers.google.com/) and on the **Credentials** tab update the redirect URIS and JavaScript Orgins to use the Azure URL.\n1. Log in using Google or Facebook. That will add the Google or Facebook account to the **canEdit** role. If you get an HTTP 400 error with the message *The redirect URI in the request: https://contactmanager{my version}.azurewebsites.net/signin-google did not match a registered redirect URI.*, you'll have to wait until the changes you made are propagated. If you get this error after more than a few minutes, verify the URIs are correct.\n\n### Stop the web app to prevent other people from registering  \n\n1. In **Server Explorer**, navigate to **Web Apps**.\n4. Right click on the web app and select **Stop**. \n\n    ![stop web app](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/s1.png) \n\n    Alternatively, from the [Azure Portal](http://go.microsoft.com/fwlink/?LinkId=529715), you can select the web app, then click the **stop** icon at the bottom of the page.\n\n    ![stop web app portal](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/stopweb.png)\n\n### Remove AddToRoleAsync, Publish, and Test\n\n1. Comment out or remove the following code from the **ExternalLoginConfirmation** method in the Account controller: \n                `await UserManager.AddToRoleAsync(user.Id, \"canEdit\");`\n1. Build the project (which saves the file changes and verifies you don't have any compile errors).\n5. Right-click the project in **Solution Explorer** and select **Publish**.\n\n       ![Publish in project context menu](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/GS13publish.png)\n    \n4. Click the **Start Preview** button. Only the files that need to be updated are deployed.\n5. Start the web app from Visual Studio or from the Portal. **You won't be able to publish while the web app is stopped**.\n\n    ![start web app](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/ss15.png)\n\n5. Go back to Visual Studio and click **Publish**.\n3. Your Azure App opens up in your default browser. If you are logged in, log out so you can view the home page as an anonymous user.  \n4. Click the **About** link. You'll be redirected to the Log in page.\n5. Click the **Register** link on the Log in page and create local account. We will use this local account to verify you can access the read only pages but you cannot access pages that change data (which are protected by the *canEdit* role). Later on in the tutorial we will remove local account access. \n\n    ![Register](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/ss16.PNG)\n\n1. Verify you can navigate to the *About* and *Contact* pages.\n\n    ![Log off](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/ss17.PNG)\n\n1. Click the **CM Demo** link to navigate to the **Cm** controller. Alternatively, you can append *Cm* to the URL. \n\n    ![CM page](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rrr4.png)\n \n1. Click an Edit link. You will be redirected to the log in page. Under **Use another service to log in**, Click Google or Facebook and log in with the account you previously registered. (If you're working quickly and your session cookie has not timed out, you will be automatically logged in with the Google or Facebook account you previously used.)\n2. Verify you can edit data while logged into that account.\n    **Note:** You cannot log out of Google from this app and log into a different google account with the same browser. If you are using one browser, you will have to navigate to Google and log out. You can log on with another account from the same third party authenticator (such as Google) by using a different browser.\n\nIf you have not filled out the first and last name of your Google account information, a NullReferenceException will occur.\n\n\n## Examine the SQL Azure DB ##\n\n1. In **Server Explorer**, navigate to the **ContactDB**\n2. Right click on **ContactDB** and select **Open in SQL Server Object Explorer**.\n \n    ![open in SSOX](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rrr12.png)\n \n3. If you haven't connected to this database previously, you may be prompted to add a firewall rule to enable access for your current IP address. The IP address will be pre-filled. Simply, click **Add Firewall Rule** to enable access.\n\n    ![add firewall rule](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/addfirewallrule.png)\n        \n    Then, log in to the database with the user name and password that you specified when creating the database. \n \n1. Right click on the **AspNetUsers** table and select **View Data**.\n\n    ![CM page](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rrr8.png)\n \n1. Note the Id from the Google account you registered with to be in the **canEdit** role, and the Id of *user1@contoso.com*. These should be the only users in the **canEdit** role. (You'll verify that in the next step.)\n\n    ![CM page](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/s2.png)\n \n2. In **SQL Server Object Explorer**, right click on **AspNetUserRoles** and select **View Data**.\n\n    ![CM page](./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rs1.png)\n \nVerify the **UserId** is from *user1@contoso.com* and the Google account you registered. \n\n\n## Next steps\n\nFollow my tutorials which build on this sample:\n\n1.  [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](http://www.asp.net/mvc/overview/getting-started/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset)\n2.  [ASP.NET MVC 5 app with SMS and email Two-Factor Authentication](http://www.asp.net/mvc/overview/getting-started/aspnet-mvc-5-app-with-sms-and-email-two-factor-authentication)\n3.  [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure) \n4.  [Create an ASP.NET MVC 5 App with Facebook and Google OAuth2](http://www.asp.net/mvc/tutorials/mvc-5/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on ) This includes instructions on how to add profile data to the user registration DB and for detailed instructions on using Facebook as an authentication provider.\n5.  [Getting Started with ASP.NET MVC 5](http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started)\n\nTo enable the social login buttons shown at the top of this tutorial, see [Pretty social login buttons for ASP.NET MVC 5](http://www.beabigrockstar.com/pretty-social-login-buttons-for-asp-net-mvc-5/).\n\nTom Dykstra's excellent [Getting Started with EF and MVC](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application) will show you more advanced MVC and EF programming.\n\nThis tutorial and the sample application was written by [Rick Anderson](http://blogs.msdn.com/b/rickandy/) (Twitter [@RickAndMSFT](https://twitter.com/RickAndMSFT)) with assistance from Tom Dykstra and Barry Dorrans (Twitter [@blowdart](https://twitter.com/blowdart)). \n\n***Please leave feedback*** on what you liked or what you would like to see improved, not only about the tutorial itself but also about the products that it demonstrates. Your feedback will help us prioritize improvements. You can also request and vote on new topics at [Show Me How With Code](http://aspnet.uservoice.com/forums/228522-show-me-how-with-code).\n\n## What's changed\n* For a guide to the change from Websites to App Service see: [Azure App Service and Its Impact on Existing Azure Services](http://go.microsoft.com/fwlink/?LinkId=529714)\n* For a guide to the change of the old portal to the new portal see: [Reference for navigating the preview portal](http://go.microsoft.com/fwlink/?LinkId=529715)\n\n<!-- bookmarks -->\n[Add an OAuth Provider]: #addOauth\n[Using the Membership API]:#mbrDB\n[Create a Data Deployment Script]:#ppd\n[Update the Membership Database]:#ppd2\n\n[setupwindowsazureenv]: #bkmk_setupwindowsazure\n[createapplication]: #bkmk_createmvc4app\n[deployapp1]: #bkmk_deploytowindowsazure1\n[deployapp11]: #bkmk_deploytowindowsazure11\n[adddb]: #bkmk_addadatabase\n\n\n<!-- images-->\n[rx2]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rx2.png\n\n[rx5]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rx5.png\n[rx6]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rx6.png\n[rx7]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rx7.png\n[rx8]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rx8.png\n[rx9]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rx9.png\n\n[rxb]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rxb.png\n\n\n[rxSSL]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/rxSSL.png\n\n[rxNOT]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rxNOT.png\n[rxNOT2]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rxNOT2.png\n\n[rxNOT]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rxNOT.png\n[rxNOT]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rxNOT.png\n[rxNOT]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rxNOT.png\n[rr1]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rr1.png\n\n[rxPrevDB]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rxPrevDB.png\n\n[rxWSnew]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rxWSnew2.png\n[rxCreateWSwithDB]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/rxCreateWSwithDB.png\n\n[setup007]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/dntutmobile-setup-azure-site-004.png\n\n[newapp004]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/dntutmobile-createapp-004.png\n\n[firsdeploy003]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/dntutmobile-deploy1-publish-001.png\n\n[adddb002]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/dntutmobile-adddatabase-002.png\n[addcode001]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/dntutmobile-controller-add-context-menu.png\n\n[addcode008]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/dntutmobile-migrations-package-manager-menu.png\n[addcode009]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database/dntutmobile-migrations-package-manager-console.png\n\n\n[Important information about ASP.NET in Azure web apps]: #aspnetwindowsazureinfo\n[Next steps]: #nextsteps\n\n[ImportPublishSettings]: ./media/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database-vs2013/ImportPublishSettings.png\n \n\ntest\n"
}