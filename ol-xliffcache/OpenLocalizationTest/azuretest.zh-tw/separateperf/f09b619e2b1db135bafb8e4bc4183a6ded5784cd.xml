{
  "nodes": [
    {
      "content": "Shard map management",
      "pos": [
        28,
        48
      ]
    },
    {
      "content": "How to use the ShardMapManager, elastic database client library",
      "pos": [
        68,
        131
      ]
    },
    {
      "content": "Shard map management",
      "pos": [
        449,
        469
      ]
    },
    {
      "content": "In a sharded database environment, a <bpt id=\"p1\">**</bpt>shard map<ept id=\"p1\">**</ept> maintains information allowing an application to connect to the correct database based upon the value of the <bpt id=\"p2\">**</bpt>sharding key<ept id=\"p2\">**</ept>.",
      "pos": [
        470,
        647
      ]
    },
    {
      "content": "Understanding how these maps are constructed is crucial to managing shards with the elastic database client library.",
      "pos": [
        648,
        764
      ]
    },
    {
      "content": "Shard maps and shard mappings",
      "pos": [
        769,
        798
      ]
    },
    {
      "content": "Supported .Net types for sharding keys",
      "pos": [
        805,
        843
      ]
    },
    {
      "content": "Elastic Scale support the following .Net Framework types as sharding keys:",
      "pos": [
        845,
        919
      ]
    },
    {
      "content": "integer",
      "pos": [
        923,
        930
      ]
    },
    {
      "content": "long",
      "pos": [
        933,
        937
      ]
    },
    {
      "content": "guid",
      "pos": [
        940,
        944
      ]
    },
    {
      "content": "byte[]",
      "pos": [
        947,
        953
      ]
    },
    {
      "content": "datetime",
      "pos": [
        958,
        966
      ]
    },
    {
      "content": "timespan",
      "pos": [
        969,
        977
      ]
    },
    {
      "content": "datetimeoffset",
      "pos": [
        980,
        994
      ]
    },
    {
      "content": "List and range shard maps",
      "pos": [
        1000,
        1025
      ]
    },
    {
      "pos": [
        1026,
        1174
      ],
      "content": "Shard maps can be constructed using <bpt id=\"p1\">**</bpt>lists of individual sharding key values<ept id=\"p1\">**</ept>, or they can be constructed using <bpt id=\"p2\">**</bpt>ranges of sharding key values<ept id=\"p2\">**</ept>."
    },
    {
      "content": "List shard maps",
      "pos": [
        1180,
        1195
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Shards<ept id=\"p1\">**</ept> contain <bpt id=\"p2\">**</bpt>shardlets<ept id=\"p2\">**</ept> and the mapping of shardlets to shards is maintained by a shard map.",
      "pos": [
        1196,
        1297
      ]
    },
    {
      "content": "A <bpt id=\"p1\">**</bpt>list shard map<ept id=\"p1\">**</ept> is an association between the individual key values that identify the shardlets and the databases that serve as shards.",
      "pos": [
        1298,
        1438
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>List mappings<ept id=\"p1\">**</ept> are explicit (for example, key 1 maps to Database A) and different key values can be mapped to the same database (key values 3 and 6 both reference Database B).",
      "pos": [
        1440,
        1618
      ]
    },
    {
      "content": "Key",
      "pos": [
        1622,
        1625
      ]
    },
    {
      "content": "Shard Location",
      "pos": [
        1628,
        1642
      ]
    },
    {
      "content": "1",
      "pos": [
        1672,
        1673
      ]
    },
    {
      "content": "Database_A",
      "pos": [
        1678,
        1688
      ]
    },
    {
      "content": "3",
      "pos": [
        1697,
        1698
      ]
    },
    {
      "content": "Database_B",
      "pos": [
        1703,
        1713
      ]
    },
    {
      "content": "4",
      "pos": [
        1722,
        1723
      ]
    },
    {
      "content": "Database_C",
      "pos": [
        1728,
        1738
      ]
    },
    {
      "content": "6",
      "pos": [
        1747,
        1748
      ]
    },
    {
      "content": "Database_B",
      "pos": [
        1753,
        1763
      ]
    },
    {
      "content": "...",
      "pos": [
        1772,
        1775
      ]
    },
    {
      "content": "...",
      "pos": [
        1778,
        1781
      ]
    },
    {
      "content": "Range shard maps",
      "pos": [
        1802,
        1818
      ]
    },
    {
      "pos": [
        1820,
        2028
      ],
      "content": "In a <bpt id=\"p1\">**</bpt>range shard map<ept id=\"p1\">**</ept>, the key range is described by a pair <bpt id=\"p2\">**</bpt>[Low Value, High Value)<ept id=\"p2\">**</ept> where the <bpt id=\"p3\">*</bpt>Low Value<ept id=\"p3\">*</ept> is the minimum key in the range, and the <bpt id=\"p4\">*</bpt>High Value<ept id=\"p4\">*</ept> is the first value higher than the range."
    },
    {
      "content": "For example, <bpt id=\"p1\">**</bpt>[0, 100)<ept id=\"p1\">**</ept> includes all integers greater than or equal 0 and less than 100.",
      "pos": [
        2031,
        2121
      ]
    },
    {
      "content": "Note that multiple ranges can point to the same database, and disjoint ranges are supported (e.g., [100,200) and [400,600) both point to Database C in the example below.)",
      "pos": [
        2122,
        2292
      ]
    },
    {
      "content": "Key",
      "pos": [
        2296,
        2299
      ]
    },
    {
      "content": "Shard Location",
      "pos": [
        2308,
        2322
      ]
    },
    {
      "content": "[1,50)",
      "pos": [
        2358,
        2364
      ]
    },
    {
      "content": "Database_A",
      "pos": [
        2370,
        2380
      ]
    },
    {
      "content": "[50,100)",
      "pos": [
        2389,
        2397
      ]
    },
    {
      "content": "Database_B",
      "pos": [
        2401,
        2411
      ]
    },
    {
      "content": "[100,200)",
      "pos": [
        2420,
        2429
      ]
    },
    {
      "content": "Database_C",
      "pos": [
        2432,
        2442
      ]
    },
    {
      "content": "[400,600)",
      "pos": [
        2451,
        2460
      ]
    },
    {
      "content": "Database_C",
      "pos": [
        2463,
        2473
      ]
    },
    {
      "content": "...",
      "pos": [
        2482,
        2485
      ]
    },
    {
      "content": "...",
      "pos": [
        2494,
        2497
      ]
    },
    {
      "content": "Each of the tables shown above is a conceptual example of a <bpt id=\"p1\">**</bpt>ShardMap<ept id=\"p1\">**</ept> object.",
      "pos": [
        2511,
        2591
      ]
    },
    {
      "content": "Each row is a simplified example of an individual <bpt id=\"p1\">**</bpt>PointMapping<ept id=\"p1\">**</ept> (for the list shard map) or <bpt id=\"p2\">**</bpt>RangeMapping<ept id=\"p2\">**</ept> (for the range shard map) object.",
      "pos": [
        2593,
        2738
      ]
    },
    {
      "content": "Shard map manager",
      "pos": [
        2743,
        2760
      ]
    },
    {
      "content": "In the client library, the Shard Map Manager is a collection of shard maps.",
      "pos": [
        2763,
        2838
      ]
    },
    {
      "content": "The data managed by a <bpt id=\"p1\">**</bpt>ShardMapManager<ept id=\"p1\">**</ept> .Net object is kept in three places:",
      "pos": [
        2839,
        2917
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Global Shard Map (GSM)<ept id=\"p1\">**</ept>: When you create a <bpt id=\"p2\">**</bpt>ShardMapManager<ept id=\"p2\">**</ept>, you specify a database to serve as the repository for all of its shard maps and mappings.",
      "pos": [
        2923,
        3079
      ]
    },
    {
      "content": "Special tables and stored procedures are automatically created to manage the information.",
      "pos": [
        3080,
        3169
      ]
    },
    {
      "content": "This is typically a small database and lightly accessed, but it should not be used for other needs of the application.",
      "pos": [
        3170,
        3288
      ]
    },
    {
      "content": "The tables are in a special schema named <bpt id=\"p1\">**</bpt>__ShardManagement<ept id=\"p1\">**</ept>.",
      "pos": [
        3289,
        3352
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Local Shard Map (LSM)<ept id=\"p1\">**</ept>: Every database that you specify to be a shard within a shard map will be modified to contain several small tables and special stored procedures that contain and manage shard map information specific to that shard.",
      "pos": [
        3358,
        3598
      ]
    },
    {
      "content": "This information is redundant to the information in the GSM, but it allows the application to validate cached shard map information without placing any load on the GSM; the application uses the LSM to determine if a cached mapping is still valid.",
      "pos": [
        3599,
        3845
      ]
    },
    {
      "content": "The tables corresponding to the LSM on each shard are in schema <bpt id=\"p1\">**</bpt>__ShardManagement<ept id=\"p1\">**</ept>.",
      "pos": [
        3846,
        3932
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Application cache<ept id=\"p1\">**</ept>: Each application instance accessing a <bpt id=\"p2\">**</bpt>ShardMapManager<ept id=\"p2\">**</ept> object maintains a local in-memory cache of its mappings.",
      "pos": [
        3937,
        4075
      ]
    },
    {
      "content": "It stores routing information that has recently been retrieved.",
      "pos": [
        4076,
        4139
      ]
    },
    {
      "content": "Constructing a ShardMapManager",
      "pos": [
        4145,
        4175
      ]
    },
    {
      "content": "A <bpt id=\"p1\">**</bpt>ShardMapManager<ept id=\"p1\">**</ept> object in the application is instantiated using a factory pattern.",
      "pos": [
        4176,
        4264
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>ShardMapManagerFactory.GetSqlShardMapManager<ept id=\"p1\">**</ept> method takes credentials (including the server name and database name holding the GSM) in the form of a <bpt id=\"p2\">**</bpt>ConnectionString<ept id=\"p2\">**</ept> and returns an instance of a <bpt id=\"p3\">**</bpt>ShardMapManager<ept id=\"p3\">**</ept>.",
      "pos": [
        4265,
        4492
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>ShardMapManager<ept id=\"p1\">**</ept> should be instantiated only once per app domain, within the initialization code for an application.",
      "pos": [
        4496,
        4619
      ]
    },
    {
      "content": "A <bpt id=\"p1\">**</bpt>ShardMapManager<ept id=\"p1\">**</ept> can contain any number of shard maps.",
      "pos": [
        4620,
        4679
      ]
    },
    {
      "content": "While a single shard map may be sufficient for many applications, there are times when different sets of databases are used for different schema or for unique purposes, and in those cases multiple shard maps may be preferable.",
      "pos": [
        4680,
        4906
      ]
    },
    {
      "content": "In this code, an application tries to open an existing <bpt id=\"p1\">**</bpt>ShardMapManager<ept id=\"p1\">**</ept>.",
      "pos": [
        4909,
        4984
      ]
    },
    {
      "content": "If objects representing a Global <bpt id=\"p1\">**</bpt>ShardMapManager<ept id=\"p1\">**</ept> (GSM) do not yet exist inside the database, the client library creates them there.",
      "pos": [
        4986,
        5121
      ]
    },
    {
      "content": "Shard map administration credentials",
      "pos": [
        6210,
        6246
      ]
    },
    {
      "content": "Typically, applications that administer and manipulate shard maps are different from those that use the shard maps to route connections.",
      "pos": [
        6248,
        6384
      ]
    },
    {
      "content": "For applications that administer shard maps (adding or changing shards, shard maps, shard mappings, etc.) you must instantiate the <bpt id=\"p1\">**</bpt>ShardMapManager<ept id=\"p1\">**</ept> using <bpt id=\"p2\">**</bpt>credentials that have read/write privileges on both the GSM database and on each database that serves as a shard<ept id=\"p2\">**</ept>.",
      "pos": [
        6387,
        6661
      ]
    },
    {
      "content": "The credentials must allow for writes against the tables in both the GSM and LSM as shard map information is entered or changed, as well as for creating LSM tables on new shards.",
      "pos": [
        6662,
        6840
      ]
    },
    {
      "content": "Only metadata affected",
      "pos": [
        6848,
        6870
      ]
    },
    {
      "content": "Methods used for populating or changing the <bpt id=\"p1\">**</bpt>ShardMapManager<ept id=\"p1\">**</ept> data do not alter the user data stored in the shards themselves.",
      "pos": [
        6873,
        7001
      ]
    },
    {
      "content": "For example, methods such as <bpt id=\"p1\">**</bpt>CreateShard<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>DeleteShard<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>UpdateMapping<ept id=\"p3\">**</ept>, etc. affect the shard map metadata only.",
      "pos": [
        7002,
        7124
      ]
    },
    {
      "content": "They do not remove, add, or alter user data contained in the shards.",
      "pos": [
        7125,
        7193
      ]
    },
    {
      "content": "Instead, these methods are designed to be used in conjunction with separate operations you perform to create or remove actual databases, or that move rows from one shard to another to rebalance a sharded environment.",
      "pos": [
        7194,
        7410
      ]
    },
    {
      "content": "(The <bpt id=\"p1\">**</bpt>split-merge<ept id=\"p1\">**</ept> tool included with elastic database tools makes use of these APIs along with orchestrating actual data movement between shards.)",
      "pos": [
        7412,
        7561
      ]
    },
    {
      "content": "Populating a shard map: example",
      "pos": [
        7567,
        7598
      ]
    },
    {
      "content": "An example sequence of operations to populate a specific shard map is shown below.",
      "pos": [
        7601,
        7683
      ]
    },
    {
      "content": "The code performs these steps:",
      "pos": [
        7684,
        7714
      ]
    },
    {
      "content": "A new shard map is created within a shard map manager.",
      "pos": [
        7720,
        7774
      ]
    },
    {
      "content": "The metadata for two different shards is added to the shard map.",
      "pos": [
        7779,
        7843
      ]
    },
    {
      "content": "A variety of key range mappings are added, and the overall contents of the shard map are displayed.",
      "pos": [
        7848,
        7947
      ]
    },
    {
      "content": "The code is written in a way that the entire method can be safely rerun in case an unexpected error is encountered – each request tests whether a shard or mapping already exists, before attempting to create it.",
      "pos": [
        7950,
        8160
      ]
    },
    {
      "content": "The code below assumes that databases named <bpt id=\"p1\">**</bpt>sample_shard_0<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>sample_shard_1<ept id=\"p2\">**</ept> and <bpt id=\"p3\">**</bpt>sample_shard_2<ept id=\"p3\">**</ept> have already been created in the server referenced by string <bpt id=\"p4\">**</bpt>shardServer<ept id=\"p4\">**</ept>.",
      "pos": [
        8161,
        8344
      ]
    },
    {
      "content": "As an alternative you can use PowerShell scripts to achieve the same result.",
      "pos": [
        11267,
        11343
      ]
    },
    {
      "content": "Once shard maps have been populated, data access applications can be created or adapted to work with the maps.",
      "pos": [
        11350,
        11460
      ]
    },
    {
      "content": "Populating or manipulating the maps need not occur again until <bpt id=\"p1\">**</bpt>map layout<ept id=\"p1\">**</ept> needs to change.",
      "pos": [
        11461,
        11555
      ]
    },
    {
      "content": "Data dependent routing",
      "pos": [
        11562,
        11584
      ]
    },
    {
      "content": "Most use of the shard map manager will come from the applications that require database connections to perform the app-specific data operations.",
      "pos": [
        11587,
        11731
      ]
    },
    {
      "content": "In a sharded application, those connections now must be associated with the correct target database.",
      "pos": [
        11732,
        11832
      ]
    },
    {
      "content": "This is known as <bpt id=\"p1\">**</bpt>Data Dependent Routing<ept id=\"p1\">**</ept>.",
      "pos": [
        11833,
        11877
      ]
    },
    {
      "content": "For these applications, instantiate a shard map manager object from the factory using credentials that have read-only access on the GSM database.",
      "pos": [
        11879,
        12024
      ]
    },
    {
      "content": "Individual requests for connections will later supply credentials necessary for connecting to the appropriate shard database.",
      "pos": [
        12025,
        12150
      ]
    },
    {
      "content": "Note that these applications (using <bpt id=\"p1\">**</bpt>ShardMapManager<ept id=\"p1\">**</ept> opened with read-only credentials) will be unable to make changes to the maps or mappings.",
      "pos": [
        12152,
        12298
      ]
    },
    {
      "content": "For those needs, create administrative-specific applications or PowerShell scripts that supply higher-privileged credentials as discussed earlier.",
      "pos": [
        12300,
        12446
      ]
    },
    {
      "pos": [
        12451,
        12552
      ],
      "content": "For more details, see <bpt id=\"p1\">[</bpt>Data dependent routing<ept id=\"p1\">](sql-database-elastic-scale-data-dependent-routing.md)</ept>."
    },
    {
      "content": "Modifying a shard map",
      "pos": [
        12558,
        12579
      ]
    },
    {
      "content": "A shard map can be changed in different ways.",
      "pos": [
        12582,
        12627
      ]
    },
    {
      "content": "All of the following methods modify the metadata describing the shards and their mappings, but they do not physically modify data within the shards, nor do they create or delete the actual databases.",
      "pos": [
        12628,
        12827
      ]
    },
    {
      "content": "Some of the operations on the shard map described below may need to be coordinated with administrative actions that physically move data or that add and remove databases serving as shards.",
      "pos": [
        12829,
        13017
      ]
    },
    {
      "content": "These methods work together as the building blocks available for modifying the overall distribution of data in your sharded database environment.",
      "pos": [
        13019,
        13164
      ]
    },
    {
      "pos": [
        13170,
        13235
      ],
      "content": "To add or remove shards: use <bpt id=\"p1\">**</bpt>CreateShard<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>DeleteShard<ept id=\"p2\">**</ept>."
    },
    {
      "content": "The server and database representing the target shard must already exist for these operations to execute.",
      "pos": [
        13246,
        13351
      ]
    },
    {
      "content": "These methods do not have any impact on the databases themselves, only on metadata in the shard map.",
      "pos": [
        13352,
        13452
      ]
    },
    {
      "pos": [
        13456,
        13594
      ],
      "content": "To create or remove points or ranges that are mapped to the shards: use <bpt id=\"p1\">**</bpt>CreateRangeMapping<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>DeleteMapping<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>CreatePointMapping<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Many different points or ranges can be mapped to the same shard.",
      "pos": [
        13605,
        13669
      ]
    },
    {
      "content": "These methods only affect metadata – they do not affect any data that may already be present in shards.",
      "pos": [
        13670,
        13773
      ]
    },
    {
      "content": "If data needs to be removed from the database in order to be consistent with <bpt id=\"p1\">**</bpt>DeleteMapping<ept id=\"p1\">**</ept> operations, you will need to perform those operations separately but in conjunction with using these methods.",
      "pos": [
        13774,
        13978
      ]
    },
    {
      "pos": [
        13984,
        14097
      ],
      "content": "To split existing ranges into two, or merge adjacent ranges into one: use <bpt id=\"p1\">**</bpt>SplitMapping<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>MergeMappings<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Note that split and merge operations <bpt id=\"p1\">**</bpt>do not change the shard to which key values are mapped<ept id=\"p1\">**</ept>.",
      "pos": [
        14105,
        14201
      ]
    },
    {
      "content": "A split breaks an existing range into two parts, but leaves both as mapped to the same shard.",
      "pos": [
        14202,
        14295
      ]
    },
    {
      "content": "A merge operates on two adjacent ranges that are already mapped to the same shard, coalescing them into a single range.",
      "pos": [
        14296,
        14415
      ]
    },
    {
      "content": "The movement of points or ranges themselves between shards needs to be coordinated by using <bpt id=\"p1\">**</bpt>UpdateMapping<ept id=\"p1\">**</ept> in conjunction with actual data movement.",
      "pos": [
        14417,
        14568
      ]
    },
    {
      "content": "You can use the <bpt id=\"p1\">**</bpt>Split/Merge<ept id=\"p1\">**</ept> service that is part of elastic database tools to coordinate shard map changes with data movement, when movement is needed.",
      "pos": [
        14570,
        14725
      ]
    },
    {
      "pos": [
        14730,
        14821
      ],
      "content": "To re-map (or move) individual points or ranges to different shards: use <bpt id=\"p1\">**</bpt>UpdateMapping<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        14829,
        15042
      ],
      "content": "Since data may need to be moved from one shard to another in order to be consistent with <bpt id=\"p1\">**</bpt>UpdateMapping<ept id=\"p1\">**</ept> operations, you will need to perform that movement separately but in conjunction with using these methods."
    },
    {
      "pos": [
        15046,
        15177
      ],
      "content": "To take mappings online and offline: use <bpt id=\"p1\">**</bpt>MarkMappingOffline<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>MarkMappingOnline<ept id=\"p2\">**</ept> to control the online state of a mapping."
    },
    {
      "content": "Certain operations on shard mappings are only allowed when a mapping is in an “offline” state, including <bpt id=\"p1\">**</bpt>UpdateMapping<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>DeleteMapping<ept id=\"p2\">**</ept>.",
      "pos": [
        15184,
        15329
      ]
    },
    {
      "content": "When a mapping is offline, a data-dependent request based on a key included in that mapping will return an error.",
      "pos": [
        15330,
        15443
      ]
    },
    {
      "content": "In addition, when a range is first taken offline, all connections to the affected shard are automatically killed in order to prevent inconsistent or incomplete results for queries directed against ranges being changed.",
      "pos": [
        15444,
        15662
      ]
    },
    {
      "content": "Mappings are immutable objects in .Net.",
      "pos": [
        15665,
        15704
      ]
    },
    {
      "content": "All of the methods above that change mappings also invalidate any references to them in your code.",
      "pos": [
        15706,
        15804
      ]
    },
    {
      "content": "To make it easier to perform sequences of operations that change a mapping’s state, all of the methods that change a mapping return a new mapping reference, so operations can be chained.",
      "pos": [
        15807,
        15993
      ]
    },
    {
      "content": "For example, to delete an existing mapping in shardmap sm that contains the key 25, you can execute the following:",
      "pos": [
        15995,
        16109
      ]
    },
    {
      "content": "Adding a shard",
      "pos": [
        16190,
        16204
      ]
    },
    {
      "content": "Applications often need to simply add new shards to handle data that is expected from new keys or key ranges, for a shard map that already exists.",
      "pos": [
        16207,
        16353
      ]
    },
    {
      "content": "For example, an application sharded by Tenant ID may need to provision a new shard for a new tenant, or data sharded monthly may need a new shard provisioned before the start of each new month.",
      "pos": [
        16354,
        16547
      ]
    },
    {
      "content": "If the new range of key values is not already part of an existing mapping and no data movement is necessary, it is very simple to add the new shard and associate the new key or range to that shard.",
      "pos": [
        16550,
        16747
      ]
    },
    {
      "content": "For details on adding new shards, see <bpt id=\"p1\">[</bpt>Adding a new shard<ept id=\"p1\">](sql-database-elastic-scale-add-a-shard.md)</ept>.",
      "pos": [
        16748,
        16850
      ]
    },
    {
      "content": "For scenarios that require data movement, however, the split-merge tool is needed to orchestrate the data movement between shards in combination with the necessary shard map updates.",
      "pos": [
        16852,
        17034
      ]
    },
    {
      "content": "For details on using the split-merge yool, see <bpt id=\"p1\">[</bpt>Overview of split-merge<ept id=\"p1\">](sql-database-elastic-scale-overview-split-and-merge.md)</ept>",
      "pos": [
        17035,
        17163
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"Shard map management\" \n    description=\"How to use the ShardMapManager, elastic database client library\" \n    services=\"sql-database\" \n    documentationCenter=\"\" \n    manager=\"jeffreyg\" \n    authors=\"sidneyh\" \n    editor=\"\"/>\n\n<tags \n    ms.service=\"sql-database\" \n    ms.workload=\"sql-database\" \n    ms.tgt_pltfrm=\"na\" \n    ms.devlang=\"na\" \n    ms.topic=\"article\" \n    ms.date=\"07/24/2015\" \n    ms.author=\"sidneyh\"/>\n\n# Shard map management\nIn a sharded database environment, a **shard map** maintains information allowing an application to connect to the correct database based upon the value of the **sharding key**. Understanding how these maps are constructed is crucial to managing shards with the elastic database client library.\n\n## Shard maps and shard mappings\n \n### Supported .Net types for sharding keys\n\nElastic Scale support the following .Net Framework types as sharding keys:\n\n* integer\n* long\n* guid\n* byte[]  \n* datetime\n* timespan\n* datetimeoffset\n\n### List and range shard maps\nShard maps can be constructed using **lists of individual sharding key values**, or they can be constructed using **ranges of sharding key values**. \n\n###List shard maps\n**Shards** contain **shardlets** and the mapping of shardlets to shards is maintained by a shard map. A **list shard map** is an association between the individual key values that identify the shardlets and the databases that serve as shards.  **List mappings** are explicit (for example, key 1 maps to Database A) and different key values can be mapped to the same database (key values 3 and 6 both reference Database B).\n\n| Key | Shard Location |\n|-----|----------------|\n| 1   | Database_A     |\n| 3   | Database_B     |\n| 4   | Database_C     |\n| 6   | Database_B     |\n| ... | ...            |\n \n\n### Range shard maps \nIn a **range shard map**, the key range is described by a pair **[Low Value, High Value)** where the *Low Value* is the minimum key in the range, and the *High Value* is the first value higher than the range. \n\nFor example, **[0, 100)** includes all integers greater than or equal 0 and less than 100. Note that multiple ranges can point to the same database, and disjoint ranges are supported (e.g., [100,200) and [400,600) both point to Database C in the example below.)\n\n| Key       | Shard Location |\n|-----------|----------------|\n| [1,50)    | Database_A     |\n| [50,100)  | Database_B     |\n| [100,200) | Database_C     |\n| [400,600) | Database_C     |\n| ...       | ...            \n\nEach of the tables shown above is a conceptual example of a **ShardMap** object.  Each row is a simplified example of an individual **PointMapping** (for the list shard map) or **RangeMapping** (for the range shard map) object.\n\n## Shard map manager \n\nIn the client library, the Shard Map Manager is a collection of shard maps. The data managed by a **ShardMapManager** .Net object is kept in three places: \n\n1. **Global Shard Map (GSM)**: When you create a **ShardMapManager**, you specify a database to serve as the repository for all of its shard maps and mappings. Special tables and stored procedures are automatically created to manage the information. This is typically a small database and lightly accessed, but it should not be used for other needs of the application. The tables are in a special schema named **__ShardManagement**. \n\n2. **Local Shard Map (LSM)**: Every database that you specify to be a shard within a shard map will be modified to contain several small tables and special stored procedures that contain and manage shard map information specific to that shard. This information is redundant to the information in the GSM, but it allows the application to validate cached shard map information without placing any load on the GSM; the application uses the LSM to determine if a cached mapping is still valid. The tables corresponding to the LSM on each shard are in schema **__ShardManagement**.\n\n3. **Application cache**: Each application instance accessing a **ShardMapManager** object maintains a local in-memory cache of its mappings. It stores routing information that has recently been retrieved. \n\n## Constructing a ShardMapManager\nA **ShardMapManager** object in the application is instantiated using a factory pattern. The **ShardMapManagerFactory.GetSqlShardMapManager** method takes credentials (including the server name and database name holding the GSM) in the form of a **ConnectionString** and returns an instance of a **ShardMapManager**.  \n\nThe **ShardMapManager** should be instantiated only once per app domain, within the initialization code for an application. A **ShardMapManager** can contain any number of shard maps. While a single shard map may be sufficient for many applications, there are times when different sets of databases are used for different schema or for unique purposes, and in those cases multiple shard maps may be preferable. \n\nIn this code, an application tries to open an existing **ShardMapManager**.  If objects representing a Global **ShardMapManager** (GSM) do not yet exist inside the database, the client library creates them there.\n\n    // Try to get a reference to the Shard Map Manager via the Shard Map Manager database.  \n    // If it doesn't already exist, then create it. \n    ShardMapManager shardMapManager; \n    bool shardMapManagerExists = ShardMapManagerFactory.TryGetSqlShardMapManager(\n                                        connectionString, \n                                        ShardMapManagerLoadPolicy.Lazy, \n                                        out shardMapManager); \n\n    if (shardMapManagerExists) \n     { \n        Console.WriteLine(\"Shard Map Manager already exists\");\n    } \n    else\n    {\n        // Create the Shard Map Manager. \n        ShardMapManagerFactory.CreateSqlShardMapManager(connectionString);\n        Console.WriteLine(\"Created SqlShardMapManager\"); \n\n        shardMapManager = ShardMapManagerFactory.GetSqlShardMapManager(\n            connectionString, \n            ShardMapManagerLoadPolicy.Lazy);\n\n        // The connectionString contains server name, database name, and admin credentials \n        // for privileges on both the GSM and the shards themselves.\n    } \n \n\n### Shard map administration credentials\n\nTypically, applications that administer and manipulate shard maps are different from those that use the shard maps to route connections. \n\nFor applications that administer shard maps (adding or changing shards, shard maps, shard mappings, etc.) you must instantiate the **ShardMapManager** using **credentials that have read/write privileges on both the GSM database and on each database that serves as a shard**. The credentials must allow for writes against the tables in both the GSM and LSM as shard map information is entered or changed, as well as for creating LSM tables on new shards.  \n\n### Only metadata affected \n\nMethods used for populating or changing the **ShardMapManager** data do not alter the user data stored in the shards themselves. For example, methods such as **CreateShard**, **DeleteShard**, **UpdateMapping**, etc. affect the shard map metadata only. They do not remove, add, or alter user data contained in the shards. Instead, these methods are designed to be used in conjunction with separate operations you perform to create or remove actual databases, or that move rows from one shard to another to rebalance a sharded environment.  (The **split-merge** tool included with elastic database tools makes use of these APIs along with orchestrating actual data movement between shards.) \n\n## Populating a shard map: example\n \nAn example sequence of operations to populate a specific shard map is shown below. The code performs these steps: \n\n1. A new shard map is created within a shard map manager. \n2. The metadata for two different shards is added to the shard map. \n3. A variety of key range mappings are added, and the overall contents of the shard map are displayed. \n\nThe code is written in a way that the entire method can be safely rerun in case an unexpected error is encountered – each request tests whether a shard or mapping already exists, before attempting to create it. The code below assumes that databases named **sample_shard_0**, **sample_shard_1** and **sample_shard_2** have already been created in the server referenced by string **shardServer**. \n\n    public void CreatePopulatedRangeMap(ShardMapManager smm, string mapName) \n        {            \n            RangeShardMap<long> sm = null; \n\n            // check if shardmap exists and if not, create it \n            if (!smm.TryGetRangeShardMap(mapName, out sm)) \n            { \n                sm = smm.CreateRangeShardMap<long>(mapName); \n            } \n\n            Shard shard0 = null, shard1=null; \n            // check if shard exists and if not, \n            // create it (Idempotent / tolerant of re-execute) \n            if (!sm.TryGetShard(new ShardLocation(shardServer, \"sample_shard_0\"), out shard0)) \n            { \n                Shard0 = sm.CreateShard(new ShardLocation(shardServer, \"sample_shard_0\")); \n            } \n\n            if (!sm.TryGetShard(new ShardLocation(shardServer, \"sample_shard_1\"), out shard1)) \n            { \n                Shard1 = sm.CreateShard(new ShardLocation(shardServer, \"sample_shard_1\"));  \n            } \n\n            RangeMapping<long> rmpg=null; \n\n            // Check if mapping exists and if not,\n            // create it (Idempotent / tolerant of re-execute) \n            if (!sm.TryGetMappingForKey(0, out rmpg)) \n            { \n                sm.CreateRangeMapping(new RangeMappingCreationInfo<long> \n                    (new Range<long>(0, 50), shard0, MappingStatus.Online)); \n            } \n\n            if (!sm.TryGetMappingForKey(50, out rmpg)) \n            { \n                sm.CreateRangeMapping(new RangeMappingCreationInfo<long> \n                    (new Range<long>(50, 100), shard1, MappingStatus.Online)); \n            } \n\n            if (!sm.TryGetMappingForKey(100, out rmpg)) \n            { \n                sm.CreateRangeMapping(new RangeMappingCreationInfo<long> \n                    (new Range<long>(100, 150), shard0, MappingStatus.Online)); \n            } \n\n            if (!sm.TryGetMappingForKey(150, out rmpg)) \n            { \n                sm.CreateRangeMapping(new RangeMappingCreationInfo<long> \n                    (new Range<long>(150, 200), shard1, MappingStatus.Online)); \n            } \n\n            if (!sm.TryGetMappingForKey(200, out rmpg)) \n            { \n               sm.CreateRangeMapping(new RangeMappingCreationInfo<long> \n                   (new Range<long>(200, 300), shard0, MappingStatus.Online)); \n            } \n\n            // List the shards and mappings \n            foreach (Shard s in sm.GetShards()\n                                    .OrderBy(s => s.Location.DataSource)\n                                    .ThenBy(s => s.Location.Database))\n            { \n               Console.WriteLine(\"shard: \"+ s.Location); \n            } \n\n            foreach (RangeMapping<long> rm in sm.GetMappings()) \n            { \n                Console.WriteLine(\"range: [\" + rm.Value.Low.ToString() + \":\" \n                        + rm.Value.High.ToString()+ \")  ==>\" +rm.Shard.Location); \n            } \n        } \n \nAs an alternative you can use PowerShell scripts to achieve the same result.     \n\nOnce shard maps have been populated, data access applications can be created or adapted to work with the maps. Populating or manipulating the maps need not occur again until **map layout** needs to change.  \n\n## Data dependent routing \n\nMost use of the shard map manager will come from the applications that require database connections to perform the app-specific data operations. In a sharded application, those connections now must be associated with the correct target database. This is known as **Data Dependent Routing**.  For these applications, instantiate a shard map manager object from the factory using credentials that have read-only access on the GSM database. Individual requests for connections will later supply credentials necessary for connecting to the appropriate shard database.\n\nNote that these applications (using **ShardMapManager** opened with read-only credentials) will be unable to make changes to the maps or mappings.  For those needs, create administrative-specific applications or PowerShell scripts that supply higher-privileged credentials as discussed earlier.   \n\nFor more details, see [Data dependent routing](sql-database-elastic-scale-data-dependent-routing.md). \n\n## Modifying a shard map \n\nA shard map can be changed in different ways. All of the following methods modify the metadata describing the shards and their mappings, but they do not physically modify data within the shards, nor do they create or delete the actual databases.  Some of the operations on the shard map described below may need to be coordinated with administrative actions that physically move data or that add and remove databases serving as shards.\n\nThese methods work together as the building blocks available for modifying the overall distribution of data in your sharded database environment.  \n\n* To add or remove shards: use **CreateShard** and **DeleteShard**. \n    \n    The server and database representing the target shard must already exist for these operations to execute. These methods do not have any impact on the databases themselves, only on metadata in the shard map.\n\n* To create or remove points or ranges that are mapped to the shards: use **CreateRangeMapping**, **DeleteMapping**, **CreatePointMapping**. \n    \n    Many different points or ranges can be mapped to the same shard. These methods only affect metadata – they do not affect any data that may already be present in shards. If data needs to be removed from the database in order to be consistent with **DeleteMapping** operations, you will need to perform those operations separately but in conjunction with using these methods.  \n\n* To split existing ranges into two, or merge adjacent ranges into one: use **SplitMapping** and **MergeMappings**.  \n\n    Note that split and merge operations **do not change the shard to which key values are mapped**. A split breaks an existing range into two parts, but leaves both as mapped to the same shard. A merge operates on two adjacent ranges that are already mapped to the same shard, coalescing them into a single range.  The movement of points or ranges themselves between shards needs to be coordinated by using **UpdateMapping** in conjunction with actual data movement.  You can use the **Split/Merge** service that is part of elastic database tools to coordinate shard map changes with data movement, when movement is needed. \n\n* To re-map (or move) individual points or ranges to different shards: use **UpdateMapping**.  \n\n    Since data may need to be moved from one shard to another in order to be consistent with **UpdateMapping** operations, you will need to perform that movement separately but in conjunction with using these methods.\n\n* To take mappings online and offline: use **MarkMappingOffline** and **MarkMappingOnline** to control the online state of a mapping. \n\n    Certain operations on shard mappings are only allowed when a mapping is in an “offline” state, including **UpdateMapping** and **DeleteMapping**. When a mapping is offline, a data-dependent request based on a key included in that mapping will return an error. In addition, when a range is first taken offline, all connections to the affected shard are automatically killed in order to prevent inconsistent or incomplete results for queries directed against ranges being changed. \n\nMappings are immutable objects in .Net.  All of the methods above that change mappings also invalidate any references to them in your code.   To make it easier to perform sequences of operations that change a mapping’s state, all of the methods that change a mapping return a new mapping reference, so operations can be chained.  For example, to delete an existing mapping in shardmap sm that contains the key 25, you can execute the following: \n\n        sm.DeleteMapping(sm.MarkMappingOffline(sm.GetMappingForKey(25)));\n\n## Adding a shard \n\nApplications often need to simply add new shards to handle data that is expected from new keys or key ranges, for a shard map that already exists. For example, an application sharded by Tenant ID may need to provision a new shard for a new tenant, or data sharded monthly may need a new shard provisioned before the start of each new month. \n\nIf the new range of key values is not already part of an existing mapping and no data movement is necessary, it is very simple to add the new shard and associate the new key or range to that shard. For details on adding new shards, see [Adding a new shard](sql-database-elastic-scale-add-a-shard.md).\n\nFor scenarios that require data movement, however, the split-merge tool is needed to orchestrate the data movement between shards in combination with the necessary shard map updates. For details on using the split-merge yool, see [Overview of split-merge](sql-database-elastic-scale-overview-split-and-merge.md) \n\n[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]\n "
}