{
  "nodes": [
    {
      "content": "Event Hubs Programming Guide",
      "pos": [
        27,
        55
      ]
    },
    {
      "content": "Describes programming with Azure Event Hubs using the Azure .NET SDK.",
      "pos": [
        73,
        142
      ]
    },
    {
      "content": "Event Hubs programming guide",
      "pos": [
        426,
        454
      ]
    },
    {
      "content": "This topic describes programming with Azure Event Hubs using the Azure .NET SDK.",
      "pos": [
        456,
        536
      ]
    },
    {
      "content": "It assumes a preliminary understanding of Event Hubs.",
      "pos": [
        537,
        590
      ]
    },
    {
      "content": "For conceptual an overview of Event Hubs, see the <bpt id=\"p1\">[</bpt>Event Hubs overview<ept id=\"p1\">](event-hubs-overview.md)</ept>.",
      "pos": [
        591,
        687
      ]
    },
    {
      "content": "Publishing events: event publishers",
      "pos": [
        692,
        727
      ]
    },
    {
      "content": "Sending events to an Event Hub is accomplished either using HTTP POST or via an AMQP 1.0 connection.",
      "pos": [
        729,
        829
      ]
    },
    {
      "content": "The choice of which to use when depends on the specific scenario being addressed.",
      "pos": [
        830,
        911
      ]
    },
    {
      "content": "AMQP 1.0 connections are metered as brokered connections in Service Bus and are more appropriate in scenarios with frequent higher message volumes and lower latency requirements as they provide a persistent messaging channel.",
      "pos": [
        912,
        1137
      ]
    },
    {
      "content": "Event Hubs are created and managed using the <bpt id=\"p1\">[</bpt>NamespaceManager<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.namespacemanager.aspx)</ept> class.",
      "pos": [
        1139,
        1288
      ]
    },
    {
      "content": "When using the .NET managed APIs, the primary constructs for publishing data to Event Hubs are the <bpt id=\"p1\">[</bpt>EventHubClient<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.aspx)</ept> and <bpt id=\"p2\">[</bpt>EventData<ept id=\"p2\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)</ept> classes.",
      "pos": [
        1289,
        1598
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>EventHubClient<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.aspx)</ept> class provides the AMQP communication channel over which events are sent to the Event Hub.",
      "pos": [
        1599,
        1797
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>EventData<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)</ept> class represents an event and is used to publish messages to an Event Hub.",
      "pos": [
        1798,
        1970
      ]
    },
    {
      "content": "This class includes the body, some metadata, and header information about the event.",
      "pos": [
        1971,
        2055
      ]
    },
    {
      "content": "Other properties are added to the <bpt id=\"p1\">[</bpt>EventData<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)</ept>object as it passes through an Event Hub.",
      "pos": [
        2056,
        2224
      ]
    },
    {
      "content": "Get started",
      "pos": [
        2229,
        2240
      ]
    },
    {
      "content": "The .NET  classes that support Event Hubs are part of the Microsoft.ServiceBus.dll assembly.",
      "pos": [
        2242,
        2334
      ]
    },
    {
      "content": "The easiest way to reference the Service Bus API and to configure your application with all of the Service Bus dependencies is to download the Service Bus NuGet package.",
      "pos": [
        2335,
        2504
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Using the NuGet Service Bus Package<ept id=\"p1\">](https://msdn.microsoft.com/library/dn741354.aspx)</ept>.",
      "pos": [
        2505,
        2619
      ]
    },
    {
      "content": "Alternatively, you can use the <bpt id=\"p1\">[</bpt>Package Manager Console<ept id=\"p1\">](http://docs.nuget.org/docs/start-here/using-the-package-manager-console)</ept> in Visual Studio.",
      "pos": [
        2620,
        2767
      ]
    },
    {
      "content": "To do so, issue the following command in the <bpt id=\"p1\">[</bpt>Package Manager Console<ept id=\"p1\">](http://docs.nuget.org/docs/start-here/using-the-package-manager-console)</ept> window:",
      "pos": [
        2768,
        2919
      ]
    },
    {
      "content": "Create an Event Hub",
      "pos": [
        2983,
        3002
      ]
    },
    {
      "content": "You can use the <bpt id=\"p1\">[</bpt>NamespaceManager<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.namespacemanager.aspx)</ept> class to create Event Hubs.",
      "pos": [
        3004,
        3145
      ]
    },
    {
      "content": "For example:",
      "pos": [
        3146,
        3158
      ]
    },
    {
      "content": "In most cases, it is recommended that you use the <bpt id=\"p1\">[</bpt>CreateEventHubIfNotExists<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.namespacemanager.createeventhubifnotexists.aspx)</ept> methods to avoid generating exceptions if the service restarts.",
      "pos": [
        3321,
        3567
      ]
    },
    {
      "content": "For example:",
      "pos": [
        3568,
        3580
      ]
    },
    {
      "content": "All Event Hub creation operations, including <bpt id=\"p1\">[</bpt>CreateEventHubIfNotExists<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.namespacemanager.createeventhubifnotexists.aspx)</ept>, require <bpt id=\"p2\">**</bpt>Manage<ept id=\"p2\">**</ept> permissions on the namespace in question.",
      "pos": [
        3658,
        3897
      ]
    },
    {
      "content": "If you want to limit the permissions of your publisher or consumer applications, you can avoid these create operation calls in production code when you use credentials with limited permissions.",
      "pos": [
        3898,
        4091
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>EventHubDescription<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubdescription.aspx)</ept> class contains details about an Event Hub, including the authorization rules, the message retention interval, partition IDs, status, and path.",
      "pos": [
        4093,
        4353
      ]
    },
    {
      "content": "You can use this class to update the metadata on an Event Hub.",
      "pos": [
        4354,
        4416
      ]
    },
    {
      "content": "Create an Event Hub client",
      "pos": [
        4421,
        4447
      ]
    },
    {
      "content": "The primary class for interacting with Event Hubs is <bpt id=\"p1\">[</bpt>Microsoft.ServiceBus.Messaging.EventHubClient<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.aspx)</ept>.",
      "pos": [
        4449,
        4637
      ]
    },
    {
      "content": "This class provides both sender and receiver capabilities.",
      "pos": [
        4638,
        4696
      ]
    },
    {
      "content": "You can instantiate this class using the <bpt id=\"p1\">[</bpt>Create<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.create.aspx)</ept> method, as shown in the following example.",
      "pos": [
        4697,
        4883
      ]
    },
    {
      "content": "This method uses the Service Bus connection information in the App.config file, in the <ph id=\"ph1\">`appSettings`</ph> section.",
      "pos": [
        4948,
        5057
      ]
    },
    {
      "content": "For an example of the <ph id=\"ph1\">`appSettings`</ph> XML used to store the Service Bus connection information, see the documentation for the <bpt id=\"p1\">[</bpt>Microsoft.ServiceBus.Messaging.EventHubClient.Create(System.String)<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.create.aspx)</ept> method.",
      "pos": [
        5058,
        5353
      ]
    },
    {
      "content": "Another option is to create the client from a connection string.",
      "pos": [
        5355,
        5419
      ]
    },
    {
      "content": "This option works well when using Azure worker roles, because you can store the string in the configuration properties for the worker.",
      "pos": [
        5420,
        5554
      ]
    },
    {
      "content": "For example:",
      "pos": [
        5555,
        5567
      ]
    },
    {
      "content": "The connection string will be in the same format as it appears in the App.config file for the previous methods:",
      "pos": [
        5647,
        5758
      ]
    },
    {
      "pos": [
        5868,
        6180
      ],
      "content": "Finally, it is also possible to create an <bpt id=\"p1\">[</bpt>EventHubClient<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.aspx)</ept> object from a <bpt id=\"p2\">[</bpt>MessagingFactory<ept id=\"p2\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.messagingfactory.aspx)</ept> instance, as shown in the following example."
    },
    {
      "content": "It is important to note that additional <bpt id=\"p1\">[</bpt>EventHubClient<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.aspx)</ept> objects created from a messaging factory instance will reuse the same underlying TCP connection.",
      "pos": [
        6333,
        6573
      ]
    },
    {
      "content": "Therefore, these objects have a client-side limit on throughput.",
      "pos": [
        6574,
        6638
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>Create<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.create.aspx)</ept> method reuses a single messaging factory.",
      "pos": [
        6639,
        6787
      ]
    },
    {
      "content": "If you need very high throughput from a single sender, then you can create multiple message factories and one <bpt id=\"p1\">[</bpt>EventHubClient<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.aspx)</ept> object from each messaging factory.",
      "pos": [
        6788,
        7037
      ]
    },
    {
      "content": "Send events to an Event Hub",
      "pos": [
        7042,
        7069
      ]
    },
    {
      "content": "You send events to an Event Hub by creating an <bpt id=\"p1\">[</bpt>EventData<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)</ept> instance and sending it via the <bpt id=\"p2\">[</bpt>Send<ept id=\"p2\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.send.aspx)</ept> method.",
      "pos": [
        7071,
        7350
      ]
    },
    {
      "content": "This method takes a single <bpt id=\"p1\">[</bpt>EventData<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)</ept> instance parameter and synchronously sends it to an Event Hub.",
      "pos": [
        7351,
        7534
      ]
    },
    {
      "content": "Event serialization",
      "pos": [
        7539,
        7558
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>EventData<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)</ept> class has <bpt id=\"p2\">[</bpt>four overloaded constructors<ept id=\"p2\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)</ept> that take a variety of parameters, such as an object and serializer, a byte array, or a stream.",
      "pos": [
        7560,
        7876
      ]
    },
    {
      "content": "It is also possible to instantiate the <bpt id=\"p1\">[</bpt>EventData<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)</ept> class and set the body stream afterwards.",
      "pos": [
        7877,
        8051
      ]
    },
    {
      "content": "When using JSON with <bpt id=\"p1\">[</bpt>EventData<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)</ept>, you can use <bpt id=\"p2\">**</bpt>Encoding.UTF8.GetBytes()<ept id=\"p2\">**</ept> to retrieve the byte array for a JSON-encoded string.",
      "pos": [
        8052,
        8262
      ]
    },
    {
      "content": "Partition key",
      "pos": [
        8267,
        8280
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>EventData<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)</ept> class has a <bpt id=\"p2\">[</bpt>PartitionKey<ept id=\"p2\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.partitionkey.aspx)</ept> property that enables the sender to specify a value that is hashed to produce a partition assignment.",
      "pos": [
        8282,
        8603
      ]
    },
    {
      "content": "Using a partition key ensures that all the events with the same key are sent to the same partition in the Event Hub.",
      "pos": [
        8604,
        8720
      ]
    },
    {
      "content": "Common partition keys include user session IDs and unique sender IDs.",
      "pos": [
        8721,
        8790
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>PartitionKey<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.partitionkey.aspx)</ept> property is optional and can be provided when using the <bpt id=\"p2\">[</bpt>Microsoft.ServiceBus.Messaging.EventHubClient.Send(Microsoft.ServiceBus.Messaging.EventData)<ept id=\"p2\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)</ept> or <bpt id=\"p3\">[</bpt>Microsoft.ServiceBus.Messaging.EventHubClient.SendAsync(Microsoft.ServiceBus.Messaging.EventData)<ept id=\"p3\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)</ept> methods.",
      "pos": [
        8791,
        9331
      ]
    },
    {
      "content": "If you do not provide a value for <bpt id=\"p1\">[</bpt>PartitionKey<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.partitionkey.aspx)</ept>, sent events are distributed to partitions using a round-robin model.",
      "pos": [
        9332,
        9545
      ]
    },
    {
      "content": "Batch event send operations",
      "pos": [
        9550,
        9577
      ]
    },
    {
      "content": "Sending events in batches can dramatically increase throughput.",
      "pos": [
        9579,
        9642
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>SendBatch<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.sendbatch.aspx)</ept> method takes an <bpt id=\"p2\">**</bpt>IEnumerable<ept id=\"p2\">**</ept> parameter of type <bpt id=\"p3\">[</bpt>EventData<ept id=\"p3\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)</ept> and sends the entire batch as an atomic operation to the Event Hub.",
      "pos": [
        9643,
        9967
      ]
    },
    {
      "content": "It is important to note that a single batch must not exceed the 256 KB limit of an event.",
      "pos": [
        10039,
        10128
      ]
    },
    {
      "content": "Additionally, each message in the batch uses the same publisher identity.",
      "pos": [
        10129,
        10202
      ]
    },
    {
      "content": "It is the responsibility of the sender to ensure that the batch does not exceed the maximum event size.",
      "pos": [
        10203,
        10306
      ]
    },
    {
      "content": "If it does, a client <bpt id=\"p1\">**</bpt>Send<ept id=\"p1\">**</ept> error is generated.",
      "pos": [
        10307,
        10356
      ]
    },
    {
      "content": "Send asynchronously and send at scale",
      "pos": [
        10361,
        10398
      ]
    },
    {
      "content": "You can also send events to an Event Hub asynchronously.",
      "pos": [
        10400,
        10456
      ]
    },
    {
      "content": "Sending asynchronously can increase the rate at which a client is able to send events.",
      "pos": [
        10457,
        10543
      ]
    },
    {
      "content": "Both the <bpt id=\"p1\">[</bpt>Send<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.send.aspx)</ept> and <bpt id=\"p2\">[</bpt>SendBatch<ept id=\"p2\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.sendbatch.aspx)</ept> methods are available in asynchronous versions that return a <bpt id=\"p3\">[</bpt>Task<ept id=\"p3\">](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx)</ept> object.",
      "pos": [
        10544,
        10909
      ]
    },
    {
      "content": "While this technique can increase throughput, it can also cause the client to continue to send events even while it is being throttled by the Event Hubs service and can result in the client experiencing failures or lost messages if not properly implemented.",
      "pos": [
        10910,
        11167
      ]
    },
    {
      "content": "In addition, you can use the <bpt id=\"p1\">[</bpt>RetryPolicy<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.cliententity.retrypolicy.aspx)</ept> property on the client to control client retry options.",
      "pos": [
        11168,
        11363
      ]
    },
    {
      "content": "Create a partition sender",
      "pos": [
        11368,
        11393
      ]
    },
    {
      "content": "Although it is most common to send events to an Event Hub with a partition key, in some cases you might want to send events directly to a given partition.",
      "pos": [
        11395,
        11549
      ]
    },
    {
      "content": "For example:",
      "pos": [
        11550,
        11562
      ]
    },
    {
      "pos": [
        11658,
        11986
      ],
      "content": "<bpt id=\"p1\">[</bpt>CreatePartitionedSender<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.createpartitionedsender.aspx)</ept> returns an <bpt id=\"p2\">[</bpt>EventHubSender<ept id=\"p2\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubsender.aspx)</ept> object that you can use to publish events to a specific Event Hub partition."
    },
    {
      "content": "Consume events: event consumers",
      "pos": [
        11991,
        12022
      ]
    },
    {
      "content": "Event Hubs has two primary models for event consumption: direct receivers and higher-level abstractions, such as <bpt id=\"p1\">[</bpt>EventProcessorHost<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx)</ept>.",
      "pos": [
        12024,
        12249
      ]
    },
    {
      "content": "Direct receivers are responsible for their own coordination of access to partitions within a consumer group.",
      "pos": [
        12250,
        12358
      ]
    },
    {
      "content": "Direct consumer",
      "pos": [
        12364,
        12379
      ]
    },
    {
      "content": "The most direct way to read from a partition within a consumer group is to use the <bpt id=\"p1\">[</bpt>EventHubReceiver<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubreceiver.aspx)</ept> class.",
      "pos": [
        12381,
        12578
      ]
    },
    {
      "content": "To create an instance of this class, you must use an instance of the <bpt id=\"p1\">[</bpt>EventHubConsumerGroup<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubconsumergroup.aspx)</ept> class.",
      "pos": [
        12579,
        12772
      ]
    },
    {
      "content": "In the following code example, the partition ID must be specified when creating the receiver for the consumer group.",
      "pos": [
        12773,
        12889
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>CreateReceiver<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubconsumergroup.createreceiver.aspx)</ept> method has several overloads that facilitate control over the reader being created.",
      "pos": [
        13049,
        13262
      ]
    },
    {
      "content": "These methods include specifying an offset as either a string or timestamp, and the ability to specify whether to include this specified offset in the returned stream, or start after it.",
      "pos": [
        13263,
        13449
      ]
    },
    {
      "content": "After you create the receiver, you can start receiving events on the returned object.",
      "pos": [
        13450,
        13535
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>Receive<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubreceiver.receive.aspx)</ept> method has four overloads that control the receive operation parameters, such as batch size and wait time.",
      "pos": [
        13536,
        13753
      ]
    },
    {
      "content": "You can use the asynchronous versions of these methods to increase the throughput of a consumer.",
      "pos": [
        13754,
        13850
      ]
    },
    {
      "content": "For example:",
      "pos": [
        13851,
        13863
      ]
    },
    {
      "content": "With respect to a specific partition, the messages are received in the order in which they were sent to the Event Hub.",
      "pos": [
        14161,
        14279
      ]
    },
    {
      "content": "The offset is a string token used to identify a message in a partition.",
      "pos": [
        14280,
        14351
      ]
    },
    {
      "content": "It is important to note that a single partition within a consumer group cannot have more than 5 concurrent readers connected at any time.",
      "pos": [
        14353,
        14490
      ]
    },
    {
      "content": "As readers connect or become disconnected, their sessions might stay active for several minutes before the service recognizes that they have disconnected.",
      "pos": [
        14491,
        14645
      ]
    },
    {
      "content": "During this time, reconnecting to a partition may fail.",
      "pos": [
        14646,
        14701
      ]
    },
    {
      "content": "For a complete example of writing a direct receiver for Event Hubs, see the <bpt id=\"p1\">[</bpt>Service Bus Event Hubs Direct Receivers<ept id=\"p1\">](https://code.msdn.microsoft.com/Event-Hub-Direct-Receivers-13fa95c6)</ept> sample.",
      "pos": [
        14702,
        14896
      ]
    },
    {
      "content": "Event processor host",
      "pos": [
        14902,
        14922
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>EventProcessorHost<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx)</ept> class processes data from Event Hubs.",
      "pos": [
        14924,
        15077
      ]
    },
    {
      "content": "You should use this implementation when building event readers on the .NET platform.",
      "pos": [
        15078,
        15162
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>EventProcessorHost<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx)</ept> provides a thread-safe, multi-process, safe runtime environment for event processor implementations that also provides checkpointing and partition lease management.",
      "pos": [
        15163,
        15439
      ]
    },
    {
      "content": "To use the <bpt id=\"p1\">[</bpt>EventProcessorHost<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx)</ept> class, you can implement <bpt id=\"p2\">[</bpt>IEventProcessor<ept id=\"p2\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.ieventprocessor.aspx)</ept>.",
      "pos": [
        15441,
        15695
      ]
    },
    {
      "content": "This interface contains three methods:",
      "pos": [
        15696,
        15734
      ]
    },
    {
      "content": "OpenAsync",
      "pos": [
        15739,
        15748
      ]
    },
    {
      "content": "CloseAsync",
      "pos": [
        15852,
        15862
      ]
    },
    {
      "content": "ProcessEventsAsync",
      "pos": [
        15967,
        15985
      ]
    },
    {
      "content": "To start event processing, instantiate <bpt id=\"p1\">[</bpt>EventProcessorHost<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx)</ept>, providing the appropriate parameters for your Event Hub.",
      "pos": [
        16095,
        16303
      ]
    },
    {
      "content": "Then call <bpt id=\"p1\">[</bpt>RegisterEventProcessorAsync<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.registereventprocessorasync.aspx)</ept> to register your <bpt id=\"p2\">[</bpt>IEventProcessor<ept id=\"p2\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.ieventprocessor.aspx)</ept> implementation with the runtime.",
      "pos": [
        16304,
        16618
      ]
    },
    {
      "content": "At this point, the host will attempt to acquire a lease on every partition in the Event Hub using a \"greedy\" algorithm.",
      "pos": [
        16619,
        16738
      ]
    },
    {
      "content": "These leases will last for a given timeframe and must then be renewed.",
      "pos": [
        16739,
        16809
      ]
    },
    {
      "content": "As new nodes, worker instances in this case, come online, they place lease reservations and over time the load shifts between nodes as each attempts to acquire more leases.",
      "pos": [
        16810,
        16982
      ]
    },
    {
      "content": "Event Processor Host",
      "pos": [
        16986,
        17006
      ]
    },
    {
      "content": "Over time, an equilibrium is established.",
      "pos": [
        17060,
        17101
      ]
    },
    {
      "content": "This dynamic capability enables CPU-based autoscaling to be applied to consumers for both scale-up and scale-down.",
      "pos": [
        17102,
        17216
      ]
    },
    {
      "content": "Because Event Hubs do not have a direct concept of message counts, average CPU utilization is often the best mechanism to measure back end or consumer scale.",
      "pos": [
        17217,
        17374
      ]
    },
    {
      "content": "If publishers begin to publish more events than consumers can process, the CPU increase on consumers can be used to cause an auto-scale on worker instance count.",
      "pos": [
        17375,
        17536
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>EventProcessorHost<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx)</ept> class also implements an Azure storage-based checkpointing mechanism.",
      "pos": [
        17538,
        17723
      ]
    },
    {
      "content": "This mechanism stores the offset on a per partition basis, so that each consumer can determine what the last checkpoint from the previous consumer was.",
      "pos": [
        17724,
        17875
      ]
    },
    {
      "content": "As partitions transition between nodes via leases, this is the synchronization mechanism that facilitates load shifting.",
      "pos": [
        17876,
        17996
      ]
    },
    {
      "content": "Publisher revocation",
      "pos": [
        18001,
        18021
      ]
    },
    {
      "content": "In addition to the advanced runtime features of <bpt id=\"p1\">[</bpt>EventProcessorHost<ept id=\"p1\">](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx)</ept>, Event Hubs enables publisher revocation in order to block specific publishers from sending event to an Event Hub.",
      "pos": [
        18023,
        18297
      ]
    },
    {
      "content": "These features are particularly useful if a publisher’s token has been compromised, or a software update is causing them to behave inappropriately.",
      "pos": [
        18298,
        18445
      ]
    },
    {
      "content": "In these situations, the publisher’s identity, which is part of their SAS token, can be blocked from publishing events.",
      "pos": [
        18446,
        18565
      ]
    },
    {
      "pos": [
        18567,
        18795
      ],
      "content": "For more information about publisher revocation and how to send to Event Hubs as a publisher, see the <bpt id=\"p1\">[</bpt>Service Bus Event Hubs Large Scale Secure Publishing<ept id=\"p1\">](https://code.msdn.microsoft.com/Service-Bus-Event-Hub-99ce67ab)</ept> sample."
    },
    {
      "content": "Next steps",
      "pos": [
        18800,
        18810
      ]
    },
    {
      "content": "To learn more about Event Hubs scenarios, visit these links:",
      "pos": [
        18812,
        18872
      ]
    },
    {
      "content": "Event Hubs API overview",
      "pos": [
        18877,
        18900
      ]
    },
    {
      "content": "Event Hubs overview",
      "pos": [
        18933,
        18952
      ]
    },
    {
      "content": "[Event Hubs Code Samples](http://code.msdn.microsoft.com/site/search?query=event hub&amp;f[0].Value=event hub&amp;f[0].Type=SearchText&amp;ac=5)",
      "pos": [
        18980,
        19112
      ]
    },
    {
      "content": "Event processor host API reference",
      "pos": [
        19116,
        19150
      ]
    },
    {
      "content": "test",
      "pos": [
        19244,
        19248
      ]
    }
  ],
  "content": "<properties \n   pageTitle=\"Event Hubs Programming Guide\"\n   description=\"Describes programming with Azure Event Hubs using the Azure .NET SDK.\"\n   services=\"event-hubs\"\n   documentationCenter=\"na\"\n   authors=\"sethmanheim\"\n   manager=\"timlt\"\n   editor=\"\" />\n<tags \n   ms.service=\"event-hubs\"\n   ms.devlang=\"na\"\n   ms.topic=\"article\"\n   ms.tgt_pltfrm=\"na\"\n   ms.workload=\"tbd\"\n   ms.date=\"07/10/2015\"\n   ms.author=\"sethm\" />\n\n# Event Hubs programming guide\n\nThis topic describes programming with Azure Event Hubs using the Azure .NET SDK. It assumes a preliminary understanding of Event Hubs. For conceptual an overview of Event Hubs, see the [Event Hubs overview](event-hubs-overview.md).\n\n## Publishing events: event publishers\n\nSending events to an Event Hub is accomplished either using HTTP POST or via an AMQP 1.0 connection. The choice of which to use when depends on the specific scenario being addressed. AMQP 1.0 connections are metered as brokered connections in Service Bus and are more appropriate in scenarios with frequent higher message volumes and lower latency requirements as they provide a persistent messaging channel.\n\nEvent Hubs are created and managed using the [NamespaceManager](https://msdn.microsoft.com/library/microsoft.servicebus.namespacemanager.aspx) class. When using the .NET managed APIs, the primary constructs for publishing data to Event Hubs are the [EventHubClient](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.aspx) and [EventData](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx) classes. The [EventHubClient](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.aspx) class provides the AMQP communication channel over which events are sent to the Event Hub. The [EventData](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx) class represents an event and is used to publish messages to an Event Hub. This class includes the body, some metadata, and header information about the event. Other properties are added to the [EventData](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx)object as it passes through an Event Hub.\n\n## Get started\n\nThe .NET  classes that support Event Hubs are part of the Microsoft.ServiceBus.dll assembly. The easiest way to reference the Service Bus API and to configure your application with all of the Service Bus dependencies is to download the Service Bus NuGet package. For more information, see [Using the NuGet Service Bus Package](https://msdn.microsoft.com/library/dn741354.aspx). Alternatively, you can use the [Package Manager Console](http://docs.nuget.org/docs/start-here/using-the-package-manager-console) in Visual Studio. To do so, issue the following command in the [Package Manager Console](http://docs.nuget.org/docs/start-here/using-the-package-manager-console) window:\n\n```powershell\nInstall-Package WindowsAzure.ServiceBus\n```\n\n## Create an Event Hub\n\nYou can use the [NamespaceManager](https://msdn.microsoft.com/library/microsoft.servicebus.namespacemanager.aspx) class to create Event Hubs. For example:\n\n```c\nvar manager = new Microsoft.ServiceBus.NamespaceManager(\"mynamespace.servicebus.windows.net\");\nvar description = manager.CreateEventHub(\"MyEventHub\");\n```\n\nIn most cases, it is recommended that you use the [CreateEventHubIfNotExists](https://msdn.microsoft.com/library/microsoft.servicebus.namespacemanager.createeventhubifnotexists.aspx) methods to avoid generating exceptions if the service restarts. For example:\n\n```\nvar description = manager.CreateEventHubIfNotExists(\"MyEventHub\");\n```\n\nAll Event Hub creation operations, including [CreateEventHubIfNotExists](https://msdn.microsoft.com/library/microsoft.servicebus.namespacemanager.createeventhubifnotexists.aspx), require **Manage** permissions on the namespace in question. If you want to limit the permissions of your publisher or consumer applications, you can avoid these create operation calls in production code when you use credentials with limited permissions.\n\nThe [EventHubDescription](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubdescription.aspx) class contains details about an Event Hub, including the authorization rules, the message retention interval, partition IDs, status, and path. You can use this class to update the metadata on an Event Hub.\n\n## Create an Event Hub client\n\nThe primary class for interacting with Event Hubs is [Microsoft.ServiceBus.Messaging.EventHubClient](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.aspx). This class provides both sender and receiver capabilities. You can instantiate this class using the [Create](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.create.aspx) method, as shown in the following example.\n\n```\nvar client = EventHubClient.Create(description.Path);\n```\n\nThis method uses the Service Bus connection information in the App.config file, in the `appSettings` section. For an example of the `appSettings` XML used to store the Service Bus connection information, see the documentation for the [Microsoft.ServiceBus.Messaging.EventHubClient.Create(System.String)](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.create.aspx) method.\n\nAnother option is to create the client from a connection string. This option works well when using Azure worker roles, because you can store the string in the configuration properties for the worker. For example:\n\n```\nEventHubClient.CreateFromConnectionString(\"your_connection_string\");\n```\n\nThe connection string will be in the same format as it appears in the App.config file for the previous methods:\n\n```\nEndpoint=sb://[namespace].servicebus.windows.net/;SharedAccessKeyName=Manage;SharedAccessKey=[key]\n```\n\nFinally, it is also possible to create an [EventHubClient](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.aspx) object from a [MessagingFactory](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.messagingfactory.aspx) instance, as shown in the following example.\n\n```\nvar factory = MessagingFactory.CreateFromConnectionString(\"your_connection_string\");\nvar client = factory.CreateEventHubClient(\"MyEventHub\");\n```\n\nIt is important to note that additional [EventHubClient](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.aspx) objects created from a messaging factory instance will reuse the same underlying TCP connection. Therefore, these objects have a client-side limit on throughput. The [Create](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.create.aspx) method reuses a single messaging factory. If you need very high throughput from a single sender, then you can create multiple message factories and one [EventHubClient](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.aspx) object from each messaging factory.\n\n## Send events to an Event Hub\n\nYou send events to an Event Hub by creating an [EventData](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx) instance and sending it via the [Send](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.send.aspx) method. This method takes a single [EventData](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx) instance parameter and synchronously sends it to an Event Hub.\n\n## Event serialization\n\nThe [EventData](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx) class has [four overloaded constructors](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx) that take a variety of parameters, such as an object and serializer, a byte array, or a stream. It is also possible to instantiate the [EventData](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx) class and set the body stream afterwards. When using JSON with [EventData](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx), you can use **Encoding.UTF8.GetBytes()** to retrieve the byte array for a JSON-encoded string.\n\n## Partition key\n\nThe [EventData](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx) class has a [PartitionKey](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.partitionkey.aspx) property that enables the sender to specify a value that is hashed to produce a partition assignment. Using a partition key ensures that all the events with the same key are sent to the same partition in the Event Hub. Common partition keys include user session IDs and unique sender IDs. The [PartitionKey](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.partitionkey.aspx) property is optional and can be provided when using the [Microsoft.ServiceBus.Messaging.EventHubClient.Send(Microsoft.ServiceBus.Messaging.EventData)](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx) or [Microsoft.ServiceBus.Messaging.EventHubClient.SendAsync(Microsoft.ServiceBus.Messaging.EventData)](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx) methods. If you do not provide a value for [PartitionKey](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.partitionkey.aspx), sent events are distributed to partitions using a round-robin model.\n\n## Batch event send operations\n\nSending events in batches can dramatically increase throughput. The [SendBatch](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.sendbatch.aspx) method takes an **IEnumerable** parameter of type [EventData](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventdata.aspx) and sends the entire batch as an atomic operation to the Event Hub.\n\n```\npublic void SendBatch(IEnumerable<EventData> eventDataList);\n```\n\nIt is important to note that a single batch must not exceed the 256 KB limit of an event. Additionally, each message in the batch uses the same publisher identity. It is the responsibility of the sender to ensure that the batch does not exceed the maximum event size. If it does, a client **Send** error is generated.\n\n## Send asynchronously and send at scale\n\nYou can also send events to an Event Hub asynchronously. Sending asynchronously can increase the rate at which a client is able to send events. Both the [Send](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.send.aspx) and [SendBatch](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.sendbatch.aspx) methods are available in asynchronous versions that return a [Task](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) object. While this technique can increase throughput, it can also cause the client to continue to send events even while it is being throttled by the Event Hubs service and can result in the client experiencing failures or lost messages if not properly implemented. In addition, you can use the [RetryPolicy](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.cliententity.retrypolicy.aspx) property on the client to control client retry options.\n\n## Create a partition sender\n\nAlthough it is most common to send events to an Event Hub with a partition key, in some cases you might want to send events directly to a given partition. For example:\n\n```\nvar partitionedSender = client.CreatePartitionedSender(description.PartitionIds[0]);\n```\n\n[CreatePartitionedSender](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubclient.createpartitionedsender.aspx) returns an [EventHubSender](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubsender.aspx) object that you can use to publish events to a specific Event Hub partition.\n\n## Consume events: event consumers\n\nEvent Hubs has two primary models for event consumption: direct receivers and higher-level abstractions, such as [EventProcessorHost](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx). Direct receivers are responsible for their own coordination of access to partitions within a consumer group.\n\n### Direct consumer\n\nThe most direct way to read from a partition within a consumer group is to use the [EventHubReceiver](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubreceiver.aspx) class. To create an instance of this class, you must use an instance of the [EventHubConsumerGroup](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubconsumergroup.aspx) class. In the following code example, the partition ID must be specified when creating the receiver for the consumer group.\n\n```\nEventHubConsumerGroup group = client.GetDefaultConsumerGroup();\nvar receiver = group.CreateReceiver(client.GetRuntimeInformation().PartitionIds[0]);\n```\n\nThe [CreateReceiver](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubconsumergroup.createreceiver.aspx) method has several overloads that facilitate control over the reader being created. These methods include specifying an offset as either a string or timestamp, and the ability to specify whether to include this specified offset in the returned stream, or start after it. After you create the receiver, you can start receiving events on the returned object. The [Receive](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubreceiver.receive.aspx) method has four overloads that control the receive operation parameters, such as batch size and wait time. You can use the asynchronous versions of these methods to increase the throughput of a consumer. For example:\n\n```\nbool receive = true;\nstring myOffset;\nwhile(receive)\n{\n    var message = receiver.Receive();\n    myOffset = message.Offset;\n    string body = Encoding.UTF8.GetString(message.GetBytes());\n    Console.WriteLine(String.Format(\"Received message offset: {0} \\nbody: {1}\", myOffset, body));\n}\n```\n\nWith respect to a specific partition, the messages are received in the order in which they were sent to the Event Hub. The offset is a string token used to identify a message in a partition.\n\nIt is important to note that a single partition within a consumer group cannot have more than 5 concurrent readers connected at any time. As readers connect or become disconnected, their sessions might stay active for several minutes before the service recognizes that they have disconnected. During this time, reconnecting to a partition may fail. For a complete example of writing a direct receiver for Event Hubs, see the [Service Bus Event Hubs Direct Receivers](https://code.msdn.microsoft.com/Event-Hub-Direct-Receivers-13fa95c6) sample.\n\n### Event processor host\n\nThe [EventProcessorHost](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx) class processes data from Event Hubs. You should use this implementation when building event readers on the .NET platform. [EventProcessorHost](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx) provides a thread-safe, multi-process, safe runtime environment for event processor implementations that also provides checkpointing and partition lease management.\n\nTo use the [EventProcessorHost](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx) class, you can implement [IEventProcessor](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.ieventprocessor.aspx). This interface contains three methods:\n\n- [OpenAsync](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.ieventprocessor.openasync.aspx)\n\n- [CloseAsync](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.ieventprocessor.closeasync.aspx)\n\n- [ProcessEventsAsync](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.ieventprocessor.processeventsasync.aspx)\n\nTo start event processing, instantiate [EventProcessorHost](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx), providing the appropriate parameters for your Event Hub. Then call [RegisterEventProcessorAsync](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.registereventprocessorasync.aspx) to register your [IEventProcessor](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.ieventprocessor.aspx) implementation with the runtime. At this point, the host will attempt to acquire a lease on every partition in the Event Hub using a \"greedy\" algorithm. These leases will last for a given timeframe and must then be renewed. As new nodes, worker instances in this case, come online, they place lease reservations and over time the load shifts between nodes as each attempts to acquire more leases.\n\n![Event Processor Host](./media/event-hubs-programming-guide/IC759863.png)\n\nOver time, an equilibrium is established. This dynamic capability enables CPU-based autoscaling to be applied to consumers for both scale-up and scale-down. Because Event Hubs do not have a direct concept of message counts, average CPU utilization is often the best mechanism to measure back end or consumer scale. If publishers begin to publish more events than consumers can process, the CPU increase on consumers can be used to cause an auto-scale on worker instance count.\n\nThe [EventProcessorHost](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx) class also implements an Azure storage-based checkpointing mechanism. This mechanism stores the offset on a per partition basis, so that each consumer can determine what the last checkpoint from the previous consumer was. As partitions transition between nodes via leases, this is the synchronization mechanism that facilitates load shifting.\n\n## Publisher revocation\n\nIn addition to the advanced runtime features of [EventProcessorHost](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx), Event Hubs enables publisher revocation in order to block specific publishers from sending event to an Event Hub. These features are particularly useful if a publisher’s token has been compromised, or a software update is causing them to behave inappropriately. In these situations, the publisher’s identity, which is part of their SAS token, can be blocked from publishing events.\n\nFor more information about publisher revocation and how to send to Event Hubs as a publisher, see the [Service Bus Event Hubs Large Scale Secure Publishing](https://code.msdn.microsoft.com/Service-Bus-Event-Hub-99ce67ab) sample.\n\n## Next steps\n\nTo learn more about Event Hubs scenarios, visit these links:\n\n- [Event Hubs API overview](event-hubs-api-overview.md)\n- [Event Hubs overview](event-hubs-overview.md)\n- [Event Hubs Code Samples](http://code.msdn.microsoft.com/site/search?query=event hub&f[0].Value=event hub&f[0].Type=SearchText&ac=5)\n- [Event processor host API reference](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx)\n\ntest\n"
}