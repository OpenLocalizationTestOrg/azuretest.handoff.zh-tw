{
  "nodes": [
    {
      "content": "Simulated hybrid cloud test environment | Microsoft Azure",
      "pos": [
        28,
        85
      ]
    },
    {
      "content": "Create a simulated hybrid cloud environment for IT pro or development testing, using two Azure virtual networks and a VNet-to-VNet connection.",
      "pos": [
        105,
        247
      ]
    },
    {
      "content": "Set up a simulated hybrid cloud environment for testing",
      "pos": [
        622,
        677
      ]
    },
    {
      "content": "This topic steps you through creating a simulated hybrid cloud environment with Microsoft Azure for testing using two separate Azure virtual networks.",
      "pos": [
        679,
        829
      ]
    },
    {
      "content": "Use this configuration as an alternative to",
      "pos": [
        830,
        873
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>Set up a hybrid cloud environment for testing<ept id=\"p1\">](virtual-networks-setup-hybrid-cloud-environment-testing.md)</ept> when you do not have a direct Internet connection and an available public IP address.",
      "pos": [
        875,
        1068
      ]
    },
    {
      "content": "Here is the resulting configuration.",
      "pos": [
        1069,
        1105
      ]
    },
    {
      "content": "This simulates a hybrid cloud production environment.",
      "pos": [
        1214,
        1267
      ]
    },
    {
      "content": "It consists of:",
      "pos": [
        1268,
        1283
      ]
    },
    {
      "content": "A simulated and simplified on-premises network hosted in an Azure virtual network (the TestLab virtual network).",
      "pos": [
        1287,
        1399
      ]
    },
    {
      "content": "A simulated cross-premises virtual network hosted in Azure (TestVNET).",
      "pos": [
        1402,
        1472
      ]
    },
    {
      "content": "A VNet-to-VNet connection between the two virtual networks.",
      "pos": [
        1475,
        1534
      ]
    },
    {
      "content": "A secondary domain controller in the TestVNET virtual network.",
      "pos": [
        1537,
        1599
      ]
    },
    {
      "content": "This provides a basis and common starting point from which you can:",
      "pos": [
        1601,
        1668
      ]
    },
    {
      "content": "Develop and test applications in a simulated hybrid cloud environment.",
      "pos": [
        1672,
        1742
      ]
    },
    {
      "content": "Create test configurations of computers, some within the TestLab virtual network and some within the TestVNET virtual network, to simulate hybrid cloud-based IT workloads.",
      "pos": [
        1745,
        1916
      ]
    },
    {
      "content": "There are four major phases to setting up this hybrid cloud test environment:",
      "pos": [
        1918,
        1995
      ]
    },
    {
      "content": "Configure the TestLab virtual network.",
      "pos": [
        2001,
        2039
      ]
    },
    {
      "content": "Create the cross-premises virtual network.",
      "pos": [
        2044,
        2086
      ]
    },
    {
      "content": "Create the VNet-to-VNet VPN connection.",
      "pos": [
        2091,
        2130
      ]
    },
    {
      "content": "Configure DC2.",
      "pos": [
        2135,
        2149
      ]
    },
    {
      "content": "If you don't already have an Azure subscription, you can sign up for a free trial at <bpt id=\"p1\">[</bpt>Try Azure<ept id=\"p1\">](http://azure.microsoft.com/pricing/free-trial/)</ept>.",
      "pos": [
        2152,
        2297
      ]
    },
    {
      "content": "If you have an MSDN Subscription, see <bpt id=\"p1\">[</bpt>Azure benefit for MSDN subscribers<ept id=\"p1\">](http://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/)</ept>.",
      "pos": [
        2298,
        2446
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> Virtual machines and virtual network gateways in Azure incur an ongoing monetary cost when they are running.",
      "pos": [
        2449,
        2570
      ]
    },
    {
      "content": "This cost is billed against your free trial, MSDN subscription, or paid subscription.",
      "pos": [
        2571,
        2656
      ]
    },
    {
      "content": "To reduce the costs of running this test environment when you are not using it, see <bpt id=\"p1\">[</bpt>Minimizing the ongoing costs of this environment<ept id=\"p1\">](#costs)</ept> in this topic for more information.",
      "pos": [
        2657,
        2835
      ]
    },
    {
      "content": "Phase 1: Configure the TestLab virtual network",
      "pos": [
        2841,
        2887
      ]
    },
    {
      "pos": [
        2889,
        3124
      ],
      "content": "Use the instructions in the <bpt id=\"p1\">[</bpt>Base Configuration Test Environment<ept id=\"p1\">](../virtual-machines/virtual-machines-base-configuration-test-environment.md)</ept> to configure the DC1, APP1, and CLIENT1 computers in an Azure virtual network named TestLab."
    },
    {
      "content": "From the Azure Management Portal on your local computer, connect to DC1 with the CORP\\User1 credentials.",
      "pos": [
        3127,
        3231
      ]
    },
    {
      "content": "To configure the CORP domain so that computers and users use their local domain controller for authentication, run these commands from an administrator-level Windows PowerShell command prompt.",
      "pos": [
        3232,
        3424
      ]
    },
    {
      "content": "This is your current configuration.",
      "pos": [
        3644,
        3679
      ]
    },
    {
      "content": "Phase 2: Create the TestVNET virtual network",
      "pos": [
        3792,
        3836
      ]
    },
    {
      "content": "First, create a new virtual network named TestVNET.",
      "pos": [
        3838,
        3889
      ]
    },
    {
      "pos": [
        3895,
        4010
      ],
      "content": "In the task bar of the Azure Management Portal, click <bpt id=\"p1\">**</bpt>New &gt; Network Services &gt; Virtual Network &gt; Custom Create<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        4015,
        4082
      ],
      "content": "On the Virtual Network Details page, type <bpt id=\"p1\">**</bpt>TestVNET<ept id=\"p1\">**</ept> in <bpt id=\"p2\">**</bpt>Name<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        4087,
        4136
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Location<ept id=\"p1\">**</ept>, select the appropriate location."
    },
    {
      "content": "Click the Next arrow.",
      "pos": [
        4141,
        4162
      ]
    },
    {
      "pos": [
        4167,
        4305
      ],
      "content": "On the DNS Servers and VPN Connectivity page, in <bpt id=\"p1\">**</bpt>DNS Servers<ept id=\"p1\">**</ept>, type <bpt id=\"p2\">**</bpt>DC1<ept id=\"p2\">**</ept> in <bpt id=\"p3\">**</bpt>Select or enter name<ept id=\"p3\">**</ept>, and then click the Next arrow."
    },
    {
      "content": "On the Virtual Network Address Spaces page:",
      "pos": [
        4310,
        4353
      ]
    },
    {
      "pos": [
        4360,
        4433
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Address Space<ept id=\"p1\">**</ept>, in <bpt id=\"p2\">**</bpt>Starting IP<ept id=\"p2\">**</ept>, select or type <bpt id=\"p3\">**</bpt>192.168.0.0<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        4440,
        4516
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Subnets<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>Subnet-1<ept id=\"p2\">**</ept> and replace the name with <bpt id=\"p3\">**</bpt>TestSubnet<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        4524,
        4603
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>CIDR (Address Count)<ept id=\"p1\">**</ept> column for the TestSubnet, click <bpt id=\"p2\">**</bpt>/24 (256)<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Click the Complete icon.",
      "pos": [
        4608,
        4632
      ]
    },
    {
      "content": "Wait until the virtual network is created before continuing.",
      "pos": [
        4633,
        4693
      ]
    },
    {
      "pos": [
        4695,
        4860
      ],
      "content": "Next, use the instructions in <bpt id=\"p1\">[</bpt>How to install and configure Azure PowerShell to install Azure PowerShell on your local computer<ept id=\"p1\">](../install-configure-powershell.md)</ept>."
    },
    {
      "content": "Next, create a new cloud service for the TestVNET virtual network.",
      "pos": [
        4862,
        4928
      ]
    },
    {
      "content": "You must pick a unique name.",
      "pos": [
        4929,
        4957
      ]
    },
    {
      "content": "For example, you could name it <bpt id=\"p1\">**</bpt>TestVNET-<ept id=\"p1\">**</ept><bpt id=\"p2\">*</bpt>UniqueSequence<ept id=\"p2\">*</ept>, in which <bpt id=\"p3\">*</bpt>UniqueSequence<ept id=\"p3\">*</ept> is an abbreviation of your organization.",
      "pos": [
        4958,
        5086
      ]
    },
    {
      "content": "For example, if your organization is named Tailspin Toys, you could name the cloud service <bpt id=\"p1\">**</bpt>TestVNET-Tailspin<ept id=\"p1\">**</ept>.",
      "pos": [
        5087,
        5200
      ]
    },
    {
      "content": "You can test for the uniqueness of the name with this Azure PowerShell command on your local computer.",
      "pos": [
        5202,
        5304
      ]
    },
    {
      "content": "If this command returns \"False\", your proposed name is unique.",
      "pos": [
        5365,
        5427
      ]
    },
    {
      "content": "Create the cloud service with this command.",
      "pos": [
        5428,
        5471
      ]
    },
    {
      "content": "This is your current configuration.",
      "pos": [
        5589,
        5624
      ]
    },
    {
      "content": "Phase 3: Create the VNet-to-VNet connection",
      "pos": [
        5736,
        5779
      ]
    },
    {
      "content": "First, you create local networks that represent the address space of each virtual network.",
      "pos": [
        5781,
        5871
      ]
    },
    {
      "pos": [
        5877,
        6005
      ],
      "content": "From the Azure Management Portal on your local computer, click <bpt id=\"p1\">**</bpt>New &gt; Network Services &gt; Virtual Network &gt; Add Local Network<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        6010,
        6174
      ],
      "content": "On the Specify your local network details page, type <bpt id=\"p1\">**</bpt>TestLabLNet<ept id=\"p1\">**</ept> in <bpt id=\"p2\">**</bpt>Name<ept id=\"p2\">**</ept>, type <bpt id=\"p3\">**</bpt>131.107.0.1<ept id=\"p3\">**</ept> in <bpt id=\"p4\">**</bpt>VPN Device IP Address<ept id=\"p4\">**</ept>, and then click the right arrow."
    },
    {
      "pos": [
        6179,
        6256
      ],
      "content": "On the Specify the address space page, in <bpt id=\"p1\">**</bpt>Starting I<ept id=\"p1\">**</ept>P, type <bpt id=\"p2\">**</bpt>10.0.0.0<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        6261,
        6342
      ],
      "content": "In <bpt id=\"p1\">**</bpt>CIDR (Address Count)<ept id=\"p1\">**</ept>, select <bpt id=\"p2\">**</bpt>/24 (256)<ept id=\"p2\">**</ept>, and then click the check mark."
    },
    {
      "pos": [
        6347,
        6418
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>New &gt; Network Services &gt; Virtual Network &gt; Add Local Network<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        6423,
        6588
      ],
      "content": "On the Specify your local network details page, type <bpt id=\"p1\">**</bpt>TestVNETLNet<ept id=\"p1\">**</ept> in <bpt id=\"p2\">**</bpt>Name<ept id=\"p2\">**</ept>, type <bpt id=\"p3\">**</bpt>131.107.0.2<ept id=\"p3\">**</ept> in <bpt id=\"p4\">**</bpt>VPN Device IP Address<ept id=\"p4\">**</ept>, and then click the right arrow."
    },
    {
      "pos": [
        6593,
        6673
      ],
      "content": "On the Specify the address space page, in <bpt id=\"p1\">**</bpt>Starting IP<ept id=\"p1\">**</ept>, type <bpt id=\"p2\">**</bpt>192.168.0.0<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        6678,
        6759
      ],
      "content": "In <bpt id=\"p1\">**</bpt>CIDR (Address Count)<ept id=\"p1\">**</ept>, select <bpt id=\"p2\">**</bpt>/24 (256)<ept id=\"p2\">**</ept>, and then click the check mark."
    },
    {
      "content": "Note that the VPN device IP addresses of 131.107.0.1 and 131.107.0.2 are just temporary placeholder values until you configure gateways for the two virtual networks.",
      "pos": [
        6761,
        6926
      ]
    },
    {
      "content": "Next, you configure each virtual network to use a site-to-site VPN connection and the local network corresponding to the other virtual network.",
      "pos": [
        6928,
        7071
      ]
    },
    {
      "pos": [
        7077,
        7252
      ],
      "content": "From the Azure Management Portal on your local computer, click <bpt id=\"p1\">**</bpt>Networks<ept id=\"p1\">**</ept> in the left pane, and then verify that the <bpt id=\"p2\">**</bpt>Status<ept id=\"p2\">**</ept> column for <bpt id=\"p3\">**</bpt>TestLab<ept id=\"p3\">**</ept> is set to <bpt id=\"p4\">**</bpt>Created<ept id=\"p4\">**</ept>."
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>TestLab<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Configure<ept id=\"p2\">**</ept>.",
      "pos": [
        7257,
        7305
      ]
    },
    {
      "content": "On the TestLab page, in the <bpt id=\"p1\">**</bpt>Site-to-Site Connectivity<ept id=\"p1\">**</ept> section, click <bpt id=\"p2\">**</bpt>Connect to the local network<ept id=\"p2\">**</ept>.",
      "pos": [
        7306,
        7412
      ]
    },
    {
      "pos": [
        7418,
        7464
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Local Network<ept id=\"p1\">**</ept>, select <bpt id=\"p2\">**</bpt>TestVNETLNet<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Save<ept id=\"p1\">**</ept> in the task bar.",
      "pos": [
        7469,
        7500
      ]
    },
    {
      "content": "In some cases, you might need to click <bpt id=\"p1\">**</bpt>Add Gateway Subnet<ept id=\"p1\">**</ept> to create a subnet used by the Azure VPN gateway.",
      "pos": [
        7501,
        7612
      ]
    },
    {
      "pos": [
        7617,
        7732
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Networks<ept id=\"p1\">**</ept> in the left pane, and then verify that the <bpt id=\"p2\">**</bpt>Status<ept id=\"p2\">**</ept> column for TestVNET is set to <bpt id=\"p3\">**</bpt>Created<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>TestVNET<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Configure<ept id=\"p2\">**</ept>.",
      "pos": [
        7737,
        7786
      ]
    },
    {
      "content": "On the TestVNET page, in the <bpt id=\"p1\">**</bpt>Site-to-Site Connectivity<ept id=\"p1\">**</ept> section, click <bpt id=\"p2\">**</bpt>Connect to the local network<ept id=\"p2\">**</ept>.",
      "pos": [
        7787,
        7894
      ]
    },
    {
      "pos": [
        7900,
        7945
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Local Network<ept id=\"p1\">**</ept>, select <bpt id=\"p2\">**</bpt>TestLabLNet<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Save<ept id=\"p1\">**</ept> in the task bar.",
      "pos": [
        7950,
        7981
      ]
    },
    {
      "content": "In some cases, you might need to click <bpt id=\"p1\">**</bpt>Add Gateway Subnet<ept id=\"p1\">**</ept> to create a subnet used by the Azure VPN gateway.",
      "pos": [
        7982,
        8093
      ]
    },
    {
      "content": "Next, you create virtual network gateways for the two virtual networks.",
      "pos": [
        8095,
        8166
      ]
    },
    {
      "content": "From the Azure Management Portal, on the <bpt id=\"p1\">**</bpt>Networks<ept id=\"p1\">**</ept> page, click <bpt id=\"p2\">**</bpt>TestLab<ept id=\"p2\">**</ept>.",
      "pos": [
        8172,
        8250
      ]
    },
    {
      "content": "On the Dashboard page, you should see a status of <bpt id=\"p1\">**</bpt>The Gateway Was Not Created<ept id=\"p1\">**</ept>.",
      "pos": [
        8251,
        8333
      ]
    },
    {
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Create Gateway<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Dynamic Routing<ept id=\"p2\">**</ept>.",
      "pos": [
        8338,
        8416
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept> when prompted.",
      "pos": [
        8417,
        8445
      ]
    },
    {
      "content": "Wait until the gateway is complete and its status changes to <bpt id=\"p1\">**</bpt>Connecting<ept id=\"p1\">**</ept>.",
      "pos": [
        8446,
        8522
      ]
    },
    {
      "content": "This could take a few minutes.",
      "pos": [
        8523,
        8553
      ]
    },
    {
      "content": "From the Dashboard page, note the <bpt id=\"p1\">**</bpt>Gateway IP Address<ept id=\"p1\">**</ept>.",
      "pos": [
        8558,
        8615
      ]
    },
    {
      "content": "This is the public IP address of the Azure VPN gateway for the TestLab virtual network.",
      "pos": [
        8616,
        8703
      ]
    },
    {
      "content": "Record this IP address, as you will need this to configure the VNet-to-VNet connection.",
      "pos": [
        8704,
        8791
      ]
    },
    {
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Manage Key<ept id=\"p1\">**</ept>, and the click the copy icon next to the key to copy it to your clipboard.",
      "pos": [
        8796,
        8908
      ]
    },
    {
      "content": "Paste this key into a document and save it.",
      "pos": [
        8909,
        8952
      ]
    },
    {
      "content": "You need this key value to configure the VNet-to-VNet connection.",
      "pos": [
        8953,
        9018
      ]
    },
    {
      "content": "On the Networks page, click <bpt id=\"p1\">**</bpt>TestVNET<ept id=\"p1\">**</ept>.",
      "pos": [
        9023,
        9064
      ]
    },
    {
      "content": "On the Dashboard page, you should see a status of <bpt id=\"p1\">**</bpt>The Gateway Was Not Created<ept id=\"p1\">**</ept>.",
      "pos": [
        9065,
        9147
      ]
    },
    {
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Create Gateway<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Dynamic Routing<ept id=\"p2\">**</ept>.",
      "pos": [
        9152,
        9230
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept> when prompted.",
      "pos": [
        9231,
        9259
      ]
    },
    {
      "content": "Wait until the gateway is complete and its status changes to <bpt id=\"p1\">**</bpt>Connecting<ept id=\"p1\">**</ept>.",
      "pos": [
        9260,
        9336
      ]
    },
    {
      "content": "This could take a few minutes.",
      "pos": [
        9337,
        9367
      ]
    },
    {
      "content": "From the Dashboard page, note the <bpt id=\"p1\">**</bpt>Gateway IP Address<ept id=\"p1\">**</ept>.",
      "pos": [
        9372,
        9429
      ]
    },
    {
      "content": "This is the public IP address of the Azure VPN gateway for the TestVNET virtual network.",
      "pos": [
        9430,
        9518
      ]
    },
    {
      "content": "Record this IP address, as you will need this to configure the VNet-to-VNet connection.",
      "pos": [
        9519,
        9606
      ]
    },
    {
      "content": "Next, you configure the TestLabLNet and TestVNETLNet local networks with the public IP addresses obtained from creating the virtual network gateways.",
      "pos": [
        9608,
        9757
      ]
    },
    {
      "pos": [
        9763,
        9844
      ],
      "content": "From the Azure Management Portal, on the Networks page, click <bpt id=\"p1\">**</bpt>Local Networks<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        9850,
        9913
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>TestLabLNet<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Edit<ept id=\"p2\">**</ept> in the task bar."
    },
    {
      "pos": [
        9918,
        10161
      ],
      "content": "On the Specify your local network details page, type the IP address of the virtual network gateway for the TestLab virtual network (from step 3 in the previous procedure) in <bpt id=\"p1\">**</bpt>VPN Device IP Address (Optional)<ept id=\"p1\">**</ept>, and then click the right arrow."
    },
    {
      "content": "On the Specify the address space page, click the check mark.",
      "pos": [
        10166,
        10226
      ]
    },
    {
      "pos": [
        10231,
        10323
      ],
      "content": "On the Local Networks page, click <bpt id=\"p1\">**</bpt>TestVNETLNet<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Edit<ept id=\"p2\">**</ept> in the task bar."
    },
    {
      "pos": [
        10328,
        10572
      ],
      "content": "On the Specify your local network details page, type the IP address of the virtual network gateway for the TestVNET virtual network (from step 7 in the previous procedure) in <bpt id=\"p1\">**</bpt>VPN Device IP Address (Optional)<ept id=\"p1\">**</ept>, and then click the right arrow."
    },
    {
      "content": "On the Specify the address space page, click the check mark.",
      "pos": [
        10577,
        10637
      ]
    },
    {
      "content": "Next, you will configure the pre-shared key for both gateways to use the same value, which is the key value determined by the Azure Management Portal for the TestLab virtual network.",
      "pos": [
        10639,
        10821
      ]
    },
    {
      "content": "Run these commands from an Azure PowerShell command prompt on your local computer, filling in the value of the TestLab pre-shared key.",
      "pos": [
        10822,
        10956
      ]
    },
    {
      "content": "Next, on the Network page of the Azure Management Portal on your local computer, click the <bpt id=\"p1\">**</bpt>TestLab<ept id=\"p1\">**</ept> virtual network, click <bpt id=\"p2\">**</bpt>Dashboard<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Connect<ept id=\"p3\">**</ept> in the task bar.",
      "pos": [
        11137,
        11321
      ]
    },
    {
      "content": "Wait until the TestLab virtual network shows a connected state.",
      "pos": [
        11322,
        11385
      ]
    },
    {
      "content": "This is your current configuration.",
      "pos": [
        11387,
        11422
      ]
    },
    {
      "content": "Phase 4: Configure DC2",
      "pos": [
        11535,
        11557
      ]
    },
    {
      "content": "First, create an Azure Virtual Machine for DC2.",
      "pos": [
        11559,
        11606
      ]
    },
    {
      "content": "Run these commands at the Azure PowerShell command prompt on your local computer.",
      "pos": [
        11607,
        11688
      ]
    },
    {
      "content": "Next, log on to the new DC2 virtual machine.",
      "pos": [
        12534,
        12578
      ]
    },
    {
      "pos": [
        12584,
        12721
      ],
      "content": "In the left pane of the Azure Management Portal, click <bpt id=\"p1\">**</bpt>Virtual Machines<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Running<ept id=\"p2\">**</ept> in the <bpt id=\"p3\">**</bpt>Status<ept id=\"p3\">**</ept> column for DC2."
    },
    {
      "pos": [
        12726,
        12761
      ],
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Connect<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        12767,
        12813
      ],
      "content": "When prompted to open DC2.rdp, click <bpt id=\"p1\">**</bpt>Open<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        12818,
        12896
      ],
      "content": "When prompted with a Remote Desktop Connection message box, click <bpt id=\"p1\">**</bpt>Connect<ept id=\"p1\">**</ept>."
    },
    {
      "content": "When prompted for credentials, use these:",
      "pos": [
        12901,
        12942
      ]
    },
    {
      "pos": [
        12945,
        12994
      ],
      "content": "Name: <bpt id=\"p1\">**</bpt>DC2\\\\<ept id=\"p1\">**</ept>[Local administrator account name]"
    },
    {
      "content": "Password: [Local administrator account password]",
      "pos": [
        12997,
        13045
      ]
    },
    {
      "pos": [
        13050,
        13150
      ],
      "content": "When prompted with a Remote Desktop Connection message box referring to certificates, click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Next, configure a Windows Firewall rule to allow traffic for basic connectivity testing.",
      "pos": [
        13152,
        13240
      ]
    },
    {
      "content": "From an administrator-level Windows PowerShell command prompt on DC2, run these commands.",
      "pos": [
        13241,
        13330
      ]
    },
    {
      "content": "The ping command should result in four successful replies from IP address 10.0.0.4.",
      "pos": [
        13468,
        13551
      ]
    },
    {
      "content": "This is a test of traffic across the Vnet-to-Vnet connection.",
      "pos": [
        13552,
        13613
      ]
    },
    {
      "content": "Next, add the extra data disk as a new volume with the drive letter F:.",
      "pos": [
        13615,
        13686
      ]
    },
    {
      "pos": [
        13692,
        13790
      ],
      "content": "In the left pane of Server Manager, click <bpt id=\"p1\">**</bpt>File and Storage Services<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Disks<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        13795,
        13902
      ],
      "content": "In the contents pane, in the <bpt id=\"p1\">**</bpt>Disks<ept id=\"p1\">**</ept> group, click <bpt id=\"p2\">**</bpt>disk 2<ept id=\"p2\">**</ept> (with the <bpt id=\"p3\">**</bpt>Partition<ept id=\"p3\">**</ept> set to <bpt id=\"p4\">**</bpt>Unknown<ept id=\"p4\">**</ept>)."
    },
    {
      "pos": [
        13907,
        13954
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Tasks<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>New Volume<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        13959,
        14029
      ],
      "content": "On the Before you begin page of the New Volume Wizard, click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>."
    },
    {
      "content": "On the Select the server and disk page, click <bpt id=\"p1\">**</bpt>Disk 2<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>.",
      "pos": [
        14034,
        14116
      ]
    },
    {
      "content": "When prompted, click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.",
      "pos": [
        14117,
        14145
      ]
    },
    {
      "pos": [
        14150,
        14209
      ],
      "content": "On the Specify the size of the volume page, click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        14214,
        14277
      ],
      "content": "On the Assign to a drive letter or folder page, click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        14282,
        14338
      ],
      "content": "On the Select file system settings page, click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        14343,
        14392
      ],
      "content": "On the Confirm selections page, click <bpt id=\"p1\">**</bpt>Create<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        14397,
        14428
      ],
      "content": "When complete, click <bpt id=\"p1\">**</bpt>Close<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Next, configure DC2 as a replica domain controller for the corp.contoso.com domain.",
      "pos": [
        14430,
        14513
      ]
    },
    {
      "content": "Run these commands from the Windows PowerShell command prompt on DC2.",
      "pos": [
        14514,
        14583
      ]
    },
    {
      "content": "Note that you are prompted to supply both the CORP\\User1 password and a Directory Services Restore Mode (DSRM) password, and to restart DC2.",
      "pos": [
        14845,
        14985
      ]
    },
    {
      "content": "Now that the TestVNET virtual network has its own DNS server (DC2), you must configure the TestVNET virtual network to use this DNS server.",
      "pos": [
        14987,
        15126
      ]
    },
    {
      "pos": [
        15132,
        15229
      ],
      "content": "In the left pane of the Azure Management Portal, click <bpt id=\"p1\">**</bpt>Networks<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>TestVNET<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        15234,
        15254
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Configure<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        15259,
        15305
      ],
      "content": "In <bpt id=\"p1\">**</bpt>DNS Servers<ept id=\"p1\">**</ept>, remove the 10.0.0.4 entry."
    },
    {
      "pos": [
        15310,
        15406
      ],
      "content": "In <bpt id=\"p1\">**</bpt>DNS Servers<ept id=\"p1\">**</ept>, add an entry with <bpt id=\"p2\">**</bpt>DC2<ept id=\"p2\">**</ept> as the name and <bpt id=\"p3\">**</bpt>192.168.0.4<ept id=\"p3\">**</ept> as the IP address."
    },
    {
      "content": "In the command bar at the bottom, click <bpt id=\"p1\">**</bpt>Save<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Yes<ept id=\"p2\">**</ept> when prompted.",
      "pos": [
        15412,
        15499
      ]
    },
    {
      "content": "Wait until the update to the TestVNet network is complete.",
      "pos": [
        15500,
        15558
      ]
    },
    {
      "content": "This is your current configuration.",
      "pos": [
        15560,
        15595
      ]
    },
    {
      "content": "Your simulated hybrid cloud environment is now ready for testing.",
      "pos": [
        15705,
        15770
      ]
    },
    {
      "content": "You can also build these configurations in this test environment:",
      "pos": [
        15772,
        15837
      ]
    },
    {
      "content": "SharePoint intranet farm",
      "pos": [
        15842,
        15866
      ]
    },
    {
      "content": "Web-based LOB application",
      "pos": [
        15930,
        15955
      ]
    },
    {
      "content": "Office 365 Directory Synchronization (DirSync) server",
      "pos": [
        16015,
        16068
      ]
    },
    {
      "content": "Additional resources",
      "pos": [
        16130,
        16150
      ]
    },
    {
      "content": "Set up a hybrid cloud environment for testing",
      "pos": [
        16153,
        16198
      ]
    },
    {
      "content": "Configure a VNet to VNet Connection",
      "pos": [
        16262,
        16297
      ]
    },
    {
      "content": "Base Configuration Test Environment",
      "pos": [
        16371,
        16406
      ]
    },
    {
      "content": "Azure hybrid cloud test environments",
      "pos": [
        16487,
        16523
      ]
    },
    {
      "content": "Azure infrastructure services implementation guidelines",
      "pos": [
        16599,
        16654
      ]
    },
    {
      "pos": [
        16751,
        16817
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"costs\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Minimizing the ongoing costs of this environment"
    },
    {
      "content": "To minimize the costs of running the virtual machines in this environment, perform your needed testing and demonstration as quickly as possible and then delete them or shut down the virtual machines when you are not using them.",
      "pos": [
        16819,
        17046
      ]
    },
    {
      "content": "For example, you could use Azure automation and a runbook to automatically shut down the virtual machines in the TestLab and Test_VNET virtual networks at the end of each business day.",
      "pos": [
        17047,
        17231
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Get started with Azure Automation<ept id=\"p1\">](../automation-create-runbook-from-samples.md)</ept>.",
      "pos": [
        17232,
        17340
      ]
    },
    {
      "content": "When you start the virtual machines on the Corpnet subnet again, start DC1 first.",
      "pos": [
        17341,
        17422
      ]
    },
    {
      "content": "An Azure VPN gateway is implemented as a set of two Azure virtual machines that incur an ongoing monetary cost.",
      "pos": [
        17424,
        17535
      ]
    },
    {
      "content": "For the details, see <bpt id=\"p1\">[</bpt>Pricing - Virtual Network<ept id=\"p1\">](http://azure.microsoft.com/pricing/details/virtual-network/)</ept>.",
      "pos": [
        17536,
        17646
      ]
    },
    {
      "content": "To minimize the costs of the two VPN gateways (one for TestLab and one for TestVNET), create the test environment and perform your needed testing and demonstration as quickly as possible or delete the gateways with these steps.",
      "pos": [
        17647,
        17874
      ]
    },
    {
      "pos": [
        17881,
        18023
      ],
      "content": "From the Azure Management Portal on your local computer, click <bpt id=\"p1\">**</bpt>Networks<ept id=\"p1\">**</ept> in the left pane, click <bpt id=\"p2\">**</bpt>TestLab<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Dashboard<ept id=\"p3\">**</ept>."
    },
    {
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Delete Gateway<ept id=\"p1\">**</ept>.",
      "pos": [
        18028,
        18070
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept> when prompted.",
      "pos": [
        18071,
        18099
      ]
    },
    {
      "content": "Wait until the gateway is deleted and its status changes to <bpt id=\"p1\">**</bpt>The Gateway Was Not Created<ept id=\"p1\">**</ept>.",
      "pos": [
        18100,
        18192
      ]
    },
    {
      "pos": [
        18197,
        18283
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Networks<ept id=\"p1\">**</ept> in the left pane, click <bpt id=\"p2\">**</bpt>TestVNET<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Dashboard<ept id=\"p3\">**</ept>."
    },
    {
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Delete Gateway<ept id=\"p1\">**</ept>.",
      "pos": [
        18288,
        18330
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept> when prompted.",
      "pos": [
        18331,
        18359
      ]
    },
    {
      "content": "Wait until the gateway is deleted and its status changes to <bpt id=\"p1\">**</bpt>The Gateway Was Not Created<ept id=\"p1\">**</ept>.",
      "pos": [
        18360,
        18452
      ]
    },
    {
      "content": "If you delete the gateways and you want to restore this test environment, you must first create new gateways.",
      "pos": [
        18454,
        18563
      ]
    },
    {
      "content": "From the Azure Management Portal on your local computer, click <bpt id=\"p1\">**</bpt>Networks<ept id=\"p1\">**</ept> in the left pane, and then click <bpt id=\"p2\">**</bpt>TestLab<ept id=\"p2\">**</ept>.",
      "pos": [
        18569,
        18690
      ]
    },
    {
      "content": "On the Dashboard page, you should see a status of <bpt id=\"p1\">**</bpt>The Gateway Was Not Created<ept id=\"p1\">**</ept>.",
      "pos": [
        18691,
        18773
      ]
    },
    {
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Create Gateway<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Dynamic Routing<ept id=\"p2\">**</ept>.",
      "pos": [
        18778,
        18856
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept> when prompted.",
      "pos": [
        18857,
        18885
      ]
    },
    {
      "content": "Wait until the gateway is complete and its status changes to <bpt id=\"p1\">**</bpt>Connecting<ept id=\"p1\">**</ept>.",
      "pos": [
        18886,
        18962
      ]
    },
    {
      "content": "This could take a few minutes.",
      "pos": [
        18963,
        18993
      ]
    },
    {
      "content": "From the Dashboard page, note the <bpt id=\"p1\">**</bpt>Gateway IP Address<ept id=\"p1\">**</ept>.",
      "pos": [
        18998,
        19055
      ]
    },
    {
      "content": "This is the new public IP address of the Azure VPN gateway for the TestLab virtual network.",
      "pos": [
        19056,
        19147
      ]
    },
    {
      "content": "You need this IP address to re-configure the TestLabLNet local network.",
      "pos": [
        19148,
        19219
      ]
    },
    {
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Manage Key<ept id=\"p1\">**</ept>, and then click the copy icon next to the key to copy it to your clipboard.",
      "pos": [
        19224,
        19337
      ]
    },
    {
      "content": "Paste this key value into a document and save it.",
      "pos": [
        19338,
        19387
      ]
    },
    {
      "content": "You need this key value to re-configure the VPN gateway for the TestVNET virtual network.",
      "pos": [
        19388,
        19477
      ]
    },
    {
      "content": "From the Azure Management Portal on your local computer, click <bpt id=\"p1\">**</bpt>Networks<ept id=\"p1\">**</ept> in the left pane, and then click <bpt id=\"p2\">**</bpt>TestVNET<ept id=\"p2\">**</ept>.",
      "pos": [
        19482,
        19604
      ]
    },
    {
      "content": "On the Dashboard page, you should see a status of <bpt id=\"p1\">**</bpt>The Gateway Was Not Created<ept id=\"p1\">**</ept>.",
      "pos": [
        19605,
        19687
      ]
    },
    {
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Create Gateway<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Dynamic Routing<ept id=\"p2\">**</ept>.",
      "pos": [
        19692,
        19770
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept> when prompted.",
      "pos": [
        19771,
        19799
      ]
    },
    {
      "content": "Wait until the gateway is complete and its status changes to Connecting.",
      "pos": [
        19800,
        19872
      ]
    },
    {
      "content": "This could take a few minutes.",
      "pos": [
        19873,
        19903
      ]
    },
    {
      "content": "From the Dashboard page, note the <bpt id=\"p1\">**</bpt>Gateway IP Address<ept id=\"p1\">**</ept>.",
      "pos": [
        19908,
        19965
      ]
    },
    {
      "content": "This is the new public IP address of the Azure VPN gateway for the TestVNET virtual network.",
      "pos": [
        19966,
        20058
      ]
    },
    {
      "content": "You need this IP address to re-configure the TestVNETLNet local network.",
      "pos": [
        20059,
        20131
      ]
    },
    {
      "content": "Next, you configure the TestLabLNet and TestVNETLNet local networks with the new public IP addresses obtained from creating the virtual network gateways.",
      "pos": [
        20133,
        20286
      ]
    },
    {
      "pos": [
        20292,
        20373
      ],
      "content": "From the Azure Management Portal, on the Networks page, click <bpt id=\"p1\">**</bpt>Local Networks<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        20379,
        20442
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>TestLabLNet<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Edit<ept id=\"p2\">**</ept> in the task bar."
    },
    {
      "pos": [
        20447,
        20690
      ],
      "content": "On the Specify your local network details page, type the IP address of the virtual network gateway for the TestLab virtual network (from step 3 in the previous procedure) in <bpt id=\"p1\">**</bpt>VPN Device IP Address (Optional)<ept id=\"p1\">**</ept>, and then click the right arrow."
    },
    {
      "content": "On the Specify the address space page, click the check mark.",
      "pos": [
        20695,
        20755
      ]
    },
    {
      "pos": [
        20760,
        20852
      ],
      "content": "On the Local Networks page, click <bpt id=\"p1\">**</bpt>TestVNETLNet<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Edit<ept id=\"p2\">**</ept> in the task bar."
    },
    {
      "pos": [
        20857,
        21101
      ],
      "content": "On the Specify your local network details page, type the IP address of the virtual network gateway for the TestVNET virtual network (from step 7 in the previous procedure) in <bpt id=\"p1\">**</bpt>VPN Device IP Address (Optional)<ept id=\"p1\">**</ept>, and then click the right arrow."
    },
    {
      "content": "On the Specify the address space page, click the check mark.",
      "pos": [
        21106,
        21166
      ]
    },
    {
      "content": "Next, you configure the pre-shared key for both gateways to use the same value, which is the key value determined by the Azure Management Portal for the TestLab virtual network.",
      "pos": [
        21168,
        21345
      ]
    },
    {
      "content": "Run these commands from an Azure PowerShell command prompt on your local computer, filling in the value of the TestLab pre-shared key.",
      "pos": [
        21346,
        21480
      ]
    },
    {
      "content": "Next, on the Network page of the Azure Management Portal, click the <bpt id=\"p1\">**</bpt>TestLab<ept id=\"p1\">**</ept> virtual network, and then click <bpt id=\"p2\">**</bpt>Connect<ept id=\"p2\">**</ept> in the task bar.",
      "pos": [
        21661,
        21801
      ]
    },
    {
      "content": "Wait until the TestLab virtual network shows a connected state to the TestVNET local network.",
      "pos": [
        21802,
        21895
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"Simulated hybrid cloud test environment | Microsoft Azure\" \n    description=\"Create a simulated hybrid cloud environment for IT pro or development testing, using two Azure virtual networks and a VNet-to-VNet connection.\" \n    services=\"virtual-network\" \n    documentationCenter=\"\" \n    authors=\"JoeDavies-MSFT\" \n    manager=\"timlt\" \n    editor=\"\"\n    tags=\"azure-service-management\"/>\n\n<tags \n    ms.service=\"virtual-network\" \n    ms.workload=\"infrastructure-services\" \n    ms.tgt_pltfrm=\"na\" \n    ms.devlang=\"na\" \n    ms.topic=\"article\" \n    ms.date=\"07/08/2015\" \n    ms.author=\"josephd\"/>\n\n# Set up a simulated hybrid cloud environment for testing\n\nThis topic steps you through creating a simulated hybrid cloud environment with Microsoft Azure for testing using two separate Azure virtual networks. Use this configuration as an alternative to \n[Set up a hybrid cloud environment for testing](virtual-networks-setup-hybrid-cloud-environment-testing.md) when you do not have a direct Internet connection and an available public IP address. Here is the resulting configuration.\n\n![](./media/virtual-networks-setup-simulated-hybrid-cloud-environment-testing/CreateSimHybridCloud_4.png)\n\nThis simulates a hybrid cloud production environment. It consists of:\n\n- A simulated and simplified on-premises network hosted in an Azure virtual network (the TestLab virtual network).\n- A simulated cross-premises virtual network hosted in Azure (TestVNET).\n- A VNet-to-VNet connection between the two virtual networks.\n- A secondary domain controller in the TestVNET virtual network.\n\nThis provides a basis and common starting point from which you can:\n\n- Develop and test applications in a simulated hybrid cloud environment.\n- Create test configurations of computers, some within the TestLab virtual network and some within the TestVNET virtual network, to simulate hybrid cloud-based IT workloads.\n\nThere are four major phases to setting up this hybrid cloud test environment:\n\n1.  Configure the TestLab virtual network.\n2.  Create the cross-premises virtual network.\n3.  Create the VNet-to-VNet VPN connection.\n4.  Configure DC2. \n\nIf you don't already have an Azure subscription, you can sign up for a free trial at [Try Azure](http://azure.microsoft.com/pricing/free-trial/). If you have an MSDN Subscription, see [Azure benefit for MSDN subscribers](http://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/).\n\n>[AZURE.NOTE] Virtual machines and virtual network gateways in Azure incur an ongoing monetary cost when they are running. This cost is billed against your free trial, MSDN subscription, or paid subscription. To reduce the costs of running this test environment when you are not using it, see [Minimizing the ongoing costs of this environment](#costs) in this topic for more information.\n\n\n## Phase 1: Configure the TestLab virtual network\n\nUse the instructions in the [Base Configuration Test Environment](../virtual-machines/virtual-machines-base-configuration-test-environment.md) to configure the DC1, APP1, and CLIENT1 computers in an Azure virtual network named TestLab. \n\nFrom the Azure Management Portal on your local computer, connect to DC1 with the CORP\\User1 credentials. To configure the CORP domain so that computers and users use their local domain controller for authentication, run these commands from an administrator-level Windows PowerShell command prompt.\n\n    New-ADReplicationSite -Name \"TestLab\" \n    New-ADReplicationSite -Name \"TestVNET\"\n    New-ADReplicationSubnet –Name \"10.0.0.0/8\" –Site \"TestLab\"\n    New-ADReplicationSubnet –Name \"192.168.0.0/16\" –Site \"TestVNET\"\n\nThis is your current configuration.\n\n![](./media/virtual-networks-setup-simulated-hybrid-cloud-environment-testing/CreateSimHybridCloud_1.png)\n \n## Phase 2: Create the TestVNET virtual network\n\nFirst, create a new virtual network named TestVNET.\n\n1.  In the task bar of the Azure Management Portal, click **New > Network Services > Virtual Network > Custom Create**.\n2.  On the Virtual Network Details page, type **TestVNET** in **Name**.\n3.  In **Location**, select the appropriate location.\n4.  Click the Next arrow.\n5.  On the DNS Servers and VPN Connectivity page, in **DNS Servers**, type **DC1** in **Select or enter name**, and then click the Next arrow.\n6.  On the Virtual Network Address Spaces page:\n    - In **Address Space**, in **Starting IP**, select or type **192.168.0.0**.\n    - In **Subnets**, click **Subnet-1** and replace the name with **TestSubnet**. \n    - In the **CIDR (Address Count)** column for the TestSubnet, click **/24 (256)**.\n7.  Click the Complete icon. Wait until the virtual network is created before continuing.\n\nNext, use the instructions in [How to install and configure Azure PowerShell to install Azure PowerShell on your local computer](../install-configure-powershell.md).\n\nNext, create a new cloud service for the TestVNET virtual network. You must pick a unique name. For example, you could name it **TestVNET-***UniqueSequence*, in which *UniqueSequence* is an abbreviation of your organization. For example, if your organization is named Tailspin Toys, you could name the cloud service **TestVNET-Tailspin**.\n\nYou can test for the uniqueness of the name with this Azure PowerShell command on your local computer.\n\n    Test-AzureName -Service <Proposed cloud service name>\n\nIf this command returns \"False\", your proposed name is unique. Create the cloud service with this command.\n\n    New-AzureService -Service <Unique cloud service name> -Location \"<Same location name as your virtual network>\"\n\nThis is your current configuration.\n\n![](./media/virtual-networks-setup-simulated-hybrid-cloud-environment-testing/CreateSimHybridCloud_2.png)\n \n##Phase 3: Create the VNet-to-VNet connection\n\nFirst, you create local networks that represent the address space of each virtual network.\n\n1.  From the Azure Management Portal on your local computer, click **New > Network Services > Virtual Network > Add Local Network**.\n2.  On the Specify your local network details page, type **TestLabLNet** in **Name**, type **131.107.0.1** in **VPN Device IP Address**, and then click the right arrow.\n3.  On the Specify the address space page, in **Starting I**P, type **10.0.0.0**.\n4.  In **CIDR (Address Count)**, select **/24 (256)**, and then click the check mark.\n5.  Click **New > Network Services > Virtual Network > Add Local Network**.\n6.  On the Specify your local network details page, type **TestVNETLNet** in **Name**, type **131.107.0.2** in **VPN Device IP Address**, and then click the right arrow.\n7.  On the Specify the address space page, in **Starting IP**, type **192.168.0.0**.\n8.  In **CIDR (Address Count)**, select **/24 (256)**, and then click the check mark.\n\nNote that the VPN device IP addresses of 131.107.0.1 and 131.107.0.2 are just temporary placeholder values until you configure gateways for the two virtual networks.\n\nNext, you configure each virtual network to use a site-to-site VPN connection and the local network corresponding to the other virtual network.\n\n1.  From the Azure Management Portal on your local computer, click **Networks** in the left pane, and then verify that the **Status** column for **TestLab** is set to **Created**.\n2.  Click **TestLab**, and then click **Configure**. On the TestLab page, in the **Site-to-Site Connectivity** section, click **Connect to the local network**. \n3.  In **Local Network**, select **TestVNETLNet**.\n4.  Click **Save** in the task bar. In some cases, you might need to click **Add Gateway Subnet** to create a subnet used by the Azure VPN gateway.\n5.  Click **Networks** in the left pane, and then verify that the **Status** column for TestVNET is set to **Created**.\n6.  Click **TestVNET**, and then click **Configure**. On the TestVNET page, in the **Site-to-Site Connectivity** section, click **Connect to the local network**. \n7.  In **Local Network**, select **TestLabLNet**.\n8.  Click **Save** in the task bar. In some cases, you might need to click **Add Gateway Subnet** to create a subnet used by the Azure VPN gateway.\n\nNext, you create virtual network gateways for the two virtual networks.\n\n1.  From the Azure Management Portal, on the **Networks** page, click **TestLab**. On the Dashboard page, you should see a status of **The Gateway Was Not Created**.\n2.  In the task bar, click **Create Gateway**, and then click **Dynamic Routing**. Click **Yes** when prompted. Wait until the gateway is complete and its status changes to **Connecting**. This could take a few minutes.\n3.  From the Dashboard page, note the **Gateway IP Address**. This is the public IP address of the Azure VPN gateway for the TestLab virtual network. Record this IP address, as you will need this to configure the VNet-to-VNet connection.\n4.  In the task bar, click **Manage Key**, and the click the copy icon next to the key to copy it to your clipboard. Paste this key into a document and save it. You need this key value to configure the VNet-to-VNet connection.\n5.  On the Networks page, click **TestVNET**. On the Dashboard page, you should see a status of **The Gateway Was Not Created**.\n6.  In the task bar, click **Create Gateway**, and then click **Dynamic Routing**. Click **Yes** when prompted. Wait until the gateway is complete and its status changes to **Connecting**. This could take a few minutes.\n7.  From the Dashboard page, note the **Gateway IP Address**. This is the public IP address of the Azure VPN gateway for the TestVNET virtual network. Record this IP address, as you will need this to configure the VNet-to-VNet connection.\n\nNext, you configure the TestLabLNet and TestVNETLNet local networks with the public IP addresses obtained from creating the virtual network gateways.\n\n1.  From the Azure Management Portal, on the Networks page, click **Local Networks**. \n2.  Click **TestLabLNet**, and then click **Edit** in the task bar.\n3.  On the Specify your local network details page, type the IP address of the virtual network gateway for the TestLab virtual network (from step 3 in the previous procedure) in **VPN Device IP Address (Optional)**, and then click the right arrow.\n4.  On the Specify the address space page, click the check mark.\n5.  On the Local Networks page, click **TestVNETLNet**, and then click **Edit** in the task bar.\n6.  On the Specify your local network details page, type the IP address of the virtual network gateway for the TestVNET virtual network (from step 7 in the previous procedure) in **VPN Device IP Address (Optional)**, and then click the right arrow.\n7.  On the Specify the address space page, click the check mark.\n\nNext, you will configure the pre-shared key for both gateways to use the same value, which is the key value determined by the Azure Management Portal for the TestLab virtual network. Run these commands from an Azure PowerShell command prompt on your local computer, filling in the value of the TestLab pre-shared key.\n\n    $preSharedKey=\"<The preshared key for the TestLab virtual network>\"\n    Set-AzureVNetGatewayKey -VNetName TestVNET -LocalNetworkSiteName TestLabLNet –SharedKey $preSharedKey\n\nNext, on the Network page of the Azure Management Portal on your local computer, click the **TestLab** virtual network, click **Dashboard**, and then click **Connect** in the task bar. Wait until the TestLab virtual network shows a connected state.\n\nThis is your current configuration.\n\n![](./media/virtual-networks-setup-simulated-hybrid-cloud-environment-testing/CreateSimHybridCloud_3.png)\n \n## Phase 4: Configure DC2\n\nFirst, create an Azure Virtual Machine for DC2. Run these commands at the Azure PowerShell command prompt on your local computer.\n\n    $ServiceName=\"<Your cloud service name from Phase 2>\"\n    $cred=Get-Credential –Message \"Type the name and password of the local administrator account for DC2.\"\n    $image = Get-AzureVMImage | where { $_.ImageFamily -eq \"Windows Server 2012 R2 Datacenter\" } | sort PublishedDate -Descending | select -ExpandProperty ImageName -First 1\n    $vm1=New-AzureVMConfig -Name DC2 -InstanceSize Medium -ImageName $image\n    $vm1 | Add-AzureProvisioningConfig -Windows -AdminUsername $cred.GetNetworkCredential().Username -Password $cred.GetNetworkCredential().Password\n    $vm1 | Set-AzureSubnet -SubnetNames TestSubnet\n    $vm1 | Set-AzureStaticVNetIP -IPAddress 192.168.0.4\n    $vm1 | Add-AzureDataDisk -CreateNew -DiskSizeInGB 20 -DiskLabel ADFiles –LUN 0 -HostCaching None\n    New-AzureVM –ServiceName $ServiceName -VMs $vm1 -VNetName TestVNET\n\nNext, log on to the new DC2 virtual machine.\n\n1.  In the left pane of the Azure Management Portal, click **Virtual Machines**, and then click **Running** in the **Status** column for DC2.\n2.  In the task bar, click **Connect**. \n3.  When prompted to open DC2.rdp, click **Open**.\n4.  When prompted with a Remote Desktop Connection message box, click **Connect**.\n5.  When prompted for credentials, use these:\n- Name: **DC2\\\\**[Local administrator account name]\n- Password: [Local administrator account password]\n6.  When prompted with a Remote Desktop Connection message box referring to certificates, click **Yes**.\n\nNext, configure a Windows Firewall rule to allow traffic for basic connectivity testing. From an administrator-level Windows PowerShell command prompt on DC2, run these commands.\n\n    Set-NetFirewallRule -DisplayName \"File and Printer Sharing (Echo Request - ICMPv4-In)\" -enabled True\n    ping dc1.corp.contoso.com\n\nThe ping command should result in four successful replies from IP address 10.0.0.4. This is a test of traffic across the Vnet-to-Vnet connection.\n\nNext, add the extra data disk as a new volume with the drive letter F:.\n\n1.  In the left pane of Server Manager, click **File and Storage Services**, and then click **Disks**.\n2.  In the contents pane, in the **Disks** group, click **disk 2** (with the **Partition** set to **Unknown**).\n3.  Click **Tasks**, and then click **New Volume**.\n4.  On the Before you begin page of the New Volume Wizard, click **Next**.\n5.  On the Select the server and disk page, click **Disk 2**, and then click **Next**. When prompted, click **OK**.\n6.  On the Specify the size of the volume page, click **Next**.\n7.  On the Assign to a drive letter or folder page, click **Next**.\n8.  On the Select file system settings page, click **Next**.\n9.  On the Confirm selections page, click **Create**.\n10. When complete, click **Close**.\n\nNext, configure DC2 as a replica domain controller for the corp.contoso.com domain. Run these commands from the Windows PowerShell command prompt on DC2.\n\n    Install-WindowsFeature AD-Domain-Services -IncludeManagementTools\n    Install-ADDSDomainController -Credential (Get-Credential CORP\\User1) -DomainName \"corp.contoso.com\" -InstallDns:$true -DatabasePath \"F:\\NTDS\" -LogPath \"F:\\Logs\" -SysvolPath \"F:\\SYSVOL\"\n\nNote that you are prompted to supply both the CORP\\User1 password and a Directory Services Restore Mode (DSRM) password, and to restart DC2.\n\nNow that the TestVNET virtual network has its own DNS server (DC2), you must configure the TestVNET virtual network to use this DNS server.\n\n1.  In the left pane of the Azure Management Portal, click **Networks**, and then click **TestVNET**.\n2.  Click **Configure**.\n3.  In **DNS Servers**, remove the 10.0.0.4 entry.\n4.  In **DNS Servers**, add an entry with **DC2** as the name and **192.168.0.4** as the IP address. \n5.  In the command bar at the bottom, click **Save**, and then click **Yes** when prompted. Wait until the update to the TestVNet network is complete.\n\nThis is your current configuration.\n\n![](./media/virtual-networks-setup-simulated-hybrid-cloud-environment-testing/CreateSimHybridCloud_4.png)\n \nYour simulated hybrid cloud environment is now ready for testing.\n\nYou can also build these configurations in this test environment:\n\n- [SharePoint intranet farm](virtual-networks-setup-sharepoint-hybrid-cloud-testing.md)\n- [Web-based LOB application](virtual-networks-setup-lobapp-hybrid-cloud-testing.md)\n- [Office 365 Directory Synchronization (DirSync) server](virtual-networks-setup-dirsync-hybrid-cloud-testing.md)\n\n## Additional resources\n\n[Set up a hybrid cloud environment for testing](virtual-networks-setup-hybrid-cloud-environment-testing.md)\n\n[Configure a VNet to VNet Connection](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md)\n\n[Base Configuration Test Environment](../virtual-machines/virtual-machines-base-configuration-test-environment.md)\n\n[Azure hybrid cloud test environments](../virtual-machines/virtual-machines-hybrid-cloud-test-environments.md)\n\n[Azure infrastructure services implementation guidelines](../virtual-machines/virtual-machines-infrastructure-services-implementation-guidelines.md)\n\n## <a id=\"costs\"></a>Minimizing the ongoing costs of this environment\n\nTo minimize the costs of running the virtual machines in this environment, perform your needed testing and demonstration as quickly as possible and then delete them or shut down the virtual machines when you are not using them. For example, you could use Azure automation and a runbook to automatically shut down the virtual machines in the TestLab and Test_VNET virtual networks at the end of each business day. For more information, see [Get started with Azure Automation](../automation-create-runbook-from-samples.md). When you start the virtual machines on the Corpnet subnet again, start DC1 first.\n\nAn Azure VPN gateway is implemented as a set of two Azure virtual machines that incur an ongoing monetary cost. For the details, see [Pricing - Virtual Network](http://azure.microsoft.com/pricing/details/virtual-network/). To minimize the costs of the two VPN gateways (one for TestLab and one for TestVNET), create the test environment and perform your needed testing and demonstration as quickly as possible or delete the gateways with these steps.\n \n1.  From the Azure Management Portal on your local computer, click **Networks** in the left pane, click **TestLab**, and then click **Dashboard**.\n2.  In the task bar, click **Delete Gateway**. Click **Yes** when prompted. Wait until the gateway is deleted and its status changes to **The Gateway Was Not Created**.\n3.  Click **Networks** in the left pane, click **TestVNET**, and then click **Dashboard**.\n4.  In the task bar, click **Delete Gateway**. Click **Yes** when prompted. Wait until the gateway is deleted and its status changes to **The Gateway Was Not Created**.\n\nIf you delete the gateways and you want to restore this test environment, you must first create new gateways.\n\n1.  From the Azure Management Portal on your local computer, click **Networks** in the left pane, and then click **TestLab**. On the Dashboard page, you should see a status of **The Gateway Was Not Created**.\n2.  In the task bar, click **Create Gateway**, and then click **Dynamic Routing**. Click **Yes** when prompted. Wait until the gateway is complete and its status changes to **Connecting**. This could take a few minutes.\n3.  From the Dashboard page, note the **Gateway IP Address**. This is the new public IP address of the Azure VPN gateway for the TestLab virtual network. You need this IP address to re-configure the TestLabLNet local network.\n4.  In the task bar, click **Manage Key**, and then click the copy icon next to the key to copy it to your clipboard. Paste this key value into a document and save it. You need this key value to re-configure the VPN gateway for the TestVNET virtual network.\n5.  From the Azure Management Portal on your local computer, click **Networks** in the left pane, and then click **TestVNET**. On the Dashboard page, you should see a status of **The Gateway Was Not Created**.\n6.  In the task bar, click **Create Gateway**, and then click **Dynamic Routing**. Click **Yes** when prompted. Wait until the gateway is complete and its status changes to Connecting. This could take a few minutes.\n7.  From the Dashboard page, note the **Gateway IP Address**. This is the new public IP address of the Azure VPN gateway for the TestVNET virtual network. You need this IP address to re-configure the TestVNETLNet local network.\n\nNext, you configure the TestLabLNet and TestVNETLNet local networks with the new public IP addresses obtained from creating the virtual network gateways.\n\n1.  From the Azure Management Portal, on the Networks page, click **Local Networks**. \n2.  Click **TestLabLNet**, and then click **Edit** in the task bar.\n3.  On the Specify your local network details page, type the IP address of the virtual network gateway for the TestLab virtual network (from step 3 in the previous procedure) in **VPN Device IP Address (Optional)**, and then click the right arrow.\n4.  On the Specify the address space page, click the check mark.\n5.  On the Local Networks page, click **TestVNETLNet**, and then click **Edit** in the task bar.\n6.  On the Specify your local network details page, type the IP address of the virtual network gateway for the TestVNET virtual network (from step 7 in the previous procedure) in **VPN Device IP Address (Optional)**, and then click the right arrow.\n7.  On the Specify the address space page, click the check mark.\n\nNext, you configure the pre-shared key for both gateways to use the same value, which is the key value determined by the Azure Management Portal for the TestLab virtual network. Run these commands from an Azure PowerShell command prompt on your local computer, filling in the value of the TestLab pre-shared key.\n\n    $preSharedKey=\"<The preshared key for the TestLab virtual network>\"\n    Set-AzureVNetGatewayKey -VNetName TestVNET -LocalNetworkSiteName TestLabLNet –SharedKey $preSharedKey\n\nNext, on the Network page of the Azure Management Portal, click the **TestLab** virtual network, and then click **Connect** in the task bar. Wait until the TestLab virtual network shows a connected state to the TestVNET local network.\n \n"
}