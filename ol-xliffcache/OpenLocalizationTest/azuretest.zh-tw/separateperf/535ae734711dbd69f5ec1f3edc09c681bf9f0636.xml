{
  "nodes": [
    {
      "content": "Performance best practices for SQL Server in Azure Virtual Machines",
      "pos": [
        28,
        95
      ]
    },
    {
      "content": "Provides best practices for optimizing SQL Server performance in Microsoft Azure VMs.",
      "pos": [
        114,
        199
      ]
    },
    {
      "content": "Performance best practices for SQL Server in Azure Virtual Machines",
      "pos": [
        551,
        618
      ]
    },
    {
      "content": "Overview",
      "pos": [
        623,
        631
      ]
    },
    {
      "content": "This topic provides best practices for optimizing SQL Server performance in Microsoft Azure Virtual Machine.",
      "pos": [
        633,
        741
      ]
    },
    {
      "content": "While running SQL Server in Azure Virtual Machines, we recommend that you continue using the same database performance tuning options that are applicable to SQL Server in on-premises server environment.",
      "pos": [
        742,
        944
      ]
    },
    {
      "content": "However, the performance of a relational database in a public cloud depends on many factors such as the size of a virtual machine, and the configuration of the data disks.",
      "pos": [
        945,
        1116
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> This paper is focused on getting the best performance for SQL Server on Azure VMs.",
      "pos": [
        1119,
        1214
      ]
    },
    {
      "content": "If your workload is less demanding, you might not require every optimization listed below.",
      "pos": [
        1215,
        1305
      ]
    },
    {
      "content": "Consider your performance needs and workload patterns as you evaluate these recommendations.",
      "pos": [
        1306,
        1398
      ]
    },
    {
      "content": "For a companion resource on this topic, you can <bpt id=\"p1\">[</bpt>download the following white paper<ept id=\"p1\">](http://download.microsoft.com/download/D/2/0/D20E1C5F-72EA-4505-9F26-FEF9550EFD44/Performance%20Guidance%20for%20SQL%20Server%20in%20Windows%20Azure%20Virtual%20Machines.docx)</ept>.",
      "pos": [
        1400,
        1661
      ]
    },
    {
      "content": "Please note that the information in that white paper is outdated in some areas.",
      "pos": [
        1662,
        1741
      ]
    },
    {
      "content": "For example, it was written before the introduction of Premium Storage, which is now recommended for the best performance results.",
      "pos": [
        1742,
        1872
      ]
    },
    {
      "content": "Quick check list",
      "pos": [
        1877,
        1893
      ]
    },
    {
      "content": "The following is a quick check list for optimal performance of SQL Server on Azure Virtual Machines:",
      "pos": [
        1895,
        1995
      ]
    },
    {
      "content": "Area",
      "pos": [
        1998,
        2002
      ]
    },
    {
      "content": "Optimizations",
      "pos": [
        2003,
        2016
      ]
    },
    {
      "content": "VM size",
      "pos": [
        2031,
        2038
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>DS3<ept id=\"p1\">](virtual-machines-size-specs.md#standard-tier-ds-series)</ept> or higher for SQL Enterprise edition.",
      "pos": [
        2041,
        2140
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>DS2<ept id=\"p1\">](virtual-machines-size-specs.md#standard-tier-ds-series)</ept> or higher for SQL Standard and Web editions.",
      "pos": [
        2150,
        2256
      ]
    },
    {
      "content": "Storage",
      "pos": [
        2261,
        2268
      ]
    },
    {
      "content": "Use <bpt id=\"p1\">[</bpt>Premium Storage<ept id=\"p1\">](../storage/storage-premium-storage-preview-portal.md)</ept>.",
      "pos": [
        2271,
        2347
      ]
    },
    {
      "content": "Keep the <bpt id=\"p1\">[</bpt>storage account<ept id=\"p1\">](../storage/storage-create-storage-account.md)</ept> and SQL Server VM in the same region.",
      "pos": [
        2357,
        2467
      ]
    },
    {
      "content": "Disable Azure <bpt id=\"p1\">[</bpt>geo-redundant storage<ept id=\"p1\">](../storage/storage-redundancy.md)</ept> (geo-replication) on the storage account.",
      "pos": [
        2477,
        2590
      ]
    },
    {
      "content": "Disks",
      "pos": [
        2595,
        2600
      ]
    },
    {
      "content": "Use a minimum of 2 <bpt id=\"p1\">[</bpt>P30 disks<ept id=\"p1\">](../storage/storage-premium-storage-preview-portal.md#scalability-and-performance-targets-when-using-premium-storage)</ept> (1 for log files; 1 for data files and TempDB).",
      "pos": [
        2603,
        2798
      ]
    },
    {
      "content": "Avoid using operating system or temporary disks for database storage or logging.",
      "pos": [
        2808,
        2888
      ]
    },
    {
      "content": "Enable read caching on the disk(s) hosting the data files and TempDB.",
      "pos": [
        2898,
        2967
      ]
    },
    {
      "content": "Do not enable caching on disk(s) hosting the log file.",
      "pos": [
        2977,
        3031
      ]
    },
    {
      "content": "Stripe multiple Azure data disks to get increased IO throughput.",
      "pos": [
        3041,
        3105
      ]
    },
    {
      "content": "Format with documented allocation sizes.",
      "pos": [
        3115,
        3155
      ]
    },
    {
      "content": "I/O",
      "pos": [
        3160,
        3163
      ]
    },
    {
      "content": "Enable database page compression.",
      "pos": [
        3166,
        3199
      ]
    },
    {
      "content": "Enable instant file initialization for data files.",
      "pos": [
        3209,
        3259
      ]
    },
    {
      "content": "Limit or disable autogrow on the database.",
      "pos": [
        3269,
        3311
      ]
    },
    {
      "content": "Disable autoshrink on the database.",
      "pos": [
        3321,
        3356
      ]
    },
    {
      "content": "Move all databases to data disks, including system databases.",
      "pos": [
        3366,
        3427
      ]
    },
    {
      "content": "Move SQL Server error log and trace file directories to data disks.",
      "pos": [
        3437,
        3504
      ]
    },
    {
      "content": "Setup default backup and database file locations.",
      "pos": [
        3514,
        3563
      ]
    },
    {
      "content": "Enable locked pages.",
      "pos": [
        3573,
        3593
      ]
    },
    {
      "content": "Apply SQL Server performance fixes.",
      "pos": [
        3603,
        3638
      ]
    },
    {
      "content": "Feature-specific",
      "pos": [
        3643,
        3659
      ]
    },
    {
      "content": "Back up directly to blob storage.",
      "pos": [
        3662,
        3695
      ]
    },
    {
      "content": "For more information, please follow the guidelines provided in the following sub sections.",
      "pos": [
        3698,
        3788
      ]
    },
    {
      "content": "Virtual machine size and storage account considerations",
      "pos": [
        3793,
        3848
      ]
    },
    {
      "content": "For performance sensitive applications, it’s recommended that you use the following virtual machines sizes:",
      "pos": [
        3850,
        3957
      ]
    },
    {
      "pos": [
        3961,
        4009
      ],
      "content": "<bpt id=\"p1\">**</bpt>SQL Server Enterprise Edition<ept id=\"p1\">**</ept>: DS3 or higher"
    },
    {
      "pos": [
        4013,
        4068
      ],
      "content": "<bpt id=\"p1\">**</bpt>SQL Server Standard and Web Editions<ept id=\"p1\">**</ept>: DS2 or higher"
    },
    {
      "pos": [
        4070,
        4198
      ],
      "content": "For up-to-date information on supported virtual machine sizes, see <bpt id=\"p1\">[</bpt>Sizes for Virtual Machines<ept id=\"p1\">](virtual-machines-size-specs.md)</ept>."
    },
    {
      "content": "In addition, we recommend that you create your Azure storage account in the same data center as your SQL Server virtual machines to reduce transfer delays.",
      "pos": [
        4200,
        4355
      ]
    },
    {
      "content": "When creating a storage account, disable geo-replication as consistent write order across multiple disks is not guaranteed.",
      "pos": [
        4356,
        4479
      ]
    },
    {
      "content": "Instead, consider configuring a SQL Server disaster recovery technology between two Azure data centers.",
      "pos": [
        4480,
        4583
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>High Availability and Disaster Recovery for SQL Server in Azure Virtual Machines<ept id=\"p1\">](virtual-machines-sql-server-high-availability-and-disaster-recovery-solutions.md)</ept>.",
      "pos": [
        4584,
        4775
      ]
    },
    {
      "content": "Disks and performance considerations",
      "pos": [
        4780,
        4816
      ]
    },
    {
      "content": "When you create an Azure Virtual Machine, the platform will attach at least one disk to the VM for your operating system disk.",
      "pos": [
        4818,
        4944
      ]
    },
    {
      "content": "This disk is a VHD stored as a page blob in storage.",
      "pos": [
        4945,
        4997
      ]
    },
    {
      "content": "You can also attach additional disks to your virtual machine as data disks, and these will be stored in storage as page blobs.",
      "pos": [
        4998,
        5124
      ]
    },
    {
      "content": "There is another disk present in Azure Virtual Machines called the temporary disk.",
      "pos": [
        5125,
        5207
      ]
    },
    {
      "content": "This is a disk on the node that can be used for scratch space.",
      "pos": [
        5208,
        5270
      ]
    },
    {
      "content": "Operating system disk",
      "pos": [
        5276,
        5297
      ]
    },
    {
      "pos": [
        5299,
        5435
      ],
      "content": "An operating system disk is a VHD that you can boot and mount as a running version of an operating system and is labeled as <bpt id=\"p1\">**</bpt>C<ept id=\"p1\">**</ept> drive."
    },
    {
      "content": "Default caching policy on the operating system disk is <bpt id=\"p1\">**</bpt>Read/Write<ept id=\"p1\">**</ept>.",
      "pos": [
        5437,
        5507
      ]
    },
    {
      "content": "For performance sensitive applications, we recommend that you use data disks instead of the operating system disk.",
      "pos": [
        5508,
        5622
      ]
    },
    {
      "content": "See the section on Data Disks below.",
      "pos": [
        5623,
        5659
      ]
    },
    {
      "content": "Temporary disk",
      "pos": [
        5665,
        5679
      ]
    },
    {
      "content": "The temporary storage drive, labeled as the <bpt id=\"p1\">**</bpt>D<ept id=\"p1\">**</ept>: drive, is not persisted to Azure blob storage.",
      "pos": [
        5681,
        5778
      ]
    },
    {
      "content": "Do not store your data or log files on the <bpt id=\"p1\">**</bpt>D<ept id=\"p1\">**</ept>: drive.",
      "pos": [
        5779,
        5835
      ]
    },
    {
      "content": "Only store TempDB and/or Buffer Pool Extensions on the <bpt id=\"p1\">**</bpt>D<ept id=\"p1\">**</ept> drive when using the D-Series or G-Series Virtual Machines (VMs).",
      "pos": [
        5837,
        5963
      ]
    },
    {
      "content": "Unlike the other VM series, the <bpt id=\"p1\">**</bpt>D<ept id=\"p1\">**</ept> drive in the D-Series and G-Series VMs is SSD-based.",
      "pos": [
        5964,
        6054
      ]
    },
    {
      "content": "This can improve the performance of workloads that heavily use temporary objects or that have working sets which don't fit in memory.",
      "pos": [
        6055,
        6188
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Using SSDs in Azure VMs to store SQL Server TempDB and Buffer Pool Extensions<ept id=\"p1\">](http://blogs.technet.com/b/dataplatforminsider/archive/2014/09/25/using-ssds-in-azure-vms-to-store-sql-server-tempdb-and-buffer-pool-extensions.aspx)</ept>.",
      "pos": [
        6189,
        6445
      ]
    },
    {
      "content": "Data Disk",
      "pos": [
        6451,
        6460
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Number of data disks for data and log files<ept id=\"p1\">**</ept>: At a minimum, use 2 <bpt id=\"p2\">[</bpt>P30 disks<ept id=\"p2\">](../storage/storage-premium-storage-preview-portal.md#scalability-and-performance-targets-when-using-premium-storage)</ept> where one disk contains the log file(s) and the other contains the data file(s) and TempDB.",
      "pos": [
        6464,
        6753
      ]
    },
    {
      "content": "For more throughput, you might require additional data disks.",
      "pos": [
        6754,
        6815
      ]
    },
    {
      "content": "To determine the number of data disks, you need to analyze the number of IOPS available for your data and log disk(s).",
      "pos": [
        6816,
        6934
      ]
    },
    {
      "content": "For that information, see the tables on IOPS per <bpt id=\"p1\">[</bpt>VM size<ept id=\"p1\">](virtual-machines-size-specs.md)</ept> and disk size in the following article: <bpt id=\"p2\">[</bpt>Using Premium Storage for Disks<ept id=\"p2\">](../storage/storage-premium-storage-preview-portal.md)</ept>.",
      "pos": [
        6935,
        7154
      ]
    },
    {
      "content": "If you require more bandwidth, you can attach additional disks use Disk Striping.",
      "pos": [
        7155,
        7236
      ]
    },
    {
      "content": "If you are not using Premium Storage, the recommendation is to add the maximum number of data disks supported by your <bpt id=\"p1\">[</bpt>VM size<ept id=\"p1\">](virtual-machines-size-specs.md)</ept> and use Disk Striping.",
      "pos": [
        7237,
        7419
      ]
    },
    {
      "content": "For more information about Disk Striping, see the related section below.",
      "pos": [
        7420,
        7492
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Caching policy<ept id=\"p1\">**</ept>: Enable read caching on the data disks hosting your data files and TempDB only.",
      "pos": [
        7496,
        7594
      ]
    },
    {
      "content": "If you are not using Premium Storage, do not enable any caching on any data disks.",
      "pos": [
        7595,
        7677
      ]
    },
    {
      "content": "For instructions on configuring disk caching, see the following topics: <bpt id=\"p1\">[</bpt>Set-AzureOSDisk<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/jj152847)</ept> and <bpt id=\"p2\">[</bpt>Set-AzureDataDisk<ept id=\"p2\">](https://msdn.microsoft.com/library/azure/jj152851.aspx)</ept>.",
      "pos": [
        7678,
        7899
      ]
    },
    {
      "pos": [
        7903,
        8066
      ],
      "content": "<bpt id=\"p1\">**</bpt>NTFS allocation unit size<ept id=\"p1\">**</ept>: When formatting the data disk, it is recommended that you use a 64-KB allocation unit size for data and log files as well as TempDB."
    },
    {
      "pos": [
        8070,
        8135
      ],
      "content": "<bpt id=\"p1\">**</bpt>Disk Striping<ept id=\"p1\">**</ept>: We recommend that you follow these guidelines:"
    },
    {
      "content": "For Windows 8/Windows Server 2012 or later, use <bpt id=\"p1\">[</bpt>Storage Spaces<ept id=\"p1\">](https://technet.microsoft.com/library/hh831739.aspx)</ept>.",
      "pos": [
        8144,
        8262
      ]
    },
    {
      "content": "Set stripe size to 64 KB for OLTP workloads and 256 KB for data warehousing workloads to avoid performance impact due to partition misalignment.",
      "pos": [
        8263,
        8407
      ]
    },
    {
      "content": "In addition, set column count = number of physical disks.",
      "pos": [
        8408,
        8465
      ]
    },
    {
      "content": "To configure a Storage Space with more than 8 disks you must use PowerShell (not Server Manager UI) to explicitly set the number of columns to match the number of disks.",
      "pos": [
        8466,
        8635
      ]
    },
    {
      "content": "For more information on how to configure <bpt id=\"p1\">[</bpt>Storage Spaces<ept id=\"p1\">](https://technet.microsoft.com/library/hh831739.aspx)</ept>, see <bpt id=\"p2\">[</bpt>Storage Spaces Cmdlets in Windows PowerShell<ept id=\"p2\">](https://technet.microsoft.com/library/jj851254.aspx)</ept>",
      "pos": [
        8636,
        8851
      ]
    },
    {
      "content": "For Windows 2008 R2 or earlier, you can use dynamic disks (OS striped volumes) and the stripe size is always 64 KB.",
      "pos": [
        8863,
        8978
      ]
    },
    {
      "content": "Note that this option is deprecated as of Windows 8/Windows Server 2012.",
      "pos": [
        8979,
        9051
      ]
    },
    {
      "content": "For information, see the support statement at <bpt id=\"p1\">[</bpt>Virtual Disk Service is transitioning to Windows Storage Management API<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/desktop/hh848071.aspx)</ept>.",
      "pos": [
        9052,
        9238
      ]
    },
    {
      "content": "If your workload is not log intensive and does not need dedicated IOPs, you can configure just one storage pool.",
      "pos": [
        9250,
        9362
      ]
    },
    {
      "content": "Otherwise, create two storage pools, one for the log file(s) and another storage pool for the data file(s) and TempDB.",
      "pos": [
        9363,
        9481
      ]
    },
    {
      "content": "Determine the number of disks associated with each storage pool based on your load expectations.",
      "pos": [
        9482,
        9578
      ]
    },
    {
      "content": "Keep in mind that different VM sizes allow different numbers of attached data disks.",
      "pos": [
        9579,
        9663
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Sizes for Virtual Machines<ept id=\"p1\">](virtual-machines-size-specs.md)</ept>.",
      "pos": [
        9664,
        9751
      ]
    },
    {
      "content": "I/O performance considerations",
      "pos": [
        9756,
        9786
      ]
    },
    {
      "content": "The best results with Premium Storage are achieved when you parallelize your application and requests.",
      "pos": [
        9790,
        9892
      ]
    },
    {
      "content": "Premium Storage is designed for scenarios where the IO queue depth is greater than 1, so you will see little or no performance gains for single-threaded serial requests (even if they are storage intensive).",
      "pos": [
        9893,
        10099
      ]
    },
    {
      "content": "For example, this could impact the single-threaded test results of performance analysis tools, such as SQLIO.",
      "pos": [
        10100,
        10209
      ]
    },
    {
      "content": "Consider using <bpt id=\"p1\">[</bpt>database page compression<ept id=\"p1\">](https://msdn.microsoft.com/library/cc280449.aspx)</ept> as it can help improve performance of I/O intensive workloads.",
      "pos": [
        10213,
        10368
      ]
    },
    {
      "content": "However, the data compression might increase the CPU consumption on the database server.",
      "pos": [
        10369,
        10457
      ]
    },
    {
      "content": "Consider compressing any data files when transferring in/out of Azure.",
      "pos": [
        10461,
        10531
      ]
    },
    {
      "content": "Consider enabling instant file initialization to reduce the time that is required for initial file allocation.",
      "pos": [
        10535,
        10645
      ]
    },
    {
      "content": "To take advantage of instant file initialization, you grant the SQL Server (MSSQLSERVER) service account with SE_MANAGE_VOLUME_NAME and add it to the <bpt id=\"p1\">**</bpt>Perform Volume Maintenance Tasks<ept id=\"p1\">**</ept> security policy.",
      "pos": [
        10646,
        10849
      ]
    },
    {
      "content": "If you are using a SQL Server platform image for Azure, the default service account (NT Service\\MSSQLSERVER) isn’t added to the <bpt id=\"p1\">**</bpt>Perform Volume Maintenance Tasks<ept id=\"p1\">**</ept> security policy.",
      "pos": [
        10850,
        11031
      ]
    },
    {
      "content": "In other words, instant file initialization is not enabled in a SQL Server Azure platform image.",
      "pos": [
        11032,
        11128
      ]
    },
    {
      "content": "After adding the SQL Server service account to the <bpt id=\"p1\">**</bpt>Perform Volume Maintenance Tasks<ept id=\"p1\">**</ept> security policy, restart the SQL Server service.",
      "pos": [
        11129,
        11265
      ]
    },
    {
      "content": "There could be security considerations for using this feature.",
      "pos": [
        11266,
        11328
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Database File Initialization<ept id=\"p1\">](https://msdn.microsoft.com/library/ms175935.aspx)</ept>.",
      "pos": [
        11329,
        11436
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>autogrow<ept id=\"p1\">**</ept> is considered to be merely a contingency for unexpected growth.",
      "pos": [
        11440,
        11516
      ]
    },
    {
      "content": "Do not manage your data and log growth on a day-to-day basis with autogrow.",
      "pos": [
        11517,
        11592
      ]
    },
    {
      "content": "If autogrow is used, pre-grow the file using the Size switch.",
      "pos": [
        11593,
        11654
      ]
    },
    {
      "pos": [
        11658,
        11764
      ],
      "content": "Make sure <bpt id=\"p1\">**</bpt>autoshrink<ept id=\"p1\">**</ept> is disabled to avoid unnecessary overhead that can negatively affect performance."
    },
    {
      "content": "If you are running SQL Server 2012, install Service Pack 1 Cumulative Update 10.",
      "pos": [
        11768,
        11848
      ]
    },
    {
      "content": "This update contains the fix for poor performance on I/O when you execute select into temporary table statement in SQL Server 2012.",
      "pos": [
        11849,
        11980
      ]
    },
    {
      "content": "For information, see this <bpt id=\"p1\">[</bpt>knowledge base article<ept id=\"p1\">](http://support.microsoft.com/kb/2958012)</ept>.",
      "pos": [
        11981,
        12073
      ]
    },
    {
      "content": "Move system databases (such as msdb and TempDB), backups and the default data and log directories of SQL Server to non-cached data disks to improve performance.",
      "pos": [
        12077,
        12237
      ]
    },
    {
      "content": "Then, perform the following actions:",
      "pos": [
        12238,
        12274
      ]
    },
    {
      "content": "Adjust the XEvent and Trace file paths.",
      "pos": [
        12282,
        12321
      ]
    },
    {
      "content": "Adjust the SQL Error Log path.",
      "pos": [
        12333,
        12363
      ]
    },
    {
      "content": "Adjust the default backup path.",
      "pos": [
        12375,
        12406
      ]
    },
    {
      "content": "Adjust the default database location.",
      "pos": [
        12418,
        12455
      ]
    },
    {
      "content": "Establish locked pages to reduce IO and any paging activities.",
      "pos": [
        12459,
        12521
      ]
    },
    {
      "content": "Feature specific performance considerations",
      "pos": [
        12526,
        12569
      ]
    },
    {
      "content": "Some deployments may achieve additional performance benefits using more advanced configuration techniques.",
      "pos": [
        12571,
        12677
      ]
    },
    {
      "content": "The following list highlights some SQL Server features that can help you to achieve better performance:",
      "pos": [
        12678,
        12781
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Backup to Azure storage<ept id=\"p1\">**</ept>: When performing backups for SQL Server running in Azure virtual machines, you can use <bpt id=\"p2\">[</bpt>SQL Server Backup to URL<ept id=\"p2\">](https://msdn.microsoft.com/library/dn435916.aspx)</ept>.",
      "pos": [
        12785,
        12977
      ]
    },
    {
      "content": "This feature is available starting with SQL Server 2012 SP1 CU2 and recommended for backing up to the attached data disks.",
      "pos": [
        12978,
        13100
      ]
    },
    {
      "content": "When you backup/restore to/from Azure storage, follow the recommendations provided at <bpt id=\"p1\">[</bpt>SQL Server Backup to URL Best Practices and Troubleshooting and Restoring from Backups Stored in Azure Storage<ept id=\"p1\">](https://msdn.microsoft.com/library/jj919149.aspx)</ept>.",
      "pos": [
        13101,
        13350
      ]
    },
    {
      "content": "You can also automate these backups using <bpt id=\"p1\">[</bpt>Automated Backup for SQL Server in Azure Virtual Machines<ept id=\"p1\">](virtual-machines-sql-server-automated-backup.md)</ept>.",
      "pos": [
        13351,
        13502
      ]
    },
    {
      "content": "Prior to SQL Server 2012, you can use <bpt id=\"p1\">[</bpt>SQL Server Backup to Azure Tool<ept id=\"p1\">](https://www.microsoft.com/download/details.aspx?id=40740)</ept>.",
      "pos": [
        13508,
        13638
      ]
    },
    {
      "content": "This tool can help to increase backup throughput using multiple backup stripe targets.",
      "pos": [
        13639,
        13725
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>SQL Server Data Files in Azure<ept id=\"p1\">**</ept>: This new feature, <bpt id=\"p2\">[</bpt>SQL Server Data Files in Azure<ept id=\"p2\">](https://msdn.microsoft.com/library/dn385720.aspx)</ept>, is available starting with SQL Server 2014.",
      "pos": [
        13729,
        13910
      ]
    },
    {
      "content": "Running SQL Server with data files in Azure demonstrates comparable performance characteristics as using Azure data disks.",
      "pos": [
        13911,
        14033
      ]
    },
    {
      "content": "Next Steps",
      "pos": [
        14038,
        14048
      ]
    },
    {
      "pos": [
        14050,
        14263
      ],
      "content": "If you are interested in exploring SQL Server and Premium Storage in more depth, see the article <bpt id=\"p1\">[</bpt>Use Azure Premium Storage with SQL Server on Virtual Machines<ept id=\"p1\">](virtual-machines-sql-server-use-premium-storage.md)</ept>."
    },
    {
      "pos": [
        14265,
        14421
      ],
      "content": "For security best practices, see <bpt id=\"p1\">[</bpt>Security Considerations for SQL Server in Azure Virtual Machines<ept id=\"p1\">](virtual-machines-sql-server-security-considerations.md)</ept>."
    },
    {
      "pos": [
        14423,
        14577
      ],
      "content": "Review other SQL Server Virtual Machine topics at <bpt id=\"p1\">[</bpt>SQL Server on Azure Virtual Machines Overview<ept id=\"p1\">](virtual-machines-sql-server-infrastructure-services.md)</ept>."
    }
  ],
  "content": "<properties \n    pageTitle=\"Performance best practices for SQL Server in Azure Virtual Machines\"\n    description=\"Provides best practices for optimizing SQL Server performance in Microsoft Azure VMs.\"\n    services=\"virtual-machines\"\n    documentationCenter=\"na\"\n    authors=\"rothja\"\n    manager=\"jeffreyg\"\n    editor=\"monicar\" />\n<tags \n    ms.service=\"virtual-machines\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.tgt_pltfrm=\"vm-windows-sql-server\"\n    ms.workload=\"infrastructure-services\"\n    ms.date=\"09/01/2015\"\n    ms.author=\"jroth\" />\n\n# Performance best practices for SQL Server in Azure Virtual Machines\n\n## Overview\n\nThis topic provides best practices for optimizing SQL Server performance in Microsoft Azure Virtual Machine. While running SQL Server in Azure Virtual Machines, we recommend that you continue using the same database performance tuning options that are applicable to SQL Server in on-premises server environment. However, the performance of a relational database in a public cloud depends on many factors such as the size of a virtual machine, and the configuration of the data disks.\n\n>[AZURE.NOTE] This paper is focused on getting the best performance for SQL Server on Azure VMs. If your workload is less demanding, you might not require every optimization listed below. Consider your performance needs and workload patterns as you evaluate these recommendations.\n\nFor a companion resource on this topic, you can [download the following white paper](http://download.microsoft.com/download/D/2/0/D20E1C5F-72EA-4505-9F26-FEF9550EFD44/Performance%20Guidance%20for%20SQL%20Server%20in%20Windows%20Azure%20Virtual%20Machines.docx). Please note that the information in that white paper is outdated in some areas. For example, it was written before the introduction of Premium Storage, which is now recommended for the best performance results.\n\n## Quick check list\n\nThe following is a quick check list for optimal performance of SQL Server on Azure Virtual Machines:\n\n|Area|Optimizations|\n|---|---|\n|**VM size**|[DS3](virtual-machines-size-specs.md#standard-tier-ds-series) or higher for SQL Enterprise edition.<br/><br/>[DS2](virtual-machines-size-specs.md#standard-tier-ds-series) or higher for SQL Standard and Web editions.|\n|**Storage**|Use [Premium Storage](../storage/storage-premium-storage-preview-portal.md).<br/><br/>Keep the [storage account](../storage/storage-create-storage-account.md) and SQL Server VM in the same region.<br/><br/>Disable Azure [geo-redundant storage](../storage/storage-redundancy.md) (geo-replication) on the storage account.|\n|**Disks**|Use a minimum of 2 [P30 disks](../storage/storage-premium-storage-preview-portal.md#scalability-and-performance-targets-when-using-premium-storage) (1 for log files; 1 for data files and TempDB).<br/><br/>Avoid using operating system or temporary disks for database storage or logging.<br/><br/>Enable read caching on the disk(s) hosting the data files and TempDB.<br/><br/>Do not enable caching on disk(s) hosting the log file.<br/><br/>Stripe multiple Azure data disks to get increased IO throughput.<br/><br/>Format with documented allocation sizes.|\n|**I/O**|Enable database page compression.<br/><br/>Enable instant file initialization for data files.<br/><br/>Limit or disable autogrow on the database.<br/><br/>Disable autoshrink on the database.<br/><br/>Move all databases to data disks, including system databases.<br/><br/>Move SQL Server error log and trace file directories to data disks.<br/><br/>Setup default backup and database file locations.<br/><br/>Enable locked pages.<br/><br/>Apply SQL Server performance fixes.|\n|**Feature-specific**|Back up directly to blob storage.|\n\nFor more information, please follow the guidelines provided in the following sub sections.\n\n## Virtual machine size and storage account considerations\n\nFor performance sensitive applications, it’s recommended that you use the following virtual machines sizes:\n\n- **SQL Server Enterprise Edition**: DS3 or higher\n\n- **SQL Server Standard and Web Editions**: DS2 or higher\n\nFor up-to-date information on supported virtual machine sizes, see [Sizes for Virtual Machines](virtual-machines-size-specs.md).\n\nIn addition, we recommend that you create your Azure storage account in the same data center as your SQL Server virtual machines to reduce transfer delays. When creating a storage account, disable geo-replication as consistent write order across multiple disks is not guaranteed. Instead, consider configuring a SQL Server disaster recovery technology between two Azure data centers. For more information, see [High Availability and Disaster Recovery for SQL Server in Azure Virtual Machines](virtual-machines-sql-server-high-availability-and-disaster-recovery-solutions.md).\n\n## Disks and performance considerations\n\nWhen you create an Azure Virtual Machine, the platform will attach at least one disk to the VM for your operating system disk. This disk is a VHD stored as a page blob in storage. You can also attach additional disks to your virtual machine as data disks, and these will be stored in storage as page blobs. There is another disk present in Azure Virtual Machines called the temporary disk. This is a disk on the node that can be used for scratch space.\n\n### Operating system disk\n\nAn operating system disk is a VHD that you can boot and mount as a running version of an operating system and is labeled as **C** drive.\n\nDefault caching policy on the operating system disk is **Read/Write**. For performance sensitive applications, we recommend that you use data disks instead of the operating system disk. See the section on Data Disks below.\n\n### Temporary disk\n\nThe temporary storage drive, labeled as the **D**: drive, is not persisted to Azure blob storage. Do not store your data or log files on the **D**: drive.\n\nOnly store TempDB and/or Buffer Pool Extensions on the **D** drive when using the D-Series or G-Series Virtual Machines (VMs). Unlike the other VM series, the **D** drive in the D-Series and G-Series VMs is SSD-based. This can improve the performance of workloads that heavily use temporary objects or that have working sets which don't fit in memory. For more information, see [Using SSDs in Azure VMs to store SQL Server TempDB and Buffer Pool Extensions](http://blogs.technet.com/b/dataplatforminsider/archive/2014/09/25/using-ssds-in-azure-vms-to-store-sql-server-tempdb-and-buffer-pool-extensions.aspx).\n\n### Data Disk\n\n- **Number of data disks for data and log files**: At a minimum, use 2 [P30 disks](../storage/storage-premium-storage-preview-portal.md#scalability-and-performance-targets-when-using-premium-storage) where one disk contains the log file(s) and the other contains the data file(s) and TempDB. For more throughput, you might require additional data disks. To determine the number of data disks, you need to analyze the number of IOPS available for your data and log disk(s). For that information, see the tables on IOPS per [VM size](virtual-machines-size-specs.md) and disk size in the following article: [Using Premium Storage for Disks](../storage/storage-premium-storage-preview-portal.md). If you require more bandwidth, you can attach additional disks use Disk Striping. If you are not using Premium Storage, the recommendation is to add the maximum number of data disks supported by your [VM size](virtual-machines-size-specs.md) and use Disk Striping. For more information about Disk Striping, see the related section below.\n\n- **Caching policy**: Enable read caching on the data disks hosting your data files and TempDB only. If you are not using Premium Storage, do not enable any caching on any data disks. For instructions on configuring disk caching, see the following topics: [Set-AzureOSDisk](https://msdn.microsoft.com/library/azure/jj152847) and [Set-AzureDataDisk](https://msdn.microsoft.com/library/azure/jj152851.aspx).\n\n- **NTFS allocation unit size**: When formatting the data disk, it is recommended that you use a 64-KB allocation unit size for data and log files as well as TempDB.\n\n- **Disk Striping**: We recommend that you follow these guidelines: \n\n    - For Windows 8/Windows Server 2012 or later, use [Storage Spaces](https://technet.microsoft.com/library/hh831739.aspx). Set stripe size to 64 KB for OLTP workloads and 256 KB for data warehousing workloads to avoid performance impact due to partition misalignment. In addition, set column count = number of physical disks. To configure a Storage Space with more than 8 disks you must use PowerShell (not Server Manager UI) to explicitly set the number of columns to match the number of disks. For more information on how to configure [Storage Spaces](https://technet.microsoft.com/library/hh831739.aspx), see [Storage Spaces Cmdlets in Windows PowerShell](https://technet.microsoft.com/library/jj851254.aspx)\n    \n    - For Windows 2008 R2 or earlier, you can use dynamic disks (OS striped volumes) and the stripe size is always 64 KB. Note that this option is deprecated as of Windows 8/Windows Server 2012. For information, see the support statement at [Virtual Disk Service is transitioning to Windows Storage Management API](https://msdn.microsoft.com/library/windows/desktop/hh848071.aspx).\n    \n    - If your workload is not log intensive and does not need dedicated IOPs, you can configure just one storage pool. Otherwise, create two storage pools, one for the log file(s) and another storage pool for the data file(s) and TempDB. Determine the number of disks associated with each storage pool based on your load expectations. Keep in mind that different VM sizes allow different numbers of attached data disks. For more information, see [Sizes for Virtual Machines](virtual-machines-size-specs.md).\n\n## I/O performance considerations\n\n- The best results with Premium Storage are achieved when you parallelize your application and requests. Premium Storage is designed for scenarios where the IO queue depth is greater than 1, so you will see little or no performance gains for single-threaded serial requests (even if they are storage intensive). For example, this could impact the single-threaded test results of performance analysis tools, such as SQLIO.\n\n- Consider using [database page compression](https://msdn.microsoft.com/library/cc280449.aspx) as it can help improve performance of I/O intensive workloads. However, the data compression might increase the CPU consumption on the database server.\n\n- Consider compressing any data files when transferring in/out of Azure.\n\n- Consider enabling instant file initialization to reduce the time that is required for initial file allocation. To take advantage of instant file initialization, you grant the SQL Server (MSSQLSERVER) service account with SE_MANAGE_VOLUME_NAME and add it to the **Perform Volume Maintenance Tasks** security policy. If you are using a SQL Server platform image for Azure, the default service account (NT Service\\MSSQLSERVER) isn’t added to the **Perform Volume Maintenance Tasks** security policy. In other words, instant file initialization is not enabled in a SQL Server Azure platform image. After adding the SQL Server service account to the **Perform Volume Maintenance Tasks** security policy, restart the SQL Server service. There could be security considerations for using this feature. For more information, see [Database File Initialization](https://msdn.microsoft.com/library/ms175935.aspx).\n\n- **autogrow** is considered to be merely a contingency for unexpected growth. Do not manage your data and log growth on a day-to-day basis with autogrow. If autogrow is used, pre-grow the file using the Size switch.\n\n- Make sure **autoshrink** is disabled to avoid unnecessary overhead that can negatively affect performance.\n\n- If you are running SQL Server 2012, install Service Pack 1 Cumulative Update 10. This update contains the fix for poor performance on I/O when you execute select into temporary table statement in SQL Server 2012. For information, see this [knowledge base article](http://support.microsoft.com/kb/2958012).\n\n- Move system databases (such as msdb and TempDB), backups and the default data and log directories of SQL Server to non-cached data disks to improve performance. Then, perform the following actions:\n\n    - Adjust the XEvent and Trace file paths.\n    \n    - Adjust the SQL Error Log path.\n    \n    - Adjust the default backup path.\n    \n    - Adjust the default database location.\n\n- Establish locked pages to reduce IO and any paging activities.\n\n## Feature specific performance considerations\n\nSome deployments may achieve additional performance benefits using more advanced configuration techniques. The following list highlights some SQL Server features that can help you to achieve better performance:\n\n- **Backup to Azure storage**: When performing backups for SQL Server running in Azure virtual machines, you can use [SQL Server Backup to URL](https://msdn.microsoft.com/library/dn435916.aspx). This feature is available starting with SQL Server 2012 SP1 CU2 and recommended for backing up to the attached data disks. When you backup/restore to/from Azure storage, follow the recommendations provided at [SQL Server Backup to URL Best Practices and Troubleshooting and Restoring from Backups Stored in Azure Storage](https://msdn.microsoft.com/library/jj919149.aspx). You can also automate these backups using [Automated Backup for SQL Server in Azure Virtual Machines](virtual-machines-sql-server-automated-backup.md).\n\n    Prior to SQL Server 2012, you can use [SQL Server Backup to Azure Tool](https://www.microsoft.com/download/details.aspx?id=40740). This tool can help to increase backup throughput using multiple backup stripe targets.\n\n- **SQL Server Data Files in Azure**: This new feature, [SQL Server Data Files in Azure](https://msdn.microsoft.com/library/dn385720.aspx), is available starting with SQL Server 2014. Running SQL Server with data files in Azure demonstrates comparable performance characteristics as using Azure data disks.\n\n## Next Steps\n\nIf you are interested in exploring SQL Server and Premium Storage in more depth, see the article [Use Azure Premium Storage with SQL Server on Virtual Machines](virtual-machines-sql-server-use-premium-storage.md).\n\nFor security best practices, see [Security Considerations for SQL Server in Azure Virtual Machines](virtual-machines-sql-server-security-considerations.md).\n\nReview other SQL Server Virtual Machine topics at [SQL Server on Azure Virtual Machines Overview](virtual-machines-sql-server-infrastructure-services.md).\n"
}