{
  "nodes": [
    {
      "content": "Cloud Cruiser and Microsoft Azure Billing API Integration",
      "pos": [
        26,
        83
      ]
    },
    {
      "content": "Provides a unique perspective from Microsoft Azure Billing partner Cloud Cruiser, on their experiences integrating the Azure Billing APIs into their product.",
      "pos": [
        101,
        258
      ]
    },
    {
      "content": "This is especially useful for Azure and Cloud Cruiser customers that are interested in using/trying Cloud Cruiser for Microsoft Azure Pack.",
      "pos": [
        260,
        399
      ]
    },
    {
      "content": "Cloud Cruiser and Microsoft Azure Billing API Integration",
      "pos": [
        696,
        753
      ]
    },
    {
      "content": "This article describes how the information collected from the new Microsoft Azure Billing APIs can be used in Cloud Cruiser for workflow cost simulation and analysis.",
      "pos": [
        755,
        921
      ]
    },
    {
      "content": "Azure RateCard API",
      "pos": [
        926,
        944
      ]
    },
    {
      "content": "The RateCard API provides rate information from Azure.",
      "pos": [
        945,
        999
      ]
    },
    {
      "content": "After authenticating with the proper credentials, you can query the API to collect metadata about the services available on Azure, along with the rates associated with your Offer ID.",
      "pos": [
        1000,
        1182
      ]
    },
    {
      "content": "Below is a sample response from the API showing the prices for the A0 (Windows) instance:",
      "pos": [
        1184,
        1273
      ]
    },
    {
      "content": "Cloud Cruiser’s Interface to Azure RateCard API",
      "pos": [
        1654,
        1701
      ]
    },
    {
      "content": "Cloud Cruiser can leverage the RateCard API information in different ways.",
      "pos": [
        1702,
        1776
      ]
    },
    {
      "content": "For this article, we will show how it can be used to make IaaS workload cost simulation and analysis.",
      "pos": [
        1777,
        1878
      ]
    },
    {
      "content": "To demonstrate this use case, imagine a workload of several instances running on Microsoft Azure Pack (WAP).",
      "pos": [
        1880,
        1988
      ]
    },
    {
      "content": "The goal is to simulate this same workload on Azure, and estimate the costs of doing such migration.",
      "pos": [
        1989,
        2089
      ]
    },
    {
      "content": "In order to create this simulation, there are two main tasks to be performed:",
      "pos": [
        2090,
        2167
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Import and process the service information collected from the RateCard API<ept id=\"p1\">**</ept> - This task is also performed on the workbooks, where the extract from the RateCard API is transformed and published to a new rate plan.",
      "pos": [
        2172,
        2387
      ]
    },
    {
      "content": "This new rate plan will be used on the simulations to estimate the Azure prices.",
      "pos": [
        2388,
        2468
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Normalize WAP services and Azure services for IaaS<ept id=\"p1\">**</ept> - By default, WAP services are based on individual resources (CPU, Memory Size, Disk Size, etc.) while Azure services are based on instance size (A0, A1, A2, etc.).",
      "pos": [
        2473,
        2692
      ]
    },
    {
      "content": "This first task can be performed by Cloud Cruiser’s ETL engine, called workbooks, where these resources can be bundled on instance sizes, analogous to Azure instance services.",
      "pos": [
        2693,
        2868
      ]
    },
    {
      "content": "Import data from the RateCard API",
      "pos": [
        2874,
        2907
      ]
    },
    {
      "content": "Cloud Cruiser workbooks provide an automated way to collect and process information from the RateCard API.",
      "pos": [
        2909,
        3015
      ]
    },
    {
      "content": "ETL (extract-transform-load) workbooks allow you to configure the collection, transformation, and publishing of data into the Cloud Cruiser database.",
      "pos": [
        3017,
        3166
      ]
    },
    {
      "content": "Each workbook can have one or multiple collections.",
      "pos": [
        3168,
        3219
      ]
    },
    {
      "content": "This allows you to correlate information from different sources to complement or augment the usage data.",
      "pos": [
        3220,
        3324
      ]
    },
    {
      "content": "In the two screenshots below, we showing creating a new <bpt id=\"p1\">*</bpt>collection<ept id=\"p1\">*</ept> in an existing workbook, and importing information into the <bpt id=\"p2\">*</bpt>collection<ept id=\"p2\">*</ept> from the RateCard API:",
      "pos": [
        3325,
        3489
      ]
    },
    {
      "content": "![Figure 1 - Creating a new collection][1]",
      "pos": [
        3491,
        3533
      ]
    },
    {
      "content": "![Figure 2 - Import data from the new collection][2]",
      "pos": [
        3535,
        3587
      ]
    },
    {
      "content": "After importing the data into the workbook, it’s possible to create multiple steps and transformation processes, to modify and model the data.",
      "pos": [
        3589,
        3731
      ]
    },
    {
      "content": "For this example, since we are only interested in infrastructure-as-a-Service (IaaS,) we can use the transformation steps to remove unnecessary rows, or records, related to services other than IaaS.",
      "pos": [
        3732,
        3930
      ]
    },
    {
      "content": "The screenshot below shows the transformation steps used to process the data collected from RateCard API:",
      "pos": [
        3932,
        4037
      ]
    },
    {
      "content": "![Figure 3 - Transformation steps to process collected data from RateCard API][3]",
      "pos": [
        4039,
        4120
      ]
    },
    {
      "content": "Defining New Services and Rate Plans",
      "pos": [
        4126,
        4162
      ]
    },
    {
      "content": "There are different ways to define services on Cloud Cruiser.",
      "pos": [
        4164,
        4225
      ]
    },
    {
      "content": "One of the options is to import the services from the usage data.",
      "pos": [
        4226,
        4291
      ]
    },
    {
      "content": "This method is commonly used when working with public clouds, where the services are already defined by the provider.",
      "pos": [
        4292,
        4409
      ]
    },
    {
      "content": "A Rate Plan is a set of rates or prices that can be applied to different services, based on effective dates, or group of customers, among other options.",
      "pos": [
        4411,
        4563
      ]
    },
    {
      "content": "Rate Plans can also be used on Cloud Cruiser to create simulation or “What-if” scenarios, to understand how changes in services can affect the total cost of a workload.",
      "pos": [
        4564,
        4732
      ]
    },
    {
      "content": "In this example, we will use the service information from the RateCard API to define new services in Cloud Cruiser.",
      "pos": [
        4734,
        4849
      ]
    },
    {
      "content": "In the same way, we can use the rates associated to the services to create a new Rate Plan on Cloud Cruiser.",
      "pos": [
        4850,
        4958
      ]
    },
    {
      "content": "At the end of the transformation process, it is possible to create a new step and publish the data from the RateCard API as new services and rates.",
      "pos": [
        4960,
        5107
      ]
    },
    {
      "content": "![Figure 4 - Publishing the data from the RateCard API as new Services and Rates][4]",
      "pos": [
        5109,
        5193
      ]
    },
    {
      "content": "Verify Azure Services and Rates",
      "pos": [
        5199,
        5230
      ]
    },
    {
      "pos": [
        5232,
        5352
      ],
      "content": "After publishing the services and rates, you can verify the list of imported services in Cloud Cruiser’s <bpt id=\"p1\">*</bpt>Services<ept id=\"p1\">*</ept> tab:"
    },
    {
      "content": "![Figure 5 - Verifying the new Services][5]",
      "pos": [
        5354,
        5397
      ]
    },
    {
      "pos": [
        5399,
        5527
      ],
      "content": "On the <bpt id=\"p1\">*</bpt>Rate Plans<ept id=\"p1\">*</ept> tab, you can check the new rate plan called “AzureSimulation” with the rates imported from the RateCard API."
    },
    {
      "content": "![Figure 6 - Verifying the new Rate Plan and associated rates][6]",
      "pos": [
        5529,
        5594
      ]
    },
    {
      "content": "Normalize WAP and Azure Services",
      "pos": [
        5600,
        5632
      ]
    },
    {
      "content": "By default, WAP provides usage information based on the use of compute, memory and network resources.",
      "pos": [
        5634,
        5735
      ]
    },
    {
      "content": "In Cloud Cruiser, you can define your services based directly on the allocation or metered usage of these resources.",
      "pos": [
        5736,
        5852
      ]
    },
    {
      "content": "For example, you can set a basic rate for each hour of CPU usage, or charge the GB of memory allocated to an instance.",
      "pos": [
        5853,
        5971
      ]
    },
    {
      "content": "For this example, in order to compare costs between WAP and Azure, we need to aggregate the resource usage on WAP into bundles, which can then be mapped to Azure services.",
      "pos": [
        5973,
        6144
      ]
    },
    {
      "content": "This transformation can be implemented easily in the workbooks:",
      "pos": [
        6145,
        6208
      ]
    },
    {
      "content": "![Figure 7 - Transforming WAP data to normalize services][7]",
      "pos": [
        6210,
        6270
      ]
    },
    {
      "content": "The last step at the workbook is to publish the data into the Cloud Cruiser database.",
      "pos": [
        6272,
        6357
      ]
    },
    {
      "content": "During this step, the usage data is now bundled into services (that map to the Azure Services) and tied to default rates to create the charges.",
      "pos": [
        6358,
        6501
      ]
    },
    {
      "content": "After finishing the workbook, you can automate the processing of the data, by adding a new task on the scheduler and specifying the frequency and time for the workbook to run.",
      "pos": [
        6503,
        6678
      ]
    },
    {
      "content": "![Figure 8 - Workbook scheduling][8]",
      "pos": [
        6680,
        6716
      ]
    },
    {
      "content": "Create Reports for Workload Cost Simulation Analysis",
      "pos": [
        6722,
        6774
      ]
    },
    {
      "content": "As the usage is collected and the charges are loaded into the Cloud Cruiser database, we can then leverage the Cloud Cruiser Insights module – an advanced analytics reporting tool – to create the workload cost simulation that we desire.",
      "pos": [
        6776,
        7012
      ]
    },
    {
      "content": "In order to demonstrate this scenario, we created the following report:",
      "pos": [
        7014,
        7085
      ]
    },
    {
      "content": "![Cost Comparison][9]",
      "pos": [
        7087,
        7108
      ]
    },
    {
      "content": "The top graph shows a cost comparison broken by services and compares the price of running the workload for each specific service between WAP (dark blue color) and Azure (light blue color).",
      "pos": [
        7110,
        7299
      ]
    },
    {
      "content": "The bottom graph shows the same data but broken down by department, demonstrating the costs for each department to run their workload on WAP and Azure, along with the difference between these two – Savings bar (green color).",
      "pos": [
        7301,
        7525
      ]
    },
    {
      "content": "Azure Usage API",
      "pos": [
        7530,
        7545
      ]
    },
    {
      "content": "Introduction",
      "pos": [
        7552,
        7564
      ]
    },
    {
      "content": "Microsoft recently",
      "pos": [
        7566,
        7584
      ]
    },
    {
      "content": "introduced the Azure Usage API, allowing subscribers to programmatically pull",
      "pos": [
        7585,
        7662
      ]
    },
    {
      "content": "in usage data to gain insights into their consumption.",
      "pos": [
        7663,
        7717
      ]
    },
    {
      "content": "This is great news for Cloud",
      "pos": [
        7718,
        7746
      ]
    },
    {
      "content": "Cruiser customers that can take advantage of the richer dataset available",
      "pos": [
        7747,
        7820
      ]
    },
    {
      "content": "through this API.",
      "pos": [
        7821,
        7838
      ]
    },
    {
      "content": "Cloud Cruiser can leverage the integration with the Usage API in several ways.",
      "pos": [
        7840,
        7918
      ]
    },
    {
      "content": "The granularity",
      "pos": [
        7919,
        7934
      ]
    },
    {
      "content": "(hourly usage information) and resource metadata information available through",
      "pos": [
        7935,
        8013
      ]
    },
    {
      "content": "the API provides the necessary dataset to support flexible Showback or",
      "pos": [
        8014,
        8084
      ]
    },
    {
      "content": "Chargeback models.",
      "pos": [
        8085,
        8103
      ]
    },
    {
      "content": "In this tutorial, we will",
      "pos": [
        8106,
        8131
      ]
    },
    {
      "content": "present one example of how Cloud Cruiser can benefit from the Usage API",
      "pos": [
        8132,
        8203
      ]
    },
    {
      "content": "information.",
      "pos": [
        8204,
        8216
      ]
    },
    {
      "content": "More specifically, we will create a new Resource Group on Azure,",
      "pos": [
        8217,
        8281
      ]
    },
    {
      "content": "associate tags for the account structure, and then describe the process of",
      "pos": [
        8282,
        8356
      ]
    },
    {
      "content": "pulling and processing the tag information into Cloud Cruiser.",
      "pos": [
        8357,
        8419
      ]
    },
    {
      "content": "The final goal is to be able",
      "pos": [
        8422,
        8450
      ]
    },
    {
      "content": "to create reports like the one below, and be able to analyze cost and",
      "pos": [
        8451,
        8520
      ]
    },
    {
      "content": "consumption based on the account structure populated by the tags.",
      "pos": [
        8521,
        8586
      ]
    },
    {
      "content": "![Figure 10 - Report with breakdowns using tags][10]",
      "pos": [
        8588,
        8640
      ]
    },
    {
      "content": "Microsoft Azure Tags",
      "pos": [
        8646,
        8666
      ]
    },
    {
      "content": "The data available through the Azure Usage API includes not only consumption information, but also resource metadata including any tags associated with it.",
      "pos": [
        8668,
        8823
      ]
    },
    {
      "content": "Tags provide an easy way to organize your resources, but in order to be effective, you need to ensure that:",
      "pos": [
        8824,
        8931
      ]
    },
    {
      "content": "Tags are correctly applied to the resources at provision time",
      "pos": [
        8935,
        8996
      ]
    },
    {
      "content": "Tags are properly used on the Showback/Chargeback process to tie the usage to the organization’s account structure.",
      "pos": [
        8999,
        9114
      ]
    },
    {
      "content": "Both of these requirements can be challenging, especially when there is some sort of manual process on the provision or charging side.",
      "pos": [
        9116,
        9250
      ]
    },
    {
      "content": "Mistyped, incorrect or even missing tags are common complaints from customers when using tags and these errors can make life on the charging side very difficult.",
      "pos": [
        9251,
        9412
      ]
    },
    {
      "content": "With the new Azure Usage API, Cloud Cruiser can pull resource tagging information, and through a very sophisticated ETL tool called workbooks, fix these common tagging errors.",
      "pos": [
        9414,
        9589
      ]
    },
    {
      "content": "Through transformation steps leveraging regular expressions and data",
      "pos": [
        9590,
        9658
      ]
    },
    {
      "content": "correlation, Cloud Cruiser is able to identify incorrectly tagged resources and apply the correct tags, filling the gaps and ensuring the correct association of the resources with the consumer.",
      "pos": [
        9659,
        9852
      ]
    },
    {
      "content": "On the charging side,",
      "pos": [
        9854,
        9875
      ]
    },
    {
      "content": "Cloud Cruiser automates the Showback/Chargeback process, and can leverage the",
      "pos": [
        9876,
        9953
      ]
    },
    {
      "content": "tag information to tie the usage to the appropriate consumer (Department,",
      "pos": [
        9954,
        10027
      ]
    },
    {
      "content": "Division, Project, etc.).",
      "pos": [
        10028,
        10053
      ]
    },
    {
      "content": "This automation provides a huge improvement and can",
      "pos": [
        10054,
        10105
      ]
    },
    {
      "content": "ensure a consistent and auditable charging process.",
      "pos": [
        10106,
        10157
      ]
    },
    {
      "content": "Creating a Resource Group with tags on Microsoft Azure",
      "pos": [
        10165,
        10219
      ]
    },
    {
      "content": "The first step in this tutorial is to create a new Resource Group on the Azure Portal and then create new tags to associate to the resources.",
      "pos": [
        10220,
        10361
      ]
    },
    {
      "content": "For this example, we will be creating",
      "pos": [
        10362,
        10399
      ]
    },
    {
      "content": "the following tags: Department, Environment, Owner, Project.",
      "pos": [
        10400,
        10460
      ]
    },
    {
      "content": "The screenshot below of the Azure Portal shows a sample Resource Group with the associated tags.",
      "pos": [
        10462,
        10558
      ]
    },
    {
      "content": "![Figure 11 - Resource Group with associated tags on Azure Portal][11]",
      "pos": [
        10560,
        10630
      ]
    },
    {
      "content": "The next step is to pull the information from the Usage API into Cloud Cruiser.",
      "pos": [
        10632,
        10711
      ]
    },
    {
      "content": "The Usage API currently provides responses in JSON format.",
      "pos": [
        10712,
        10770
      ]
    },
    {
      "content": "Here is a sample of the data retrieved:",
      "pos": [
        10771,
        10810
      ]
    },
    {
      "content": "Import data from the Usage API into Cloud Cruiser",
      "pos": [
        11991,
        12040
      ]
    },
    {
      "content": "Cloud Cruiser workbooks provide an automated way to collect and process information from the Usage API.",
      "pos": [
        12042,
        12145
      ]
    },
    {
      "content": "An ETL (extract-transform-load) workbook allows you to configure the",
      "pos": [
        12146,
        12214
      ]
    },
    {
      "content": "collection, transformation, and publishing of data into the Cloud Cruiser database.",
      "pos": [
        12215,
        12298
      ]
    },
    {
      "content": "Each workbook can have one or multiple collections.",
      "pos": [
        12300,
        12351
      ]
    },
    {
      "content": "This allows you to correlate information from different sources to complement or augment the usage data.",
      "pos": [
        12352,
        12456
      ]
    },
    {
      "content": "For this example, we will create a new sheet in the Azure template workbook (<bpt id=\"p1\">_</bpt>UsageAPI)<ept id=\"p1\">_</ept> and set a new <bpt id=\"p2\">_</bpt>collection<ept id=\"p2\">_</ept> to import information from the Usage API.",
      "pos": [
        12457,
        12614
      ]
    },
    {
      "content": "![Figure 3 - Usage API data imported into the UsageAPI sheet][12]",
      "pos": [
        12616,
        12681
      ]
    },
    {
      "pos": [
        12683,
        12861
      ],
      "content": "Notice that this workbook already has other sheets to import services from Azure (<bpt id=\"p1\">_</bpt>ImportServices<ept id=\"p1\">_</ept>), and process the consumption information from the Billing API (<bpt id=\"p2\">_</bpt>PublishData<ept id=\"p2\">_</ept>)."
    },
    {
      "pos": [
        12863,
        13063
      ],
      "content": "We are going to extract and process the information from the Usage API on the <bpt id=\"p1\">_</bpt>UsageAPI<ept id=\"p1\">_</ept> sheet, and correlate the information with the consumption data from the Billing API on the <bpt id=\"p2\">_</bpt>PublishData<ept id=\"p2\">_</ept> sheet."
    },
    {
      "content": "Processing the tag information from the Usage API",
      "pos": [
        13069,
        13118
      ]
    },
    {
      "content": "After importing the data into the workbook, we will create transformation steps in the <bpt id=\"p1\">_</bpt>UsageAPI<ept id=\"p1\">_</ept> sheet in order to process the information from the API.",
      "pos": [
        13120,
        13273
      ]
    },
    {
      "content": "First step is to use a “JSON split” processor to extract the tags from a single field (as they are imported from the API) and create new fields for each one of them (Department, Project, Owner and",
      "pos": [
        13274,
        13470
      ]
    },
    {
      "content": "Environment).",
      "pos": [
        13471,
        13484
      ]
    },
    {
      "content": "![Figure 4 - Create new fields for the tag information][13]",
      "pos": [
        13486,
        13545
      ]
    },
    {
      "content": "Notice that the “Networking” service is missing the tag information (yellow box), but we can tell that this service is part of the same Resource Group by looking at the <bpt id=\"p1\">_</bpt>ResourceGroupName<ept id=\"p1\">_</ept> field.",
      "pos": [
        13547,
        13742
      ]
    },
    {
      "content": "Since we have the tags for the other resources from this same Resource Group, we can use this information to apply the missing tags to this resource later in the process.",
      "pos": [
        13743,
        13913
      ]
    },
    {
      "content": "The next step is to create a lookup table associating the information from the tags to the <bpt id=\"p1\">_</bpt>ResourceGroupName<ept id=\"p1\">_</ept>.",
      "pos": [
        13915,
        14026
      ]
    },
    {
      "content": "This lookup table will be used on the next step to enrich the consumption data with tag information.",
      "pos": [
        14027,
        14127
      ]
    },
    {
      "content": "Adding the tag information to the consumption data",
      "pos": [
        14133,
        14183
      ]
    },
    {
      "content": "Now we can jump to the <bpt id=\"p1\">_</bpt>PublishData<ept id=\"p1\">_</ept> sheet, which processes the consumption information from the Billing API, and add the fields extracted from the tags.",
      "pos": [
        14185,
        14338
      ]
    },
    {
      "content": "This process is performed by looking at the lookup table created on the previous step, using the <bpt id=\"p1\">_</bpt>ResourceGroupName<ept id=\"p1\">_</ept>",
      "pos": [
        14339,
        14455
      ]
    },
    {
      "content": "as the key for the lookups.",
      "pos": [
        14456,
        14483
      ]
    },
    {
      "content": "![Figure 5 - Populating the account structure with the information from the lookups][14]",
      "pos": [
        14485,
        14573
      ]
    },
    {
      "content": "Notice that the appropriate account structure fields for the “Networking” service were applied, fixing the issue with the missing tags.",
      "pos": [
        14575,
        14710
      ]
    },
    {
      "content": "We also populated the account structure",
      "pos": [
        14711,
        14750
      ]
    },
    {
      "content": "fields for resources other than our target Resource Group with “Other”, in order to differentiate them on the reports.",
      "pos": [
        14751,
        14869
      ]
    },
    {
      "content": "Now we just need to add another step to publish the usage data.",
      "pos": [
        14871,
        14934
      ]
    },
    {
      "content": "During this step, the appropriate rates for each service defined on our Rate Plan will be applied to the usage",
      "pos": [
        14935,
        15045
      ]
    },
    {
      "content": "information, and the resulting charge is then loaded into the database.",
      "pos": [
        15046,
        15117
      ]
    },
    {
      "content": "The best part is that you only have to go through this process once.",
      "pos": [
        15119,
        15187
      ]
    },
    {
      "content": "When the workbook is completed, you just need to add it to the scheduler and it will run hourly or daily at the",
      "pos": [
        15188,
        15299
      ]
    },
    {
      "content": "scheduled time.",
      "pos": [
        15300,
        15315
      ]
    },
    {
      "content": "Then it’s just a matter of creating new reports, or customizing",
      "pos": [
        15316,
        15379
      ]
    },
    {
      "content": "existing ones, in order to visualize and analyze the data to get meaningful",
      "pos": [
        15380,
        15455
      ]
    },
    {
      "content": "insights from your cloud usage.",
      "pos": [
        15456,
        15487
      ]
    },
    {
      "content": "Next Steps",
      "pos": [
        15493,
        15503
      ]
    },
    {
      "content": "For detailed instructions on creating Cloud Cruiser workbooks and reports, please refer to Cloud Cruiser’s online <bpt id=\"p1\">[</bpt>documentation<ept id=\"p1\">](http://docs.cloudcruiser.com/)</ept> (valid login required).",
      "pos": [
        15507,
        15691
      ]
    },
    {
      "content": "For more information about Cloud Cruiser, please contact <bpt id=\"p1\">[</bpt>info@cloudcruiser.com<ept id=\"p1\">](mailto:info@cloudcruiser.com)</ept>.",
      "pos": [
        15693,
        15804
      ]
    },
    {
      "pos": [
        15807,
        15973
      ],
      "content": "See <bpt id=\"p1\">[</bpt>Gain insights into your Microsoft Azure resource consumption<ept id=\"p1\">](billing-usage-rate-card-overview.md)</ept> for an overview of the Azure Resource Usage and RateCard APIs."
    },
    {
      "pos": [
        15976,
        16212
      ],
      "content": "Check out the <bpt id=\"p1\">[</bpt>Azure Billing REST API Reference<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/1ea5b323-54bb-423d-916f-190de96c6a3c)</ept> for more information on both APIs, which are part of the set of APIs provided by the Azure Resource Manager."
    },
    {
      "pos": [
        16215,
        16381
      ],
      "content": "If you would like to dive right into the sample code, check out our <bpt id=\"p1\">[</bpt>Microsoft Azure Billing API Code Samples on Github<ept id=\"p1\">](https://github.com/Azure/BillingCodeSamples)</ept>."
    },
    {
      "content": "Learn More",
      "pos": [
        16387,
        16397
      ]
    },
    {
      "pos": [
        16400,
        16525
      ],
      "content": "See the <bpt id=\"p1\">[</bpt>Azure Resource Manager Overview<ept id=\"p1\">](resource-group-overview.md)</ept> article to learn more about the Azure Resource Manager."
    },
    {
      "content": "test",
      "pos": [
        18786,
        18790
      ]
    }
  ],
  "content": "<properties\n   pageTitle=\"Cloud Cruiser and Microsoft Azure Billing API Integration\"\n   description=\"Provides a unique perspective from Microsoft Azure Billing partner Cloud Cruiser, on their experiences integrating the Azure Billing APIs into their product.  This is especially useful for Azure and Cloud Cruiser customers that are interested in using/trying Cloud Cruiser for Microsoft Azure Pack.\"\n   services=\"billing\"\n   documentationCenter=\"\"\n   authors=\"BryanLa\"\n   manager=\"mbaldwin\"\n   editor=\"\"/>\n\n<tags\n   ms.service=\"billing\"\n   ms.devlang=\"na\"\n   ms.topic=\"article\"\n   ms.tgt_pltfrm=\"na\"\n   ms.workload=\"billing\"\n   ms.date=\"08/10/2015\"\n   ms.author=\"mobandyo;sirishap;bryanla\"/>\n\n# Cloud Cruiser and Microsoft Azure Billing API Integration\n\nThis article describes how the information collected from the new Microsoft Azure Billing APIs can be used in Cloud Cruiser for workflow cost simulation and analysis.\n\n## Azure RateCard API\nThe RateCard API provides rate information from Azure. After authenticating with the proper credentials, you can query the API to collect metadata about the services available on Azure, along with the rates associated with your Offer ID.\n\nBelow is a sample response from the API showing the prices for the A0 (Windows) instance:\n\n    {\n        \"MeterId\": \"0e59ad56-03e5-4c3d-90d4-6670874d7e29\",\n        \"MeterName\": \"Compute Hours\",\n        \"MeterCategory\": \"Virtual Machines\",\n        \"MeterSubCategory\": \"A0 VM (Windows)\",\n        \"Unit\": \"Hours\",\n        \"MeterRates\":\n        {\n            \"0\": 0.029\n        },\n        \"EffectiveDate\": \"2014-08-01T00:00:00Z\",\n        \"IncludedQuantity\": 0.0\n    },\n\n### Cloud Cruiser’s Interface to Azure RateCard API\nCloud Cruiser can leverage the RateCard API information in different ways. For this article, we will show how it can be used to make IaaS workload cost simulation and analysis.\n\nTo demonstrate this use case, imagine a workload of several instances running on Microsoft Azure Pack (WAP). The goal is to simulate this same workload on Azure, and estimate the costs of doing such migration. In order to create this simulation, there are two main tasks to be performed:\n\n1. **Import and process the service information collected from the RateCard API** - This task is also performed on the workbooks, where the extract from the RateCard API is transformed and published to a new rate plan. This new rate plan will be used on the simulations to estimate the Azure prices.\n\n2. **Normalize WAP services and Azure services for IaaS** - By default, WAP services are based on individual resources (CPU, Memory Size, Disk Size, etc.) while Azure services are based on instance size (A0, A1, A2, etc.). This first task can be performed by Cloud Cruiser’s ETL engine, called workbooks, where these resources can be bundled on instance sizes, analogous to Azure instance services.\n\n### Import data from the RateCard API\n\nCloud Cruiser workbooks provide an automated way to collect and process information from the RateCard API.  ETL (extract-transform-load) workbooks allow you to configure the collection, transformation, and publishing of data into the Cloud Cruiser database.\n\nEach workbook can have one or multiple collections. This allows you to correlate information from different sources to complement or augment the usage data. In the two screenshots below, we showing creating a new *collection* in an existing workbook, and importing information into the *collection* from the RateCard API:\n\n![Figure 1 - Creating a new collection][1]\n\n![Figure 2 - Import data from the new collection][2]\n\nAfter importing the data into the workbook, it’s possible to create multiple steps and transformation processes, to modify and model the data. For this example, since we are only interested in infrastructure-as-a-Service (IaaS,) we can use the transformation steps to remove unnecessary rows, or records, related to services other than IaaS.\n\nThe screenshot below shows the transformation steps used to process the data collected from RateCard API:\n\n![Figure 3 - Transformation steps to process collected data from RateCard API][3]\n\n### Defining New Services and Rate Plans\n\nThere are different ways to define services on Cloud Cruiser. One of the options is to import the services from the usage data. This method is commonly used when working with public clouds, where the services are already defined by the provider.\n\nA Rate Plan is a set of rates or prices that can be applied to different services, based on effective dates, or group of customers, among other options. Rate Plans can also be used on Cloud Cruiser to create simulation or “What-if” scenarios, to understand how changes in services can affect the total cost of a workload.\n\nIn this example, we will use the service information from the RateCard API to define new services in Cloud Cruiser. In the same way, we can use the rates associated to the services to create a new Rate Plan on Cloud Cruiser.\n\nAt the end of the transformation process, it is possible to create a new step and publish the data from the RateCard API as new services and rates.\n\n![Figure 4 - Publishing the data from the RateCard API as new Services and Rates][4]\n\n### Verify Azure Services and Rates\n\nAfter publishing the services and rates, you can verify the list of imported services in Cloud Cruiser’s *Services* tab:\n\n![Figure 5 - Verifying the new Services][5]\n\nOn the *Rate Plans* tab, you can check the new rate plan called “AzureSimulation” with the rates imported from the RateCard API.\n\n![Figure 6 - Verifying the new Rate Plan and associated rates][6]\n\n### Normalize WAP and Azure Services\n\nBy default, WAP provides usage information based on the use of compute, memory and network resources. In Cloud Cruiser, you can define your services based directly on the allocation or metered usage of these resources. For example, you can set a basic rate for each hour of CPU usage, or charge the GB of memory allocated to an instance.\n\nFor this example, in order to compare costs between WAP and Azure, we need to aggregate the resource usage on WAP into bundles, which can then be mapped to Azure services. This transformation can be implemented easily in the workbooks:\n\n![Figure 7 - Transforming WAP data to normalize services][7]\n\nThe last step at the workbook is to publish the data into the Cloud Cruiser database. During this step, the usage data is now bundled into services (that map to the Azure Services) and tied to default rates to create the charges.\n\nAfter finishing the workbook, you can automate the processing of the data, by adding a new task on the scheduler and specifying the frequency and time for the workbook to run.\n\n![Figure 8 - Workbook scheduling][8]\n\n### Create Reports for Workload Cost Simulation Analysis\n\nAs the usage is collected and the charges are loaded into the Cloud Cruiser database, we can then leverage the Cloud Cruiser Insights module – an advanced analytics reporting tool – to create the workload cost simulation that we desire.\n\nIn order to demonstrate this scenario, we created the following report:\n\n![Cost Comparison][9]\n\nThe top graph shows a cost comparison broken by services and compares the price of running the workload for each specific service between WAP (dark blue color) and Azure (light blue color).\n\nThe bottom graph shows the same data but broken down by department, demonstrating the costs for each department to run their workload on WAP and Azure, along with the difference between these two – Savings bar (green color).\n\n## Azure Usage API\n\n\n### Introduction\n\nMicrosoft recently\nintroduced the Azure Usage API, allowing subscribers to programmatically pull\nin usage data to gain insights into their consumption. This is great news for Cloud\nCruiser customers that can take advantage of the richer dataset available\nthrough this API.\n\nCloud Cruiser can leverage the integration with the Usage API in several ways. The granularity\n(hourly usage information) and resource metadata information available through\nthe API provides the necessary dataset to support flexible Showback or\nChargeback models. \n\nIn this tutorial, we will\npresent one example of how Cloud Cruiser can benefit from the Usage API\ninformation. More specifically, we will create a new Resource Group on Azure,\nassociate tags for the account structure, and then describe the process of\npulling and processing the tag information into Cloud Cruiser.\n \nThe final goal is to be able\nto create reports like the one below, and be able to analyze cost and\nconsumption based on the account structure populated by the tags.\n\n![Figure 10 - Report with breakdowns using tags][10]\n\n### Microsoft Azure Tags\n\nThe data available through the Azure Usage API includes not only consumption information, but also resource metadata including any tags associated with it. Tags provide an easy way to organize your resources, but in order to be effective, you need to ensure that:\n\n- Tags are correctly applied to the resources at provision time\n- Tags are properly used on the Showback/Chargeback process to tie the usage to the organization’s account structure.\n\nBoth of these requirements can be challenging, especially when there is some sort of manual process on the provision or charging side. Mistyped, incorrect or even missing tags are common complaints from customers when using tags and these errors can make life on the charging side very difficult.\n\nWith the new Azure Usage API, Cloud Cruiser can pull resource tagging information, and through a very sophisticated ETL tool called workbooks, fix these common tagging errors. Through transformation steps leveraging regular expressions and data\ncorrelation, Cloud Cruiser is able to identify incorrectly tagged resources and apply the correct tags, filling the gaps and ensuring the correct association of the resources with the consumer.\n\nOn the charging side,\nCloud Cruiser automates the Showback/Chargeback process, and can leverage the\ntag information to tie the usage to the appropriate consumer (Department,\nDivision, Project, etc.). This automation provides a huge improvement and can\nensure a consistent and auditable charging process.\n \n\n### Creating a Resource Group with tags on Microsoft Azure\nThe first step in this tutorial is to create a new Resource Group on the Azure Portal and then create new tags to associate to the resources. For this example, we will be creating\nthe following tags: Department, Environment, Owner, Project.\n\nThe screenshot below of the Azure Portal shows a sample Resource Group with the associated tags.\n\n![Figure 11 - Resource Group with associated tags on Azure Portal][11]\n\nThe next step is to pull the information from the Usage API into Cloud Cruiser. The Usage API currently provides responses in JSON format. Here is a sample of the data retrieved:\n\n\n    {\n      \"id\": \"/subscriptions/bb678b04-0e48-4b44-XXXX-XXXXXXX/providers/Microsoft.Commerce/UsageAggregates/Daily_BRSDT_20150623_0000\",\n      \"name\": \"Daily_BRSDT_20150623_0000\",\n      \"type\": \"Microsoft.Commerce/UsageAggregate\",\n      \"properties\":\n      {\n        \"subscriptionId\": \"bb678b04-0e48-4b44-XXXX-XXXXXXXXX\",\n        \"usageStartTime\": \"2015-06-22T00:00:00+00:00\",\n        \"usageEndTime\": \"2015-06-23T00:00:00+00:00\",\n        \"meterName\": \"Compute Hours\",\n        \"meterRegion\": \"\",\n        \"meterCategory\": \"Virtual Machines\",\n        \"meterSubCategory\": \"Standard_D1 VM (Non-Windows)\",\n        \"unit\": \"Hours\",\n        \"instanceData\": \"{\\\"Microsoft.Resources\\\":{\\\"resourceUri\\\":\\\"/subscriptions/bb678b04-0e48-4b44-XXXX-XXXXXXXX/resourceGroups/DEMOUSAGEAPI/providers/Microsoft.Compute/virtualMachines/MyDockerVM\\\",\\\"location\\\":\\\"eastus\\\",\\\"tags\\\":{\\\"Department\\\":\\\"Sales\\\",\\\"Project\\\":\\\"Demo Usage API\\\",\\\"Environment\\\":\\\"Test\\\",\\\"Owner\\\":\\\"RSE\\\"},\\\"additionalInfo\\\":{\\\"ImageType\\\":\\\"Canonical\\\",\\\"ServiceType\\\":\\\"Standard_D1\\\"}}}\",\n        \"meterId\": \"e60caf26-9ba0-413d-a422-6141f58081d6\",\n        \"infoFields\": {},\n        \"quantity\": 8\n\n      },\n    },\n\n\n### Import data from the Usage API into Cloud Cruiser\n\nCloud Cruiser workbooks provide an automated way to collect and process information from the Usage API. An ETL (extract-transform-load) workbook allows you to configure the\ncollection, transformation, and publishing of data into the Cloud Cruiser database.\n\nEach workbook can have one or multiple collections. This allows you to correlate information from different sources to complement or augment the usage data. For this example, we will create a new sheet in the Azure template workbook (_UsageAPI)_ and set a new _collection_ to import information from the Usage API.\n\n![Figure 3 - Usage API data imported into the UsageAPI sheet][12]\n\nNotice that this workbook already has other sheets to import services from Azure (_ImportServices_), and process the consumption information from the Billing API (_PublishData_).\n\nWe are going to extract and process the information from the Usage API on the _UsageAPI_ sheet, and correlate the information with the consumption data from the Billing API on the _PublishData_ sheet.\n\n### Processing the tag information from the Usage API\n\nAfter importing the data into the workbook, we will create transformation steps in the _UsageAPI_ sheet in order to process the information from the API. First step is to use a “JSON split” processor to extract the tags from a single field (as they are imported from the API) and create new fields for each one of them (Department, Project, Owner and\nEnvironment).\n\n![Figure 4 - Create new fields for the tag information][13]\n\nNotice that the “Networking” service is missing the tag information (yellow box), but we can tell that this service is part of the same Resource Group by looking at the _ResourceGroupName_ field. Since we have the tags for the other resources from this same Resource Group, we can use this information to apply the missing tags to this resource later in the process.\n\nThe next step is to create a lookup table associating the information from the tags to the _ResourceGroupName_. This lookup table will be used on the next step to enrich the consumption data with tag information.\n\n### Adding the tag information to the consumption data\n\nNow we can jump to the _PublishData_ sheet, which processes the consumption information from the Billing API, and add the fields extracted from the tags. This process is performed by looking at the lookup table created on the previous step, using the _ResourceGroupName_\nas the key for the lookups.\n\n![Figure 5 - Populating the account structure with the information from the lookups][14]\n\nNotice that the appropriate account structure fields for the “Networking” service were applied, fixing the issue with the missing tags. We also populated the account structure\nfields for resources other than our target Resource Group with “Other”, in order to differentiate them on the reports.\n\nNow we just need to add another step to publish the usage data. During this step, the appropriate rates for each service defined on our Rate Plan will be applied to the usage\ninformation, and the resulting charge is then loaded into the database.\n\nThe best part is that you only have to go through this process once. When the workbook is completed, you just need to add it to the scheduler and it will run hourly or daily at the\nscheduled time. Then it’s just a matter of creating new reports, or customizing\nexisting ones, in order to visualize and analyze the data to get meaningful\ninsights from your cloud usage.\n\n### Next Steps\n\n+ For detailed instructions on creating Cloud Cruiser workbooks and reports, please refer to Cloud Cruiser’s online [documentation](http://docs.cloudcruiser.com/) (valid login required).  For more information about Cloud Cruiser, please contact [info@cloudcruiser.com](mailto:info@cloudcruiser.com).\n+ See [Gain insights into your Microsoft Azure resource consumption](billing-usage-rate-card-overview.md) for an overview of the Azure Resource Usage and RateCard APIs.\n+ Check out the [Azure Billing REST API Reference](https://msdn.microsoft.com/library/azure/1ea5b323-54bb-423d-916f-190de96c6a3c) for more information on both APIs, which are part of the set of APIs provided by the Azure Resource Manager.\n+ If you would like to dive right into the sample code, check out our [Microsoft Azure Billing API Code Samples on Github](https://github.com/Azure/BillingCodeSamples).\n\n### Learn More\n+ See the [Azure Resource Manager Overview](resource-group-overview.md) article to learn more about the Azure Resource Manager.\n\n<!--Image references-->\n \n[1]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Create-New-Workbook-Collection.png \"Figure 1 - Creating a new collection\"\n[2]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Import-Data-From-RateCard.png \"Figure 2 - Import data from the new collection\"\n[3]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Transformation-Steps-Process-RateCard-Data.png \"Figure 3 - Transformation steps to process collected data from RateCard API\"\n[4]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Publish-RateCard-Data-New-Services-Rates.png \"Figure 4 - Publishing the data from the RateCard API as new Services and Rates\"\n[5]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Verify-Azure-Services-And-Pricing1.png \"Figure 5 - Verifying the new Services\"\n[6]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Verify-Azure-Services-And-Pricing2.png \"Figure 6 - Verifying the new Rate Plan and associated rates\"\n[7]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Transforming-WAP-Normalize-Services.png \"Figure 7 - Transforming WAP data to normalize services\"\n[8]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Workbook-Scheduling.png \"Figure 8 - Workbook scheduling\"\n[9]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/Workload-Cost-Simulation-Report.png \"Figure 9 - Sample Report for the Workload cost comparison scenario\"\n[10]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/1_ReportWithTags.png \"Figure 10 - Report with breakdowns using tags\"\n[11]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/2_ResourceGroupsWithTags.png \"Figure 11 - Resource Group with associated tags on Azure Portal\"\n[12]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/3_ImportIntoUsageAPISheet.png \"Figure 12 - Usage API data imported into the UsageAPI sheet\"\n[13]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/4_NewTagField.png \"Figure 13 - Create new fields for the tag information\"\n[14]: ./media/billing-usage-rate-card-partner-solution-cloudcruiser/5_PopulateAccountStructure.png \"Figure 14 - Populating the account structure with the information from the lookups\"\n\ntest\n"
}