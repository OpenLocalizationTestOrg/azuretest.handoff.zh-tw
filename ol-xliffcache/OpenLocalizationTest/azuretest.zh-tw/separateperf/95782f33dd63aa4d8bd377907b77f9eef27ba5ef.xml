{
  "nodes": [
    {
      "content": "Configure HBase replication between two datacenters | Microsoft Azure",
      "pos": [
        27,
        96
      ]
    },
    {
      "content": "Learn how to configure HBase replication across two data centers, and about the use cases for cluster replication.",
      "pos": [
        115,
        229
      ]
    },
    {
      "content": "Configure HBase geo-replication in HDInsight",
      "pos": [
        539,
        583
      ]
    },
    {
      "content": "[AZURE.SELECTOR]",
      "pos": [
        587,
        603
      ]
    },
    {
      "content": "Configure VPN connectivity",
      "pos": [
        607,
        633
      ]
    },
    {
      "content": "Configure DNS",
      "pos": [
        693,
        706
      ]
    },
    {
      "content": "Configure HBase replication",
      "pos": [
        761,
        788
      ]
    },
    {
      "content": "Learn how to configure HBase replication across two data centers.",
      "pos": [
        829,
        894
      ]
    },
    {
      "content": "Some use cases for cluster replication include:",
      "pos": [
        895,
        942
      ]
    },
    {
      "content": "Backup and disaster recovery",
      "pos": [
        946,
        974
      ]
    },
    {
      "content": "Data aggregation",
      "pos": [
        977,
        993
      ]
    },
    {
      "content": "Geographic data distribution",
      "pos": [
        996,
        1024
      ]
    },
    {
      "content": "Online data ingestion combined with offline data analytics",
      "pos": [
        1027,
        1085
      ]
    },
    {
      "content": "Cluster replication uses a source-push methodology.",
      "pos": [
        1087,
        1138
      ]
    },
    {
      "content": "An HBase cluster can be a source, a destination, or can fulfill both roles at once.",
      "pos": [
        1139,
        1222
      ]
    },
    {
      "content": "Replication is asynchronous, and the goal of replication is eventual consistency.",
      "pos": [
        1223,
        1304
      ]
    },
    {
      "content": "When the source receives an edit to a column family with replication enabled, that edit is propagated to all destination clusters.",
      "pos": [
        1305,
        1435
      ]
    },
    {
      "content": "When data is replicated from one cluster to another, the source cluster and all clusters which have already consumed the data are tracked to prevent replication loops.",
      "pos": [
        1436,
        1603
      ]
    },
    {
      "content": "For more information,",
      "pos": [
        1604,
        1625
      ]
    },
    {
      "content": "In this tutorial, you will configure a source-destination replication.",
      "pos": [
        1627,
        1697
      ]
    },
    {
      "content": "For other cluster topologies, see <bpt id=\"p1\">[</bpt>Apache HBase Reference Guide<ept id=\"p1\">](http://hbase.apache.org/book.html#_cluster_replication)</ept>.",
      "pos": [
        1699,
        1820
      ]
    },
    {
      "content": "This is the third part of the series:",
      "pos": [
        1822,
        1859
      ]
    },
    {
      "content": "Configure a VPN connectivity between two virtual networks",
      "pos": [
        1864,
        1921
      ]
    },
    {
      "content": "Configure DNS for the virtual networks",
      "pos": [
        1960,
        1998
      ]
    },
    {
      "content": "Configure HBase geo replication (this tutorial)",
      "pos": [
        2035,
        2082
      ]
    },
    {
      "pos": [
        2084,
        2363
      ],
      "content": "The following diagram illustrates the two virtual networks and the network connectivity you created in <bpt id=\"p1\">[</bpt>Configure a VPN connectivity between two virtual networks<ept id=\"p1\">][hdinsight-hbase-geo-replication-vnet]</ept> and <bpt id=\"p2\">[</bpt>Configure DNS for the virtual networks<ept id=\"p2\">][hdinsight-hbase-replication-dns]</ept>:"
    },
    {
      "content": "HDInsight HBase replication virtual network diagram",
      "pos": [
        2368,
        2419
      ]
    },
    {
      "pos": [
        2443,
        2482
      ],
      "content": "<ph id=\"ph1\">&lt;a id=\"prerequisites\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph>Prerequisites"
    },
    {
      "content": "Before you begin this tutorial, you must have the following:",
      "pos": [
        2484,
        2544
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>An Azure subscription<ept id=\"p1\">**</ept>.",
      "pos": [
        2548,
        2574
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>Get Azure free trial<ept id=\"p1\">](http://azure.microsoft.com/documentation/videos/get-azure-free-trial-for-testing-hadoop-in-hdinsight/)</ept>.",
      "pos": [
        2575,
        2705
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>A workstation with Azure PowerShell<ept id=\"p1\">**</ept>.",
      "pos": [
        2709,
        2749
      ]
    },
    {
      "content": "See <bpt id=\"p1\">[</bpt>Install and use Azure PowerShell<ept id=\"p1\">](http://azure.microsoft.com/documentation/videos/install-and-use-azure-powershell/)</ept>.",
      "pos": [
        2750,
        2872
      ]
    },
    {
      "content": "To execute PowerShell scripts, you must run Azure PowerShell as administrator and set the execution policy to <bpt id=\"p1\">*</bpt>RemoteSigned<ept id=\"p1\">*</ept>.",
      "pos": [
        2873,
        2998
      ]
    },
    {
      "content": "See Using the Set-ExecutionPolicy cmdlet.",
      "pos": [
        2999,
        3040
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Two Azure virtual network with VPN connectivity and with DNS configured<ept id=\"p1\">**</ept>.",
      "pos": [
        3044,
        3120
      ]
    },
    {
      "content": "For instructions, see <bpt id=\"p1\">[</bpt>Configure a VPN connection between two Azure virtual networks<ept id=\"p1\">][hdinsight-hbase-replication-vnet]</ept>, and <bpt id=\"p2\">[</bpt>Configure DNS between two Azure virtual networks<ept id=\"p2\">][hdinsight-hbase-replication-dns]</ept>.",
      "pos": [
        3122,
        3331
      ]
    },
    {
      "content": "Provision HBase clusters in HDInsight",
      "pos": [
        3651,
        3688
      ]
    },
    {
      "content": "In <bpt id=\"p1\">[</bpt>Configure a VPN connection between two Azure virtual networks<ept id=\"p1\">][hdinsight-hbase-replication-vnet]</ept>, you have created a virtual network in an Europe data center, and a virtual network in a U.S.",
      "pos": [
        3690,
        3884
      ]
    },
    {
      "content": "data center.",
      "pos": [
        3885,
        3897
      ]
    },
    {
      "content": "The two virtual network are connected via VPN.",
      "pos": [
        3898,
        3944
      ]
    },
    {
      "content": "In this session, you will provision an HBase cluster in each of the virtual networks.",
      "pos": [
        3945,
        4030
      ]
    },
    {
      "content": "Later in this tutorial, you will make one of the HBase clusters to replicate the other HBase cluster.",
      "pos": [
        4031,
        4132
      ]
    },
    {
      "content": "The Azure portal doesn't support provisioning HDInsight clusters with custom configuration options.",
      "pos": [
        4134,
        4233
      ]
    },
    {
      "content": "For example, set <bpt id=\"p1\">*</bpt>hbase.replication<ept id=\"p1\">*</ept> to <bpt id=\"p2\">*</bpt>true<ept id=\"p2\">*</ept>.",
      "pos": [
        4234,
        4281
      ]
    },
    {
      "content": "If you set the value in the configuration file after a cluster is provisioned, you will lose the setting after the cluster is being reimaged.",
      "pos": [
        4282,
        4423
      ]
    },
    {
      "content": "For more information see <bpt id=\"p1\">[</bpt>Provision Hadoop clusters in HDInsight<ept id=\"p1\">][hdinsight-provision]</ept>.",
      "pos": [
        4424,
        4511
      ]
    },
    {
      "content": "One of the options to provision HDInsight cluster with custom options is using Azure PowerShell.",
      "pos": [
        4512,
        4608
      ]
    },
    {
      "content": "To provision an HBase Cluster in Contoso-VNet-EU",
      "pos": [
        4613,
        4661
      ]
    },
    {
      "content": "From your workstation, open Windows PowerShell ISE.",
      "pos": [
        4669,
        4720
      ]
    },
    {
      "content": "Set the variables at the beginning of the script, and then run the script.",
      "pos": [
        4724,
        4798
      ]
    },
    {
      "content": "To provision an HBase Cluster in Contoso-VNet-US",
      "pos": [
        8125,
        8173
      ]
    },
    {
      "content": "Use the same script with the following values:",
      "pos": [
        8180,
        8226
      ]
    },
    {
      "content": "Because you have already connected to your Azure account, you don't need to run the following comlets anymore:",
      "pos": [
        8470,
        8580
      ]
    },
    {
      "content": "Configure DNS conditional forwarder",
      "pos": [
        8671,
        8706
      ]
    },
    {
      "content": "In <bpt id=\"p1\">[</bpt>Configure DNS for the virtual networks<ept id=\"p1\">][hdinsight-hbase-replication-dns]</ept>, you have configured DNS servers for the two networks.",
      "pos": [
        8708,
        8839
      ]
    },
    {
      "content": "The HBase clusters have different domain suffixes.",
      "pos": [
        8840,
        8890
      ]
    },
    {
      "content": "So you need to configure additional DNS conditional forwarders.",
      "pos": [
        8891,
        8954
      ]
    },
    {
      "content": "To configure conditional forwarder, you need to know the domain suffixes of the two HBase clusters.",
      "pos": [
        8956,
        9055
      ]
    },
    {
      "content": "To find the domain suffixes of the two HBase clusters",
      "pos": [
        9060,
        9113
      ]
    },
    {
      "content": "RDP into <bpt id=\"p1\">**</bpt>Contoso-HBase-EU<ept id=\"p1\">**</ept>.",
      "pos": [
        9120,
        9150
      ]
    },
    {
      "content": "For instructions, see <bpt id=\"p1\">[</bpt>Manage Hadoop clusters in HDInsight by using the Azure portal<ept id=\"p1\">][hdinsight-manage-portal]</ept>.",
      "pos": [
        9152,
        9263
      ]
    },
    {
      "content": "It is actually headnode0 of the cluster.",
      "pos": [
        9264,
        9304
      ]
    },
    {
      "content": "Open a Windows PowerShell console, or a command prompt.",
      "pos": [
        9308,
        9363
      ]
    },
    {
      "pos": [
        9367,
        9435
      ],
      "content": "Run <bpt id=\"p1\">**</bpt>ipconfig<ept id=\"p1\">**</ept>, and write down <bpt id=\"p2\">**</bpt>Connection-specific DNS suffix<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Please don't close the RDP session.",
      "pos": [
        9439,
        9474
      ]
    },
    {
      "content": "You will need it later to test domain name resolution.",
      "pos": [
        9476,
        9530
      ]
    },
    {
      "pos": [
        9534,
        9631
      ],
      "content": "Repeat the same steps to find out the <bpt id=\"p1\">**</bpt>Connection-specific DNS suffix<ept id=\"p1\">**</ept> of <bpt id=\"p2\">**</bpt>Contoso-HBase-US<ept id=\"p2\">**</ept>."
    },
    {
      "content": "To configure DNS forwarders",
      "pos": [
        9636,
        9663
      ]
    },
    {
      "pos": [
        9672,
        9700
      ],
      "content": "RDP into <bpt id=\"p1\">**</bpt>Contoso-DNS-EU<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Click the Windows key on the lower left.",
      "pos": [
        9706,
        9746
      ]
    },
    {
      "pos": [
        9751,
        9782
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Administrative Tools<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        9787,
        9801
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>DNS<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        9806,
        9859
      ],
      "content": "In the left pane, expand <bpt id=\"p1\">**</bpt>DSN<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>Contoso-DNS-EU<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        9864,
        9949
      ],
      "content": "Right-click <bpt id=\"p1\">**</bpt>Conditional Forwarders<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>New Conditional Forwarder<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Enter the following information:",
      "pos": [
        9955,
        9987
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>DNS Domain<ept id=\"p1\">**</ept>: enter the DNS suffix of the Contoso-HBase-US.",
      "pos": [
        9994,
        10055
      ]
    },
    {
      "content": "For example: Contoso-HBase-US.f5.internal.cloudapp.net.",
      "pos": [
        10056,
        10111
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>IP addresses of the master servers<ept id=\"p1\">**</ept>: enter 10.2.0.4, which is the Contoso-DNS-US’s IP address.",
      "pos": [
        10118,
        10215
      ]
    },
    {
      "content": "Please verify the IP.",
      "pos": [
        10216,
        10237
      ]
    },
    {
      "content": "Your DNS server can have a different IP address.",
      "pos": [
        10238,
        10286
      ]
    },
    {
      "content": "Press <bpt id=\"p1\">**</bpt>ENTER<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>.",
      "pos": [
        10291,
        10330
      ]
    },
    {
      "content": "Now you will be able to resolve the Contoso-DNS-US’s IP address from Contoso-DNS-EU.",
      "pos": [
        10332,
        10416
      ]
    },
    {
      "content": "Repeat the steps to add a DNS conditional forwarder to the DNS service on the Contoso-DNS-US virtual machine with the following values:",
      "pos": [
        10421,
        10556
      ]
    },
    {
      "pos": [
        10563,
        10624
      ],
      "content": "<bpt id=\"p1\">**</bpt>DNS Domain<ept id=\"p1\">**</ept>: enter the DNS suffix of the Contoso-HBase-EU."
    },
    {
      "pos": [
        10632,
        10729
      ],
      "content": "<bpt id=\"p1\">**</bpt>IP addresses of the master servers<ept id=\"p1\">**</ept>: enter 10.2.0.4, which is the Contoso-DNS-EU’s IP address."
    },
    {
      "content": "To test domain name resolution",
      "pos": [
        10733,
        10763
      ]
    },
    {
      "content": "Switch to the Contoso-HBase-EU RDP window.",
      "pos": [
        10770,
        10812
      ]
    },
    {
      "content": "Open a command prompt.",
      "pos": [
        10816,
        10838
      ]
    },
    {
      "content": "Run the ping command:",
      "pos": [
        10842,
        10863
      ]
    },
    {
      "content": "The ICM protocol is turned on the worker nodes of the HBase clusters",
      "pos": [
        10926,
        10994
      ]
    },
    {
      "content": "Don't close the RDP session.",
      "pos": [
        10999,
        11027
      ]
    },
    {
      "content": "You will still need it later in the tutorial.",
      "pos": [
        11028,
        11073
      ]
    },
    {
      "content": "Repeat the same steps to ping the headnode0 of the Contoso-HBase-EU from the Contoso-HBase-US.",
      "pos": [
        11077,
        11171
      ]
    },
    {
      "pos": [
        11174,
        11247
      ],
      "content": "<ph id=\"ph1\">[AZURE.IMPORTANT]</ph> DNS must work before you can proceed to the next steps."
    },
    {
      "content": "Enable replication between HBase tables",
      "pos": [
        11252,
        11291
      ]
    },
    {
      "content": "Now, you can create a sample HBase table, enable replication, and then test it with some data.",
      "pos": [
        11293,
        11387
      ]
    },
    {
      "content": "The sample table you will use has two column families: Personal and Office.",
      "pos": [
        11388,
        11463
      ]
    },
    {
      "content": "In this tutorial, you will make the Europe HBase cluster as the source cluster, and the U.S.",
      "pos": [
        11466,
        11558
      ]
    },
    {
      "content": "HBase cluster as the destination cluster.",
      "pos": [
        11559,
        11600
      ]
    },
    {
      "content": "Create HBase tables with the same names and column families on both the source and destination clusters, so that the destination cluster knows where to store data it will receive.",
      "pos": [
        11602,
        11781
      ]
    },
    {
      "content": "For more information on using the HBase shell, see <bpt id=\"p1\">[</bpt>Get started with Apache HBase in HDInsight<ept id=\"p1\">][hdinsight-hbase-get-started]</ept>.",
      "pos": [
        11782,
        11907
      ]
    },
    {
      "content": "To create an HBase table on Contoso-HBase-EU",
      "pos": [
        11911,
        11955
      ]
    },
    {
      "pos": [
        11962,
        12008
      ],
      "content": "Switch to the <bpt id=\"p1\">**</bpt>Contoso-HBase-EU<ept id=\"p1\">**</ept> RDP window."
    },
    {
      "pos": [
        12012,
        12060
      ],
      "content": "From the desktop, click <bpt id=\"p1\">**</bpt>Hadoop Command Line<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Change the folder to the HBase home directory:",
      "pos": [
        12064,
        12110
      ]
    },
    {
      "content": "Open the HBase shell:",
      "pos": [
        12143,
        12164
      ]
    },
    {
      "content": "Create an HBase table:",
      "pos": [
        12189,
        12211
      ]
    },
    {
      "content": "Don't close either the RDP session nor the Hadoop Command Line window.",
      "pos": [
        12264,
        12334
      ]
    },
    {
      "content": "You will still need them later in the tutorial.",
      "pos": [
        12335,
        12382
      ]
    },
    {
      "content": "To create an HBase table on Contoso-HBase-US",
      "pos": [
        12390,
        12434
      ]
    },
    {
      "content": "Repeat the same steps to create the same table on Contoso-HBase-US.",
      "pos": [
        12440,
        12507
      ]
    },
    {
      "content": "To add Contoso-HBase-US as a replication peer",
      "pos": [
        12512,
        12557
      ]
    },
    {
      "pos": [
        12564,
        12609
      ],
      "content": "Switch to the <bpt id=\"p1\">**</bpt>Contso-HBase_EU<ept id=\"p1\">**</ept> RDP window."
    },
    {
      "content": "From the HBase shell window, add the destination cluster (Contoso-HBase-US) as a peer, for example:",
      "pos": [
        12613,
        12712
      ]
    },
    {
      "content": "In the sample, the domain suffix is <bpt id=\"p1\">*</bpt>contoso-hbase-us.d4.internal.cloudapp.net<ept id=\"p1\">*</ept>.",
      "pos": [
        12914,
        12994
      ]
    },
    {
      "content": "You need to update it to match your domain suffix of the US HBase cluster.",
      "pos": [
        12995,
        13069
      ]
    },
    {
      "content": "Make sure there is no spaces between the hostnames.",
      "pos": [
        13070,
        13121
      ]
    },
    {
      "content": "To configure each column family to be replicated on the source cluster",
      "pos": [
        13125,
        13195
      ]
    },
    {
      "pos": [
        13202,
        13317
      ],
      "content": "From the HBase shell window of the <bpt id=\"p1\">**</bpt>Contso-HBase-EU<ept id=\"p1\">**</ept> RDP session,  configure each column family to be replicated:"
    },
    {
      "content": "To bulk upload data to the HBase table",
      "pos": [
        13519,
        13557
      ]
    },
    {
      "content": "A sample data file has been uploaded to a public Azure Blob container with the following URL:",
      "pos": [
        13561,
        13654
      ]
    },
    {
      "content": "The content of the file:",
      "pos": [
        13737,
        13761
      ]
    },
    {
      "content": "You can upload the same data file into your HBase cluster and import the data from there.",
      "pos": [
        14408,
        14497
      ]
    },
    {
      "pos": [
        14502,
        14548
      ],
      "content": "Switch to the <bpt id=\"p1\">**</bpt>Contoso-HBase-EU<ept id=\"p1\">**</ept> RDP window."
    },
    {
      "pos": [
        14552,
        14600
      ],
      "content": "From the desktop, click <bpt id=\"p1\">**</bpt>Hadoop Command Line<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Change the folder to the HBase home directory:",
      "pos": [
        14604,
        14650
      ]
    },
    {
      "content": "upload the data:",
      "pos": [
        14684,
        14700
      ]
    },
    {
      "content": "Verify that data replication is taking place",
      "pos": [
        15058,
        15102
      ]
    },
    {
      "content": "You can verify that replication is taking place by scanning the tables from both clusters with the following HBase shell commands:",
      "pos": [
        15104,
        15234
      ]
    },
    {
      "content": "Next Steps",
      "pos": [
        15265,
        15275
      ]
    },
    {
      "content": "In this tutorial, you have learned how to configure HBase replication across two datacenters.",
      "pos": [
        15277,
        15370
      ]
    },
    {
      "content": "To learn more about HDInsight and HBase, see:",
      "pos": [
        15371,
        15416
      ]
    },
    {
      "content": "HDInsight service page",
      "pos": [
        15421,
        15443
      ]
    },
    {
      "content": "HDInsight documentation",
      "pos": [
        15496,
        15519
      ]
    },
    {
      "content": "Get started with Apache HBase in HDInsight",
      "pos": [
        15586,
        15628
      ]
    },
    {
      "content": "HDInsight HBase overview",
      "pos": [
        15662,
        15686
      ]
    },
    {
      "content": "Provision HBase clusters on Azure Virtual Network",
      "pos": [
        15717,
        15766
      ]
    },
    {
      "content": "Analyze real-time Twitter sentiment with HBase",
      "pos": [
        15803,
        15849
      ]
    },
    {
      "content": "Analyzing sensor data with Storm and HBase in HDInsight (Hadoop)",
      "pos": [
        15889,
        15953
      ]
    },
    {
      "content": "test",
      "pos": [
        16273,
        16277
      ]
    }
  ],
  "content": "<properties \n   pageTitle=\"Configure HBase replication between two datacenters | Microsoft Azure\" \n   description=\"Learn how to configure HBase replication across two data centers, and about the use cases for cluster replication.\" \n   services=\"hdinsight,virtual-network\" \n   documentationCenter=\"\" \n   authors=\"mumian\" \n   manager=\"paulettm\" \n   editor=\"cgronlun\"/>\n\n<tags\n   ms.service=\"hdinsight\"\n   ms.devlang=\"na\"\n   ms.topic=\"article\"\n   ms.tgt_pltfrm=\"na\"\n   ms.workload=\"big-data\" \n   ms.date=\"07/08/2015\"\n   ms.author=\"jgao\"/>\n\n# Configure HBase geo-replication in HDInsight\n\n> [AZURE.SELECTOR]\n- [Configure VPN connectivity](../hdinsight-hbase-geo-replication-configure-VNETs.md)\n- [Configure DNS](hdinsight-hbase-geo-replication-configure-DNS.md)\n- [Configure HBase replication](hdinsight-hbase-geo-replication.md) \n \nLearn how to configure HBase replication across two data centers. Some use cases for cluster replication include:\n\n- Backup and disaster recovery\n- Data aggregation\n- Geographic data distribution\n- Online data ingestion combined with offline data analytics\n\nCluster replication uses a source-push methodology. An HBase cluster can be a source, a destination, or can fulfill both roles at once. Replication is asynchronous, and the goal of replication is eventual consistency. When the source receives an edit to a column family with replication enabled, that edit is propagated to all destination clusters. When data is replicated from one cluster to another, the source cluster and all clusters which have already consumed the data are tracked to prevent replication loops. For more information, \nIn this tutorial, you will configure a source-destination replication.  For other cluster topologies, see [Apache HBase Reference Guide](http://hbase.apache.org/book.html#_cluster_replication).\n\nThis is the third part of the series:\n\n- [Configure a VPN connectivity between two virtual networks][hdinsight-hbase-replication-vnet]\n- [Configure DNS for the virtual networks][hdinsight-hbase-replication-dns]\n- Configure HBase geo replication (this tutorial)\n\nThe following diagram illustrates the two virtual networks and the network connectivity you created in [Configure a VPN connectivity between two virtual networks][hdinsight-hbase-geo-replication-vnet] and [Configure DNS for the virtual networks][hdinsight-hbase-replication-dns]: \n\n![HDInsight HBase replication virtual network diagram][img-vnet-diagram]\n\n## <a id=\"prerequisites\"></a>Prerequisites\n\nBefore you begin this tutorial, you must have the following:\n\n- **An Azure subscription**. See [Get Azure free trial](http://azure.microsoft.com/documentation/videos/get-azure-free-trial-for-testing-hadoop-in-hdinsight/).\n\n- **A workstation with Azure PowerShell**. See [Install and use Azure PowerShell](http://azure.microsoft.com/documentation/videos/install-and-use-azure-powershell/). To execute PowerShell scripts, you must run Azure PowerShell as administrator and set the execution policy to *RemoteSigned*. See Using the Set-ExecutionPolicy cmdlet.\n\n- **Two Azure virtual network with VPN connectivity and with DNS configured**.  For instructions, see [Configure a VPN connection between two Azure virtual networks][hdinsight-hbase-replication-vnet], and [Configure DNS between two Azure virtual networks][hdinsight-hbase-replication-dns].\n\n\n    Before running PowerShell scripts, make sure you are connected to your Azure subscription using the following cmdlet:\n\n        Add-AzureAccount\n\n    If you have multiple Azure subscriptions, use the following cmdlet to set the current subscription:\n\n        Select-AzureSubscription <AzureSubscriptionName>\n\n\n\n## Provision HBase clusters in HDInsight\n\nIn [Configure a VPN connection between two Azure virtual networks][hdinsight-hbase-replication-vnet], you have created a virtual network in an Europe data center, and a virtual network in a U.S. data center. The two virtual network are connected via VPN. In this session, you will provision an HBase cluster in each of the virtual networks. Later in this tutorial, you will make one of the HBase clusters to replicate the other HBase cluster.\n\nThe Azure portal doesn't support provisioning HDInsight clusters with custom configuration options. For example, set *hbase.replication* to *true*. If you set the value in the configuration file after a cluster is provisioned, you will lose the setting after the cluster is being reimaged. For more information see [Provision Hadoop clusters in HDInsight][hdinsight-provision]. One of the options to provision HDInsight cluster with custom options is using Azure PowerShell.\n\n\n**To provision an HBase Cluster in Contoso-VNet-EU** \n\n1. From your workstation, open Windows PowerShell ISE.\n2. Set the variables at the beginning of the script, and then run the script.\n\n        # create hbase cluster with replication enabled\n        \n        $azureSubscriptionName = \"[AzureSubscriptionName]\"\n        \n        $hbaseClusterName = \"Contoso-HBase-EU\" # This is the HBase cluster name to be used.\n        $hbaseClusterSize = 1   # You must provision a cluster that contains at least 3 nodes for high availability of the HBase services.\n        $hadoopUserLogin = \"[HadoopUserName]\"\n        $hadoopUserpw = \"[HadoopUserPassword]\"\n        \n        $vNetName = \"Contoso-VNet-EU\"  # This name must match your Europe virtual network name.\n        $subNetName = 'Subnet-1' # This name must match your Europe virtual network subnet name.  The default name is \"Subnet-1\".\n        \n        $storageAccountName = 'ContosoStoreEU'  # The script will create this storage account for you.  The storage account name doesn't support hyphens. \n        $storageAccountName = $storageAccountName.ToLower() #Storage account name must be in lower case.\n        $blobContainerName = $hbaseClusterName.ToLower()  #Use the cluster name as the default container name.\n        \n        #connect to your Azure subscription\n        Add-AzureAccount \n        Select-AzureSubscription $azureSubscriptionName\n        \n        # Create a storage account used by the HBase cluster\n        $location = Get-AzureVNetSite -VNetName $vNetName | %{$_.Location} # use the virtual network location\n        New-AzureStorageAccount -StorageAccountName $storageAccountName -Location $location\n        \n        # Create a blob container used by the HBase cluster\n        $storageAccountKey = Get-AzureStorageKey -StorageAccountName $storageAccountName | %{$_.Primary}\n        $storageContext = New-AzureStorageContext -StorageAccountName $storageAccountName -StorageAccountKey $storageAccountKey\n        New-AzureStorageContainer -Name $blobContainerName -Context $storageContext\n        \n        # Create provision configuration object\n        $hbaseConfigValues = new-object 'Microsoft.WindowsAzure.Management.HDInsight.Cmdlet.DataObjects.AzureHDInsightHBaseConfiguration'\n            \n        $hbaseConfigValues.Configuration = @{ \"hbase.replication\"=\"true\" } #this modifies the hbase-site.xml file\n        \n        # retrieve vnet id based on vnetname\n        $vNetID = Get-AzureVNetSite -VNetName $vNetName | %{$_.id}\n        \n        $config = New-AzureHDInsightClusterConfig `\n                        -ClusterSizeInNodes $hbaseClusterSize `\n                        -ClusterType HBase `\n                        -VirtualNetworkId $vNetID `\n                        -SubnetName $subNetName `\n                    | Set-AzureHDInsightDefaultStorage `\n                        -StorageAccountName $storageAccountName `\n                        -StorageAccountKey $storageAccountKey `\n                        -StorageContainerName $blobContainerName `\n                    | Add-AzureHDInsightConfigValues `\n                        -HBase $hbaseConfigValues\n        \n        # provision HDInsight cluster\n        $hadoopUserPassword = ConvertTo-SecureString -String $hadoopUserpw -AsPlainText -Force     \n        $credential = New-Object System.Management.Automation.PSCredential($hadoopUserLogin,$hadoopUserPassword)\n        \n        $config | New-AzureHDInsightCluster -Name $hbaseClusterName -Location $location -Credential $credential\n\n\n\n**To provision an HBase Cluster in Contoso-VNet-US** \n\n- Use the same script with the following values:\n\n        $hbaseClusterName = \"Contoso-HBase-US\" # This is the HBase cluster name to be used.\n        $vNetName = \"Contoso-VNet-US\"  # This name must match your Europe virtual network name.\n        $storageAccountName = 'ContosoStoreUS'  \n\n    Because you have already connected to your Azure account, you don't need to run the following comlets anymore:\n\n        Add-AzureAccount \n        Select-AzureSubscription $azureSubscriptionName\n\n\n\n\n## Configure DNS conditional forwarder\n\nIn [Configure DNS for the virtual networks][hdinsight-hbase-replication-dns], you have configured DNS servers for the two networks. The HBase clusters have different domain suffixes. So you need to configure additional DNS conditional forwarders.\n\nTo configure conditional forwarder, you need to know the domain suffixes of the two HBase clusters. \n\n**To find the domain suffixes of the two HBase clusters**\n\n1. RDP into **Contoso-HBase-EU**.  For instructions, see [Manage Hadoop clusters in HDInsight by using the Azure portal][hdinsight-manage-portal]. It is actually headnode0 of the cluster.\n2. Open a Windows PowerShell console, or a command prompt.\n3. Run **ipconfig**, and write down **Connection-specific DNS suffix**.\n4. Please don't close the RDP session.  You will need it later to test domain name resolution.\n5. Repeat the same steps to find out the **Connection-specific DNS suffix** of **Contoso-HBase-US**.\n\n\n**To configure DNS forwarders**\n \n1.  RDP into **Contoso-DNS-EU**. \n2.  Click the Windows key on the lower left.\n2.  Click **Administrative Tools**.\n3.  Click **DNS**.\n4.  In the left pane, expand **DSN**, **Contoso-DNS-EU**.\n5.  Right-click **Conditional Forwarders**, and then click **New Conditional Forwarder**. \n5.  Enter the following information:\n    - **DNS Domain**: enter the DNS suffix of the Contoso-HBase-US. For example: Contoso-HBase-US.f5.internal.cloudapp.net.\n    - **IP addresses of the master servers**: enter 10.2.0.4, which is the Contoso-DNS-US’s IP address. Please verify the IP. Your DNS server can have a different IP address.\n6.  Press **ENTER**, and then click **OK**.  Now you will be able to resolve the Contoso-DNS-US’s IP address from Contoso-DNS-EU.\n7.  Repeat the steps to add a DNS conditional forwarder to the DNS service on the Contoso-DNS-US virtual machine with the following values:\n    - **DNS Domain**: enter the DNS suffix of the Contoso-HBase-EU. \n    - **IP addresses of the master servers**: enter 10.2.0.4, which is the Contoso-DNS-EU’s IP address.\n\n**To test domain name resolution**\n\n1. Switch to the Contoso-HBase-EU RDP window.\n2. Open a command prompt.\n3. Run the ping command:\n\n        ping headnode0.[DNS suffix of Contoso-HBase-US]\n\n    The ICM protocol is turned on the worker nodes of the HBase clusters\n\n4. Don't close the RDP session. You will still need it later in the tutorial.\n5. Repeat the same steps to ping the headnode0 of the Contoso-HBase-EU from the Contoso-HBase-US.\n\n>[AZURE.IMPORTANT] DNS must work before you can proceed to the next steps.\n\n## Enable replication between HBase tables\n\nNow, you can create a sample HBase table, enable replication, and then test it with some data. The sample table you will use has two column families: Personal and Office. \n\nIn this tutorial, you will make the Europe HBase cluster as the source cluster, and the U.S. HBase cluster as the destination cluster.\n\nCreate HBase tables with the same names and column families on both the source and destination clusters, so that the destination cluster knows where to store data it will receive. For more information on using the HBase shell, see [Get started with Apache HBase in HDInsight][hdinsight-hbase-get-started].\n\n**To create an HBase table on Contoso-HBase-EU**\n\n1. Switch to the **Contoso-HBase-EU** RDP window.\n2. From the desktop, click **Hadoop Command Line**.\n2. Change the folder to the HBase home directory:\n\n        cd %HBASE_HOME%\\bin\n3. Open the HBase shell:\n\n        hbase shell\n4. Create an HBase table:\n\n        create 'Contacts', 'Personal', 'Office'\n5. Don't close either the RDP session nor the Hadoop Command Line window. You will still need them later in the tutorial.\n    \n**To create an HBase table on Contoso-HBase-US**\n\n- Repeat the same steps to create the same table on Contoso-HBase-US.\n\n\n**To add Contoso-HBase-US as a replication peer**\n\n1. Switch to the **Contso-HBase_EU** RDP window.\n2. From the HBase shell window, add the destination cluster (Contoso-HBase-US) as a peer, for example:\n\n        add_peer '1', 'zookeeper0.contoso-hbase-us.d4.internal.cloudapp.net,zookeeper1.contoso-hbase-us.d4.internal.cloudapp.net,zookeeper2.contoso-hbase-us.d4.internal.cloudapp.net:2181:/hbase'\n\n    In the sample, the domain suffix is *contoso-hbase-us.d4.internal.cloudapp.net*. You need to update it to match your domain suffix of the US HBase cluster. Make sure there is no spaces between the hostnames.\n\n**To configure each column family to be replicated on the source cluster**\n\n1. From the HBase shell window of the **Contso-HBase-EU** RDP session,  configure each column family to be replicated:\n\n        disable 'Contacts'\n        alter 'Contacts', {NAME => 'Personal', REPLICATION_SCOPE => '1'}\n        alter 'Contacts', {NAME => 'Office', REPLICATION_SCOPE => '1'}\n        enable 'Contacts'\n\n**To bulk upload data to the HBase table**\n\nA sample data file has been uploaded to a public Azure Blob container with the following URL:\n\n        wasb://hbasecontacts@hditutorialdata.blob.core.windows.net/contacts.txt\n\nThe content of the file:\n\n        8396    Calvin Raji 230-555-0191    5415 San Gabriel Dr.\n        16600   Karen Wu    646-555-0113    9265 La Paz\n        4324    Karl Xie    508-555-0163    4912 La Vuelta\n        16891   Jonathan Jackson    674-555-0110    40 Ellis St.\n        3273    Miguel Miller   397-555-0155    6696 Anchor Drive\n        3588    Osarumwense Agbonile    592-555-0152    1873 Lion Circle\n        10272   Julia Lee   870-555-0110    3148 Rose Street\n        4868    Jose Hayes  599-555-0171    793 Crawford Street\n        4761    Caleb Alexander 670-555-0141    4775 Kentucky Dr.\n        16443   Terry Chander   998-555-0171    771 Northridge Drive\n\nYou can upload the same data file into your HBase cluster and import the data from there.\n\n1. Switch to the **Contoso-HBase-EU** RDP window.\n2. From the desktop, click **Hadoop Command Line**.\n3. Change the folder to the HBase home directory:\n\n        cd %HBASE_HOME%\\bin\n\n4. upload the data:\n\n        hbase org.apache.hadoop.hbase.mapreduce.ImportTsv -Dimporttsv.columns=\"HBASE_ROW_KEY,Personal:Name, Personal:HomePhone, Office:Address\" -Dimporttsv.bulk.output=/tmpOutput Contacts wasb://hbasecontacts@hditutorialdata.blob.core.windows.net/contacts.txt\n\n        hbase org.apache.hadoop.hbase.mapreduce.LoadIncrementalHFiles /tmpOutput Contacts\n\n\n## Verify that data replication is taking place\n\nYou can verify that replication is taking place by scanning the tables from both clusters with the following HBase shell commands:\n\n        Scan 'Contacts'\n\n\n## Next Steps\n\nIn this tutorial, you have learned how to configure HBase replication across two datacenters. To learn more about HDInsight and HBase, see:\n\n- [HDInsight service page](http://azure.microsoft.com/services/hdinsight/)\n- [HDInsight documentation](http://azure.microsoft.com/documentation/services/hdinsight/)\n- [Get started with Apache HBase in HDInsight][hdinsight-hbase-get-started]\n- [HDInsight HBase overview][hdinsight-hbase-overview]\n- [Provision HBase clusters on Azure Virtual Network][hdinsight-hbase-provision-vnet]\n- [Analyze real-time Twitter sentiment with HBase][hdinsight-hbase-twitter-sentiment]\n- [Analyzing sensor data with Storm and HBase in HDInsight (Hadoop)][hdinsight-sensor-data]\n\n[hdinsight-hbase-geo-replication-vnet]: hdinsight-hbase-geo-replication-configure-VNets.md\n[hdinsight-hbase-geo-replication-dns]: ../hdinsight-hbase-geo-replication-configure-VNet.md\n\n\n[img-vnet-diagram]: ./media/hdinsight-hbase-geo-replication/HDInsight.HBase.Replication.Network.diagram.png\n\n[powershell-install]: ../install-configure-powershell.md\n[hdinsight-hbase-get-started]: ../hdinsight-hbase-get-started.md\n[hdinsight-manage-portal]: hdinsight-administer-use-management-portal.md\n[hdinsight-provision]: hdinsight-provision-clusters.md\n[hdinsight-hbase-replication-vnet]: hdinsight-hbase-geo-replication-configure-VNets.md\n[hdinsight-hbase-replication-dns]: hdinsight-hbase-geo-replication-configure-DNS.md\n[hdinsight-hbase-twitter-sentiment]: hdinsight-hbase-analyze-twitter-sentiment.md\n[hdinsight-sensor-data]: hdinsight-storm-sensor-data-analysis.md\n[hdinsight-hbase-overview]: hdinsight-hbase-overview.md\n[hdinsight-hbase-provision-vnet]: hdinsight-hbase-provision-vnet.md\n[hdinsight-hbase-get-started]: ../hdinsight-hbase-get-started.md \ntest\n"
}