{
  "nodes": [
    {
      "content": "Get started with Azure Cloud Services and ASP.NET | Microsoft Azure",
      "pos": [
        27,
        94
      ]
    },
    {
      "content": "Learn how to create a multi-tier app using ASP.NET MVC and Azure.",
      "pos": [
        113,
        178
      ]
    },
    {
      "content": "The app runs in a cloud service, with web role and worker role.",
      "pos": [
        179,
        242
      ]
    },
    {
      "content": "It uses Entity Framework, SQL Database, and Azure Storage queues and blobs.",
      "pos": [
        243,
        318
      ]
    },
    {
      "content": "Get started with Azure Cloud Services and ASP.NET",
      "pos": [
        651,
        700
      ]
    },
    {
      "content": "[AZURE.SELECTOR]",
      "pos": [
        704,
        720
      ]
    },
    {
      "content": "Node.js",
      "pos": [
        724,
        731
      ]
    },
    {
      "content": ".NET",
      "pos": [
        781,
        785
      ]
    },
    {
      "content": "Overview",
      "pos": [
        829,
        837
      ]
    },
    {
      "content": "This tutorial shows how to create a multi-tier .NET application with an ASP.NET MVC front-end, and deploy it to an <bpt id=\"p1\">[</bpt>Azure cloud service<ept id=\"p1\">](fundamentals-application-models.md#CloudServices)</ept>.",
      "pos": [
        839,
        1026
      ]
    },
    {
      "content": "The application uses <bpt id=\"p1\">[</bpt>Azure SQL Database<ept id=\"p1\">](http://msdn.microsoft.com/library/azure/ee336279)</ept>, the <bpt id=\"p2\">[</bpt>Azure Blob service<ept id=\"p2\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage)</ept>, and the <bpt id=\"p3\">[</bpt>Azure Queue service<ept id=\"p3\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern)</ept>.",
      "pos": [
        1027,
        1471
      ]
    },
    {
      "content": "You can <bpt id=\"p1\">[</bpt>download the Visual Studio project<ept id=\"p1\">](http://code.msdn.microsoft.com/Simple-Azure-Cloud-Service-e01df2e4)</ept> from the MSDN Code Gallery.",
      "pos": [
        1472,
        1612
      ]
    },
    {
      "content": "The tutorial shows you how to build and run the application locally, how to deploy it to Azure and run in the cloud, and finally how to build it from scratch.",
      "pos": [
        1614,
        1772
      ]
    },
    {
      "content": "You can start by building from scratch and then do the test and deploy steps afterward if you prefer.",
      "pos": [
        1773,
        1874
      ]
    },
    {
      "content": "Contoso Ads application",
      "pos": [
        1879,
        1902
      ]
    },
    {
      "content": "The application is an advertising bulletin board.",
      "pos": [
        1904,
        1953
      ]
    },
    {
      "content": "Users create an ad by entering text and uploading an image.",
      "pos": [
        1954,
        2013
      ]
    },
    {
      "content": "They can see a list of ads with thumbnail images, and they can see the full size image when they select an ad to see the details.",
      "pos": [
        2014,
        2143
      ]
    },
    {
      "content": "Ad list",
      "pos": [
        2147,
        2154
      ]
    },
    {
      "pos": [
        2209,
        2491
      ],
      "content": "The application uses the <bpt id=\"p1\">[</bpt>queue-centric work pattern<ept id=\"p1\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern)</ept> to off-load the CPU-intensive work of creating thumbnails to a back-end process."
    },
    {
      "content": "Alternative architecture: Websites and WebJobs",
      "pos": [
        2496,
        2542
      ]
    },
    {
      "content": "This tutorial shows how to run both front-end and back-end in an Azure cloud service.",
      "pos": [
        2544,
        2629
      ]
    },
    {
      "content": "An alternative is to run the front-end in an <bpt id=\"p1\">[</bpt>Azure website<ept id=\"p1\">](/services/web-sites/)</ept> and use the <bpt id=\"p2\">[</bpt>WebJobs<ept id=\"p2\">](http://go.microsoft.com/fwlink/?LinkId=390226)</ept> feature (currently in preview) for the back-end.",
      "pos": [
        2630,
        2830
      ]
    },
    {
      "content": "For a tutorial that uses WebJobs, see <bpt id=\"p1\">[</bpt>Get Started with the Azure WebJobs SDK<ept id=\"p1\">](../websites-dotnet-webjobs-sdk-get-started.md)</ept>.",
      "pos": [
        2831,
        2957
      ]
    },
    {
      "content": "For information about how to choose the services that best fit your scenario, see <bpt id=\"p1\">[</bpt>Azure Websites, Cloud Services, and virtual machines comparison<ept id=\"p1\">](../choose-web-site-cloud-service-vm.md)</ept>.",
      "pos": [
        2958,
        3146
      ]
    },
    {
      "content": "What you'll learn",
      "pos": [
        3151,
        3168
      ]
    },
    {
      "content": "How to enable your machine for Azure development by installing the Azure SDK.",
      "pos": [
        3172,
        3249
      ]
    },
    {
      "content": "How to create a Visual Studio cloud service project with an ASP.NET MVC web role and a worker role.",
      "pos": [
        3252,
        3351
      ]
    },
    {
      "content": "How to test the cloud service project locally, using the Azure storage emulator.",
      "pos": [
        3354,
        3434
      ]
    },
    {
      "content": "How to publish the cloud project to an Azure cloud service and test using an Azure storage account.",
      "pos": [
        3437,
        3536
      ]
    },
    {
      "content": "How to upload files and store them in the Azure Blob service.",
      "pos": [
        3539,
        3600
      ]
    },
    {
      "content": "How to use the Azure Queue service for communication between tiers.",
      "pos": [
        3603,
        3670
      ]
    },
    {
      "content": "Prerequisites",
      "pos": [
        3675,
        3688
      ]
    },
    {
      "content": "The tutorial assumes that you understand <bpt id=\"p1\">[</bpt>basic concepts about Azure cloud services<ept id=\"p1\">](fundamentals-application-models.md#CloudServices)</ept> such as <bpt id=\"p2\">*</bpt>web role<ept id=\"p2\">*</ept> and <bpt id=\"p3\">*</bpt>worker role<ept id=\"p3\">*</ept> terminology.",
      "pos": [
        3690,
        3874
      ]
    },
    {
      "content": "It also assumes that you know how to work with <bpt id=\"p1\">[</bpt>ASP.NET MVC<ept id=\"p1\">](http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started)</ept> or <bpt id=\"p2\">[</bpt>Web Forms<ept id=\"p2\">](http://www.asp.net/web-forms/tutorials/aspnet-45/getting-started-with-aspnet-45-web-forms/introduction-and-overview)</ept> projects in Visual Studio.",
      "pos": [
        3876,
        4164
      ]
    },
    {
      "content": "The sample application uses MVC, but most of the tutorial also applies to Web Forms.",
      "pos": [
        4165,
        4249
      ]
    },
    {
      "content": "You can run the app locally without an Azure subscription, but you'll need one in order to deploy the application to the cloud.",
      "pos": [
        4251,
        4378
      ]
    },
    {
      "content": "If you don't have an account, you can <bpt id=\"p1\">[</bpt>activate your MSDN subscriber benefits<ept id=\"p1\">](/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A55E3C668)</ept> or <bpt id=\"p2\">[</bpt>sign up for a free trial<ept id=\"p2\">](/pricing/free-trial/?WT.mc_id=A55E3C668)</ept>.",
      "pos": [
        4379,
        4595
      ]
    },
    {
      "content": "The tutorial instructions work with either of the following products:",
      "pos": [
        4597,
        4666
      ]
    },
    {
      "content": "Visual Studio 2013",
      "pos": [
        4670,
        4688
      ]
    },
    {
      "content": "Visual Studio 2013 Express for Web",
      "pos": [
        4691,
        4725
      ]
    },
    {
      "content": "If you don't have one of these, Visual Studio 2013 Express for Web will be installed automatically when you install the Azure SDK.",
      "pos": [
        4727,
        4857
      ]
    },
    {
      "content": "Application architecture",
      "pos": [
        4862,
        4886
      ]
    },
    {
      "content": "The app stores ads in a SQL database, using Entity Framework Code First to create the tables and access the data.",
      "pos": [
        4888,
        5001
      ]
    },
    {
      "content": "For each ad the database stores two URLs, one for the full-size image and one for the thumbnail.",
      "pos": [
        5002,
        5098
      ]
    },
    {
      "content": "Ad table",
      "pos": [
        5102,
        5110
      ]
    },
    {
      "content": "When a user uploads an image, the front-end running in a web role stores the image in an <bpt id=\"p1\">[</bpt>Azure blob<ept id=\"p1\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage)</ept>, and it stores the ad information in the database with a URL that points to the blob.",
      "pos": [
        5168,
        5502
      ]
    },
    {
      "content": "At the same time, it writes a message to an Azure queue.",
      "pos": [
        5503,
        5559
      ]
    },
    {
      "content": "A back-end process running in a worker role periodically polls the queue for new messages.",
      "pos": [
        5560,
        5650
      ]
    },
    {
      "content": "When a new message appears, the worker role creates a thumbnail for that image and updates the thumbnail URL database field for that ad.",
      "pos": [
        5651,
        5787
      ]
    },
    {
      "content": "The following diagram shows how the parts of the application interact.",
      "pos": [
        5788,
        5858
      ]
    },
    {
      "content": "Contoso Ads architecture",
      "pos": [
        5862,
        5886
      ]
    },
    {
      "content": "Download and run the completed solution",
      "pos": [
        6037,
        6076
      ]
    },
    {
      "pos": [
        6081,
        6193
      ],
      "content": "Download and unzip the <bpt id=\"p1\">[</bpt>completed solution<ept id=\"p1\">](http://code.msdn.microsoft.com/Simple-Azure-Cloud-Service-e01df2e4)</ept>."
    },
    {
      "content": "Start Visual Studio.",
      "pos": [
        6198,
        6218
      ]
    },
    {
      "pos": [
        6223,
        6350
      ],
      "content": "From the <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept> menu choose <bpt id=\"p2\">**</bpt>Open Project<ept id=\"p2\">**</ept>, navigate to where you downloaded the solution, and then open the solution file."
    },
    {
      "content": "Press CTRL+SHIFT+B to build the solution.",
      "pos": [
        6355,
        6396
      ]
    },
    {
      "content": "By default, Visual Studio automatically restores the NuGet package content, which was not included in the <bpt id=\"p1\">*</bpt>.zip<ept id=\"p1\">*</ept> file.",
      "pos": [
        6402,
        6520
      ]
    },
    {
      "content": "If the packages don't restore, install them manually by going to the <bpt id=\"p1\">**</bpt>Manage NuGet Packages for Solution<ept id=\"p1\">**</ept> dialog box and clicking the <bpt id=\"p2\">**</bpt>Restore<ept id=\"p2\">**</ept> button at the top right.",
      "pos": [
        6521,
        6693
      ]
    },
    {
      "pos": [
        6698,
        6801
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, make sure that <bpt id=\"p2\">**</bpt>ContosoAdsCloudService<ept id=\"p2\">**</ept> is selected as the startup project."
    },
    {
      "content": "Press CTRL+F5 to run the application.",
      "pos": [
        6806,
        6843
      ]
    },
    {
      "content": "When you run a cloud service project locally, Visual Studio automatically invokes the Azure <bpt id=\"p1\">*</bpt>compute emulator<ept id=\"p1\">*</ept> and Azure <bpt id=\"p2\">*</bpt>storage emulator<ept id=\"p2\">*</ept>.",
      "pos": [
        6849,
        6989
      ]
    },
    {
      "content": "The compute emulator uses your computer's resources to simulate the web role and worker role environments.",
      "pos": [
        6990,
        7096
      ]
    },
    {
      "content": "The storage emulator uses a <bpt id=\"p1\">[</bpt>SQL Server Express LocalDB<ept id=\"p1\">](http://msdn.microsoft.com/library/hh510202.aspx)</ept> database to simulate Azure cloud storage.",
      "pos": [
        7097,
        7244
      ]
    },
    {
      "content": "The first time you run a cloud service project, it takes a minute or so for the emulators to start up.",
      "pos": [
        7250,
        7352
      ]
    },
    {
      "content": "When emulator startup is finished, the default browser opens to the application home page.",
      "pos": [
        7353,
        7443
      ]
    },
    {
      "content": "Contoso Ads architecture",
      "pos": [
        7451,
        7475
      ]
    },
    {
      "pos": [
        7533,
        7557
      ],
      "content": "Click  <bpt id=\"p1\">**</bpt>Create an Ad<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        7562,
        7646
      ],
      "content": "Enter some test data and select a <bpt id=\"p1\">*</bpt>.jpg<ept id=\"p1\">*</ept> image to upload, and then click <bpt id=\"p2\">**</bpt>Create<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Create page",
      "pos": [
        7654,
        7665
      ]
    },
    {
      "content": "The app goes to the Index page, but it doesn't show a thumbnail for the new ad because that processing hasn't happened yet.",
      "pos": [
        7726,
        7849
      ]
    },
    {
      "content": "Wait a moment and then refresh the Index page to see the thumbnail.",
      "pos": [
        7854,
        7921
      ]
    },
    {
      "content": "Index page",
      "pos": [
        7929,
        7939
      ]
    },
    {
      "pos": [
        7997,
        8054
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Details<ept id=\"p1\">**</ept> for your ad to see the full-size image."
    },
    {
      "content": "Details page",
      "pos": [
        8062,
        8074
      ]
    },
    {
      "content": "You've been running the application entirely on your local computer, with no connection to the cloud.",
      "pos": [
        8132,
        8233
      ]
    },
    {
      "content": "The storage emulator stores the queue and blob data in a SQL Server Express LocalDB database, and the application stores the ad data in another LocalDB database.",
      "pos": [
        8234,
        8395
      ]
    },
    {
      "content": "Entity Framework Code First automatically created the ad database the first time the web app tried to access it.",
      "pos": [
        8396,
        8508
      ]
    },
    {
      "content": "In the following section you'll configure the solution to use Azure cloud resources for queues, blobs, and the application database when it runs in the cloud.",
      "pos": [
        8510,
        8668
      ]
    },
    {
      "content": "If you wanted to continue to run locally but use cloud storage and database resources, you could do that; it's just a matter of setting connection strings, which you'll see how to do.",
      "pos": [
        8669,
        8852
      ]
    },
    {
      "content": "Deploy the application to Azure",
      "pos": [
        8857,
        8888
      ]
    },
    {
      "content": "You'll do the following steps to run the application in the cloud:",
      "pos": [
        8890,
        8956
      ]
    },
    {
      "content": "Create an Azure cloud service.",
      "pos": [
        8960,
        8990
      ]
    },
    {
      "content": "Create an Azure SQL database.",
      "pos": [
        8993,
        9022
      ]
    },
    {
      "content": "Create an Azure storage account.",
      "pos": [
        9025,
        9057
      ]
    },
    {
      "content": "Configure the solution to use your Azure SQL database when it runs in Azure.",
      "pos": [
        9060,
        9136
      ]
    },
    {
      "content": "Configure the solution to use your Azure storage account when it runs in Azure.",
      "pos": [
        9139,
        9218
      ]
    },
    {
      "content": "Deploy the project to your Azure cloud service.",
      "pos": [
        9221,
        9268
      ]
    },
    {
      "content": "Create an Azure cloud service",
      "pos": [
        9274,
        9303
      ]
    },
    {
      "content": "An Azure cloud service is the environment the application will run in.",
      "pos": [
        9305,
        9375
      ]
    },
    {
      "pos": [
        9380,
        9453
      ],
      "content": "In your browser, open the <bpt id=\"p1\">[</bpt>Azure portal<ept id=\"p1\">](http://manage.windowsazure.com)</ept>."
    },
    {
      "pos": [
        9458,
        9513
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>New &gt; Compute &gt; Cloud Service &gt; Quick Create<ept id=\"p1\">**</ept>."
    },
    {
      "content": "In the URL input box, enter a URL prefix.",
      "pos": [
        9518,
        9559
      ]
    },
    {
      "content": "This URL has to be unique.",
      "pos": [
        9565,
        9591
      ]
    },
    {
      "content": "You'll get an error message if the prefix you choose is already in use by someone else.",
      "pos": [
        9593,
        9680
      ]
    },
    {
      "content": "Choose the region where you want to deploy the application.",
      "pos": [
        9685,
        9744
      ]
    },
    {
      "content": "This field specifies which datacenter your cloud service will be hosted in.",
      "pos": [
        9750,
        9825
      ]
    },
    {
      "content": "For a production application, you'd choose the region closest to your customers.",
      "pos": [
        9826,
        9906
      ]
    },
    {
      "content": "For this tutorial, choose the region closest to you.",
      "pos": [
        9907,
        9959
      ]
    },
    {
      "pos": [
        9964,
        9995
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Create Cloud Service<ept id=\"p1\">**</ept>."
    },
    {
      "content": "In the following image, a cloud service is created with the URL contosoads.cloudapp.net.",
      "pos": [
        10001,
        10089
      ]
    },
    {
      "content": "New Cloud Service",
      "pos": [
        10097,
        10114
      ]
    },
    {
      "content": "Create an Azure SQL database",
      "pos": [
        10174,
        10202
      ]
    },
    {
      "content": "When the app runs in the cloud, it will use a cloud-based database.",
      "pos": [
        10204,
        10271
      ]
    },
    {
      "pos": [
        10276,
        10391
      ],
      "content": "In the <bpt id=\"p1\">[</bpt>Azure portal<ept id=\"p1\">](http://manage.windowsazure.com)</ept>, click <bpt id=\"p2\">**</bpt>New &gt; Data Services &gt; SQL Database &gt; Quick Create<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        10396,
        10445
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Database Name<ept id=\"p1\">**</ept> box, enter <bpt id=\"p2\">*</bpt>contosoads<ept id=\"p2\">*</ept>."
    },
    {
      "pos": [
        10450,
        10521
      ],
      "content": "From the <bpt id=\"p1\">**</bpt>Server<ept id=\"p1\">**</ept> drop-down list, choose <bpt id=\"p2\">**</bpt>New SQL Database server<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Alternatively, if your subscription already has a server, you can select that server from the drop-down list.",
      "pos": [
        10527,
        10636
      ]
    },
    {
      "pos": [
        10641,
        10705
      ],
      "content": "Choose the same <bpt id=\"p1\">**</bpt>Region<ept id=\"p1\">**</ept> that you chose for the cloud service."
    },
    {
      "content": "When the cloud service and database are in different datacenters (different regions), latency will increase and you will be charged for bandwidth outside the data center.",
      "pos": [
        10711,
        10881
      ]
    },
    {
      "content": "Bandwidth within a data center is free.",
      "pos": [
        10882,
        10921
      ]
    },
    {
      "pos": [
        10926,
        10981
      ],
      "content": "Enter an administrator <bpt id=\"p1\">**</bpt>Login Name<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Password<ept id=\"p2\">**</ept>."
    },
    {
      "content": "If you selected <bpt id=\"p1\">**</bpt>New SQL Database server<ept id=\"p1\">**</ept> you aren't entering an existing name and password here, you're entering a new name and password that you're defining now to use later when you access the database.",
      "pos": [
        10987,
        11194
      ]
    },
    {
      "content": "If you selected a server that you created previously, you'll be prompted for the password to the administrative user account you already created.",
      "pos": [
        11195,
        11340
      ]
    },
    {
      "pos": [
        11345,
        11375
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Create SQL Database<ept id=\"p1\">**</ept>."
    },
    {
      "content": "New SQL Database",
      "pos": [
        11383,
        11399
      ]
    },
    {
      "pos": [
        11458,
        11610
      ],
      "content": "After Azure finishes creating the database, click the <bpt id=\"p1\">**</bpt>SQL Databases<ept id=\"p1\">**</ept> tab in the left pane of the portal, and then click the name of the new database."
    },
    {
      "pos": [
        11615,
        11643
      ],
      "content": "Click the <bpt id=\"p1\">**</bpt>Dashboard<ept id=\"p1\">**</ept> tab."
    },
    {
      "pos": [
        11648,
        11686
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Manage allowed IP addresses<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        11691,
        11756
      ],
      "content": "Under <bpt id=\"p1\">**</bpt>Allowed Services<ept id=\"p1\">**</ept>, change <bpt id=\"p2\">**</bpt>Azure Services<ept id=\"p2\">**</ept> to <bpt id=\"p3\">**</bpt>Yes<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        11761,
        11776
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Save<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Create an Azure storage account",
      "pos": [
        11782,
        11813
      ]
    },
    {
      "content": "An Azure storage account provides resources for storing queue and blob data in the cloud.",
      "pos": [
        11815,
        11904
      ]
    },
    {
      "content": "In a real-world application, you would typically create separate accounts for application data versus logging data, and separate accounts for test data versus production data.",
      "pos": [
        11906,
        12081
      ]
    },
    {
      "content": "For this tutorial you'll use just one account.",
      "pos": [
        12082,
        12128
      ]
    },
    {
      "pos": [
        12133,
        12243
      ],
      "content": "In the <bpt id=\"p1\">[</bpt>Azure portal<ept id=\"p1\">](http://manage.windowsazure.com)</ept>, click <bpt id=\"p2\">**</bpt>New &gt; Data Services &gt; Storage &gt; Quick Create<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        12248,
        12287
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>URL<ept id=\"p1\">**</ept> box, enter a URL prefix."
    },
    {
      "content": "This prefix plus the text you see under the box will be the unique URL to your storage account.",
      "pos": [
        12293,
        12388
      ]
    },
    {
      "content": "If the prefix you enter has already been used by someone else, you'll have to choose a different prefix.",
      "pos": [
        12389,
        12493
      ]
    },
    {
      "pos": [
        12498,
        12583
      ],
      "content": "Set the <bpt id=\"p1\">**</bpt>Region<ept id=\"p1\">**</ept> drop-down list to the same region you chose for the cloud service."
    },
    {
      "content": "When the cloud service and storage account are in different datacenters (different regions), latency will increase and you will be charged for bandwidth outside the data center.",
      "pos": [
        12589,
        12766
      ]
    },
    {
      "content": "Bandwidth within a data center is free.",
      "pos": [
        12767,
        12806
      ]
    },
    {
      "content": "Azure affinity groups provide a mechanism to minimize the distance between resources in a data center, which can reduce latency.",
      "pos": [
        12812,
        12940
      ]
    },
    {
      "content": "This tutorial does not use affinity groups.",
      "pos": [
        12941,
        12984
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>How to Create an Affinity Group in Azure<ept id=\"p1\">](http://msdn.microsoft.com/library/jj156209.aspx)</ept>.",
      "pos": [
        12985,
        13103
      ]
    },
    {
      "pos": [
        13108,
        13172
      ],
      "content": "Set the <bpt id=\"p1\">**</bpt>Replication<ept id=\"p1\">**</ept> drop-down list to <bpt id=\"p2\">**</bpt>Locally redundant<ept id=\"p2\">**</ept>."
    },
    {
      "content": "When geo-replication is enabled for a storage account, the stored content is replicated to a secondary datacenter to enable failover to that location in case of a major disaster in the primary location.",
      "pos": [
        13178,
        13380
      ]
    },
    {
      "content": "Geo-replication can incur additional costs.",
      "pos": [
        13381,
        13424
      ]
    },
    {
      "content": "For test and development accounts, you generally don't want to pay for geo-replication.",
      "pos": [
        13425,
        13512
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Create, manage, or delete a storage account<ept id=\"p1\">](../storage-create-storage-account/#replication-options)</ept>.",
      "pos": [
        13513,
        13641
      ]
    },
    {
      "pos": [
        13646,
        13679
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Create Storage Account<ept id=\"p1\">**</ept>."
    },
    {
      "content": "New storage account",
      "pos": [
        13687,
        13706
      ]
    },
    {
      "pos": [
        13771,
        13857
      ],
      "content": "In the image, a storage account is created with the URL <ph id=\"ph1\">`contosoads.core.windows.net`</ph>."
    },
    {
      "content": "Configure the solution to use your Azure SQL database when it runs in Azure",
      "pos": [
        13863,
        13938
      ]
    },
    {
      "content": "The web project and the worker role project each has its own database connection string, and each needs to point to the Azure SQL database when the app runs in Azure.",
      "pos": [
        13940,
        14106
      ]
    },
    {
      "pos": [
        14108,
        14322
      ],
      "content": "You'll use a <bpt id=\"p1\">[</bpt>Web.config transform<ept id=\"p1\">](http://www.asp.net/mvc/tutorials/deployment/visual-studio-web-deployment/web-config-transformations)</ept> for the web role and a cloud service environment setting for the worker role."
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> In this section and the next section you store credentials in project files.",
      "pos": [
        14325,
        14414
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>Don't store sensitive data in public source code repositories<ept id=\"p1\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control#secrets)</ept>.",
      "pos": [
        14415,
        14623
      ]
    },
    {
      "pos": [
        14628,
        14856
      ],
      "content": "In the ContosoAdsWeb project, open the <bpt id=\"p1\">*</bpt>Web.Release.config<ept id=\"p1\">*</ept> transform file for the application <bpt id=\"p2\">*</bpt>Web.config<ept id=\"p2\">*</ept> file, delete the comment block that contains a <ph id=\"ph1\">`&lt;connectionStrings&gt;`</ph> element, and paste the following code in its place."
    },
    {
      "content": "Leave the file open for editing.",
      "pos": [
        15107,
        15139
      ]
    },
    {
      "pos": [
        15144,
        15363
      ],
      "content": "In the <bpt id=\"p1\">[</bpt>Azure portal<ept id=\"p1\">](http://manage.windowsazure.com)</ept>, click <bpt id=\"p2\">**</bpt>SQL Databases<ept id=\"p2\">**</ept> in the left pane, click the database you created for this tutorial, click the <bpt id=\"p3\">**</bpt>Dashboard<ept id=\"p3\">**</ept> tab, and then click <bpt id=\"p4\">**</bpt>Show connection strings<ept id=\"p4\">**</ept>."
    },
    {
      "content": "Show connection strings",
      "pos": [
        15371,
        15394
      ]
    },
    {
      "content": "The portal displays connection strings, with a placeholder for the password.",
      "pos": [
        15455,
        15531
      ]
    },
    {
      "content": "Connection strings",
      "pos": [
        15539,
        15557
      ]
    },
    {
      "pos": [
        15622,
        15769
      ],
      "content": "In the <bpt id=\"p1\">*</bpt>Web.Release.config<ept id=\"p1\">*</ept> transform file, delete <ph id=\"ph1\">`{connectionstring}`</ph> and paste in its place the ADO.NET connection string from the Azure portal."
    },
    {
      "pos": [
        15774,
        15947
      ],
      "content": "In the connection string that you pasted into the <bpt id=\"p1\">*</bpt>Web.Release.config<ept id=\"p1\">*</ept> transform file, replace <ph id=\"ph1\">`{your_password_here}`</ph> with the password you created for the new SQL database."
    },
    {
      "content": "Save the file.",
      "pos": [
        15952,
        15966
      ]
    },
    {
      "content": "Select and copy the connection string (without the surrounding quotation marks) for use in the following steps for configuring the worker role project.",
      "pos": [
        15973,
        16124
      ]
    },
    {
      "pos": [
        16129,
        16264
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, under <bpt id=\"p2\">**</bpt>Roles<ept id=\"p2\">**</ept> in the cloud service project, right-click <bpt id=\"p3\">**</bpt>ContosoAdsWorker<ept id=\"p3\">**</ept> and then click <bpt id=\"p4\">**</bpt>Properties<ept id=\"p4\">**</ept>."
    },
    {
      "content": "Role properties",
      "pos": [
        16272,
        16287
      ]
    },
    {
      "pos": [
        16361,
        16388
      ],
      "content": "Click the <bpt id=\"p1\">**</bpt>Settings<ept id=\"p1\">**</ept> tab."
    },
    {
      "pos": [
        16393,
        16439
      ],
      "content": "Change <bpt id=\"p1\">**</bpt>Service Configuration<ept id=\"p1\">**</ept> to <bpt id=\"p2\">**</bpt>Cloud<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        16444,
        16602
      ],
      "content": "Select the text in the <ph id=\"ph1\">`ContosoAdsDbConnectionString`</ph> setting, and then paste the connection string that you copied from the previous section of the tutorial."
    },
    {
      "content": "Database connection string for worker role",
      "pos": [
        16610,
        16652
      ]
    },
    {
      "content": "Save your changes.",
      "pos": [
        16716,
        16734
      ]
    },
    {
      "content": "Configure the solution to use your Azure storage account when it runs in Azure",
      "pos": [
        16742,
        16820
      ]
    },
    {
      "content": "Azure storage account connection strings for both the web role project and the worker role project are stored in environment settings in the cloud service project.",
      "pos": [
        16822,
        16985
      ]
    },
    {
      "content": "For each project there is a separate set of settings to be used when the application runs locally and when it runs in the cloud.",
      "pos": [
        16986,
        17114
      ]
    },
    {
      "content": "You'll update the cloud environment settings for both web and worker role projects.",
      "pos": [
        17115,
        17198
      ]
    },
    {
      "pos": [
        17203,
        17348
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, right-click <bpt id=\"p2\">**</bpt>ContosoAdsWeb<ept id=\"p2\">**</ept> under <bpt id=\"p3\">**</bpt>Roles<ept id=\"p3\">**</ept> in the <bpt id=\"p4\">**</bpt>ContosoAdsCloudService<ept id=\"p4\">**</ept> project, and then click <bpt id=\"p5\">**</bpt>Properties<ept id=\"p5\">**</ept>."
    },
    {
      "content": "Role properties",
      "pos": [
        17356,
        17371
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>Settings<ept id=\"p1\">**</ept> tab.",
      "pos": [
        17439,
        17466
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Service Configuration<ept id=\"p1\">**</ept> drop-down box, choose <bpt id=\"p2\">**</bpt>Cloud<ept id=\"p2\">**</ept>.",
      "pos": [
        17467,
        17532
      ]
    },
    {
      "content": "Cloud configuration",
      "pos": [
        17540,
        17559
      ]
    },
    {
      "content": "Select the <bpt id=\"p1\">**</bpt>StorageConnectionString<ept id=\"p1\">**</ept> entry, and you'll see an ellipsis (<bpt id=\"p2\">**</bpt>...<ept id=\"p2\">**</ept>) button at the right end of the line.",
      "pos": [
        17620,
        17739
      ]
    },
    {
      "content": "Click the ellipsis button to open the <bpt id=\"p1\">**</bpt>Create Storage Account Connection String<ept id=\"p1\">**</ept> dialog box.",
      "pos": [
        17740,
        17834
      ]
    },
    {
      "content": "Open Connection String Create box",
      "pos": [
        17842,
        17875
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Create Storage Connection String<ept id=\"p1\">**</ept> dialog box, click <bpt id=\"p2\">**</bpt>Your subscription<ept id=\"p2\">**</ept>, choose the storage account that you created earlier, and then click <bpt id=\"p3\">**</bpt>OK<ept id=\"p3\">**</ept>.",
      "pos": [
        17941,
        18101
      ]
    },
    {
      "content": "If you're not already logged in, you'll be prompted for your Azure account credentials.",
      "pos": [
        18102,
        18189
      ]
    },
    {
      "content": "Create Storage Connection String",
      "pos": [
        18197,
        18229
      ]
    },
    {
      "content": "Save your changes.",
      "pos": [
        18298,
        18316
      ]
    },
    {
      "pos": [
        18321,
        18504
      ],
      "content": "Follow the same procedure that you used for the <ph id=\"ph1\">`StorageConnectionString`</ph> connection string to set the <ph id=\"ph2\">`Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString`</ph> connection string."
    },
    {
      "content": "This connection string is used for logging.",
      "pos": [
        18510,
        18553
      ]
    },
    {
      "content": "Follow the same procedure that you used for the <bpt id=\"p1\">**</bpt>ContosoAdsWeb<ept id=\"p1\">**</ept> role to set both connection strings for the <bpt id=\"p2\">**</bpt>ContosoAdsWorker<ept id=\"p2\">**</ept> role.",
      "pos": [
        18558,
        18694
      ]
    },
    {
      "content": "Don't forget to set <bpt id=\"p1\">**</bpt>Service Configuration<ept id=\"p1\">**</ept> to <bpt id=\"p2\">**</bpt>Cloud<ept id=\"p2\">**</ept>.",
      "pos": [
        18695,
        18754
      ]
    },
    {
      "content": "The role environment settings that you have configured using the Visual Studio UI are stored in the following files in the ContosoAdsCloudService project:",
      "pos": [
        18756,
        18910
      ]
    },
    {
      "pos": [
        18914,
        18968
      ],
      "content": "<bpt id=\"p1\">*</bpt>ServiceDefinition.csdef<ept id=\"p1\">*</ept> - Defines the setting names."
    },
    {
      "pos": [
        18971,
        19059
      ],
      "content": "<bpt id=\"p1\">*</bpt>ServiceConfiguration.Cloud.cscfg<ept id=\"p1\">*</ept> - Provides values for when the app runs in the cloud."
    },
    {
      "pos": [
        19062,
        19145
      ],
      "content": "<bpt id=\"p1\">*</bpt>ServiceConfiguration.Local.cscfg<ept id=\"p1\">*</ept> - Provides values for when the app runs locally."
    },
    {
      "content": "For example, the ServiceDefinition.csdef includes the following definitions.",
      "pos": [
        19147,
        19223
      ]
    },
    {
      "pos": [
        19402,
        19518
      ],
      "content": "And the <bpt id=\"p1\">*</bpt>ServiceConfiguration.Cloud.cscfg<ept id=\"p1\">*</ept> file includes the values you entered for those settings in Visual Studio."
    },
    {
      "content": "The <ph id=\"ph1\">`&lt;Instances&gt;`</ph> setting specifies the number of virtual machines that Azure will run the worker role code on.",
      "pos": [
        19946,
        20057
      ]
    },
    {
      "content": "The <bpt id=\"p1\">[</bpt>Next steps<ept id=\"p1\">](#next-steps)</ept> section includes links to more information about scaling out a cloud service,",
      "pos": [
        20058,
        20165
      ]
    },
    {
      "content": "Deploy the project to Azure",
      "pos": [
        20172,
        20199
      ]
    },
    {
      "pos": [
        20205,
        20316
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, right-click the <bpt id=\"p2\">**</bpt>ContosoAdsCloudService<ept id=\"p2\">**</ept> cloud project and then select <bpt id=\"p3\">**</bpt>Publish<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Publish menu",
      "pos": [
        20324,
        20336
      ]
    },
    {
      "pos": [
        20397,
        20481
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Sign in<ept id=\"p1\">**</ept> step of the <bpt id=\"p2\">**</bpt>Publish Azure Application<ept id=\"p2\">**</ept> wizard, click <bpt id=\"p3\">**</bpt>Next<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Sign in step",
      "pos": [
        20489,
        20501
      ]
    },
    {
      "pos": [
        20564,
        20619
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Settings<ept id=\"p1\">**</ept> step of the wizard, click <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Settings step",
      "pos": [
        20627,
        20640
      ]
    },
    {
      "content": "The default settings in the <bpt id=\"p1\">**</bpt>Advanced<ept id=\"p1\">**</ept> tab are fine for this tutorial.",
      "pos": [
        20706,
        20778
      ]
    },
    {
      "content": "For information about the advanced tab, see <bpt id=\"p1\">[</bpt>Publish Azure Application Wizard<ept id=\"p1\">](http://msdn.microsoft.com/library/hh535756.aspx)</ept>.",
      "pos": [
        20779,
        20907
      ]
    },
    {
      "pos": [
        20912,
        20955
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Summary<ept id=\"p1\">**</ept> step, click <bpt id=\"p2\">**</bpt>Publish<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Summary step",
      "pos": [
        20963,
        20975
      ]
    },
    {
      "pos": [
        21039,
        21096
      ],
      "content": "The <bpt id=\"p1\">**</bpt>Azure Activity Log<ept id=\"p1\">**</ept> window opens in Visual Studio."
    },
    {
      "content": "Click the right arrow icon to expand the deployment details.",
      "pos": [
        21101,
        21161
      ]
    },
    {
      "content": "The deployment can take up to 5 minutes or more to complete.",
      "pos": [
        21167,
        21227
      ]
    },
    {
      "content": "Azure Activity Log window",
      "pos": [
        21235,
        21260
      ]
    },
    {
      "pos": [
        21318,
        21409
      ],
      "content": "When the deployment status is complete, click the <bpt id=\"p1\">**</bpt>Website URL<ept id=\"p1\">**</ept> to start the application."
    },
    {
      "content": "You can now test the app by creating, viewing, and editing some ads, as you did when you ran the application locally.",
      "pos": [
        21414,
        21531
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> When you're finished testing, delete or stop the cloud service.",
      "pos": [
        21534,
        21610
      ]
    },
    {
      "content": "Even if you're not using the cloud service, it's accruing charges because virtual machine resources are reserved for it.",
      "pos": [
        21611,
        21731
      ]
    },
    {
      "content": "And if you leave it running, anyone who finds your URL can create and view ads.",
      "pos": [
        21732,
        21811
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">[</bpt>Azure portal<ept id=\"p1\">](http://manage.windowsazure.com)</ept>, go to the <bpt id=\"p2\">**</bpt>Dashboard<ept id=\"p2\">**</ept> tab for your cloud service, and then click the <bpt id=\"p3\">**</bpt>Delete<ept id=\"p3\">**</ept> button at the bottom of the page.",
      "pos": [
        21812,
        21982
      ]
    },
    {
      "content": "If you just want to temporarily prevent others from accessing the site, click <bpt id=\"p1\">**</bpt>Stop<ept id=\"p1\">**</ept> instead.",
      "pos": [
        21983,
        22078
      ]
    },
    {
      "content": "In that case, charges will continue to accrue.",
      "pos": [
        22079,
        22125
      ]
    },
    {
      "content": "You can follow a similar procedure to delete the SQL database and storage account when you no longer need them.",
      "pos": [
        22126,
        22237
      ]
    },
    {
      "content": "Create the application from scratch",
      "pos": [
        22242,
        22277
      ]
    },
    {
      "content": "If you haven't already downloaded",
      "pos": [
        22279,
        22312
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>the completed application<ept id=\"p1\">](http://code.msdn.microsoft.com/Simple-Azure-Cloud-Service-e01df2e4)</ept>, do that now.",
      "pos": [
        22313,
        22422
      ]
    },
    {
      "content": "You'll copy files from the downloaded project into the new project.",
      "pos": [
        22423,
        22490
      ]
    },
    {
      "content": "Creating the Contoso Ads application involves the following steps:",
      "pos": [
        22492,
        22558
      ]
    },
    {
      "content": "Create a cloud service Visual Studio solution.",
      "pos": [
        22562,
        22608
      ]
    },
    {
      "content": "Update and add NuGet packages.",
      "pos": [
        22611,
        22641
      ]
    },
    {
      "content": "Set project references.",
      "pos": [
        22644,
        22667
      ]
    },
    {
      "content": "Configure connection strings.",
      "pos": [
        22670,
        22699
      ]
    },
    {
      "content": "Add code files.",
      "pos": [
        22702,
        22717
      ]
    },
    {
      "content": "After the solution is created, you'll review the code that is unique to cloud service projects and Azure blobs and queues.",
      "pos": [
        22719,
        22841
      ]
    },
    {
      "content": "Create a cloud service Visual Studio solution",
      "pos": [
        22847,
        22892
      ]
    },
    {
      "pos": [
        22897,
        22961
      ],
      "content": "In Visual Studio, choose <bpt id=\"p1\">**</bpt>New Project<ept id=\"p1\">**</ept> from the <bpt id=\"p2\">**</bpt>File<ept id=\"p2\">**</ept> menu."
    },
    {
      "pos": [
        22966,
        23124
      ],
      "content": "In the left pane of the <bpt id=\"p1\">**</bpt>New Project<ept id=\"p1\">**</ept> dialog box, expand <bpt id=\"p2\">**</bpt>Visual C#<ept id=\"p2\">**</ept> and choose <bpt id=\"p3\">**</bpt>Cloud<ept id=\"p3\">**</ept> templates, and then choose the <bpt id=\"p4\">**</bpt>Azure Cloud Service<ept id=\"p4\">**</ept> template."
    },
    {
      "pos": [
        23129,
        23205
      ],
      "content": "Name the project and solution ContosoAdsCloudService, and then click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>."
    },
    {
      "content": "New Project",
      "pos": [
        23213,
        23224
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>New Azure Cloud Service<ept id=\"p1\">**</ept> dialog box, add a web role and a worker role.",
      "pos": [
        23288,
        23368
      ]
    },
    {
      "content": "Name the web role ContosoAdsWeb, and name the worker role ContosoAdsWorker.",
      "pos": [
        23369,
        23444
      ]
    },
    {
      "content": "(Use the pencil icon in the right-hand pane to change the default names of the roles.)",
      "pos": [
        23445,
        23531
      ]
    },
    {
      "content": "New Cloud Service Project",
      "pos": [
        23539,
        23564
      ]
    },
    {
      "pos": [
        23627,
        23763
      ],
      "content": "When you see the <bpt id=\"p1\">**</bpt>New ASP.NET Project<ept id=\"p1\">**</ept> dialog box for the web role, choose the MVC template, and then click <bpt id=\"p2\">**</bpt>Change Authentication<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Change Authentication",
      "pos": [
        23771,
        23792
      ]
    },
    {
      "pos": [
        23853,
        23950
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Change Authentication<ept id=\"p1\">**</ept> dialog box, choose <bpt id=\"p2\">**</bpt>No Authentication<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>OK<ept id=\"p3\">**</ept>."
    },
    {
      "content": "No Authentication",
      "pos": [
        23958,
        23975
      ]
    },
    {
      "pos": [
        24035,
        24087
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>New ASP.NET Project<ept id=\"p1\">**</ept> dialog, click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        24092,
        24203
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, right-click the solution (not one of the projects), and choose <bpt id=\"p2\">**</bpt>Add - New Project<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        24209,
        24359
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Add New Project<ept id=\"p1\">**</ept> dialog box, choose <bpt id=\"p2\">**</bpt>Windows Desktop<ept id=\"p2\">**</ept> under <bpt id=\"p3\">**</bpt>Visual C#<ept id=\"p3\">**</ept> in the left pane, and then click the <bpt id=\"p4\">**</bpt>Class Library<ept id=\"p4\">**</ept> template."
    },
    {
      "pos": [
        24367,
        24426
      ],
      "content": "Name the project <bpt id=\"p1\">*</bpt>ContosoAdsCommon<ept id=\"p1\">*</ept>, and then click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>."
    },
    {
      "content": "You need to reference the Entity Framework context and the data model from both web and worker role projects.",
      "pos": [
        24432,
        24541
      ]
    },
    {
      "content": "As an alternative you could define the EF-related classes in the web role project and reference that project from the worker role project.",
      "pos": [
        24542,
        24680
      ]
    },
    {
      "content": "But in the alternative approach, your worker role project would have a reference to web assemblies which it doesn't need.",
      "pos": [
        24681,
        24802
      ]
    },
    {
      "content": "Update and add NuGet packages",
      "pos": [
        24808,
        24837
      ]
    },
    {
      "pos": [
        24843,
        24906
      ],
      "content": "Open the <bpt id=\"p1\">**</bpt>Manage NuGet Packages<ept id=\"p1\">**</ept> dialog box for the solution."
    },
    {
      "pos": [
        24912,
        24949
      ],
      "content": "In the left pane, select <bpt id=\"p1\">**</bpt>Updates<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        24955,
        25098
      ],
      "content": "Look for the <bpt id=\"p1\">*</bpt>WindowsAzure.Storage<ept id=\"p1\">*</ept> package, and if it's in the list, click <bpt id=\"p2\">**</bpt>Update<ept id=\"p2\">**</ept> to get the latest version of the storage client library."
    },
    {
      "content": "Update SCL",
      "pos": [
        25106,
        25116
      ]
    },
    {
      "content": "The storage client library is updated more frequently than Visual Studio project templates, so you'll often find that the version in a newly created projected needs to be updated.",
      "pos": [
        25177,
        25356
      ]
    },
    {
      "pos": [
        25362,
        25398
      ],
      "content": "In the left pane, select <bpt id=\"p1\">**</bpt>Online<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        25404,
        25483
      ],
      "content": "Find the <bpt id=\"p1\">*</bpt>EntityFramework<ept id=\"p1\">*</ept> NuGet package, and install it in all three projects."
    },
    {
      "pos": [
        25489,
        25601
      ],
      "content": "Find the <bpt id=\"p1\">*</bpt>Microsoft.WindowsAzure.ConfigurationManager<ept id=\"p1\">*</ept> NuGet package, and install it in the worker role project."
    },
    {
      "content": "Set project references",
      "pos": [
        25607,
        25629
      ]
    },
    {
      "content": "In the ContosoAdsWeb project, set a reference to the ContosoAdsCommon project.",
      "pos": [
        25635,
        25713
      ]
    },
    {
      "content": "Right-click the ContosoAdsWeb project, and then click <bpt id=\"p1\">**</bpt>References<ept id=\"p1\">**</ept> - <bpt id=\"p2\">**</bpt>Add References<ept id=\"p2\">**</ept>.",
      "pos": [
        25714,
        25804
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Reference Manager<ept id=\"p1\">**</ept> dialog box, select <bpt id=\"p2\">**</bpt>Solution – Projects<ept id=\"p2\">**</ept> in the left pane, select <bpt id=\"p3\">**</bpt>ContosoAdsCommon<ept id=\"p3\">**</ept>, and then click <bpt id=\"p4\">**</bpt>OK<ept id=\"p4\">**</ept>.",
      "pos": [
        25805,
        25946
      ]
    },
    {
      "content": "In the ContosoAdsWorker project, set a reference to the ContosAdsCommon project.",
      "pos": [
        25952,
        26032
      ]
    },
    {
      "content": "ContosoAdsCommon will contain the Entity Framework data model and context class, which will be used by both the front-end and back-end.",
      "pos": [
        26038,
        26173
      ]
    },
    {
      "pos": [
        26179,
        26248
      ],
      "content": "In the ContosoAdsWorker project, set a reference to <ph id=\"ph1\">`System.Drawing`</ph>."
    },
    {
      "content": "This assembly is used by the back-end to convert images to thumbnails.",
      "pos": [
        26254,
        26324
      ]
    },
    {
      "content": "Configure connection strings",
      "pos": [
        26330,
        26358
      ]
    },
    {
      "content": "In this section you configure Azure Storage and SQL connection strings for testing locally.",
      "pos": [
        26360,
        26451
      ]
    },
    {
      "content": "The deployment instructions earlier in the tutorial explain how to set up the connection strings for when the app runs in the cloud.",
      "pos": [
        26452,
        26584
      ]
    },
    {
      "pos": [
        26589,
        26745
      ],
      "content": "In the ContosoAdsWeb project, open the application Web.config file, and insert the following <ph id=\"ph1\">`connectionStrings`</ph> element after the <ph id=\"ph2\">`configSections`</ph> element."
    },
    {
      "content": "Save your changes.",
      "pos": [
        27021,
        27039
      ]
    },
    {
      "pos": [
        27044,
        27156
      ],
      "content": "In the ContosoAdsCloudService project, right-click ContosoAdsWeb under <bpt id=\"p1\">**</bpt>Roles<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Properties<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Role properties",
      "pos": [
        27164,
        27179
      ]
    },
    {
      "pos": [
        27247,
        27356
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>ContosAdsWeb [Role]<ept id=\"p1\">**</ept> properties window, click the <bpt id=\"p2\">**</bpt>Settings<ept id=\"p2\">**</ept> tab, and then click <bpt id=\"p3\">**</bpt>Add Setting<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        27362,
        27424
      ],
      "content": "Leave <bpt id=\"p1\">**</bpt>Service Configuration<ept id=\"p1\">**</ept> set to <bpt id=\"p2\">**</bpt>All Configurations<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Add a new setting named <bpt id=\"p1\">*</bpt>StorageConnectionString<ept id=\"p1\">*</ept>.",
      "pos": [
        27429,
        27479
      ]
    },
    {
      "content": "Set <bpt id=\"p1\">**</bpt>Type<ept id=\"p1\">**</ept> to <bpt id=\"p2\">*</bpt>ConnectionString<ept id=\"p2\">*</ept>, and set <bpt id=\"p3\">**</bpt>Value<ept id=\"p3\">**</ept> to <bpt id=\"p4\">*</bpt>UseDevelopmentStorage=true<ept id=\"p4\">*</ept>.",
      "pos": [
        27480,
        27566
      ]
    },
    {
      "content": "New connection string",
      "pos": [
        27574,
        27595
      ]
    },
    {
      "content": "Save your changes.",
      "pos": [
        27654,
        27672
      ]
    },
    {
      "content": "Follow the same procedure to add a storage connection string in the ContosoAdsWorker role properties.",
      "pos": [
        27677,
        27778
      ]
    },
    {
      "pos": [
        27783,
        27873
      ],
      "content": "Still in the <bpt id=\"p1\">**</bpt>ContosoAdsWorker [Role]<ept id=\"p1\">**</ept> properties window, add another connection string:"
    },
    {
      "content": "Name: ContosoAdsDbConnectionString",
      "pos": [
        27881,
        27915
      ]
    },
    {
      "content": "Type: String",
      "pos": [
        27922,
        27934
      ]
    },
    {
      "content": "Value: Paste the same connection string you used for the web role project:",
      "pos": [
        27941,
        28015
      ]
    },
    {
      "content": "Add code files",
      "pos": [
        28148,
        28162
      ]
    },
    {
      "content": "In this section you copy code files from the downloaded solution into the new solution.",
      "pos": [
        28164,
        28251
      ]
    },
    {
      "content": "The following sections will show and explain key parts of this code.",
      "pos": [
        28252,
        28320
      ]
    },
    {
      "content": "To add files to a project or a folder, right-click the project or folder and click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept> - <bpt id=\"p2\">**</bpt>Existing Item<ept id=\"p2\">**</ept>.",
      "pos": [
        28322,
        28433
      ]
    },
    {
      "content": "Select the files you want and then click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept>.",
      "pos": [
        28434,
        28483
      ]
    },
    {
      "content": "If asked whether you want to replace existing files, click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept>.",
      "pos": [
        28484,
        28551
      ]
    },
    {
      "pos": [
        28556,
        28711
      ],
      "content": "In the ContosoAdsCommon project, delete the <bpt id=\"p1\">*</bpt>Class1.cs<ept id=\"p1\">*</ept> file and add in its place the <bpt id=\"p2\">*</bpt>Ad.cs<ept id=\"p2\">*</ept> and <bpt id=\"p3\">*</bpt>ContosoAdscontext.cs<ept id=\"p3\">*</ept> files from the downloaded project."
    },
    {
      "content": "In the ContosoAdsWeb project, add the following files from the downloaded project.",
      "pos": [
        28716,
        28798
      ]
    },
    {
      "pos": [
        28805,
        28822
      ],
      "content": "<bpt id=\"p1\">*</bpt>Global.asax.cs<ept id=\"p1\">*</ept>."
    },
    {
      "pos": [
        28831,
        28886
      ],
      "content": "In the <bpt id=\"p1\">*</bpt>Views\\Shared<ept id=\"p1\">*</ept> folder: <ph id=\"ph1\">&lt;em&gt;</ph>\\_Layout.cshtml<ph id=\"ph2\">&lt;/em&gt;</ph>."
    },
    {
      "pos": [
        28893,
        28936
      ],
      "content": "In the <bpt id=\"p1\">*</bpt>Views\\Home<ept id=\"p1\">*</ept> folder: <bpt id=\"p2\">*</bpt>Index.cshtml<ept id=\"p2\">*</ept>."
    },
    {
      "pos": [
        28943,
        28990
      ],
      "content": "In the <bpt id=\"p1\">*</bpt>Controllers<ept id=\"p1\">*</ept> folder: <bpt id=\"p2\">*</bpt>AdController.cs<ept id=\"p2\">*</ept>."
    },
    {
      "pos": [
        28997,
        29070
      ],
      "content": "In the <bpt id=\"p1\">*</bpt>Views\\Ad<ept id=\"p1\">*</ept> folder (create the folder first): five <bpt id=\"p2\">*</bpt>.cshtml<ept id=\"p2\">*</ept> files."
    },
    {
      "pos": [
        29075,
        29156
      ],
      "content": "In the ContosoAdsWorker project, add <bpt id=\"p1\">*</bpt>WorkerRole.cs<ept id=\"p1\">*</ept> from the downloaded project."
    },
    {
      "content": "You can now build and run the application as instructed earlier in the tutorial, and the app will use local database and storage emulator resources.",
      "pos": [
        29158,
        29306
      ]
    },
    {
      "content": "The following sections explain the code related to working with the Azure environment, blobs, and queues.",
      "pos": [
        29308,
        29413
      ]
    },
    {
      "content": "This tutorial does not explain how to create MVC controllers and views using scaffolding, how to write Entity Framework code that works with SQL Server databases, or the basics of asynchronous programming in ASP.NET 4.5.",
      "pos": [
        29414,
        29634
      ]
    },
    {
      "content": "For information about these topics, see the following resources:",
      "pos": [
        29635,
        29699
      ]
    },
    {
      "content": "Get started with MVC 5",
      "pos": [
        29704,
        29726
      ]
    },
    {
      "content": "Get started with EF 6 and MVC 5",
      "pos": [
        29800,
        29831
      ]
    },
    {
      "pos": [
        29903,
        30116
      ],
      "content": "<bpt id=\"p1\">[</bpt>Introduction to asynchronous programming in .NET 4.5<ept id=\"p1\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/web-development-best-practices#async)</ept>."
    },
    {
      "content": "ContosoAdsCommon - Ad.cs",
      "pos": [
        30122,
        30146
      ]
    },
    {
      "content": "The Ad.cs file defines an enum for ad categories and a POCO entity class for ad information.",
      "pos": [
        30148,
        30240
      ]
    },
    {
      "content": "ContosoAdsCommon - ContosoAdsContext.cs",
      "pos": [
        31359,
        31398
      ]
    },
    {
      "content": "The ContosoAdsContext class specifies that the Ad class is used in a DbSet collection, which Entity Framework will store in a SQL database.",
      "pos": [
        31400,
        31539
      ]
    },
    {
      "content": "The class has two constructors.",
      "pos": [
        31898,
        31929
      ]
    },
    {
      "content": "The first of them is used by the web project, and specifies the name of a connection string that is stored in the Web.config file.",
      "pos": [
        31930,
        32060
      ]
    },
    {
      "content": "The second constructor enables you to pass in the actual connection string.",
      "pos": [
        32061,
        32136
      ]
    },
    {
      "content": "That is needed by the worker role project, since it doesn't have a Web.config file.",
      "pos": [
        32137,
        32220
      ]
    },
    {
      "content": "You saw earlier where this connection string was stored, and you'll see later how the code retrieves the connection string when it instantiates the DbContext class.",
      "pos": [
        32221,
        32385
      ]
    },
    {
      "content": "ContosoAdsWeb - Global.asax.cs",
      "pos": [
        32391,
        32421
      ]
    },
    {
      "content": "Code that is called from the <ph id=\"ph1\">`Application_Start`</ph> method creates an <bpt id=\"p1\">*</bpt>images<ept id=\"p1\">*</ept> blob container and an <bpt id=\"p2\">*</bpt>images<ept id=\"p2\">*</ept> queue if they don't already exist.",
      "pos": [
        32423,
        32564
      ]
    },
    {
      "content": "This ensures that whenever you start using a new storage account, or start using the storage emulator on a new computer, the required blob container and queue will be created automatically.",
      "pos": [
        32565,
        32754
      ]
    },
    {
      "pos": [
        32756,
        32862
      ],
      "content": "The code gets access to the storage account by using the storage connection string from the <bpt id=\"p1\">*</bpt>.cscfg<ept id=\"p1\">*</ept> file."
    },
    {
      "content": "Then it gets a reference to the <bpt id=\"p1\">*</bpt>images<ept id=\"p1\">*</ept> blob container, creates the container if it doesn't already exist, and sets access permissions on the new container.",
      "pos": [
        33007,
        33164
      ]
    },
    {
      "content": "By default, new containers only allow clients with storage account credentials to access blobs.",
      "pos": [
        33165,
        33260
      ]
    },
    {
      "content": "The website needs the blobs to be public so that it can display images using URLs that point to the image blobs.",
      "pos": [
        33261,
        33373
      ]
    },
    {
      "content": "Similar code gets a reference to the <bpt id=\"p1\">*</bpt>images<ept id=\"p1\">*</ept> queue and creates a new queue.",
      "pos": [
        33792,
        33868
      ]
    },
    {
      "content": "In this case no permissions change is needed.",
      "pos": [
        33869,
        33914
      ]
    },
    {
      "content": "ContosoAdsWeb - \\_Layout.cshtml",
      "pos": [
        34109,
        34140
      ]
    },
    {
      "pos": [
        34142,
        34244
      ],
      "content": "The <bpt id=\"p1\">*</bpt>_Layout.cshtml<ept id=\"p1\">*</ept> file sets the app name in the header and footer, and creates an \"Ads\" menu entry."
    },
    {
      "content": "ContosoAdsWeb - Views\\Home\\Index.cshtml",
      "pos": [
        34250,
        34289
      ]
    },
    {
      "content": "The <bpt id=\"p1\">*</bpt>Views\\Home\\Index.cshtml<ept id=\"p1\">*</ept> file displays category links on the home page.",
      "pos": [
        34291,
        34367
      ]
    },
    {
      "content": "The links pass the integer value of the <ph id=\"ph1\">`Category`</ph> enum in a querystring variable to the Ads Index page.",
      "pos": [
        34368,
        34472
      ]
    },
    {
      "content": "ContosoAdsWeb - AdController.cs",
      "pos": [
        34877,
        34908
      ]
    },
    {
      "pos": [
        34910,
        35094
      ],
      "content": "In the <bpt id=\"p1\">*</bpt>AdController.cs<ept id=\"p1\">*</ept> file the constructor calls the <ph id=\"ph1\">`InitializeStorage`</ph> method to create Azure Storage Client Library objects that provide an API for working with blobs and queues."
    },
    {
      "content": "Then the code gets a reference to the <bpt id=\"p1\">*</bpt>images<ept id=\"p1\">*</ept> blob container as you saw earlier in <bpt id=\"p2\">*</bpt>Global.asax.cs<ept id=\"p2\">*</ept>.",
      "pos": [
        35096,
        35197
      ]
    },
    {
      "content": "While doing that it sets a default <bpt id=\"p1\">[</bpt>retry policy<ept id=\"p1\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/transient-fault-handling)</ept> appropriate for a web app.",
      "pos": [
        35198,
        35420
      ]
    },
    {
      "content": "The default exponential backoff retry policy could hang the web app for longer than a minute on repeated retries for a transient fault.",
      "pos": [
        35421,
        35556
      ]
    },
    {
      "content": "The retry policy specified here waits 3 seconds after each try for up to 3 tries.",
      "pos": [
        35557,
        35638
      ]
    },
    {
      "pos": [
        35858,
        35910
      ],
      "content": "Similar code gets a reference to the <bpt id=\"p1\">*</bpt>images<ept id=\"p1\">*</ept> queue."
    },
    {
      "content": "Most of the controller code is typical for working with an Entity Framework data model using a DbContext class.",
      "pos": [
        36135,
        36246
      ]
    },
    {
      "content": "An exception is the HttpPost <ph id=\"ph1\">`Create`</ph> method, which uploads a file and saves it in blob storage.",
      "pos": [
        36247,
        36343
      ]
    },
    {
      "content": "The model binder provides an <bpt id=\"p1\">[</bpt>HttpPostedFileBase<ept id=\"p1\">](http://msdn.microsoft.com/library/system.web.httppostedfilebase.aspx)</ept> object to the method.",
      "pos": [
        36344,
        36485
      ]
    },
    {
      "content": "If the user selected a file to upload, the code uploads the file, saves it in a blob, and updates the Ad database record with a URL that points to the blob.",
      "pos": [
        36710,
        36866
      ]
    },
    {
      "content": "The code that does the upload is in the <ph id=\"ph1\">`UploadAndSaveBlobAsync`</ph> method.",
      "pos": [
        37059,
        37131
      ]
    },
    {
      "content": "It creates a GUID name for the blob, uploads and saves the file, and returns a reference to the saved blob.",
      "pos": [
        37132,
        37239
      ]
    },
    {
      "pos": [
        37731,
        37919
      ],
      "content": "After the HttpPost <ph id=\"ph1\">`Create`</ph> method uploads a blob and updates the database, it creates a queue message to inform that back-end process that an image is ready for conversion to a thumbnail."
    },
    {
      "pos": [
        38099,
        38244
      ],
      "content": "The code for the HttpPost <ph id=\"ph1\">`Edit`</ph> method is similar except that if the user selects a new image file any blobs that already exist must be deleted."
    },
    {
      "content": "The next example shows the code that deletes blobs when you delete an ad.",
      "pos": [
        38489,
        38562
      ]
    },
    {
      "content": "ContosoAdsWeb - Views\\Ad\\Index.cshtml and Details.cshtml",
      "pos": [
        39327,
        39383
      ]
    },
    {
      "pos": [
        39385,
        39452
      ],
      "content": "The <bpt id=\"p1\">*</bpt>Index.cshtml<ept id=\"p1\">*</ept> file displays thumbnails with the other ad data."
    },
    {
      "pos": [
        39507,
        39562
      ],
      "content": "The <bpt id=\"p1\">*</bpt>Details.cshtml<ept id=\"p1\">*</ept> file displays the full-size image."
    },
    {
      "content": "ContosoAdsWeb - Views\\Ad\\Create.cshtml and Edit.cshtml",
      "pos": [
        39617,
        39671
      ]
    },
    {
      "pos": [
        39673,
        39806
      ],
      "content": "The <bpt id=\"p1\">*</bpt>Create.cshtml<ept id=\"p1\">*</ept> and <bpt id=\"p2\">*</bpt>Edit.cshtml<ept id=\"p2\">*</ept> files specify form encoding that enables the controller to get the <ph id=\"ph1\">`HttpPostedFileBase`</ph> object."
    },
    {
      "pos": [
        39915,
        39989
      ],
      "content": "An <ph id=\"ph1\">`&lt;input&gt;`</ph> element tells the browser to provide a file selection dialog."
    },
    {
      "content": "ContosoAdsWorker - WorkerRole.cs - OnStart method",
      "pos": [
        40092,
        40141
      ]
    },
    {
      "pos": [
        40143,
        40336
      ],
      "content": "The Azure worker role environment calls the <ph id=\"ph1\">`OnStart`</ph> method in the <ph id=\"ph2\">`WorkerRole`</ph> class when the worker role is getting started, and it calls the <ph id=\"ph3\">`Run`</ph> method when the <ph id=\"ph4\">`OnStart`</ph> method finishes."
    },
    {
      "content": "The <ph id=\"ph1\">`OnStart`</ph> method gets the database connection string from the <bpt id=\"p1\">*</bpt>.cscfg<ept id=\"p1\">*</ept> file and passes it to the Entity Framework DbContext class.",
      "pos": [
        40338,
        40472
      ]
    },
    {
      "content": "The SQLClient provider is used by default, so the provider does not have to be specified.",
      "pos": [
        40473,
        40562
      ]
    },
    {
      "content": "After that the method gets a reference to the storage account and creates the blob container and queue if they don't exist.",
      "pos": [
        40712,
        40835
      ]
    },
    {
      "content": "The code for that is similar to what you already saw in the web role <ph id=\"ph1\">`Application_Start`</ph> method.",
      "pos": [
        40836,
        40932
      ]
    },
    {
      "content": "ContosoAdsWorker - WorkerRole.cs - Run method",
      "pos": [
        40938,
        40983
      ]
    },
    {
      "content": "The <ph id=\"ph1\">`Run`</ph> method is called when the <ph id=\"ph2\">`OnStart`</ph> method finishes its initialization work.",
      "pos": [
        40985,
        41071
      ]
    },
    {
      "content": "The method executes an infinite loop that watches for new queue messages and processes them when they arrive.",
      "pos": [
        41072,
        41181
      ]
    },
    {
      "content": "After each iteration of the loop, if no queue message was found, the program sleeps for a second.",
      "pos": [
        42011,
        42108
      ]
    },
    {
      "content": "This prevents the worker role from incurring excessive CPU time and storage transaction costs.",
      "pos": [
        42109,
        42203
      ]
    },
    {
      "content": "The Microsoft Customer Advisory Team tells a story about a  developer who forgot to include this, deployed to production, and left for vacation.",
      "pos": [
        42204,
        42348
      ]
    },
    {
      "content": "When he got back, his oversight cost more than the vacation.",
      "pos": [
        42349,
        42409
      ]
    },
    {
      "content": "Sometimes the content of a queue message causes an error in processing.",
      "pos": [
        42411,
        42482
      ]
    },
    {
      "content": "This is called a <bpt id=\"p1\">*</bpt>poison message<ept id=\"p1\">*</ept>, and if you just logged an error and restarted the loop, you could endlessly try to process that message.",
      "pos": [
        42483,
        42622
      ]
    },
    {
      "content": "Therefore the catch block includes an if statement that checks to see how many times the app has tried to process the current message, and if it has been more than 5 times, the message is deleted from the queue.",
      "pos": [
        42624,
        42835
      ]
    },
    {
      "pos": [
        42837,
        42899
      ],
      "content": "<ph id=\"ph1\">`ProcessQueueMessage`</ph> is called when a queue message is found."
    },
    {
      "content": "This code reads the database to get the image URL, converts the image to a thumbnail, saves the thumbnail in a blob, updates the database with the thumbnail blob URL, and deletes the queue message.",
      "pos": [
        43955,
        44152
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> The code in the <ph id=\"ph2\">`ConvertImageToThumbnailJPG`</ph> method uses classes in the System.Drawing namespace for simplicity.",
      "pos": [
        44155,
        44280
      ]
    },
    {
      "content": "However, the classes in this namespace were designed for use with Windows Forms.",
      "pos": [
        44281,
        44361
      ]
    },
    {
      "content": "They are not supported for use in a Windows or ASP.NET service.",
      "pos": [
        44362,
        44425
      ]
    },
    {
      "content": "For more information about image processing options, see <bpt id=\"p1\">[</bpt>Dynamic Image Generation<ept id=\"p1\">](http://www.hanselman.com/blog/BackToBasicsDynamicImageGenerationASPNETControllersRoutingIHttpHandlersAndRunAllManagedModulesForAllRequests.aspx)</ept> and <bpt id=\"p2\">[</bpt>Deep Inside Image Resizing<ept id=\"p2\">](http://www.hanselminutes.com/313/deep-inside-image-resizing-and-scaling-with-aspnet-and-iis-with-imageresizingnet-author-na)</ept>.",
      "pos": [
        44426,
        44813
      ]
    },
    {
      "content": "Troubleshooting",
      "pos": [
        44818,
        44833
      ]
    },
    {
      "content": "In case something doesn't work while you're following the instructions in this tutorial, here are some common errors and how to resolve them.",
      "pos": [
        44835,
        44976
      ]
    },
    {
      "content": "ServiceRuntime.RoleEnvironmentException",
      "pos": [
        44982,
        45021
      ]
    },
    {
      "content": "The <ph id=\"ph1\">`RoleEnvironment`</ph> object is provided by Azure when you run an application in Azure or when you run locally using the Azure compute emulator.",
      "pos": [
        45023,
        45167
      ]
    },
    {
      "content": "If you get this error when you're running locally, make sure that you have set the ContosoAdsCloudService project as the startup project.",
      "pos": [
        45169,
        45306
      ]
    },
    {
      "content": "This sets up the project to run using the Azure compute emulator.",
      "pos": [
        45307,
        45372
      ]
    },
    {
      "content": "One of the things the application uses the Azure RoleEnvironment for is to get the connection string values that are stored in the <bpt id=\"p1\">*</bpt>.cscfg<ept id=\"p1\">*</ept> files, so another cause of this exception is a missing connection string.",
      "pos": [
        45374,
        45587
      ]
    },
    {
      "content": "Make sure that you created the StorageConnectionString setting for both Cloud and Local configurations in the ContosoAdsWeb project, and that you created both connection strings for both configurations in the ContosoAdsWorker project.",
      "pos": [
        45588,
        45822
      ]
    },
    {
      "content": "If you do a <bpt id=\"p1\">**</bpt>Find All<ept id=\"p1\">**</ept> search for StorageConnectionString in the entire solution, you should see it 9 times in 6 files.",
      "pos": [
        45823,
        45944
      ]
    },
    {
      "content": "Cannot override to port xxx.",
      "pos": [
        45950,
        45978
      ]
    },
    {
      "content": "New port below minimum allowed value 8080 for protocol http",
      "pos": [
        45979,
        46038
      ]
    },
    {
      "content": "Try changing the port number used by the web project.",
      "pos": [
        46040,
        46093
      ]
    },
    {
      "content": "Right-click the ContosoAdsWeb project, and then click <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept>.",
      "pos": [
        46094,
        46163
      ]
    },
    {
      "content": "Click the <bpt id=\"p1\">**</bpt>Web<ept id=\"p1\">**</ept> tab, and then change the port number in the <bpt id=\"p2\">**</bpt>Project Url<ept id=\"p2\">**</ept> setting.",
      "pos": [
        46164,
        46250
      ]
    },
    {
      "content": "For another alternative that might resolve the problem, see the following  section.",
      "pos": [
        46252,
        46335
      ]
    },
    {
      "content": "Other errors when running locally",
      "pos": [
        46341,
        46374
      ]
    },
    {
      "content": "By default new cloud service projects use the Azure compute emulator express to simulate the Azure environment.",
      "pos": [
        46376,
        46487
      ]
    },
    {
      "content": "This is a lightweight version of the full compute emulator, and under some conditions the full emulator will work when the express version does not.",
      "pos": [
        46488,
        46636
      ]
    },
    {
      "content": "To change the project to use the full emulator, right-click the ContosoAdsCloudService project, and then click <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept>.",
      "pos": [
        46640,
        46766
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept> window click the <bpt id=\"p2\">**</bpt>Web<ept id=\"p2\">**</ept> tab, and then click the <bpt id=\"p3\">**</bpt>Use Full Emulator<ept id=\"p3\">**</ept> radio button.",
      "pos": [
        46767,
        46873
      ]
    },
    {
      "content": "In order to run the application with the full emulator, you have to open Visual Studio with administrator privileges.",
      "pos": [
        46875,
        46992
      ]
    },
    {
      "content": "Next steps",
      "pos": [
        46997,
        47007
      ]
    },
    {
      "content": "The Contoso Ads application has intentionally been kept simple for a getting-started tutorial.",
      "pos": [
        47009,
        47103
      ]
    },
    {
      "content": "For example, it doesn't implement <bpt id=\"p1\">[</bpt>dependency injection<ept id=\"p1\">](http://www.asp.net/mvc/tutorials/hands-on-labs/aspnet-mvc-4-dependency-injection)</ept> or the <bpt id=\"p2\">[</bpt>repository and unit of work patterns<ept id=\"p2\">](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/advanced-entity-framework-scenarios-for-an-mvc-web-application#repo)</ept>, it doesn't <bpt id=\"p3\">[</bpt>use an interface for logging<ept id=\"p3\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry#log)</ept>, it doesn't use <bpt id=\"p4\">[</bpt>EF Code First Migrations<ept id=\"p4\">](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application)</ept> to manage data model changes or <bpt id=\"p5\">[</bpt>EF Connection Resiliency<ept id=\"p5\">](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application)</ept> to manage transient network errors, and so forth.",
      "pos": [
        47104,
        48090
      ]
    },
    {
      "content": "Here are some cloud service sample applications that demonstrate more real-world coding practices, listed from less complex to more complex:",
      "pos": [
        48092,
        48232
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>PhluffyFotos<ept id=\"p1\">](http://code.msdn.microsoft.com/PhluffyFotos-Sample-7ecffd31)</ept>.",
      "pos": [
        48236,
        48312
      ]
    },
    {
      "content": "Similar in concept to Contoso Ads but implements more features and more real-world coding practices.",
      "pos": [
        48313,
        48413
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>Azure Cloud Service Multi-Tier Application with Tables, Queues, and Blobs<ept id=\"p1\">](http://code.msdn.microsoft.com/windowsazure/Windows-Azure-Multi-Tier-eadceb36)</ept>.",
      "pos": [
        48416,
        48571
      ]
    },
    {
      "content": "Introduces Azure Storage tables as well as blobs and queues, and comes with a <bpt id=\"p1\">[</bpt>step-by-step tutorial series<ept id=\"p1\">](../cloud-services-dotnet-multi-tier-app-storage-1-overview.md)</ept>.",
      "pos": [
        48572,
        48744
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>Cloud Service Fundamentals in Microsoft Azure<ept id=\"p1\">](http://code.msdn.microsoft.com/Cloud-Service-Fundamentals-4ca72649)</ept>.",
      "pos": [
        48747,
        48863
      ]
    },
    {
      "content": "A comprehensive sample demonstrating a wide range of best practices, produced by the Microsoft Patterns and Practices group.",
      "pos": [
        48864,
        48988
      ]
    },
    {
      "pos": [
        48990,
        49228
      ],
      "content": "For general information about developing for the cloud, see <bpt id=\"p1\">[</bpt>Building Real-World Cloud Apps with Azure<ept id=\"p1\">](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction)</ept>."
    },
    {
      "pos": [
        49230,
        49423
      ],
      "content": "For a video introduction to Azure Storage best practices and patterns, see <bpt id=\"p1\">[</bpt>Microsoft Azure Storage – What's New, Best Practices and Patterns<ept id=\"p1\">](http://channel9.msdn.com/Events/Build/2014/3-628)</ept>."
    },
    {
      "content": "For more information, see the following resources:",
      "pos": [
        49425,
        49475
      ]
    },
    {
      "content": "Azure Cloud Services Part 1: Introduction",
      "pos": [
        49480,
        49521
      ]
    },
    {
      "content": "How to manage Cloud Services",
      "pos": [
        49600,
        49628
      ]
    },
    {
      "content": "Azure Storage",
      "pos": [
        49666,
        49679
      ]
    },
    {
      "content": "test",
      "pos": [
        49716,
        49720
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"Get started with Azure Cloud Services and ASP.NET | Microsoft Azure\"\n    description=\"Learn how to create a multi-tier app using ASP.NET MVC and Azure. The app runs in a cloud service, with web role and worker role. It uses Entity Framework, SQL Database, and Azure Storage queues and blobs.\"\n    services=\"cloud-services, storage\"\n    documentationCenter=\".net\"\n    authors=\"tdykstra\"\n    manager=\"wpickett\"\n    editor=\"mollybos\"/>\n\n<tags\n    ms.service=\"cloud-services\"\n    ms.workload=\"tbd\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"dotnet\"\n    ms.topic=\"hero-article\"\n    ms.date=\"09/01/2015\"\n    ms.author=\"tdykstra\"/>\n\n# Get started with Azure Cloud Services and ASP.NET\n\n> [AZURE.SELECTOR]\n- [Node.js](cloud-services-nodejs-develop-deploy-app.md)\n- [.NET](cloud-services-dotnet-get-started.md)\n\n## Overview\n\nThis tutorial shows how to create a multi-tier .NET application with an ASP.NET MVC front-end, and deploy it to an [Azure cloud service](fundamentals-application-models.md#CloudServices). The application uses [Azure SQL Database](http://msdn.microsoft.com/library/azure/ee336279), the [Azure Blob service](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage), and the [Azure Queue service](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern). You can [download the Visual Studio project](http://code.msdn.microsoft.com/Simple-Azure-Cloud-Service-e01df2e4) from the MSDN Code Gallery.\n\nThe tutorial shows you how to build and run the application locally, how to deploy it to Azure and run in the cloud, and finally how to build it from scratch. You can start by building from scratch and then do the test and deploy steps afterward if you prefer.\n\n## Contoso Ads application\n\nThe application is an advertising bulletin board. Users create an ad by entering text and uploading an image. They can see a list of ads with thumbnail images, and they can see the full size image when they select an ad to see the details.\n\n![Ad list](./media/cloud-services-dotnet-get-started/list.png)\n\nThe application uses the [queue-centric work pattern](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern) to off-load the CPU-intensive work of creating thumbnails to a back-end process.\n\n## Alternative architecture: Websites and WebJobs\n\nThis tutorial shows how to run both front-end and back-end in an Azure cloud service. An alternative is to run the front-end in an [Azure website](/services/web-sites/) and use the [WebJobs](http://go.microsoft.com/fwlink/?LinkId=390226) feature (currently in preview) for the back-end. For a tutorial that uses WebJobs, see [Get Started with the Azure WebJobs SDK](../websites-dotnet-webjobs-sdk-get-started.md). For information about how to choose the services that best fit your scenario, see [Azure Websites, Cloud Services, and virtual machines comparison](../choose-web-site-cloud-service-vm.md).\n\n## What you'll learn\n\n* How to enable your machine for Azure development by installing the Azure SDK.\n* How to create a Visual Studio cloud service project with an ASP.NET MVC web role and a worker role.\n* How to test the cloud service project locally, using the Azure storage emulator.\n* How to publish the cloud project to an Azure cloud service and test using an Azure storage account.\n* How to upload files and store them in the Azure Blob service.\n* How to use the Azure Queue service for communication between tiers.\n\n## Prerequisites\n\nThe tutorial assumes that you understand [basic concepts about Azure cloud services](fundamentals-application-models.md#CloudServices) such as *web role* and *worker role* terminology.  It also assumes that you know how to work with [ASP.NET MVC](http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started) or [Web Forms](http://www.asp.net/web-forms/tutorials/aspnet-45/getting-started-with-aspnet-45-web-forms/introduction-and-overview) projects in Visual Studio. The sample application uses MVC, but most of the tutorial also applies to Web Forms.\n\nYou can run the app locally without an Azure subscription, but you'll need one in order to deploy the application to the cloud. If you don't have an account, you can [activate your MSDN subscriber benefits](/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A55E3C668) or [sign up for a free trial](/pricing/free-trial/?WT.mc_id=A55E3C668).\n\nThe tutorial instructions work with either of the following products:\n\n* Visual Studio 2013\n* Visual Studio 2013 Express for Web\n\nIf you don't have one of these, Visual Studio 2013 Express for Web will be installed automatically when you install the Azure SDK.\n\n## Application architecture\n\nThe app stores ads in a SQL database, using Entity Framework Code First to create the tables and access the data. For each ad the database stores two URLs, one for the full-size image and one for the thumbnail.\n\n![Ad table](./media/cloud-services-dotnet-get-started/adtable.png)\n\nWhen a user uploads an image, the front-end running in a web role stores the image in an [Azure blob](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage), and it stores the ad information in the database with a URL that points to the blob. At the same time, it writes a message to an Azure queue. A back-end process running in a worker role periodically polls the queue for new messages. When a new message appears, the worker role creates a thumbnail for that image and updates the thumbnail URL database field for that ad. The following diagram shows how the parts of the application interact.\n\n![Contoso Ads architecture](./media/cloud-services-dotnet-get-started/apparchitecture.png)\n\n[AZURE.INCLUDE [install-sdk-2013-only](../../includes/install-sdk-2013-only.md)]\n\n## Download and run the completed solution\n\n1. Download and unzip the [completed solution](http://code.msdn.microsoft.com/Simple-Azure-Cloud-Service-e01df2e4).\n\n2. Start Visual Studio.\n\n3. From the **File** menu choose **Open Project**, navigate to where you downloaded the solution, and then open the solution file.\n\n3. Press CTRL+SHIFT+B to build the solution.\n\n    By default, Visual Studio automatically restores the NuGet package content, which was not included in the *.zip* file. If the packages don't restore, install them manually by going to the **Manage NuGet Packages for Solution** dialog box and clicking the **Restore** button at the top right.\n\n3. In **Solution Explorer**, make sure that **ContosoAdsCloudService** is selected as the startup project.\n\n1. Press CTRL+F5 to run the application.\n\n    When you run a cloud service project locally, Visual Studio automatically invokes the Azure *compute emulator* and Azure *storage emulator*. The compute emulator uses your computer's resources to simulate the web role and worker role environments. The storage emulator uses a [SQL Server Express LocalDB](http://msdn.microsoft.com/library/hh510202.aspx) database to simulate Azure cloud storage.\n\n    The first time you run a cloud service project, it takes a minute or so for the emulators to start up. When emulator startup is finished, the default browser opens to the application home page.\n\n    ![Contoso Ads architecture](./media/cloud-services-dotnet-get-started/home.png)\n\n2. Click  **Create an Ad**.\n\n2. Enter some test data and select a *.jpg* image to upload, and then click **Create**.\n\n    ![Create page](./media/cloud-services-dotnet-get-started/create.png)\n\n    The app goes to the Index page, but it doesn't show a thumbnail for the new ad because that processing hasn't happened yet.\n\n3. Wait a moment and then refresh the Index page to see the thumbnail.\n\n    ![Index page](./media/cloud-services-dotnet-get-started/list.png)\n\n4. Click **Details** for your ad to see the full-size image.\n\n    ![Details page](./media/cloud-services-dotnet-get-started/details.png)\n\nYou've been running the application entirely on your local computer, with no connection to the cloud. The storage emulator stores the queue and blob data in a SQL Server Express LocalDB database, and the application stores the ad data in another LocalDB database. Entity Framework Code First automatically created the ad database the first time the web app tried to access it.\n\nIn the following section you'll configure the solution to use Azure cloud resources for queues, blobs, and the application database when it runs in the cloud. If you wanted to continue to run locally but use cloud storage and database resources, you could do that; it's just a matter of setting connection strings, which you'll see how to do.\n\n## Deploy the application to Azure\n\nYou'll do the following steps to run the application in the cloud:\n\n* Create an Azure cloud service.\n* Create an Azure SQL database.\n* Create an Azure storage account.\n* Configure the solution to use your Azure SQL database when it runs in Azure.\n* Configure the solution to use your Azure storage account when it runs in Azure.\n* Deploy the project to your Azure cloud service.\n\n### Create an Azure cloud service\n\nAn Azure cloud service is the environment the application will run in.\n\n1. In your browser, open the [Azure portal](http://manage.windowsazure.com).\n\n2. Click **New > Compute > Cloud Service > Quick Create**.\n\n4. In the URL input box, enter a URL prefix.\n\n    This URL has to be unique.  You'll get an error message if the prefix you choose is already in use by someone else.\n\n5. Choose the region where you want to deploy the application.\n\n    This field specifies which datacenter your cloud service will be hosted in. For a production application, you'd choose the region closest to your customers. For this tutorial, choose the region closest to you.\n\n6. Click **Create Cloud Service**.\n\n    In the following image, a cloud service is created with the URL contosoads.cloudapp.net.\n\n    ![New Cloud Service](./media/cloud-services-dotnet-get-started/newcs.png)\n\n### Create an Azure SQL database\n\nWhen the app runs in the cloud, it will use a cloud-based database.\n\n1. In the [Azure portal](http://manage.windowsazure.com), click **New > Data Services > SQL Database > Quick Create**.\n\n1. In the **Database Name** box, enter *contosoads*.\n\n1. From the **Server** drop-down list, choose **New SQL Database server**.\n\n    Alternatively, if your subscription already has a server, you can select that server from the drop-down list.\n\n1. Choose the same **Region** that you chose for the cloud service.\n\n    When the cloud service and database are in different datacenters (different regions), latency will increase and you will be charged for bandwidth outside the data center. Bandwidth within a data center is free.\n\n1. Enter an administrator **Login Name** and **Password**.\n\n    If you selected **New SQL Database server** you aren't entering an existing name and password here, you're entering a new name and password that you're defining now to use later when you access the database. If you selected a server that you created previously, you'll be prompted for the password to the administrative user account you already created.\n\n1. Click **Create SQL Database**.\n\n    ![New SQL Database](./media/cloud-services-dotnet-get-started/newdb.png)\n\n1. After Azure finishes creating the database, click the **SQL Databases** tab in the left pane of the portal, and then click the name of the new database.\n\n2. Click the **Dashboard** tab.\n\n3. Click **Manage allowed IP addresses**.\n\n4. Under **Allowed Services**, change **Azure Services** to **Yes**.\n\n5. Click **Save**.\n\n### Create an Azure storage account\n\nAn Azure storage account provides resources for storing queue and blob data in the cloud.\n\nIn a real-world application, you would typically create separate accounts for application data versus logging data, and separate accounts for test data versus production data. For this tutorial you'll use just one account.\n\n1. In the [Azure portal](http://manage.windowsazure.com), click **New > Data Services > Storage > Quick Create**.\n\n4. In the **URL** box, enter a URL prefix.\n\n    This prefix plus the text you see under the box will be the unique URL to your storage account. If the prefix you enter has already been used by someone else, you'll have to choose a different prefix.\n\n5. Set the **Region** drop-down list to the same region you chose for the cloud service.\n\n    When the cloud service and storage account are in different datacenters (different regions), latency will increase and you will be charged for bandwidth outside the data center. Bandwidth within a data center is free.\n\n    Azure affinity groups provide a mechanism to minimize the distance between resources in a data center, which can reduce latency. This tutorial does not use affinity groups. For more information, see [How to Create an Affinity Group in Azure](http://msdn.microsoft.com/library/jj156209.aspx).\n\n6. Set the **Replication** drop-down list to **Locally redundant**.\n\n    When geo-replication is enabled for a storage account, the stored content is replicated to a secondary datacenter to enable failover to that location in case of a major disaster in the primary location. Geo-replication can incur additional costs. For test and development accounts, you generally don't want to pay for geo-replication. For more information, see [Create, manage, or delete a storage account](../storage-create-storage-account/#replication-options).\n\n5. Click **Create Storage Account**.\n\n    ![New storage account](./media/cloud-services-dotnet-get-started/newstorage.png)\n\n    In the image, a storage account is created with the URL `contosoads.core.windows.net`.\n\n### Configure the solution to use your Azure SQL database when it runs in Azure\n\nThe web project and the worker role project each has its own database connection string, and each needs to point to the Azure SQL database when the app runs in Azure.\n\nYou'll use a [Web.config transform](http://www.asp.net/mvc/tutorials/deployment/visual-studio-web-deployment/web-config-transformations) for the web role and a cloud service environment setting for the worker role.\n\n>[AZURE.NOTE] In this section and the next section you store credentials in project files. [Don't store sensitive data in public source code repositories](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control#secrets).\n\n1. In the ContosoAdsWeb project, open the *Web.Release.config* transform file for the application *Web.config* file, delete the comment block that contains a `<connectionStrings>` element, and paste the following code in its place.\n\n        <connectionStrings>\n            <add name=\"ContosoAdsContext\" connectionString=\"{connectionstring}\"\n            providerName=\"System.Data.SqlClient\" xdt:Transform=\"SetAttributes\" xdt:Locator=\"Match(name)\"/>\n        </connectionStrings>\n\n    Leave the file open for editing.\n\n2. In the [Azure portal](http://manage.windowsazure.com), click **SQL Databases** in the left pane, click the database you created for this tutorial, click the **Dashboard** tab, and then click **Show connection strings**.\n\n    ![Show connection strings](./media/cloud-services-dotnet-get-started/showcs.png)\n\n    The portal displays connection strings, with a placeholder for the password.\n\n    ![Connection strings](./media/cloud-services-dotnet-get-started/connstrings.png)\n\n4. In the *Web.Release.config* transform file, delete `{connectionstring}` and paste in its place the ADO.NET connection string from the Azure portal.\n\n5. In the connection string that you pasted into the *Web.Release.config* transform file, replace `{your_password_here}` with the password you created for the new SQL database.\n\n7. Save the file.  \n\n6. Select and copy the connection string (without the surrounding quotation marks) for use in the following steps for configuring the worker role project.\n\n5. In **Solution Explorer**, under **Roles** in the cloud service project, right-click **ContosoAdsWorker** and then click **Properties**.\n\n    ![Role properties](./media/cloud-services-dotnet-get-started/rolepropertiesworker.png)\n\n6. Click the **Settings** tab.\n\n7. Change **Service Configuration** to **Cloud**.\n\n7. Select the text in the `ContosoAdsDbConnectionString` setting, and then paste the connection string that you copied from the previous section of the tutorial.\n\n    ![Database connection string for worker role](./media/cloud-services-dotnet-get-started/workerdbcs.png)\n\n7. Save your changes.  \n\n### Configure the solution to use your Azure storage account when it runs in Azure\n\nAzure storage account connection strings for both the web role project and the worker role project are stored in environment settings in the cloud service project. For each project there is a separate set of settings to be used when the application runs locally and when it runs in the cloud. You'll update the cloud environment settings for both web and worker role projects.\n\n4. In **Solution Explorer**, right-click **ContosoAdsWeb** under **Roles** in the **ContosoAdsCloudService** project, and then click **Properties**.\n\n    ![Role properties](./media/cloud-services-dotnet-get-started/roleproperties.png)\n\n5. Click the **Settings** tab. In the **Service Configuration** drop-down box, choose **Cloud**.\n\n    ![Cloud configuration](./media/cloud-services-dotnet-get-started/sccloud.png)\n\n6. Select the **StorageConnectionString** entry, and you'll see an ellipsis (**...**) button at the right end of the line. Click the ellipsis button to open the **Create Storage Account Connection String** dialog box.\n\n    ![Open Connection String Create box](./media/cloud-services-dotnet-get-started/opencscreate.png)\n\n1. In the **Create Storage Connection String** dialog box, click **Your subscription**, choose the storage account that you created earlier, and then click **OK**. If you're not already logged in, you'll be prompted for your Azure account credentials.\n\n    ![Create Storage Connection String](./media/cloud-services-dotnet-get-started/createstoragecs.png)\n\n1. Save your changes.\n\n2. Follow the same procedure that you used for the `StorageConnectionString` connection string to set the `Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString` connection string.\n\n    This connection string is used for logging.\n\n2. Follow the same procedure that you used for the **ContosoAdsWeb** role to set both connection strings for the **ContosoAdsWorker** role. Don't forget to set **Service Configuration** to **Cloud**.\n\nThe role environment settings that you have configured using the Visual Studio UI are stored in the following files in the ContosoAdsCloudService project:\n\n* *ServiceDefinition.csdef* - Defines the setting names.\n* *ServiceConfiguration.Cloud.cscfg* - Provides values for when the app runs in the cloud.\n* *ServiceConfiguration.Local.cscfg* - Provides values for when the app runs locally.\n\nFor example, the ServiceDefinition.csdef includes the following definitions.\n\n        <ConfigurationSettings>\n          <Setting name=\"StorageConnectionString\" />\n          <Setting name=\"ContosoAdsDbConnectionString\" />\n        </ConfigurationSettings>\n\nAnd the *ServiceConfiguration.Cloud.cscfg* file includes the values you entered for those settings in Visual Studio.\n\n        <Role name=\"ContosoAdsWorker\">\n          <Instances count=\"1\" />\n          <ConfigurationSettings>\n            <Setting name=\"StorageConnectionString\" value=\"{yourconnectionstring}\" />\n            <Setting name=\"ContosoAdsDbConnectionString\" value=\"{yourconnectionstring}\" />\n            <!-- other settings not shown -->\n          </ConfigurationSettings>\n          <!-- other settings not shown -->\n        </Role>\n\nThe `<Instances>` setting specifies the number of virtual machines that Azure will run the worker role code on. The [Next steps](#next-steps) section includes links to more information about scaling out a cloud service,\n\n###  Deploy the project to Azure\n\n3.  In **Solution Explorer**, right-click the **ContosoAdsCloudService** cloud project and then select **Publish**.\n\n    ![Publish menu](./media/cloud-services-dotnet-get-started/pubmenu.png)\n\n2. In the **Sign in** step of the **Publish Azure Application** wizard, click **Next**.\n\n    ![Sign in step](./media/cloud-services-dotnet-get-started/pubsignin.png)\n\n3. In the **Settings** step of the wizard, click **Next**.\n\n    ![Settings step](./media/cloud-services-dotnet-get-started/pubsettings.png)\n\n    The default settings in the **Advanced** tab are fine for this tutorial. For information about the advanced tab, see [Publish Azure Application Wizard](http://msdn.microsoft.com/library/hh535756.aspx).\n\n2. In the **Summary** step, click **Publish**.\n\n    ![Summary step](./media/cloud-services-dotnet-get-started/pubsummary.png)\n\n   The **Azure Activity Log** window opens in Visual Studio.\n\n2. Click the right arrow icon to expand the deployment details.\n\n    The deployment can take up to 5 minutes or more to complete.\n\n    ![Azure Activity Log window](./media/cloud-services-dotnet-get-started/waal.png)\n\n1. When the deployment status is complete, click the **Website URL** to start the application.\n\n9. You can now test the app by creating, viewing, and editing some ads, as you did when you ran the application locally.\n\n>[AZURE.NOTE] When you're finished testing, delete or stop the cloud service. Even if you're not using the cloud service, it's accruing charges because virtual machine resources are reserved for it. And if you leave it running, anyone who finds your URL can create and view ads. In the [Azure portal](http://manage.windowsazure.com), go to the **Dashboard** tab for your cloud service, and then click the **Delete** button at the bottom of the page. If you just want to temporarily prevent others from accessing the site, click **Stop** instead. In that case, charges will continue to accrue. You can follow a similar procedure to delete the SQL database and storage account when you no longer need them.\n\n## Create the application from scratch\n\nIf you haven't already downloaded\n[the completed application](http://code.msdn.microsoft.com/Simple-Azure-Cloud-Service-e01df2e4), do that now. You'll copy files from the downloaded project into the new project.\n\nCreating the Contoso Ads application involves the following steps:\n\n* Create a cloud service Visual Studio solution.\n* Update and add NuGet packages.\n* Set project references.\n* Configure connection strings.\n* Add code files.\n\nAfter the solution is created, you'll review the code that is unique to cloud service projects and Azure blobs and queues.\n\n### Create a cloud service Visual Studio solution\n\n1. In Visual Studio, choose **New Project** from the **File** menu.\n\n2. In the left pane of the **New Project** dialog box, expand **Visual C#** and choose **Cloud** templates, and then choose the **Azure Cloud Service** template.\n\n3. Name the project and solution ContosoAdsCloudService, and then click **OK**.\n\n    ![New Project](./media/cloud-services-dotnet-get-started/newproject.png)\n\n4. In the **New Azure Cloud Service** dialog box, add a web role and a worker role. Name the web role ContosoAdsWeb, and name the worker role ContosoAdsWorker. (Use the pencil icon in the right-hand pane to change the default names of the roles.)\n\n    ![New Cloud Service Project](./media/cloud-services-dotnet-get-started/newcsproj.png)\n\n5. When you see the **New ASP.NET Project** dialog box for the web role, choose the MVC template, and then click **Change Authentication**.\n\n    ![Change Authentication](./media/cloud-services-dotnet-get-started/chgauth.png)\n\n7. In the **Change Authentication** dialog box, choose **No Authentication**, and then click **OK**.\n\n    ![No Authentication](./media/cloud-services-dotnet-get-started/noauth.png)\n\n8. In the **New ASP.NET Project** dialog, click **OK**.\n\n9. In **Solution Explorer**, right-click the solution (not one of the projects), and choose **Add - New Project**.\n\n11. In the **Add New Project** dialog box, choose **Windows Desktop** under **Visual C#** in the left pane, and then click the **Class Library** template.  \n\n10. Name the project *ContosoAdsCommon*, and then click **OK**.\n\n    You need to reference the Entity Framework context and the data model from both web and worker role projects. As an alternative you could define the EF-related classes in the web role project and reference that project from the worker role project. But in the alternative approach, your worker role project would have a reference to web assemblies which it doesn't need.\n\n### Update and add NuGet packages\n\n11. Open the **Manage NuGet Packages** dialog box for the solution.\n\n12. In the left pane, select **Updates**.\n\n13. Look for the *WindowsAzure.Storage* package, and if it's in the list, click **Update** to get the latest version of the storage client library.\n\n    ![Update SCL](./media/cloud-services-dotnet-get-started/updstg.png)\n\n    The storage client library is updated more frequently than Visual Studio project templates, so you'll often find that the version in a newly created projected needs to be updated.\n\n14. In the left pane, select **Online**.\n\n16. Find the *EntityFramework* NuGet package, and install it in all three projects.\n\n17. Find the *Microsoft.WindowsAzure.ConfigurationManager* NuGet package, and install it in the worker role project.\n\n### Set project references\n\n10. In the ContosoAdsWeb project, set a reference to the ContosoAdsCommon project. Right-click the ContosoAdsWeb project, and then click **References** - **Add References**. In the **Reference Manager** dialog box, select **Solution – Projects** in the left pane, select **ContosoAdsCommon**, and then click **OK**.\n\n11. In the ContosoAdsWorker project, set a reference to the ContosAdsCommon project.\n\n    ContosoAdsCommon will contain the Entity Framework data model and context class, which will be used by both the front-end and back-end.\n\n11. In the ContosoAdsWorker project, set a reference to `System.Drawing`.\n\n    This assembly is used by the back-end to convert images to thumbnails.\n\n### Configure connection strings\n\nIn this section you configure Azure Storage and SQL connection strings for testing locally. The deployment instructions earlier in the tutorial explain how to set up the connection strings for when the app runs in the cloud.\n\n3. In the ContosoAdsWeb project, open the application Web.config file, and insert the following `connectionStrings` element after the `configSections` element.\n\n        <connectionStrings>\n          <add name=\"ContosoAdsContext\" connectionString=\"Data Source=(localdb)\\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;\" providerName=\"System.Data.SqlClient\" />\n        </connectionStrings>\n\n3. Save your changes.\n\n2. In the ContosoAdsCloudService project, right-click ContosoAdsWeb under **Roles**, and then click **Properties**.\n\n    ![Role properties](./media/cloud-services-dotnet-get-started/roleproperties.png)\n\n3. In the **ContosAdsWeb [Role]** properties window, click the **Settings** tab, and then click **Add Setting**.\n\n    Leave **Service Configuration** set to **All Configurations**.\n\n4. Add a new setting named *StorageConnectionString*. Set **Type** to *ConnectionString*, and set **Value** to *UseDevelopmentStorage=true*.\n\n    ![New connection string](./media/cloud-services-dotnet-get-started/scall.png)\n\n5. Save your changes.\n\n3. Follow the same procedure to add a storage connection string in the ContosoAdsWorker role properties.\n\n5. Still in the **ContosoAdsWorker [Role]** properties window, add another connection string:\n\n    * Name: ContosoAdsDbConnectionString\n    * Type: String\n    * Value: Paste the same connection string you used for the web role project:\n\n            Data Source=(localdb)\\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;\n\n### Add code files\n\nIn this section you copy code files from the downloaded solution into the new solution. The following sections will show and explain key parts of this code.\n\nTo add files to a project or a folder, right-click the project or folder and click **Add** - **Existing Item**. Select the files you want and then click **Add**. If asked whether you want to replace existing files, click **Yes**.\n\n3. In the ContosoAdsCommon project, delete the *Class1.cs* file and add in its place the *Ad.cs* and *ContosoAdscontext.cs* files from the downloaded project.\n\n3. In the ContosoAdsWeb project, add the following files from the downloaded project.\n    - *Global.asax.cs*.  \n    - In the *Views\\Shared* folder: <em>\\_Layout.cshtml</em>.\n    - In the *Views\\Home* folder: *Index.cshtml*.\n    - In the *Controllers* folder: *AdController.cs*.\n    - In the *Views\\Ad* folder (create the folder first): five *.cshtml* files.\n\n3. In the ContosoAdsWorker project, add *WorkerRole.cs* from the downloaded project.\n\nYou can now build and run the application as instructed earlier in the tutorial, and the app will use local database and storage emulator resources.\n\nThe following sections explain the code related to working with the Azure environment, blobs, and queues. This tutorial does not explain how to create MVC controllers and views using scaffolding, how to write Entity Framework code that works with SQL Server databases, or the basics of asynchronous programming in ASP.NET 4.5. For information about these topics, see the following resources:\n\n* [Get started with MVC 5](http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started)\n* [Get started with EF 6 and MVC 5](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc)\n* [Introduction to asynchronous programming in .NET 4.5](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/web-development-best-practices#async).\n\n### ContosoAdsCommon - Ad.cs\n\nThe Ad.cs file defines an enum for ad categories and a POCO entity class for ad information.\n\n        public enum Category\n        {\n            Cars,\n            [Display(Name=\"Real Estate\")]\n            RealEstate,\n            [Display(Name = \"Free Stuff\")]\n            FreeStuff\n        }\n\n        public class Ad\n        {\n            public int AdId { get; set; }\n\n            [StringLength(100)]\n            public string Title { get; set; }\n\n            public int Price { get; set; }\n\n            [StringLength(1000)]\n            [DataType(DataType.MultilineText)]\n            public string Description { get; set; }\n\n            [StringLength(1000)]\n            [DisplayName(\"Full-size Image\")]\n            public string ImageURL { get; set; }\n\n            [StringLength(1000)]\n            [DisplayName(\"Thumbnail\")]\n            public string ThumbnailURL { get; set; }\n\n            [DataType(DataType.Date)]\n            [DisplayFormat(DataFormatString = \"{0:yyyy-MM-dd}\", ApplyFormatInEditMode = true)]\n            public DateTime PostedDate { get; set; }\n\n            public Category? Category { get; set; }\n            [StringLength(12)]\n            public string Phone { get; set; }\n        }\n\n### ContosoAdsCommon - ContosoAdsContext.cs\n\nThe ContosoAdsContext class specifies that the Ad class is used in a DbSet collection, which Entity Framework will store in a SQL database.\n\n        public class ContosoAdsContext : DbContext\n        {\n            public ContosoAdsContext() : base(\"name=ContosoAdsContext\")\n            {\n            }\n            public ContosoAdsContext(string connString)\n                : base(connString)\n            {\n            }\n            public System.Data.Entity.DbSet<Ad> Ads { get; set; }\n        }\n\nThe class has two constructors. The first of them is used by the web project, and specifies the name of a connection string that is stored in the Web.config file. The second constructor enables you to pass in the actual connection string. That is needed by the worker role project, since it doesn't have a Web.config file. You saw earlier where this connection string was stored, and you'll see later how the code retrieves the connection string when it instantiates the DbContext class.\n\n### ContosoAdsWeb - Global.asax.cs\n\nCode that is called from the `Application_Start` method creates an *images* blob container and an *images* queue if they don't already exist. This ensures that whenever you start using a new storage account, or start using the storage emulator on a new computer, the required blob container and queue will be created automatically.\n\nThe code gets access to the storage account by using the storage connection string from the *.cscfg* file.\n\n        var storageAccount = CloudStorageAccount.Parse\n            (RoleEnvironment.GetConfigurationSettingValue(\"StorageConnectionString\"));\n\nThen it gets a reference to the *images* blob container, creates the container if it doesn't already exist, and sets access permissions on the new container. By default, new containers only allow clients with storage account credentials to access blobs. The website needs the blobs to be public so that it can display images using URLs that point to the image blobs.\n\n        var blobClient = storageAccount.CreateCloudBlobClient();\n        var imagesBlobContainer = blobClient.GetContainerReference(\"images\");\n        if (imagesBlobContainer.CreateIfNotExists())\n        {\n            imagesBlobContainer.SetPermissions(\n                new BlobContainerPermissions\n                {\n                    PublicAccess =BlobContainerPublicAccessType.Blob\n                });\n        }\n\nSimilar code gets a reference to the *images* queue and creates a new queue. In this case no permissions change is needed.\n\n        CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient();\n        var imagesQueue = queueClient.GetQueueReference(\"images\");\n        imagesQueue.CreateIfNotExists();\n\n### ContosoAdsWeb - \\_Layout.cshtml\n\nThe *_Layout.cshtml* file sets the app name in the header and footer, and creates an \"Ads\" menu entry.\n\n### ContosoAdsWeb - Views\\Home\\Index.cshtml\n\nThe *Views\\Home\\Index.cshtml* file displays category links on the home page. The links pass the integer value of the `Category` enum in a querystring variable to the Ads Index page.\n\n        <li>@Html.ActionLink(\"Cars\", \"Index\", \"Ad\", new { category = (int)Category.Cars }, null)</li>\n        <li>@Html.ActionLink(\"Real estate\", \"Index\", \"Ad\", new { category = (int)Category.RealEstate }, null)</li>\n        <li>@Html.ActionLink(\"Free stuff\", \"Index\", \"Ad\", new { category = (int)Category.FreeStuff }, null)</li>\n        <li>@Html.ActionLink(\"All\", \"Index\", \"Ad\", null, null)</li>\n\n### ContosoAdsWeb - AdController.cs\n\nIn the *AdController.cs* file the constructor calls the `InitializeStorage` method to create Azure Storage Client Library objects that provide an API for working with blobs and queues.\n\nThen the code gets a reference to the *images* blob container as you saw earlier in *Global.asax.cs*. While doing that it sets a default [retry policy](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/transient-fault-handling) appropriate for a web app. The default exponential backoff retry policy could hang the web app for longer than a minute on repeated retries for a transient fault. The retry policy specified here waits 3 seconds after each try for up to 3 tries.\n\n        var blobClient = storageAccount.CreateCloudBlobClient();\n        blobClient.RetryPolicy = new LinearRetry(TimeSpan.FromSeconds(3), 3);\n        imagesBlobContainer = blobClient.GetContainerReference(\"images\");\n\nSimilar code gets a reference to the *images* queue.\n\n        CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient();\n        queueClient.RetryPolicy = new LinearRetry(TimeSpan.FromSeconds(3), 3);\n        imagesQueue = queueClient.GetQueueReference(\"images\");\n\nMost of the controller code is typical for working with an Entity Framework data model using a DbContext class. An exception is the HttpPost `Create` method, which uploads a file and saves it in blob storage. The model binder provides an [HttpPostedFileBase](http://msdn.microsoft.com/library/system.web.httppostedfilebase.aspx) object to the method.\n\n        [HttpPost]\n        [ValidateAntiForgeryToken]\n        public async Task<ActionResult> Create(\n            [Bind(Include = \"Title,Price,Description,Category,Phone\")] Ad ad,\n            HttpPostedFileBase imageFile)\n\nIf the user selected a file to upload, the code uploads the file, saves it in a blob, and updates the Ad database record with a URL that points to the blob.\n\n        if (imageFile != null && imageFile.ContentLength != 0)\n        {\n            blob = await UploadAndSaveBlobAsync(imageFile);\n            ad.ImageURL = blob.Uri.ToString();\n        }\n\nThe code that does the upload is in the `UploadAndSaveBlobAsync` method. It creates a GUID name for the blob, uploads and saves the file, and returns a reference to the saved blob.\n\n        private async Task<CloudBlockBlob> UploadAndSaveBlobAsync(HttpPostedFileBase imageFile)\n        {\n            string blobName = Guid.NewGuid().ToString() + Path.GetExtension(imageFile.FileName);\n            CloudBlockBlob imageBlob = imagesBlobContainer.GetBlockBlobReference(blobName);\n            using (var fileStream = imageFile.InputStream)\n            {\n                await imageBlob.UploadFromStreamAsync(fileStream);\n            }\n            return imageBlob;\n        }\n\nAfter the HttpPost `Create` method uploads a blob and updates the database, it creates a queue message to inform that back-end process that an image is ready for conversion to a thumbnail.\n\n        string queueMessageString = ad.AdId.ToString();\n        var queueMessage = new CloudQueueMessage(queueMessageString);\n        await queue.AddMessageAsync(queueMessage);\n\nThe code for the HttpPost `Edit` method is similar except that if the user selects a new image file any blobs that already exist must be deleted.\n\n        if (imageFile != null && imageFile.ContentLength != 0)\n        {\n            await DeleteAdBlobsAsync(ad);\n            imageBlob = await UploadAndSaveBlobAsync(imageFile);\n            ad.ImageURL = imageBlob.Uri.ToString();\n        }\n\nThe next example shows the code that deletes blobs when you delete an ad.\n\n        private async Task DeleteAdBlobsAsync(Ad ad)\n        {\n            if (!string.IsNullOrWhiteSpace(ad.ImageURL))\n            {\n                Uri blobUri = new Uri(ad.ImageURL);\n                await DeleteAdBlobAsync(blobUri);\n            }\n            if (!string.IsNullOrWhiteSpace(ad.ThumbnailURL))\n            {\n                Uri blobUri = new Uri(ad.ThumbnailURL);\n                await DeleteAdBlobAsync(blobUri);\n            }\n        }\n        private static async Task DeleteAdBlobAsync(Uri blobUri)\n        {\n            string blobName = blobUri.Segments[blobUri.Segments.Length - 1];\n            CloudBlockBlob blobToDelete = imagesBlobContainer.GetBlockBlobReference(blobName);\n            await blobToDelete.DeleteAsync();\n        }\n\n### ContosoAdsWeb - Views\\Ad\\Index.cshtml and Details.cshtml\n\nThe *Index.cshtml* file displays thumbnails with the other ad data.\n\n        <img  src=\"@Html.Raw(item.ThumbnailURL)\" />\n\nThe *Details.cshtml* file displays the full-size image.\n\n        <img src=\"@Html.Raw(Model.ImageURL)\" />\n\n### ContosoAdsWeb - Views\\Ad\\Create.cshtml and Edit.cshtml\n\nThe *Create.cshtml* and *Edit.cshtml* files specify form encoding that enables the controller to get the `HttpPostedFileBase` object.\n\n        @using (Html.BeginForm(\"Create\", \"Ad\", FormMethod.Post, new { enctype = \"multipart/form-data\" }))\n\nAn `<input>` element tells the browser to provide a file selection dialog.\n\n        <input type=\"file\" name=\"imageFile\" accept=\"image/*\" class=\"form-control fileupload\" />\n\n### ContosoAdsWorker - WorkerRole.cs - OnStart method\n\nThe Azure worker role environment calls the `OnStart` method in the `WorkerRole` class when the worker role is getting started, and it calls the `Run` method when the `OnStart` method finishes.\n\nThe `OnStart` method gets the database connection string from the *.cscfg* file and passes it to the Entity Framework DbContext class. The SQLClient provider is used by default, so the provider does not have to be specified.\n\n        var dbConnString = CloudConfigurationManager.GetSetting(\"ContosoAdsDbConnectionString\");\n        db = new ContosoAdsContext(dbConnString);\n\nAfter that the method gets a reference to the storage account and creates the blob container and queue if they don't exist. The code for that is similar to what you already saw in the web role `Application_Start` method.\n\n### ContosoAdsWorker - WorkerRole.cs - Run method\n\nThe `Run` method is called when the `OnStart` method finishes its initialization work. The method executes an infinite loop that watches for new queue messages and processes them when they arrive.\n\n        public override void Run()\n        {\n            CloudQueueMessage msg = null;\n\n            while (true)\n            {\n                try\n                {\n                    msg = this.imagesQueue.GetMessage();\n                    if (msg != null)\n                    {\n                        ProcessQueueMessage(msg);\n                    }\n                    else\n                    {\n                        System.Threading.Thread.Sleep(1000);\n                    }\n                }\n                catch (StorageException e)\n                {\n                    if (msg != null && msg.DequeueCount > 5)\n                    {\n                        this.imagesQueue.DeleteMessage(msg);\n                    }\n                    System.Threading.Thread.Sleep(5000);\n                }\n            }\n        }\n\nAfter each iteration of the loop, if no queue message was found, the program sleeps for a second. This prevents the worker role from incurring excessive CPU time and storage transaction costs. The Microsoft Customer Advisory Team tells a story about a  developer who forgot to include this, deployed to production, and left for vacation. When he got back, his oversight cost more than the vacation.\n\nSometimes the content of a queue message causes an error in processing. This is called a *poison message*, and if you just logged an error and restarted the loop, you could endlessly try to process that message.  Therefore the catch block includes an if statement that checks to see how many times the app has tried to process the current message, and if it has been more than 5 times, the message is deleted from the queue.\n\n`ProcessQueueMessage` is called when a queue message is found.\n\n        private void ProcessQueueMessage(CloudQueueMessage msg)\n        {\n            var adId = int.Parse(msg.AsString);\n            Ad ad = db.Ads.Find(adId);\n            if (ad == null)\n            {\n                throw new Exception(String.Format(\"AdId {0} not found, can't create thumbnail\", adId.ToString()));\n            }\n\n            CloudBlockBlob inputBlob = this.imagesBlobContainer.GetBlockBlobReference(ad.ImageURL);\n\n            string thumbnailName = Path.GetFileNameWithoutExtension(inputBlob.Name) + \"thumb.jpg\";\n            CloudBlockBlob outputBlob = this.imagesBlobContainer.GetBlockBlobReference(thumbnailName);\n\n            using (Stream input = inputBlob.OpenRead())\n            using (Stream output = outputBlob.OpenWrite())\n            {\n                ConvertImageToThumbnailJPG(input, output);\n                outputBlob.Properties.ContentType = \"image/jpeg\";\n            }\n\n            ad.ThumbnailURL = outputBlob.Uri.ToString();\n            db.SaveChanges();\n\n            this.imagesQueue.DeleteMessage(msg);\n        }\n\nThis code reads the database to get the image URL, converts the image to a thumbnail, saves the thumbnail in a blob, updates the database with the thumbnail blob URL, and deletes the queue message.\n\n>[AZURE.NOTE] The code in the `ConvertImageToThumbnailJPG` method uses classes in the System.Drawing namespace for simplicity. However, the classes in this namespace were designed for use with Windows Forms. They are not supported for use in a Windows or ASP.NET service. For more information about image processing options, see [Dynamic Image Generation](http://www.hanselman.com/blog/BackToBasicsDynamicImageGenerationASPNETControllersRoutingIHttpHandlersAndRunAllManagedModulesForAllRequests.aspx) and [Deep Inside Image Resizing](http://www.hanselminutes.com/313/deep-inside-image-resizing-and-scaling-with-aspnet-and-iis-with-imageresizingnet-author-na).\n\n## Troubleshooting\n\nIn case something doesn't work while you're following the instructions in this tutorial, here are some common errors and how to resolve them.\n\n### ServiceRuntime.RoleEnvironmentException\n\nThe `RoleEnvironment` object is provided by Azure when you run an application in Azure or when you run locally using the Azure compute emulator.  If you get this error when you're running locally, make sure that you have set the ContosoAdsCloudService project as the startup project. This sets up the project to run using the Azure compute emulator.\n\nOne of the things the application uses the Azure RoleEnvironment for is to get the connection string values that are stored in the *.cscfg* files, so another cause of this exception is a missing connection string. Make sure that you created the StorageConnectionString setting for both Cloud and Local configurations in the ContosoAdsWeb project, and that you created both connection strings for both configurations in the ContosoAdsWorker project. If you do a **Find All** search for StorageConnectionString in the entire solution, you should see it 9 times in 6 files.\n\n### Cannot override to port xxx. New port below minimum allowed value 8080 for protocol http\n\nTry changing the port number used by the web project. Right-click the ContosoAdsWeb project, and then click **Properties**. Click the **Web** tab, and then change the port number in the **Project Url** setting.\n\nFor another alternative that might resolve the problem, see the following  section.\n\n### Other errors when running locally\n\nBy default new cloud service projects use the Azure compute emulator express to simulate the Azure environment. This is a lightweight version of the full compute emulator, and under some conditions the full emulator will work when the express version does not.  \n\nTo change the project to use the full emulator, right-click the ContosoAdsCloudService project, and then click **Properties**. In the **Properties** window click the **Web** tab, and then click the **Use Full Emulator** radio button.\n\nIn order to run the application with the full emulator, you have to open Visual Studio with administrator privileges.\n\n## Next steps\n\nThe Contoso Ads application has intentionally been kept simple for a getting-started tutorial. For example, it doesn't implement [dependency injection](http://www.asp.net/mvc/tutorials/hands-on-labs/aspnet-mvc-4-dependency-injection) or the [repository and unit of work patterns](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/advanced-entity-framework-scenarios-for-an-mvc-web-application#repo), it doesn't [use an interface for logging](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry#log), it doesn't use [EF Code First Migrations](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application) to manage data model changes or [EF Connection Resiliency](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application) to manage transient network errors, and so forth.\n\nHere are some cloud service sample applications that demonstrate more real-world coding practices, listed from less complex to more complex:\n\n* [PhluffyFotos](http://code.msdn.microsoft.com/PhluffyFotos-Sample-7ecffd31). Similar in concept to Contoso Ads but implements more features and more real-world coding practices.\n* [Azure Cloud Service Multi-Tier Application with Tables, Queues, and Blobs](http://code.msdn.microsoft.com/windowsazure/Windows-Azure-Multi-Tier-eadceb36). Introduces Azure Storage tables as well as blobs and queues, and comes with a [step-by-step tutorial series](../cloud-services-dotnet-multi-tier-app-storage-1-overview.md).\n* [Cloud Service Fundamentals in Microsoft Azure](http://code.msdn.microsoft.com/Cloud-Service-Fundamentals-4ca72649). A comprehensive sample demonstrating a wide range of best practices, produced by the Microsoft Patterns and Practices group.\n\nFor general information about developing for the cloud, see [Building Real-World Cloud Apps with Azure](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction).\n\nFor a video introduction to Azure Storage best practices and patterns, see [Microsoft Azure Storage – What's New, Best Practices and Patterns](http://channel9.msdn.com/Events/Build/2014/3-628).\n\nFor more information, see the following resources:\n\n* [Azure Cloud Services Part 1: Introduction](http://justazure.com/microsoft-azure-cloud-services-part-1-introduction/)\n* [How to manage Cloud Services](cloud-services-how-to-manage.md)\n* [Azure Storage](/documentation/services/storage/)\n\ntest\n"
}