{
  "nodes": [
    {
      "content": "Getting started with elastic database jobs",
      "pos": [
        82,
        124
      ]
    },
    {
      "content": "how to use elastic database jobs",
      "pos": [
        143,
        175
      ]
    },
    {
      "content": "Getting started with Elastic Database jobs",
      "pos": [
        528,
        570
      ]
    },
    {
      "content": "Elastic Database jobs (preview) for Azure SQL Database allows you to reliability execute T-SQL scripts that span multiple databases while automatically retrying and providing eventual completion guarantees.",
      "pos": [
        572,
        778
      ]
    },
    {
      "content": "For more information about the Elastic Database job feature, please see the <bpt id=\"p1\">[</bpt>feature overview page<ept id=\"p1\">](sql-database-elastic-jobs-overview.md)</ept>.",
      "pos": [
        779,
        918
      ]
    },
    {
      "content": "This topic extends the sample found in <bpt id=\"p1\">[</bpt>Getting started with Elastic Database tools<ept id=\"p1\">](sql-database-elastic-scale-get-started.md)</ept>.",
      "pos": [
        920,
        1048
      ]
    },
    {
      "content": "When completed, you will: learn how to create and manage jobs that manage a group of related databases.",
      "pos": [
        1049,
        1152
      ]
    },
    {
      "content": "Prerequisites",
      "pos": [
        1157,
        1170
      ]
    },
    {
      "pos": [
        1172,
        1289
      ],
      "content": "Download and run the <bpt id=\"p1\">[</bpt>Getting started with Elastic Database tools sample<ept id=\"p1\">](sql-database-elastic-scale-get-started.md)</ept>."
    },
    {
      "content": "Create a shard map manager using the sample app",
      "pos": [
        1294,
        1341
      ]
    },
    {
      "content": "Here you will create a shard map manager along with several shards, followed by insertion of data into the shards.",
      "pos": [
        1343,
        1457
      ]
    },
    {
      "content": "If you happen to already have shards setup with sharded data in them, you can skip the following steps and move to the next section.",
      "pos": [
        1458,
        1590
      ]
    },
    {
      "content": "Build and run the <bpt id=\"p1\">**</bpt>Getting started with Elastic Database tools<ept id=\"p1\">**</ept> sample application.",
      "pos": [
        1595,
        1680
      ]
    },
    {
      "content": "Follow the steps until step 7 in the section <bpt id=\"p1\">[</bpt>Download and run the sample app<ept id=\"p1\">](sql-database-elastic-scale-get-started.md#Getting-started-with-elastic-database-tools)</ept>.",
      "pos": [
        1681,
        1847
      ]
    },
    {
      "content": "At the end of Step 7, you will see the following command prompt:",
      "pos": [
        1848,
        1912
      ]
    },
    {
      "content": "![command prompt][1]",
      "pos": [
        1918,
        1938
      ]
    },
    {
      "content": "In the command window, type \"1\" and press <bpt id=\"p1\">**</bpt>Enter<ept id=\"p1\">**</ept>.",
      "pos": [
        1944,
        1996
      ]
    },
    {
      "content": "This creates the shard map manager, and adds two shards to the server.",
      "pos": [
        1997,
        2067
      ]
    },
    {
      "content": "Then type \"3\" and press <bpt id=\"p1\">**</bpt>Enter<ept id=\"p1\">**</ept>; repeat the action four times.",
      "pos": [
        2068,
        2132
      ]
    },
    {
      "content": "This inserts sample data rows in your shards.",
      "pos": [
        2133,
        2178
      ]
    },
    {
      "pos": [
        2184,
        2288
      ],
      "content": "The <bpt id=\"p1\">[</bpt>Azure preview portal<ept id=\"p1\">](https://portal.azure.com)</ept> should show three new databases in your v12 server:"
    },
    {
      "content": "![Visual Studio confirmation][2]",
      "pos": [
        2294,
        2326
      ]
    },
    {
      "content": "At this point, we will create a custom database collection that reflects all the databases in the shard map.",
      "pos": [
        2332,
        2440
      ]
    },
    {
      "content": "This will allow us to create and execute a job that add a new table across shards.",
      "pos": [
        2441,
        2523
      ]
    },
    {
      "content": "Now here we would usually create a shard map target, using the <bpt id=\"p1\">**</bpt>New-AzureSqlJobTarget<ept id=\"p1\">**</ept> cmdlet.",
      "pos": [
        2525,
        2621
      ]
    },
    {
      "content": "The shard map manager database must be set as a database target and then the specific shard map is specified as a target.",
      "pos": [
        2622,
        2743
      ]
    },
    {
      "content": "Instead, we are going to enumerate all the databases in the server and add the databases to the new custom collection with the exception of master database.",
      "pos": [
        2744,
        2900
      ]
    },
    {
      "content": "Creates a custom collection and adds all databases in the server to the custom collection target with the exception of master.",
      "pos": [
        2904,
        3030
      ]
    },
    {
      "content": "}",
      "pos": [
        4725,
        4726
      ]
    },
    {
      "content": "Create a T-SQL Script for execution across databases",
      "pos": [
        4735,
        4787
      ]
    },
    {
      "content": "Create the job to execute a script across the custom group of databases",
      "pos": [
        5251,
        5322
      ]
    },
    {
      "content": "Execute the job",
      "pos": [
        5702,
        5717
      ]
    },
    {
      "content": "The following PowerShell script can be used to execute an existing job:",
      "pos": [
        5720,
        5791
      ]
    },
    {
      "content": "Update the following variable to reflect the desired job name to have executed:",
      "pos": [
        5793,
        5872
      ]
    },
    {
      "content": "Retrieve the state of a single job execution",
      "pos": [
        6014,
        6058
      ]
    },
    {
      "pos": [
        6060,
        6282
      ],
      "content": "Use the same <bpt id=\"p1\">**</bpt>Get-AzureSqlJobExecution<ept id=\"p1\">**</ept> cmdlet with the <bpt id=\"p2\">**</bpt>IncludeChildren<ept id=\"p2\">**</ept> parameter to view the state of child job executions, namely the specific state for each job execution against each database targeted by the job."
    },
    {
      "content": "View the state across multiple job executions",
      "pos": [
        6459,
        6504
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>Get-AzureSqlJobExecution<ept id=\"p1\">**</ept> cmdlet has multiple optional parameters that can be used to display multiple job executions, filtered through the provided parameters.",
      "pos": [
        6506,
        6673
      ]
    },
    {
      "content": "The following demonstrates some of the possible ways to use Get-AzureSqlJobExecution:",
      "pos": [
        6674,
        6759
      ]
    },
    {
      "content": "Retrieve all active top level job executions:",
      "pos": [
        6761,
        6806
      ]
    },
    {
      "content": "Retrieve all top level job executions, including inactive job executions:",
      "pos": [
        6838,
        6911
      ]
    },
    {
      "content": "Retrieve all child job executions of a provided job execution ID, including inactive job executions:",
      "pos": [
        6960,
        7060
      ]
    },
    {
      "content": "Retrieve all job executions created using a schedule / job combination, including inactive jobs:",
      "pos": [
        7235,
        7331
      ]
    },
    {
      "content": "Retrieve all jobs targeting a specified shard map, including inactive jobs:",
      "pos": [
        7492,
        7567
      ]
    },
    {
      "content": "Retrieve all jobs targeting a specified custom collection, including inactive jobs:",
      "pos": [
        7952,
        8035
      ]
    },
    {
      "content": "Retrieve the list of job task executions within a specific job execution:",
      "pos": [
        8247,
        8320
      ]
    },
    {
      "content": "Retrieve job task execution details:",
      "pos": [
        8489,
        8525
      ]
    },
    {
      "content": "The following PowerShell script can be used to view the details of a job task execution, which is particularly useful when debugging execution failures.",
      "pos": [
        8527,
        8679
      ]
    },
    {
      "content": "Retrieve failures within job task executions",
      "pos": [
        8865,
        8909
      ]
    },
    {
      "content": "The JobTaskExecution object includes a property for the Lifecycle of the task along with a Message property.",
      "pos": [
        8911,
        9019
      ]
    },
    {
      "content": "If a job task execution failed, the Lifecycle property will be set to <bpt id=\"p1\">*</bpt>Failed<ept id=\"p1\">*</ept> and the Message property will be set to the resulting exception message and its stack.",
      "pos": [
        9020,
        9185
      ]
    },
    {
      "content": "If a job did not succeed, it is important to view the details of job tasks that did not succeed for a given job.",
      "pos": [
        9186,
        9298
      ]
    },
    {
      "content": "Waiting for a job execution to complete",
      "pos": [
        9634,
        9673
      ]
    },
    {
      "content": "The following PowerShell script can be used to wait for a job task to complete:",
      "pos": [
        9675,
        9754
      ]
    },
    {
      "content": "Create a custom execution policy",
      "pos": [
        9866,
        9898
      ]
    },
    {
      "content": "Elastic Database jobs supports creating custom execution policies that can be applied when starting jobs.",
      "pos": [
        9900,
        10005
      ]
    },
    {
      "content": "Execution policies currently allow for defining:",
      "pos": [
        10009,
        10057
      ]
    },
    {
      "content": "Name: Identifier for the execution policy.",
      "pos": [
        10061,
        10103
      ]
    },
    {
      "content": "Job Timeout: Total time before a job will be canceled by Elastic Database Jobs.",
      "pos": [
        10106,
        10185
      ]
    },
    {
      "content": "Initial Retry Interval: Interval to wait before first retry.",
      "pos": [
        10188,
        10248
      ]
    },
    {
      "content": "Maximum Retry Interval: Cap of retry intervals to use.",
      "pos": [
        10251,
        10305
      ]
    },
    {
      "content": "Retry Interval Backoff Coefficient: Coefficient used to calculate the next interval between retries.",
      "pos": [
        10308,
        10408
      ]
    },
    {
      "content": "The following formula is used: (Initial Retry Interval) * Math.pow((Interval Backoff Coefficient), (Number of Retries) - 2).",
      "pos": [
        10410,
        10534
      ]
    },
    {
      "content": "Maximum Attempts: The maximum number of retry attempts to perform within a job.",
      "pos": [
        10538,
        10617
      ]
    },
    {
      "content": "The default execution policy uses the following values:",
      "pos": [
        10619,
        10674
      ]
    },
    {
      "content": "Name: Default execution policy",
      "pos": [
        10678,
        10708
      ]
    },
    {
      "content": "Job Timeout: 1 week",
      "pos": [
        10711,
        10730
      ]
    },
    {
      "content": "Initial Retry Interval:  100 milliseconds",
      "pos": [
        10733,
        10774
      ]
    },
    {
      "content": "Maximum Retry Interval: 30 minutes",
      "pos": [
        10777,
        10811
      ]
    },
    {
      "content": "Retry Interval Coefficient: 2",
      "pos": [
        10814,
        10843
      ]
    },
    {
      "content": "Maximum Attempts: 2,147,483,647",
      "pos": [
        10846,
        10877
      ]
    },
    {
      "content": "Create the desired execution policy:",
      "pos": [
        10879,
        10915
      ]
    },
    {
      "content": "Update a custom execution policy",
      "pos": [
        11538,
        11570
      ]
    },
    {
      "content": "Update the desired execution policy to update:",
      "pos": [
        11572,
        11618
      ]
    },
    {
      "content": "Cancel a job",
      "pos": [
        12255,
        12267
      ]
    },
    {
      "content": "Elastic Database Jobs supports cancellation requests of jobs.",
      "pos": [
        12269,
        12330
      ]
    },
    {
      "content": "If Elastic Database Jobs detects a cancellation request for a job currently being executed, it will attempt to stop the job.",
      "pos": [
        12332,
        12456
      ]
    },
    {
      "content": "There are two different ways that Elastic Database Jobs can perform a cancellation:",
      "pos": [
        12458,
        12541
      ]
    },
    {
      "content": "Canceling Currently Executing Tasks: If a cancellation is detected while a task is currently running, a cancellation will be attempted within the currently executing aspect of the task.",
      "pos": [
        12546,
        12731
      ]
    },
    {
      "content": "For example: If there is a long running query currently being performed when a cancellation is attempted, there will be an attempt to cancel the query.",
      "pos": [
        12733,
        12884
      ]
    },
    {
      "content": "Canceling Task Retries: If a cancellation is detected by the control thread before a task is launched for execution, the control thread will avoid launching the task and declare the request as canceled.",
      "pos": [
        12888,
        13090
      ]
    },
    {
      "content": "If a job cancellation is requested for a parent job, the cancellation request will be honored for the parent job and for all of its child jobs.",
      "pos": [
        13092,
        13235
      ]
    },
    {
      "pos": [
        13238,
        13358
      ],
      "content": "To submit a cancellation request, use the <bpt id=\"p1\">**</bpt>Stop-AzureSqlJobExecution<ept id=\"p1\">**</ept> cmdlet and set the <bpt id=\"p2\">**</bpt>JobExecutionId<ept id=\"p2\">**</ept> parameter."
    },
    {
      "content": "Delete a job by name and the job's history",
      "pos": [
        13469,
        13511
      ]
    },
    {
      "content": "Elastic Database jobs supports asynchronous deletion of jobs.",
      "pos": [
        13513,
        13574
      ]
    },
    {
      "content": "A job can be marked for deletion and the system will delete the job and all its job history after all job executions have completed for the job.",
      "pos": [
        13575,
        13719
      ]
    },
    {
      "content": "The system will not automatically cancel active job executions.",
      "pos": [
        13720,
        13783
      ]
    },
    {
      "content": "Instead, Stop-AzureSqlJobExecution must be invoked to cancel active job executions.",
      "pos": [
        13787,
        13870
      ]
    },
    {
      "pos": [
        13872,
        13969
      ],
      "content": "To trigger job deletion, use the <bpt id=\"p1\">**</bpt>Remove-AzureSqlJob<ept id=\"p1\">**</ept> cmdlet and set the <bpt id=\"p2\">**</bpt>JobName<ept id=\"p2\">**</ept> parameter."
    },
    {
      "content": "Create a custom database target",
      "pos": [
        14045,
        14076
      ]
    },
    {
      "content": "Custom database targets can be defined in Elastic Database jobs which can be used either for execution directly or for inclusion within a custom database group.",
      "pos": [
        14077,
        14237
      ]
    },
    {
      "content": "Since <bpt id=\"p1\">**</bpt>Elastic Database pools<ept id=\"p1\">**</ept> are not yet directly supported via the PowerShell APIs, you simply create a custom database target and custom database collection target which encompasses all the databases in the pool.",
      "pos": [
        14238,
        14456
      ]
    },
    {
      "content": "Set the following variables to reflect the desired database information:",
      "pos": [
        14458,
        14530
      ]
    },
    {
      "content": "Create a custom database collection target",
      "pos": [
        14711,
        14753
      ]
    },
    {
      "content": "A custom database collection target can be defined to enable execution across multiple defined database targets.",
      "pos": [
        14754,
        14866
      ]
    },
    {
      "content": "After a database group is created, databases can be associated to the custom collection target.",
      "pos": [
        14867,
        14962
      ]
    },
    {
      "content": "Set the following variables to reflect the desired custom collection target configuration:",
      "pos": [
        14964,
        15054
      ]
    },
    {
      "content": "Add databases to a custom database collection target",
      "pos": [
        15196,
        15248
      ]
    },
    {
      "content": "Database targets can be associated with custom database collection targets to create a group of databases.",
      "pos": [
        15250,
        15356
      ]
    },
    {
      "content": "Whenever a job is created that targets a custom database collection target, it will be expanded to target the databases associated to the group at the time of execution.",
      "pos": [
        15357,
        15526
      ]
    },
    {
      "content": "Add the desired database to a specific custom collection:",
      "pos": [
        15528,
        15585
      ]
    },
    {
      "content": "Review the databases within a custom database collection target",
      "pos": [
        15874,
        15937
      ]
    },
    {
      "pos": [
        15939,
        16055
      ],
      "content": "Use the <bpt id=\"p1\">**</bpt>Get-AzureSqlJobTarget<ept id=\"p1\">**</ept> cmdlet to retrieve the child databases within a custom database collection target."
    },
    {
      "content": "Create a job to execute a script across a custom database collection target",
      "pos": [
        16314,
        16389
      ]
    },
    {
      "content": "Use the <bpt id=\"p1\">**</bpt>New-AzureSqlJob<ept id=\"p1\">**</ept> cmdlet to create a job against a group of databases defined by a custom database collection target.",
      "pos": [
        16391,
        16518
      ]
    },
    {
      "content": "Elastic Database jobs will expand the job into multiple child jobs each corresponding to a database associated with the custom database collection target and ensure that the script is executed against each database.",
      "pos": [
        16519,
        16734
      ]
    },
    {
      "content": "Again, it is important that scripts are idempotent to be resilient to retries.",
      "pos": [
        16735,
        16813
      ]
    },
    {
      "content": "Data collection across databases",
      "pos": [
        17209,
        17241
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Elastic Database jobs<ept id=\"p1\">**</ept> supports executing a query across a group of databases and sends the results to a specified database’s table.",
      "pos": [
        17243,
        17378
      ]
    },
    {
      "content": "The table can be queried after the fact to see the query’s results from each database.",
      "pos": [
        17379,
        17465
      ]
    },
    {
      "content": "This provides an asynchronous mechanism to execute a query across many databases.",
      "pos": [
        17466,
        17547
      ]
    },
    {
      "content": "Failure cases such as one of the databases being temporarily unavailable are handled automatically via retries.",
      "pos": [
        17548,
        17659
      ]
    },
    {
      "content": "The specified destination table will be automatically created if it does not yet exist matching the schema of the returned result set.",
      "pos": [
        17661,
        17795
      ]
    },
    {
      "content": "If a script execution returns multiple result sets, Elastic Database jobs will only send the first one to the provided destination table.",
      "pos": [
        17796,
        17933
      ]
    },
    {
      "content": "The following PowerShell script can be used to execute a script collecting its results into a specified table.",
      "pos": [
        17935,
        18045
      ]
    },
    {
      "content": "This script assumes that a T-SQL script has been created which outputs a single result set and a custom database collection target has been created.",
      "pos": [
        18046,
        18194
      ]
    },
    {
      "content": "Set the following to reflect the desired script, credentials, and execution target:",
      "pos": [
        18196,
        18279
      ]
    },
    {
      "content": "Create and start a job for data collection scenarios",
      "pos": [
        18839,
        18891
      ]
    },
    {
      "content": "Create a schedule for job execution using a job trigger",
      "pos": [
        19437,
        19492
      ]
    },
    {
      "content": "The following PowerShell script can be used to create a reoccurring schedule.",
      "pos": [
        19494,
        19571
      ]
    },
    {
      "content": "This script uses a minute interval, but New-AzureSqlJobSchedule also supports -DayInterval, -HourInterval, -MonthInterval, and -WeekInterval parameters.",
      "pos": [
        19572,
        19724
      ]
    },
    {
      "content": "Schedules that execute only once can be created by passing -OneTime.",
      "pos": [
        19725,
        19793
      ]
    },
    {
      "content": "Create a new schedule:",
      "pos": [
        19795,
        19817
      ]
    },
    {
      "content": "Create a job trigger to have a job executed on a time schedule",
      "pos": [
        20083,
        20145
      ]
    },
    {
      "content": "A job trigger can be defined to have a job executed according to a time schedule.",
      "pos": [
        20147,
        20228
      ]
    },
    {
      "content": "The following PowerShell script can be used to create a job trigger.",
      "pos": [
        20229,
        20297
      ]
    },
    {
      "content": "Set the following variables to correspond to the desired job and schedule:",
      "pos": [
        20299,
        20373
      ]
    },
    {
      "content": "Remove a scheduled association to stop job from executing on schedule",
      "pos": [
        20562,
        20631
      ]
    },
    {
      "content": "To discontinue reoccurring job execution through a job trigger, the job trigger can be removed.",
      "pos": [
        20633,
        20728
      ]
    },
    {
      "content": "Remove a job trigger to stop a job from being executed according to a schedule using the <bpt id=\"p1\">**</bpt>Remove-AzureSqlJobTrigger<ept id=\"p1\">**</ept> cmdlet.",
      "pos": [
        20730,
        20856
      ]
    },
    {
      "content": "Import elastic database query results to Excel",
      "pos": [
        21008,
        21054
      ]
    },
    {
      "content": "You can import the results from of a query to an Excel file.",
      "pos": [
        21057,
        21117
      ]
    },
    {
      "content": "Launch Excel 2013.",
      "pos": [
        21122,
        21140
      ]
    },
    {
      "pos": [
        21145,
        21177
      ],
      "content": "Navigate to the <bpt id=\"p1\">**</bpt>Data<ept id=\"p1\">**</ept> ribbon."
    },
    {
      "pos": [
        21182,
        21241
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>From Other Sources<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>From SQL Server<ept id=\"p2\">**</ept>."
    },
    {
      "content": "![Excel import from other sources][5]",
      "pos": [
        21247,
        21284
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Data Connection Wizard<ept id=\"p1\">**</ept> type the server name and login credentials.",
      "pos": [
        21289,
        21366
      ]
    },
    {
      "content": "Then click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>.",
      "pos": [
        21367,
        21387
      ]
    },
    {
      "pos": [
        21392,
        21506
      ],
      "content": "In the dialog box <bpt id=\"p1\">**</bpt>Select the database that contains the data you want<ept id=\"p1\">**</ept>, select the <bpt id=\"p2\">**</bpt>ElasticDBQuery<ept id=\"p2\">**</ept> database."
    },
    {
      "content": "Select the <bpt id=\"p1\">**</bpt>Customers<ept id=\"p1\">**</ept> table in the list view and click <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>.",
      "pos": [
        21511,
        21578
      ]
    },
    {
      "content": "Then click <bpt id=\"p1\">**</bpt>Finish<ept id=\"p1\">**</ept>.",
      "pos": [
        21579,
        21601
      ]
    },
    {
      "pos": [
        21606,
        21735
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Import Data<ept id=\"p1\">**</ept> form, under <bpt id=\"p2\">**</bpt>Select how you want to view this data in your workbook<ept id=\"p2\">**</ept>, select <bpt id=\"p3\">**</bpt>Table<ept id=\"p3\">**</ept> and click <bpt id=\"p4\">**</bpt>OK<ept id=\"p4\">**</ept>."
    },
    {
      "pos": [
        21737,
        21828
      ],
      "content": "All the rows from <bpt id=\"p1\">**</bpt>Customers<ept id=\"p1\">**</ept> table, stored in different shards populate the Excel sheet."
    },
    {
      "content": "Next steps",
      "pos": [
        21833,
        21843
      ]
    },
    {
      "content": "You can now use Excel’s powerful data functions.",
      "pos": [
        21844,
        21892
      ]
    },
    {
      "content": "You can use the connection string with your server name, database name and credentials to connect your BI and data integration tools to the elastic query database.",
      "pos": [
        21893,
        22056
      ]
    },
    {
      "content": "Make sure that SQL Server is supported as a data source for your tool.",
      "pos": [
        22057,
        22127
      ]
    },
    {
      "content": "You can refer to the elastic query database and external tables just like any other SQL Server database and SQL Server tables that you would connect to with your tool.",
      "pos": [
        22128,
        22295
      ]
    },
    {
      "content": "Cost",
      "pos": [
        22301,
        22305
      ]
    },
    {
      "content": "There is no additional charge for using the Elastic Database Query feature.",
      "pos": [
        22306,
        22381
      ]
    },
    {
      "content": "However, at this time this feature is available only on premium databases as an end point, but the shards can be of any service tier.",
      "pos": [
        22382,
        22515
      ]
    },
    {
      "pos": [
        22517,
        22634
      ],
      "content": "For pricing information see <bpt id=\"p1\">[</bpt>SQL Database Pricing Details<ept id=\"p1\">](http://azure.microsoft.com/pricing/details/sql-database/)</ept>."
    }
  ],
  "content": "<properties\n    title=\"Getting started with elastic database jobs\"\n    pageTitle=\"Getting started with elastic database jobs\"\n    description=\"how to use elastic database jobs\"\n    metaKeywords=\"azure sql database elastic jobs\"\n    services=\"sql-database\"\n    documentationCenter=\"\"  \n    manager=\"jeffreyg\"\n    authors=\"sidneyh\"/>\n\n<tags\n    ms.service=\"sql-database\"\n    ms.workload=\"sql-database\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.date=\"08/04/2015\"\n    ms.author=\"sidneyh; ddove\" />\n\n# Getting started with Elastic Database jobs\n\nElastic Database jobs (preview) for Azure SQL Database allows you to reliability execute T-SQL scripts that span multiple databases while automatically retrying and providing eventual completion guarantees. For more information about the Elastic Database job feature, please see the [feature overview page](sql-database-elastic-jobs-overview.md).\n\nThis topic extends the sample found in [Getting started with Elastic Database tools](sql-database-elastic-scale-get-started.md). When completed, you will: learn how to create and manage jobs that manage a group of related databases.\n\n## Prerequisites\n\nDownload and run the [Getting started with Elastic Database tools sample](sql-database-elastic-scale-get-started.md).\n\n## Create a shard map manager using the sample app\n\nHere you will create a shard map manager along with several shards, followed by insertion of data into the shards. If you happen to already have shards setup with sharded data in them, you can skip the following steps and move to the next section.\n\n1. Build and run the **Getting started with Elastic Database tools** sample application. Follow the steps until step 7 in the section [Download and run the sample app](sql-database-elastic-scale-get-started.md#Getting-started-with-elastic-database-tools). At the end of Step 7, you will see the following command prompt:\n\n    ![command prompt][1]\n\n2.  In the command window, type \"1\" and press **Enter**. This creates the shard map manager, and adds two shards to the server. Then type \"3\" and press **Enter**; repeat the action four times. This inserts sample data rows in your shards.\n\n3.  The [Azure preview portal](https://portal.azure.com) should show three new databases in your v12 server:\n\n    ![Visual Studio confirmation][2]\n\n    At this point, we will create a custom database collection that reflects all the databases in the shard map. This will allow us to create and execute a job that add a new table across shards.\n\nNow here we would usually create a shard map target, using the **New-AzureSqlJobTarget** cmdlet. The shard map manager database must be set as a database target and then the specific shard map is specified as a target. Instead, we are going to enumerate all the databases in the server and add the databases to the new custom collection with the exception of master database.\n\n##Creates a custom collection and adds all databases in the server to the custom collection target with the exception of master.\n\n\n    $customCollectionName = \"dbs_in_server\"\n    New-AzureSqlJobTarget -CustomCollectionName $customCollectionName \n    $ResourceGroupName = \"ddove_samples\"\n    $ServerName = \"samples\"\n    $dbsinserver = Get-AzureSqlDatabase -ResourceGroupName $ResourceGroupName -ServerName $ServerName \n    $dbsinserver | %{\n    $currentdb = $_.DatabaseName \n    $ErrorActionPreference = \"Stop\"\n    Write-Output \"\"\n\n    Try\n    {\n       New-AzureSqlJobTarget -ServerName $ServerName -DatabaseName $currentdb | Write-Output\n    }\n    Catch \n    {\n        $ErrorMessage = $_.Exception.Message\n        $ErrorCategory = $_.CategoryInfo.Reason\n                \n        if ($ErrorCategory -eq 'UniqueConstraintViolatedException')\n        {\n             Write-Host $currentdb \"is already a database target.\" \n        }\n\n        else\n        {\n            throw $_\n        }\n    \n    }\n\n    Try\n    {\n        if ($currentdb -eq \"master\")\n        {\n            Write-Host $currentdb \"will not be added custom collection target\" $CustomCollectionName \".\"\n        }\n\n        else\n        {\n            Add-AzureSqlJobChildTarget -CustomCollectionName $CustomCollectionName -ServerName $ServerName -DatabaseName $currentdb\n            Write-Host $currentdb \"was added to\" $CustomCollectionName \".\"\n        }\n\n    }\n    Catch \n    {\n        $ErrorMessage = $_.Exception.Message\n        $ErrorCategory = $_.CategoryInfo.Reason\n\n        if ($ErrorCategory -eq 'UniqueConstraintViolatedException')\n        {\n             Write-Host $currentdb \"is already in the custom collection target\" $CustomCollectionName\".\"\n        }\n\n        else\n        {\n            throw $_\n        }\n    }\n    $ErrorActionPreference = \"Continue\"\n}\n    \n## Create a T-SQL Script for execution across databases\n\n    $scriptName = \"NewTable\"\n    $scriptCommandText = \"\n    IF NOT EXISTS (SELECT name FROM sys.tables WHERE name = 'Test')\n    BEGIN\n        CREATE TABLE Test(\n            TestId INT PRIMARY KEY IDENTITY,\n            InsertionTime DATETIME2\n        );\n    END\n    GO\n    INSERT INTO Test(InsertionTime) VALUES (sysutcdatetime());\n    GO\"\n\n    $script = New-AzureSqlJobContent -ContentName $scriptName -CommandText $scriptCommandText\n    Write-Output $script\n\n##Create the job to execute a script across the custom group of databases\n\n    $jobName = \"create on server dbs\"\n    $scriptName = \"NewTable\"\n    $customCollectionName = \"dbs_in_server\"\n    $credentialName = \"ddove66\"\n    $target = Get-AzureSqlJobTarget -CustomCollectionName $customCollectionName\n    $job = New-AzureSqlJob -JobName $jobName -CredentialName $credentialName -ContentName $scriptName -TargetId $target.TargetId\n    Write-Output $job\n\n\n##Execute the job \n\nThe following PowerShell script can be used to execute an existing job:\n\nUpdate the following variable to reflect the desired job name to have executed:\n\n    $jobName = \"create on server dbs\"\n    $jobExecution = Start-AzureSqlJobExecution -JobName $jobName \n    Write-Output $jobExecution\n \n## Retrieve the state of a single job execution\n\nUse the same **Get-AzureSqlJobExecution** cmdlet with the **IncludeChildren** parameter to view the state of child job executions, namely the specific state for each job execution against each database targeted by the job.\n\n    $jobExecutionId = \"{Job Execution Id}\"\n    $jobExecutions = Get-AzureSqlJobExecution -JobExecutionId $jobExecutionId -IncludeChildren\n    Write-Output $jobExecutions \n\n## View the state across multiple job executions\n\nThe **Get-AzureSqlJobExecution** cmdlet has multiple optional parameters that can be used to display multiple job executions, filtered through the provided parameters. The following demonstrates some of the possible ways to use Get-AzureSqlJobExecution:\n\nRetrieve all active top level job executions:\n\n    Get-AzureSqlJobExecution\n\nRetrieve all top level job executions, including inactive job executions:\n\n    Get-AzureSqlJobExecution -IncludeInactive\n\nRetrieve all child job executions of a provided job execution ID, including inactive job executions:\n\n    $parentJobExecutionId = \"{Job Execution Id}\"\n    Get-AzureSqlJobExecution -AzureSqlJobExecution -JobExecutionId $parentJobExecutionId –IncludeInactive -IncludeChildren\n\nRetrieve all job executions created using a schedule / job combination, including inactive jobs:\n\n    $jobName = \"{Job Name}\"\n    $scheduleName = \"{Schedule Name}\"\n    Get-AzureSqlJobExecution -JobName $jobName -ScheduleName $scheduleName -IncludeInactive\n\nRetrieve all jobs targeting a specified shard map, including inactive jobs:\n\n    $shardMapServerName = \"{Shard Map Server Name}\"\n    $shardMapDatabaseName = \"{Shard Map Database Name}\"\n    $shardMapName = \"{Shard Map Name}\"\n    $target = Get-AzureSqlJobTarget -ShardMapManagerDatabaseName $shardMapDatabaseName -ShardMapManagerServerName $shardMapServerName -ShardMapName $shardMapName\n    Get-AzureSqlJobExecution -TargetId $target.TargetId –IncludeInactive\n\nRetrieve all jobs targeting a specified custom collection, including inactive jobs:\n\n    $customCollectionName = \"{Custom Collection Name}\"\n    $target = Get-AzureSqlJobTarget -CustomCollectionName $customCollectionName\n    Get-AzureSqlJobExecution -TargetId $target.TargetId –IncludeInactive\n \nRetrieve the list of job task executions within a specific job execution:\n\n    $jobExecutionId = \"{Job Execution Id}\"\n    $jobTaskExecutions = Get-AzureSqlJobTaskExecution -JobExecutionId $jobExecutionId\n    Write-Output $jobTaskExecutions \n\nRetrieve job task execution details:\n\nThe following PowerShell script can be used to view the details of a job task execution, which is particularly useful when debugging execution failures.\n\n    $jobTaskExecutionId = \"{Job Task Execution Id}\"\n    $jobTaskExecution = Get-AzureSqlJobTaskExecution -JobTaskExecutionId $jobTaskExecutionId\n    Write-Output $jobTaskExecution\n\n## Retrieve failures within job task executions\n\nThe JobTaskExecution object includes a property for the Lifecycle of the task along with a Message property. If a job task execution failed, the Lifecycle property will be set to *Failed* and the Message property will be set to the resulting exception message and its stack. If a job did not succeed, it is important to view the details of job tasks that did not succeed for a given job.\n\n    $jobExecutionId = \"{Job Execution Id}\"\n    $jobTaskExecutions = Get-AzureSqlJobTaskExecution -JobExecutionId $jobExecutionId\n    Foreach($jobTaskExecution in $jobTaskExecutions) \n        {\n        if($jobTaskExecution.Lifecycle -ne 'Succeeded')\n            {\n            Write-Output $jobTaskExecution\n            }\n        }\n\n## Waiting for a job execution to complete\n\nThe following PowerShell script can be used to wait for a job task to complete:\n\n    $jobExecutionId = \"{Job Execution Id}\"\n    Wait-AzureSqlJobExecution -JobExecutionId $jobExecutionId \n\n## Create a custom execution policy\n\nElastic Database jobs supports creating custom execution policies that can be applied when starting jobs.\n  \nExecution policies currently allow for defining:\n\n* Name: Identifier for the execution policy.\n* Job Timeout: Total time before a job will be canceled by Elastic Database Jobs.\n* Initial Retry Interval: Interval to wait before first retry.\n* Maximum Retry Interval: Cap of retry intervals to use.\n* Retry Interval Backoff Coefficient: Coefficient used to calculate the next interval between retries.  The following formula is used: (Initial Retry Interval) * Math.pow((Interval Backoff Coefficient), (Number of Retries) - 2). \n* Maximum Attempts: The maximum number of retry attempts to perform within a job.\n\nThe default execution policy uses the following values:\n\n* Name: Default execution policy\n* Job Timeout: 1 week\n* Initial Retry Interval:  100 milliseconds\n* Maximum Retry Interval: 30 minutes\n* Retry Interval Coefficient: 2\n* Maximum Attempts: 2,147,483,647\n\nCreate the desired execution policy:\n\n    $executionPolicyName = \"{Execution Policy Name}\"\n    $initialRetryInterval = New-TimeSpan -Seconds 10\n    $jobTimeout = New-TimeSpan -Minutes 30\n    $maximumAttempts = 999999\n    $maximumRetryInterval = New-TimeSpan -Minutes 1\n    $retryIntervalBackoffCoefficient = 1.5\n    $executionPolicy = New-AzureSqlJobExecutionPolicy -ExecutionPolicyName $executionPolicyName -InitialRetryInterval $initialRetryInterval -JobTimeout $jobTimeout -MaximumAttempts $maximumAttempts -MaximumRetryInterval $maximumRetryInterval -RetryIntervalBackoffCoefficient $retryIntervalBackoffCoefficient\n    Write-Output $executionPolicy\n\n### Update a custom execution policy\n\nUpdate the desired execution policy to update:\n\n    $executionPolicyName = \"{Execution Policy Name}\"\n    $initialRetryInterval = New-TimeSpan -Seconds 15\n    $jobTimeout = New-TimeSpan -Minutes 30\n    $maximumAttempts = 999999\n    $maximumRetryInterval = New-TimeSpan -Minutes 1\n    $retryIntervalBackoffCoefficient = 1.5\n    $updatedExecutionPolicy = Set-AzureSqlJobExecutionPolicy -ExecutionPolicyName $executionPolicyName -InitialRetryInterval $initialRetryInterval -JobTimeout $jobTimeout -MaximumAttempts $maximumAttempts -MaximumRetryInterval $maximumRetryInterval -RetryIntervalBackoffCoefficient $retryIntervalBackoffCoefficient\n    Write-Output $updatedExecutionPolicy\n \n## Cancel a job\n\nElastic Database Jobs supports cancellation requests of jobs.  If Elastic Database Jobs detects a cancellation request for a job currently being executed, it will attempt to stop the job.\n\nThere are two different ways that Elastic Database Jobs can perform a cancellation:\n\n1. Canceling Currently Executing Tasks: If a cancellation is detected while a task is currently running, a cancellation will be attempted within the currently executing aspect of the task.  For example: If there is a long running query currently being performed when a cancellation is attempted, there will be an attempt to cancel the query.\n2. Canceling Task Retries: If a cancellation is detected by the control thread before a task is launched for execution, the control thread will avoid launching the task and declare the request as canceled.\n\nIf a job cancellation is requested for a parent job, the cancellation request will be honored for the parent job and for all of its child jobs.\n \nTo submit a cancellation request, use the **Stop-AzureSqlJobExecution** cmdlet and set the **JobExecutionId** parameter.\n\n    $jobExecutionId = \"{Job Execution Id}\"\n    Stop-AzureSqlJobExecution -JobExecutionId $jobExecutionId\n\n## Delete a job by name and the job's history\n\nElastic Database jobs supports asynchronous deletion of jobs. A job can be marked for deletion and the system will delete the job and all its job history after all job executions have completed for the job. The system will not automatically cancel active job executions.  \n\nInstead, Stop-AzureSqlJobExecution must be invoked to cancel active job executions.\n\nTo trigger job deletion, use the **Remove-AzureSqlJob** cmdlet and set the **JobName** parameter.\n\n    $jobName = \"{Job Name}\"\n    Remove-AzureSqlJob -JobName $jobName\n \n## Create a custom database target\nCustom database targets can be defined in Elastic Database jobs which can be used either for execution directly or for inclusion within a custom database group. Since **Elastic Database pools** are not yet directly supported via the PowerShell APIs, you simply create a custom database target and custom database collection target which encompasses all the databases in the pool.\n\nSet the following variables to reflect the desired database information:\n\n    $databaseName = \"{Database Name}\"\n    $databaseServerName = \"{Server Name}\"\n    New-AzureSqlJobDatabaseTarget -DatabaseName $databaseName -ServerName $databaseServerName \n\n## Create a custom database collection target\nA custom database collection target can be defined to enable execution across multiple defined database targets. After a database group is created, databases can be associated to the custom collection target.\n\nSet the following variables to reflect the desired custom collection target configuration:\n\n    $customCollectionName = \"{Custom Database Collection Name}\"\n    New-AzureSqlJobTarget -CustomCollectionName $customCollectionName \n\n### Add databases to a custom database collection target\n\nDatabase targets can be associated with custom database collection targets to create a group of databases. Whenever a job is created that targets a custom database collection target, it will be expanded to target the databases associated to the group at the time of execution.\n\nAdd the desired database to a specific custom collection:\n\n    $serverName = \"{Database Server Name}\"\n    $databaseName = \"{Database Name}\"\n    $customCollectionName = \"{Custom Database Collection Name}\"\n    Add-AzureSqlJobChildTarget -CustomCollectionName $customCollectionName -DatabaseName $databaseName -ServerName $databaseServerName \n\n#### Review the databases within a custom database collection target\n\nUse the **Get-AzureSqlJobTarget** cmdlet to retrieve the child databases within a custom database collection target. \n \n    $customCollectionName = \"{Custom Database Collection Name}\"\n    $target = Get-AzureSqlJobTarget -CustomCollectionName $customCollectionName\n    $childTargets = Get-AzureSqlJobTarget -ParentTargetId $target.TargetId\n    Write-Output $childTargets\n\n### Create a job to execute a script across a custom database collection target\n\nUse the **New-AzureSqlJob** cmdlet to create a job against a group of databases defined by a custom database collection target. Elastic Database jobs will expand the job into multiple child jobs each corresponding to a database associated with the custom database collection target and ensure that the script is executed against each database. Again, it is important that scripts are idempotent to be resilient to retries.\n\n    $jobName = \"{Job Name}\"\n    $scriptName = \"{Script Name}\"\n    $customCollectionName = \"{Custom Collection Name}\"\n    $credentialName = \"{Credential Name}\"\n    $target = Get-AzureSqlJobTarget -CustomCollectionName $customCollectionName\n    $job = New-AzureSqlJob -JobName $jobName -CredentialName $credentialName -ContentName $scriptName -TargetId $target.TargetId\n    Write-Output $job\n\n## Data collection across databases\n\n**Elastic Database jobs** supports executing a query across a group of databases and sends the results to a specified database’s table. The table can be queried after the fact to see the query’s results from each database. This provides an asynchronous mechanism to execute a query across many databases. Failure cases such as one of the databases being temporarily unavailable are handled automatically via retries.\n\nThe specified destination table will be automatically created if it does not yet exist matching the schema of the returned result set. If a script execution returns multiple result sets, Elastic Database jobs will only send the first one to the provided destination table.\n\nThe following PowerShell script can be used to execute a script collecting its results into a specified table. This script assumes that a T-SQL script has been created which outputs a single result set and a custom database collection target has been created.\n\nSet the following to reflect the desired script, credentials, and execution target:\n\n    $jobName = \"{Job Name}\"\n    $scriptName = \"{Script Name}\"\n    $executionCredentialName = \"{Execution Credential Name}\"\n    $customCollectionName = \"{Custom Collection Name}\"\n    $destinationCredentialName = \"{Destination Credential Name}\"\n    $destinationServerName = \"{Destination Server Name}\"\n    $destinationDatabaseName = \"{Destination Database Name}\"\n    $destinationSchemaName = \"{Destination Schema Name}\"\n    $destinationTableName = \"{Destination Table Name}\"\n    $target = Get-AzureSqlJobTarget -CustomCollectionName $customCollectionName\n\n### Create and start a job for data collection scenarios\n    $job = New-AzureSqlJob -JobName $jobName -CredentialName $executionCredentialName -ContentName $scriptName -ResultSetDestinationServerName $destinationServerName -ResultSetDestinationDatabaseName $destinationDatabaseName -ResultSetDestinationSchemaName $destinationSchemaName -ResultSetDestinationTableName $destinationTableName -ResultSetDestinationCredentialName $destinationCredentialName -TargetId $target.TargetId\n    Write-Output $job\n    $jobExecution = Start-AzureSqlJobExecution -JobName $jobName\n    Write-Output $jobExecution\n\n## Create a schedule for job execution using a job trigger\n\nThe following PowerShell script can be used to create a reoccurring schedule. This script uses a minute interval, but New-AzureSqlJobSchedule also supports -DayInterval, -HourInterval, -MonthInterval, and -WeekInterval parameters. Schedules that execute only once can be created by passing -OneTime.\n\nCreate a new schedule:\n\n    $scheduleName = \"Every one minute\"\n    $minuteInterval = 1\n    $startTime = (Get-Date).ToUniversalTime()\n    $schedule = New-AzureSqlJobSchedule -MinuteInterval $minuteInterval -ScheduleName $scheduleName -StartTime $startTime \n    Write-Output $schedule\n\n### Create a job trigger to have a job executed on a time schedule\n\nA job trigger can be defined to have a job executed according to a time schedule. The following PowerShell script can be used to create a job trigger.\n\nSet the following variables to correspond to the desired job and schedule:\n\n    $jobName = \"{Job Name}\"\n    $scheduleName = \"{Schedule Name}\"\n    $jobTrigger = New-AzureSqlJobTrigger -ScheduleName $scheduleName –JobName $jobName\n    Write-Output $jobTrigger\n\n### Remove a scheduled association to stop job from executing on schedule\n\nTo discontinue reoccurring job execution through a job trigger, the job trigger can be removed. \nRemove a job trigger to stop a job from being executed according to a schedule using the **Remove-AzureSqlJobTrigger** cmdlet.\n\n    $jobName = \"{Job Name}\"\n    $scheduleName = \"{Schedule Name}\"\n    Remove-AzureSqlJobTrigger -ScheduleName $scheduleName -JobName $jobName\n\n\n\n\n\n## Import elastic database query results to Excel\n\n You can import the results from of a query to an Excel file.\n\n1. Launch Excel 2013.\n2.  Navigate to the **Data** ribbon.\n3.  Click **From Other Sources** and click **From SQL Server**.\n\n    ![Excel import from other sources][5]\n4.  In the **Data Connection Wizard** type the server name and login credentials. Then click **Next**.\n5.  In the dialog box **Select the database that contains the data you want**, select the **ElasticDBQuery** database.\n6.  Select the **Customers** table in the list view and click **Next**. Then click **Finish**.\n7.  In the **Import Data** form, under **Select how you want to view this data in your workbook**, select **Table** and click **OK**.\n\nAll the rows from **Customers** table, stored in different shards populate the Excel sheet.\n\n## Next steps\nYou can now use Excel’s powerful data functions. You can use the connection string with your server name, database name and credentials to connect your BI and data integration tools to the elastic query database. Make sure that SQL Server is supported as a data source for your tool. You can refer to the elastic query database and external tables just like any other SQL Server database and SQL Server tables that you would connect to with your tool.\n\n### Cost\nThere is no additional charge for using the Elastic Database Query feature. However, at this time this feature is available only on premium databases as an end point, but the shards can be of any service tier.\n\nFor pricing information see [SQL Database Pricing Details](http://azure.microsoft.com/pricing/details/sql-database/).\n\n\n[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]\n\n<!--Image references-->\n[1]: ./media/sql-database-elastic-query-getting-started/cmd-prompt.png\n[2]: ./media/sql-database-elastic-query-getting-started/portal.png\n[3]: ./media/sql-database-elastic-query-getting-started/tiers.png\n[4]: ./media/sql-database-elastic-query-getting-started/details.png\n[5]: ./media/sql-database-elastic-query-getting-started/exel-sources.png\n<!--anchors-->\n"
}