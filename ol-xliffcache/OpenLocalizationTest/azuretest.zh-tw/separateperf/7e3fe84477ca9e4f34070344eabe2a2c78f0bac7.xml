{
  "nodes": [
    {
      "content": "Hybrid cloud test environment | Microsoft Azure",
      "pos": [
        28,
        75
      ]
    },
    {
      "content": "Learn how to create a hybrid cloud environment for IT pro or development testing, complete with a simplfied on-premises network.",
      "pos": [
        95,
        223
      ]
    },
    {
      "content": "Set up a hybrid cloud environment for testing",
      "pos": [
        598,
        643
      ]
    },
    {
      "content": "This topic steps you through creating a hybrid cloud environment with Microsoft Azure for testing.",
      "pos": [
        645,
        743
      ]
    },
    {
      "content": "Here is the resulting configuration.",
      "pos": [
        744,
        780
      ]
    },
    {
      "content": "This simulates a real hybrid production environment from your location on the Internet.",
      "pos": [
        880,
        967
      ]
    },
    {
      "content": "It consists of:",
      "pos": [
        968,
        983
      ]
    },
    {
      "content": "A simplified on-premises network (the Corpnet subnet).",
      "pos": [
        988,
        1042
      ]
    },
    {
      "content": "A cross-premises virtual network hosted in Azure (TestVNET).",
      "pos": [
        1046,
        1106
      ]
    },
    {
      "content": "A site-to-site VPN connection.",
      "pos": [
        1110,
        1140
      ]
    },
    {
      "content": "A secondary domain controller in the TestVNET virtual network.",
      "pos": [
        1144,
        1206
      ]
    },
    {
      "content": "This configuration provides a basis and common starting point from which you can:",
      "pos": [
        1208,
        1289
      ]
    },
    {
      "content": "Develop and test applications in a hybrid cloud environment.",
      "pos": [
        1294,
        1354
      ]
    },
    {
      "content": "Create test configurations of computers, some on the Corpnet subnet and some within the TestVNET virtual network, for hybrid cloud-based IT workloads.",
      "pos": [
        1358,
        1508
      ]
    },
    {
      "content": "There are five major phases to setting up this hybrid cloud test environment:",
      "pos": [
        1510,
        1587
      ]
    },
    {
      "content": "Configure the computers on the Corpnet subnet.",
      "pos": [
        1593,
        1639
      ]
    },
    {
      "content": "Configure RRAS1.",
      "pos": [
        1644,
        1660
      ]
    },
    {
      "content": "Create the cross-premises Azure virtual network.",
      "pos": [
        1665,
        1713
      ]
    },
    {
      "content": "Create the site-to-site VPN connection.",
      "pos": [
        1718,
        1757
      ]
    },
    {
      "content": "Configure DC2.",
      "pos": [
        1762,
        1776
      ]
    },
    {
      "content": "If you don't already have an Azure subscription, you can sign up for a free trial at <bpt id=\"p1\">[</bpt>Try Azure<ept id=\"p1\">](http://azure.microsoft.com/pricing/free-trial/)</ept>.",
      "pos": [
        1779,
        1924
      ]
    },
    {
      "content": "If you have an MSDN Subscription, see <bpt id=\"p1\">[</bpt>Azure benefit for MSDN subscribers<ept id=\"p1\">](http://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/)</ept>.",
      "pos": [
        1925,
        2073
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> Virtual machines and virtual network gateways in Azure incur an ongoing monetary cost when they are running.",
      "pos": [
        2076,
        2197
      ]
    },
    {
      "content": "This cost is billed against your free trial, MSDN subscription, or paid subscription.",
      "pos": [
        2198,
        2283
      ]
    },
    {
      "content": "To reduce the costs of running this test environment when you are not using it, see <bpt id=\"p1\">[</bpt>Minimizing the ongoing costs of this environment<ept id=\"p1\">](#costs)</ept> in this topic for more information.",
      "pos": [
        2284,
        2462
      ]
    },
    {
      "content": "This configuration requires a test subnet of up to four computers connected directly to the Internet using a public IP address.",
      "pos": [
        2464,
        2591
      ]
    },
    {
      "content": "If you don't have these resources, you can also <bpt id=\"p1\">[</bpt>Set up a simulated hybrid cloud environment for testing<ept id=\"p1\">](virtual-networks-setup-simulated-hybrid-cloud-environment-testing.md)</ept>.",
      "pos": [
        2592,
        2768
      ]
    },
    {
      "content": "The simulated hybrid cloud test environment requires only an Azure subscription.",
      "pos": [
        2769,
        2849
      ]
    },
    {
      "content": "Phase 1: Configure the computers on the Corpnet subnet",
      "pos": [
        2854,
        2908
      ]
    },
    {
      "content": "Use the instructions in the \"Steps for Configuring the Corpnet Subnet\" section of the <bpt id=\"p1\">[</bpt>Test Lab Guide: Base Configuration for Windows Server 2012 R2<ept id=\"p1\">](http://www.microsoft.com/download/details.aspx?id=39638)</ept> to configure the DC1, APP1, and CLIENT1 computers on a subnet named Corpnet.",
      "pos": [
        2910,
        3193
      ]
    },
    {
      "content": "This subnet must be isolated from your organization network because it will be connected directly to the Internet through the RRAS1 computer.",
      "pos": [
        3196,
        3337
      ]
    },
    {
      "content": "**",
      "pos": [
        3337,
        3339
      ]
    },
    {
      "content": "Next, log on to DC1 with the CORP\\User1 credentials.",
      "pos": [
        3342,
        3394
      ]
    },
    {
      "content": "To configure the CORP domain so that computers and users use their local domain controller for authentication, run these commands from an administrator-level Windows PowerShell command prompt.",
      "pos": [
        3395,
        3587
      ]
    },
    {
      "content": "This is your current configuration.",
      "pos": [
        3806,
        3841
      ]
    },
    {
      "content": "Phase 2: Configure RRAS1",
      "pos": [
        3945,
        3969
      ]
    },
    {
      "content": "RRAS1 provides traffic routing and VPN device services between the computers on the Corpnet subnet and the TestVNET virtual network.",
      "pos": [
        3971,
        4103
      ]
    },
    {
      "content": "RRAS1 must have two network adapters installed.",
      "pos": [
        4104,
        4151
      ]
    },
    {
      "content": "First, install the operating system on RRAS1.",
      "pos": [
        4153,
        4198
      ]
    },
    {
      "content": "Start the installation of Windows Server 2012 R2.",
      "pos": [
        4204,
        4253
      ]
    },
    {
      "content": "Follow the instructions to complete the installation, specifying a strong password for the local administrator account.",
      "pos": [
        4258,
        4377
      ]
    },
    {
      "content": "Log on using the local administrator account.",
      "pos": [
        4378,
        4423
      ]
    },
    {
      "content": "Connect RRAS1 to a network that has Internet access and run Windows Update to install the latest updates for Windows Server 2012 R2.",
      "pos": [
        4428,
        4560
      ]
    },
    {
      "content": "Connect one network adapter to the Corpnet subnet and the other directly to the Internet.",
      "pos": [
        4565,
        4654
      ]
    },
    {
      "content": "RRAS1 can be located behind an Internet firewall but must not be behind a network address translator (NAT).",
      "pos": [
        4655,
        4762
      ]
    },
    {
      "content": "Next, configure the TCP/IP properties of RRAS1.",
      "pos": [
        4764,
        4811
      ]
    },
    {
      "content": "You will need a public IP address configuration, including an address, subnet mask (or prefix length), and the default gateway and DNS servers of your Internet service provider (ISP).",
      "pos": [
        4812,
        4995
      ]
    },
    {
      "content": "Use these commands at an administrator-level Windows PowerShell command prompt on RRAS1.",
      "pos": [
        4997,
        5085
      ]
    },
    {
      "content": "Prior to running these commands, fill in the variable values and remove the &lt; and &gt; characters.",
      "pos": [
        5086,
        5181
      ]
    },
    {
      "content": "You can get the current names of the network adapters from the display of the <bpt id=\"p1\">**</bpt>Get-NetAdapter<ept id=\"p1\">**</ept> command.",
      "pos": [
        5182,
        5287
      ]
    },
    {
      "content": "For the last command, verify that there are four responses from the IP address 10.0.0.1.",
      "pos": [
        6624,
        6712
      ]
    },
    {
      "content": "This is your current configuration.",
      "pos": [
        6714,
        6749
      ]
    },
    {
      "content": "Phase 3: Create the cross-premises Azure Virtual Network",
      "pos": [
        6852,
        6908
      ]
    },
    {
      "pos": [
        6910,
        7076
      ],
      "content": "First, log on to the <bpt id=\"p1\">[</bpt>Azure Management Portal<ept id=\"p1\">](https://manage.windowsazure.com/)</ept> with your Azure subscription credentials and create a virtual network named TestVNET."
    },
    {
      "pos": [
        7082,
        7197
      ],
      "content": "In the task bar of the Azure Management Portal, click <bpt id=\"p1\">**</bpt>New &gt; Network Services &gt; Virtual Network &gt; Custom Create<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        7202,
        7269
      ],
      "content": "On the Virtual Network Details page, type <bpt id=\"p1\">**</bpt>TestVNET<ept id=\"p1\">**</ept> in <bpt id=\"p2\">**</bpt>Name<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        7274,
        7343
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Location<ept id=\"p1\">**</ept>, select the appropriate datacenter for your location."
    },
    {
      "content": "Click the Next arrow.",
      "pos": [
        7348,
        7369
      ]
    },
    {
      "pos": [
        7374,
        7568
      ],
      "content": "On the DNS Servers and VPN Connectivity page, in <bpt id=\"p1\">**</bpt>DNS servers<ept id=\"p1\">**</ept>, type <bpt id=\"p2\">**</bpt>DC1<ept id=\"p2\">**</ept> in <bpt id=\"p3\">**</bpt>Select or enter name<ept id=\"p3\">**</ept>, type <bpt id=\"p4\">**</bpt>10.0.0.1<ept id=\"p4\">**</ept> in <bpt id=\"p5\">**</bpt>IP address<ept id=\"p5\">**</ept>, and then select <bpt id=\"p6\">**</bpt>Configure a site-to-site VPN<ept id=\"p6\">**</ept>."
    },
    {
      "pos": [
        7573,
        7634
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Local Network<ept id=\"p1\">**</ept>, select <bpt id=\"p2\">**</bpt>Specify a New Local Network<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Click the Next arrow.",
      "pos": [
        7640,
        7661
      ]
    },
    {
      "content": "On the Site-to-Site Connectivity page:",
      "pos": [
        7666,
        7704
      ]
    },
    {
      "pos": [
        7711,
        7741
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Name<ept id=\"p1\">**</ept>, type <bpt id=\"p2\">**</bpt>Corpnet<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        7749,
        7850
      ],
      "content": "In <bpt id=\"p1\">**</bpt>VPN Device IP Address<ept id=\"p1\">**</ept>, type the public IP address assigned to the Internet interface of RRAS1."
    },
    {
      "content": "In <bpt id=\"p1\">**</bpt>Address Space<ept id=\"p1\">**</ept>, in the <bpt id=\"p2\">**</bpt>Starting IP<ept id=\"p2\">**</ept> column, type <bpt id=\"p3\">**</bpt>10.0.0.0<ept id=\"p3\">**</ept>.",
      "pos": [
        7857,
        7928
      ]
    },
    {
      "content": "In <bpt id=\"p1\">**</bpt>CIDR (Address Count)<ept id=\"p1\">**</ept>, select <bpt id=\"p2\">**</bpt>/8<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Add Address Space<ept id=\"p3\">**</ept>.",
      "pos": [
        7929,
        8010
      ]
    },
    {
      "content": "Click the Next arrow.",
      "pos": [
        8015,
        8036
      ]
    },
    {
      "content": "On the Virtual Network Address Spaces page:",
      "pos": [
        8041,
        8084
      ]
    },
    {
      "pos": [
        8091,
        8156
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Address Space<ept id=\"p1\">**</ept>, in <bpt id=\"p2\">**</bpt>Starting IP<ept id=\"p2\">**</ept>, select <bpt id=\"p3\">**</bpt>192.168.0.0<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        8163,
        8239
      ],
      "content": "In <bpt id=\"p1\">**</bpt>Subnets<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>Subnet-1<ept id=\"p2\">**</ept> and replace the name with <bpt id=\"p3\">**</bpt>TestSubnet<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        8247,
        8326
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>CIDR (Address Count)<ept id=\"p1\">**</ept> column for the TestSubnet, click <bpt id=\"p2\">**</bpt>/24 (256)<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        8333,
        8362
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Add Gateway Subnet<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Click the Complete icon.",
      "pos": [
        8367,
        8391
      ]
    },
    {
      "content": "Wait until the virtual network is created before continuing.",
      "pos": [
        8392,
        8452
      ]
    },
    {
      "pos": [
        8454,
        8619
      ],
      "content": "Next, use the instructions in <bpt id=\"p1\">[</bpt>How to install and configure Azure PowerShell<ept id=\"p1\">](../install-configure-powershell.md)</ept> to install Azure PowerShell on your local computer."
    },
    {
      "content": "Next, create a new cloud service for the TestVNET virtual network.",
      "pos": [
        8621,
        8687
      ]
    },
    {
      "content": "You must pick a unique name.",
      "pos": [
        8688,
        8716
      ]
    },
    {
      "content": "For example, you could name it TestVNET-<bpt id=\"p1\">*</bpt>UniqueSequence<ept id=\"p1\">*</ept>, in which <bpt id=\"p2\">*</bpt>UniqueSequence<ept id=\"p2\">*</ept> is an abbreviation of your organization.",
      "pos": [
        8717,
        8841
      ]
    },
    {
      "content": "For example, if your organization is named Tailspin Toys, you could name the cloud service TestVNET-Tailspin.",
      "pos": [
        8842,
        8951
      ]
    },
    {
      "content": "You can test for the uniqueness of the name with the following Azure PowerShell command on your local computer.",
      "pos": [
        8953,
        9064
      ]
    },
    {
      "content": "If this command returns \"False\", your proposed name is unique.",
      "pos": [
        9125,
        9187
      ]
    },
    {
      "content": "Create the cloud service with this command.",
      "pos": [
        9188,
        9231
      ]
    },
    {
      "content": "Next, create a new storage account for the TestVNET virtual network.",
      "pos": [
        9349,
        9417
      ]
    },
    {
      "content": "You must pick a unique name.",
      "pos": [
        9418,
        9446
      ]
    },
    {
      "content": "You can test for the uniqueness of the storage account name with this command.",
      "pos": [
        9447,
        9525
      ]
    },
    {
      "content": "If this command returns \"False\", your proposed name is unique.",
      "pos": [
        9588,
        9650
      ]
    },
    {
      "content": "Create and set the storage account with these commands.",
      "pos": [
        9651,
        9706
      ]
    },
    {
      "content": "This is your current configuration.",
      "pos": [
        9922,
        9957
      ]
    },
    {
      "content": "Phase 4: Create the site-to-site VPN connection",
      "pos": [
        10062,
        10109
      ]
    },
    {
      "content": "First, you create a virtual network gateway.",
      "pos": [
        10111,
        10155
      ]
    },
    {
      "pos": [
        10161,
        10331
      ],
      "content": "In the Azure Management Portal on your local computer, click <bpt id=\"p1\">**</bpt>Networks<ept id=\"p1\">**</ept> in the left pane, and then verify that the <bpt id=\"p2\">**</bpt>Status<ept id=\"p2\">**</ept> column for TestVNET is set to <bpt id=\"p3\">**</bpt>Created<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>TestVNET<ept id=\"p1\">**</ept>.",
      "pos": [
        10336,
        10355
      ]
    },
    {
      "content": "On the Dashboard page, you should see a status of <bpt id=\"p1\">**</bpt>Gateway Not Created<ept id=\"p1\">**</ept>.",
      "pos": [
        10356,
        10430
      ]
    },
    {
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Create Gateway<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Dynamic Routing<ept id=\"p2\">**</ept>.",
      "pos": [
        10435,
        10513
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept> when prompted.",
      "pos": [
        10514,
        10542
      ]
    },
    {
      "content": "Wait until the gateway is complete and its status changes to <bpt id=\"p1\">**</bpt>Connecting<ept id=\"p1\">**</ept>.",
      "pos": [
        10543,
        10619
      ]
    },
    {
      "content": "This could take a few minutes.",
      "pos": [
        10620,
        10650
      ]
    },
    {
      "content": "From the Dashboard page, note the <bpt id=\"p1\">**</bpt>Gateway IP Address<ept id=\"p1\">**</ept>.",
      "pos": [
        10655,
        10712
      ]
    },
    {
      "content": "This is the public IP address of the Azure VPN gateway for the TestVNET virtual network.",
      "pos": [
        10713,
        10801
      ]
    },
    {
      "content": "You need this IP address to configure RRAS1.",
      "pos": [
        10802,
        10846
      ]
    },
    {
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Manage Key<ept id=\"p1\">**</ept>, and then click the copy icon next to the key to copy it to your clipboard.",
      "pos": [
        10851,
        10964
      ]
    },
    {
      "content": "Paste this key into a document and save it.",
      "pos": [
        10965,
        11008
      ]
    },
    {
      "content": "You need this key value to configure RRAS1.",
      "pos": [
        11009,
        11052
      ]
    },
    {
      "content": "Next, configure RRAS1 with the Routing and Remote Access Service to act as the VPN device for the Corpnet subnet.",
      "pos": [
        11055,
        11168
      ]
    },
    {
      "content": "Log on to RRAS1 as the local administrator and run these commands at a Windows PowerShell command prompt.",
      "pos": [
        11169,
        11274
      ]
    },
    {
      "content": "Next, configure RRAS1 to receive the site-to-site VPN connection from the Azure VPN gateway.",
      "pos": [
        11434,
        11526
      ]
    },
    {
      "content": "Restart RRAS1, then log on as the local administrator and run these commands at a Windows PowerShell command prompt.",
      "pos": [
        11527,
        11643
      ]
    },
    {
      "content": "You need to provide the IP address of the Azure VPN gateway and the key value.",
      "pos": [
        11644,
        11722
      ]
    },
    {
      "pos": [
        12439,
        12578
      ],
      "content": "Next, go to the Azure Management Portal on your local computer and wait until the TestVNET virtual network shows a status of <bpt id=\"p1\">**</bpt>Connected<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Next, configure RRAS1 to support translated traffic to Internet locations.",
      "pos": [
        12580,
        12654
      ]
    },
    {
      "content": "On RRAS1:",
      "pos": [
        12655,
        12664
      ]
    },
    {
      "pos": [
        12670,
        12753
      ],
      "content": "From the Start screen, type <bpt id=\"p1\">**</bpt>rras<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Routing and Remote Access<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        12759,
        12826
      ],
      "content": "In the console tree, open the server name, and then click <bpt id=\"p1\">**</bpt>IPv4<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        12831,
        12896
      ],
      "content": "Right-click <bpt id=\"p1\">**</bpt>General<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>New Routing Protocol<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        12901,
        12938
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>NAT<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        12943,
        13057
      ],
      "content": "In the console tree, right-click <bpt id=\"p1\">**</bpt>NAT<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>New Interface<ept id=\"p2\">**</ept>, click <bpt id=\"p3\">**</bpt>Corpnet<ept id=\"p3\">**</ept>, and then click <bpt id=\"p4\">**</bpt>OK<ept id=\"p4\">**</ept> twice."
    },
    {
      "pos": [
        13062,
        13150
      ],
      "content": "Right-click <bpt id=\"p1\">**</bpt>NAT<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>New Interface<ept id=\"p2\">**</ept>, click <bpt id=\"p3\">**</bpt>Internet<ept id=\"p3\">**</ept>, and then click <bpt id=\"p4\">**</bpt>OK<ept id=\"p4\">**</ept>."
    },
    {
      "pos": [
        13155,
        13292
      ],
      "content": "On the <bpt id=\"p1\">**</bpt>NAT<ept id=\"p1\">**</ept> tab, click <bpt id=\"p2\">**</bpt>Public interface connected to the Internet<ept id=\"p2\">**</ept>, select <bpt id=\"p3\">**</bpt>Enable NAT on this interface<ept id=\"p3\">**</ept>, and then click <bpt id=\"p4\">**</bpt>OK<ept id=\"p4\">**</ept>."
    },
    {
      "content": "Next, configure DC1, APP1, and CLIENT1 to use RRAS1 as its default gateway.",
      "pos": [
        13295,
        13370
      ]
    },
    {
      "content": "On DC1, run these commands at an administrator-level Windows PowerShell command prompt.",
      "pos": [
        13373,
        13460
      ]
    },
    {
      "pos": [
        13605,
        13718
      ],
      "content": "If the name of the interface is not Ethernet, use the <bpt id=\"p1\">**</bpt>Get-NetAdapter<ept id=\"p1\">**</ept> command to determine the interface name."
    },
    {
      "content": "On APP1, run this command at an administrator-level Windows PowerShell command prompt.",
      "pos": [
        13720,
        13806
      ]
    },
    {
      "content": "On CLIENT1, run this command at an administrator-level Windows PowerShell command prompt.",
      "pos": [
        13902,
        13991
      ]
    },
    {
      "content": "This is your current configuration.",
      "pos": [
        14014,
        14049
      ]
    },
    {
      "content": "Phase 5: Configure DC2",
      "pos": [
        14155,
        14177
      ]
    },
    {
      "content": "First, create an Azure Virtual Machine for DC2 with these commands at the Azure PowerShell command prompt on your local computer.",
      "pos": [
        14179,
        14308
      ]
    },
    {
      "content": "Next, log on to the new DC2 virtual machine.",
      "pos": [
        15261,
        15305
      ]
    },
    {
      "pos": [
        15311,
        15448
      ],
      "content": "In the left pane of the Azure Management Portal, click <bpt id=\"p1\">**</bpt>Virtual Machines<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Running<ept id=\"p2\">**</ept> in the <bpt id=\"p3\">**</bpt>Status<ept id=\"p3\">**</ept> column for DC2."
    },
    {
      "pos": [
        15453,
        15488
      ],
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Connect<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        15494,
        15540
      ],
      "content": "When prompted to open DC2.rdp, click <bpt id=\"p1\">**</bpt>Open<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        15545,
        15623
      ],
      "content": "When prompted with a Remote Desktop Connection message box, click <bpt id=\"p1\">**</bpt>Connect<ept id=\"p1\">**</ept>."
    },
    {
      "content": "When prompted for credentials, use the following:",
      "pos": [
        15628,
        15677
      ]
    },
    {
      "pos": [
        15684,
        15733
      ],
      "content": "Name: <bpt id=\"p1\">**</bpt>DC2\\\\<ept id=\"p1\">**</ept>[Local administrator account name]"
    },
    {
      "content": "Password: [Local administrator account password]",
      "pos": [
        15740,
        15788
      ]
    },
    {
      "pos": [
        15793,
        15893
      ],
      "content": "When prompted with a Remote Desktop Connection message box referring to certificates, click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Next, configure a Windows Firewall rule to allow traffic for basic connectivity testing.",
      "pos": [
        15895,
        15983
      ]
    },
    {
      "content": "From an administrator-level Windows PowerShell command prompt on DC2, run:",
      "pos": [
        15984,
        16058
      ]
    },
    {
      "content": "The ping command should result in four successful replies from IP address 10.0.0.1.",
      "pos": [
        16196,
        16279
      ]
    },
    {
      "content": "This is a test of traffic across the site-to-site VPN connection.",
      "pos": [
        16280,
        16345
      ]
    },
    {
      "content": "Next, add an extra data disk as a new volume with the drive letter F:.",
      "pos": [
        16347,
        16417
      ]
    },
    {
      "pos": [
        16423,
        16521
      ],
      "content": "In the left pane of Server Manager, click <bpt id=\"p1\">**</bpt>File and Storage Services<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Disks<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        16526,
        16633
      ],
      "content": "In the contents pane, in the <bpt id=\"p1\">**</bpt>Disks<ept id=\"p1\">**</ept> group, click <bpt id=\"p2\">**</bpt>disk 2<ept id=\"p2\">**</ept> (with the <bpt id=\"p3\">**</bpt>Partition<ept id=\"p3\">**</ept> set to <bpt id=\"p4\">**</bpt>Unknown<ept id=\"p4\">**</ept>)."
    },
    {
      "pos": [
        16638,
        16685
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Tasks<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>New Volume<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        16690,
        16760
      ],
      "content": "On the Before you begin page of the New Volume Wizard, click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>."
    },
    {
      "content": "On the Select the server and disk page, click <bpt id=\"p1\">**</bpt>Disk 2<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>.",
      "pos": [
        16765,
        16847
      ]
    },
    {
      "content": "When prompted, click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.",
      "pos": [
        16848,
        16876
      ]
    },
    {
      "pos": [
        16881,
        16940
      ],
      "content": "On the Specify the size of the volume page, click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        16945,
        17008
      ],
      "content": "On the Assign to a drive letter or folder page, click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        17013,
        17069
      ],
      "content": "On the Select file system settings page, click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        17074,
        17123
      ],
      "content": "On the Confirm selections page, click <bpt id=\"p1\">**</bpt>Create<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        17128,
        17159
      ],
      "content": "When complete, click <bpt id=\"p1\">**</bpt>Close<ept id=\"p1\">**</ept>."
    },
    {
      "content": "Next, configure DC2 as a replica domain controller for the corp.contoso.com domain.",
      "pos": [
        17161,
        17244
      ]
    },
    {
      "content": "Run these commands from the Windows PowerShell command prompt on DC2.",
      "pos": [
        17245,
        17314
      ]
    },
    {
      "content": "Note that you will be prompted to supply both the CORP\\User1 password and a Directory Services Restore Mode (DSRM) password and to restart DC2.",
      "pos": [
        17576,
        17719
      ]
    },
    {
      "content": "Now that the TestVNET virtual network has its own DNS server (DC2), you must configure the TestVNET virtual network to use this DNS server.",
      "pos": [
        17721,
        17860
      ]
    },
    {
      "pos": [
        17866,
        17963
      ],
      "content": "In the left pane of the Azure Management Portal, click <bpt id=\"p1\">**</bpt>Networks<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>TestVNET<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        17968,
        17988
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Configure<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        17993,
        18043
      ],
      "content": "In <bpt id=\"p1\">**</bpt>DNS Servers<ept id=\"p1\">**</ept>, remove the <bpt id=\"p2\">**</bpt>10.0.0.1<ept id=\"p2\">**</ept> entry."
    },
    {
      "pos": [
        18048,
        18144
      ],
      "content": "In <bpt id=\"p1\">**</bpt>DNS Servers<ept id=\"p1\">**</ept>, add an entry with <bpt id=\"p2\">**</bpt>DC2<ept id=\"p2\">**</ept> as the name and <bpt id=\"p3\">**</bpt>192.168.0.4<ept id=\"p3\">**</ept> as the IP address."
    },
    {
      "pos": [
        18150,
        18199
      ],
      "content": "In the command bar at the bottom, click <bpt id=\"p1\">**</bpt>Save<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        18204,
        18330
      ],
      "content": "In the left pane of the Azure Management Portal, click <bpt id=\"p1\">**</bpt>Virtual Machines<ept id=\"p1\">**</ept>, and then click the <bpt id=\"p2\">**</bpt>Status<ept id=\"p2\">**</ept> column next to DC2."
    },
    {
      "content": "In the command bar, click <bpt id=\"p1\">**</bpt>Restart<ept id=\"p1\">**</ept>.",
      "pos": [
        18335,
        18373
      ]
    },
    {
      "content": "Wait for DC2 to restart.",
      "pos": [
        18374,
        18398
      ]
    },
    {
      "content": "This is your current configuration.",
      "pos": [
        18401,
        18436
      ]
    },
    {
      "content": "Your hybrid cloud environment is now ready for testing.",
      "pos": [
        18538,
        18593
      ]
    },
    {
      "content": "Additional resources",
      "pos": [
        18598,
        18618
      ]
    },
    {
      "content": "Set up a SharePoint intranet farm in a hybrid cloud for testing",
      "pos": [
        18621,
        18684
      ]
    },
    {
      "content": "Set up a web-based LOB application in a hybrid cloud for testing",
      "pos": [
        18747,
        18811
      ]
    },
    {
      "content": "Set up Office 365 Directory Synchronization (DirSync) in a hybrid cloud for testing",
      "pos": [
        18870,
        18953
      ]
    },
    {
      "content": "Set up a simulated hybrid cloud environment for testing",
      "pos": [
        19013,
        19068
      ]
    },
    {
      "content": "Azure hybrid cloud test environments",
      "pos": [
        19142,
        19178
      ]
    },
    {
      "content": "Azure infrastructure services implementation guidelines",
      "pos": [
        19254,
        19309
      ]
    },
    {
      "content": "Minimizing the ongoing costs of this environment",
      "pos": [
        19406,
        19454
      ]
    },
    {
      "content": "To minimize the costs of running the virtual machines in this environment, perform your needed testing and demonstration as quickly as possible and then delete them or shut down the virtual machines when you are not using them.",
      "pos": [
        19456,
        19683
      ]
    },
    {
      "content": "For example, you could use Azure automation and a runbook to automatically shut down the virtual machines in the Test_VNET virtual network at the end of each business day.",
      "pos": [
        19684,
        19855
      ]
    },
    {
      "content": "For more information, see <bpt id=\"p1\">[</bpt>Get started with Azure Automation<ept id=\"p1\">](../automation-create-runbook-from-samples.md)</ept>.",
      "pos": [
        19856,
        19964
      ]
    },
    {
      "content": "The Azure VPN gateway is implemented as a set of two Azure virtual machines that incur an ongoing monetary cost.",
      "pos": [
        19967,
        20079
      ]
    },
    {
      "content": "For the details, see <bpt id=\"p1\">[</bpt>Pricing - Virtual Network<ept id=\"p1\">](http://azure.microsoft.com/pricing/details/virtual-network/)</ept>.",
      "pos": [
        20080,
        20190
      ]
    },
    {
      "content": "To minimize the costs of the VPN gateway, create the test environment and perform your needed testing and demonstration as quickly as possible or delete the gateway with these steps.",
      "pos": [
        20191,
        20373
      ]
    },
    {
      "pos": [
        20380,
        20523
      ],
      "content": "From the Azure Management Portal on your local computer, click <bpt id=\"p1\">**</bpt>Networks<ept id=\"p1\">**</ept> in the left pane, click <bpt id=\"p2\">**</bpt>TestVNET<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Dashboard<ept id=\"p3\">**</ept>."
    },
    {
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Delete Gateway<ept id=\"p1\">**</ept>.",
      "pos": [
        20528,
        20570
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept> when prompted.",
      "pos": [
        20571,
        20599
      ]
    },
    {
      "content": "Wait until the gateway is deleted and its status changes to <bpt id=\"p1\">**</bpt>The Gateway Was Not Created<ept id=\"p1\">**</ept>.",
      "pos": [
        20600,
        20692
      ]
    },
    {
      "content": "If you delete the gateway and you want to restore the test environment, you must first create a new gateway.",
      "pos": [
        20694,
        20802
      ]
    },
    {
      "content": "From the Azure Management Portal on your local computer, click <bpt id=\"p1\">**</bpt>Networks<ept id=\"p1\">**</ept> in the left pane, and then click <bpt id=\"p2\">**</bpt>TestVNET<ept id=\"p2\">**</ept>.",
      "pos": [
        20808,
        20930
      ]
    },
    {
      "content": "On the Dashboard page, you should see a status of <bpt id=\"p1\">**</bpt>The Gateway Was Not Created<ept id=\"p1\">**</ept>.",
      "pos": [
        20931,
        21013
      ]
    },
    {
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Create Gateway<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Dynamic Routing<ept id=\"p2\">**</ept>.",
      "pos": [
        21018,
        21096
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept> when prompted.",
      "pos": [
        21097,
        21125
      ]
    },
    {
      "content": "Wait until the gateway is complete and its status changes to <bpt id=\"p1\">**</bpt>Connecting<ept id=\"p1\">**</ept>.",
      "pos": [
        21126,
        21202
      ]
    },
    {
      "content": "This could take a few minutes.",
      "pos": [
        21203,
        21233
      ]
    },
    {
      "content": "From the Dashboard page, note the <bpt id=\"p1\">**</bpt>Gateway IP Address<ept id=\"p1\">**</ept>.",
      "pos": [
        21238,
        21295
      ]
    },
    {
      "content": "This is the new public IP address of the Azure VPN gateway for the TestVNET virtual network.",
      "pos": [
        21296,
        21388
      ]
    },
    {
      "content": "You need this IP address to re-configure RRAS1.",
      "pos": [
        21389,
        21436
      ]
    },
    {
      "content": "In the task bar, click <bpt id=\"p1\">**</bpt>Manage Key<ept id=\"p1\">**</ept>, and then click the copy icon next to the key to copy it to your clipboard.",
      "pos": [
        21441,
        21554
      ]
    },
    {
      "content": "Paste this key value into a document and save it.",
      "pos": [
        21555,
        21604
      ]
    },
    {
      "content": "You need this key value to re-configure RRAS1.",
      "pos": [
        21605,
        21651
      ]
    },
    {
      "content": "Next, log on to RRAS1 as the local administrator and run these commands at an administrator-level Windows PowerShell command prompt to reconfigure RRAS1 with the new public IP address and preshared key.",
      "pos": [
        21654,
        21856
      ]
    },
    {
      "content": "Next, go to the Azure Management Portal on your local computer and wait until the TestVNET virtual network shows a connected status.",
      "pos": [
        22016,
        22148
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"Hybrid cloud test environment | Microsoft Azure\" \n    description=\"Learn how to create a hybrid cloud environment for IT pro or development testing, complete with a simplfied on-premises network.\" \n    services=\"virtual-network\" \n    documentationCenter=\"\" \n    authors=\"JoeDavies-MSFT\" \n    manager=\"timlt\" \n    editor=\"\"\n    tags=\"azure-service-management\"/>\n\n<tags \n    ms.service=\"virtual-network\" \n    ms.workload=\"infrastructure-services\" \n    ms.tgt_pltfrm=\"na\" \n    ms.devlang=\"na\" \n    ms.topic=\"article\" \n    ms.date=\"07/08/2015\" \n    ms.author=\"josephd\"/>\n\n# Set up a hybrid cloud environment for testing\n\nThis topic steps you through creating a hybrid cloud environment with Microsoft Azure for testing. Here is the resulting configuration.\n\n![](./media/virtual-networks-setup-hybrid-cloud-environment-testing/CreateHybridCloudVNet_5.png)\n\nThis simulates a real hybrid production environment from your location on the Internet. It consists of:\n\n-  A simplified on-premises network (the Corpnet subnet).\n-  A cross-premises virtual network hosted in Azure (TestVNET).\n-  A site-to-site VPN connection.\n-  A secondary domain controller in the TestVNET virtual network.\n\nThis configuration provides a basis and common starting point from which you can:\n\n-  Develop and test applications in a hybrid cloud environment.\n-  Create test configurations of computers, some on the Corpnet subnet and some within the TestVNET virtual network, for hybrid cloud-based IT workloads.\n\nThere are five major phases to setting up this hybrid cloud test environment:\n\n1.  Configure the computers on the Corpnet subnet.\n2.  Configure RRAS1.\n3.  Create the cross-premises Azure virtual network.\n4.  Create the site-to-site VPN connection.\n5.  Configure DC2. \n\nIf you don't already have an Azure subscription, you can sign up for a free trial at [Try Azure](http://azure.microsoft.com/pricing/free-trial/). If you have an MSDN Subscription, see [Azure benefit for MSDN subscribers](http://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/).\n\n>[AZURE.NOTE] Virtual machines and virtual network gateways in Azure incur an ongoing monetary cost when they are running. This cost is billed against your free trial, MSDN subscription, or paid subscription. To reduce the costs of running this test environment when you are not using it, see [Minimizing the ongoing costs of this environment](#costs) in this topic for more information.\n\nThis configuration requires a test subnet of up to four computers connected directly to the Internet using a public IP address. If you don't have these resources, you can also [Set up a simulated hybrid cloud environment for testing](virtual-networks-setup-simulated-hybrid-cloud-environment-testing.md). The simulated hybrid cloud test environment requires only an Azure subscription.\n\n## Phase 1: Configure the computers on the Corpnet subnet\n\nUse the instructions in the \"Steps for Configuring the Corpnet Subnet\" section of the [Test Lab Guide: Base Configuration for Windows Server 2012 R2](http://www.microsoft.com/download/details.aspx?id=39638) to configure the DC1, APP1, and CLIENT1 computers on a subnet named Corpnet. **This subnet must be isolated from your organization network because it will be connected directly to the Internet through the RRAS1 computer.** \n\nNext, log on to DC1 with the CORP\\User1 credentials. To configure the CORP domain so that computers and users use their local domain controller for authentication, run these commands from an administrator-level Windows PowerShell command prompt.\n\n    New-ADReplicationSite -Name \"TestLab\" \n    New-ADReplicationSite -Name \"TestVNET\"\n    New-ADReplicationSubnet –Name \"10.0.0.0/8\" –Site \"TestLab\"\n    New-ADReplicationSubnet –Name \"192.168.0.0/16\" –Site \"TestVNET\n\nThis is your current configuration.\n\n![](./media/virtual-networks-setup-hybrid-cloud-environment-testing/CreateHybridCloudVNet_1.png)\n \n## Phase 2: Configure RRAS1\n\nRRAS1 provides traffic routing and VPN device services between the computers on the Corpnet subnet and the TestVNET virtual network. RRAS1 must have two network adapters installed.\n\nFirst, install the operating system on RRAS1.\n\n1.  Start the installation of Windows Server 2012 R2.\n2.  Follow the instructions to complete the installation, specifying a strong password for the local administrator account. Log on using the local administrator account.\n3.  Connect RRAS1 to a network that has Internet access and run Windows Update to install the latest updates for Windows Server 2012 R2.\n4.  Connect one network adapter to the Corpnet subnet and the other directly to the Internet. RRAS1 can be located behind an Internet firewall but must not be behind a network address translator (NAT).\n\nNext, configure the TCP/IP properties of RRAS1. You will need a public IP address configuration, including an address, subnet mask (or prefix length), and the default gateway and DNS servers of your Internet service provider (ISP).\n\nUse these commands at an administrator-level Windows PowerShell command prompt on RRAS1. Prior to running these commands, fill in the variable values and remove the < and > characters. You can get the current names of the network adapters from the display of the **Get-NetAdapter** command.\n\n    $corpnetAdapterName=\"<Name of the adapter attached to the Corpnet subnet>\"\n    $internetAdapterName=\"<Name of the adapter attached to the Internet>\"\n    [Ipaddress]$publicIP=\"<Your public IP address>\"\n    $publicIPpreflength=<Prefix length of your public IP address>\n    [IPAddress]$publicDG=\"<Your ISP default gateway>\"\n    [IPAddress]$publicDNS=\"<Your ISP DNS server(s)>\"\n    Rename-NetAdapter –Name $corpnetAdapterName –NewName Corpnet\n    Rename-NetAdapter –Name $internetAdapterName –NewName Internet\n    New-NetIPAddress -InterfaceAlias \"Internet\" -IPAddress $publicIP -PrefixLength $publicIPpreflength –DefaultGateway $publicDG\n    Set-DnsClientServerAddress -InterfaceAlias Internet -ServerAddresses $publicDNS\n    New-NetIPAddress -InterfaceAlias \"Corpnet\" -IPAddress 10.0.0.2 -AddressFamily IPv4 -PrefixLength 24\n    Set-DnsClientServerAddress -InterfaceAlias \"Corpnet\" -ServerAddresses 10.0.0.1\n    Set-DnsClient -InterfaceAlias \"Corpnet\" -ConnectionSpecificSuffix corp.contoso.com\n    New-NetFirewallRule –DisplayName “Allow ICMPv4-In” –Protocol ICMPv4\n    New-NetFirewallRule –DisplayName “Allow ICMPv4-Out” –Protocol ICMPv4 –Direction Outbound\n    Disable-NetAdapterBinding -Name \"Internet\" -ComponentID ms_msclient\n    Disable-NetAdapterBinding -Name \"Internet\" -ComponentID ms_server\n    ping dc1.corp.contoso.com\n\nFor the last command, verify that there are four responses from the IP address 10.0.0.1.\n\nThis is your current configuration.\n\n![](./media/virtual-networks-setup-hybrid-cloud-environment-testing/CreateHybridCloudVNet_2.png)\n\n## Phase 3: Create the cross-premises Azure Virtual Network\n\nFirst, log on to the [Azure Management Portal](https://manage.windowsazure.com/) with your Azure subscription credentials and create a virtual network named TestVNET.\n\n1.  In the task bar of the Azure Management Portal, click **New > Network Services > Virtual Network > Custom Create**.\n2.  On the Virtual Network Details page, type **TestVNET** in **Name**.\n3.  In **Location**, select the appropriate datacenter for your location.\n4.  Click the Next arrow.\n5.  On the DNS Servers and VPN Connectivity page, in **DNS servers**, type **DC1** in **Select or enter name**, type **10.0.0.1** in **IP address**, and then select **Configure a site-to-site VPN**.\n6.  In **Local Network**, select **Specify a New Local Network**. \n7.  Click the Next arrow.\n8.  On the Site-to-Site Connectivity page:\n    - In **Name**, type **Corpnet**. \n    - In **VPN Device IP Address**, type the public IP address assigned to the Internet interface of RRAS1.\n    - In **Address Space**, in the **Starting IP** column, type **10.0.0.0**. In **CIDR (Address Count)**, select **/8**, and then click **Add Address Space**.\n9.  Click the Next arrow.\n10. On the Virtual Network Address Spaces page:\n    - In **Address Space**, in **Starting IP**, select **192.168.0.0**.\n    - In **Subnets**, click **Subnet-1** and replace the name with **TestSubnet**. \n    - In the **CIDR (Address Count)** column for the TestSubnet, click **/24 (256)**.\n    - Click **Add Gateway Subnet**.\n11. Click the Complete icon. Wait until the virtual network is created before continuing.\n\nNext, use the instructions in [How to install and configure Azure PowerShell](../install-configure-powershell.md) to install Azure PowerShell on your local computer.\n\nNext, create a new cloud service for the TestVNET virtual network. You must pick a unique name. For example, you could name it TestVNET-*UniqueSequence*, in which *UniqueSequence* is an abbreviation of your organization. For example, if your organization is named Tailspin Toys, you could name the cloud service TestVNET-Tailspin.\n\nYou can test for the uniqueness of the name with the following Azure PowerShell command on your local computer.\n\n    Test-AzureName -Service <Proposed cloud service name>\n\nIf this command returns \"False\", your proposed name is unique. Create the cloud service with this command.\n\n    New-AzureService -Service <Unique cloud service name> -Location \"<Same location name as your virtual network>\"\n\nNext, create a new storage account for the TestVNET virtual network. You must pick a unique name. You can test for the uniqueness of the storage account name with this command.\n\n    Test-AzureName -Storage <Proposed storage account name>\n\nIf this command returns \"False\", your proposed name is unique. Create and set the storage account with these commands.\n\n    New-AzureStorageAccount -StorageAccountName <Unique storage account name> -Location \"<Same location name as your virtual network>\"\n    Set-AzureStorageAccount -StorageAccountName <Unique storage account name>\n\nThis is your current configuration.\n\n![](./media/virtual-networks-setup-hybrid-cloud-environment-testing/CreateHybridCloudVNet_3.png)\n\n \n## Phase 4: Create the site-to-site VPN connection\n\nFirst, you create a virtual network gateway.\n\n1.  In the Azure Management Portal on your local computer, click **Networks** in the left pane, and then verify that the **Status** column for TestVNET is set to **Created**.\n2.  Click **TestVNET**. On the Dashboard page, you should see a status of **Gateway Not Created**.\n3.  In the task bar, click **Create Gateway**, and then click **Dynamic Routing**. Click **Yes** when prompted. Wait until the gateway is complete and its status changes to **Connecting**. This could take a few minutes.\n4.  From the Dashboard page, note the **Gateway IP Address**. This is the public IP address of the Azure VPN gateway for the TestVNET virtual network. You need this IP address to configure RRAS1.\n5.  In the task bar, click **Manage Key**, and then click the copy icon next to the key to copy it to your clipboard. Paste this key into a document and save it. You need this key value to configure RRAS1. \n\nNext, configure RRAS1 with the Routing and Remote Access Service to act as the VPN device for the Corpnet subnet. Log on to RRAS1 as the local administrator and run these commands at a Windows PowerShell command prompt.\n\n    Import-Module ServerManager\n    Install-WindowsFeature RemoteAccess -IncludeManagementTools\n    Add-WindowsFeature -name Routing -IncludeManagementTools\n\nNext, configure RRAS1 to receive the site-to-site VPN connection from the Azure VPN gateway. Restart RRAS1, then log on as the local administrator and run these commands at a Windows PowerShell command prompt. You need to provide the IP address of the Azure VPN gateway and the key value.\n\n    $PresharedKey=\"<Key value>\"\n    Import-Module RemoteAccess\n    Install-RemoteAccess -VpnType VpnS2S\n    Add-VpnS2SInterface -Protocol IKEv2 -AuthenticationMethod PSKOnly -Persistent -NumberOfTries 3 -ResponderAuthenticationMethod PSKOnly -Name S2StoTestVNET -Destination \"<IP address of the Azure VPN gateway>\" -IPv4Subnet @(\"192.168.0.0/24:100\") -SharedSecret $PresharedKey\n    Set-VpnServerIPsecConfiguration -EncryptionType MaximumEncryption\n    Set-VpnServerIPsecConfiguration -SADataSizeForRenegotiationKilobytes 33553408\n    New-ItemProperty -Path HKLM:\\System\\CurrentControlSet\\Services\\RemoteAccess\\Parameters\\IKEV2 -Name SkipConfigPayload -PropertyType DWord -Value 1\n    Restart-Service RemoteAccess\n\nNext, go to the Azure Management Portal on your local computer and wait until the TestVNET virtual network shows a status of **Connected**.\n\nNext, configure RRAS1 to support translated traffic to Internet locations. On RRAS1:\n\n1.  From the Start screen, type **rras**, and then click **Routing and Remote Access**. \n2.  In the console tree, open the server name, and then click **IPv4**.\n3.  Right-click **General**, and then click **New Routing Protocol**.\n4.  Click **NAT**, and then click **OK**.\n5.  In the console tree, right-click **NAT**, click **New Interface**, click **Corpnet**, and then click **OK** twice.\n6.  Right-click **NAT**, click **New Interface**, click **Internet**, and then click **OK**.\n7.  On the **NAT** tab, click **Public interface connected to the Internet**, select **Enable NAT on this interface**, and then click **OK**.\n\n\nNext, configure DC1, APP1, and CLIENT1 to use RRAS1 as its default gateway.\n \nOn DC1, run these commands at an administrator-level Windows PowerShell command prompt.\n\n    New-NetRoute –DestinationPrefix \"0.0.0.0/0\" –InterfaceAlias \"Ethernet\" –NextHop 10.0.0.2\n    Set-DhcpServerv4OptionValue –Router 10.0.0.2\n\nIf the name of the interface is not Ethernet, use the **Get-NetAdapter** command to determine the interface name.\n\nOn APP1, run this command at an administrator-level Windows PowerShell command prompt.\n\n    New-NetRoute –DestinationPrefix \"0.0.0.0/0\" –InterfaceAlias \"Ethernet\" –NextHop 10.0.0.2\n\nOn CLIENT1, run this command at an administrator-level Windows PowerShell command prompt.\n\n    ipconfig /renew\n\nThis is your current configuration.\n \n\n![](./media/virtual-networks-setup-hybrid-cloud-environment-testing/CreateHybridCloudVNet_4.png)\n\n\n## Phase 5: Configure DC2\n\nFirst, create an Azure Virtual Machine for DC2 with these commands at the Azure PowerShell command prompt on your local computer.\n\n    $ServiceName=\"<Your cloud service name from Phase 3>\"\n    $image = Get-AzureVMImage | where { $_.ImageFamily -eq \"Windows Server 2012 R2 Datacenter\" } | sort PublishedDate -Descending | select -ExpandProperty ImageName -First 1\n    $vm1=New-AzureVMConfig -Name DC2 -InstanceSize Medium -ImageName $image\n    $cred=Get-Credential –Message \"Type the name and password of the local administrator account for DC2.\"\n    $vm1 | Add-AzureProvisioningConfig -Windows -AdminUsername $cred.GetNetworkCredential().Username -Password $cred.GetNetworkCredential().Password \n    $vm1 | Add-AzureProvisioningConfig -Windows -AdminUsername $LocalAdminName -Password $LocalAdminPW  \n    $vm1 | Set-AzureSubnet -SubnetNames TestSubnet\n    $vm1 | Set-AzureStaticVNetIP -IPAddress 192.168.0.4\n    $vm1 | Add-AzureDataDisk -CreateNew -DiskSizeInGB 20 -DiskLabel ADFiles –LUN 0 -HostCaching None\n    New-AzureVM –ServiceName $ServiceName -VMs $vm1 -VNetName TestVNET\n\n\nNext, log on to the new DC2 virtual machine.\n\n1.  In the left pane of the Azure Management Portal, click **Virtual Machines**, and then click **Running** in the **Status** column for DC2.\n2.  In the task bar, click **Connect**. \n3.  When prompted to open DC2.rdp, click **Open**.\n4.  When prompted with a Remote Desktop Connection message box, click **Connect**.\n5.  When prompted for credentials, use the following:\n    - Name: **DC2\\\\**[Local administrator account name]\n    - Password: [Local administrator account password]\n6.  When prompted with a Remote Desktop Connection message box referring to certificates, click **Yes**.\n\nNext, configure a Windows Firewall rule to allow traffic for basic connectivity testing. From an administrator-level Windows PowerShell command prompt on DC2, run:\n\n    Set-NetFirewallRule -DisplayName \"File and Printer Sharing (Echo Request - ICMPv4-In)\" -enabled True\n    ping dc1.corp.contoso.com\n\nThe ping command should result in four successful replies from IP address 10.0.0.1. This is a test of traffic across the site-to-site VPN connection.\n\nNext, add an extra data disk as a new volume with the drive letter F:.\n\n1.  In the left pane of Server Manager, click **File and Storage Services**, and then click **Disks**.\n2.  In the contents pane, in the **Disks** group, click **disk 2** (with the **Partition** set to **Unknown**).\n3.  Click **Tasks**, and then click **New Volume**.\n4.  On the Before you begin page of the New Volume Wizard, click **Next**.\n5.  On the Select the server and disk page, click **Disk 2**, and then click **Next**. When prompted, click **OK**.\n6.  On the Specify the size of the volume page, click **Next**.\n7.  On the Assign to a drive letter or folder page, click **Next**.\n8.  On the Select file system settings page, click **Next**.\n9.  On the Confirm selections page, click **Create**.\n10. When complete, click **Close**.\n\nNext, configure DC2 as a replica domain controller for the corp.contoso.com domain. Run these commands from the Windows PowerShell command prompt on DC2.\n\n    Install-WindowsFeature AD-Domain-Services -IncludeManagementTools\n    Install-ADDSDomainController -Credential (Get-Credential CORP\\User1) -DomainName \"corp.contoso.com\" -InstallDns:$true -DatabasePath \"F:\\NTDS\" -LogPath \"F:\\Logs\" -SysvolPath \"F:\\SYSVOL\"\n\nNote that you will be prompted to supply both the CORP\\User1 password and a Directory Services Restore Mode (DSRM) password and to restart DC2.\n\nNow that the TestVNET virtual network has its own DNS server (DC2), you must configure the TestVNET virtual network to use this DNS server.\n\n1.  In the left pane of the Azure Management Portal, click **Networks**, and then click **TestVNET**.\n2.  Click **Configure**.\n3.  In **DNS Servers**, remove the **10.0.0.1** entry.\n4.  In **DNS Servers**, add an entry with **DC2** as the name and **192.168.0.4** as the IP address. \n5.  In the command bar at the bottom, click **Save**.\n6.  In the left pane of the Azure Management Portal, click **Virtual Machines**, and then click the **Status** column next to DC2.\n7.  In the command bar, click **Restart**. Wait for DC2 to restart.\n\n\nThis is your current configuration.\n\n![](./media/virtual-networks-setup-hybrid-cloud-environment-testing/CreateHybridCloudVNet_5.png)\n\n \nYour hybrid cloud environment is now ready for testing.\n\n## Additional resources\n\n[Set up a SharePoint intranet farm in a hybrid cloud for testing](virtual-networks-setup-sharepoint-hybrid-cloud-testing.md)\n\n[Set up a web-based LOB application in a hybrid cloud for testing](virtual-networks-setup-lobapp-hybrid-cloud-testing.md)\n\n[Set up Office 365 Directory Synchronization (DirSync) in a hybrid cloud for testing](virtual-networks-setup-dirsync-hybrid-cloud-testing.md)\n\n[Set up a simulated hybrid cloud environment for testing](virtual-networks-setup-simulated-hybrid-cloud-environment-testing.md)\n\n[Azure hybrid cloud test environments](../virtual-machines/virtual-machines-hybrid-cloud-test-environments.md)\n\n[Azure infrastructure services implementation guidelines](../virtual-machines/virtual-machines-infrastructure-services-implementation-guidelines.md)\n\n## Minimizing the ongoing costs of this environment\n\nTo minimize the costs of running the virtual machines in this environment, perform your needed testing and demonstration as quickly as possible and then delete them or shut down the virtual machines when you are not using them. For example, you could use Azure automation and a runbook to automatically shut down the virtual machines in the Test_VNET virtual network at the end of each business day. For more information, see [Get started with Azure Automation](../automation-create-runbook-from-samples.md). \n\nThe Azure VPN gateway is implemented as a set of two Azure virtual machines that incur an ongoing monetary cost. For the details, see [Pricing - Virtual Network](http://azure.microsoft.com/pricing/details/virtual-network/). To minimize the costs of the VPN gateway, create the test environment and perform your needed testing and demonstration as quickly as possible or delete the gateway with these steps. \n\n1.  From the Azure Management Portal on your local computer, click **Networks** in the left pane, click **TestVNET**, and then click **Dashboard**.\n2.  In the task bar, click **Delete Gateway**. Click **Yes** when prompted. Wait until the gateway is deleted and its status changes to **The Gateway Was Not Created**.\n\nIf you delete the gateway and you want to restore the test environment, you must first create a new gateway.\n\n1.  From the Azure Management Portal on your local computer, click **Networks** in the left pane, and then click **TestVNET**. On the Dashboard page, you should see a status of **The Gateway Was Not Created**.\n2.  In the task bar, click **Create Gateway**, and then click **Dynamic Routing**. Click **Yes** when prompted. Wait until the gateway is complete and its status changes to **Connecting**. This could take a few minutes.\n3.  From the Dashboard page, note the **Gateway IP Address**. This is the new public IP address of the Azure VPN gateway for the TestVNET virtual network. You need this IP address to re-configure RRAS1.\n4.  In the task bar, click **Manage Key**, and then click the copy icon next to the key to copy it to your clipboard. Paste this key value into a document and save it. You need this key value to re-configure RRAS1. \n\nNext, log on to RRAS1 as the local administrator and run these commands at an administrator-level Windows PowerShell command prompt to reconfigure RRAS1 with the new public IP address and preshared key.\n\n    $PresharedKey=\"<Key value>\"\n    Set-VpnS2SInterface -Name S2StoTestVNET -Destination \"<IP address of the Azure VPN gateway>\" -SharedSecret $PresharedKey\n\nNext, go to the Azure Management Portal on your local computer and wait until the TestVNET virtual network shows a connected status.\n "
}